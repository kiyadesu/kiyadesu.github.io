<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[Android é€†å‘æŠ€å·§æ€»ç»“]]></title>
      <url>/2333/03/03/android-reversing-skills/</url>
      <content type="html"><![CDATA[<p>ä»¥ä»£è¡¨æ€§çš„ crackme ä¸ºä¾‹æ€»ç»“ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼github ä»“åº“<a href="https://github.com/kiya-z/android-reversing-challenges" target="_blank" rel="external">åœ¨æ­¤</a>ã€‚<br><a id="more"></a></p>
<h1 id="å·¥å…·åˆ—è¡¨"><a href="#å·¥å…·åˆ—è¡¨" class="headerlink" title="å·¥å…·åˆ—è¡¨"></a>å·¥å…·åˆ—è¡¨</h1><table>
<thead>
<tr>
<th>name</th>
<th>How to get</th>
</tr>
</thead>
<tbody>
<tr>
<td>jadx</td>
<td><a href="https://github.com/skylot/jadx/releases" target="_blank" rel="external">https://github.com/skylot/jadx/releases</a></td>
</tr>
<tr>
<td>jeb</td>
<td><a href="https://down.52pojie.cn/Tools/Android_Tools/" target="_blank" rel="external">https://down.52pojie.cn/Tools/Android_Tools/</a></td>
</tr>
<tr>
<td>Ida</td>
<td><a href="https://down.52pojie.cn/Tools/Disassemblers/" target="_blank" rel="external">https://down.52pojie.cn/Tools/Disassemblers/</a></td>
</tr>
<tr>
<td>ARM â‡Œ Hex</td>
<td><a href="http://armconverter.com/" target="_blank" rel="external">http://armconverter.com/</a></td>
</tr>
<tr>
<td>010 Editor</td>
<td><a href="https://down.52pojie.cn/Tools/Editors/" target="_blank" rel="external">https://down.52pojie.cn/Tools/Editors/</a></td>
</tr>
<tr>
<td>010 templates</td>
<td><a href="http://www.sweetscape.com/010editor/templates/" target="_blank" rel="external">http://www.sweetscape.com/010editor/templates/</a></td>
</tr>
<tr>
<td>aapt</td>
<td>in sdk build-tools</td>
</tr>
<tr>
<td>Google signapk</td>
<td><a href="https://github.com/kiya-z/Android/tree/master/tools/signapk" target="_blank" rel="external">https://github.com/kiya-z/Android/tree/master/tools/signapk</a></td>
</tr>
<tr>
<td>Android Device Monitor</td>
<td>in sdk tools</td>
</tr>
<tr>
<td>gdb</td>
<td>in ndk toolchains (ndk &lt;= r10)</td>
</tr>
<tr>
<td>gdbserver</td>
<td>in ndk prebuilt (ndk &lt;= r10)</td>
</tr>
<tr>
<td>Android Studio</td>
<td><a href="https://developer.android.com/studio" target="_blank" rel="external">https://developer.android.com/studio</a></td>
</tr>
<tr>
<td>ShakaApktool</td>
<td><a href="https://github.com/rover12421/ShakaApktool" target="_blank" rel="external">https://github.com/rover12421/ShakaApktool</a></td>
</tr>
<tr>
<td>smalidea</td>
<td><a href="https://bitbucket.org/JesusFreke/smali/downloads/" target="_blank" rel="external">https://bitbucket.org/JesusFreke/smali/downloads/</a></td>
</tr>
<tr>
<td>smali</td>
<td><a href="https://bitbucket.org/JesusFreke/smali/downloads/" target="_blank" rel="external">https://bitbucket.org/JesusFreke/smali/downloads/</a></td>
</tr>
<tr>
<td>baksmali</td>
<td><a href="https://bitbucket.org/JesusFreke/smali/downloads/" target="_blank" rel="external">https://bitbucket.org/JesusFreke/smali/downloads/</a></td>
</tr>
<tr>
<td>axmlprinter</td>
<td><a href="https://github.com/rednaga/axmlprinter/releases" target="_blank" rel="external">https://github.com/rednaga/axmlprinter/releases</a></td>
</tr>
<tr>
<td>unluac</td>
<td><a href="https://sourceforge.net/projects/unluac/" target="_blank" rel="external">https://sourceforge.net/projects/unluac/</a></td>
</tr>
<tr>
<td>sqlcipher</td>
<td><a href="https://github.com/sqlcipher/sqlcipher" target="_blank" rel="external">https://github.com/sqlcipher/sqlcipher</a></td>
</tr>
<tr>
<td>android-backup-extractor</td>
<td><a href="https://github.com/nelenkov/android-backup-extractor" target="_blank" rel="external">https://github.com/nelenkov/android-backup-extractor</a></td>
</tr>
</tbody>
</table>
<h1 id="JNI-Onload-ä¸­é€šè¿‡-RegisterNatives-åŠ¨æ€æ³¨å†Œ-jni-å‡½æ•°"><a href="#JNI-Onload-ä¸­é€šè¿‡-RegisterNatives-åŠ¨æ€æ³¨å†Œ-jni-å‡½æ•°" class="headerlink" title="JNI_Onload ä¸­é€šè¿‡ RegisterNatives åŠ¨æ€æ³¨å†Œ jni å‡½æ•°"></a>JNI_Onload ä¸­é€šè¿‡ RegisterNatives åŠ¨æ€æ³¨å†Œ jni å‡½æ•°</h1><p><strong>ç›¸å…³å‡½æ•°</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">signed int __fastcall JNI_OnLoad(_JavaVM *a1)</div><div class="line"></div><div class="line">((int (__fastcall *)(_JavaVM *, _JNIEnv **, signed int))v1-&gt;functions-&gt;GetEnv)(v1, &amp;v8, 65540)  </div><div class="line">    /*  v1:JavaVM  v8:JniEnv  65540:jni version */</div><div class="line"></div><div class="line">((int (__fastcall *)(_JNIEnv *, char *))v3-&gt;functions-&gt;FindClass)(v3, v4)   </div><div class="line">    /*  v3:JNIEnv  v4:ç±»å    */</div><div class="line"></div><div class="line">((int (__fastcall *)(_JNIEnv *, int, char **, signed int))v3-&gt;functions-&gt;RegisterNatives)(v3, v5, off_400C, 2)</div><div class="line">    /*  v3:JniEnv  v5:FindClasså¾—åˆ°çš„jclasså¯¹è±¡  off_400C:è¦æ³¨å†Œçš„methods  2:æ³¨å†Œçš„methodsä¸ªæ•°</div><div class="line">        methodçš„æ ¼å¼ä¸ºï¼šå‡½æ•°å å‡½æ•°æè¿°(smaliæ ¼å¼) å‡½æ•°æŒ‡é’ˆ</div><div class="line">        ä¾‹å¦‚(in ida)ï¼š</div><div class="line">            DCD aHello              ; &quot;hello&quot;</div><div class="line">            DCD aLjavaLangStr_1     ; &quot;()Ljava/lang/String;&quot;</div><div class="line">            DCD native_hello+1</div><div class="line">    */</div></pre></td></tr></table></figure>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/mobicrackNDK.apk" target="_blank" rel="external">mobicrackNDK.apk</a></p>
<h1 id="init-array"><a href="#init-array" class="headerlink" title=".init_array"></a>.init_array</h1><p>æ ¹æ® linker æºç , section çš„æ‰§è¡Œé¡ºåºä¸º <code>.preinit_array</code> -&gt; <code>.init</code> -&gt; <code>.init_array</code> ã€‚ä½† so æ˜¯ä¸ä¼šæ‰§è¡Œ <code>.preinit_array</code> çš„, å¯ä»¥å¿½ç•¥ã€‚</p>
<p><code>.init_array</code> æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ã€‚ç¼–å†™ä»£ç æ—¶åœ¨å‡½æ•°å£°æ˜æ—¶åŠ ä¸Š <code>__attribute__((constructor))</code> ä½¿ä¹‹æˆä¸ºå…±äº«æ„é€ å‡½æ•°ï¼Œå³å¯ä½¿è¯¥å‡½æ•°å‡ºç°åœ¨ <code>.init_array</code> section ä¸­ã€‚</p>
<p>IDA åŠ¨æ€è°ƒè¯•æ—¶ â€˜ctrl+sâ€™ æŸ¥çœ‹ section ä¿¡æ¯å³å¯å®šä½è¿™ä¸¤ä¸ª setctionï¼Œç‰¹åˆ«çš„ï¼Œå¯¹äº <code>.init_array</code>ï¼Œå¯é€šè¿‡æœç´¢ <code>Calling %s @ %p for &#39;%s&#39;</code> å®šä½ã€‚</p>
<p><strong>éƒ¨åˆ†æºç </strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">void soinfo::CallConstructors() &#123;</div><div class="line">    ...</div><div class="line">    // DT_INIT should be called before DT_INIT_ARRAY if both are present.</div><div class="line">    CallFunction(&quot;DT_INIT&quot;, init_func);</div><div class="line">    CallArray(&quot;DT_INIT_ARRAY&quot;, init_array, init_array_count, false);    // CallArray ä¸­ä¹Ÿä¼šè°ƒç”¨ CallFunction å‡½æ•°</div><div class="line">&#125;</div><div class="line"></div><div class="line">void soinfo::CallFunction(const char* function_name UNUSED, linker_function_t function) &#123;</div><div class="line">  if (function == NULL || reinterpret_cast&lt;uintptr_t&gt;(function) == static_cast&lt;uintptr_t&gt;(-1)) &#123;</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  TRACE(&quot;[ Calling %s @ %p for &apos;%s&apos; ]&quot;, function_name, function, name);</div><div class="line">  function();</div><div class="line">  TRACE(&quot;[ Done calling %s @ %p for &apos;%s&apos; ]&quot;, function_name, function, name);</div><div class="line"></div><div class="line">  // The function may have called dlopen(3) or dlclose(3), so we need to ensure our data structures</div><div class="line">  // are still writable. This happens with our debug malloc (see http://b/7941716).</div><div class="line">  set_soinfo_pool_protection(PROT_READ | PROT_WRITE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/mobicrackNDK.apk" target="_blank" rel="external">mobicrackNDK.apk</a></p>
<h1 id="dex-ç»“æ„"><a href="#dex-ç»“æ„" class="headerlink" title="dex ç»“æ„"></a>dex ç»“æ„</h1><h2 id="ä¿®å¤-dexHeader-amp-onCreate"><a href="#ä¿®å¤-dexHeader-amp-onCreate" class="headerlink" title="ä¿®å¤ dexHeader &amp; onCreate"></a>ä¿®å¤ dexHeader &amp; onCreate</h2><p>å¿«é€Ÿç®€è®°ï¼š</p>
<table>
<thead>
<tr>
<th>ç»“æ„</th>
<th>å•ä½ç»“æ„ä½“å å­—èŠ‚</th>
<th>å…±è®¡å­—èŠ‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>DexHeader</td>
<td>-</td>
<td>0x70h</td>
</tr>
<tr>
<td>String Table</td>
<td>4</td>
<td>-</td>
</tr>
<tr>
<td>Type Table</td>
<td>4</td>
<td>-</td>
</tr>
<tr>
<td>Proto Table</td>
<td>12</td>
<td>-</td>
</tr>
<tr>
<td>Field Table</td>
<td>8</td>
<td>-</td>
</tr>
<tr>
<td>Method Table</td>
<td>8</td>
<td>-</td>
</tr>
<tr>
<td>Class Def Table</td>
<td>32</td>
<td>-</td>
</tr>
<tr>
<td>Data Section(å«Map Section)</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/misc.apk" target="_blank" rel="external">misc.apk</a></p>
<h1 id="hook-ç³»ç»Ÿå‡½æ•°"><a href="#hook-ç³»ç»Ÿå‡½æ•°" class="headerlink" title="hook ç³»ç»Ÿå‡½æ•°"></a>hook ç³»ç»Ÿå‡½æ•°</h1><p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/EasyRe.apk" target="_blank" rel="external">EasyRe.apk</a></p>
<h1 id="dump-å†…å­˜æœç´¢-flag"><a href="#dump-å†…å­˜æœç´¢-flag" class="headerlink" title="dump å†…å­˜æœç´¢ flag"></a>dump å†…å­˜æœç´¢ flag</h1><h2 id="1-åˆ©ç”¨-ddms-çš„-dump-HPROF-file-åŠŸèƒ½-å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡"><a href="#1-åˆ©ç”¨-ddms-çš„-dump-HPROF-file-åŠŸèƒ½-å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡" class="headerlink" title="1. åˆ©ç”¨ ddms çš„ dump HPROF file åŠŸèƒ½ (å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡)"></a>1. åˆ©ç”¨ ddms çš„ <code>dump HPROF file</code> åŠŸèƒ½ (å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡)</h2><p>æœç´¢ï¼š<code>strings easyre.sjl.gossip.easyre.hprof | grep 0ctf</code></p>
<h2 id="2-åˆ©ç”¨-gore"><a href="#2-åˆ©ç”¨-gore" class="headerlink" title="2. åˆ©ç”¨ gore"></a>2. åˆ©ç”¨ gore</h2><p>gdb é™„åŠ è¿›ç¨‹åç›´æ¥æ‰§è¡Œ <code>gcore</code> dumpï¼Œæœç´¢ï¼š<code>strings core.7967 | grep 0ctf</code></p>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/EasyRe.apk" target="_blank" rel="external">EasyRe.apk</a></p>
<h1 id="ä¿®æ”¹-smali-ä»£ç "><a href="#ä¿®æ”¹-smali-ä»£ç " class="headerlink" title="ä¿®æ”¹ smali ä»£ç "></a>ä¿®æ”¹ smali ä»£ç </h1><p>æŒ‡ä»¤å‚è€ƒè¿™é‡ŒğŸ‘‰<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode" target="_blank" rel="external">dalvik bytecode</a></p>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/Timer.apk" target="_blank" rel="external">Timer.apk</a></p>
<h1 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h1><h2 id="ARM-çš„å‚æ•°ä¼ é€’è§„åˆ™"><a href="#ARM-çš„å‚æ•°ä¼ é€’è§„åˆ™" class="headerlink" title="ARM çš„å‚æ•°ä¼ é€’è§„åˆ™"></a>ARM çš„å‚æ•°ä¼ é€’è§„åˆ™</h2><p>R0ã€R1ã€R2ã€R3ï¼Œ åœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œç”¨æ¥å­˜æ”¾å‰4ä¸ªå‡½æ•°å‚æ•°ï¼›å¦‚æœå‡½æ•°çš„å‚æ•°å¤šäº 4 ä¸ªï¼Œåˆ™å¤šä½™å‚æ•°å­˜æ”¾åœ¨å †æ ˆå½“ä¸­ï¼›<br>ä½äº32ä½çš„å‡½æ•°è¿”å›å€¼å­˜äº R0ã€‚</p>
<h2 id="ARM-çš„å¯„å­˜å™¨è§„åˆ™"><a href="#ARM-çš„å¯„å­˜å™¨è§„åˆ™" class="headerlink" title="ARM çš„å¯„å­˜å™¨è§„åˆ™"></a>ARM çš„å¯„å­˜å™¨è§„åˆ™</h2><table>
<thead>
<tr>
<th>å¯„å­˜å™¨</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>R0 ~ R3</td>
<td>è°ƒç”¨å‡½æ•°æ—¶ï¼Œç”¨æ¥å­˜æ”¾å‰4ä¸ªå‡½æ•°å‚æ•°</td>
</tr>
<tr>
<td>R0</td>
<td>å‡½æ•°è¿”å›æ—¶ï¼Œå­˜æ”¾ä½äº32ä½çš„å‡½æ•°è¿”å›å€¼</td>
</tr>
<tr>
<td>R4 ~ R11</td>
<td>ä¿å­˜å±€éƒ¨å˜é‡ã€‚è¿›å…¥å‡½æ•°æ—¶å¿…é¡»ä¿å­˜æ‰€ç”¨åˆ°çš„å±€éƒ¨å˜é‡å¯„å­˜å™¨çš„å€¼ï¼Œåœ¨è¿”å›å‰å¿…é¡»æ¢å¤è¿™äº›å¯„å­˜å™¨çš„å€¼ï¼›å¯¹äºå‡½æ•°ä¸­æ²¡æœ‰ç”¨åˆ°çš„å¯„å­˜å™¨åˆ™ä¸å¿…è¿›è¡Œè¿™äº›æ“ä½œã€‚<br>åœ¨Thumbä¸­ï¼Œé€šå¸¸åªèƒ½ä½¿ç”¨å¯„å­˜å™¨ R4~R7æ¥ä¿å­˜å±€éƒ¨å˜é‡ï¼Œ<br>æ‰€ä»¥å‡½æ•°å†…éƒ¨é€šç”¨çš„å…¥æ ˆå‡ºæ ˆä»£ç å¯ä»¥ä¸ºï¼š<br>STMFD sp!,{r4-r11,lr}<br>// body of ASM code<br>LDMFD sp!,{r4-r11,pc}</td>
</tr>
<tr>
<td>R12</td>
<td>ç”¨ä½œ IPï¼Œå†…éƒ¨è°ƒç”¨æš‚æ—¶å¯„å­˜å™¨</td>
</tr>
<tr>
<td>R13</td>
<td>ç”¨ä½œ SPï¼Œæ ˆæŒ‡é’ˆï¼Œsp ä¸­å­˜æ”¾çš„å€¼åœ¨é€€å‡ºè¢«è°ƒç”¨å‡½æ•°æ—¶å¿…é¡»ä¸è¿›å…¥æ—¶çš„å€¼ç›¸åŒã€‚</td>
</tr>
<tr>
<td>R14</td>
<td>ç”¨ä½œ LRï¼Œé“¾æ¥å¯„å­˜å™¨ï¼Œä¿å­˜å‡½æ•°çš„è¿”å›åœ°å€ï¼›å¦‚æœåœ¨å‡½æ•°ä¸­ä¿å­˜äº†è¿”å›åœ°å€ï¼Œå¯„å­˜å™¨R14 åˆ™å¯ä»¥ç”¨ä½œå…¶ä»–ç”¨é€”</td>
</tr>
<tr>
<td>R15</td>
<td>ç”¨ä½œ PCï¼Œç¨‹åºè®¡æ•°å™¨</td>
</tr>
<tr>
<td>R16</td>
<td>CPSRï¼ŒçŠ¶æ€å¯„å­˜å™¨</td>
</tr>
</tbody>
</table>
<p><strong>ä¾‹ï¼š</strong><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/LoopAndLoop.apk" target="_blank" rel="external">LoopAndLoop.apk</a></p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://github.com/toToCW/CTF-Mobile" target="_blank" rel="external">CTF-Mobile</a></p>
<p><a href="https://github.com/ctfs/write-ups-2015" target="_blank" rel="external">write-ups-2015</a></p>
]]></content>
      
        
        <tags>
            
            <tag> reversing </tag>
            
            <tag> CTF </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gdb è°ƒè¯• Android app]]></title>
      <url>/2017/06/21/android-gdb/</url>
      <content type="html"><![CDATA[<p>Android NDK åœ¨ r11 ä¹‹åå»æ‰äº† toolchain ä¸­çš„ gdb å·¥å…·ï¼Œæ— å¥ˆä¸‹è½½äº† r10 çš„ arm-linux-androideabi-gdb å’Œ gdbserverã€‚<a id="more"></a></p>
<p>æŠŠ  arm-linux-androideabi-gdb æ”¾åœ¨ ndk çš„ <code>toolchains/arm-linux-androideabi-4.9/prebuilt/*platform*-x86_64/bin</code> ç›®å½•ä¸‹ï¼ŒæŠŠ <code>gdbserver</code> push åˆ°æ‰‹æœºçš„ <code>system/bin</code> ä¸‹å¹¶æ·»åŠ æ‰§è¡Œæƒé™ã€‚</p>
<blockquote>
<p>æœ¬æ¬¡æµ‹è¯•ç”¨ crackme æ¥è‡ª 0CTF 2015 Quals : <a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/simple.apk" target="_blank" rel="external">simple.apk</a></p>
</blockquote>
<p>åœ¨æ‰‹æœºä¸Šæ‰“å¼€ app å¹¶æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ps | grep easy</div><div class="line">gdbserver :1234 --attach 7967   // 1234 ä¸ºç«¯å£ï¼Œå¯éšæ„æŒ‡å®šï¼›7967ä¸º pidã€‚</div></pre></td></tr></table></figure>
<p>åœ¨ç”µè„‘ç«¯æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">adb forward tcp:1234 tcp:1234</div><div class="line">arm-linux-androideabi-gdb</div><div class="line">(gdb) target remote :1234</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶è°ƒè¯•ç®—æ˜¯å·²ç»å¼€å§‹äº†ã€‚</p>
<p><strong>æ‰©å±•</strong>ï¼š</p>
<p>ä¸ºäº†æ‰¾åˆ°è¯¥ crackme çš„ flagï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç€æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(gdb) gcore</div></pre></td></tr></table></figure>
<p>ç­‰ gore dump å‡ºå†…å­˜åï¼Œåœ¨ç”µè„‘ç«¯çš„å½“å‰ç›®å½•ä¸‹ä½¿ç”¨<code>strings</code>å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">strings core.7967 | grep 0CTF</div></pre></td></tr></table></figure>
<p>å³å¯å¾—åˆ° flag ï¼Œçœå»äº†é™æ€åˆ†æå’ŒåŠ¨æ€è°ƒè¯•çš„ç¹çã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> debug </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¿»è¯‘ - å¤šç§ç‰¹å¾æ£€æµ‹ Frida]]></title>
      <url>/2017/05/08/detect-frida/</url>
      <content type="html"><![CDATA[<p>Frida åœ¨é€†å‘å·¥ç¨‹ç‹®ä¸­å¾ˆå—æ¬¢è¿ï¼Œä½ åŸºæœ¬å¯ä»¥åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°ä½ èƒ½æƒ³åˆ°çš„ä»»ä½•ä¸œè¥¿ï¼Œå†…å­˜åœ°å€ã€native å‡½æ•°ã€Java å®ä¾‹å¯¹è±¡ç­‰ã€‚åœ¨ OWASP çš„ç§»åŠ¨æµ‹è¯•æŒ‡å—é‡Œå°±æåˆ°äº† Fridaã€‚<a id="more"></a>ä½†æ˜¯å•Šï¼Œæ¯å‡ºæ¥ä¸ªå¥½ç”¨çš„æ³¨å…¥å·¥å…·ï¼Œéƒ½ä¼šæœ‰åæ³¨å…¥ã€ååæ³¨å…¥ã€åååæ³¨å…¥ã€åâ€¦æ³¨å…¥ã€‚è¿™ç¯‡æ–‡ç« è¦ä»‹ç»çš„æ˜¯ Android APP æ£€æµ‹ Frida çš„æ–¹æ³•ã€‚</p>
<h2 id="æ£€æŸ¥-Frida-çš„ç—•è¿¹"><a href="#æ£€æŸ¥-Frida-çš„ç—•è¿¹" class="headerlink" title="æ£€æŸ¥ Frida çš„ç—•è¿¹"></a>æ£€æŸ¥ Frida çš„ç—•è¿¹</h2><p>ä¸€ç§ç®€æ˜“æ–¹æ³•æ˜¯æ£€æµ‹ Frida çš„è¿è¡Œç—•è¿¹ï¼Œä¹Ÿé€‚ç”¨äºåŒç±»å·¥å…·çš„æ£€æµ‹ï¼Œæ¯”å¦‚åŒ…æ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€åº“æ–‡ä»¶ã€è¿›ç¨‹ã€ä¸´æ—¶æ–‡ä»¶ç­‰ç­‰ã€‚æœ¬ä¾‹ä¸­é’ˆå¯¹çš„å¯¹è±¡æ˜¯ fridaserverï¼Œå®ƒé€šè¿‡ TCP å¯¹å¤–ä¸ frida é€šä¿¡ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ Java éå†è¿è¡Œçš„è¿›ç¨‹åˆ—è¡¨ä»è€Œæ£€æŸ¥ fridaserver æ˜¯å¦åœ¨è¿è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public boolean checkRunningProcesses() &#123;</div><div class="line"></div><div class="line">  boolean returnValue = false;</div><div class="line"></div><div class="line">  // Get currently running application processes</div><div class="line">  List&lt;RunningServiceInfo&gt; list = manager.getRunningServices(300);</div><div class="line"></div><div class="line">  if(list != null)&#123;</div><div class="line">    String tempName;</div><div class="line">    for(int i=0;i&lt;list.size();++i)&#123;</div><div class="line">      tempName = list.get(i).process;</div><div class="line"></div><div class="line">      if(tempName.contains(&quot;fridaserver&quot;)) &#123;</div><div class="line">        returnValue = true;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‹¥ Frida è¿è¡Œåœ¨é»˜è®¤é…ç½®æ—¶æ­¤æ³•æœ‰æ•ˆï¼Œè‹¥æ˜¯é‡åˆ°ä¸ªç¬¨æ‹™çš„è„šæœ¬å°å­ï¼Œåœ¨ç¬¬ä¸€æ­¥å°±èƒ½ç»Šå€’ä»–ã€‚ç»•è¿‡ä¹Ÿæ˜¯ç›¸å½“ç®€å•ï¼Œåªéœ€é‡å‘½å fridaserverï¼Œæˆ‘ä»¬å¾—æ‰¾ä¸ªæ›´å¥½çš„æ–¹æ³•ã€‚</p>
<p>fridaserver é»˜è®¤çš„ TCP ç«¯å£æ˜¯ 27047ï¼Œå¯ä»¥æ£€æŸ¥è¿™ä¸ªç«¯å£æ˜¯å¦å¼€æ”¾ã€‚native ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">boolean is_frida_server_listening() &#123;</div><div class="line">    struct sockaddr_in sa;</div><div class="line"></div><div class="line">    memset(&amp;sa, 0, sizeof(sa));</div><div class="line">    sa.sin_family = AF_INET;</div><div class="line">    sa.sin_port = htons(27047);</div><div class="line">    inet_aton(&quot;127.0.0.1&quot;, &amp;(sa.sin_addr));</div><div class="line"></div><div class="line">    int sock = socket(AF_INET , SOCK_STREAM , 0);</div><div class="line"></div><div class="line">    if (connect(sock , (struct sockaddr*)&amp;sa , sizeof sa) != -1) &#123;</div><div class="line">      /* Frida server detected. Do somethingâ€¦ */</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒæ ·ï¼Œè¿™ä¹Ÿå¾—è¦æ±‚ fridaserver æ˜¯é»˜è®¤é…ç½®è¿è¡Œï¼Œå‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°å°±å¯ä»¥æ”¹å˜å®ƒçš„ç›‘å¬ç«¯å£ï¼Œç»•è¿‡ä¹Ÿå¤ªä¸éº»çƒ¦äº†ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥ç”¨â€™ nmap -sVâ€™ æ‰¾åˆ°å¼€æ”¾ç«¯å£æ¥æ”¹å–„è¿™ä¸ªæ–¹æ³•ã€‚å› ä¸º fridaserver ä½¿ç”¨ D-Bus åè®®é€šä¿¡ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªå¼€æ”¾çš„ç«¯å£å‘é€ D-Bus çš„è®¤è¯æ¶ˆæ¯ï¼Œå“ªä¸ªç«¯å£å›å¤äº†å“ªä¸ªå°±æ˜¯ fridaserverã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Mini-portscan to detect frida-server on any local port.</div><div class="line"> */</div><div class="line"></div><div class="line">for(i = 0 ; i &lt;= 65535 ; i++) &#123;</div><div class="line"></div><div class="line">    sock = socket(AF_INET , SOCK_STREAM , 0);</div><div class="line">    sa.sin_port = htons(i);</div><div class="line"></div><div class="line">    if (connect(sock , (struct sockaddr*)&amp;sa , sizeof sa) != -1) &#123;</div><div class="line"></div><div class="line">        __android_log_print(ANDROID_LOG_VERBOSE, APPNAME,  &quot;FRIDA DETECTION [1]: Open Port: %d&quot;, i);</div><div class="line"></div><div class="line">        memset(res, 0 , 7);</div><div class="line"></div><div class="line">        // send a D-Bus AUTH message. Expected answer is â€œREJECT&quot;</div><div class="line"></div><div class="line">        send(sock, &quot;\x00&quot;, 1, NULL);</div><div class="line">        send(sock, &quot;AUTH\r\n&quot;, 6, NULL);</div><div class="line"></div><div class="line">        usleep(100);</div><div class="line"></div><div class="line">        if (ret = recv(sock, res, 6, MSG_DONTWAIT) != -1) &#123;</div><div class="line"></div><div class="line">            if (strcmp(res, &quot;REJECT&quot;) == 0) &#123;</div><div class="line">               /* Frida server detected. Do somethingâ€¦ */</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    close(sock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç°åœ¨å¥½åƒæœ‰äº†ä¸ªéå¸¸å¥½ç”¨çš„æ–¹æ³•äº†å‘¢ï¼Œä½†æ˜¯è¿˜å­˜åœ¨é—®é¢˜ã€‚Frida æä¾›ä¸éœ€è¦ fridaserver è¿è¡Œçš„æ¨¡å¼ï¼æ€ä¹ˆæ£€æµ‹ï¼Ÿï¼</p>
<p>Frida çš„å„ä¸ªæ¨¡å¼éƒ½æ˜¯ç”¨æ¥æ³¨å…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ç‚¹å°±æ˜¯ frida è¿è¡Œæ—¶æ˜ å°„åˆ°å†…å­˜çš„åº“ã€‚æœ€ç›´æ¥çš„æ˜¯æŒ¨ä¸ªæ£€æŸ¥åŠ è½½çš„åº“ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">char line[512];</div><div class="line">FILE* fp;</div><div class="line"></div><div class="line">fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);</div><div class="line"></div><div class="line">if (fp) &#123;</div><div class="line">    while (fgets(line, 512, fp)) &#123;</div><div class="line">        if (strstr(line, &quot;frida&quot;)) &#123;</div><div class="line">            /* Evil library is loaded. Do somethingâ€¦ */</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fclose(fp);</div><div class="line"></div><div class="line">    &#125; else &#123;</div><div class="line">       /* Error opening /proc/self/maps. If this happens, something is off. */</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ£€æµ‹åå­—å«æœ‰â€œfridaâ€çš„åº“ï¼Œè¡¨æ˜ä¸Šæœ‰ç”¨ï¼Œå®é™…ä¸Šï¼š</p>
<ul>
<li><p>è¿˜è®°å¾—ä¸ºä»€ä¹ˆæ£€æµ‹åå­—æ˜¯â€œfridaserverâ€çš„æ–¹æ³•ä¸ºä»€ä¹ˆä¸å¯é å§ï¼Ÿè¿™é‡Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œç¨å¾®æ”¹ä¸€ä¸‹ frida å°±èƒ½é‡å‘½åä»£ç†åº“åã€‚</p>
</li>
<li><p>è¿™æ®µä»£ç ä¾èµ–çš„æ˜¯æ ‡å‡†åº“çš„<code>fopen()</code>å’Œ<code>strstr()</code>å‡½æ•°ï¼Œå¯ç¬‘çš„æ˜¯ï¼Œæˆ‘ä»¬ç«Ÿæƒ³ç”¨èƒ½è¢« frida è½»è€Œæ˜“ä¸¾å°± hook çš„å‡½æ•°æ¥æ£€æµ‹ frida ï¼</p>
</li>
</ul>
<p>é—®é¢˜1å¯ä»¥ç”¨ç»å…¸çš„ç—…æ¯’æ‰«ææ³•è§£å†³ï¼Œåœ¨å†…å­˜ä¸­æ‰«æ frida çš„åº“ç‰¹å¾ â€œgadgetsâ€ã€‚æˆ‘é€‰æ‹©å­—ç¬¦ä¸² â€œLIBFRIDAâ€ï¼Œå®ƒåœ¨æ‰€æœ‰ frida-gadget å’Œ frida-agent çš„ç‰ˆæœ¬ä¸­éƒ½æœ‰å‡ºç°ã€‚ä¸‹é¢çš„ä»£ç æ‰«æäº†åœ¨ <code>/proc/sel/maps</code> é‡Œæ‰¾åˆ°çš„æ‰€æœ‰çš„å¯æ‰§è¡Œæ®µï¼Œä¸ºäº†ç®€æ´æˆ‘æ”¾äº†éƒ¨åˆ†ä»£ç ï¼Œå®Œæ•´çš„åœ¨ <a href="https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/native-lib.cpp" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/native-lib.cpp</a> ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static char keyword[] = &quot;LIBFRIDA&quot;;</div><div class="line">num_found = 0;</div><div class="line"></div><div class="line">int scan_executable_segments(char * map) &#123;</div><div class="line">    char buf[512];</div><div class="line">    unsigned long start, end;</div><div class="line"></div><div class="line">    sscanf(map, &quot;%lx-%lx %s&quot;, &amp;start, &amp;end, buf);</div><div class="line"></div><div class="line">    if (buf[2] == &apos;x&apos;) &#123;</div><div class="line">        return (find_mem_string(start, end, (char*)keyword, 8) == 1);</div><div class="line">    &#125; else &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void scan() &#123;</div><div class="line"></div><div class="line">    if ((fd = my_openat(AT_FDCWD, &quot;/proc/self/maps&quot;, O_RDONLY, 0)) &gt;= 0) &#123;</div><div class="line"></div><div class="line">    while ((read_one_line(fd, map, MAX_LINE)) &gt; 0) &#123;</div><div class="line">        if (scan_executable_segments(map) == 1) &#123;</div><div class="line">            num_found++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (num_found &gt; 1) &#123;</div><div class="line"></div><div class="line">        /* Frida Detected */</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ <code>my_openat()</code> ç­‰å‡½æ•°ï¼Œå®ƒä»¬å¹¶éå¹³å¸¸çš„ libc åº“å‡½æ•°ï¼Œæ˜¯è‡ªå®šä¹‰å®ç°çš„ï¼Œä½†æ˜¯åŠŸèƒ½å’Œ libc ä¸­çš„ä¸€æ ·ï¼Œè®¾ç½®äº†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œæ‰§è¡Œäº†è½¯ä¸­æ–­ã€‚å› ä¸ºç›´æ¥è°ƒç”¨å…¬å…± API å¹¶ä¸å¯é ï¼Œè¿™æ ·ä¸å®¹æ˜“è¢« hookã€‚å®Œæ•´çš„å®ç°åœ¨ <a href="https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/syscall.S" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/syscall.S</a> ã€‚ä¸‹é¢æ˜¯ my_openat çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#include &quot;bionic_asm.h&quot;</div><div class="line"></div><div class="line">.text</div><div class="line">    .globl my_openat</div><div class="line">    .type my_openat,function</div><div class="line">my_openat:</div><div class="line">    .cfi_startproc</div><div class="line">    mov ip, r7</div><div class="line">    .cfi_register r7, ip</div><div class="line">    ldr r7, =__NR_openat</div><div class="line">    swi #0</div><div class="line">    mov r7, ip</div><div class="line">    .cfi_restore r7</div><div class="line">    cmn r0, #(4095 + 1)</div><div class="line">    bxls lr</div><div class="line">    neg r0, r0</div><div class="line">    b __set_errno_internal</div><div class="line">    .cfi_endproc</div><div class="line"></div><div class="line">    .size my_openat, .-my_openat;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œæ€»ç®—æ˜¯æœ‰æ•ˆçš„æ–¹æ³•äº†ï¼Œåªç”¨ frida çš„è¯ä¹Ÿä¸å®¹æ˜“ç»•è¿‡ï¼ŒåŠ äº†æ··æ·†æ›´éš¾ã€‚å³ä½¿è¿™æ ·ï¼Œä¾ç„¶æœ‰å¾ˆå¤šåŠæ³•å¯ä»¥ç»•è¿‡ï¼Œç›´æ¥èƒ½æƒ³åˆ°çš„å°±æ˜¯æ‰“è¡¥ä¸ã€hook ç³»ç»Ÿè°ƒç”¨ã€‚ä½†æ˜¯è®°ä½ï¼Œé€†å‘å·¥ç¨‹æ°¸è¿œèƒœåˆ©ï¼</p>
<p>æƒ³è¦è¯•éªŒï¼Œå¯ä»¥åœ¨è¿™é‡Œ <a href="https://github.com/b-mueller/frida-detection-demo/" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/</a> ä¸‹è½½ Android studio å·¥ç¨‹ã€‚frida æ³¨å…¥æ—¶çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://vp-web.s3.amazonaws.com/uploads/ckeditor/pictures/73/content_fridadetection.jpg" alt=""></p>
<hr>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="http://www.vantagepoint.sg/blog/90-the-jiu-jitsu-of-detecting-frida" target="_blank" rel="external">http://www.vantagepoint.sg/blog/90-the-jiu-jitsu-of-detecting-frida</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-217482.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> translation </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¿»è¯‘ - ç”¨ VirtualBox è°ƒè¯• macOS å†…æ ¸]]></title>
      <url>/2017/04/14/debug-macos-kernel/</url>
      <content type="html"><![CDATA[<p><strong>é‡å¤§æ›´æ–°</strong>ï¼šawalton åœ¨ Hacker News ä¸Šçš„è®¨è®ºä¸­æåˆ°ï¼šVMWare é‡Œå¯ä»¥è®¾ç½® CPUID æ ‡å¿—æ¥ç¦ç”¨ SMAPï¼Œåªéœ€è¦åœ¨ vmx æ–‡ä»¶ä¸­åŠ ä¸Šcpuid.7.ebx = â€œâ€”â€”â€”â€“0â€”â€”â€”â€”â€”â€”â€“â€.<a id="more"></a></p>
<hr>
<p>ä¸Šå¹´ï¼Œæˆ‘ç»™æˆ‘çš„è€ MBP å‡çº§äº†2016å¹´çš„ Skylake Intel å¤„ç†å™¨ã€‚æˆ‘åœ¨è°ƒè¯•ä¸€ä¸ªå†…æ ¸æ¼æ´æ—¶ï¼Œå‘ç°æˆ‘çš„ VMWare å¼€å¯äº†â€œSMAPâ€(é˜²æ­¢è¶…çº§ç”¨æˆ·è®¿é—®)æœºåˆ¶ã€‚æˆ‘æ‰¾ä¸åˆ°æ€ä¹ˆå…³é—­ SMAPï¼Œè¿˜å¥½ VirtualBox ç›®å‰å¥½åƒä¸æ”¯æŒ SMAPï¼Ÿ</p>
<p>è¿™ç¯‡æ–‡ç« ä¼šæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•ç”¨ VirtualBox è¿›è¡Œ macOS å†…æ ¸çš„æºç çº§è°ƒè¯•ã€‚è™½ç„¶è¿™äº›æ­¥éª¤éƒ½æ˜¯åœ¨ VirtualBoxä¸Šè¿›è¡Œçš„ï¼Œä½†åœ¨ VMWare ä¸Šä¹Ÿæ˜¯é€šç”¨çš„ï¼Œç”šè‡³æ›´ç®€å•ã€‚</p>
<h1 id="å®‰è£…-VirtualBox-å’Œ-Sierra"><a href="#å®‰è£…-VirtualBox-å’Œ-Sierra" class="headerlink" title="å®‰è£… VirtualBox å’Œ Sierra"></a>å®‰è£… VirtualBox å’Œ Sierra</h1><p>å¦‚æœä½ è¿˜æ²¡åœ¨ VirtualBox ä¸Šå®‰è£… macOS é•œåƒï¼Œä½ å¯ä»¥å¤ç”¨ VMWare çš„ vmdkï¼Œä¹Ÿå¯ä»¥è£…ä¸ªæ–°çš„ã€‚é‡æ–°å®‰è£…ç³»ç»Ÿéœ€è¦ ISO é•œåƒï¼Œä¸‹é¢çš„å‘½ä»¤å¯ä»¥å°†ä»<a href="https://itunes.apple.com/us/app/macos-sierra/id1127487414?ls=1&amp;mt=12" target="_blank" rel="external">Mac app store</a>ä¸‹è½½çš„ Sierra è½¬æˆ ISOã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ hdiutil attach /Applications/Install\ macOS\ Sierra.app/Contents/SharedSupport/InstallESD.dmg -noverify -nobrowse -mountpoint /Volumes/installesd</div><div class="line">$ hdiutil create -o /tmp/Sierra -size 8g -type SPARSE -layout SPUD -fs HFS+J</div><div class="line">$ hdiutil attach /tmp/Sierra.sparseimage -noverify -nobrowse -mountpoint /Volumes/install</div><div class="line">$ asr restore -source /Volumes/installesd/BaseSystem.dmg -target /Volumes/install -noprompt -noverify -erase</div><div class="line">$ rm /Volumes/OS\ X\ Base\ System/System/Installation/Packages</div><div class="line">$ cp -rp /Volumes/installesd/Packages /Volumes/OS\ X\ Base\ System/System/Installation/</div><div class="line">$ cp -rp /Volumes/installesd/BaseSystem.dmg /Volumes/OS\ X\ Base\ System/BaseSystem.dmg</div><div class="line">$ cp -rp /Volumes/installesd/BaseSystem.chunklist /Volumes/OS\ X\ Base\ System/BaseSystem.chunklist</div><div class="line">$ hdiutil detach /Volumes/installesd</div><div class="line">$ hdiutil detach /Volumes/OS\ X\ Base\ System/</div><div class="line">$ hdiutil resize -sectors min /tmp/Sierra.sparseimage</div><div class="line">$ hdiutil convert /tmp/Sierra.sparseimage -format UDTO -o /tmp/Sierra</div><div class="line">$ rm /tmp/Sierra.sparseimage</div><div class="line">$ mv /tmp/Sierra.cdr /tmp/Sierra.iso</div></pre></td></tr></table></figure>
<h2 id="ç½‘ç»œè®¾ç½®"><a href="#ç½‘ç»œè®¾ç½®" class="headerlink" title="ç½‘ç»œè®¾ç½®"></a>ç½‘ç»œè®¾ç½®</h2><p>å¦‚æœä½ ç”¨äº†æ¡¥æ¥ï¼Œå¯ä»¥è·³è¿‡è¿™éƒ¨åˆ†ã€‚</p>
<p>å¦‚æœç”¨çš„æ˜¯ NATï¼Œéœ€è¦ä¸º KDP å¼€å¯ç«¯å£è½¬å‘ã€‚ç‚¹å‡»â€œç½‘ç»œâ€ï¼Œé€‰æ‹©â€œé«˜çº§â€ -&gt; â€œç«¯å£è½¬å‘â€ï¼Œå°† localhost 41139/UDP è½¬å‘åˆ°è™šæ‹Ÿæœºçš„ 41139/UDPï¼Œå°±èƒ½å¤Ÿè®¿é—®åˆ°è™šæ‹Ÿæœºçš„ 41139 ç«¯å£äº†ã€‚</p>
<h1 id="å®‰è£…-XCode"><a href="#å®‰è£…-XCode" class="headerlink" title="å®‰è£… XCode"></a>å®‰è£… XCode</h1><p>åœ¨ä½ çš„ä¸»æœºä¸Šå®‰è£… XCodeï¼Œé€šè¿‡ App store å®‰è£…æœ€ç®€å•ã€‚ å¯ä»¥ç›´æ¥æ‰“å¼€ XCodeï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œ <code>sudo xcodebuild -license accept</code> æ¥å— XCode licenseã€‚</p>
<h1 id="å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶-KDK"><a href="#å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶-KDK" class="headerlink" title="å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶(KDK)"></a>å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶(KDK)</h1><p>æ ¹æ®æˆ‘ä»¬è¦è°ƒè¯•çš„ macOS ç‰ˆæœ¬ä» Apple å¼€å‘è€…ä¸­å¿ƒå®‰è£… KDK ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯10.12 build 16A323.</p>
<p>KDK çš„å®‰è£…ç›®å½•æ˜¯<code>/Library/Developer/KDKs</code>ï¼Œæä¾›çš„å†…æ ¸ç‰ˆæœ¬ã€ç¬¦å·ã€å†…æ ¸æ‰©å±•éƒ½æœ‰ RELEASEã€DEVELOPMENTã€DEBUG ä¸‰ç§ç‰ˆæœ¬ã€‚ä¸åŒä¹‹å¤„åœ¨äº DEVELOPMENT å’Œ DEBUG ç‰ˆæ¯” RELEASE ç‰ˆå¤šäº†äº›æ–­è¨€å’Œé”™è¯¯æ£€æŸ¥ï¼ŒDEBUG ç‰ˆçš„æœ€ä¸°å¯Œã€‚</p>
<p>æ³¨æ„ï¼šè¢«è°ƒè¯•çš„ç³»ç»Ÿä¸éœ€è¦å®‰è£… KDKã€‚</p>
<h1 id="ä¿®æ”¹-nvram-boot-args"><a href="#ä¿®æ”¹-nvram-boot-args" class="headerlink" title="ä¿®æ”¹ nvram boot-args"></a>ä¿®æ”¹ nvram boot-args</h1><p>ä¸ºäº†èƒ½å¤Ÿè°ƒè¯•è™šæ‹Ÿæœºï¼Œéœ€è¦è®¾ç½®è™šæ‹Ÿæœºä¸Š nvram ä¸­çš„ debug é¡¹ã€‚é™¤äº† debug çš„å€¼å¤–å…¶ä»–å€¼ä¹Ÿèƒ½è¢«æˆ‘ä»¬æ‰€ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€äº›å› å‚æ–¯æŒºçš„é€‰é¡¹ï¼š</p>
<ul>
<li>-vï¼šä»¥ verbose æ¨¡å¼å¯åŠ¨ç³»ç»Ÿã€‚</li>
<li>kcsuffixï¼šå¡«å†™åç¼€ä»¥æŒ‡å®šå¯åŠ¨çš„å†…æ ¸ã€‚</li>
<li>pmuflagsï¼šè²Œä¼¼å¤§å®¶éƒ½æ¨èæŠŠè¿™é¡¹å€¼è®¾ä¸º1ã€‚ç„¶è€Œ Appleâ€™s Kernel Programming Guide å·²ç»æ˜ç¡®æŒ‡å‡ºç®¡ç†ç”µæºçš„çœ‹é—¨ç‹—å®šæ—¶å™¨â€œåªåœ¨å°å¼æœºã€ç¬”è®°æœ¬çš„ G4 ç‰ˆæœ¬å’Œå°å¼æœºçš„ G5 ç‰ˆæœ¬åŠä¹‹å‰æœ‰ä½œç”¨â€ï¼Œå…¶ä»–çš„çœ‹é—¨ç‹—å®šæ—¶å™¨â€œåªåœ¨ OS X Server ä¸­å¯ç”¨â€ã€‚æ‰€ä»¥ï¼Œè™½ç„¶è®¾ç½®äº†ä¹Ÿä¸å½±å“ï¼Œä½†è¿™ä¸ªé€‰é¡¹çœŸæ²¡ä»€ä¹ˆåµç”¨ã€‚</li>
<li>debugï¼šå…è®¸è¿œç¨‹å†…æ ¸è°ƒè¯•ã€‚ Apple docs é‡Œæœ‰åˆ—å‡ºå¯ç”¨çš„æ ‡å¿—ã€‚æˆ‘å¸¸ç”¨çš„æ˜¯<code>DB_LOG_PI_SCRN | DB_ARP | DB_NMI</code>ã€‚å¦å¤–ï¼Œ<code>control + option + command + shift + escape</code> å¯ä»¥è§¦å‘ä¸å¯å±è”½ä¸­æ–­ï¼ˆNMIï¼‰ï¼Œç»§è€Œå¼•å‘è°ƒè¯•å™¨ä¸­æ–­ï¼Œè¶…çº§æ–¹ä¾¿ã€‚è¿™å¯¹ç»„åˆé”®è·Ÿ host key çš„ç»„åˆé”®å†²çªçš„æ—¶å€™ç”¨èµ·æ¥å¾ˆéš¾å—ï¼Œæ‰€ä»¥æˆ‘æŠŠ host key é‡æ–°ç»‘å®šæˆ<code>command + right</code>äº†ã€‚</li>
</ul>
<h2 id="ä¿®æ”¹-nvram"><a href="#ä¿®æ”¹-nvram" class="headerlink" title="ä¿®æ”¹ nvram"></a>ä¿®æ”¹ nvram</h2><p>åœ¨ VMware é‡Œï¼Œå¯ç”¨è¿™æ ·ä¿®æ”¹ nvramï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo nvram boot-args=&quot;-v debug=0x144&quot;</div></pre></td></tr></table></figure></p>
<p>åœ¨ virtualbox é‡Œæ²¡é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºä¸€é‡å¯ä¿®æ”¹çš„å€¼å°±æ²¡äº†ã€‚è¿˜å¥½ä» virtualbox æ‰‹å†Œçš„ 3.13.2 çœ‹åˆ°äº†å¸Œæœ›ï¼š</p>
<blockquote>
<p>ä¸èƒ½åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºå†…éƒ¨æ“ä½œ EFI å˜é‡äº†ï¼ˆå¦‚ï¼šåœ¨Mac OS X è™šæ‹Ÿæœºé‡Œè¿è¡Œ nvram æ¥è®¾ç½®â€œboot-argsâ€ä¸ç®¡ç”¨äº†ï¼‰ã€‚ä¸è¿‡ï¼Œå¯ä»¥é€šè¿‡ç»™è™šæ‹Ÿæœºå‘é€é™„åŠ æ•°æ®â€VBoxInternal2/EfiBootArgsâ€ æ¥è®¾ç½®â€œboot-argsâ€ã€‚â€¦</p>
</blockquote>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­è™šæ‹Ÿæœºï¼Œåœ¨ä¸»æœºä¸Šè¿è¡Œå‘½ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ VBoxManage list vms # åˆ—å‡ºä¸‹æ¡å‘½ä»¤ä½¿ç”¨çš„ UUID</div><div class="line">&quot;macOS 10.12.0&quot; &#123;9ad936f8-9360-44a6-ba3e-c4d92b4243e8&#125;</div><div class="line">$ VBoxManage setextradata 9ad936f8-9360-44a6-ba3e-c4d92b4243e8 VBoxInternal2/EfiBootArgs &quot;-v debug=0x144&quot;</div></pre></td></tr></table></figure></p>
<h1 id="äº¤æ¢å†…æ ¸"><a href="#äº¤æ¢å†…æ ¸" class="headerlink" title="äº¤æ¢å†…æ ¸"></a>äº¤æ¢å†…æ ¸</h1><p>å‰é¢æˆ‘æåˆ°å¯ä»¥æŒ‡å®š<code>kcsuffix</code>é€‰é¡¹ä»¥è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ã€‚å†…æ ¸æ–‡ä»¶åœ¨è™šæ‹Ÿæœºçš„<code>/System/Library/Kernels</code>ç›®å½•ï¼Œç„¶è€Œè¿™ä¸ªç›®å½•å—â€œç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤â€æœºåˆ¶ä¿æŠ¤ï¼ˆSIPï¼‰ã€‚æ‰€ä»¥è¦æƒ³ä½¿ç”¨ KDK æˆ–è€…è‡ªå·±ç¼–è¯‘çš„å†…æ ¸ï¼Œå¿…é¡»å¯åŠ¨è¿›å…¥ recoveryï¼ŒæŠŠç›®æ ‡å†…æ ¸æ‹·è¿›<code>/System/Library/Kernels</code>ç›®å½•ï¼Œä½¿ kextcache å¤±æ•ˆï¼Œç„¶åé‡æ–°å¯åŠ¨ã€‚</p>
<h2 id="å¯åŠ¨è¿›å…¥-recovery"><a href="#å¯åŠ¨è¿›å…¥-recovery" class="headerlink" title="å¯åŠ¨è¿›å…¥ recovery"></a>å¯åŠ¨è¿›å…¥ recovery</h2><p>åœ¨ VMware é‡Œï¼Œ<code>cmd + R</code>å°±èƒ½è¿›å…¥ recovery æ¨¡å¼ã€‚virtualbox è¦å¤šå‡ æ­¥ã€‚</p>
<p>å¯åŠ¨è™šæ‹Ÿæœºæ—¶ï¼ŒæŒ‰ä½<code>F12</code>ï¼Œç„¶åé€‰æ‹©<code>Boot Manager -&gt; EFI Internal Shell</code>ï¼Œå°±ä¼šçœ‹åˆ° EFI Shell çš„æ¬¢è¿ç•Œé¢ã€‚è¾“å…¥å‘½ä»¤è¿›å…¥ recoveryï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FS2:\com.apple.recovery.boot\boot.efi</div></pre></td></tr></table></figure></p>
<p>è¿›å…¥ recovery çš„ç•Œé¢ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œæ“ä½œç›®æ ‡å†…æ ¸ï¼Œå¹¶å°† kextcache è®¾ç½®ä¸ºæ— æ•ˆã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># mv /path/to/kernels/kernel.development /System/Library/Kernels</div><div class="line"># kextcache -invalidate /Volumes/Macintosh\ HD</div><div class="line"># reboot</div></pre></td></tr></table></figure></p>
<p>å¦‚æœéœ€è¦ç¦ç”¨ SIPï¼Œåœ¨é‡å¯ä¹‹å‰æ‰§è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># csrutil disable</div><div class="line">Successfully disabled System Integrity Protection. Please restart the machine for the changes to take effect.</div></pre></td></tr></table></figure></p>
<h1 id="æºç è°ƒè¯•"><a href="#æºç è°ƒè¯•" class="headerlink" title="æºç è°ƒè¯•"></a>æºç è°ƒè¯•</h1><p>ä¸‹è½½è¦è°ƒè¯•çš„ç‰ˆæœ¬çš„ XNU æºç ã€‚è°ƒè¯•æ—¶ï¼ŒLLDB ä¼šå» <code>/Library/Caches/com.apple.xbs/Sources/xnu/xnu-...</code>ç›®å½•å¯»æ‰¾å†…æ ¸æºç ï¼Œæ‰€ä»¥å¯ä»¥æŠŠä¸‹è½½çš„æºç æ”¾è¿™ä¸ªç›®å½•ï¼Œä¹Ÿå¯ä»¥å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æŒ‡å‘æºç ç›®å½•ã€‚è¿˜æœ‰ä¸ªæ–¹æ³•æ˜¯ è®¾ç½® LLDB çš„<code>target.source-map</code>å˜é‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lldb&gt; settings set target.source-map /Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.1.32 /Users/kedy/Downloads/xnu-3789.1.32</div></pre></td></tr></table></figure>
<p>æ—©ä¸€äº›çš„ macOS ç‰ˆæœ¬æ¯”å¦‚ Yosemite å°±åªèƒ½æŠŠæºç æ”¾åœ¨ <code>/SourceCache/xnu/</code>é‡Œã€‚</p>
<h1 id="å®‰è£…-LLDB"><a href="#å®‰è£…-LLDB" class="headerlink" title="å®‰è£… LLDB"></a>å®‰è£… LLDB</h1><p>ç»ˆäºåˆ°è°ƒè¯•å™¨äº†ã€‚ä¸‹é¢ä¼šä¸¾ä¾‹ç”¨çš„æ˜¯ RELEASE å†…æ ¸ã€‚</p>
<p>ä¸ºäº†åœ¨ Sierra KDK é‡Œç”¨ XNU LLDB å®ï¼Œæ‰§è¡Œ<code>pip install macholib</code>å®‰è£…<code>macholib</code>æ¨¡å—ã€‚ç²˜è´´æ‰§è¡ŒåŠ è½½å†…æ ¸æ–‡ä»¶æ—¶æç¤ºæˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p>è§¦å‘ NMI åï¼ˆæˆ–è€…ç­‰å¾…è®¾ç½®äº†<code>DB_HALT</code>çš„è°ƒè¯•å™¨æš‚åœå¯åŠ¨è¿›ç¨‹æ—¶ï¼‰ï¼Œæ‰§è¡Œ<code>kdp-remote &lt;ip&gt;</code>è¿æ¥åˆ°è°ƒè¯•è¿›ç¨‹ï¼ˆè‹¥ä½¿ç”¨çš„æ˜¯ NAT ç«¯å£è½¬å‘ï¼Œip æ˜¯ localhostï¼‰ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">$ lldb /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel</div><div class="line">(lldb) target create &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel&quot;</div><div class="line">warning: &apos;kernel&apos; contains a debug script. To run this script in this debug session:</div><div class="line"></div><div class="line">    command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py&quot;</div><div class="line"></div><div class="line">To run all discovered debug scripts in this session:</div><div class="line"></div><div class="line">    settings set target.load-script-from-symbol-file true</div><div class="line"></div><div class="line">Current executable set to &apos;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel&apos; (x86_64).</div><div class="line">(lldb) command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py&quot;</div><div class="line">Loading kernel debugging from /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py</div><div class="line">LLDB version lldb-370.0.40</div><div class="line">  Swift-3.1</div><div class="line">settings set target.process.python-os-plugin-path &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/core/operating_system.py&quot;</div><div class="line">settings set target.trap-handler-names hndl_allintrs hndl_alltraps trap_from_kernel hndl_double_fault hndl_machine_check _fleh_prefabt _ExceptionVectorsBase _ExceptionVectorsTable _fleh_undef _fleh_dataabt _fleh_irq _fleh_decirq _fleh_fiq_generic _fleh_dec</div><div class="line">command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/xnu.py&quot;</div><div class="line">xnu debug macros loaded successfully. Run showlldbtypesummaries to enable type summaries.</div><div class="line"></div><div class="line"></div><div class="line">(lldb) kdp-remote 192.168.149.184</div><div class="line">Version: Darwin Kernel Version 15.2.0: Fri Nov 13 19:56:56 PST 2015; root:xnu-3248.20.55~2/RELEASE_X86_64; UUID=17EA3101-D2E4-31BF-BDA9-931F51049F93; stext=0xffffff8007a00000</div><div class="line">Kernel UUID: 17EA3101-D2E4-31BF-BDA9-931F51049F93</div><div class="line">Load Address: 0xffffff8007a00000</div><div class="line">Kernel slid 0x7800000 in memory.</div><div class="line">Loaded kernel file /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel</div><div class="line">Target arch: x86_64</div><div class="line">Instantiating threads completely from saved state in memory.</div><div class="line">Loading 82 kext modules warning: Can&apos;t find binary/dSYM for com.apple.kec.corecrypto (491718F5-B509-31DC-92B5-6BAC95E3F494)</div><div class="line">.warning: Can&apos;t find binary/dSYM for com.apple.kec.pthread (0888BA0A-49EE-394A-AEB1-1E5C6838A1F2)</div><div class="line"></div><div class="line">(omitted...)</div><div class="line"></div><div class="line">. done.</div><div class="line">kernel was compiled with optimization - stepping may behave oddly; variables may not be available.</div><div class="line">Process 1 stopped</div><div class="line">* thread #2, name = &apos;0xffffff800db8b000&apos;, queue = &apos;0x0&apos;, stop reason = signal SIGSTOP</div><div class="line">    frame #0: 0xffffff8007bd655e kernel`Debugger(message=&lt;unavailable&gt;) at model_dep.c:1020 [opt]</div><div class="line">   1017</div><div class="line">   1018		doprnt_hide_pointers = old_doprnt_hide_pointers;</div><div class="line">   1019		__asm__(&quot;int3&quot;);</div><div class="line">-&gt; 1020		hw_atomic_sub(&amp;debug_mode, 1);</div><div class="line">   1021	&#125;</div><div class="line">   1022</div><div class="line">   1023	char *</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>ç§ï¼ŒmacOS å†…æ ¸æºç è°ƒè¯•è¿™å°±å¼€å§‹äº†ï¼</p>
<hr>
<p>åŸæ–‡é“¾æ¥: <a href="https://klue.github.io/blog/2017/04/macos_kernel_debugging_vbox/" target="_blank" rel="external">Securing Browsers Through Isolation Versus Mitigation</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-217023.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> translation </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¿»è¯‘ - â€œéš”ç¦»â€ä¸â€œç¼“è§£â€ - Chromeã€Edge åœ¨æµè§ˆå™¨é˜²æŠ¤ä¸Šçš„ç»ˆæå¯¹å†³ï¼]]></title>
      <url>/2017/03/10/chromeVSie/</url>
      <content type="html"><![CDATA[<p>æ˜¨å¤©å¾®è½¯å‘å¸ƒäº†ä¸€ç¯‡å…³äºâ€œ<a href="https://blogs.windows.com/msedgedev/2017/02/23/mitigating-arbitrary-native-code-execution/" target="_blank" rel="external">æ–°æ—§éš”ç¦»æœºåˆ¶</a>â€çš„æ–‡ç« [<em>è¯‘è€…æ³¨</em>:éš”ç¦»ä»»æ„ native ä»£ç çš„æ‰§è¡Œ]ï¼Œæˆ‘ä¸ªäººéå¸¸èµåŒä»–ä»¬ç»™ Edge æ•´ä¸Šè¿™ä¸ªæœºåˆ¶ï¼Œä½†å¤–é¢æœ‰äº›ä¸ªååº”ç®€ç›´å¤¸å¼ çš„ä¸çœŸå®ã€‚<a id="more"></a>æ¥çœ‹çœ‹ Dan Guido çš„ Twitter (å¯¹ä¸ä½äº† Dan ~ğŸ˜‰):</p>
<blockquote>
<p>æ¯«æ— äº‰è®®, Edge ä¸€è·ƒè¶…è¿‡ Chrome æˆä¸ºäº†æœ€å®‰å…¨çš„æµè§ˆå™¨ï¼ <a href="https://t.co/JeE08LHBBv" target="_blank" rel="external">https://t.co/JeE08LHBBv</a> â€”â€”<a href="https://twitter.com/dguido/status/834846901191204864" target="_blank" rel="external">@dguido</a></p>
</blockquote>
<p>åœ¨è¿™ä»¶äº‹ä¸Šï¼Œæˆ‘è®¤ä¸ºå¯¹æ¯” Chrome æ¥åè§‚å¾®è½¯è¿™æ¬¡çš„åŠ¨ä½œï¼Œå¼„æ¸…æ¥šæµè§ˆå™¨çš„ä¸–ç•Œé‡Œå‘ç”Ÿäº†ä»€ä¹ˆæ›´ä¸ºé‡è¦ã€‚å½“ç„¶ï¼Œä½œä¸º Chrome å®‰å…¨çš„å·¥ç¨‹æŒ‡å¯¼æˆ‘å¯èƒ½ä¼šåå¿ƒã€‚ä½†æ˜¯ï¼Œæˆ‘çš„å·¥ä½œè¦æ±‚æˆ‘å®¢è§‚çš„è¯„ä»·å„ç§å®‰å…¨æœºåˆ¶ä»è€ŒæŒ‡å¯¼æˆ‘çš„å›¢é˜Ÿçš„åŠªåŠ›æ–¹å‘ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘è¦ä½œå‡ºçš„ç»“è®ºè¿˜æ˜¯æŒºâ€œæ¸…ç™½â€çš„ã€‚</p>
<p><img src="http://bmob-cdn-1754.b0.upaiyun.com/2017/03/10/801c119140181489806cb2d2ed2d8216.jpeg" alt="EvsC"></p>
<h2 id="ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ-RCE"><a href="#ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ-RCE" class="headerlink" title="ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)"></a>ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)</h2><p>å¯¹äºå‰ç«¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå¾®è½¯å¯æ˜¯ä¸‹äº†å¤§åŠŸå¤«ã€‚å®ƒè¯•å›¾é€šè¿‡é˜²æ­¢æ”»å‡»è€…è·å¾—å¯é çš„ä»£ç è€Œæ‰“ç ´æ¼æ´åˆ©ç”¨çš„ç¬¬ä¸€ç¯ï¼Œå¦‚æœæˆåŠŸçš„è¯å°±å¯ä»¥å®Œå…¨é˜»æ­¢æ”»å‡»è€…ã€‚ä½†æœ€åä»ç„¶ä¼šæ¼”å˜æˆçŒ«æ‰è€é¼ çš„æ¸¸æˆï¼Œç¼“è§£è™½ç„¶å¯ä»¥æ¶ˆè€—æ”»å‡»è€…æ›´å¤šç²¾åŠ›ï¼Œå´ä¸èƒ½ä»æ ¹æœ¬ä¸Šé˜»æ­¢æ¼æ´åˆ©ç”¨ã€‚</p>
<p>ä¸ªäººæ¥è¯´ï¼Œæˆ‘è®¤ä¸ºå¾®è½¯æ­¤æ¬¡çš„ç€çœ¼ç‚¹ä»…ä»…æ˜¯æ”¾åœ¨äº† IE å’Œ Edge æœ€å¸¸å—åˆ°çš„æ”»å‡»ç±»å‹ä¸Šï¼Œâ€œè®©æ•°æ®è¯´è¯â€ä¹Ÿçš„ç¡®ä¸å¤±ä¸ºä¸€ç§åˆé€»è¾‘çš„ç­–ç•¥ã€‚è¿™æ ·çš„è¯å°±æœ‰ä¸€å¤§å †æ–°çš„ RCE ç¼“è§£æŠ€æœ¯ï¼Œè¿åŒç€å…¶ä¸ chrome ç±»ä¼¼æŠ€æœ¯çš„å¯¹æ¯”ï¼Œæˆ‘åœ¨ä¸‹é¢åˆ—äº†å†™å€¼å¾—æ³¨æ„çš„å‡ é¡¹:</p>
<ul>
<li><p>å†…å­˜å›æ”¶<br>é€šè¿‡å›æ”¶ DOM å¯¹è±¡ã€åœ¨ free æ“ä½œæ—¶ä½œç¼“è§£ï¼Œå†…å­˜å›æ”¶é™ä½äº†å¯åˆ©ç”¨çš„ use-after-free æ¼æ´å‡ºç°çš„å¯èƒ½æ€§ã€‚è¿™èƒ½ä¸ Chrome çš„ <a href="https://chromium.googlesource.com/chromium/src/+/master/third_party/WebKit/Source/platform/heap/BlinkGCAPIReference.md" target="_blank" rel="external">use of Oilpan</a> ç±»ä¼¼ï¼Œé€šè¿‡å›æ”¶ DOM å¯¹è±¡ã€åˆ†å—åˆ†é…å†…å­˜ï¼Œé‡‡ç”¨ä¸åŒçš„ç¼“è§£æªæ–½ï¼Œæ¥å¯¹æŠ—å‘ç”Ÿä¸­çš„ use-after-free åˆ©ç”¨ã€‚æ€»çš„æ¥è¯´ï¼Œå†…å­˜å›æ”¶åªæ˜¯ Chrome åœ¨è¿™å—å„¿çš„ä¸€ä¸ªå°ç‰¹ç‚¹ï¼Œç›¸å¯¹æ¥è¯´ Chrome æ²¡æœ‰é‚£ä¹ˆå¤šå¯åˆ©ç”¨çš„æ¼æ´ï¼Œè¿™å±€æ‰“å¹³ã€‚</p>
</li>
<li><p>æ‰§è¡Œæµä¿æŠ¤(CFG)</p>
</li>
</ul>
<p>CFG æä¾›å®Œæ•´çš„æ‰§è¡Œæµè¡¨ï¼Œåœ¨â€œé¢„é˜²ç›´æ¥æ‰§è¡Œéæ³•è·¯å¾„â€ä¸Šä½œäº†å¢å¼ºï¼ŒEdge åœ¨å†…éƒ¨ä»£ç å’Œç³»ç»Ÿåº“éƒ½ç”¨äº† CFGã€‚è€ŒChrome åªåœ¨ç³»ç»Ÿ DLL ç”¨äº† CFGï¼Œ å¦ä¸€æ–¹é¢ä¸æ˜¯ Chrome å†…éƒ¨è€Œæ˜¯ç”¨åœ¨äº† Clang/LLVM  å·¥å…·é“¾ä¸Šï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Clang çš„ CFI æ£€æŸ¥ï¼Œéå¸¸å¥½åœ°å¥‘åˆäº† Chrome çš„éœ€æ±‚ã€‚CFI/CFG æ˜¯æœªç»è¿‡å®é™…æ£€éªŒçš„æŠ€æœ¯ï¼Œæœªæ¥è¿˜å¯èƒ½å‡ºç°é‡å¤§çš„å¼±ç‚¹å’Œè®¾è®¡ç¼ºé™·ï¼Œæ€»çš„æ¥è¯´æ˜¯ Edge å äº†ä¸Šé£ã€‚</p>
<ul>
<li>JavaScript JIT åŠ å¼º</li>
</ul>
<p>å¾®è½¯åœ¨â€œé˜²æ­¢æ¼æ´åˆ©ç”¨æ—¶åˆ©ç”¨ JIT â€æ–¹é¢åšäº†å¾ˆå¤šå·¥ä½œï¼Œå…¶ä¸­æœ€åˆ›æ–°çš„è«è¿‡äºå°† JIT ç§»å‡ºè¿›ç¨‹ï¼Œä¸è®©æ²™ç›’ä¸­çš„è¿›ç¨‹ç›´æ¥åˆ›å»ºå¯æ‰§è¡Œé¡µé¢ã€‚æ”»å‡»è€…å¿…é¡»å®Œæ•´ç¼–è¯‘ RCE æˆ ROP é“¾ï¼Œè¿™å¯è¦è´¹å¤§å·¥å¤«äº†ã€‚æ— å¯å¦è®¤ï¼Œè™½ç„¶ v8 è¦æ¨å‡º JavaScript è§£é‡Šå™¨ï¼ˆignitionï¼‰å’Œ JIT çš„æ›¿ä»£å“ï¼ˆturbofanï¼‰ï¼ŒChrome çš„æ€§èƒ½ä¼šå¤§å¹…æå‡ï¼Œä½†æ˜¯ Chrome å½“å‰çš„ JIT ç¼“è§£æªæ–½è¿˜æ˜¯æ¯”å¾®è½¯å¼±ã€‚è¿™æ–¹é¢ Edge é¥é¥é¢†å…ˆäº† Chromeã€‚</p>
<h2 id="å®‰å…¨éš”ç¦»æœºåˆ¶"><a href="#å®‰å…¨éš”ç¦»æœºåˆ¶" class="headerlink" title="å®‰å…¨éš”ç¦»æœºåˆ¶"></a>å®‰å…¨éš”ç¦»æœºåˆ¶</h2><p>å¾®è½¯åœ¨ RCE ç¼“è§£æ–¹é¢æ¯” Chrome æŠ•å…¥æ›´å¤šï¼ŒChrome æ›´ä¸“æ³¨äºåœ¨æµè§ˆç½‘é¡µæ—¶å®šä¹‰å’ŒåŠ å¼ºæŒç»­å¯ç”¨çš„éš”ç¦»è¾¹ç•Œã€‚åƒå¾®è½¯ä¸€æ ·ï¼ŒChrome ä¹Ÿæ˜¯å—æš´éœ²çš„æ¼æ´ç±»å‹é©±åŠ¨çš„ã€‚ç„¶è€Œï¼Œä¸¤å®¶æ˜¯æœ‰ä¸åŒçš„ç†å¿µå’Œå®æ–½çº¦æŸçš„ï¼Œé€šè¿‡é•¿æœŸè§‚å¯Ÿï¼Œæˆ‘ä»¬å‘ç°éš”ç¦»æœºåˆ¶åè€Œæ˜¯æ›´æœ‰æ•ˆçš„ç­–ç•¥ï¼Œè·¨å¹³å°ä¹Ÿæ›´æ–¹ä¾¿ã€‚</p>
<p>é¦–å…ˆï¼Œä»å®‰å…¨æœºåˆ¶çš„é•¿æœŸæœ‰æ•ˆæ€§æ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨ Chrome ä¸Šå‘ç°ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œåº•å±‚ OS å¹³å°å€¾å‘äºæå‡å®‰å…¨éš”ç¦»åŸè¯­ã€‚æ¯”å¦‚è¯´ Linux çš„è¡ç”Ÿç³»ç»Ÿä¼šä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Seccomp" target="_blank" rel="external">seccomp-bpf æœºåˆ¶</a>ï¼Œä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨ï¼ŒWindows ç³»ç»Ÿä¼šä½¿ç”¨<a href="https://msdn.microsoft.com/en-us/library/bb625957.aspx" target="_blank" rel="external">integrity level(IL)</a>ï¼Œ é”å®š win32k ä¸Šçš„è¿›ç¨‹ç¼“è§£ç­–ç•¥ã€‚åœ¨å®‰å…¨éš”ç¦»æ–¹é¢ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰èƒ½åŠ›åˆ©ç”¨è¿™äº›æ“ä½œç³»ç»Ÿä½œå‡ºçš„å®‰å…¨ä¸Šçš„æ”¹è¿›ã€‚</p>
<p>è¯´åˆ°å¯ç§»æ¤æ€§ï¼Œæ‹¿å¾®è½¯æœ€è¿‘çš„ JIT åŠ å¼ºæ¥è¯´ï¼Œå®ƒä¾èµ–äº Windows 10 ä¸Š Edge çš„æ–°ç‰¹æ€§ï¼Œå¹¶ä¸”å—é™äºå¾®è½¯çš„ç­¾åæ–‡ä»¶ã€‚ç°åœ¨è¿™ç§ OS é™åˆ¶å·²ç»ä¸å¸¸è§ï¼Œå·¥ç¨‹å¸ˆä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°æ›¿ä»£æ–¹æ³•è§£å†³ï¼Œä½†æ˜¯è€ƒè™‘åˆ°è¿™é¡¹åŠŸèƒ½æ¶‰åŠä¿®æ”¹ä¸»æ¶æ„ï¼Œå¿…é¡»ç¡®å®šè¿™å¯¹å…¶ä»–å¹³å°æ˜¯å¦å‹å¥½ï¼Œæˆ–è€…è§£é‡Šè¯´æ˜¯å®‰å…¨ä¸Šä½œäº†é‡å¤§æ”¹è¿›ï¼Œç„¶è€Œè¿™ä¸¤ç§è¯´æ³•éƒ½ä¸ç°å®ã€‚</p>
<blockquote>
<p>æ¯”èµ· Edgeï¼Œ Chrome çš„æ¸²æŸ“å™¨å¤„åœ¨æ›´å¼ºæœ‰åŠ›çš„æ²™ç®±ä¿æŠ¤ä¸­ã€‚</p>
</blockquote>
<p>Chrome åœ¨åˆ›å»ºæ›´å¼ºçš„éš”ç¦»åŸè¯­ï¼ˆå¦‚ Chrome çš„æ¸²æŸ“å™¨æ¯” Edge å¤„åœ¨æ›´å¼ºçš„æ²™ç®±ä¿æŠ¤ä¸­ï¼‰å’Œæ‰©å±•å…¶åº”ç”¨æ–¹é¢ï¼ˆå¦‚ GPU æ²™ç›’ã€ç½‘ç»œæ²™ç›’ï¼‰åšå‡ºäº†æ›´å¤§åŠªåŠ›ã€‚</p>
<p>è¿™æ–¹é¢æˆ‘ä»¬çš„ç‹ç‰Œæ˜¯ä»Šå¹´æ¨å‡ºçš„<a href="https://www.chromium.org/developers/design-documents/site-isolation" target="_blank" rel="external">ç«™ç‚¹éš”ç¦»é¡¹ç›®</a>ï¼Œç«™ç‚¹éš”ç¦»æ˜¯æ•°åå¹´çš„å·¥ç¨‹æˆæœï¼Œä¸º web æºåŠ ä¸Šé™åˆ¶ï¼Œä»è€Œé˜»æ­¢æ¸²æŸ“å™¨æ²™ç›’ RCE æ“ä½œå…¶ä»– web æºã€‚è¿™æ¯”ç°ä»Šå…¶ä»–ä»»ä½•æµè§ˆå™¨çš„å®‰å…¨ä¿è¯éƒ½æ›´å¼ºå£®æœ‰åŠ›ã€‚</p>
<h2 id="è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ"><a href="#è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ" class="headerlink" title="è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ"></a>è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ</h2><p>æµè§ˆå™¨å®‰å…¨æ˜¯ä¸ªå¤æ‚çš„è¯é¢˜ã€‚æ‰€ä»¥æˆ‘æƒ³ä¸º Chrome ç°åœ¨çš„å†³ç­–ä½œä¸€äº›è¯´æ˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘è®¤ä¸ºè¿™äº›å†³ç­–ä»ç„¶å¯ä»¥æå« Chrome åœ¨å„ä¸ªå¹³å°ä½œä¸ºæœ€å®‰å…¨æµè§ˆå™¨çš„åœ°ä½ï¼ˆäº‹å®è¯æ˜ï¼‰ã€‚</p>
<p>ç°åœ¨é—®é¢˜æ˜¯æœ‰ä¸€äº›ç°è±¡æŠŠå®‰å…¨ç ”ç©¶é™ä½æˆç®€å•åœ°åˆ’åˆ’æ¸…å•ï¼Œæˆ–è€…æ˜¯äº’ç›¸æ¯”è¾ƒå®‰å…¨ç‰¹å¾/CVE çš„æ¸¸æˆï¼Œè¿™äº›ä¸œè¥¿å¯¹è¯„ä¼°çœŸå®çš„å®‰å…¨æ²¡ä¸€ç‚¹ç”¨å¤„ã€‚æµè§ˆå™¨çš„æ¶æ„æ˜¯è½¯ä»¶é‡Œæœ€å¤æ‚çš„ï¼ŒèƒŒåçš„å†³ç­–å¯¹æˆ‘ä»¬ä¹Ÿæ˜¯ä¸é€æ˜çš„ã€‚æˆ‘ç¡®å®è®¤ä¸ºæˆ‘ä»¬åšäº†æ­£ç¡®çš„å†³å®šï¼Œä¼˜å…ˆè§£å†³ç€ Chrome æœ€è¦ç´§çš„é—®é¢˜ã€‚æˆ‘æ‰¿è®¤å¦‚æœæˆ‘è´Ÿè´£çš„æ˜¯ Edge çš„å®‰å…¨ï¼Œæˆ‘ä¼šé’ˆå¯¹ä¸åŒçš„ç”¨æˆ·æ‹¿å‡ºä¸åŒçš„æ•°æ®ï¼Œæœ€ååšå‡ºä¸ªä¸ä¸€æ ·çš„ç»“è®ºã€‚</p>
<h2 id="ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ"><a href="#ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ" class="headerlink" title="ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ"></a>ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ</h2><p>å¾®è½¯çš„åšå®¢é‡Œå…³äº Edge å¦‚ä½•é˜²æ­¢ç¬¬ä¸‰æ–¹ä»£ç æ³¨å…¥è¿™ç‚¹éå¸¸æœ‰æ„æ€ï¼Œè¿™ä¹Ÿæ˜¯æ‰€æœ‰æµè§ˆå™¨å¤§å¤´çš„ç‚¹ã€‚ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ä¸å½“æ“ä½œæ’å…¥ä»£ç ä¸ä»…ä¼šé€ æˆç¨³å®šæ€§é—®é¢˜å’Œæ€§èƒ½é—®é¢˜ï¼Œä¹Ÿå¦¨å®³ç€æµè§ˆå™¨å®‰å…¨ã€‚æˆ‘ä¸€ç›´è¯´æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸€ç›´ä¸èƒ½åœ¨ Chrome æ²™ç›’é‡Œå¯ç”¨ Lowbox Tokenï¼ˆApp å®¹å™¨å®‰å…¨é™åˆ¶ï¼‰å’Œ CSRSS é™åˆ¶ï¼Œå› ä¸ºé‚£æ—¶ç¬¬ä¸‰æ–¹çš„åç—…æ¯’ç¨‹åºä¼šé€ æˆ Chrome å´©æºƒã€‚</p>
<p>å¾ˆé«˜å…´çœ‹åˆ°å¾®è½¯åˆ©è½çš„åˆ‡å…¥äº† Edgeï¼Œä¸ºé˜»æ­¢ç¬¬ä¸‰æ–¹æ³¨å…¥å¼€äº†å…ˆæ²³ã€‚Chrome å’Œ Firefox ä»Šå¹´ä¹Ÿå‡†å¤‡éƒ¨ç½²ç±»ä¼¼çš„æ–¹æ¡ˆï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šä¸ºäº†æœ€å¥½çš„å¸®åŠ©ç”¨æˆ·æˆ‘ä»¬è¾¾æˆäº†ç»“ç›Ÿã€‚</p>
<p><img src="http://bmob-cdn-1754.b0.upaiyun.com/2017/03/10/6ed3e9394075934e805505708887b01b.jpeg" alt=""></p>
<hr>
<p>åŸæ–‡é“¾æ¥: <a href="https://medium.com/@justin.schuh/securing-browsers-through-isolation-versus-mitigation-15f0baced2c2#.l2srshz32" target="_blank" rel="external">Securing Browsers Through Isolation Versus Mitigation</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-216267.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> translation </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¼–è¯‘ lua 5.3.3 æºç ]]></title>
      <url>/2016/08/31/compile-lua-5-3-3/</url>
      <content type="html"><![CDATA[<p>lua æºç ç›´æ¥ <code>make platform</code> ç¼–è¯‘æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè¿™é‡Œå°±è¯´ä¸€ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<a id="more"></a>
<h1 id="ç¼–è¯‘ä¸ºsoåº“"><a href="#ç¼–è¯‘ä¸ºsoåº“" class="headerlink" title="ç¼–è¯‘ä¸ºsoåº“"></a>ç¼–è¯‘ä¸ºsoåº“</h1><p>é»˜è®¤çš„ç¼–è¯‘åªæœ‰ .a åº“, so åº“åªèƒ½è‡ªå·±åŠ¨æ‰‹äº†.</p>
<h2 id="ä¿®æ”¹-Makefile"><a href="#ä¿®æ”¹-Makefile" class="headerlink" title="ä¿®æ”¹ Makefile"></a>ä¿®æ”¹ Makefile</h2><p>å°†æ ¹ç›®å½•ä¸­çš„Makefileä½œå¦‚ä¸‹ä¿®æ”¹:</p>
<p>å°†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TO_LIB= liblua.a</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TO_LIB= liblua.a liblua.so</div></pre></td></tr></table></figure></p>
<p>åœ¨src/Makefileä¸­å¯»æ‰¾åˆé€‚çš„ä½ç½®æ·»åŠ ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LUA_SO=liblua.so</div><div class="line"></div><div class="line">$(LUA_SO): $(CORE_O) $(LIB_O)</div><div class="line">    $(CC) -o $@ -shared $? -ldl -lm</div></pre></td></tr></table></figure></p>
<p>å°†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALL_T= $(LUA_A) $(LUA_T) $(LUAC_T)</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALL_T= $(LUA_A) $(LUA_T) $(LUAC_T) $(LUA_SO)</div></pre></td></tr></table></figure></p>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>ç¼–è¯‘å®Œæˆåæœ‰ä¸¤ä¸ªä¸»è¦çš„å¯æ‰§è¡Œæ–‡ä»¶<code>lua</code> å’Œ <code>luac</code> å’Œä¸¤ä¸ªåº“ <code>liblua.a</code> å’Œ <code>liblua.so</code>.</p>
<p><code>lua</code> : è™šæ‹Ÿæœºï¼Œç”¨æ¥æ‰§è¡Œ lua ä»£ç <br><code>luac</code> : ç¼–è¯‘å™¨ï¼Œç”¨æ¥ä¸º lua ä»£ç åšä¸€äº›ä¼˜åŒ–ä»€ä¹ˆçš„ (å¹¶ä¸æ˜¯è¯´è„šæœ¬è¯­è¨€å°±ä¸éœ€è¦ç¼–è¯‘å™¨äº†å•Šå•Šå•Šå•Š)<br><code>liblua.a</code> : é™æ€åº“<br><code>liblua.so</code> : åŠ¨æ€åº“</p>
<h1 id="ä¸ºAndroidå¹³å°ç¼–è¯‘"><a href="#ä¸ºAndroidå¹³å°ç¼–è¯‘" class="headerlink" title="ä¸ºAndroidå¹³å°ç¼–è¯‘"></a>ä¸ºAndroidå¹³å°ç¼–è¯‘</h1><p>æ–°å»º <code>liblua.mk</code> å’Œ <code>Android.mk</code>, å†™å…¥:</p>
<p><strong>liblua.mk</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">LIB_VERSION:=lua-5.3.3-src</div><div class="line">SRC_ROOT_PATH:= ../../$(LIB_VERSION)</div><div class="line"></div><div class="line">LOCAL_PATH:= $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE := liblua</div><div class="line">LOCAL_CFLAGS := -D&quot;lua_getlocaledecpoint() =&apos;.&apos;&quot; -DLUA_USE_C89</div><div class="line"></div><div class="line">LOCAL_SRC_FILES := \</div><div class="line"> $(SRC_ROOT_PATH)/src/lapi.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lauxlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lbaselib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lbitlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lcode.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lcorolib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lctype.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldblib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldebug.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldo.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldump.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lfunc.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lgc.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/linit.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/liolib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/llex.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lmathlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lmem.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/loadlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lobject.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lopcodes.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/loslib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lparser.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstate.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstring.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstrlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltable.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltablib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltm.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lua.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lundump.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lvm.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lzio.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lutf8lib.c\</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div><div class="line">#include $(BUILD_STATIC_LIBRARY)</div><div class="line">#include $(BUILD_EXECUTABLE)</div></pre></td></tr></table></figure></p>
<p><strong>Android.mk</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH:= $(call my-dir)</div><div class="line">include $(LOCAL_PATH)/liblua.mk</div></pre></td></tr></table></figure></p>
<p>æ­¤æ—¶æ–‡ä»¶ç»“æ„å¦‚å›¾ (lua-5.5.5-srcæ–‡ä»¶å¤¹ä¸ºä¸‹è½½çš„æºç ,å…¶ä»–æ˜¯æ–°å»ºçš„):</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/30/1.png-styleOnlyWatermark" alt=""></p>
<p>è¿›å…¥<code>jni</code>æ–‡ä»¶å¤¹æ‰§è¡Œ<code>ndk-build</code>ç¼–è¯‘, æˆåŠŸåçš„æ–‡ä»¶ç»“æ„å¦‚å›¾:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/30/2.png-styleOnlyWatermark" alt=""></p>
<h1 id="é”™è¯¯åˆ—è¡¨"><a href="#é”™è¯¯åˆ—è¡¨" class="headerlink" title="é”™è¯¯åˆ—è¡¨"></a>é”™è¯¯åˆ—è¡¨</h1><h2 id="é”™è¯¯1"><a href="#é”™è¯¯1" class="headerlink" title="é”™è¯¯1"></a>é”™è¯¯1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file not recognized: ä¸å¯è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make clean</div></pre></td></tr></table></figure></p>
<h2 id="é”™è¯¯2"><a href="#é”™è¯¯2" class="headerlink" title="é”™è¯¯2"></a>é”™è¯¯2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/bin/ld: lapi.o: relocation R_X86_64_32 against `luaO_nilobject_&apos; can not be used when making a shared object; recompile with -fPIC</div><div class="line">lapi.o: error adding symbols: é”™è¯¯çš„å€¼</div></pre></td></tr></table></figure>
<p>å°†src/Makefileæ–‡ä»¶ä¸­çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFLAGS= -O2 -Wall -Wextra -DLUA_COMPAT_5_2 $(SYSCFLAGS) $(MYCFLAGS)</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFLAGS= -O2 -Wall -Wextra -DLUA_COMPAT_5_2 $(SYSCFLAGS) -fPIC $(MYCFLAGS)</div></pre></td></tr></table></figure></p>
<h2 id="é”™è¯¯3"><a href="#é”™è¯¯3" class="headerlink" title="é”™è¯¯3"></a>é”™è¯¯3</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error: &apos;struct lconv&apos; has no member named &apos;decimal_point&apos;</div></pre></td></tr></table></figure>
<p>å°†<code>luaconf.h</code>ä¸­çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define lua_getlocaledecpoint()		(localeconv()-&gt;decimal_point[0])</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define lua_getlocaledecpoint()		&apos;.&apos;</div></pre></td></tr></table></figure></p>
<p><strong>æˆ–è€…</strong> åœ¨makefileåŠ ä¸Šé€‰é¡¹ <code>-D&quot;lua_getlocaledecpoint() =&#39;.&#39;&quot;</code>. (å®Œæ•´makefileå†…å®¹è§ä¸Š)</p>
<h2 id="é”™è¯¯4"><a href="#é”™è¯¯4" class="headerlink" title="é”™è¯¯4"></a>é”™è¯¯4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">undefined reference to &apos;log2&apos;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>makefile</code> åŠ ä¸Šé€‰é¡¹ <code>-DLUA_USE_C89</code> . (å®Œæ•´makefileå†…å®¹è§ä¸Š)</p>
<hr>
]]></content>
      
        
        <tags>
            
            <tag> compile </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Studio è°ƒè¯• smali ä»£ç ]]></title>
      <url>/2016/08/07/use-studio-debug-smali/</url>
      <content type="html"><![CDATA[<p>å¯¹äº java å±‚é€†å‘æ¥è¯´ï¼ŒåŠ¨æ€è°ƒè¯•å¯æ¯”æ‰“ log æ–¹ä¾¿å¤šäº† :p</p>
<a id="more"></a>
<p>å¼€å§‹ä¹‹å‰å…ˆä¾›å‡ºä¸€ä¸ªå¤§ç¥ï¼ˆæ­¤å¤„çŒ®ä¸Šè†ç›–ï¼‰ï¼Œsmaliã€baksmaliã€smalidea å…¨å¥—éƒ½å¯ä»¥åœ¨è¿™é‡Œ -&gt; <a href="https://bitbucket.org/JesusFreke/smali/downloads" target="_blank" rel="external">ä¸‹è½½</a>ï¼Œä»Šå¤©ç”¨åˆ°çš„æ˜¯ smalidea æ’ä»¶ï¼Œç›®å‰ç‰ˆæœ¬æ˜¯ 0.03 .</p>
<h2 id="å®‰è£…æ’ä»¶"><a href="#å®‰è£…æ’ä»¶" class="headerlink" title="å®‰è£…æ’ä»¶"></a>å®‰è£…æ’ä»¶</h2><ul>
<li><strong>File -&gt; Settings</strong> ç‚¹å‡» <strong>Plugins</strong> :</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/1.png-styleOnlyWatermark" alt=""></p>
<h2 id="å¯¼å…¥é¡¹ç›®"><a href="#å¯¼å…¥é¡¹ç›®" class="headerlink" title="å¯¼å…¥é¡¹ç›®"></a>å¯¼å…¥é¡¹ç›®</h2><ul>
<li>ä½¿ç”¨ baksmali å°† dex æ–‡ä»¶åç¼–è¯‘ä¸º smali .</li>
<li><strong>File -&gt; New -&gt; Import Projectâ€¦</strong>ï¼Œé€‰ä¸­åç¼–è¯‘è¿‡çš„ smali ç›®å½•ã€‚</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/2.png-styleOnlyWatermark" alt=""></p>
<p>ä¹‹åä¸€è·¯ next å³å¯ã€‚</p>
<h2 id="ä¸€äº›è®¾ç½®"><a href="#ä¸€äº›è®¾ç½®" class="headerlink" title="ä¸€äº›è®¾ç½®"></a>ä¸€äº›è®¾ç½®</h2><ul>
<li>å³é”®æºä»£ç æ ¹ç›®å½• <strong>Mark Directory As -&gt; Sources Root</strong> </li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/5.png-styleOnlyWatermark" alt=""></p>
<ul>
<li><strong>File -&gt; Project Structureâ€¦</strong> è®¾ç½® jdk</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/3.png-styleOnlyWatermark" alt=""></p>
<ul>
<li><strong>Run -&gt; Edit Configurationsâ€¦</strong> æ–°å»ºä¸€ä¸ª remoteï¼Œè®¾ç½®ç«¯å£ä¸º8700ï¼Œå‘½åä¸º smali</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/7.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/8.png-styleOnlyWatermark" alt=""></p>
<h2 id="å¼€å§‹è°ƒè¯•"><a href="#å¼€å§‹è°ƒè¯•" class="headerlink" title="å¼€å§‹è°ƒè¯•"></a>å¼€å§‹è°ƒè¯•</h2><ul>
<li>ç¡®ä¿é€‰æ‹©çš„ app æ˜¯å¯è°ƒè¯•çš„/ä¿®æ”¹è¿‡è®¾å¤‡ç¯å¢ƒ</li>
<li><p>å®‰è£… apk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb install xxx.apk</div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ Android Device Monitor ï¼ˆå¼€å¯è°ƒè¯•ç«¯å£ç”¨ï¼‰</p>
</li>
<li><p>å¯åŠ¨ app</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb shell am start -D -n package_name/main_activity_name</div></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹å¥½æ–­ç‚¹</p>
</li>
<li>å¼€å§‹ Debug</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/9.png-styleOnlyWatermark" alt=""></p>
<ul>
<li>æ–­ä¸‹</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/6.png-styleOnlyWatermark" alt=""></p>
<hr>
<p>over~</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> debug </tag>
            
            <tag> smali </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å¦‚ä½•é‡æ–°ç¼–è¯‘ uiautomatorviewer]]></title>
      <url>/2016/08/06/recompile-uiautomatorviewer/</url>
      <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨uiautomatorvieweræ—¶å¯èƒ½ä¼šæƒ³ç”¨åˆ°å…¶æœ¬èº«æ²¡æœ‰çš„åŠŸèƒ½ï¼Œæˆ–è€…æƒ³ä¿®æ”¹ä¸€ä¸‹å®ƒçš„é€»è¾‘ï¼Œè¿™æ—¶å€™å°±éœ€è¦é‡æ–°ç¼–è¯‘ä¸€ä¸ªjaråŒ…äº†ã€‚</p>
<a id="more"></a>
<p>å¥½åœ¨Androidæ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥ä¸ç”¨åç¼–è¯‘åŸæ¥çš„jaråŒ…ç›´æ¥ä¸‹è½½æºä»£ç å°±å¯ä»¥äº†ï¼Œæˆ‘æ˜¯åœ¨è¿™é‡Œcloneäº†ä¸€ä»½ -&gt; <a href="https://github.com/android-ia/platform_tools_swt" target="_blank" rel="external">é“¾æ¥</a> ~ å½“ç„¶åªéœ€è¦ç”¨åˆ°å…¶ä¸­çš„<a href="https://github.com/android-ia/platform_tools_swt/tree/master/uiautomatorviewer" target="_blank" rel="external">uiautomatorviewer</a>è¿™ä¸€ä¸ªæºç æ–‡ä»¶å¤¹å°±å¤Ÿäº†ã€‚</p>
<p>å› ä¸ºgoogleä½¿ç”¨eclipse rcpæ¥å¼€å‘è¿™äº›ä¸ªå·¥å…·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨eclipseå»ºç«‹e4é¡¹ç›®ã€‚</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/1.png-styleOnlyWatermark" alt=""></p>
<p>å»ºç«‹çš„è¿‡ç¨‹ä¸­ä¸€ç›´nextå°±å¥½ã€‚</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/2.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/3.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/4.png-styleOnlyWatermark" alt=""></p>
<p>å°†uiautomatorviewerçš„æºç ä¸­src/main/javaæ–‡ä»¶å¤¹ä¸‹çš„ <strong>com å’Œ image</strong> æ–‡ä»¶å¤¹å¤åˆ¶åˆ°å·¥ç¨‹ä¸­çš„srcä¸­ï¼Œä¸‹è½½ <strong>ddmlib.jar</strong> å’Œ <strong>common.jar</strong> å¤åˆ¶åˆ° libs æ–‡ä»¶å¤¹ä¸‹(æ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª)ï¼Œå†å°†è¿™ä¸¤ä¸ª jar åŒ…å³é”® <strong>â€œBuild Pathâ€ -&gt; â€œAdd to Build Pathâ€</strong>ã€‚<br>é™„ä¸Š <a href="http://www.java2s.com/Code/JarDownload/ddmlib/ddmlib-22.2.0.jar.zip" target="_blank" rel="external">ddmlib.jar</a> å’Œ <a href="http://www.java2s.com/Code/JarDownload/common/common.jar.zip" target="_blank" rel="external">common.jar</a> çš„ä¸‹è½½åœ°å€ã€‚<br>è¿™æ˜¯å®Œæˆçš„é¡¹ç›®ç›®å½•ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/5.png-styleOnlyWatermark" alt=""></p>
<p>æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹è¿‡ä»£ç åï¼Œåœ¨é¡¹ç›®æ ¹èŠ‚ç‚¹å³é”® <strong>â€œexportâ€¦â€</strong>ï¼Œé€‰æ‹© <strong>â€œJAR fileâ€</strong>:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/6.png-styleOnlyWatermark" alt=""></p>
<p>é€‰æ‹©å¯¼å‡ºè¦åŒ…æ‹¬çš„é¡¹ç›®æ–‡ä»¶ï¼Œåªé€‰ <strong>src</strong> å³å¯ï¼Œå¹¶å¡«å…¥å¯¼å‡ºè·¯å¾„:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/7.png-styleOnlyWatermark" alt=""></p>
<p>ä¸€ç›´nextï¼Œåœ¨æœ€åä¸€æ­¥è®°å¾—å¡«å…¥ <strong>Main class</strong>:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/8.png-styleOnlyWatermark" alt=""></p>
<p><strong>finish</strong> ä¹‹åå³å¯åœ¨å¯¼å‡ºè·¯å¾„ä¸‹çœ‹åˆ°jaræ–‡ä»¶ï¼Œæ›¿æ¢æ‰sdk toolsä¸­çš„uiautomatorviewer.jarå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å·¥å…·äº†~</p>
<hr>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> compile </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å‡çº§ç«™é•¿ç§˜ç±ï¼šä½¿ç”¨flarumæ¡†æ¶æ­å»ºä¸€ä¸ªæœ‰é€¼æ ¼çš„è½»è®ºå›]]></title>
      <url>/2016/04/14/install-flarum/</url>
      <content type="html"><![CDATA[<p>å…ˆæ¥ä¸ªæˆå“å›¾è§‚èµè§‚èµï¼š</p>
<a id="more"></a>
<p>æ‰‹æœºç‰ˆï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/10/30-style1" alt=""></p>
<p>ç”µè„‘ç‰ˆï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/05/53-style1" alt=""></p>
<hr>
<p>æˆ‘çš„ç¯å¢ƒï¼šubuntu 14.06 x64 VPS</p>
<h1 id="å®‰è£…å‡†å¤‡"><a href="#å®‰è£…å‡†å¤‡" class="headerlink" title="å®‰è£…å‡†å¤‡"></a>å®‰è£…å‡†å¤‡</h1><p>ä¾æ¬¡å®‰è£… apache2ã€php5ã€mysql-serverã€php5-mysql .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install apache2</div><div class="line">sudo apt-get install php5</div><div class="line">sudo apt-get install mysql-server</div><div class="line">sudo apt-get install php5-mysql</div></pre></td></tr></table></figure>
<p>å®‰è£…composer.(è¿™ä¸€æ­¥ç›´æ¥åœ¨å®˜ç½‘ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶åŠ ä¸Šå¯æ‰§è¡Œæƒé™å¤åˆ¶åˆ°/usr/local/binä¸­å°±è¡Œ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php -r &quot;readfile(&apos;https://getcomposer.org/installer&apos;);&quot; &gt; composer-setup.php</div><div class="line">php -r &quot;if (hash(&apos;SHA384&apos;, file_get_contents(&apos;composer-setup.php&apos;)) === &apos;7228c001f88bee97506740ef0888240bd8a760b046ee16db8f4095c0d8d525f2367663f22a46b48d072c816e7fe19959&apos;) &#123; echo &apos;Installer verified&apos;; &#125; else &#123; echo &apos;Installer corrupt&apos;; unlink(&apos;composer-setup.php&apos;); &#125; echo PHP_EOL;&quot;</div><div class="line">php composer-setup.php --install-dir=bin --filename=composer</div><div class="line">php -r &quot;unlink(&apos;composer-setup.php&apos;);&quot;</div></pre></td></tr></table></figure>
<h1 id="åˆ›å»ºflarumå·¥ç¨‹"><a href="#åˆ›å»ºflarumå·¥ç¨‹" class="headerlink" title="åˆ›å»ºflarumå·¥ç¨‹"></a>åˆ›å»ºflarumå·¥ç¨‹</h1><p>ä¸€å®šè¦åœ¨ç©ºç›®å½•é‡Œæ‰§è¡Œcreate-object.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir V2NB_forum</div><div class="line">cd V2NB_forum/</div><div class="line">composer create-project flarum/flarum . --stability=beta</div></pre></td></tr></table></figure>
<p>å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Installing flarum/flarum (v0.1.0-beta.5)</div><div class="line">  - Installing flarum/flarum (v0.1.0-beta.5)</div><div class="line">    Downloading: 100%         </div><div class="line"></div><div class="line">Created project in .</div><div class="line">Loading composer repositories with package information</div><div class="line">Updating dependencies (including require-dev)</div><div class="line">Your requirements could not be resolved to an installable set of packages.</div><div class="line"></div><div class="line">  Problem 1</div><div class="line">    - flarum/flarum-ext-akismet v0.1.0-beta.3 requires tijsverkoyen/akismet ^1.1 -&gt; satisfiable by tijsverkoyen/akismet[1.1.0].</div><div class="line">    - flarum/flarum-ext-akismet v0.1.0-beta.5 requires tijsverkoyen/akismet ^1.1 -&gt; satisfiable by tijsverkoyen/akismet[1.1.0].</div><div class="line">    - tijsverkoyen/akismet 1.1.0 requires ext-curl * -&gt; the requested PHP extension curl is missing from your system.</div><div class="line">    - Installation request for flarum/flarum-ext-akismet ^0.1.0 -&gt; satisfiable by flarum/flarum-ext-akismet[v0.1.0-beta.3, v0.1.0-beta.5].</div><div class="line"></div><div class="line">  To enable extensions, verify that they are enabled in those .ini files:</div><div class="line">    - /etc/php5/cli/php.ini</div><div class="line">    - /etc/php5/cli/conf.d/05-opcache.ini</div><div class="line">    - /etc/php5/cli/conf.d/10-pdo.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-json.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-mysql.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-mysqli.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-pdo_mysql.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-readline.ini</div><div class="line">  You can also run `php --ini` inside terminal to see which files are used by PHP in CLI mode.</div></pre></td></tr></table></figure>
<p>è¿™æ—¶éœ€è¦å®‰è£…php-curlåï¼Œåˆ é™¤ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶(åŒ…æ‹¬.å¼€å¤´çš„éšè—æ–‡ä»¶)å†æ‰§è¡Œ<code>composer create-project flarum/flarum . --stability=beta</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install php5-curl</div></pre></td></tr></table></figure>
<p>æ­£å¸¸çš„å®‰è£…æ—¥å¿—åº”è¯¥å¥½é•¿å¥½é•¿ã€‚</p>
<p>è¿™æ—¶å·¥ç¨‹ç›®å½•ä¸­çš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/35/27-style1" alt=""></p>
<h1 id="ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®"><a href="#ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®" class="headerlink" title="ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®"></a>ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®</h1><h2 id="ä¿®æ”¹æƒé™"><a href="#ä¿®æ”¹æƒé™" class="headerlink" title="ä¿®æ”¹æƒé™"></a>ä¿®æ”¹æƒé™</h2><p>å°†å·¥ç¨‹ç›®å½•å…¨éƒ¨æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„æƒé™ä¿®æ”¹ä¸º777.<br>å¦‚æˆ‘çš„æ˜¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod -R 777 /home/kiya/v2nb</div></pre></td></tr></table></figure>
<h2 id="å¼€å¯rewrite"><a href="#å¼€å¯rewrite" class="headerlink" title="å¼€å¯rewrite"></a>å¼€å¯rewrite</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /etc/apache2/mods-enabled</div><div class="line">sudo ln -s ../mods-available/rewrite.load</div></pre></td></tr></table></figure>
<h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><p>ä¿®æ”¹<code>/etc/apache2/sites-available/000-default.conf</code>æ–‡ä»¶ä¸­çš„DocumentRooté¡¹ä¸ºä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹è·¯å¾„. å¦‚<code>DocumentRoot /home/kiya/v2nb</code>.<br>å¹¶åœ¨è¯¥æ–‡ä»¶ä¸­çš„<code>VirtualHost</code>èŠ‚ç‚¹ä¹‹é—´æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /home/kiya/V2NB&gt;</div><div class="line">    AllowOverride All</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>åœ¨<code>/etc/apache2/apache2.conf</code>æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /&gt;</div><div class="line">        Options FollowSymLinks</div><div class="line">        AllowOverride None</div><div class="line">        Require all denied</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>å°†<code>Require all denied</code>æ”¹ä¸º<code>Require all granted</code>,å°†<code>AllowOverride None</code>æ”¹ä¸º<code>AllowOverride All</code>.</p>
<h2 id="ä¿®æ”¹host"><a href="#ä¿®æ”¹host" class="headerlink" title="ä¿®æ”¹host"></a>ä¿®æ”¹host</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/hosts</div></pre></td></tr></table></figure>
<p>æ‰“å¼€hostsæ–°å¢åŠ ä¸€è¡Œ<code>23.105.197.243 v2nb.today</code>. è¿™é‡Œçš„ipæ˜¯vpsçš„ipï¼ŒåŸŸåéšä¾¿å†™. æœ¬æœºçš„è¯å¯ä»¥ipå¯ä»¥å†™æˆ<code>127.0.0.1</code>.<br>å¦‚æœè¿™é‡Œä¸åŠ åœ¨å¯åŠ¨apacheæœåŠ¡æ—¶ä¼šè­¦å‘Š:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AH00558: apache2: Could not reliably determine the server&apos;s fully qualified domain name, using v2nb.today. Set the &apos;ServerName&apos; directive globally to suppress this message</div></pre></td></tr></table></figure>
<h1 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h1><p>å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªè®ºå›ç”¨çš„æ•°æ®åº“,userå’Œpassæ—¶å®‰è£…mysqlæ—¶å¡«å†™çš„è´¦å·å¯†ç . å¾…ä¼šè¦ç”¨åˆ°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql -u user -p</div><div class="line">pass</div><div class="line">create database v2nb;</div></pre></td></tr></table></figure>
<h1 id="å®‰è£…flarum"><a href="#å®‰è£…flarum" class="headerlink" title="å®‰è£…flarum"></a>å®‰è£…flarum</h1><p>é‡å¯apacheæœåŠ¡.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service apache2 restart</div></pre></td></tr></table></figure>
<p>ç”¨æµè§ˆå™¨è®¿é—®<code>23.105.197.243</code>. å¦‚æœæ˜¯æœ¬åœ°æµ‹è¯•åˆ™è®¿é—®<code>localhost</code>.</p>
<p>å¦‚æœå‡ºç°çš„æ˜¯ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/39/41-style1" alt=""></p>
<p>åˆ™éœ€è¦å®‰è£…<code>gd</code>æ¨¡å—,æ‰§è¡Œ<code>sudo apt-get install php5-gd</code>é‡å¯apacheå³å¯.</p>
<p>æ­£ç¡®çš„è¯ä¼šå‡ºç°ä¸‹å›¾é¡µé¢ç”¨ä»¥å¡«å†™ä¿¡æ¯ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/43/21-style1" alt=""></p>
<p>å…¶ä¸­çš„<code>MySQL Database</code>æ˜¯ä¸Šé¢æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„æ•°æ®åº“åå­—. å¡«å¥½ä¹‹åç‚¹å‡»<code>Install Flarum</code>.</p>
<p>å‡ºç°ä¸‹å›¾å°±å®‰è£…å¥½å•¦~</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/47/54-style1" alt=""></p>
<p>ç®¡ç†å‘˜ç•Œé¢:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/15/00/11/45-style1" alt=""></p>
<h1 id="è®¿é—®oops"><a href="#è®¿é—®oops" class="headerlink" title="è®¿é—®oops"></a>è®¿é—®oops</h1><p>åœ¨ä½¿ç”¨åŸŸåæ‰“å¼€è®ºå›æ—¶å¦‚æœç»å¸¸å‡ºç°<code>Oops! Something went wrong. Please reload the page and try again</code>å¹¶ä¸”èµ„æºä¹ŸåŠ è½½ä¸å‡º,å¯èƒ½æ˜¯è¯´æ˜è¯·æ±‚çš„urlå’Œé…ç½®çš„urlä¸ä¸€æ ·.<br>éœ€è¦ä¿®æ”¹å·¥ç¨‹ç›®å½•ä¸‹çš„<code>config.php</code>æ–‡ä»¶.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim config.php</div></pre></td></tr></table></figure>
<p>å¦‚å°†<code>&#39;url&#39; =&gt; &#39;23.105.197.243&#39;</code>æ”¹ä¸º<code>&#39;url&#39; =&gt; &#39;v2nb.today&#39;</code>.</p>
<h1 id="enjoy"><a href="#enjoy" class="headerlink" title="enjoy !"></a>enjoy !</h1><p>ç´¯ç…æˆ‘ä¹Ÿ.</p>
]]></content>
      
        <categories>
            
            <category> flarum </category>
            
        </categories>
        
        
        <tags>
            
            <tag> instruction </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ubuntuå¯åŠ¨idaæŠ¥é”™æ‰¾ä¸åˆ°libgthread-2.0.so.0]]></title>
      <url>/2016/03/20/install-ia32-libs/</url>
      <content type="html"><![CDATA[<p>æ¢äº†ç”µè„‘æ–°è£…äº†ubuntu 15.04 64ä½ï¼Œå¯åŠ¨idaæ—¶æŠ¥é”™â€œError while loading shared libraries: libgthread-2.0.so.0â€ã€‚<br>è¿™æ˜¯å› ä¸ºidaéœ€è¦32ä½çš„åº“è€Œæˆ‘çš„ç³»ç»Ÿæ˜¯64ä½çš„ï¼Œæ‰€ä»¥è¦å®‰è£…32ä½çš„åº“ã€‚</p>
<a id="more"></a>
<p>è¯´ç¼ºå°‘libgthread-2.0.so.0é‚£æˆ‘å°±å…ˆå®‰è£…libgthread-2.0.so.0å‘—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dpkg -S libgthread-2.0.so.0</div><div class="line">sudo apt-get install libglib2.0-0:i386</div></pre></td></tr></table></figure>
<p>å®Œäº†å¯åŠ¨idaåˆæç¤ºç¼ºå°‘å¦ä¸€ä¸ªï¼Œå†å®‰åˆæç¤º..<br>å¾—äº†ï¼Œç›´æ¥æŠŠ32ä½çš„åº“éƒ½å®‰äº†å§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install ia32-libs</div></pre></td></tr></table></figure>
<p>ç„¶è€Œå¹¶æ²¡æœ‰æˆåŠŸï¼ŒæŠ¥é”™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">æ­£åœ¨è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨...å®Œæˆ</div><div class="line">æ­£åœ¨åˆ†æè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»æ ‘</div><div class="line">æ­£åœ¨è¯»å–çŠ¶æ€ä¿¡æ¯...å®Œæˆ</div><div class="line">ç°åœ¨æ²¡æœ‰å¯ç”¨çš„è½¯ä»¶åŒ… ia32-libsï¼Œä½†æ˜¯å®ƒè¢«å…¶å®ƒçš„è½¯ä»¶åŒ…å¼•ç”¨äº†ã€‚</div><div class="line">è¿™å¯èƒ½æ„å‘³ç€è¿™ä¸ªç¼ºå¤±çš„è½¯ä»¶åŒ…å¯èƒ½å·²ç»è¢«åºŸå¼ƒï¼Œ</div><div class="line">æˆ–è€…åªèƒ½åœ¨å…¶ä»–å‘å¸ƒæºä¸­æ‰¾åˆ°</div><div class="line">....</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dpkg --print-architecture</div><div class="line">dpkg --add-architecture i386</div><div class="line">apt-get update</div><div class="line">apt-get install iceweasel:i386</div></pre></td></tr></table></figure>
<p><strong>Reference</strong></p>
<p><a href="http://blog.tshine.me/ubuntu14-04-64%E4%BD%8D-%E5%AE%89%E8%A3%85-ia32-libs%E5%BA%93.html" target="_blank" rel="external">ubuntu14.04 64ä½ å®‰è£… ia32-libsåº“</a></p>
<p><a href="http://askubuntu.com/questions/427496/error-while-loading-shared-libraries-libgthread-2-0-so-0" target="_blank" rel="external">Error while loading shared libraries: libgthread-2.0.so.0</a></p>
<p><a href="http://blog.csdn.net/u011500307/article/details/11933739" target="_blank" rel="external">64ä½Ubuntuç³»ç»Ÿå®‰è£…32ä½å…¼å®¹åº“</a></p>
]]></content>
      
        <categories>
            
            <category> Ubuntu </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ida </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æŸåŠ å›ºä¸­çš„åè°ƒè¯•]]></title>
      <url>/2016/01/12/anti-debug-in-jiagubao/</url>
      <content type="html"><![CDATA[<p>ä»¥æŸå¨æˆ¿ä¸ºä¾‹.</p>
<a id="more"></a>
<h1 id="åè°ƒè¯•å‡½æ•°"><a href="#åè°ƒè¯•å‡½æ•°" class="headerlink" title="åè°ƒè¯•å‡½æ•°"></a>åè°ƒè¯•å‡½æ•°</h1><p>ï¼ˆjiagu.soåŸºå€5287d000ï¼‰</p>
<p>åœ¨library load/unloadæ–­ä¸‹,åœ¨mmapå‡½æ•°å°¾éƒ¨ä¸‹æ–­ç‚¹,æ–­ä¸‹åf8æ‰§è¡Œå‡ å¥,å¯æ‰¾åˆ°<code>libjiagu.so:528855E4 BL      loc_5288308C</code>,è¿›å…¥åè°ƒè¯•.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/12/35/50" alt=""></p>
<p>å¾€ä¸‹æ‰§è¡Œçš„å…³é”®è·³è½¬æœ‰<br><strong>libjiagu.so:528830D0 BLX     LR     ; debug079:5287C000</strong><br><strong>debug079:5287C014 BLX     LR         ; loc_5288042C</strong><br><strong>debug079:5287C038 BLX     LR ; loc_52880614</strong></p>
<p><code>5287C000</code>æ˜¯ä¸€ä¸ªåè°ƒè¯•æ¨¡å—çš„èµ·å§‹.</p>
<p><code>libjiagu.so:loc_5288042C</code>å‡½æ•°ä½œç”¨æ˜¯æ‰“å¼€statusæ–‡ä»¶è·å¾—TracerPid,æ­¤å‡½æ•°åœ°å€ä¸å˜ å…¶ä¸­çš„ <strong>libjiagu.so:52880528 BL      open_0</strong> æ˜¯è°ƒç”¨<code>open</code>æ‰“å¼€<code>/proc/self/status</code>çš„.</p>
<p><code>loc_52880614</code>æ˜¯ç¬¬äºŒç§åè°ƒè¯•.</p>
<hr>
<h1 id="å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹"><a href="#å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹" class="headerlink" title="å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹"></a>å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹</h1><h2 id="è§£æstatusæ–‡ä»¶"><a href="#è§£æstatusæ–‡ä»¶" class="headerlink" title="è§£æstatusæ–‡ä»¶"></a>è§£æstatusæ–‡ä»¶</h2><h3 id="æ‰¾å‡º-TracerPid"><a href="#æ‰¾å‡º-TracerPid" class="headerlink" title="æ‰¾å‡º TracerPid"></a>æ‰¾å‡º TracerPid</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/33/10-style1" alt=""></p>
<h3 id="è½¬æ¢-TracerPid"><a href="#è½¬æ¢-TracerPid" class="headerlink" title="è½¬æ¢ TracerPid"></a>è½¬æ¢ TracerPid</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/19/37/38-style1" alt=""></p>
<h3 id="æ¯”è¾ƒ-TracerPid"><a href="#æ¯”è¾ƒ-TracerPid" class="headerlink" title="æ¯”è¾ƒ TracerPid"></a>æ¯”è¾ƒ TracerPid</h3><p>å¦‚æœ<code>TracerPid</code>ä¸ä¸º0,kill!</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/34/28-style1" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/34/47-style1" alt=""></p>
<h2 id="è§£æ-proc-net-tcpæ–‡ä»¶"><a href="#è§£æ-proc-net-tcpæ–‡ä»¶" class="headerlink" title="è§£æ/proc/net/tcpæ–‡ä»¶"></a>è§£æ/proc/net/tcpæ–‡ä»¶</h2><p>åœ¨æ¯”è¾ƒè¿‡<code>tracerid</code>å,æ¥ç€åˆè§£æäº†<code>tcp</code>æ–‡ä»¶.</p>
<h3 id="è°ƒç”¨å¤„"><a href="#è°ƒç”¨å¤„" class="headerlink" title="è°ƒç”¨å¤„"></a>è°ƒç”¨å¤„</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/12-style1" alt=""></p>
<h3 id="æ‰“å¼€æ–‡ä»¶"><a href="#æ‰“å¼€æ–‡ä»¶" class="headerlink" title="æ‰“å¼€æ–‡ä»¶"></a>æ‰“å¼€æ–‡ä»¶</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/33-style1" alt=""></p>
<h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/49-style1" alt=""></p>
<p>é€è¡Œæ¯”è¾ƒæ˜¯å¦å«æœ‰<code>00000000:5D8A</code>,5d8aå°±æ˜¯23946,<code>android_server</code>ç›‘å¬ç«¯å£å³ä¸º23946,0AçŠ¶æ€è¡¨ç¤ºç›‘å¬.<br>è¿™é‡Œr0ä¼šè¢«èµ‹ä¸º1ï¼Œè¿”å›è°ƒç”¨å¤„æ—¶è¿›ç¨‹å°±ä¼šè¢«kill.</p>
<p>å¦‚æœ¬æœºtcpæ–‡ä»¶ä¸­çš„å†…å®¹ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode                                                     </div><div class="line"> 0: 00000000:5D8A 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 42138 1 00000000 100 0 0 10 -1                            </div><div class="line"> 1: 00000000:15B3 00000000:0000 0A 00000000:00000000 00:00000000 00000000  2000        0 20426 1 00000000 100 0 0 10 -1                            </div><div class="line"> 2: 0100007F:91AF 0100007F:5D8A 01 00000000:00000000 00:00000000 00000000  2000        0 43283 1 00000000 21 4 2 10 -1                             </div><div class="line"> 3: ED01A8C0:15B3 EE01A8C0:E1B6 01 00000018:00000000 01:00000018 00000000  2000        0 20427 2 00000000 24 4 28 8 6                              </div><div class="line"> 4: 0100007F:5D8A 0100007F:91AF 01 00000000:00000000 02:00083C35 00000000     0        0 42634 2 00000000 22 4 3 10 -1</div></pre></td></tr></table></figure>
<hr>
<h1 id="ç»•è¿‡åè°ƒè¯•"><a href="#ç»•è¿‡åè°ƒè¯•" class="headerlink" title="ç»•è¿‡åè°ƒè¯•"></a>ç»•è¿‡åè°ƒè¯•</h1><p>å…³é”®æ–­ç‚¹æ˜¯:<code>libjiagu.so:loc_5288042C</code>,è¿”å›ä¹‹åå°±æ˜¯cmp.<br>ç¬¬äºŒç§åè°ƒè¯•<code>libjiagu.so:52880614</code>åœ¨cmpä¸‹é¢(è‹¥æœ‰).</p>
<p>æ–­ä¸‹ä¹‹ååœ¨lrå¯¹åº”çš„åœ°å€ä¸‹æ–­ç‚¹,f9ï¼Œå°†ä¸¤ä¸ªåè°ƒè¯•å‡½æ•°ä¸‹é¢çš„æ¯”è¾ƒçš„r0å€¼ä¿®æ”¹å°±å¯ä»¥äº†.</p>
<hr>
<h1 id="åè°ƒè¯•çš„patch"><a href="#åè°ƒè¯•çš„patch" class="headerlink" title="åè°ƒè¯•çš„patch"></a>åè°ƒè¯•çš„patch</h1><p>ä½†æ˜¯ä¸æ­¢ä¸€æ¬¡åè°ƒè¯•,æ¯æ¬¡çš„åœ°å€ä¹Ÿä¸åŒ,è€Œä¸”æ¯ä¸ªé‡‡ç”¨è¿™ç§åŠ å›ºçš„appéƒ½è¦å¦‚æ­¤,è¿™æ ·ä¹Ÿå¤ªä¸åˆ’ç®—äº†å§.æ—¢ç„¶å¦‚æ­¤,ä¸ºä»€ä¹ˆä¸patchä¸€ä¸‹å‘¢?</p>
<p>å°†<code>libjiagu.so</code>ä½œå¦‚ä¸‹ä¿®æ”¹å³å¯å»æ‰åè°ƒè¯•:(è¿”å›å€¼r0æ”¹ä¸º0,mov r0,#0)<br>æ–‡ä»¶åç§»<code>35EC</code>å¤„ -&gt; <code>04 00 A0 E1</code>æ”¹ä¸º<code>00 00 A0 E3</code><br>æ–‡ä»¶åç§»<code>3720</code>å¤„ -&gt; <code>01 00 A0 E3</code>æ”¹ä¸º<code>00 00 A0 E3</code></p>
<hr>
<p>æœ¬æ–‡å°ç™½é¼ : <a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/com.xiachufang_138.apk" target="_blank" rel="external">here</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://www.52pojie.cn/thread-435746-1-1.html" target="_blank" rel="external">xxxåŠ å›º ä¹‹ åŠ¨æ€è„±å£³</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
            <category> æŸåŠ å›º </category>
            
        </categories>
        
        
        <tags>
            
            <tag> anti-debug </tag>
            
            <tag> enforce </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¬¬ä¸€ä¸ªxposedæ¨¡å—ä¸­çš„â€œClass ref in pre-verified class resolved to unexpected implementationâ€é”™è¯¯åŸå› ]]></title>
      <url>/2016/01/03/xposed-class-ispreverified/</url>
      <content type="html"><![CDATA[<p>åœ¨æˆ‘çš„<a href="http://kiya.space/2015/12/28/hello-xposed/" target="_blank" rel="external">ç¬¬ä¸€ä¸ª Xposed æ¨¡å—</a>ä¸­æ›¾å‡ºç°<code>Class ref in pre-verified class resolved to unexpected implementation</code>é”™è¯¯,Xposed logå¦‚ä¸‹ï¼š</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">01-03 19:42:03.974 134-134/? I/Xposed: Loading modules from /data/app/space.kiya.xposedtest-1.apk</div><div class="line">01-03 19:42:04.285 134-134/? I/Xposed:   Loading class space.kiya.xposedtest.ChangeStatusBar</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed: java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexFile.defineClass(Native Method)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexFile.loadClassBinaryName(DexFile.java:211)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexPathList.findClass(DexPathList.java:313)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:51)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at java.lang.ClassLoader.loadClass(ClassLoader.java:501)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at java.lang.ClassLoader.loadClass(ClassLoader.java:461)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.loadModule(XposedBridge.java:421)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.loadModules(XposedBridge.java:386)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.main(XposedBridge.java:120)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure>
<p>ä»ä¸­å¯ä»¥çœ‹åˆ°,å› ä¸ºXposedBridgeçš„mainå‡½æ•°è°ƒç”¨äº†loadModules,è€ŒloadModulesåˆè°ƒç”¨äº†loadModule,loadModuleè°ƒç”¨loadClass,è¿™æ ·ä¸€å±‚ä¸€å±‚ä¸‹å»æœ€ç»ˆå¯¼è‡´äº†ç°åœ¨çš„é”™è¯¯.<br>æˆ‘ä»¬å°±ä»æ¡ˆå‘ç°åœº<code>loadclass</code>å’Œé”™è¯¯ä¿¡æ¯<code>Class ref in pre-verified class resolved to unexpected implementation</code>å…¥æ‰‹å§ï¼</p>
<h1 id="æ¡ˆå‘ç°åœº-loadclass"><a href="#æ¡ˆå‘ç°åœº-loadclass" class="headerlink" title="æ¡ˆå‘ç°åœº loadclass"></a>æ¡ˆå‘ç°åœº loadclass</h1><p>æŠŠ<a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="external">XposedBridgeçš„ä»£ç </a>cloneä¸‹æ¥,æ‰¾åˆ°<code>de/robv/android/xposed/XposedBridge</code>æ–‡ä»¶.</p>
<p>æˆ‘ä»¬çŸ¥é“<code>Xposed Installer</code>çš„ç•Œé¢æœ‰ä¸€ä¸ªæ¨¡å—åˆ—è¡¨,åœ¨å†™Xposedæ¨¡å—æ—¶ä¹Ÿéœ€è¦æ–°å»ºæ–‡ä»¶<code>xposed_init</code>å†™å…¥å®ç°äº†Xposedæ¥å£çš„ç±»å.</p>
<p>mainå‡½æ•°çš„ä½œç”¨å°±æ˜¯åˆå§‹åŒ–Xposedæ¡†æ¶å’Œæ¨¡å—,æ¨¡å—æ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„å‘¢?æ¥çœ‹loadModuleså‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Try to load all modules defined in &lt;code&gt;BASE_DIR/conf/modules.list&lt;/code&gt;</div><div class="line"> */</div><div class="line">private static void loadModules() throws IOException &#123;</div><div class="line">	final String filename = BASE_DIR + &quot;conf/modules.list&quot;;</div><div class="line">	BaseService service = SELinuxHelper.getAppDataFileService();</div><div class="line">	if (!service.checkFileExists(filename)) &#123;</div><div class="line">		Log.e(TAG, &quot;Cannot load any modules because &quot; + filename + &quot; was not found&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	InputStream stream = service.getFileInputStream(filename);</div><div class="line">	BufferedReader apks = new BufferedReader(new InputStreamReader(stream));</div><div class="line">	String apk;</div><div class="line">	while ((apk = apks.readLine()) != null) &#123;</div><div class="line">		loadModule(apk);</div><div class="line">	&#125;</div><div class="line">	apks.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>Xposed Installer</code>çš„å®‰è£…ç›®å½•<code>/data/data/de.robv.android.xposed.installer</code>ä¸‹çš„<code>conf</code>æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª<code>modules.list</code>æ–‡ä»¶,è®°å½•ç€æ¯ä¸ªxposedæ¨¡å—çš„apkçš„è·¯å¾„.<br><code>loadModules</code>å¯¹æ¯è¡Œ(ä¸€è¡Œå¯¹åº”ä¸€ä¸ªapkè·¯å¾„)è°ƒç”¨<code>loadModule</code>å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Load a module from an APK by calling the init(String) method for all classes defined</div><div class="line"> * in &lt;code&gt;assets/xposed_init&lt;/code&gt;.</div><div class="line"> */</div><div class="line">@SuppressWarnings(&quot;deprecation&quot;)</div><div class="line">private static void loadModule(String apk) &#123;</div><div class="line">	log(&quot;Loading modules from &quot; + apk);</div><div class="line"></div><div class="line">	if (!new File(apk).exists()) &#123;</div><div class="line">		log(&quot;  File does not exist&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ClassLoader mcl = new PathClassLoader(apk, BOOTCLASSLOADER);</div><div class="line">	InputStream is = mcl.getResourceAsStream(&quot;assets/xposed_init&quot;);</div><div class="line">	if (is == null) &#123;</div><div class="line">		log(&quot;assets/xposed_init not found in the APK&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	BufferedReader moduleClassesReader = new BufferedReader(new InputStreamReader(is));</div><div class="line">	try &#123;</div><div class="line">		String moduleClassName;</div><div class="line">		while ((moduleClassName = moduleClassesReader.readLine()) != null) &#123;</div><div class="line">			moduleClassName = moduleClassName.trim();</div><div class="line">			if (moduleClassName.isEmpty() || moduleClassName.startsWith(&quot;#&quot;))</div><div class="line">				continue;</div><div class="line"></div><div class="line">			try &#123;</div><div class="line">				log (&quot;  Loading class &quot; + moduleClassName);</div><div class="line">				Class&lt;?&gt; moduleClass = mcl.loadClass(moduleClassName);</div><div class="line"></div><div class="line">				if (!IXposedMod.class.isAssignableFrom(moduleClass)) &#123;</div><div class="line">					log (&quot;    This class doesn&apos;t implement any sub-interface of IXposedMod, skipping it&quot;);</div><div class="line">					continue;</div><div class="line">				&#125; else if (disableResources &amp;&amp; IXposedHookInitPackageResources.class.isAssignableFrom(moduleClass)) &#123;</div><div class="line">					log (&quot;    This class requires resource-related hooks (which are disabled), skipping it.&quot;);</div><div class="line">					continue;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				final Object moduleInstance = moduleClass.newInstance();</div><div class="line">				if (isZygote) &#123;</div><div class="line">					if (moduleInstance instanceof IXposedHookZygoteInit) &#123;</div><div class="line">						IXposedHookZygoteInit.StartupParam param = new IXposedHookZygoteInit.StartupParam();</div><div class="line">						param.modulePath = apk;</div><div class="line">						param.startsSystemServer = startsSystemServer;</div><div class="line">						((IXposedHookZygoteInit) moduleInstance).initZygote(param);</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					if (moduleInstance instanceof IXposedHookLoadPackage)</div><div class="line">						hookLoadPackage(new IXposedHookLoadPackage.Wrapper((IXposedHookLoadPackage) moduleInstance));</div><div class="line"></div><div class="line">					if (moduleInstance instanceof IXposedHookInitPackageResources)</div><div class="line">						hookInitPackageResources(new IXposedHookInitPackageResources.Wrapper((IXposedHookInitPackageResources) moduleInstance));</div><div class="line">				&#125; else &#123;</div><div class="line">					if (moduleInstance instanceof IXposedHookCmdInit) &#123;</div><div class="line">						IXposedHookCmdInit.StartupParam param = new IXposedHookCmdInit.StartupParam();</div><div class="line">						param.modulePath = apk;</div><div class="line">						param.startClassName = startClassName;</div><div class="line">						((IXposedHookCmdInit) moduleInstance).initCmdApp(param);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125; catch (Throwable t) &#123;</div><div class="line">				log(t);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; catch (IOException e) &#123;</div><div class="line">		log(e);</div><div class="line">	&#125; finally &#123;</div><div class="line">		try &#123;</div><div class="line">			is.close();</div><div class="line">		&#125; catch (IOException ignored) &#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>loadModule</code>è¯»å–æ¯ä¸ªapkæ–‡ä»¶ä¸­çš„<code>assets/xposed_init</code>,ä½¿ç”¨<code>PathClassLoader</code>çš„<code>loadclass</code>æ–¹æ³•åŠ è½½æ¯ä¸ªæ³¨å†Œçš„ç±»,ç„¶åå°†ç±»çš„å®ä¾‹ä½œä¸ºç›¸åº”xposedæ¨¡å—çš„å›è°ƒ.</p>
<p>é‚£ä¹ˆ<code>Class&lt;?&gt; moduleClass = mcl.loadClass(moduleClassName);</code>è¿™å¥ä»£ç æ˜¯æ€ä¹ˆä¼šå‡ºé”™çš„å‘¢?</p>
<h1 id="ä½•æ–¹ç¥åœ£-CLASS-ISPREVERIFIED"><a href="#ä½•æ–¹ç¥åœ£-CLASS-ISPREVERIFIED" class="headerlink" title="ä½•æ–¹ç¥åœ£ CLASS_ISPREVERIFIED"></a>ä½•æ–¹ç¥åœ£ CLASS_ISPREVERIFIED</h1><p><code>CLASS_ISPREVERIFIED</code>æ˜¯è™šæ‹Ÿæœºåœ¨å¯¹dexæ–‡ä»¶ä¼˜åŒ–æ—¶çš„ä¸€ä¸ª<code>ClassFlags</code>,è¡¨ç¤ºæŸä¸ªç±»æ˜¯å¦å·²ç»è¢«é¢„éªŒè¯è¿‡.<br>ä¹Ÿå°±æ˜¯è¯´å½“æŸä¸ªç±»ä¸­å¼•ç”¨çš„æ–¹æ³•å…¨éƒ¨æ¥è‡ªæ‰€åœ¨çš„dexæ–‡ä»¶ä¸­æ—¶,è¿™ä¸ªç±»å°±ä¼šè¢«æ‰“ä¸Šè¿™ä¸ªæ ‡è®°.<br>è‹¥appæœ‰å¤šä¸ªdexæ–‡ä»¶æ—¶,å½“å¼•ç”¨äº†æŸä¸ªå¸¦æœ‰è¿™ä¸ªæ ‡è®°çš„ç±»æ—¶,è™šæ‹Ÿæœºä¸éœ€è¦åœ¨å…¨éƒ¨çš„dexæ–‡ä»¶ä¸­æŸ¥æ‰¾,ä»è€Œå¸®åŠ©æé«˜dalvikè™šæ‹Ÿæœºçš„æ€§èƒ½.</p>
<p>å…³äºå¦‚ä½•éªŒè¯çš„ç»†èŠ‚ç¨ååˆ†æ.</p>
<p>æˆ‘ä»¬å†™çš„<code>ChangeStatusBar</code>ç±»å®ç°äº†<code>IXposedHookLoadPackage</code>,åŒæ—¶jaråŒ…çš„å¼•ç”¨æ–¹å¼ä¸º<code>compile</code>,æ‰€ä»¥ä¹ŸæŠŠXposedBridge.jarç¼–è¯‘è¿›dexäº†,å› æ­¤åœ¨éªŒè¯<code>ChangeStatusBar</code>ç±»æ—¶åœ¨æœ¬dexä¸­å¯ä»¥æ‰¾åˆ°<code>IXposedHookLoadPackage</code>ä»è€Œè¢«æ ‡è®°äº†<code>CLASS_ISPREVERIFIED</code>.</p>
<p><strong>é‚£ä¹ˆæ˜¯åœ¨å“ªé‡Œæ£€æŸ¥æ˜¯å¦æœ‰CLASS_ISPREVERIFIEDæ ‡è®°çš„å‘¢ï¼Ÿ</strong></p>
<p>æºä»£ç æ–‡ä»¶<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Resolve.cpp#119" target="_blank" rel="external">/dalvik/vm/oo/Resolve.cpp</a>çš„<code>dvmResolveClass</code>å‡½æ•°ä¸­:æœ‰è¿™ä¹ˆä¸€æ®µä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">if (!fromUnverifiedConstant &amp;&amp; IS_CLASS_FLAG_SET(referrer, CLASS_ISPREVERIFIED))</div><div class="line">&#123;</div><div class="line">    ClassObject* resClassCheck = resClass;</div><div class="line">    if (dvmIsArrayClass(resClassCheck))</div><div class="line">        resClassCheck = resClassCheck-&gt;elementClass;</div><div class="line"></div><div class="line">    if (referrer-&gt;pDvmDex != resClassCheck-&gt;pDvmDex &amp;&amp;</div><div class="line">        resClassCheck-&gt;classLoader != NULL)</div><div class="line">    &#123;</div><div class="line">        ALOGW(&quot;Class resolved by unexpected DEX:&quot;</div><div class="line">             &quot; %s(%p):%p ref [%s] %s(%p):%p&quot;,</div><div class="line">            referrer-&gt;descriptor, referrer-&gt;classLoader,</div><div class="line">            referrer-&gt;pDvmDex,</div><div class="line">            resClass-&gt;descriptor, resClassCheck-&gt;descriptor,</div><div class="line">            resClassCheck-&gt;classLoader, resClassCheck-&gt;pDvmDex);</div><div class="line">        ALOGW(&quot;(%s had used a different %s during pre-verification)&quot;,</div><div class="line">            referrer-&gt;descriptor, resClass-&gt;descriptor);</div><div class="line">        dvmThrowIllegalAccessError(</div><div class="line">            &quot;Class ref in pre-verified class resolved to unexpected &quot;</div><div class="line">            &quot;implementation&quot;);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“è™šæ‹Ÿæœºæ‰¾åˆ°éœ€è¦å¼•ç”¨çš„ç±»æ—¶,å¦‚æœå¼•ç”¨è€…å·²ç»è¢«é¢„éªŒè¯è¿‡,ä¸”å¼•ç”¨è€…æ‰€åœ¨çš„dexå’Œè¢«å¼•ç”¨è€…æ‰€åœ¨çš„dexä¸åŒæ—¶,æŠ›å‡º<code>Class ref in pre-verified class ...</code>å¼‚å¸¸!</p>
<p>è€Œåœ¨æˆ‘çš„<a href="http://kiya.space/2015/12/28/hello-xposed/" target="_blank" rel="external">ç¬¬ä¸€ä¸ª Xposed æ¨¡å—</a>å‡ºç°é”™è¯¯æ—¶dalvikçš„logå¦‚ä¸‹(ç»è¿‡å‰ªåˆ‡):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01-04 20:11:03.463 134-134/? W/dalvikvm: Class resolved by unexpected DEX: Lspace/kiya/xposedtest/ChangeStatusBar;(0x40e59fc8):0x5028f000 ref [Lde/robv/android/xposed/IXposedHookLoadPackage;] Lde/robv/android/xposed/IXposedHookLoadPackage;(0x40da2fd0):0x4f2f8000</div><div class="line">01-04 20:14:06.184 134-134/? W/dalvikvm: (Lspace/kiya/xposedtest/ChangeStatusBar; had used a different Lde/robv/android/xposed/IXposedHookLoadPackage; during pre-verification)</div><div class="line"></div><div class="line">01-04 20:11:03.467 134-134/? W/dalvikvm: Class resolved by unexpected DEX: Lspace/kiya/xposedtest/GetQQPassword;(0x40e59fc8):0x5028f000 ref [Lde/robv/android/xposed/IXposedHookLoadPackage;] Lde/robv/android/xposed/IXposedHookLoadPackage;(0x40da2fd0):0x4f2f8000</div><div class="line">01-04 20:14:06.187 134-134/? W/dalvikvm: (Lspace/kiya/xposedtest/GetQQPassword; had used a different Lde/robv/android/xposed/IXposedHookLoadPackage; during pre-verification)</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨<code>loadclass</code>æ—¶çš„å¼•ç”¨è€…æ˜¯<code>Lspace/kiya/xposedtest/ChangeStatusBar</code>,è¢«å¼•ç”¨è€…æ˜¯<code>Lde/robv/android/xposed/IXposedHookLoadPackage</code>.<br>(è§£æç±»çš„è¿‡ç¨‹åŒ…æ‹¬ç±»çš„æ‰€æœ‰å¼•ç”¨çš„æ£€æŸ¥,è¿™é‡Œé—®é¢˜æ˜¯å‡ºåœ¨æ¨¡å—ç±»å¼•ç”¨å…¶ä»–ç±»æ—¶è€ŒéxposedåŠ è½½æ¨¡å—ç±»æ—¶,æ•…å¼•ç”¨è€…æ˜¯è¢«åŠ è½½çš„æ¨¡å—ç±»)</p>
<p>dalvikè§£æçš„æ—¶å€™å‘ç°<code>IXposedHookLoadPackage</code>å’Œ<code>ChangeStatusBar</code>ä¸åœ¨ä¸€ä¸ªdexæ–‡ä»¶å†…,ä½†æ˜¯<code>ChangeStatusBar</code>ç±»å·²ç»è¢«æ ¡éªŒè¿‡äº†å‘€,é‡Œé¢æ‰€æœ‰çš„æ–¹æ³•éƒ½åœ¨æœ¬dexå†…,ç°åœ¨åˆå‘Šè¯‰æˆ‘ä¸åœ¨ä¸€èµ·äº†,é‚£è‚¯å®šè¦æŠ¥é”™äº†!</p>
<p>å’Œä¸Šä¸€å°èŠ‚çš„é—®é¢˜ç»“åˆèµ·æ¥,å¿…ç„¶æ˜¯<code>loadclass</code>åŠ è½½ç±»çš„åŒæ—¶åšäº†éªŒè¯!æ˜¯å¦æ˜¯è¿™æ ·æˆ‘ä»¬éšåå†éªŒè¯.</p>
<p>ç°åœ¨çš„é—®é¢˜æ˜¯æ˜æ˜<code>ChangeStatusBar</code>å·²ç»é€šè¿‡äº†æ ¡éªŒ,<code>IXposedHookLoadPackage</code>å’Œ<code>ChangeStatusBar</code>åœ¨åŒä¸€ä¸ªdexä¸­,æ€ä¹ˆåŠ è½½æ—¶<code>IXposedHookLoadPackage</code>åˆä¸åœ¨è¿™é‡Œäº†?</p>
<h1 id="ç½ªé­ç¥¸é¦–-PathClassLoader"><a href="#ç½ªé­ç¥¸é¦–-PathClassLoader" class="headerlink" title="ç½ªé­ç¥¸é¦– PathClassLoader"></a>ç½ªé­ç¥¸é¦– PathClassLoader</h1><p>è¿™å°±è¦è¯´è¯´PathClassLoaderäº†.</p>
<p><code>XposedBridge</code>æºç ä¸­ä½¿ç”¨çš„ç±»åŠ è½½å™¨å°±æ˜¯PathClassLoader.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public static final ClassLoader BOOTCLASSLOADER = ClassLoader.getSystemClassLoader();</div><div class="line">ClassLoader mcl = new PathClassLoader(apk, BOOTCLASSLOADER);</div></pre></td></tr></table></figure>
<p>å…¶ä¸­apkæ˜¯æ¨¡å—apkçš„è·¯å¾„;BOOTCLASSLOADERæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨çš„å®ä¾‹,ä»classpathä¸­åŠ è½½ç±».</p>
<blockquote>
<p>loadClassæ–¹æ³•åœ¨åŠ è½½ä¸€ä¸ªç±»çš„å®ä¾‹çš„æ—¶å€™ï¼Œ<br>ä¼šå…ˆæŸ¥è¯¢å½“å‰ClassLoaderå®ä¾‹æ˜¯å¦åŠ è½½è¿‡æ­¤ç±»ï¼Œæœ‰å°±è¿”å›ï¼›<br>å¦‚æœæ²¡æœ‰ã€‚æŸ¥è¯¢Parentæ˜¯å¦å·²ç»åŠ è½½è¿‡æ­¤ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œå°±ç›´æ¥è¿”å›ParentåŠ è½½çš„ç±»ï¼›<br>å¦‚æœç»§æ‰¿è·¯çº¿ä¸Šçš„ClassLoaderéƒ½æ²¡æœ‰åŠ è½½ï¼Œæ‰ç”±Childæ‰§è¡Œç±»çš„åŠ è½½å·¥ä½œï¼›</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„<code>apk</code>æ˜¯æœ€åä¸€ä¸ªè¢«æŸ¥æ‰¾çš„è·¯å¾„.</p>
<p>è€Œåœ¨<code>Xposed</code>æºç ä¸­çš„<code>app_main.cpp</code>(è¢«ä¿®æ”¹è¿‡çš„app_process)è°ƒç”¨äº†<code>xposed::initialize(zygote, startSystemServer, className, argc, argv)</code>,<code>initialize</code>ä¸­åˆè°ƒç”¨äº†<code>addJarToClasspath()</code>,åŠŸèƒ½å°±æ˜¯å°†<code>XposedBridge.jar</code>æ·»åŠ åˆ°Java classpath!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#define XPOSED_JAR               &quot;/system/framework/XposedBridge.jar&quot;</div><div class="line">/** Add XposedBridge.jar to the Java classpath. */</div><div class="line">bool addJarToClasspath() &#123;</div><div class="line">    ALOGI(&quot;-----------------&quot;);</div><div class="line"></div><div class="line">    if (access(XPOSED_JAR, R_OK) == 0) &#123;</div><div class="line">        if (!addPathToEnv(&quot;CLASSPATH&quot;, XPOSED_JAR))</div><div class="line">            return false;</div><div class="line"></div><div class="line">        ALOGI(&quot;Added Xposed (%s) to CLASSPATH&quot;, XPOSED_JAR);</div><div class="line">        return true;</div><div class="line">    &#125; else &#123;</div><div class="line">        ALOGE(&quot;ERROR: Could not access Xposed jar &apos;%s&apos;&quot;, XPOSED_JAR);</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥<code>loadclass</code>åœ¨æ£€æŸ¥<code>apk</code>è·¯å¾„ä¹‹å‰ç³»ç»Ÿç±»åŠ è½½å™¨å°±åœ¨ç³»ç»Ÿç±»è·¯å¾„ä¸­çš„<code>XposedBridge.jar</code>ä¸­æ‰¾åˆ°äº†<code>IXposedHookLoadPackage</code>,è™½ç„¶æˆ‘ä»¬çš„apkä¸­ä¹Ÿæœ‰è¿™ä¸ªå‡½æ•°,ä½†æ˜¯è¿˜æ²¡æœ‰ç­‰åˆ°åŠ è½½å°±å·²ç»ç»“æŸäº†.</p>
<p>åˆ°è¿™é‡Œå°±å¯ä»¥ç†æ¸…é”™è¯¯ä¸ºä»€ä¹ˆå‘ç”Ÿäº†:</p>
<ol>
<li>ç¼–å†™æ¨¡å—æ—¶æˆ‘ä»¬æŠŠ<code>XposedBridge.jar</code>ç¼–è¯‘è¿›äº†dexæ–‡ä»¶ä¸­;</li>
<li>dalvikåœ¨ä¼˜åŒ–dexæ—¶ä¸ºæ¨¡å—ç±»æ‰“ä¸Šäº†<code>CLASS_ISPREVERIFIED</code>æ ‡è®°,è¡¨ç¤ºæ²¡æœ‰å¼•ç”¨çš„ç±»å…¨éƒ¨æ¥è‡ªæœ¬dex;</li>
<li>xposedæ¡†æ¶ä¿®æ”¹åçš„app_processä¼šåœ¨å¼€æœºæ—¶å°†<code>/system/framework/XposedBridge.jar</code>åŠ å…¥ç±»è·¯å¾„;</li>
<li>éšåxposedè¦åŠ è½½æˆ‘ä»¬æ³¨å†Œçš„æ¨¡å—ç±»,åœ¨äº‹å…ˆä¸ºå…¶å‡†å¤‡å¥½çš„jaråŒ…ä¸­æ‰¾åˆ°äº†å¼•ç”¨çš„ç±»;</li>
<li>ä½†æ˜¯æ¨¡å—ç±»è¢«æ‰“ä¸Šæ ‡è®°äº†,xposedå‘ç°æ¨¡å—å°±æ²¡æ‰“ç®—ç”¨è‡ªå·±å‡†å¤‡å¥½çš„ç±»,åè€Œè¦è‡ªç»™è‡ªè¶³,è¿™å“ªæ˜¯æ¡†æ¶å’Œæ¨¡å—çš„å…³ç³»!ç®€ç›´æ˜¯é€ å!äºæ˜¯æ„¤è€ŒæŠ¥é”™.</li>
</ol>
<p>å‰é¢ä¹Ÿæåˆ°è§£å†³æ–¹æ³•å°±æ˜¯ä¸å°†<code>XposedBridge.jar</code>ç¼–è¯‘è¿›dexå³å¯,è¿™æ ·ä¸ä¼šè¢«æ‰“ä¸Šæ ‡è®°,ä¸‡äº‹ok.<br>ç°åœ¨appçš„çƒ­ä¿®å¤åŸç†ä¹Ÿæ˜¯è¿™æ ·.</p>
<h1 id="å‡Œæ™¨4ç‚¹-startvm"><a href="#å‡Œæ™¨4ç‚¹-startvm" class="headerlink" title="å‡Œæ™¨4ç‚¹ startvm"></a>å‡Œæ™¨4ç‚¹ startvm</h1><p>åˆ°äº†ç°åœ¨,å¦‚æœä¸åœ¨æ„ä¸€äº›ç»†èŠ‚,æœ¬æ¡ˆå·²ç»è¢«ç ´!</p>
<p>ä¹‹å‰è¯´åˆ°,å½“ç±»åŠ è½½å™¨è°ƒç”¨<code>loadclass</code>åŠ è½½ç±»æ—¶å‘ç°<code>ChangeStatusBar</code>ç±»å·²ç»è¢«æ ¡éªŒè¿‡â€¦<br>ç­‰ç­‰!æˆ‘ä»¬çš„XposedBridgeåŠ è½½æ¨¡å—ç±»çš„ä»£ç æ˜¯åœ¨app_processä¸­å‘€,è€Œæ ¡éªŒæ˜¯å±äºdexopt(dexä¼˜åŒ–)çš„æ­¥éª¤å“‡,éš¾é“dexä¼˜åŒ–æ¯”app_processè¿™ä¸ªå¯åŠ¨ä»£ç è¿˜è¦æ—©?</p>
<p>é‚£ä¹ˆé—®é¢˜å°±æ¸…æ™°å¤šäº†: <strong>app_process å’Œ dexopt çš„å…³ç³»</strong>.</p>
<p>ä¸€ä¸ªappå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªapp_processè¿›ç¨‹,app_processçš„ä½œç”¨å¦‚ä¸‹:</p>
<ol>
<li>åˆ›å»ºjvm</li>
<li>æ‰§è¡ŒstartClassçš„mainæ–¹æ³•</li>
</ol>
<p><code>app_main.cpp</code>ä¸­çš„éƒ¨åˆ†æ·»åŠ ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#define XPOSED_CLASS_DOTS_ZYGOTE &quot;de.robv.android.xposed.XposedBridge&quot;</div><div class="line">isXposedLoaded = xposed::initialize(zygote, startSystemServer, className, argc, argv);</div><div class="line">if (zygote) &#123;</div><div class="line">    runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_ZYGOTE : &quot;com.android.internal.os.ZygoteInit&quot;,</div><div class="line">            startSystemServer ? &quot;start-system-server&quot; : &quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>initialize</code>åœ¨ä¸Šé¢æåˆ°è¿‡,è€Œ<code>runtime.start</code>å°±æ˜¯androidæºç <a href="http://androidxref.com/4.4.4_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#805" target="_blank" rel="external">/frameworks/base/core/jni/AndroidRuntime.cpp</a>ä¸­çš„<code>AndroidRuntime::start</code>å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Start the Android runtime.  This involves starting the virtual machine</div><div class="line"> * and calling the &quot;static void main(String[] args)&quot; method in the class</div><div class="line"> * named by &quot;className&quot;.</div><div class="line"> *</div><div class="line"> * Passes the main function two arguments, the class name and the specified</div><div class="line"> * options string.</div><div class="line"> */</div><div class="line">void AndroidRuntime::start(const char* className, const char* options)</div></pre></td></tr></table></figure>
<p><strong>æ­¤å‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯:</strong> å¯åŠ¨è™šæ‹Ÿæœº,æ‰§è¡Œä¼ å…¥ç±»çš„mainå‡½æ•°<br><strong>æµç¨‹:</strong> AndroidRuntime::start -&gt; startvm -&gt; æ‰§è¡Œä¼ å…¥çš„ç±»çš„mainå‡½æ•°<br>æœ¬æ¡ˆä¸­ä¼ å…¥çš„ç±»æ˜¯<code>de.robv.android.xposed.XposedBridge</code>.</p>
<p>è€Œstartvmä¸­åˆæ‰§è¡Œäº†ä»€ä¹ˆå‘¢?<br>startvm -&gt; JNI_CreateJavaVM -&gt; dvmStartup -&gt; dvmClassStartup -&gt; â€¦ -&gt; ç›´åˆ°ä¼˜åŒ–dexæ—¶éªŒè¯class</p>
<p>====&gt; å› æ­¤å½“XposedBridgeçš„mainå‡½æ•°æ‰§è¡Œæ—¶,dexä¸­çš„å„ä¸ªç±»å·²ç»è¢«verifyè¿‡äº†.æˆ‘ä»¬çš„çŒœæƒ³æ˜¯å¯¹å“©.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://bugly.qq.com/blog/?p=781" target="_blank" rel="external">ã€æ–°æŠ€èƒ½getã€‘è®©AppåƒWebä¸€æ ·å‘å¸ƒæ–°ç‰ˆæœ¬</a></p>
<p><a href="http://gold.xitu.io/entry/564ab7eb60b259caed3827f1" target="_blank" rel="external">Android çƒ­è¡¥ä¸åŠ¨æ€ä¿®å¤æ¡†æ¶å°ç»“</a></p>
<p><a href="http://segmentfault.com/a/1190000004062880" target="_blank" rel="external">AndroidåŠ¨æ€åŠ è½½åŸºç¡€ ClassLoaderå·¥ä½œæœºåˆ¶</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Xposed </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¬¬ä¸€ä¸ª Xposed æ¨¡å—]]></title>
      <url>/2015/12/28/hello-xposed/</url>
      <content type="html"><![CDATA[<p>ç¯å¢ƒ:<br>å·²rootæ‰‹æœºä¸€æš(Android 4.4.4)<br>Android Studioä¸€æš</p>
<a id="more"></a>
<p>å®˜æ–¹æ–‡æ¡£å‚è€ƒ<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial-style1" target="_blank" rel="external">è¿™é‡Œ</a>.</p>
<h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>æˆ‘ä»¬éœ€è¦äº‹å…ˆä¸‹è½½ä¸€ä¸ª<a href="http://dl-xda.xposed.info/modules/de.robv.android.xposed.installer_v33_36570c.apk-style1" target="_blank" rel="external">Xposed installer</a>å®‰è£…åœ¨æ‰‹æœºä¸Š,ç”¨æ¥ç®¡ç†æ‰€æœ‰çš„æ¨¡å—.</p>
<p>å®‰è£…å®Œæˆåæ‰“å¼€:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/02-style1" alt=""></p>
<p>ç‚¹å‡»<code>æ¡†æ¶</code>,</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/32-style1" alt=""></p>
<p>ç‚¹å‡»<code>å®‰è£…/æ›´æ–°</code>å®‰è£…æ¡†æ¶,</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/49-style1" alt=""></p>
<p>ç‚¹å‡»ç¡®å®šé‡å¯,æ¡†æ¶ç•Œé¢æ˜¯è¿™æ ·çš„:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/54/11-style1" alt=""></p>
<h1 id="ç¼–å†™æ–°æ¨¡å—"><a href="#ç¼–å†™æ–°æ¨¡å—" class="headerlink" title="ç¼–å†™æ–°æ¨¡å—"></a>ç¼–å†™æ–°æ¨¡å—</h1><p>æ‰“å¼€android studio,æ–°å»ºå·¥ç¨‹,é€‰æ‹©<code>Add no activity</code></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/54/35-style1" alt=""></p>
<p>æ–°å»ºå®Œæˆå,æ‰¾åˆ°<code>app</code>ç›®å½•ä¸‹çš„<code>build.gradle</code>æ–‡ä»¶,å°†<code>dependencies</code>ä¸­çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div></pre></td></tr></table></figure>
<p>æ”¹ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">provided fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div></pre></td></tr></table></figure>
<p>ä¸‹è½½<a href="http://forum.xda-developers.com/attachment.php?attachmentid=2748878&amp;d=1400342298-style1" target="_blank" rel="external">XposedBridgeApi-54.jar</a>å¹¶æ”¾å…¥appç›®å½•ä¸‹çš„libsæ–‡ä»¶å¤¹.</p>
<p>åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶çš„<code>application</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ,å…¶ä¸­çš„54æ˜¯å‰é¢ä¸‹è½½çš„æ–‡ä»¶ä¸­çš„å·ç .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposedmodule&quot;</div><div class="line">    android:value=&quot;true&quot; /&gt;</div><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposeddescription&quot;</div><div class="line">    android:value=&quot;kiya&apos;s test module&quot; /&gt;</div><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposedminversion&quot;</div><div class="line">    android:value=&quot;54&quot; /&gt;</div></pre></td></tr></table></figure>
<p>æ–°å»ºä¸€ä¸ª<code>Test</code>ç±»,å†™å…¥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">package space.kiya.xposedtest;</div><div class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</div><div class="line">import de.robv.android.xposed.XposedBridge;</div><div class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</div><div class="line"></div><div class="line">public class Test implements IXposedHookLoadPackage&#123;</div><div class="line">    @Override public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123;</div><div class="line">        XposedBridge.log(&quot;loaded: &quot; + loadPackageParam.packageName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–°å»º<code>assets</code>æ–‡ä»¶å¤¹,åœ¨é‡Œé¢æ–°å»ºæ–‡ä»¶åä¸º<code>xposed_init</code>,å†™å…¥åˆšåˆšçš„ç±»å,æ­¤å¤„åº”ä¸º<code>space.kiya.xposedtest.Test</code>.</p>
<p>è¿™æ—¶å°±å¯ä»¥ç¼–è¯‘å®‰è£…äº†.</p>
<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>å› ä¸ºå·¥ç¨‹æ²¡æœ‰activity,æ‰€ä»¥åœ¨æ¡Œé¢ä¸Šçœ‹ä¸åˆ°è¯¥åº”ç”¨ã€‚<br>æ¥åˆ°<code>xposed installer</code>çš„<code>æ¨¡å—</code>ä¸­,å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æ¨¡å—å‡ºç°åœ¨è¿™é‡Œ,ç°åœ¨å‹¾é€‰å®ƒ:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/10/17/03-style1" alt=""></p>
<p>åœ¨é‡å¯ä½¿ä¹‹ç”Ÿæ•ˆä¹‹å‰,æˆ‘ä»¬åœ¨logcatæ–°å»ºä¸€ä¸ªtagä¸º<code>Xposed</code>çš„è¿‡æ»¤å™¨,è¿™æ ·å°±å¯ä»¥è¿‡æ»¤å‡ºæ¨¡å—è¾“å‡ºçš„log.<br>å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Loading Xposed v54(for Zygote)...</div><div class="line">Loading modules from /data/app/space.kiya.xposedtest-1.apk</div><div class="line">  Loading class space.kiya.xposedtest.Test</div><div class="line">Loaded: android</div><div class="line">...</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„æ—¥å¿—åœ¨<code>xposed installer</code>çš„<code>æ—¥å¿—</code>ä¸­ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°çš„.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/10/16/42-style1" alt=""></p>
<h1 id="å¯èƒ½å‡ºç°çš„é”™è¯¯"><a href="#å¯èƒ½å‡ºç°çš„é”™è¯¯" class="headerlink" title="å¯èƒ½å‡ºç°çš„é”™è¯¯"></a>å¯èƒ½å‡ºç°çš„é”™è¯¯</h1><p>å¦‚æœè¾“å‡ºçš„logä¸­å‡ºç°äº†å¦‚ä¸‹é”™è¯¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</div></pre></td></tr></table></figure>
<p>è¯´æ˜æ˜¯å‰é¢æ­¥éª¤ä¸­æ²¡æœ‰ä¿®æ”¹<code>build.gradle</code>å¯¼è‡´çš„.</p>
<p>å…·ä½“åŸå› è§<a href="http://kiya.space/2016/01/03/xposed-class-ispreverified/" target="_blank" rel="external">å¦ä¸€ç¯‡åšå®¢</a>.</p>
<h1 id="xposedæ€æ ·å·¥ä½œ"><a href="#xposedæ€æ ·å·¥ä½œ" class="headerlink" title="xposedæ€æ ·å·¥ä½œ?"></a>xposedæ€æ ·å·¥ä½œ?</h1><p>å¼€æœºæ—¶,<code>./init.rc</code>è„šæœ¬æ–‡ä»¶ä¼šå¯åŠ¨<code>Zygote</code>è¿›ç¨‹,Zygoteå¯¹åº”çš„å…·ä½“ç¨‹åºæ˜¯<code>/system/bin/app_process</code>,ç„¶ååŠ è½½éœ€è¦çš„ç±»,è°ƒç”¨åˆå§‹åŒ–çš„æ–¹æ³•,ä¹‹åå¯åŠ¨çš„æ¯ä¸ªåº”ç”¨éƒ½æ˜¯Zygoteçš„æ‹·è´,æ‰€ä»¥Zygoteè¿›ç¨‹æ˜¯ååˆ†é‡è¦çš„.</p>
<p>é€šè¿‡åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä¸€ä¸ªjaråŒ…,åœ¨<code>app_process</code>çš„ç‰¹å®šä½ç½®è°ƒç”¨jaråŒ…ä¸­çš„æ–¹æ³•,Xposedæ¡†æ¶å®ç°äº†å¸¦æ‰©å±•åŠŸèƒ½çš„<code>app_process</code>,ç„¶åå°†åŸæœ‰çš„<code>app_process</code>æ›¿æ¢æ‰.<br>åœ¨<code>/data/data/de.robv.android.xposed.installer/bin/</code>ç›®å½•ä¸‹æœ‰ä¸€ä¸ª<code>XposedBridge.jar</code>æ–‡ä»¶,å®ƒå°±æ˜¯è¢«å¼•ç”¨çš„jaråŒ…,æºç åœ¨<a href="https://github.com/rovo89/XposedBridge-style1" target="_blank" rel="external">github</a>,mainå‡½æ•°åœ¨<code>/src/de/robv/android/xposed/XposedBridge.java</code>ä¸­,æ¯ä¸ªè¿›ç¨‹æ¯æ¬¡å¯åŠ¨æ—¶éƒ½ä¼šè¢«è°ƒç”¨.åŠ è½½æ¨¡å—çš„åŠŸèƒ½ä¹Ÿæ˜¯åœ¨è¿™é‡Œå®ç°.</p>
<p>XposedçœŸæ­£å¼ºå¤§çš„æ˜¯å®ƒå¯ä»¥hookè°ƒç”¨çš„æ–¹æ³•.å½“ä½ åç¼–è¯‘ä¿®æ”¹apkæ—¶,ä½ å¯ä»¥åœ¨é‡Œé¢æ’å…¥xposedçš„å‘½ä»¤,äºæ˜¯ä½ å°±å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨å‰åæ³¨å…¥è‡ªå·±çš„ä»£ç .</p>
<p>XposedBridgeæœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°æ–¹æ³•<code>hookMethodNative</code>,ä»£ç å®ç°æ”¾åœ¨<code>app_process</code>ä¸­.åœ¨è°ƒç”¨è¢«hookçš„æ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨æ­¤æ–¹æ³•,<code>hookMethodNative</code>æœ‰ä¸€ä¸ª<code>handleHookedMethod</code>æ–¹æ³•,å¯ä»¥ä¿®æ”¹ä¼ é€’ç»™è¢«hookå‡½æ•°çš„å‚æ•°,å˜é‡ç”šè‡³æ˜¯è°ƒç”¨å…¶ä»–æ–¹æ³•.</p>
<h1 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h1><p>ä»¥ä¸Šä»…ä»…æ˜¯è¯æ˜äº†æˆ‘ä»¬çš„xposedæ¨¡å—æ˜¯å¯ä»¥å·¥ä½œçš„.ç°åœ¨æ¥ä¿®æ”¹ç‚¹ä»€ä¹ˆ,æ¯”å¦‚çŠ¶æ€æ ä¸Šçš„æ—¶é—´?</p>
<p>åœ¨å®‰è£…æºç ä¸‹çš„<a href="http://androidxref.com/4.4.4_r1/xref/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java#42" target="_blank" rel="external">/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java</a>æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª<code>updateClock</code>å‡½æ•°ç”¨æ¥æ›´æ–°æ—¶é—´.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final void updateClock() &#123;</div><div class="line">    if (mDemoMode) return;</div><div class="line">    mCalendar.setTimeInMillis(System.currentTimeMillis());</div><div class="line">    setText(getSmallTime());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä»£ç ä¸­ä½¿ç”¨<code>findAndHookMethod</code>å‡½æ•°æ‰¾åˆ°è¿™ä¸€å‡½æ•°,å¹¶åœ¨updateClockå‡½æ•°æ‰§è¡Œåå°†<code>TextView</code>çš„å†…å®¹é‡æ–°è®¾ç½®å³å¯.æ³¨æ„åœ¨ä½¿ç”¨å‰éœ€è¦è¿™æ ·å°†å…¶å¯¼å…¥:<code>import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</code>.<br>æˆ‘ä»¬çš„æ•ˆæœæ˜¯å°†æ—¶é—´åé¢åŠ ä¸Šä¸€ä¸ªç¬‘è„¸,é¢œè‰²è®¾ä¸ºçº¢è‰².<br>ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">package space.kiya.xposedtest;</div><div class="line"></div><div class="line">import android.graphics.Color;</div><div class="line">import android.widget.TextView;</div><div class="line"></div><div class="line">import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</div><div class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</div><div class="line">import de.robv.android.xposed.XC_MethodHook;</div><div class="line">import de.robv.android.xposed.XposedBridge;</div><div class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</div><div class="line"></div><div class="line">public class Test implements IXposedHookLoadPackage&#123;</div><div class="line">    @Override public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123;</div><div class="line">        if(loadPackageParam.packageName.equals(&quot;com.android.systemui&quot;))&#123;</div><div class="line">            findAndHookMethod(&quot;com.android.systemui.statusbar.policy.Clock&quot;, loadPackageParam.classLoader, &quot;updateClock&quot;, new XC_MethodHook() &#123;</div><div class="line">                @Override protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</div><div class="line">                    TextView tv = (TextView)param.thisObject;</div><div class="line">                    String text = tv.getText().toString();</div><div class="line">                    tv.setText(text + &quot;:)&quot;);</div><div class="line">                    tv.setTextColor(Color.RED);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/15/34/49-style1" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Xposed </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hook - Android ARMä¸‹çš„çš„soæ³¨å…¥]]></title>
      <url>/2015/12/23/hook-call-function-in-so/</url>
      <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹<a href="http://www.weibo.com/zhengmin1989" target="_blank" rel="external">å¤§çŠ‡è’¸ç±³spark</a>çš„<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a>çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">é“¾æ¥</a>.</p>
<a id="more"></a>
<p><strong>è¢«æµ‹è¯•ä»£ç :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line"></div><div class="line">int count = 0;</div><div class="line"></div><div class="line">void print()</div><div class="line">&#123;</div><div class="line">	printf(&quot;hello,%d\n&quot;,count);</div><div class="line">        sleep(1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(int argc, char const *argv[])</div><div class="line">&#123;</div><div class="line">	while(1)&#123;</div><div class="line">		print();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨å…¥æ–¹æ³•éƒ½æ˜¯é€šè¿‡ptraceå®ç°çš„.<br>æœ¬æ–‡ä»£ç åœ¨<a href="https://github.com/kiya-z/Android/tree/master/hook" target="_blank" rel="external">github</a>.</p>
<h1 id="è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°"><a href="#è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°" class="headerlink" title="è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°"></a>è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°</h1><p>ç›®æ ‡å‡½æ•°æ˜¯<code>libc.so</code>ä¸­çš„<code>sleep</code>å‡½æ•°.<br>æ­£å¸¸æƒ…å†µæ˜¯æ¯è¾“å‡ºä¸€æ¬¡æš‚åœä¸€ç§’,ç°åœ¨æˆ‘ä»¬è®©å®ƒæš‚åœ10ç§’.</p>
<h2 id="æ€»ä½“æ€è·¯"><a href="#æ€»ä½“æ€è·¯" class="headerlink" title="æ€»ä½“æ€è·¯"></a>æ€»ä½“æ€è·¯</h2><ul>
<li>è·å–ç›®æ ‡è¿›ç¨‹sleepå‡½æ•°åœ°å€</li>
<li>åœ¨ç›®æ ‡è¿›ç¨‹å†…æ‰§è¡Œsleepå‡½æ•°</li>
</ul>
<h2 id="å¦‚ä½•è·å–å‡½æ•°åœ°å€"><a href="#å¦‚ä½•è·å–å‡½æ•°åœ°å€" class="headerlink" title="å¦‚ä½•è·å–å‡½æ•°åœ°å€"></a>å¦‚ä½•è·å–å‡½æ•°åœ°å€</h2><ul>
<li><p><strong>å·²çŸ¥æ¡ä»¶</strong>: æœ¬è¿›ç¨‹çš„åŸºå€ã€ç›®æ ‡è¿›ç¨‹çš„åŸºå€ã€æœ¬è¿›ç¨‹ä¸­sleepå‡½æ•°çš„åœ°å€(å½“ç„¶,è¿™äº›å·²çŸ¥æ¡ä»¶ä¹Ÿæ˜¯éœ€è¦è·å¾—çš„ :p)<br><code>/proc/&lt;pid&gt;/maps</code>æ–‡ä»¶ä¸­å­˜å‚¨çš„æ˜¯è¿›ç¨‹å†…å­˜æ˜ å°„è¯¦æƒ…,æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥è¯¢è¿›ç¨‹ä¸­soçš„åŸºå€;<br><code>sleep</code>å‡½æ•°åœ¨æœ¬è¿›ç¨‹ä¸­çš„åœ°å€ç›´æ¥å¯ä»¥è·å¾—(<code>void*</code>)</p>
</li>
<li><p><strong>æ±‚è§£</strong>: ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€</p>
</li>
<li><p><strong>è®¡ç®—</strong>: æœ¬è¿›ç¨‹sleepåœ°å€ - æœ¬è¿›ç¨‹åŸºå€ + ç›®æ ‡è¿›ç¨‹åŸºå€</p>
</li>
</ul>
<h3 id="è·å–soåº“çš„åŠ è½½åŸºå€"><a href="#è·å–soåº“çš„åŠ è½½åŸºå€" class="headerlink" title="è·å–soåº“çš„åŠ è½½åŸºå€"></a>è·å–soåº“çš„åŠ è½½åŸºå€</h3><p>æ‰“å¼€<code>/proc/&lt;pid&gt;/maps</code>æ–‡ä»¶æ‰¾åˆ°åŸºå€.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">void* get_module_base(int pid, const char* module_name)</div><div class="line">&#123;</div><div class="line">    FILE *f;		//æ–‡ä»¶æŒ‡é’ˆ</div><div class="line">    long addr = 0;	//æ¨¡å—åœ°å€</div><div class="line">    char filename[32];	//mapsè·¯å¾„</div><div class="line">    char *pch;</div><div class="line">    char line[1024];	//æ¯è¡Œ</div><div class="line">    if(pid == 0)&#123;</div><div class="line">        snprintf(filename, sizeof(filename), &quot;/proc/self/maps&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">        snprintf(filename, sizeof(filename), &quot;/proc/%d/maps&quot;, pid);</div><div class="line">    &#125;</div><div class="line">    f = fopen(filename, &quot;r&quot;);</div><div class="line">    if(f != NULL)&#123;</div><div class="line">        while(fgets(line,sizeof(line),f))&#123;</div><div class="line">           if(strstr(line, module_name)) &#123;  //æ‰¾åˆ°è¯¥è¡Œæ˜¯å¦å«æœ‰module_name</div><div class="line">               pch = strtok(line,&quot;-&quot;);  //åˆ†å‰²å‡ºåŸºå€å­—ç¬¦ä¸²</div><div class="line">               addr = strtoul(pch,NULL,0x10); //è½¬æ¢ä¸º16è¿›åˆ¶æ•°</div><div class="line">               if(addr == 0x8000)   //32ä½linuxç¨‹åºä¸­é»˜è®¤çš„textåŠ è½½åœ°å€ä¸º0x08408000,64ä½çš„æ”¹ä¸º0x00400000,æ­¤æ—¶è®¡ç®—baseåœ°å€å°±æ²¡ä»€ä¹ˆç”¨äº†</div><div class="line">                   addr = 0;</div><div class="line">               break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        fclose(f);</div><div class="line">    &#125;</div><div class="line">    return (void*)addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€"><a href="#è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€" class="headerlink" title="è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€"></a>è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">long get_remote_addr(int target_pid, const char* module_name, void* local_addr)</div><div class="line">&#123;</div><div class="line">    void* local_handle = get_module_base(0,module_name);</div><div class="line">    void* remote_handle = get_module_base(target_pid,module_name);</div><div class="line"></div><div class="line">    printf(&quot;local_handle:%p  remote_handle:%p\n&quot;, local_handle, remote_handle);</div><div class="line"></div><div class="line">    //è®¡ç®—å…¬å¼</div><div class="line">    long remote_addr = (long)((uint32_t)local_addr - (uint32_t)local_handle + (uint32_t)remote_handle);</div><div class="line"></div><div class="line">    printf(&quot;remote_addr:%p\n&quot;, remote_addr);</div><div class="line">    return remote_addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°"><a href="#å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°" class="headerlink" title="å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°"></a>å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°</h2><ul>
<li>è®¾ç½®å‡½æ•°å‚æ•°,å¦‚æœå‚æ•°ä¸ªæ•°å°äºç­‰äº4,å‚æ•°æŒ‰é¡ºåºæ”¾å…¥R0~R4å¯„å­˜å™¨ä¸­;å¦‚æœå‚æ•°ä¸ªæ•°å¤§äº4,å¤šä½™çš„éƒ¨åˆ†éœ€è¦å…¥æ ˆ.</li>
<li>è®¾ç½®pcå¯„å­˜å™¨çš„å€¼,è®¾ç½®å½“å‰æŒ‡ä»¤é›†æ ‡å¿—ä½.</li>
<li>åº”ç”¨ä»¥ä¸Šå¯„å­˜å™¨çš„ä¿®æ”¹ä½¿ä¹‹ç”Ÿæ•ˆ.</li>
<li>ç­‰å¾…å‡½æ•°æ‰§è¡Œ.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">//ç›®æ ‡è¿›ç¨‹id,å‚æ•°åœ°å€,å‚æ•°ä¸ªæ•°,å¯„å­˜å™¨åœ°å€</div><div class="line">int ptrace_call(int pid, long addr, long *params, uint32_t params_num, struct pt_regs* regs)</div><div class="line">&#123;</div><div class="line">    uint32_t i;</div><div class="line">    for (i = 0; i &lt; params_num &amp;&amp; i &lt; 4; i++) &#123;     //è®¾ç½®å°‘äº4ä¸ªçš„å‚æ•°</div><div class="line">        regs-&gt;uregs[i] = params[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //è®¾ç½®å¤šäº4ä¸ªçš„å‚æ•°</div><div class="line">    if (i &lt; params_num) &#123;</div><div class="line">        regs-&gt;ARM_sp -= (params_num - i) * long_size;    //æŠ¬é«˜æ ˆé¡¶æŒ‡é’ˆ(åˆ†é…ç©ºé—´)</div><div class="line">        writeData(pid, (long)regs-&gt;ARM_sp, (char*)&amp;params[i], (params_num - i) * long_size); //å†™å…¥</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    regs-&gt;ARM_pc = addr;    //è®¾ç½®pc</div><div class="line">    if (regs-&gt;ARM_pc &amp; 1) &#123;     //åˆ¤æ–­æ˜¯å¦æ˜¯ThumbæŒ‡ä»¤</div><div class="line">        regs-&gt;ARM_pc &amp;= (~1u);  //Thumbçš„pcæœ€åä¸€ä½æ€»æ˜¯0</div><div class="line">        regs-&gt;ARM_cpsr |= CPSR_T_MASK;  //Tæ ‡å¿—ä½ä¸º1</div><div class="line">    &#125; else &#123;    //arm</div><div class="line">        regs-&gt;ARM_cpsr &amp;= ~CPSR_T_MASK;  //Tæ ‡å¿—ä½ä¸º0</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    regs-&gt;ARM_lr = 0;   //ä¸ºäº†ä½¿sleepå‡½æ•°æ‰§è¡Œå®Œæ¯•åäº§ç”Ÿâ€œå†…å­˜è®¿é—®é”™è¯¯â€,è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®Œäº†</div><div class="line"></div><div class="line">    if(ptrace_setregs(pid,regs)==-1 || ptrace_continue(pid)==-1)&#123;   //ç›®æ ‡è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int stat = 0;                   //WUNTRACEDè¡¨ç¤ºå¦‚æœpidè¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€ï¼Œé‚£ä¹ˆwaitpidå‡½æ•°ç«‹å³è¿”å›</div><div class="line">    waitpid(pid,&amp;stat,WUNTRACED);   //ç­‰å¾…sleepå‡½æ•°æ‰§è¡Œ,ç­‰å¾…è¿‡ç¨‹ä¸­æœ¬è¿›ç¨‹æš‚åœæ‰§è¡Œ</div><div class="line">    printf(&quot;%d\n&quot;, stat);</div><div class="line">    while (stat != 0xb7f) &#123;     //0xb7fè¡¨ç¤ºç›®æ ‡è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€</div><div class="line">        printf(&quot;%d\n&quot;, stat);</div><div class="line">        if (ptrace_continue(pid) == -1) &#123;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        waitpid(pid,&amp;stat,WUNTRACED);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•æ³¨å…¥"><a href="#å¦‚ä½•æ³¨å…¥" class="headerlink" title="å¦‚ä½•æ³¨å…¥"></a>å¦‚ä½•æ³¨å…¥</h2><ul>
<li>ä¿å­˜å¯„å­˜å™¨çš„å€¼</li>
<li>è·å¾—sleepå‡½æ•°åœ°å€</li>
<li>æ‰§è¡Œsleepå‡½æ•°</li>
<li>æ¢å¤å¯„å­˜å™¨çš„å€¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">void inject(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs old_regs,regs;</div><div class="line">    long sleep_addr;</div><div class="line">    //ä¿å­˜å¯„å­˜å™¨</div><div class="line">    ptrace(PTRACE_GETREGS, pid, NULL, &amp;old_regs);</div><div class="line">    memcpy(&amp;regs, &amp;old_regs, sizeof(regs));</div><div class="line"></div><div class="line">    long parameters[1];</div><div class="line">    parameters[0] = 10;</div><div class="line">    sleep_addr = get_remote_addr(pid, &quot;libc.so&quot;, (void*)sleep);</div><div class="line">    ptrace_call(pid,sleep_addr,parameters,1,&amp;regs);</div><div class="line">    //æ¢å¤å¯„å­˜å™¨</div><div class="line">    ptrace(PTRACE_SETREGS, pid, NULL, &amp;old_regs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ä¸»å‡½æ•°"><a href="#ä¸»å‡½æ•°" class="headerlink" title="ä¸»å‡½æ•°"></a>ä¸»å‡½æ•°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;string.h&gt;  // strstr,strtok</div><div class="line">#include&lt;stdlib.h&gt;  //strtoul</div><div class="line">#include&lt;stdint.h&gt;  //uint32_t</div><div class="line">#include&lt;unistd.h&gt;  //sleep</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">#include&lt;linux/wait.h&gt;    // WUNTRACED</div><div class="line">#include&lt;time.h&gt;</div><div class="line"></div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(argc != 2)&#123;</div><div class="line">        printf(&quot;usage: %s &lt;pid to be traced&gt;\n&quot;,argv[0]);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    int pid = atoi(argv[1]);</div><div class="line"></div><div class="line">    if(0 != ptrace(PTRACE_ATTACH, pid, NULL, NULL))&#123;</div><div class="line">        printf(&quot;attach failed.&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    inject(pid);</div><div class="line"></div><div class="line">    ptrace(PTRACE_DETACH, pid, NULL, NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ç•ªå¤–"><a href="#ç•ªå¤–" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><h2 id="proc-lt-pid-gt-æ–‡ä»¶å¤¹"><a href="#proc-lt-pid-gt-æ–‡ä»¶å¤¹" class="headerlink" title="/proc/&lt;pid&gt; æ–‡ä»¶å¤¹"></a>/proc/&lt;pid&gt; æ–‡ä»¶å¤¹</h2><table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>cmdline</td>
<td>å‘½ä»¤è¡Œå…¨å(åŠ å‚æ•°å˜é‡)å’Œ ps å‘½ä»¤ä¸­çš„command åˆ—ç»“æœä¸€æ ·</td>
</tr>
<tr>
<td>cwd</td>
<td>è¿›ç¨‹çš„å·¥ä½œç›®å½• å’Œ (pwdx PID) ç»“æœç›¸åŒ</td>
</tr>
<tr>
<td>environ</td>
<td>è¿›ç¨‹çš„ç¯å¢ƒå˜é‡</td>
</tr>
<tr>
<td>exe</td>
<td>ä¸€èˆ¬æ˜¯/bin/ çš„é“¾æ¥</td>
</tr>
<tr>
<td>fd</td>
<td>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°fu .ç”¨ls -l å¯ä»¥æŸ¥çœ‹å…·ä½“çš„æ–‡ä»¶ (å¯ä»¥ç”¨lsof -p PID)</td>
</tr>
<tr>
<td>status</td>
<td>è¿›ç¨‹çš„ç›¸å…³çŠ¶æ€</td>
</tr>
<tr>
<td>task</td>
<td>è¯¥ç›®å½•ä¸‹æ˜¯è¿›ç¨‹æ‰€åŒ…å«çš„çº¿ç¨‹(note: ps å¯ä»¥æŸ¥çœ‹çº¿ç¨‹)</td>
</tr>
<tr>
<td>mounts</td>
<td>è¿›ç¨‹æŒ‚è½½ç‚¹</td>
</tr>
<tr>
<td>maps</td>
<td>è¿›ç¨‹å†…å­˜æ˜ å°„è¯¦æƒ…</td>
</tr>
</tbody>
</table>
<h2 id="å…³äºpcå¯„å­˜å™¨"><a href="#å…³äºpcå¯„å­˜å™¨" class="headerlink" title="å…³äºpcå¯„å­˜å™¨"></a>å…³äºpcå¯„å­˜å™¨</h2><p><a href="https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf" target="_blank" rel="external">arm.pdf</a> ä¸­çš„<strong>A2.4.3 Register 15 and the program counter</strong>æœ‰è¿™æ ·ä¸€æ®µè¯:<br>æ˜¯å…³äºæŒ‡ä»¤é›†åœ¨pcå¯„å­˜å™¨ä¸Šçš„è¡¨ç°çš„.</p>
<blockquote>
<p>Reading the program counter<br>When an instruction reads the PC, the value read depends on which instruction set it comes from:<br>â€¢ For an ARM instruction, the value read is the address of the instruction plus 8 bytes. Bits [1:0] of this<br>value are always zero, because ARM instructions are always word-aligned.<br>â€¢ For a Thumb instruction, the value read is the address of the instruction plus 4 bytes. Bit [0] of this<br>value is always zero, because Thumb instructions are always halfword-aligned.</p>
</blockquote>
<h2 id="å…³äºCPSRå¯„å­˜å™¨"><a href="#å…³äºCPSRå¯„å­˜å™¨" class="headerlink" title="å…³äºCPSRå¯„å­˜å™¨"></a>å…³äºCPSRå¯„å­˜å™¨</h2><table>
<thead>
<tr>
<th>31</th>
<th>30</th>
<th>29</th>
<th>28</th>
<th>27</th>
<th>26  25</th>
<th>24</th>
<th>23 20</th>
<th>19 16</th>
<th>15 10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4 0</th>
</tr>
</thead>
<tbody>
<tr>
<td>N</td>
<td>Z</td>
<td>C</td>
<td>V</td>
<td>Q</td>
<td>Res</td>
<td>J</td>
<td>RESERVED</td>
<td>GE[3:0]</td>
<td>RESERVED</td>
<td>E</td>
<td>A</td>
<td>I</td>
<td>F</td>
<td>T</td>
<td>M[4:0]</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­Jå’ŒTæ ‡è®°ä½ä»£è¡¨å½“å‰æŒ‡ä»¤é›†:</p>
<table>
<thead>
<tr>
<th>J</th>
<th>T</th>
<th>Instruction set</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>ARM</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>Thumb</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>Jazelle</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>RESERVED</td>
</tr>
</tbody>
</table>
<h2 id="å…³äºwaitpid"><a href="#å…³äºwaitpid" class="headerlink" title="å…³äºwaitpid"></a>å…³äºwaitpid</h2><p>è¯¦ç»†ä»‹ç»å¯çœ‹<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr2/wait.htm" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>.</p>
<h3 id="å‚æ•°status"><a href="#å‚æ•°status" class="headerlink" title="å‚æ•°status"></a>å‚æ•°status</h3><p><code>wait</code>å‡½æ•°è°ƒç”¨è¿‡å,<code>status</code>æŒ‡é’ˆæŒ‡å‘å¯ä»¥è¢«å®è§£æçš„å€¼,è¿™äº›å®åœ¨ndkç›®å½•ä¸‹<code>platforms/android-21/arch-arm/usr/include/sys/wait.h</code>æ–‡ä»¶ä¸­å®šä¹‰.</p>
<p>é«˜2å­—èŠ‚ç”¨äºè¡¨ç¤ºå¯¼è‡´å­è¿›ç¨‹çš„é€€å‡ºæˆ–æš‚åœçŠ¶æ€ä¿¡å·å€¼(<code>WTERMSIG</code>)ï¼Œä½2å­—èŠ‚è¡¨ç¤ºå­è¿›ç¨‹æ˜¯é€€å‡º(0x0)è¿˜æ˜¯æš‚åœ(0x7f)çŠ¶æ€(<code>WEXITSTATUS</code>)ã€‚<br>å¦‚:0xb7få°±è¡¨ç¤ºå­è¿›ç¨‹ä¸ºæš‚åœçŠ¶æ€ï¼Œå¯¼è‡´å®ƒæš‚åœçš„ä¿¡å·é‡ä¸º11å³<code>sigsegv</code>é”™è¯¯ã€‚<br>å…³äºé”™è¯¯ä»£ç çš„æ–‡æ¡£å¯çœ‹<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr1/lrv1ch5.htm" target="_blank" rel="external">è¿™é‡Œ</a>,<br>å®šä¹‰åœ¨ndkç›®å½•ä¸‹<code>platforms/android-21/arch-arm/usr/include/asm/signal.h</code>ä¸­.</p>
<blockquote>
<p>å…¶ä¸­ä¸¤ä¸ªå®:<br>WEXITSTATUS(*statusPtr):<br>if the child process terminates normally, this macro evaluates to the lower 8 bits of the value passed to the exit or _exit function or returned from main.<br>WTERMSIG(*statusPtr)<br>if the child process ends by a signal that was not caught, this macro evaluates to the number of that signal.</p>
</blockquote>
<h3 id="å‚æ•°options"><a href="#å‚æ•°options" class="headerlink" title="å‚æ•°options"></a>å‚æ•°options</h3><p>æŒ‡å®šäº†<code>waitpid</code>çš„é¢å¤–è¡ŒåŠ¨.é€‰é¡¹æœ‰:</p>
<p><strong>WNOHANG</strong>:<br>å‘Šè¯‰<code>waitpid</code>ä¸ç­‰ç¨‹åºä¸­æ­¢ç«‹å³è¿”å›<code>status</code>ä¿¡æ¯.<br>æ­£å¸¸æƒ…å†µæ˜¯å½“ä¸»è¿›ç¨‹å¯¹å­è¿›ç¨‹ä½¿ç”¨äº†<code>waitpid</code>,ä¸»è¿›ç¨‹å°±ä¼šé˜»å¡ç›´åˆ°<code>waitpid</code>è¿”å›<code>status</code>ä¿¡æ¯;å¦‚æœæŒ‡å®šäº†<code>WNOHANG</code>é€‰é¡¹,ä¸»è¿›ç¨‹å°±ä¸ä¼šé˜»å¡äº†.<br>å¦‚æœè¿˜æ²¡æœ‰å¯ç”¨çš„<code>status</code>ä¿¡æ¯,<code>waitpid</code>è¿”å›0.</p>
<p><strong>WUNTRACED</strong>:<br>å‘Šè¯‰<code>waitpid</code>ï¼Œå¦‚æœå­è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€æˆ–è€…å·²ç»ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°±ç«‹å³è¿”å›<code>status</code>ä¿¡æ¯,æ­£å¸¸æƒ…å†µæ˜¯ç´«ç¦åŸç»ˆæ­¢çš„æ—¶å€™æ‰è¿”å›.<br>å¦‚æœæ˜¯è¢«ptraceçš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆå³ä½¿ä¸æä¾›WUNTRACEDå‚æ•°ï¼Œä¹Ÿä¼šåœ¨å­è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€çš„æ—¶å€™ç«‹å³è¿”å›ã€‚<br>å¯¹äºä½¿ç”¨<code>ptrace_cont</code>è¿è¡Œçš„å­è¿›ç¨‹ï¼Œå®ƒä¼šåœ¨3ç§æƒ…å†µä¸‹è¿›å…¥æš‚åœçŠ¶æ€ï¼šâ‘ ä¸‹ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼›â‘¡å­è¿›ç¨‹é€€å‡ºï¼›â‘¢å­è¿›ç¨‹çš„æ‰§è¡Œå‘ç”Ÿé”™è¯¯ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç¨‹åºä¸­çš„<code>0xb7f</code>å°±è¡¨ç¤ºå­è¿›ç¨‹è¿›å…¥äº†æš‚åœçŠ¶æ€ï¼Œä¸”å‘é€çš„é”™è¯¯ä¿¡å·ä¸º11(SIGSEGV)ï¼Œå®ƒè¡¨ç¤ºè¯•å›¾è®¿é—®æœªåˆ†é…ç»™è‡ªå·±çš„å†…å­˜, æˆ–è¯•å›¾å¾€æ²¡æœ‰å†™æƒé™çš„å†…å­˜åœ°å€å†™æ•°æ®ã€‚<br>å½“å­è¿›ç¨‹æ‰§è¡Œå®Œæ³¨å…¥çš„å‡½æ•°åï¼Œç”±äºæˆ‘ä»¬åœ¨å‰é¢è®¾ç½®äº†regs-&gt;ARM_lr = 0ï¼Œå®ƒå°±ä¼šè¿”å›åˆ°0åœ°å€å¤„ç»§ç»­æ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šäº§ç”ŸSIGSEGVäº†.</p>
<h1 id="è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°"><a href="#è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°" class="headerlink" title="è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°"></a>è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°</h1><ul>
<li>ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€</li>
<li>è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€</li>
<li>è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯</li>
<li>è°ƒç”¨dlopenåŠ è½½soåº“</li>
<li>è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€</li>
<li>æ‰§è¡Œç›®æ ‡å‡½æ•°</li>
<li>è°ƒç”¨dlcloseå¸è½½soåº“</li>
<li>æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€</li>
</ul>
<h2 id="ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€"><a href="#ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€" class="headerlink" title="ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€"></a>ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">struct pt_regs old_regs,regs;</div><div class="line">ptrace(PTRACE_GETREGS, pid, NULL, &amp;old_regs);</div><div class="line">memcpy(&amp;regs,&amp;old_regs,sizeof(regs));</div></pre></td></tr></table></figure>
<h2 id="è·å–ç›®æ ‡ç¨‹åºçš„mmap-dlopen-dlsym-dlcloseå‡½æ•°åœ°å€"><a href="#è·å–ç›®æ ‡ç¨‹åºçš„mmap-dlopen-dlsym-dlcloseå‡½æ•°åœ°å€" class="headerlink" title="è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€"></a>è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">long mmap_addr,dlopen_addr,dlsym_addr,dlclose_addr;</div><div class="line">mmap_addr = get_remote_addr(pid, libc_path, (void*)mmap);</div><div class="line">dlopen_addr = get_remote_addr(pid, libc_path, (void*)dlopen);</div><div class="line">dlsym_addr = get_remote_addr(pid, libc_path, (void*)dlsym);</div><div class="line">dlclose_addr = get_remote_addr(pid, libc_path, (void*)dlclose);</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯"><a href="#è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯" class="headerlink" title="è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯"></a>è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯</h2><p>mmapçš„åŸå‹å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>addr</td>
<td>æ˜ å°„çš„èµ·å§‹åœ°å€,ä¸º0è¡¨ç¤ºç”±ç³»ç»Ÿå†³å®šæ˜ å°„çš„èµ·å§‹åœ°å€</td>
</tr>
<tr>
<td>length</td>
<td>æ˜ å°„çš„é•¿åº¦</td>
</tr>
<tr>
<td>prot</td>
<td>æ˜ å°„çš„å†…å­˜ä¿å­˜å±æ€§,ä¸èƒ½ä¸æ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼å†²çª</td>
</tr>
<tr>
<td>flags</td>
<td>æŒ‡å®šæ˜ å°„å¯¹è±¡çš„ç±»å‹,æ˜ å°„é€‰é¡¹å’Œæ˜ å°„é¡µæ˜¯å¦å¯ä»¥å…±äº«</td>
</tr>
<tr>
<td>fd</td>
<td>æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦,ä¸€èˆ¬æ˜¯ç”±open()å‡½æ•°è¿”å›;å…¶å€¼ä¹Ÿå¯ä»¥è®¾ç½®ä¸º-1,æ­¤æ—¶éœ€è¦æŒ‡å®šflagså‚æ•°ä¸­çš„MAP_ANON,è¡¨æ˜è¿›è¡Œçš„æ˜¯åŒ¿åæ˜ å°„</td>
</tr>
<tr>
<td>offset</td>
<td>è¢«æ˜ å°„å¯¹è±¡å†…å®¹çš„èµ·ç‚¹</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>mmap(0,0x4000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE,0,0)</code>,<br><code>PROT_EXEC</code>è¡¨ç¤ºå¯æ‰§è¡Œ.<br><code>PROT_READ</code>è¡¨ç¤ºå¯è¯».<br><code>PROT_WRITE</code>è¡¨ç¤ºå¯å†™.<br><code>MAP_PRIVATE</code>è¡¨ç¤ºå»º.ç«‹ä¸€ä¸ªå†™å…¥æ—¶æ‹·è´çš„ç§æœ‰æ˜ å°„.å†…å­˜åŒºåŸŸçš„å†™å…¥ä¸ä¼šå½±å“åˆ°åŸæ–‡ä»¶.è¿™ä¸ªæ ‡å¿—å’Œä»¥ä¸Šæ ‡å¿—æ˜¯äº’æ–¥çš„,åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª.<br><code>MAP_ANONYMOUS</code>è¡¨ç¤ºåŒ¿åæ˜ å°„,æ˜ å°„åŒºä¸ä¸ä»»ä½•æ–‡ä»¶å…³è”.<br>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">long parameters[10];    </div><div class="line">parameters[0] = 0;  //æ„é€ å‚æ•°</div><div class="line">parameters[1] = 0x4000;</div><div class="line">parameters[2] = PROT_READ | PROT_WRITE | PROT_EXEC;</div><div class="line">parameters[3] = MAP_ANONYMOUS | MAP_PRIVATE;</div><div class="line">parameters[4] = 0;</div><div class="line">parameters[5] = 0;</div><div class="line">ptrace_call(pid,mmap_addr,parameters,6,&amp;regs);</div><div class="line">//è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">long mapping_base = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlopenåŠ è½½soåº“"><a href="#è°ƒç”¨dlopenåŠ è½½soåº“" class="headerlink" title="è°ƒç”¨dlopenåŠ è½½soåº“"></a>è°ƒç”¨dlopenåŠ è½½soåº“</h2><p><strong>åŸå‹:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *dlopen(const char *filename, int flags);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>filename</td>
<td>soåº“å</td>
</tr>
<tr>
<td>flags</td>
<td>æ‰“å¼€æ–¹å¼</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>dlopen(so_path,RTLD_NOW | RTLD_GLOBAL)</code>,<br><code>RTLD_NOW</code>è¡¨ç¤ºéœ€è¦åœ¨dlopenè¿”å›å‰,è§£æå‡ºæ‰€æœ‰æœªå®šä¹‰ç¬¦å·,å¦‚æœè§£æä¸å‡ºæ¥åœ¨dlopenä¼šè¿”å›NULL;<br><code>RTLD_GLOBAL</code>è¡¨ç¤ºåŠ¨æ€åº“ä¸­å®šä¹‰çš„ç¬¦å·å¯è¢«å…¶åæ‰“å¼€çš„å…¶å®ƒåº“è§£æ.<br>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, so_path, strlen(so_path)+1);   //å°†åº“åå­—ç¬¦ä¸²æ”¾å…¥ç›®æ ‡è¿›ç¨‹ç©ºé—´</div><div class="line">parameters[0] = mapping_base;</div><div class="line">parameters[1] = RTLD_NOW | RTLD_GLOBAL;</div><div class="line">ptrace_call(pid, dlopen_addr, parameters, 2, &amp;regs);</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);  //è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">long handle = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€"><a href="#è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€" class="headerlink" title="è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€"></a>è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€</h2><p>åŸå‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *dlsym(void *handle, const char *symbol);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>handle</td>
<td>soåº“çš„åŸºå€</td>
</tr>
<tr>
<td>symbol</td>
<td>å‡½æ•°ååœ°å€</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>dlsym(handle, function_name)</code>,åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, function_name, strlen(function_name)+1);</div><div class="line">parameters[0] = handle;</div><div class="line">parameters[1] = mapping_base;</div><div class="line">ptrace_call(pid, dlsym_addr, parameters, 2, &amp;regs);</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);  //è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">long function_addr = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="æ‰§è¡Œç›®æ ‡å‡½æ•°"><a href="#æ‰§è¡Œç›®æ ‡å‡½æ•°" class="headerlink" title="æ‰§è¡Œç›®æ ‡å‡½æ•°"></a>æ‰§è¡Œç›®æ ‡å‡½æ•°</h2><p>å…ˆå†™æ®µcç¨‹åºç¼–è¯‘ä¸ºsoæ–‡ä»¶:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line"></div><div class="line">void hello(char *str)</div><div class="line">&#123;</div><div class="line">    printf(&quot;hello %s\n&quot;,str);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, function_parameters, strlen(function_parameters)+1);</div><div class="line">parameters[0] = mapping_base;</div><div class="line">ptrace_call(pid, function_addr, parameters, 1, &amp;regs);</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlcloseå¸è½½soåº“"><a href="#è°ƒç”¨dlcloseå¸è½½soåº“" class="headerlink" title="è°ƒç”¨dlcloseå¸è½½soåº“"></a>è°ƒç”¨dlcloseå¸è½½soåº“</h2><p>åŸå‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int dlclose(void *handle);</div></pre></td></tr></table></figure>
<p>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">parameters[0] = handle;</div><div class="line">ptrace_call(pid,dlclose_addr,parameters,1,&amp;regs);</div></pre></td></tr></table></figure>
<h2 id="æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€"><a href="#æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€" class="headerlink" title="æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€"></a>æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ptrace(PTRACE_SETREGS,pid,NULL,&amp;old_regs);</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a></p>
<p><a href="http://blog.csdn.net/jinzhuojun/article/details/9900105" target="_blank" rel="external">Androidä¸­çš„soæ³¨å…¥(inject)å’ŒæŒ‚é’©(hook) - For both x86 and arm</a></p>
<p><a href="http://www.cnblogs.com/wanyuanchun/p/4020756.html" target="_blank" rel="external">Androidæ³¨å…¥å®Œå…¨å‰–æ</a></p>
<p><a href="http://segmentfault.com/a/1190000000606904" target="_blank" rel="external">http://segmentfault.com/a/1190000000606904</a></p>
<p><a href="http://www.sanwho.com/133.html" target="_blank" rel="external">Androidä¸‹soæ³¨å…¥æ±‡æ€»</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hook </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Pythonçˆ¬è™« - ç™»å½•csdn]]></title>
      <url>/2015/12/22/csdn-login/</url>
      <content type="html"><![CDATA[<p>ä½¿ç”¨<code>urllib2</code>ã€<code>BeautifulSoup</code>å’Œ<code>CookieJar</code>å®ç°ç™»å½•.</p>
<a id="more"></a>
<p>ä½¿ç”¨charlesæŠ“åŒ…æ‰¾åˆ°postçš„loginç½‘å€: <code>https://passport.csdn.net/account/login</code></p>
<p>å†æ¥çœ‹çœ‹postçš„å‚æ•°:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/22/16/26/16" alt=""></p>
<p>å“å‘€è¿™é‡Œçš„å¯†ç ç«Ÿç„¶æ˜¯æ˜æ–‡..</p>
<p>usernameã€passwordå’Œ_eventIdå¥½è¯´,åªæ˜¯ltå’Œexecutionåœ¨å“ªé‡Œè·å¾—å‘¢?</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç´§æŒ¨ç€çš„GETè¯·æ±‚è¿”å›çš„htmlä»£ç ,è¿™é‡Œç«Ÿç„¶è¿˜æœ‰æ³¨é‡Šå“‡å“‡:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/22/16/29/43" alt=""></p>
<p>å¥½,é‚£ä¹ˆç°åœ¨æ€»ç»“ä¸€ä¸‹ <strong>æ­¥éª¤</strong>:</p>
<ol>
<li>å¯¹<code>https://passport.csdn.net/account/login</code>è¿›è¡Œgetè¯·æ±‚,åœ¨htmlä»£ç ä¸­è·å¾—ltå’Œexecution;</li>
<li>è¡¨å•åˆ›å»º</li>
<li>å¸¦ä¸ŠPOSTè¡¨å•,è¿›è¡ŒPOSTè¯·æ±‚</li>
</ol>
<p><strong>ä»£ç å¦‚ä¸‹:</strong></p>
<p>è·å– lt å’Œ execution:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cookie = cookielib.MozillaCookieJar(&apos;cookie.txt&apos;)   # MozillaCookieJarå¯ä¿å­˜cookie</div><div class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</div><div class="line">opener = urllib2.build_opener(cookie_handler)</div><div class="line"># prepare for login</div><div class="line">response = opener.open(&apos;https://passport.csdn.net/account/login&apos;)</div><div class="line">data = response.read()</div><div class="line">lt = &quot;&quot;</div><div class="line">execution = &quot;&quot;</div><div class="line">bs = BeautifulSoup(response.read(),&quot;lxml&quot;)</div><div class="line">for input in bs.form.find_all(&apos;input&apos;):</div><div class="line">    if input.get(&apos;name&apos;) == &apos;lt&apos;:</div><div class="line">        lt = input.get(&apos;value&apos;)</div><div class="line">    if input.get(&apos;name&apos;) == &apos;execution&apos;:</div><div class="line">        execution = input.get(&apos;value&apos;)</div></pre></td></tr></table></figure>
<p><strong>è¡¨å•</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">post_data = urllib.urlencode(&#123;</div><div class="line">    &apos;username&apos; : &apos;xxxx&apos;,</div><div class="line">    &apos;password&apos; : &apos;xxxx&apos;,</div><div class="line">    &apos;lt&apos; : lt,</div><div class="line">    &apos;execution&apos; : execution,</div><div class="line">    &apos;_eventId&apos; : &apos;submit&apos;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>POSTåœ°å€</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">login_url = &apos;https://passport.csdn.net/account/login&apos;</div></pre></td></tr></table></figure>
<p><strong>POST</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">request = urllib2.Request(url = login_url,data=post_data)</div><div class="line">try:</div><div class="line">    response = opener.open(request)</div><div class="line">except urllib2.HTTPError as e:</div><div class="line">    print e.read()</div></pre></td></tr></table></figure>
<p><strong>GETå…¶ä»–ç½‘å€éªŒè¯</strong>:</p>
<p>æ³¨æ„è¿™é‡Œçš„requestè¯·æ±‚éœ€è¦å¸¦ä¸Šheaders,å¦åˆ™ä¼šæŠ¥<code>403 forbidden</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">headers_data = &#123;</div><div class="line">    &apos;User-Agent&apos; :	&apos;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&apos;</div><div class="line">&#125;</div><div class="line">request = urllib2.Request(url = &apos;http://blog.csdn.net/attach_114&apos;,headers=headers_data)</div><div class="line">print opener.open(request).read()</div></pre></td></tr></table></figure>
<p><strong>å®Œæ•´ä»£ç :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">#coding:utf-8</div><div class="line">import urllib</div><div class="line">import urllib2</div><div class="line">import cookielib</div><div class="line">from bs4 import BeautifulSoup</div><div class="line">from pass_csdn import username,password</div><div class="line">cookie = cookielib.MozillaCookieJar(&apos;cookie.txt&apos;)</div><div class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</div><div class="line">opener = urllib2.build_opener(cookie_handler)</div><div class="line">def login():</div><div class="line">    # prepare for login</div><div class="line">    response = opener.open(&apos;https://passport.csdn.net/account/login&apos;)</div><div class="line">    lt = &quot;&quot;</div><div class="line">    execution = &quot;&quot;</div><div class="line">    bs = BeautifulSoup(response.read(),&quot;lxml&quot;)</div><div class="line">    for input in bs.form.find_all(&apos;input&apos;):</div><div class="line">        if input.get(&apos;name&apos;) == &apos;lt&apos;:</div><div class="line">            lt = input.get(&apos;value&apos;)</div><div class="line">        if input.get(&apos;name&apos;) == &apos;execution&apos;:</div><div class="line">            execution = input.get(&apos;value&apos;)</div><div class="line">    post_data = urllib.urlencode(&#123;</div><div class="line">        &apos;username&apos; : username,</div><div class="line">        &apos;password&apos; : password,</div><div class="line">        &apos;lt&apos; : lt,</div><div class="line">        &apos;execution&apos; : execution,</div><div class="line">        &apos;_eventId&apos; : &apos;submit&apos;</div><div class="line">    &#125;)</div><div class="line">    headers_data = &#123;</div><div class="line">        &apos;User-Agent&apos; :	&apos;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&apos;</div><div class="line">    &#125;</div><div class="line">    login_url_with_jsession = &apos;https://passport.csdn.net/account/login&apos;</div><div class="line">    request = urllib2.Request(url = login_url_with_jsession,data=post_data)</div><div class="line">    try:</div><div class="line">        response = opener.open(request)</div><div class="line">    except urllib2.HTTPError as e:</div><div class="line">        print e.read()</div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    login()</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Python </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hook - æ‹¦æˆªç³»ç»Ÿè°ƒç”¨]]></title>
      <url>/2015/12/21/hook-syscall/</url>
      <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹<a href="http://www.weibo.com/zhengmin1989" target="_blank" rel="external">å¤§çŠ‡è’¸ç±³spark</a>çš„<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a>çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">é“¾æ¥</a>.</p>
<a id="more"></a>
<p>å®ç°hookå°±ç¦»ä¸å¼€<a href="http://kiya.space/2015/12/18/ptrace-basis/" target="_blank" rel="external">ptrace</a>.</p>
<h1 id="ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨"><a href="#ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨"></a>ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨</h1><p>ç³»ç»Ÿè°ƒç”¨ç”±SWIå®ç°,å³è½¯ä»¶ä¸­æ–­(Software Interrupt),åœ¨è¯·æ±‚ç³»ç»ŸæœåŠ¡æ—¶é€ æˆçš„ä¸­æ–­,ç”±SWIæŒ‡ä»¤é€ æˆå¼‚å¸¸ä»è€Œåˆ‡å…¥ç‰¹æƒæ¨¡å¼,ä»è€Œå…è®¸éç‰¹æƒæ¨¡å¼è®¿é—®ç‰¹æƒæ¨¡å¼çš„å‡½æ•°.</p>
<p>ARMä¸­æœ‰ä¸¤ç§ç³»ç»Ÿè°ƒç”¨æ–¹å¼: OABI(old application binary interface)å’ŒEABI(extended application binary interface).è§(å†…æ ¸æºç arch/arm/kernel/entry-common.Sæ–‡ä»¶).</p>
<p>å¯¹äºOABI: é€šè¿‡è·Ÿéšåœ¨swiæŒ‡ä»¤åçš„è°ƒç”¨å·æ¥è¿›è¡Œ. <code>1101 1111 vvvv vvvv -- SWI immed_8</code> (ThumbæŒ‡ä»¤)æ ¼å¼)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">swi (#num | 0x900000) (0x900000æ˜¯ä¸ªmagicå€¼)</div></pre></td></tr></table></figure></p>
<p>å¯¹äºEABI: è°ƒç”¨å·å­˜æ”¾åœ¨r7ä¸­. <code>1110 1111 0000 0000 -- SWI 0</code> (ThumbæŒ‡ä»¤æ ¼å¼)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mov r7, #num</div><div class="line">swi 0x0</div></pre></td></tr></table></figure></p>
<p>åœ¨ <a href="https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf" target="_blank" rel="external">arm.pdf</a>çš„ <strong>A4.1.107 SWI</strong> å’Œ <strong>A7.1.69 SWI</strong> åˆ†åˆ«æ˜¯å¯¹ARMå’ŒThumbä¸­SWIçš„æè¿°.</p>
<p>æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨å·åœ¨<code>arch/arm/include/asm/unistd.h</code>æ–‡ä»¶.</p>
<p>æ‰€ä»¥åœ¨å¾—åˆ°ä¸€æ¡SWIæŒ‡ä»¤æ—¶,è¦è§£æå‡ºç³»ç»Ÿè°ƒç”¨å·å¾—åˆ†ä¸¤ç§æƒ…å†µ:<br>è¿™é‡Œçš„æºç¨‹åºç›´æ¥æŒ‰ARMæŒ‡ä»¤é›†å¤„ç†äº†,æ²¡æœ‰åšåˆ¤æ–­thumbçš„å¤„ç†.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if(ins == 0xef000000)&#123;      //ç›´æ¥å’ŒæŒ‡ä»¤æ¯”è¾ƒ</div><div class="line">    return regs-&gt;ARM_r7;</div><div class="line">&#125;else&#123;</div><div class="line">    if((ins &amp; 0x0ff00000) != 0x0f900000)&#123;   //å’Œmagicå€¼æ¯”è¾ƒ,è¿™é‡Œæˆ‘è®¤ä¸ºå‰é¢ä¸¤ä½0fæ”¹æˆåˆ«çš„å€¼ä¹Ÿæ˜¯å¯ä»¥çš„,é‡è¦çš„æ˜¯magicå€¼</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line">    return ins &amp;= 0x000fffff;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="æ‹¦æˆªç³»ç»Ÿè°ƒç”¨"><a href="#æ‹¦æˆªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ‹¦æˆªç³»ç»Ÿè°ƒç”¨"></a>æ‹¦æˆªç³»ç»Ÿè°ƒç”¨</h1><p><strong>æ•´ä¸ªæ€è·¯æ˜¯:</strong></p>
<p>ä½¿è¢«è°ƒè¯•ç¨‹åºåœ¨ä¸‹æ¬¡æ¬¡è°ƒç”¨ç³»ç»Ÿå‡½æ•°å‰ååœä¸‹(SYSCALL),è¿™æ—¶è°ƒè¯•ç¨‹åºå¯¹è¢«è°ƒè¯•è¿›è¡Œæ“ä½œ(PTRACE_PEEKTEXT/PTRACE_GETREGSâ€¦),éšåä½¿è¢«è°ƒè¯•ç¨‹åºç»§ç»­è¿è¡Œ(SYSCALL),è°ƒè¯•ç¨‹åºç­‰å¾…(wait).</p>
<p><strong>è¢«è°ƒè¯•ç¨‹åº:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">int count = 0;</div><div class="line">void print()</div><div class="line">&#123;</div><div class="line">	printf(&quot;hello,%d\n&quot;,count);</div><div class="line">        sleep(1);</div><div class="line">&#125;</div><div class="line">int main(int argc, char const *argv[])</div><div class="line">&#123;</div><div class="line">	while(1)&#123;</div><div class="line">		print();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è°ƒè¯•ç¨‹åº:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;  //å¤´æ–‡ä»¶è·¯å¾„æ ¹æ®ndkç›®å½•ä¸‹/platforms/android-21/arch-arm/usr/include</div><div class="line">#include&lt;asm/unistd.h&gt;</div><div class="line">long getSystemCallNumber(int pid, struct pt_regs *regs)</div><div class="line">&#123;</div><div class="line">    long ins = 0;</div><div class="line">    ins = ptrace(PTRACE_PEEKTEXT, pid, (void *)(regs-&gt;ARM_pc - 4), NULL);   //r15-4</div><div class="line">    if(ins == 0)&#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    if(ins == 0xef000000)&#123;      //EABI</div><div class="line">        return regs-&gt;ARM_r7;</div><div class="line">    &#125;else&#123;</div><div class="line">        if((ins &amp; 0x0ff00000) != 0x0f900000)&#123;   //OABI</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        return ins &amp;= 0x000fffff;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void doSthBefore(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;before syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;    //å¾—åˆ°å‚æ•°</div><div class="line">        printf(&quot;__NR_write &lt;&lt; %ld, %p, %ld\n&quot;,regs.ARM_r0, (void*)regs.ARM_r1, regs.ARM_r2);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void doSthAfter(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;after syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;</div><div class="line">        printf(&quot;__NR_write &gt;&gt; %ld\n&quot;,regs.ARM_r0);</div><div class="line">    &#125;</div><div class="line">    printf(&quot;\n&quot;);</div><div class="line">&#125;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(argc != 2)&#123;</div><div class="line">        printf(&quot;usage: %s &lt;pid to be traced&gt;\n&quot;,argv[0]);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    int pid = atoi(argv[1]);</div><div class="line">    if(0 != ptrace(PTRACE_ATTACH, pid, NULL, NULL))&#123;</div><div class="line">        printf(&quot;attach failed.&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    ptrace(PTRACE_SYSCALL, pid, NULL, NULL);    //ä½¿ä¹‹åœ¨ç³»ç»Ÿè°ƒç”¨å‰ååœä¸‹</div><div class="line">    int status;</div><div class="line">    while(1)&#123;</div><div class="line">        wait(&amp;status);</div><div class="line">        doSthBefore(pid);</div><div class="line">        ptrace(PTRACE_SYSCALL, pid, NULL, NULL);</div><div class="line">        wait(&amp;status);</div><div class="line">        doSthAfter(pid);</div><div class="line">        ptrace(PTRACE_SYSCALL, pid, NULL, NULL);</div><div class="line">    &#125;</div><div class="line">    ptrace(PTRACE_DETACH, pid, NULL, NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç»“æœ:</strong></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/19/16/20/25" alt=""></p>
<h1 id="ä¿®æ”¹å‡½æ•°å‚æ•°"><a href="#ä¿®æ”¹å‡½æ•°å‚æ•°" class="headerlink" title="ä¿®æ”¹å‡½æ•°å‚æ•°"></a>ä¿®æ”¹å‡½æ•°å‚æ•°</h1><p>ä¿®æ”¹printfçš„å‚æ•°:å­—ç¬¦ä¸²åŠå…¶é•¿åº¦.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">#define long_size 4</div><div class="line">void readData(int pid, long addr, char *str, int len)</div><div class="line">&#123;</div><div class="line">    int i,j;</div><div class="line">    char *laddr;</div><div class="line">    union u&#123;</div><div class="line">        long val;</div><div class="line">        char chars[long_size];</div><div class="line">    &#125;data;</div><div class="line">    i = 0;</div><div class="line">    j = len / long_size;</div><div class="line">    laddr = str;</div><div class="line">    while (i &lt; j) &#123;</div><div class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr+i*4, NULL);    //PEEKDATAä¸€æ¬¡è¯»ä¸€ä¸ªå­—</div><div class="line">        memcpy(laddr,data.chars,long_size);</div><div class="line">        laddr += long_size;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    j = len % long_size;</div><div class="line">    if (j != 0) &#123;</div><div class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr+i*4, NULL);    //PEEKDATAä¸€æ¬¡è¯»ä¸€ä¸ªå­—</div><div class="line">        memcpy(laddr,data.chars,long_size);</div><div class="line">    &#125;</div><div class="line">    str[len] = &apos;\0&apos;;</div><div class="line">&#125;</div><div class="line">void writeData(int pid, long addr, char *str, int len)</div><div class="line">&#123;</div><div class="line">    int i,j;</div><div class="line">    char *laddr;</div><div class="line">    union u&#123;</div><div class="line">        long val;</div><div class="line">        char chars[long_size];</div><div class="line">    &#125;data;</div><div class="line">    i = 0;</div><div class="line">    j = len / long_size;</div><div class="line">    laddr = str;</div><div class="line">    while (i &lt; j) &#123;</div><div class="line">        memcpy(data.chars,laddr,long_size);</div><div class="line">        ptrace(PTRACE_POKEDATA, pid, addr+i*4, data.val);    //PEEKDATAä¸€æ¬¡å†™ä¸€ä¸ªå­—</div><div class="line">        laddr += long_size;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    j = len % long_size;</div><div class="line">    if (j != 0) &#123;</div><div class="line">        memcpy(data.chars,laddr,j);</div><div class="line">        ptrace(PTRACE_POKEDATA, pid, addr+i*4, data.val);    //POKEDATAä¸€æ¬¡å†™ä¸€ä¸ªå­—</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void strrev(char *p)</div><div class="line">&#123;</div><div class="line">  char *q = p;</div><div class="line">  while(q &amp;&amp; *q) ++q;</div><div class="line">  for(--q; p &lt; q; ++p, --q)</div><div class="line">    *p = *p ^ *q,</div><div class="line">    *q = *p ^ *q,</div><div class="line">    *p = *p ^ *q;</div><div class="line">&#125;</div><div class="line">void modifyString(int pid,long addr,long len)</div><div class="line">&#123;</div><div class="line">    char *str;</div><div class="line">    str = (char*)calloc(sizeof(char)*(len+1),1);</div><div class="line">    readData(pid,addr,str,len);</div><div class="line">    strrev(str);</div><div class="line">    writeData(pid,addr,str,len);</div><div class="line">&#125;</div><div class="line">void doSthBefore(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;before syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;</div><div class="line">        printf(&quot;__NR_write &lt;&lt; %ld, %p, %ld\n&quot;,regs.ARM_r0, (void*)regs.ARM_r1, regs.ARM_r2);</div><div class="line">        modifyString(pid,regs.ARM_r1,regs.ARM_r2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a></p>
<p><a href="http://www.xuebuyuan.com/706076.html" target="_blank" rel="external">Android ptraceç®€ä»‹</a></p>
<p><a href="http://blog.csdn.net/ce123/article/details/6925375" target="_blank" rel="external">æµ…è°ˆEABIå’ŒOABI</a></p>
<p><a href="http://blog.csdn.net/myarrow/article/details/7036266" target="_blank" rel="external">Arm Linuxç³»ç»Ÿè°ƒç”¨æµç¨‹è¯¦ç»†è§£æ-SWI</a></p>
<p><a href="http://bbs.pediy.com/showthread.php?t=196435" target="_blank" rel="external">linux arm ç³»ç»Ÿè°ƒç”¨</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hook </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[åè°ƒè¯•æ–¹æ³•äºŒ - æŠ¢å ptrace]]></title>
      <url>/2015/12/18/ptrace-basis/</url>
      <content type="html"><![CDATA[<blockquote>
<p>The ptrace() system call provides a means by which one process (theâ€tracerâ€) may observe and control the execution of another process(the â€œtraceeâ€), and examine and change the traceeâ€™s memory andregisters.  It is primarily used to implement breakpoint debugging and system call tracing.</p>
</blockquote>
<p>å¸®åŠ©æ–‡æ¡£<a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="external">online</a>.</p>
<a id="more"></a>
<h1 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h1><p><code>ptrace</code>å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹ç›‘è§†å’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œ,å¹¶ä¸”ä¿®æ”¹è¢«ç›‘è§†è¿›ç¨‹çš„å†…å­˜ã€å¯„å­˜å™¨ç­‰,ä¸»è¦åº”ç”¨äºæ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ª.</p>
<p>å‡½æ•°åŸå‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">long ptrace(int request, pid_t pid, void * addr, void * data)</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­,requestä»£è¡¨è¯·æ±‚ç±»å‹,pidä»£è¡¨è¢«è°ƒè¯•è¿›ç¨‹çš„pid.</p>
<blockquote>
<p>ptraceå»ºç«‹è·Ÿè¸ªå…³ç³»çš„ä¸¤ç§æ–¹å¼:</p>
<ol>
<li>fork:<br>åˆ©ç”¨fork+execveæ‰§è¡Œè¢«æµ‹è¯•çš„ç¨‹åºï¼Œå­è¿›ç¨‹åœ¨æ‰§è¡Œexecveä¹‹å‰è°ƒç”¨ptrace(PTRACE_TRACEME)ï¼Œå»ºç«‹äº†ä¸çˆ¶è¿›ç¨‹(debugger)çš„è·Ÿè¸ªå…³ç³»ã€‚</li>
<li>attach: debuggerå¯ä»¥è°ƒç”¨ptrace(PTRACE_ATTACHï¼Œpid,â€¦)ï¼Œå»ºç«‹è‡ªå·±ä¸è¿›ç¨‹å·ä¸ºpidçš„è¿›ç¨‹é—´çš„è·Ÿè¸ªå…³ç³»ã€‚<br>å³åˆ©ç”¨PTRACE_ATTACHï¼Œä½¿è‡ªå·±å˜æˆè¢«è°ƒè¯•ç¨‹åºçš„çˆ¶è¿›ç¨‹(ç”¨pså¯ä»¥çœ‹åˆ°)ã€‚ç”¨attachå»ºç«‹èµ·æ¥çš„è·Ÿè¸ªå…³ç³»ï¼Œå¯ä»¥è°ƒç”¨ptrace(PTRACE_DETACHï¼Œpid,â€¦)æ¥è§£é™¤ã€‚æ³¨æ„attachè¿›ç¨‹æ—¶çš„æƒé™é—®é¢˜ï¼Œå¦‚ä¸€ä¸ªérootæƒé™çš„è¿›ç¨‹æ˜¯ä¸èƒ½attachåˆ°ä¸€ä¸ªrootè¿›ç¨‹ä¸Šçš„ã€‚</li>
</ol>
</blockquote>
<p>æœ‰ä¿¡å·å‘ç”Ÿæ—¶,è¢«è°ƒè¯•è¿›ç¨‹å°±ä¼šæš‚åœä¸‹æ¥,å¹¶ä¸”é€šçŸ¥è°ƒè¯•è¿›ç¨‹.è°ƒè¯•è¿›ç¨‹å¯ä»¥è°ƒç”¨waitpid()è·å¾—è¢«è°ƒè¯•è¿›ç¨‹æš‚åœä½ç½®çš„ç›¸å…³ä¿¡æ¯.<br>åœ¨è¢«è°ƒè¯•è¿›ç¨‹æš‚åœçš„æœŸé—´,è°ƒè¯•è¿›ç¨‹å¯ä»¥å„ç§ptrace requestæ¥å¯¹è¢«è°ƒè¯•è¿›ç¨‹è¿›è¡Œæ“ä½œ,æŸ¥çœ‹ã€ä¿®æ”¹ã€ä½¿ä¹‹ç»§ç»­è¿è¡Œã€å¿½ç•¥è¯¥ä¿¡å·ç”šè‡³å‘é€ä¿¡å·.</p>
<h1 id="éƒ¨åˆ†ptrace-request"><a href="#éƒ¨åˆ†ptrace-request" class="headerlink" title="éƒ¨åˆ†ptrace request"></a>éƒ¨åˆ†ptrace request</h1><h2 id="PTRACE-TRACEME"><a href="#PTRACE-TRACEME" class="headerlink" title="PTRACE_TRACEME"></a>PTRACE_TRACEME</h2><p>å°†å½“å‰è¿›ç¨‹åˆ‡æ¢åˆ°åœæ­¢çŠ¶æ€ã€‚å®ƒé€šå¸¸æ€»æ˜¯ä¸ fork/exec ä¸€èµ·ä½¿ç”¨ã€‚å¯¹äºæ¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒPTRACE_TRACEME åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<h2 id="PTRACE-ATTACH"><a href="#PTRACE-ATTACH" class="headerlink" title="PTRACE_ATTACH"></a>PTRACE_ATTACH</h2><p>æ ¹æ®pidå°†è¢«è°ƒè¯•è¿›ç¨‹é™„åŠ åˆ°è°ƒè¯•è¿›ç¨‹ä¸Š,PTRACE_ATTACHå‘è¢«è°ƒè¯•è¿›ç¨‹å‘é€SIGSTOPä¿¡å·ä½¿ä¹‹åœä¸‹.<br>ä½†æ˜¯åœ¨<code>ptrace(PTRACE_ATTACH,pid,0,0)</code>æ‰§è¡Œå®Œæ¯•æ—¶è¢«è°ƒè¯•è¿›ç¨‹å¯èƒ½è¿˜æ²¡æœ‰æš‚åœ,å¯ä»¥ä½¿ç”¨<code>waitpid()</code>ç­‰å¾…å…¶åœä¸‹.</p>
<h2 id="PTRACE-DETACH"><a href="#PTRACE-DETACH" class="headerlink" title="PTRACE_DETACH"></a>PTRACE_DETACH</h2><p>å°†è¢«è°ƒè¯•è¿›ç¨‹ä¸è°ƒè¯•è¿›ç¨‹åˆ†ç¦»,ä½¿è¢«è°ƒè¯•è¿›ç¨‹æ­£å¸¸è¿è¡Œ.</p>
<h2 id="PTRACE-SYSCALL"><a href="#PTRACE-SYSCALL" class="headerlink" title="PTRACE_SYSCALL"></a>PTRACE_SYSCALL</h2><p>ä½¿è¢«è°ƒè¯•è¿›ç¨‹ç»§ç»­è¿è¡Œ,ä½†æ˜¯åœ¨ä¸‹ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å…¥å£å¤„æˆ–å‡ºå£å¤„åœä¸‹,æˆ–è€…æ˜¯æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤ååœä¸‹.<br>ä¾‹å¦‚,è°ƒè¯•è¿›ç¨‹å¯ä»¥ç›‘è§†è¢«è°ƒè¯•è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨å…¥å£å¤„çš„å‚æ•°,æ¥ç€å†ä½¿ç”¨SYSCALL,ç›‘è§†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼.</p>
<h2 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h2><p>waitå‡½æ•°ä¼šå»¶è¿Ÿçˆ¶è¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°è¢«è°ƒè¯•çš„è¿›ç¨‹åˆ‡æ¢ä¸ºåœæ­¢çŠ¶æ€æˆ–è€…ç»ˆæ­¢ä¸ºæ­¢.</p>
<h1 id="åè°ƒè¯•"><a href="#åè°ƒè¯•" class="headerlink" title="åè°ƒè¯•"></a>åè°ƒè¯•</h1><p>ptraceè¢«å¹¿æ³›ç”¨äºåè°ƒè¯•,å› ä¸ºä¸€ä¸ªè¿›ç¨‹åªèƒ½è¢«ptraceä¸€æ¬¡,å¦‚æœäº‹å…ˆè°ƒç”¨äº†ptraceæ–¹æ³•,é‚£å°±å¯ä»¥é˜²æ­¢åˆ«äººè°ƒè¯•æˆ‘ä»¬çš„ç¨‹åº.</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æµ‹è¯•ç¨‹åº:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    ptrace(PTRACE_TRACEME);</div><div class="line">    while(1)&#123;</div><div class="line">        printf(&quot;Hello Ptrace!\n&quot;);</div><div class="line">        sleep(1);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–è¯‘:<code>gcc -g -o hello-ptrace hello-ptrace.c</code></p>
<p>è¿è¡Œ:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/18/16/07/45" alt=""></p>
<p>å¦å¼€å‘½ä»¤è¡Œè°ƒè¯•:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/18/15/59/52" alt=""></p>
<h2 id="æ£€æµ‹"><a href="#æ£€æµ‹" class="headerlink" title="æ£€æµ‹"></a>æ£€æµ‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(-1 == ptrace(PTRACE_TRACEME))</div><div class="line">    &#123;</div><div class="line">        printf(&quot;Debugger!\n&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    printf(&quot;Hello Ptrace!\n&quot;);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ååè°ƒè¯•"><a href="#ååè°ƒè¯•" class="headerlink" title="ååè°ƒè¯•"></a>ååè°ƒè¯•</h1><p><code>ptrace</code>ç”¨æˆ·æ€æºç (ä½äºbionic/libc/bionic/ptrace.c):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">long ptrace(int request, pid_t pid, void * addr, void * data)</div><div class="line">&#123;</div><div class="line">    switch (request) &#123;</div><div class="line">        case PTRACE_PEEKUSR:</div><div class="line">        case PTRACE_PEEKTEXT:</div><div class="line">        case PTRACE_PEEKDATA:</div><div class="line">        &#123;</div><div class="line">            long word;</div><div class="line">            long ret;</div><div class="line">            ret = __ptrace(request, pid, addr, &amp;word);</div><div class="line">            if (ret == 0) &#123;</div><div class="line">                return word;</div><div class="line">            &#125; else &#123;</div><div class="line">                // __ptrace will set errno for us</div><div class="line">                return -1;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        default:</div><div class="line">             return __ptrace(request, pid, addr, data);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>0è¡¨ç¤ºæˆåŠŸ,-1è¡¨ç¤ºé”™è¯¯.</p>
<ul>
<li><p>å•ä¸ªåº”ç”¨å¯åœ¨ptraceä¸‹æ–­ç‚¹.</p>
</li>
<li><p>å®šåˆ¶ROM,å¯ä»¥å°†ptraceæºä»£ç ä¿®æ”¹ä¸º<code>å¦‚æœæ˜¯è‡ªå·±çš„pidè°ƒç”¨ptrace,è¿”å›-1;å¦åˆ™è¿”å›0</code>.</p>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://www.xuebuyuan.com/706076.html" target="_blank" rel="external">Android ptraceç®€ä»‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> anti-debug </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è„±å£³åŸºç¡€ dvmDexFileOpenPartial]]></title>
      <url>/2015/12/16/unshell-basic/</url>
      <content type="html"><![CDATA[<p>æ —å­<a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/shell-protect-1.apk" target="_blank" rel="external">åœ¨æ­¤</a></p>
<a id="more"></a>
<h1 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h1><p><a href="http://kiya.space/2015/12/11/ida-dynamic-debug-dex/" target="_blank" rel="external">é™„åŠ è¿›ç¨‹</a>å,åœ¨<code>libdvm.so</code>ä¸­çš„<code>dvmDexFileOpenPartial</code>å‡½æ•°ä¸‹æ–­ç‚¹.</p>
<p>dvmDexFileOpenPartialçš„å‡½æ•°åŸå‹ä¸º(ä½äº/dalvik/vm/DvmDex.cpp):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * @addr: ä¼ å…¥å‚æ•°, dexæ–‡ä»¶çš„èµ·å§‹åœ°å€</div><div class="line"> * @len: ä¼ å‡ºå‚æ•°, dexæ–‡ä»¶çš„å¤§å°</div><div class="line"> * @ppDvmDex: ä¼ å‡ºå‚æ•°,æŒ‡å‘ DvmDex ç»“æ„çš„åœ°å€</div><div class="line">*/</div><div class="line">int dvmDexFileOpenPartial(const void* addr, int len, DvmDex** ppDvmDex)</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œåæ–­ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/16/13/39/27" alt=""></p>
<p>å¾—R0ä¸ºaddr,R1ä¸ºlen.</p>
<p>æ‰§è¡Œè„šæœ¬:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/16/13/39/41" alt=""></p>
<p>ç°åœ¨å°±å¯ä»¥ä½¿ç”¨baksmaliå¤„ç†dexæ–‡ä»¶ç»§ç»­åˆ†æäº†.</p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>dalvikè™šæ‹Ÿæœºä¼šæŠŠdexæ–‡ä»¶ä¼˜åŒ–ä¸ºodexæ–‡ä»¶,è€Œä¼˜åŒ–çš„æºä»£ç ä¸º<code>/dalvik/dexopt/OptMain.cpp</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Main entry point.  Decide where to go.</div><div class="line"> */</div><div class="line">int main(int argc, char* const argv[])</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">    if (argc &gt; 1) &#123;</div><div class="line">        if (strcmp(argv[1], &quot;--zip&quot;) == 0)</div><div class="line">            return fromZip(argc, argv);</div><div class="line">        else if (strcmp(argv[1], &quot;--dex&quot;) == 0)</div><div class="line">            return fromDex(argc, argv);</div><div class="line">        else if (strcmp(argv[1], &quot;--preopt&quot;) == 0)</div><div class="line">            return preopt(argc, argv);</div><div class="line">    &#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>fromzip</code>å’Œ<code>preopt</code>éƒ½ä¼šè°ƒç”¨<code>processZipFile</code>å…ˆå°†dexæ–‡ä»¶æå–å‡ºæ¥,<code>fromDex</code>åˆ™ç›´æ¥è°ƒç”¨<code>dvmContinueOptimization</code>ä¼˜åŒ–.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Common functionality for normal device-side processing as well as</div><div class="line"> * preoptimization.</div><div class="line"> */</div><div class="line">static int processZipFile(int zipFd, int cacheFd, const char* zipName,</div><div class="line">        const char *dexoptFlags)</div><div class="line">&#123;</div><div class="line">   	...</div><div class="line">    int result = extractAndProcessZip(zipFd, cacheFd, zipName, isBootstrap,</div><div class="line">            bcp, dexoptFlags);</div><div class="line">    free(bcpCopy);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>extractAndProcessZip</code>ä¸­å¤„ç†zipæ–‡ä»¶å¹¶å°†dexæå–å‡ºæ¥,éšåè°ƒç”¨ä¼˜åŒ–å‡½æ•°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Extract &quot;classes.dex&quot; from zipFd into &quot;cacheFd&quot;, leaving a little space</div><div class="line"> * up front for the DEX optimization header.</div><div class="line"> */</div><div class="line">static int extractAndProcessZip(int zipFd, int cacheFd,</div><div class="line">    const char* debugFileName, bool isBootstrap, const char* bootClassPath,</div><div class="line">    const char* dexoptFlagStr)</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">    /*</div><div class="line">     * Open the zip archive, find the DEX entry.</div><div class="line">     */</div><div class="line">    if (dexZipPrepArchive(zipFd, debugFileName, &amp;zippy) != 0) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: unable to open zip archive &apos;%s&apos;&quot;, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    zipEntry = dexZipFindEntry(&amp;zippy, kClassesDex);</div><div class="line">    if (zipEntry == NULL) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: zip archive &apos;%s&apos; does not include %s&quot;,</div><div class="line">            debugFileName, kClassesDex);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    /*</div><div class="line">     * Extract some info about the zip entry.</div><div class="line">     */</div><div class="line">    if (dexZipGetEntryInfo(&amp;zippy, zipEntry, NULL, &amp;uncompLen, NULL, NULL,</div><div class="line">            &amp;modWhen, &amp;crc32) != 0)</div><div class="line">    &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: zip archive GetEntryInfo failed on %s&quot;, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    uncompLen = uncompLen;</div><div class="line">    modWhen = modWhen;</div><div class="line">    crc32 = crc32;</div><div class="line">    /*</div><div class="line">     * Extract the DEX data into the cache file at the current offset.</div><div class="line">     */</div><div class="line">    if (dexZipExtractEntryToFile(&amp;zippy, zipEntry, cacheFd) != 0) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: extraction of %s from %s failed&quot;,</div><div class="line">            kClassesDex, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">   	...</div><div class="line">    /*</div><div class="line">     * Prep the VM and perform the optimization.</div><div class="line">     */</div><div class="line">    if (dvmPrepForDexOpt(bootClassPath, dexOptMode, verifyMode,</div><div class="line">            dexoptFlags) != 0)</div><div class="line">    &#123;</div><div class="line">        ALOGE(&quot;DexOptZ: VM init failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    //vmStarted = 1;</div><div class="line">    /* do the optimization */</div><div class="line">    if (!dvmContinueOptimization(cacheFd, dexOffset, uncompLen, debugFileName,</div><div class="line">            modWhen, crc32, isBootstrap))</div><div class="line">    &#123;</div><div class="line">        ALOGE(&quot;Optimization failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>dvmContinueOptimization</code>å‡½æ•°ä½äº/dalvik/vm/analysis/DexPrepare.cppæ–‡ä»¶,å…¶ä¸­è°ƒç”¨äº†<code>dvmDexFileOpenPartial</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Do the actual optimization.  This is executed in the dexopt process.</div><div class="line"> *</div><div class="line"> * For best use of disk/memory, we want to extract once and perform</div><div class="line"> * optimizations in place.  If the file has to expand or contract</div><div class="line"> * to match local structure padding/alignment expectations, we want</div><div class="line"> * to do the rewrite as part of the extract, rather than extracting</div><div class="line"> * into a temp file and slurping it back out.  (The structure alignment</div><div class="line"> * is currently correct for all platforms, and this isn&apos;t expected to</div><div class="line"> * change, so we should be okay with having it already extracted.)</div><div class="line"> *</div><div class="line"> * Returns &quot;true&quot; on success.</div><div class="line"> */</div><div class="line">bool dvmContinueOptimization(int fd, off_t dexOffset, long dexLength,</div><div class="line">    const char* fileName, u4 modWhen, u4 crc, bool isBootstrap)</div><div class="line">&#123;</div><div class="line">   ...</div><div class="line">		success = rewriteDex(((u1*) mapAddr) + dexOffset, dexLength,</div><div class="line">                    doVerify, doOpt, &amp;pClassLookup, NULL);</div><div class="line">        if (success) &#123;</div><div class="line">            DvmDex* pDvmDex = NULL;</div><div class="line">            u1* dexAddr = ((u1*) mapAddr) + dexOffset;</div><div class="line">            if (dvmDexFileOpenPartial(dexAddr, dexLength, &amp;pDvmDex) != 0) &#123;</div><div class="line">                ALOGE(&quot;Unable to create DexFile&quot;);</div><div class="line">                success = false;</div><div class="line">            &#125; else &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>dvmDexFileOpenPartial</code>è°ƒç”¨äº†<code>dexFileParse</code>,ç”¨æ¥è§£æå†…å­˜ä¸­ä¼˜åŒ–è¿‡æˆ–æœªä¼˜åŒ–è¿‡çš„dexæ–‡ä»¶,è¿”å›dexFileç»“æ„.<br>æ‰€ä»¥æ­¤æ—¶dexæ–‡ä»¶å·²ç»è¢«åŠ è½½è¿›å†…å­˜,å°±å¯ä»¥dumpå‡ºæ¥äº†.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Create a DexFile structure for a &quot;partial&quot; DEX.  This is one that is in</div><div class="line"> * the process of being optimized.  The optimization header isn&apos;t finished</div><div class="line"> * and we won&apos;t have any of the auxillary data tables, so we have to do</div><div class="line"> * the initialization slightly differently.</div><div class="line"> *</div><div class="line"> * Returns nonzero on error.</div><div class="line"> */</div><div class="line">int dvmDexFileOpenPartial(const void* addr, int len, DvmDex** ppDvmDex)</div><div class="line">&#123;</div><div class="line">    DvmDex* pDvmDex;</div><div class="line">    DexFile* pDexFile;</div><div class="line">    int parseFlags = kDexParseDefault;</div><div class="line">    int result = -1;</div><div class="line">    /* -- file is incomplete, new checksum has not yet been calculated</div><div class="line">    if (gDvm.verifyDexChecksum)</div><div class="line">        parseFlags |= kDexParseVerifyChecksum;</div><div class="line">    */</div><div class="line">    pDexFile = dexFileParse((u1*)addr, len, parseFlags);</div><div class="line">    if (pDexFile == NULL) &#123;</div><div class="line">        ALOGE(&quot;DEX parse failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> MSC </tag>
            
            <tag> enforce </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[åè°ƒè¯•æ–¹æ³•ä¸€ - è¯»å–è¿›ç¨‹statusæ–‡ä»¶]]></title>
      <url>/2015/12/14/android-anti-debug-read-status/</url>
      <content type="html"><![CDATA[<p>æ —å­:<a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/AliCrackme_2.apk" target="_blank" rel="external">é˜¿é‡Œç§»åŠ¨å®‰å…¨æŒ‘æˆ˜èµ›ç¬¬äºŒé¢˜</a></p>
<a id="more"></a>
<blockquote>
<p>æœ¬æ —åè°ƒè¯•æ–¹æ³•:<br>ç”¨fopenæ‰“å¼€<code>/proc/&lt;pid&gt;/status</code>æ–‡ä»¶è¯»å–å…¶ä¸­çš„<code>TracerPid</code>å€¼æ¥æ£€æµ‹è‡ªå·±çš„è¿›ç¨‹æ˜¯å¦è¢«attachï¼Œ<br>TracerPidå¦‚æœä¸º0è¯´æ˜æ²¡æœ‰åˆ«çš„è¿›ç¨‹åœ¨è°ƒè¯•è¿™ä¸ªè¿›ç¨‹ï¼Œå¦‚æœä¸ä¸º0è¯´æ˜æœ‰ç¨‹åºåœ¨è°ƒè¯•ã€‚</p>
</blockquote>
<p>ä½¿ç”¨idaé™„åŠ è¿›ç¨‹,å…³é”®å‡½æ•°ä¸‹æ–­ç‚¹F9ä¹‹å,è¿›ç¨‹é€€å‡º,idaé€€å‡º.<br>è°ƒè¯•è¿‡åå‘ç°JNI_OnLoadä¸­æœ‰åè°ƒè¯•æ–¹æ³•(å®é™…ä¸Šæ˜¯å‰è¾ˆçš„ç»“è®º :p).</p>
<p>æ ¹æ®<a href="http://kiya.space/2015/12/11/ida-dynamic-debug-so/" target="_blank" rel="external">ä½¿ç”¨idaè°ƒè¯•soæ–‡ä»¶</a>çš„æ­¥éª¤åœ¨<code>library load</code>å¤„æ–­ä¸‹.</p>
<h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p>æ‰“å¼€Debugger windows -&gt; Module list,æ‰¾åˆ°<code>/data/app-lib/com.yaotong.crackme-1/libcrackme.so</code>,ä¸ºå…¶ä¸­çš„JNI_OnLoadæ–¹æ³•å³é”®<code>Add breakpoint</code>.è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°libcrackme.soçš„åŸºå€ä¸º0x520AE000.<br>(å½“ç„¶å¦‚æœåè°ƒè¯•æ–¹æ³•æ˜¯åœ¨.initarrayä¸­,å…¶åœ°å€éœ€è¦æ‰‹åŠ¨è®¡ç®—.)</p>
<p>ä¸€æ­¥ä¸€æ­¥F8å‘ç°åœ¨æ‰§è¡Œè¿™ä¸€å¥ä¹‹åç¨‹åºé€€å‡º.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/14/22" alt=""></p>
<p>F7è¿›å»,å‘ç°æ˜¯<code>pthread_create</code>å‡½æ•°.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/14/57" alt=""></p>
<p>æ‰€ä»¥ä¸Šä¸Šå›¾ä¸­çš„<code>unk_520AF6A4</code>å‡½æ•°å°±æ˜¯çº¿ç¨‹å›è°ƒå‡½æ•°å’¯.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/15/23" alt=""></p>
<p>å…ˆä¸å»åˆ†æ(å…¶å®æ˜¯æ°´å¹³è¾¾ä¸åˆ° :( ),æ‰€ä»¥æˆ‘ä»¬è¦ç”¨å®ˆæ ªå¾…å…”çš„æ–¹æ³•.<br>åœ¨module listä¸­æ‰¾åˆ°<code>libc.so</code>,åœ¨fopenå‡½æ•°ä¸‹æ–­ç‚¹,ä»¥æ­¤æ£€éªŒç¨‹åºæ˜¯å¦æ‰“å¼€äº†æŸäº›æ–‡ä»¶æ£€æµ‹çŠ¶æ€å€¼.<br>åŒæ—¶æ‰“å¼€ä¸€ä¸ªhex view(View -&gt; Open subviews -&gt; Hex dump),è®¾ç½®æ•°æ®ä¸R0åŒæ­¥.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/15/46" alt=""></p>
<p>F9è¿è¡Œåˆ°fopenå‡½æ•°å¤„(æœ‰æ—¶å¹¶ä¸èƒ½ä¸€æ¬¡å°±æ–­åœ¨fopen,æ³¨æ„çœ‹æ³¨é‡Š).</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/06" alt=""></p>
<p>æ‰€ä»¥ç¨‹åºç¡®å®æ˜¯è¯»å–äº†statusæ–‡ä»¶. :P<br>è¿™æ˜¯éœ€è¦æ‰¾åˆ°æ˜¯è°è°ƒç”¨äº†fopenå‡½æ•°,ç„¶åä¿®æ”¹è¯»å–statusçš„è¿”å›å€¼ä¸º0(ä¸ç„¶å°±éœ²é¦…äº†).<br>ä¸€ç›´æ‘F8ç›´åˆ°fopenå‡½æ•°è¿”å›,äºæ˜¯æˆ‘ä»¬æ¥åˆ°äº†è¿™é‡Œ.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/21" alt=""></p>
<p>ä¸€è¾¹æ˜¯æ•°æ®ä¸€è¾¹æ˜¯ä»£ç ,å®Œå…¨æ‰¾ä¸åˆ°å‡½æ•°å¼€å§‹çš„åœ°æ–¹å“‡.<br>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ­¤å¤„åœ°å€ä¸º<code>520AF420</code>,å‡å»æˆ‘ä»¬ä¹‹å‰è®°ä¸‹çš„libcrackme.soçš„åŸºå€520AE000,å¾—åˆ°ç›¸å¯¹åœ°å€ä¸º<code>1420</code><br>å¦å¼€ä¸€ä¸ªida,æ‘Gé”®è·³è‡³æ­¤åœ°å€,F5å‘ç°æ˜¯å‡½æ•°<code>sub_130c</code>.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/38" alt=""></p>
<p>å°†<code>sub_130c</code>çš„æ–‡ä»¶åç§»è½¬æ¢ä¸ºç»å¯¹åœ°å€:130c+520AE000=520AF30C.<br>pé”®å°†æ­¤å¤„æ•°æ®è§†ä¸ºä»£ç å˜æˆè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/02" alt=""></p>
<p>ç¨‹åºéšåä¼šç”¨fgets()å’Œstrstr()æ¥è·å–TracerIdçš„å€¼ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨strstr()å¤„ä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åè®©hex viewçš„æ•°æ®ä¸R0åŒæ­¥.<br>ä¸€ç›´F9,ç›´åˆ°R0çš„å€¼å˜ä¸ºè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/31" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/48" alt=""></p>
<p>F2ä¿®æ”¹ä¸ºè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/22/34" alt=""></p>
<p>ä½†æ˜¯è¿‡ä¸€ä¼šç¨‹åºåˆè¦è·å–,æˆ‘ä»¬å¾—ä¸€ç›´ä¸åœçš„æ”¹,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™æ®µä»£ç nopæ‰,ä¸–ç•Œæ‰å®‰é™.</p>
<h1 id="patch-so"><a href="#patch-so" class="headerlink" title="patch so"></a>patch so</h1><p>å¦‚æœé™æ€åˆ†ææ—¶æ‰¾åˆ°JNI_OnLoadä¸­å…³é”®çš„é‚£å¥ä»£ç :</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/59" alt=""></p>
<p>è¿›å…¥çº¿ç¨‹çš„å›è°ƒå‡½æ•°,å‘ç°ç«Ÿç„¶æ˜¯è¿™æ ·å­çš„!</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/15" alt=""></p>
<p>å›è°ƒå‡½æ•°<code>sub_16a4</code>ä¸­è°ƒç”¨äº†<code>sub_130c</code>!<br>è·Ÿæˆ‘ä»¬åœ¨åŠ¨æ€è°ƒè¯•æ—¶çœ‹åˆ°çš„å®Œå…¨ä¸ä¸€æ ·å˜›.<br>ç°åœ¨å°†å›è°ƒå‡½æ•°ä¸­çš„è¿™ä¸€å¥nopæ‰å°±å¥½äº†å‘—.<br>å³é”®é€‰æ‹©<code>copy to assembly</code></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/31" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/48" alt=""></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯<code>BL sub_130C</code>. armä¸­æ²¡æœ‰nopè¯­å¥,æ‰€ä»¥å°†<code>movs r0,r0</code>ä½œä¸ºNOP,å¯¹åº”çš„æœºå™¨ç ä¸º<code>00 00 A0 E1</code>.</p>
<p>å³é”®è¿›å…¥hex view.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/02" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/17" alt=""></p>
<p>æ‘F2å°†<code>13 FF FF EB</code>æ”¹ä¸º<code>00 00 A0 E1</code>,å†æ‘F2åº”ç”¨.<br>ç‚¹å‡»<code>Edit -&gt; Patch program -&gt; Apply patches to input file...</code>ä¿å­˜å³å¯.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/34" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/20/31" alt=""></p>
<p>å°†åŸapkä¸­çš„soæ–‡ä»¶æ›¿æ¢ä¸ºæ­¤soæ–‡ä»¶,é‡æ–°æ‰“åŒ…ç­¾åå®‰è£…,ç°åœ¨ç›´æ¥æ‰“å¼€appè°ƒè¯•å°±ä¸ä¼šé€€å‡ºäº†. Success!</p>
<hr>
<h1 id="ç•ªå¤–"><a href="#ç•ªå¤–" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><p>idaä¸­æŒ‰ä¸‰ä¸‹Dï¼Œå°†æ•°æ®æ ¼å¼ä»å­—ç¬¦è½¬åŒ–ä¸ºæŒ‡é’ˆå½¢å¼.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/6840" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹å­”é›€ç¿ â€“ Ida Pro</a></p>
]]></content>
      
        <categories>
            
            <category> Android Security </category>
            
        </categories>
        
        
        <tags>
            
            <tag> anti-debug </tag>
            
            <tag> MSC </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨idaè°ƒè¯•soæ–‡ä»¶]]></title>
      <url>/2015/12/11/ida-dynamic-debug-so/</url>
      <content type="html"><![CDATA[<p>ä¿æŠ¤ä»£ç é€šå¸¸æ”¾åœ¨soæ–‡ä»¶ä¸­.</p>
<a id="more"></a>
<h1 id="æ­£å¸¸çš„åº”ç”¨"><a href="#æ­£å¸¸çš„åº”ç”¨" class="headerlink" title="æ­£å¸¸çš„åº”ç”¨"></a>æ­£å¸¸çš„åº”ç”¨</h1><h2 id="androidæœºçš„å‡†å¤‡å·¥ä½œ"><a href="#androidæœºçš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="androidæœºçš„å‡†å¤‡å·¥ä½œ"></a>androidæœºçš„å‡†å¤‡å·¥ä½œ</h2><p>æ‰¾åˆ°<code>ida</code>ç›®å½•ä¸‹çš„<code>/dbgsrv/android_server</code>æ–‡ä»¶,pushè¿›androidæœº,å¯åŠ¨<code>android_server</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">adb push android_server /data/local/tmp/</div><div class="line">adb shell</div><div class="line">su</div><div class="line">cd data/local/tmp</div><div class="line">chmod 755 android_server</div><div class="line">./android_server</div></pre></td></tr></table></figure>
<p>å‡ºç°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@android:/data/local/tmp # ./android_server</div><div class="line">IDA Android 32-bit remote debug server(ST) v1.19. Hex-Rays (c) 2004-2015</div><div class="line">Listening on port #23946...</div></pre></td></tr></table></figure>
<p>å¦å¼€å‘½ä»¤è¡Œè¿›è¡Œtcpç«¯å£è½¬å‘ï¼š<br><code>adb forward tcp:23946 tcp:23946</code></p>
<p>[<strong>æ³¨æ„äº‹é¡¹</strong>]</p>
<ol>
<li>æ­¤android_serveréœ€å’Œidaæ˜¯é…å¥—çš„</li>
<li>å‡ºç°<code>bind: Address already in use</code>é”™è¯¯<br>è¿™æ˜¯å› ä¸ºæ‰‹æœºä¸­å¯èƒ½å·²ç»åœ¨è¿è¡Œandroid_server,ä½¿ç”¨<code>ps | grep android_server</code>çœ‹ä¸€ä¸‹,æœ‰çš„è¯æ€æ‰.<br>å¦‚ä¸‹:(14061æ˜¯pid)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@android:/ # ps | grep android_server</div><div class="line">root      14061 13574 11180  9504  ffffffff 40183da0 S /data/local/tmp/android_server</div><div class="line">127|root@android:/ # kill -s 9 14061</div></pre></td></tr></table></figure>
<h2 id="ida-çš„å‡†å¤‡"><a href="#ida-çš„å‡†å¤‡" class="headerlink" title="ida çš„å‡†å¤‡"></a>ida çš„å‡†å¤‡</h2><p>æ‰“å¼€idaï¼Œæ‰“å¼€soæ–‡ä»¶,è®°å½•soæ–‡ä»¶ä¸­æ„Ÿå…´è¶£çš„å‡½æ•°çš„æ–‡ä»¶åç§».</p>
<p>æ‰‹æœºæ‰“å¼€app.</p>
<p>å¦å¼€ä¸€ä¸ªida,èœå•æ è®¾ç½®<code>Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</code>å¦‚ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/46/45" alt=""></p>
<p>ç‚¹å‡»ok,å¼¹å‡ºè¿›ç¨‹åˆ—è¡¨,ä¾‹å¦‚:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/49/17" alt=""></p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>å¦‚æœæ­¤æ—¶è¿›ç¨‹åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸¤ä¸ªè¿›ç¨‹,å¯èƒ½æ˜¯å› ä¸ºä¸Šä¸€æ­¥å¯åŠ¨<code>android_server</code>æ—¶ä½ ä½¿ç”¨äº†è¿™æ ·çš„å‘½ä»¤:<br><code>adb shell /data/local/tmp/android_server</code><br>åªè¦å…ˆè¿›å…¥<code>adb shell</code>å†æ‰§è¡Œå°±æ²¡é—®é¢˜äº†.</p>
</blockquote>
<p>é€‰æ‹©è¦è°ƒè¯•çš„è¿›ç¨‹,ç­‰å¾…åˆ†æå®Œæ¯•.</p>
<p><code>ctrl+s</code>æ‰“å¼€segmentåˆ—è¡¨,æ‰¾åˆ°è¦è°ƒè¯•çš„soæ–‡ä»¶,é€‰æ‹©classå±æ€§ä¸ºCODEçš„é‚£ä¸ªå°±okäº†.è®°å¾—è®°ä¸‹soçš„åŸºå€(startå±æ€§).<br>åŸºå€åŠ ä¸Šåˆšåˆšè®°å½•çš„å‡½æ•°çš„æ–‡ä»¶åç§»å³å¾—å‡½æ•°çš„åœ°å€,æŒ‰å¿«æ·é”®Gè¾“å…¥åœ°å€è·³è½¬,ä¸‹æ–­ç‚¹è¿è¡Œå³å¯.</p>
<h1 id="ä¸æ­£å¸¸çš„åº”ç”¨"><a href="#ä¸æ­£å¸¸çš„åº”ç”¨" class="headerlink" title="ä¸æ­£å¸¸çš„åº”ç”¨"></a>ä¸æ­£å¸¸çš„åº”ç”¨</h1><p>(æ­¤æ­¥éª¤ä¹Ÿé€‚ç”¨äºç»™ç³»ç»Ÿå‡½æ•°ä¸‹æ–­ç‚¹)<br>soæ–‡ä»¶åœ¨è¢«åŠ è½½çš„æ—¶å€™ä¼šé¦–å…ˆæ‰§è¡Œ.init_arrayä¸­çš„å‡½æ•°ï¼Œç„¶åå†æ‰§è¡ŒJNI_OnLoad()å‡½æ•°ã€‚å¦‚æœåœ¨è¿™ä¸­é—´åŠ äº†åè°ƒè¯•ä»£ç ,é‚£ä¹ˆæˆ‘ä»¬ä¸€æ—¦å¼€å§‹è°ƒè¯•appå¯èƒ½å°±ä¼šé€€å‡º.æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨soæ–‡ä»¶è¢«åŠ è½½ä¹‹å‰å°±æ–­ä¸‹æ¥.</p>
<h2 id="å¯åŠ¨app"><a href="#å¯åŠ¨app" class="headerlink" title="å¯åŠ¨app"></a>å¯åŠ¨app</h2><p>ä½¿ç”¨am startå‘½ä»¤å¯åŠ¨app:<br><code>adb shell am start -D -n com.yaotong.crackme/com.yaotong.crackme.MainActivity</code><br><strong>com.yaotong.crackme</strong> ä¸ºåŒ…å,<strong>com.yaotong.crackme.MainActivity</strong> ä¸ºä¸»activityå.</p>
<p>æ­¤æ—¶æ‰‹æœºä¸Šä¼šå¼¹å‡º:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/12/13/35/08" alt=""></p>
<h2 id="idaå‡†å¤‡"><a href="#idaå‡†å¤‡" class="headerlink" title="idaå‡†å¤‡"></a>idaå‡†å¤‡</h2><p>åŒæ ·æ˜¯è®¾ç½®<code>Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</code>å†é€‰æ‹©è¿›ç¨‹.<br>ä¹‹åéœ€è¦è®¾ç½®è°ƒè¯•å™¨è°ƒè¯•é€‰é¡¹ä¸º:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/12/13/35/31" alt=""></p>
<p>F9è¿è¡Œ.<br>åœ¨æ§åˆ¶å°ä½¿ç”¨jdbæ¢å¤è¿›ç¨‹è¿è¡Œ:<br><code>jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</code></p>
<p>æ­£å¸¸æƒ…å†µä¼šå‡ºç°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">è®¾ç½®æœªæ•è·çš„java.lang.Throwable</div><div class="line">è®¾ç½®å»¶è¿Ÿçš„æœªæ•è·çš„java.lang.Throwable</div><div class="line">æ­£åœ¨åˆå§‹åŒ–jdb...</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">java.net.ConnectException: Connection refused: connect</div><div class="line">        at java.net.DualStackPlainSocketImpl.connect0(Native Method)</div><div class="line">        at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:79)</div><div class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:345)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:172)</div><div class="line">        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">        at java.net.Socket.connect(Socket.java:589)</div><div class="line">        at com.sun.tools.jdi.SocketTransportService.attach(SocketTransportService.java:222)</div><div class="line">        at com.sun.tools.jdi.GenericAttachingConnector.attach(GenericAttachingConnector.java:116)</div><div class="line">        at com.sun.tools.jdi.SocketAttachingConnector.attach(SocketAttachingConnector.java:90)</div><div class="line">        at com.sun.tools.example.debug.tty.VMConnection.attachTarget(VMConnection.java:519)</div><div class="line">        at com.sun.tools.example.debug.tty.VMConnection.open(VMConnection.java:328)</div><div class="line">        at com.sun.tools.example.debug.tty.Env.init(Env.java:63)</div><div class="line">        at com.sun.tools.example.debug.tty.TTY.main(TTY.java:1066)</div><div class="line">è‡´å‘½é”™è¯¯:</div><div class="line">æ— æ³•é™„åŠ åˆ°ç›®æ ‡ VMã€‚</div></pre></td></tr></table></figure>
<ul>
<li>æ‰“å¼€ddmså°è¯•.</li>
<li>æ£€æŸ¥è°ƒè¯•çš„appé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦æœ‰<code>android:debuggable=&quot;true&quot;</code>ï¼Œå¯¼è‡´ä¸èƒ½è°ƒè¯•ã€‚<br>è‹¥æ— åˆ™åœ¨æ¸…å•æ–‡ä»¶çš„applicationä¸­åŠ ä¸Š,é‡æ–°æ‰“åŒ…å³å¯.</li>
</ul>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨.initarrayå’ŒJNI_OnLoadä¸‹æ–­ç‚¹äº†.</p>
<hr>
<blockquote>
<p>ç•ªå¤–</p>
</blockquote>
<h1 id="initarray"><a href="#initarray" class="headerlink" title=".initarray"></a>.initarray</h1><p>é™æ€åˆ†æsoæ–‡ä»¶æ—¶,æŒ‰<code>ctrl+s</code>å‡ºç°segmentåˆ—è¡¨,è¿›å…¥<code>.initarray</code>å³å¯çœ‹åˆ°åˆ—è¡¨.</p>
<h1 id="å¦‚ä½•dump-soæ–‡ä»¶"><a href="#å¦‚ä½•dump-soæ–‡ä»¶" class="headerlink" title="å¦‚ä½•dump soæ–‡ä»¶"></a>å¦‚ä½•dump soæ–‡ä»¶</h1><p>dumpæ—¶åŠ¡å¿…ç¡®ä¿soæ–‡ä»¶å·²ç»åŠ è½½.<br>pythonè„šæœ¬:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import idaapi</div><div class="line">data = idaapi.dbg_read_memory(start_addr,file_len)</div><div class="line">f = open(r&apos;C:\Users\...\Desktop\dump.so&apos;,&apos;wb&apos;)</div><div class="line">f.write(data)</div><div class="line">f.close()</div></pre></td></tr></table></figure>
<p>idaçš„apiå‡½æ•°åœ°å€:<a href="https://www.hex-rays.com/products/ida/support/idapython_docs/idaapi-module.html" target="_blank" rel="external">https://www.hex-rays.com/products/ida/support/idapython_docs/idaapi-module.html</a></p>
<p>ä»¥ä¸Š.</p>
]]></content>
      
        <categories>
            
            <category> é€†å‘ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> MSC </tag>
            
            <tag> debug </tag>
            
            <tag> ida </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨idaè°ƒè¯•dexæ–‡ä»¶]]></title>
      <url>/2015/12/11/ida-dynamic-debug-dex/</url>
      <content type="html"><![CDATA[<h2 id="åç¼–è¯‘apkæ–‡ä»¶"><a href="#åç¼–è¯‘apkæ–‡ä»¶" class="headerlink" title="åç¼–è¯‘apkæ–‡ä»¶"></a>åç¼–è¯‘apkæ–‡ä»¶</h2><a id="more"></a>
<h2 id="dexæ–‡ä»¶æ‹–å…¥ida-ç­‰å¾…åˆ†æå®Œæ¯•"><a href="#dexæ–‡ä»¶æ‹–å…¥ida-ç­‰å¾…åˆ†æå®Œæ¯•" class="headerlink" title="dexæ–‡ä»¶æ‹–å…¥ida,ç­‰å¾…åˆ†æå®Œæ¯•"></a>dexæ–‡ä»¶æ‹–å…¥ida,ç­‰å¾…åˆ†æå®Œæ¯•</h2><h2 id="è®¾ç½®è°ƒè¯•é€‰é¡¹"><a href="#è®¾ç½®è°ƒè¯•é€‰é¡¹" class="headerlink" title="è®¾ç½®è°ƒè¯•é€‰é¡¹"></a>è®¾ç½®è°ƒè¯•é€‰é¡¹</h2><h3 id="èœå•æ -Debugger-gt-Debugger-optionsâ€¦"><a href="#èœå•æ -Debugger-gt-Debugger-optionsâ€¦" class="headerlink" title="èœå•æ  Debugger -&gt; Debugger optionsâ€¦"></a>èœå•æ  Debugger -&gt; Debugger optionsâ€¦</h3><p>å‹¾é€‰å¦‚ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/22/02" alt=""></p>
<p>ç‚¹å‡»<code>Set specific options</code>,å¡«å…¥åŒ…åå’Œå¯åŠ¨activity:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/23/22" alt=""></p>
<p>åŒ…åå’Œä¸»activityååœ¨<code>Androidmanifest.xml</code>æ–‡ä»¶ä¸­.</p>
<h3 id="èœå•æ -Debugger-gt-Process-options"><a href="#èœå•æ -Debugger-gt-Process-options" class="headerlink" title="èœå•æ  Debugger -&gt; Process options"></a>èœå•æ  Debugger -&gt; Process options</h3><p>ä¿®æ”¹ç«¯å£ä¸º8700</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/25/01" alt=""></p>
<p>8700åœ¨<code>ddms</code>ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/26/05" alt=""></p>
<h2 id="æ ¹æ®éœ€è¦ä¸‹æ–­ç‚¹"><a href="#æ ¹æ®éœ€è¦ä¸‹æ–­ç‚¹" class="headerlink" title="æ ¹æ®éœ€è¦ä¸‹æ–­ç‚¹"></a>æ ¹æ®éœ€è¦ä¸‹æ–­ç‚¹</h2><h2 id="ç‚¹ç»¿è‰²ä¸‰è§’ï¼Œå¯åŠ¨è°ƒè¯•"><a href="#ç‚¹ç»¿è‰²ä¸‰è§’ï¼Œå¯åŠ¨è°ƒè¯•" class="headerlink" title="ç‚¹ç»¿è‰²ä¸‰è§’ï¼Œå¯åŠ¨è°ƒè¯•"></a>ç‚¹ç»¿è‰²ä¸‰è§’ï¼Œå¯åŠ¨è°ƒè¯•</h2><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/28/39" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/29/06" alt=""></p>
<p>è¿™æ—¶å€™å¯èƒ½å‡ºç°é”™è¯¯ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/27/46" alt=""></p>
<p>è¿™æ˜¯å› ä¸º8700ç«¯å£å’Œ<code>monitor</code>çš„å†²çªäº†,å…³æ‰<code>ddms</code>å³å¯.</p>
<p>å¯èƒ½å‡ºç°:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/16/13/38/13" alt=""></p>
<p>è¿™æ˜¯å› ä¸º<code>AndroidManifest.xml</code>ä¸­æ²¡æœ‰<code>android:debuggable=&quot;true&quot;</code>é€‰é¡¹,åŠ ä¸Šé‡æ–°ç¼–è¯‘å³å¯.</p>
<h2 id="è§¦å‘æ–­ç‚¹"><a href="#è§¦å‘æ–­ç‚¹" class="headerlink" title="è§¦å‘æ–­ç‚¹"></a>è§¦å‘æ–­ç‚¹</h2><p>åœ¨appä¸Šæ“ä½œä»¥è§¦å‘æ–­ç‚¹,æ–­ä¸‹ä¹‹åå‹¾é€‰èœå•æ ä¸­ <strong>Debugger -&gt; Use source-level debugging</strong>.</p>
<p>è¿™æ—¶å€™å°±å¯ä»¥å¼€å§‹è°ƒè¯•å’¯ã€‚</p>
]]></content>
      
        <categories>
            
            <category> é€†å‘ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> debug </tag>
            
            <tag> ida </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[armæŒ‡ä»¤ç»ƒä¹ ç¯‡ç« ä¸€]]></title>
      <url>/2015/12/07/arm-instruction-exercises-1/</url>
      <content type="html"><![CDATA[<p><strong>å£å·</strong>:ä¸ºäº†ç†Ÿæ‚‰armæŒ‡ä»¤è€Œå¥‹æ–—!</p>
<a id="more"></a>
<h1 id="for"><a href="#for" class="headerlink" title="for"></a>for</h1><h2 id="C-code"><a href="#C-code" class="headerlink" title="C code"></a>C code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">int test_for()</div><div class="line">&#123;</div><div class="line">    int i,sum = 0;</div><div class="line">    for(i = 0; i &lt; 100; i++)</div><div class="line">        sum += i;</div><div class="line">    return sum;</div><div class="line">&#125;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    printf(&quot;sum:%d\n&quot;,test_for());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="arm-code"><a href="#arm-code" class="headerlink" title="arm code"></a>arm code</h2><h3 id="mainå‡½æ•°"><a href="#mainå‡½æ•°" class="headerlink" title="mainå‡½æ•°"></a>mainå‡½æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">00008370 &lt;main&gt;:</div><div class="line">    8370:	e92d4800 	push	&#123;fp, lr&#125;</div><div class="line">    8374:	e28db004 	add	fp, sp, #4</div><div class="line">    8378:	e24dd008 	sub	sp, sp, #8</div><div class="line">    837c:	e50b0008 	str	r0, [fp, #-8]</div><div class="line">    8380:	e50b100c 	str	r1, [fp, #-12]</div><div class="line">    8384:	ebffffe2 	bl	8314 &lt;test_for&gt;</div><div class="line">    8388:	e1a02000 	mov	r2, r0</div><div class="line">    838c:	e59f3018 	ldr	r3, [pc, #24]	; 83ac &lt;main+0x3c&gt;</div><div class="line">    8390:	e08f3003 	add	r3, pc, r3</div><div class="line">    8394:	e1a00003 	mov	r0, r3</div><div class="line">    8398:	e1a01002 	mov	r1, r2</div><div class="line">    839c:	ebffffad 	bl	8258 &lt;printf@plt&gt;</div><div class="line">    83a0:	e1a00003 	mov	r0, r3</div><div class="line">    83a4:	e24bd004 	sub	sp, fp, #4</div><div class="line">    83a8:	e8bd8800 	pop	&#123;fp, pc&#125;</div><div class="line">    83ac:	00000030 	.word	0x00000030</div></pre></td></tr></table></figure>
<p><strong>push    {fp, lr}</strong></p>
<p><code>{}</code>: å…¶ä¸­åŒ…å«å¤šä¸ªå€¼;<br><code>fp</code>(frame pointer): å¸§æŒ‡é’ˆ,æ¯ä¸ªæ ˆå¸§ç”±fpå’Œspç•Œå®š,fpç›¸å½“äºx86ä¸­çš„ebp,spç›¸å½“äºx86ä¸­çš„esp;<br><code>lr</code>(link register): é“¾æ¥å¯„å­˜å™¨,åœ¨ç¨‹åºä¸­è°ƒç”¨å…¶ä»–å‡½æ•°æ—¶,å­˜æ”¾å­ç¨‹åºçš„è¿”å›åœ°å€(å³è°ƒç”¨æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤);</p>
<p>æœ¬æŒ‡ä»¤ç›¸å½“äº<code>stmfd sp!,{fp,lr}</code>(!è¡¨ç¤ºæ›´æ–°å¯„å­˜å™¨çš„å€¼),å°†è°ƒç”¨è€…çš„fpå’Œlrå¯„å­˜çš„å€¼å‹å…¥å †æ ˆ(é¡ºåº:ç¼–å·å°çš„å¯„å­˜å™¨çš„å€¼å­˜å…¥ä½åœ°å€,ç¼–å·å¤§çš„å¯„å­˜å™¨çš„å€¼å­˜å…¥é«˜åœ°å€),<br>ä¿æŠ¤è°ƒç”¨è€…ç¨‹åºçš„ç¯å¢ƒ,å­ç¨‹åºæ‰§è¡Œå®Œæ¯•åæ¢å¤ç¯å¢ƒ.</p>
<p><strong>add    fp, sp, #4</strong></p>
<p>å°†è¢«è°ƒç”¨è€…çš„fp(æ ˆåº•)æŒ‡å‘å­˜æ”¾è°ƒç”¨è€…fpçš„åœ°å€.</p>
<p><strong>sub    sp, sp, #8</strong></p>
<p>æŠ¬é«˜æ ˆé¡¶æŒ‡é’ˆ,å¼€è¾Ÿæ ˆç©ºé—´(8å­—èŠ‚).</p>
<p><strong>str    r0, [fp, #-8]</strong></p>
<p>å°†r0çš„å€¼(å‚æ•°1)å­˜å‚¨åˆ°fp-8æ‰€åœ¨çš„åœ°å€.</p>
<p><strong>str    r1, [fp, #-12]</strong></p>
<p>å°†r1çš„å€¼(å‚æ•°2)å­˜å‚¨åˆ°fp-12æ‰€åœ¨çš„åœ°å€.<br>ç°åœ¨å­ç¨‹åºçš„æ ˆç»“æ„å¦‚ä¸‹:<br>é«˜åœ°å€   -&gt;   ä½åœ°å€<br>è¿”å›åœ°å€(fp) å‚æ•°1 å‚æ•°2(sp)</p>
<p><strong>bl    8314 <test_for></test_for></strong></p>
<p>è°ƒç”¨8314å¤„çš„test_forå‡½æ•°.blæŒ‡ä»¤åŒæ—¶ä¼šå°†è¿”å›åœ°å€å­˜å‚¨åœ¨r14(lr)ä¸­.</p>
<p><strong>mov    r2, r0</strong></p>
<p>r0å­˜å‚¨çš„æ˜¯test_forçš„è¿”å›å€¼,èµ‹ç»™r2.</p>
<p><strong>ldr    r3, [pc, #24]    ; 83ac <main+0x3c></main+0x3c></strong></p>
<p>åŠ è½½pc+24åœ°å€å¤„çš„ä¸€ä¸ªå­—çš„æ•°æ®(.word    0x00000030)æ”¾å…¥r3.r3=0x30.</p>
<p><strong>add    r3, pc, r3</strong></p>
<p>r3+=pc,å³å–â€sum:%dâ€å­—ç¬¦ä¸²çš„åœ°å€.(PCçš„å€¼ä¸ºå½“å‰æ‰§è¡ŒæŒ‡ä»¤åœ°å€+8å­—èŠ‚)</p>
<p><strong>mov    r0, r3</strong></p>
<p>r0ä¸ºç¬¬ä¸€ä¸ªå‚æ•°(formatå­—ç¬¦ä¸²).</p>
<p><strong>mov    r1, r2</strong></p>
<p>r2ä¸ºç¬¬äºŒä¸ªå‚æ•°(test_forè¿”å›å€¼).(å½“å‚æ•°å°‘äº4ä¸ªæ—¶ä¿å­˜åœ¨é€šç”¨å¯„å­˜å™¨ä¸­,å¤šä½™4ä¸ªçš„ä¿å­˜åœ¨æ ˆä¸­)</p>
<p><strong>bl    8258 <a href="&#x6d;&#x61;&#x69;&#x6c;&#x74;&#x6f;&#58;&#x70;&#x72;&#x69;&#x6e;&#x74;&#x66;&#64;&#112;&#x6c;&#x74;">&#x70;&#x72;&#x69;&#x6e;&#x74;&#x66;&#64;&#112;&#x6c;&#x74;</a></strong></p>
<p>è°ƒç”¨printfå‡½æ•°.</p>
<p><strong>sub    sp, fp, #4</strong></p>
<p>ä¸å¼€è¾Ÿæ ˆç©ºé—´ç›¸å¯¹åº”.</p>
<p><strong>pop    {fp, pc}</strong></p>
<p>å°†æ ˆé¡¶æ•°æ®åˆ†åˆ«å¼¹å‡ºè‡³fp,pc,æ¢å¤è°ƒç”¨è€…ç¨‹åºçš„ç¯å¢ƒ(é¡ºåº:ä½åœ°å€çš„å€¼æ”¾å…¥ç¼–å·å°çš„å¯„å­˜å™¨,é«˜åœ°å€çš„å€¼æ”¾å…¥ç¼–å·å¤§çš„å¯„å­˜å™¨).</p>
<h3 id="test-for"><a href="#test-for" class="headerlink" title="test_for"></a>test_for</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">00008314 &lt;test_for&gt;:</div><div class="line">    8314:	e52db004 	push	&#123;fp&#125;		; (str fp, [sp, #-4]!)   @æ²¡æœ‰ç”¨åˆ°lrå¯„å­˜å™¨,æ— éœ€ä¿å­˜</div><div class="line">    8318:	e28db000 	add	fp, sp, #0</div><div class="line">    831c:	e24dd00c 	sub	sp, sp, #12     @å¼€è¾Ÿæ ˆç©ºé—´</div><div class="line">    8320:	e3a03000 	mov	r3, #0     </div><div class="line">    8324:	e50b300c 	str	r3, [fp, #-12]  @sum</div><div class="line">    8328:	e3a03000 	mov	r3, #0</div><div class="line">    832c:	e50b3008 	str	r3, [fp, #-8]   @i</div><div class="line">    8330:	ea000006 	b	8350 &lt;test_for+0x3c&gt; @bæŒ‡ä»¤ç›´æ¥æŒ‰åœ°å€è·³è½¬,ä¸ä¿å­˜è¿”å›åœ°å€</div><div class="line">    8334:	e51b200c 	ldr	r2, [fp, #-12]</div><div class="line">    8338:	e51b3008 	ldr	r3, [fp, #-8]</div><div class="line">    833c:	e0823003 	add	r3, r2, r3      @å–iå’Œsumç›¸åŠ </div><div class="line">    8340:	e50b300c 	str	r3, [fp, #-12]</div><div class="line">    8344:	e51b3008 	ldr	r3, [fp, #-8]   @å–iå€¼åŠ 1</div><div class="line">    8348:	e2833001 	add	r3, r3, #1</div><div class="line">    834c:	e50b3008 	str	r3, [fp, #-8]</div><div class="line">    8350:	e51b3008 	ldr	r3, [fp, #-8]   @å–iå€¼</div><div class="line">    8354:	e3530063 	cmp	r3, #99	; 0x63</div><div class="line">    8358:	dafffff5 	ble	8334 &lt;test_for+0x20&gt;    @å°äºç­‰äº99ç»§ç»­</div><div class="line">    835c:	e51b300c 	ldr	r3, [fp, #-12]</div><div class="line">    8360:	e1a00003 	mov	r0, r3          @sumå€¼æ”¾å…¥r0è¿”å›</div><div class="line">    8364:	e24bd000 	sub	sp, fp, #0</div><div class="line">    8368:	e49db004 	pop	&#123;fp&#125;		; (ldr fp, [sp], #4)</div><div class="line">    836c:	e12fff1e 	bx	lr   @è½¬åˆ°è¿”å›åœ°å€</div></pre></td></tr></table></figure>
<h1 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h1><h2 id="c-code"><a href="#c-code" class="headerlink" title="c code"></a>c code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">int global_v = 5;</div><div class="line">int test_switch()</div><div class="line">&#123;</div><div class="line">    switch(global_v)&#123;</div><div class="line">        case 1: printf(&quot;1&quot;);</div><div class="line">        case 5: printf(&quot;5&quot;);</div><div class="line">        case 7: printf(&quot;7&quot;);</div><div class="line">        default: printf(&quot;fail&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    test_switch();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="arm-code-1"><a href="#arm-code-1" class="headerlink" title="arm code"></a>arm code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">00008344 &lt;test_switch&gt;:</div><div class="line">    8344:	e92d4800 	push	&#123;fp, lr&#125;   @ä¿å­˜ç¯å¢ƒ</div><div class="line">    8348:	e28db004 	add	fp, sp, #4     @è°ƒæ•´å½“å‰æ ˆå¸§çš„æ ˆåº•æŒ‡é’ˆ</div><div class="line">    834c:	e59f2054 	ldr	r2, [pc, #84]	; 83a8 &lt;test_switch+0x64&gt;</div><div class="line">    8350:	e08f2002 	add	r2, pc, r2</div><div class="line">    8354:	e59f3050 	ldr	r3, [pc, #80]	; 83ac &lt;test_switch+0x68&gt; @è¿™é‡Œå¯è§å…¨å±€å˜é‡æ˜¯é€šè¿‡åœ°å€å­˜å–çš„</div><div class="line">    8358:	e7923003 	ldr	r3, [r2, r3]</div><div class="line">    835c:	e5933000 	ldr	r3, [r3]</div><div class="line">    8360:	e3530005 	cmp	r3, #5  @ç”±æ­¤å¯è§é‡‡ç”¨äº†äºŒåˆ†æŸ¥æ‰¾</div><div class="line">    8364:	0a000006 	beq	8384 &lt;test_switch+0x40&gt;</div><div class="line">    8368:	e3530007 	cmp	r3, #7</div><div class="line">    836c:	0a000007 	beq	8390 &lt;test_switch+0x4c&gt;</div><div class="line">    8370:	e3530001 	cmp	r3, #1</div><div class="line">    8374:	1a000008 	bne	839c &lt;test_switch+0x58&gt;</div><div class="line">    8378:	e3a00031 	mov	r0, #49	; 0x31</div><div class="line">    837c:	ebffffbe 	bl	827c &lt;putchar@plt&gt;       @å•ä¸ªå­—ç¬¦çš„printfå˜æˆäº†putchar</div><div class="line">    8380:	ea000009 	b	83ac &lt;test_switch+0x68&gt;</div><div class="line">    8384:	e3a00035 	mov	r0, #53	; 0x35</div><div class="line">    8388:	ebffffbb 	bl	827c &lt;putchar@plt&gt;</div><div class="line">    838c:	ea000006 	b	83ac &lt;test_switch+0x68&gt;   @è¿”å›</div><div class="line">    8390:	e3a00037 	mov	r0, #55	; 0x37</div><div class="line">    8394:	ebffffb8 	bl	827c &lt;putchar@plt&gt;</div><div class="line">    8398:	ea000003 	b	83ac &lt;test_switch+0x68&gt;</div><div class="line">    839c:	e59f3018 	ldr	r3, [pc, #24]	; 83bc &lt;test_switch+0x78&gt;</div><div class="line">    83a0:	e08f3003 	add	r3, pc, r3</div><div class="line">    83a4:	e1a00003 	mov	r0, r3</div><div class="line">    83a8:	ebffffb6 	bl	8288 &lt;printf@plt&gt;</div><div class="line">    83ac:	e1a00003 	mov	r0, r3      @è¿”å›å€¼</div><div class="line">    83b0:	e8bd8800 	pop	&#123;fp, pc&#125;    @æ¢å¤ç¯å¢ƒ</div><div class="line">    83b4:	00001c8c 	.word	0x00001c8c</div><div class="line">    83b8:	fffffffc 	.word	0xfffffffc</div><div class="line">    83bc:	00000054 	.word	0x00000054</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> arm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Arm æ¶æ„ç®€ä»‹]]></title>
      <url>/2015/12/05/arm-introduction/</url>
      <content type="html"><![CDATA[<p>åŸä¹¦é“¾æ¥: <a href="https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf" target="_blank" rel="external">https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf</a></p>
<p>æœ¬æ–‡åŸæ–‡: â€œA1.1 About the ARM architectureâ€</p>
<a id="more"></a>
<h1 id="A1-1-å…³äºARM-æ¶æ„"><a href="#A1-1-å…³äºARM-æ¶æ„" class="headerlink" title="A1.1 å…³äºARM æ¶æ„"></a>A1.1 å…³äºARM æ¶æ„</h1><p>ARM æ¶æ„å·²ç»å¯ä»¥æ”¯æŒé«˜ä½å„ç§æ€§èƒ½çš„å®ç°. è¶…è¿‡20äº¿è®¾å¤‡è£…å¤‡äº†ARM,ç¡®ç«‹äº†å…¶åœ¨å¸‚åœºä¸Šç»Ÿæ²»æ„ä¹‰çš„åœ°ä½. ARM å¤„ç†å™¨çš„ç®€å•æ¶æ„å¯ä»¥å®ç°å„ç§å°åŠŸèƒ½åŒæ—¶ç”µé‡æ¶ˆè€—ä½. åœ¨ ARM æ¶æ„çš„å‘å±•ä¸­,å®ç°éš¾åº¦,æ€§èƒ½,ç”µé‡æ¶ˆè€—ä½éƒ½æ˜¯ä¸å¯æˆ–ç¼ºçš„å…³é”®å› ç´ .</p>
<p>ARM æ˜¯ç²¾ç®€æŒ‡ä»¤é›†,å…¸å‹ç‰¹å¾å¦‚ä¸‹:</p>
<ul>
<li>ç»Ÿä¸€æ ·å¼çš„å¯„å­˜å™¨æ–‡ä»¶</li>
<li>load/store æ¶æ„,æ•°æ®å¤„ç†æŒ‡ä»¤åªèƒ½å¤„ç†å¯„å­˜å™¨ä¸­çš„å†…å®¹,ä¸èƒ½ç›´æ¥å¤„ç†å†…å­˜ä¸­çš„å†…å®¹</li>
<li>ç®€å•çš„å¯»å€æ¨¡å¼,load/storeçš„åœ°å€åªç”±å¯„å­˜å™¨å†…å®¹å’ŒæŒ‡ä»¤å­—æ®µå†³å®š</li>
<li>ç»Ÿä¸€å›ºå®šé•¿åº¦çš„æŒ‡ä»¤å­—æ®µ,å¯ç®€åŒ–æŒ‡ä»¤è§£æ</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–,ARMæ¶æ„è¿˜æä¾›:</p>
<ul>
<li>å¤§å¤šæ•°æ•°æ®å¤„ç†æŒ‡ä»¤éƒ½å¯ä»¥æ§åˆ¶ALUå’Œç§»ä½å™¨,è¿™æ ·å¯ä»¥æœ€å¤§åŒ–åˆ©ç”¨ALUå’Œç§»ä½å™¨</li>
<li>è‡ªå¢è‡ªå‡å¯»å€æ¨¡å¼,ä¼˜åŒ–å¾ªç¯</li>
<li>load/storeå¤šæ¡æŒ‡ä»¤åˆä¸€,å¢åŠ æ•°æ®ååé‡</li>
<li>æ‰€æœ‰æŒ‡ä»¤çš„æ¡ä»¶æ‰§è¡Œ,å¢åŠ æ‰§è¡Œååé‡</li>
</ul>
<p>è¿™äº›å¯¹äºRISCçš„å¢å¼ºåŠŸèƒ½ä½¿å¾—ARMå¤„ç†å™¨åœ¨é«˜æ€§èƒ½,ä»£ç å°‘,ä½æ¶ˆè€—å’ŒèŠ¯ç‰‡é¢ç§¯å°ä¹‹é—´è¾¾åˆ°äº†è‰¯å¥½çš„å¹³è¡¡.</p>
<h1 id="A1-1-1-ARM-å¯„å­˜å™¨"><a href="#A1-1-1-ARM-å¯„å­˜å™¨" class="headerlink" title="A1.1.1  ARM å¯„å­˜å™¨"></a>A1.1.1  ARM å¯„å­˜å™¨</h1><p>ARMæœ‰31ä¸ª32ä½é€šç”¨å¯„å­˜å™¨,ä»»ä½•æ—¶å€™å…¶ä¸­16ä¸ªéƒ½æ˜¯å¯è§çš„,å…¶ä»–å¯„å­˜å™¨æ˜¯ç”¨æ¥åŠ é€Ÿå¼‚å¸¸å¤„ç†çš„.<br>éç‰¹æƒä»£ç ä½¿ç”¨ç€è¿™16ä¸ªå¯„å­˜å™¨,ä¹Ÿå°±æ˜¯å¤„äºç”¨æˆ·æ¨¡å¼çš„ä»£ç .<br>ç”¨æˆ·æ¨¡å¼çš„ç‰¹ç‚¹å¦‚ä¸‹:</p>
<ul>
<li>ç”¨æˆ·æ¨¡å¼åªèƒ½äº§ç”Ÿå¼‚å¸¸åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä¸­.åœ¨ç¼–ç¨‹å±‚é¢ç”±SWIæŒ‡ä»¤å®ç°è¿™ä¸€åŠŸèƒ½.</li>
<li>ç›¸å¯¹äºç‰¹æƒæ¨¡å¼,ç”¨æˆ·æ¨¡å¼èƒ½è®¿é—®åˆ°çš„å†…å­˜å’Œåå¤„ç†å™¨åŠŸèƒ½æ˜¯æœ‰é™çš„.</li>
</ul>
<p>åœ¨è¿™16ä¸ªå¯„å­˜å™¨å½“ä¸­,æœ‰ä¸‰ä¸ªæ˜¯ç‰¹æ®Šå¯„å­˜å™¨:<br><strong>Stack pointer</strong>: R13æ˜¯æ ˆé¡¶æŒ‡é’ˆ(SP). åœ¨Tå˜ç§æŒ‡ä»¤é›†ä¸­R13è¢«PUSHå’ŒPOPä½¿ç”¨,ä»ARMv6ä¹‹åè¢«SRSå’ŒRFEæŒ‡ä»¤ä½¿ç”¨.</p>
<p><strong>Link register</strong>: R14æ˜¯é“¾æ¥å¯„å­˜å™¨(LR),åœ¨æ‰§è¡ŒBLå’ŒBLXæŒ‡ä»¤æ—¶,å­˜æ”¾ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€(å³å­ç¨‹åºçš„è¿”å›åœ°å€). åœ¨å¼‚å¸¸æ¨¡å¼çš„å…¥å£å¤„é¡µä½œä¸ºè¿”å›åœ°å€ä½¿ç”¨. å…¶ä½™æƒ…å†µä½œä¸ºé€šç”¨å¯„å­˜å™¨ä½¿ç”¨.</p>
<p><strong>Program counter</strong>: R15æ˜¯ç¨‹åºè®¡æ•°å™¨(PC). æŒ‡å‘å½“å‰æ­£åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€æ¡çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€. åœ¨ARMä¸­,æ‰€æœ‰çš„æŒ‡ä»¤éƒ½æ˜¯4å­—èŠ‚é•¿(ä¸€ä¸ª32ä½å­—),å¹¶ä¸”ä»¥ä¸€ä¸ªå­—é•¿å¯¹é½. è¿™å°±æ„å‘³ç€PCçš„åä¸¤ä½æ€»æ˜¯0,ä¹Ÿå°±æ˜¯åªæœ‰30ä½æ˜¯æœ‰ç”¨çš„. æœ‰äº›æ¶æ„ç‰ˆæœ¬ç»™å‰©ä½™çš„ä¸¤ä½èµ‹äºˆäº†å«ä¹‰. Tå˜ç§å’ŒJå˜ç§çš„JazelleçŠ¶æ€æ”¯æŒThumbæŒ‡ä»¤é›†,æ­¤æ—¶PCå¤§å°ä¸º16ä½,ä»¥1å­—èŠ‚å¯¹é½.</p>
<p>å…¶ä½™çš„13ä¸ªå¯„å­˜å™¨æ²¡æœ‰ç‰¹æ®Šçš„ç¡¬ä»¶æŒ‡å®šçš„ç”¨é€”,åªä¼šè¢«è½¯ä»¶æŒ‡å®šä½¿ç”¨.</p>
<h1 id="A1-1-2-å¼‚å¸¸"><a href="#A1-1-2-å¼‚å¸¸" class="headerlink" title="A1.1.2 å¼‚å¸¸"></a>A1.1.2 å¼‚å¸¸</h1><p>ARMæ”¯æŒ7ç§ç±»å‹çš„å¼‚å¸¸,æ¯ç§å¼‚å¸¸éƒ½å¯è¿›å…¥ç‰¹æƒå¤„ç†æ¨¡å¼.<br>è¿™7ç§å¼‚å¸¸æ˜¯:</p>
<ul>
<li>é‡ç½®</li>
<li>è¯•å›¾æ‰§è¡Œæœªå®šä¹‰æŒ‡ä»¤</li>
<li>è½¯ä»¶ä¸­æ–­æŒ‡ä»¤(SWI),å¯ä»¥ç”¨æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿ</li>
<li>é¢„å–ä¸­æ­¢,ä¸­æ­¢è¯»å†…å­˜æŒ‡ä»¤</li>
<li>æ•°æ®ä¸­æ­¢,æ•°æ®è®¿é—®æƒé™ä¸­æ­¢</li>
<li>IRQ,æ­£å¸¸ä¸­æ–­</li>
<li>FIQ,å¿«é€Ÿä¸­æ–­</li>
</ul>
<p>å¼‚å¸¸å‘ç”Ÿæ—¶,ä¸€äº›æ ‡å‡†å¯„å­˜å™¨å°†è¢«å¼‚å¸¸æ¨¡å¼å¾ç”¨. æ‰€æœ‰çš„å¼‚å¸¸éƒ½æœ‰R13,R14çš„æ›¿ä»£å¯„å­˜å™¨,å¿«é€Ÿä¸­æ–­å¼‚å¸¸æ¨¡å¼è¿˜æœ‰å…¶ä»–çš„æ›¿ä»£å¯„å­˜å™¨.</p>
<p>è¿›å…¥å¼‚å¸¸çš„handleræ—¶,R14å­˜æ”¾å¼‚å¸¸å¤„ç†çš„è¿”å›åœ°å€,ç”¨æ¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„ä»£ç .</p>
<p>åœ¨æ•´ä¸ªå¼‚å¸¸å¤„ç†è¿‡ç¨‹ä¸­,R13æ˜¯æ¯ä¸ªhandlerçš„ç‹¬ç«‹çš„stack pointer. å¿«é€Ÿä¸­æ–­æ¨¡å¼ä¼šå°†R8-R12çš„å€¼å­˜èµ·æ¥,è¿™æ ·ä¸­æ–­å¤„ç†ç¨‹åºåœ¨å¼€å§‹ä¹‹å‰å°±ä¸ç”¨å­˜å‚¨æˆ–è€…æ¢å¤è¿™äº›å¯„å­˜å™¨äº†.</p>
<p>ç¬¬å…­ç‰¹æƒå¤„ç†æ¨¡å¼-ç³»ç»Ÿæ¨¡å¼,å¯ä»¥ä½¿ç”¨ç”¨æˆ·æ¨¡å¼çš„å¯„å­˜å™¨. æ­¤åŠŸèƒ½ç”¨æ¥è¿è¡Œéœ€è¦å†…å­˜æˆ–åå¤„ç†å™¨é«˜çº§æƒé™çš„ä»»åŠ¡,å¹¶ä¸”æ²¡æœ‰å¯¹å¼‚å¸¸å‘ç”Ÿçš„é™åˆ¶.</p>
<p>é™¤äº†ä¸Šé¢è¿™äº›,resetå’ŒSWIså…±äº«åŒç­‰ç‰¹æƒæ¨¡å¼.</p>
<h2 id="å¼‚å¸¸å¤„ç†è¿‡ç¨‹"><a href="#å¼‚å¸¸å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¼‚å¸¸å¤„ç†è¿‡ç¨‹"></a>å¼‚å¸¸å¤„ç†è¿‡ç¨‹</h2><p>å¼‚å¸¸å‘ç”Ÿæ—¶, ARM å¤„ç†å™¨ä»¥ä¸€ç§é¢„å®šä¹‰çš„æ–¹å¼æš‚åœæ‰§è¡Œ, å¼€å§‹æ‰§è¡Œå†…å­˜ä¸­æŸä¸€å›ºå®šåœ°å€å¤„çš„å¼‚å¸¸å‘é‡ä»£ç . åŒ…æ‹¬resetåœ¨å†…æ¯ä¸ªå¼‚å¸¸éƒ½æœ‰ä¸€ä¸ªå¼‚å¸¸å‘é‡åœ°å€. æ­£å¸¸è¿è¡Œçš„ç³»ç»Ÿå’Œè°ƒè¯•äº‹ä»¶å¯¹åº”çš„è¡Œä¸ºéƒ½æ˜¯å®šä¹‰å¥½çš„.</p>
<p>æ“ä½œç³»ç»Ÿåœ¨åˆå§‹åŒ–æ—¶ä¸ºæ¯ä¸ªå¼‚å¸¸åˆ†é…ä¸€ä¸ªhandler, æœ‰æƒé™çš„ç³»ç»Ÿä»»åŠ¡è¿è¡Œåœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹å¯ä»¥è®©æ“ä½œç³»ç»Ÿå†…ä¸å¸¦çŠ¶æ€æŸå¤±çš„å‘ç”Ÿå¼‚å¸¸.</p>
<h1 id="A1-1-3-çŠ¶æ€å¯„å­˜å™¨"><a href="#A1-1-3-çŠ¶æ€å¯„å­˜å™¨" class="headerlink" title="A1.1.3 çŠ¶æ€å¯„å­˜å™¨"></a>A1.1.3 çŠ¶æ€å¯„å­˜å™¨</h1><p>é™¤äº†é€šç”¨å¯„å­˜å™¨çš„å†…å®¹ä¹‹å¤–,æ‰€æœ‰çš„å¤„ç†å™¨çŠ¶æ€ä¿å­˜åœ¨çŠ¶æ€å¯„å­˜å™¨ä¸­. å½“å‰çš„æ“ä½œç³»ç»ŸçŠ¶æ€ä¿å­˜åœ¨CPSRå¯„å­˜å™¨ä¸­(Current Program Status Register). å†…å®¹å¦‚ä¸‹:</p>
<ul>
<li>4ä¸ªæ¡ä»¶æ ‡è®°ä½(è´Ÿæ•°,0,è¿›ä½,æº¢å‡º)</li>
<li>1ä¸ªsticky(Q)æ ‡è®°ä½(ARMv5åŠä»¥ä¸Š),æ ‡è®°é¥±å’Œç®—æ•°æŒ‡ä»¤æ˜¯å¦å·²ç»è¾¾åˆ°é¥±å’Œ,æˆ–è€…åœ¨ç´¯åŠ ä¹˜æ³•ä¸­æŒ‡ä»¤æ˜¯å¦æœ‰ç¬¦å·æº¢å‡º.</li>
<li>4ä¸ªGE(å¤§äºç­‰äº)æ ‡è®°ä½(ARMv6åŠä»¥ä¸Š),ç”¨æ¥æ ‡è®°ä¸€ä¸‹æƒ…å†µ:<br>(1) æœ‰ç¬¦å·è¿ç®—çš„ç»“æœæ˜¯éè´Ÿçš„<br>(2) æ— ç¬¦å·è¿ç®—æ˜¯å¦äº§ç”Ÿè¿›ä½æˆ–å€Ÿä½</li>
<li>2ä¸ªä¸­æ–­æ ‡è®°ä½,ä¸€ä¸ªæ˜¯ä¸­æ–­çš„ç±»å‹(2ä¸ªæ˜¯åœ¨ARMv5ç‰ˆæœ¬åŠä»¥ä¸‹).</li>
<li>1ä¸ªä¸ç¡®åˆ‡ä¸­æ–­æ ‡è®°ä½(ARMv6ä¹‹å)</li>
<li>5ä¸ªå½“å‰å¤„ç†å™¨æ‰€åœ¨æ¨¡å¼æ ‡è®°ä½</li>
<li>2ä¸ªæŒ‡ä»¤é›†æ ‡è®°ä½,æ ‡è®°å½“å‰æ‰§è¡Œçš„æ˜¯æŒ‡ä»¤é›†æ˜¯ARM,Thumbè¿˜æ˜¯Jazelle</li>
<li>1ä¸ªload/storeæ“ä½œçš„å­—èŠ‚é¡ºåºæ ‡è®°ä½</li>
</ul>
<p>æ¯ä¸ªå¼‚å¸¸æ¨¡å¼æœ‰ä¸€ä¸ªSPSRå¯„å­˜å™¨(Saved Program Status Register),è¿›å…¥å¼‚å¸¸å‰ä¿å­˜ä»»åŠ¡çš„CPSRå€¼.è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä»¥ç‰¹æ®Šçš„æŒ‡ä»¤å­˜å–.</p>
<p><strong>Table A1-1 Status register summary</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Architecture</th>
</tr>
</thead>
<tbody>
<tr>
<td>N Z C V</td>
<td>Condition code flags</td>
<td>All</td>
</tr>
<tr>
<td>J</td>
<td>Jazelle state flag</td>
<td>5TEJ and above</td>
</tr>
<tr>
<td>GE[3:0]</td>
<td>SIMD condition</td>
<td>flags 6</td>
</tr>
<tr>
<td>E</td>
<td>Endian Load/Store</td>
<td>6</td>
</tr>
<tr>
<td>A</td>
<td>Imprecise Abort Mask</td>
<td>6</td>
</tr>
<tr>
<td>I</td>
<td>IRQ Interrupt Mask</td>
<td>All</td>
</tr>
<tr>
<td>F</td>
<td>FIQ Interrupt Mask</td>
<td>All</td>
</tr>
<tr>
<td>T</td>
<td>Thumb state flag</td>
<td>4T and above</td>
</tr>
<tr>
<td>Mode[4:0]</td>
<td>Processor mode</td>
<td>All</td>
</tr>
</tbody>
</table>
]]></content>
      
        <categories>
            
            <category> ARM </category>
            
            <category> è¯‘æ–‡ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> arm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[åœ¨androidæ‰‹æœºä¸Šè¿è¡ŒCç¨‹åº - hello arm!]]></title>
      <url>/2015/12/02/run-first-c-program-on-android-phone/</url>
      <content type="html"><![CDATA[<p>ä¸ºäº†å­¦ä¹ armæŒ‡ä»¤é›†ï¼Œå½“ç„¶è¦å…ˆå†™æ®µ hello arm è¯•éªŒå’¯ã€‚</p>
<a id="more"></a>
<h1 id="å†™æ®µ-hello-arm"><a href="#å†™æ®µ-hello-arm" class="headerlink" title="å†™æ®µ hello arm"></a>å†™æ®µ hello arm</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">        printf(&quot;hello arm!\n&quot;);</div><div class="line">        return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ç¼–è¯‘æ–¹å¼"><a href="#ç¼–è¯‘æ–¹å¼" class="headerlink" title="ç¼–è¯‘æ–¹å¼"></a>ç¼–è¯‘æ–¹å¼</h1><p>è¿™é‡Œæœ‰ä¸¤ç§æ‰‹åŠ¨ç¼–è¯‘æ–¹å¼ï¼šgccå’Œndk-build.</p>
<h2 id="ä½¿ç”¨gcc"><a href="#ä½¿ç”¨gcc" class="headerlink" title="ä½¿ç”¨gcc"></a>ä½¿ç”¨gcc</h2><h3 id="é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ"><a href="#é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ"></a>é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ</h3><p>å› ä¸ºæˆ‘ä»¬è¦ç¼–è¯‘å‡ºåœ¨androidæ‰‹æœºä¸Šè¿è¡Œçš„ç¨‹åºï¼Œå¿…é¡»è¦ä¸ºgccæä¾›androidçš„å¹³å°æ–‡ä»¶å’ŒæŒ‡ä»¤é›†ã€‚<br>è€Œndkä¸­è‡ªå¸¦äº†gccç­‰ä¸€ç³»åˆ—å·¥å…·ï¼Œæ‰€ä»¥ç°åœ¨ç›´æ¥è°ƒç”¨å³å¯ã€‚æ²¡æœ‰ndkçš„è¯éœ€è¦å…ˆè¡Œä¸‹è½½ã€‚<br>ä¸º<code>ï½/.bashrc</code>é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#android-ndk-gcc</div><div class="line">export NDKROOT=/media/d/android-sdk-linux/android-sdk-linux/ndk-bundle</div><div class="line">export SYSROOT=$NDKROOT/platforms/android-21/arch-arm</div><div class="line">export NDKTOOL=$NDKROOT/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin</div><div class="line">alias ndk-gcc=&apos;$NDKTOOL/arm-linux-androideabi-gcc-4.9 --sysroot=$SYSROOT&apos;</div><div class="line">alias ndk-objdump=&apos;$NDKTOOL/arm-linux-androideabi-objdump&apos;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<br><code>NDKROOT</code>æ˜¯ndkçš„ä¸»ç›®å½•;<br><code>SYSROOT</code>æ˜¯æ‰€é€‰çš„æŒ‡ä»¤é›†,è¿™é‡Œæ˜¯arm;<br><code>NDKTOOL</code>æ˜¯ndkçš„å·¥å…·é“¾ç›®å½•;<br><code>ndk-gcc</code>æ˜¯ä¸ºåé¢ä¸€ä¸²å‘½ä»¤èµ·çš„åˆ«åï¼Œè¿™æ ·ä½¿ç”¨æ—¶å°±ä¸ç”¨ä¸€éä¸€éçš„è¾“å‚æ•°äº†;<br><code>ndk-objdump</code>æ˜¯å¯ä»¥åæ±‡ç¼–armç¨‹åºçš„å·¥å…·,ä¸ndk-gccåœ¨ndkçš„åŒä¸€ç›®å½•ä¸‹.</p>
<p>é…ç½®å®Œæˆåå¯æ‰§è¡Œ<code>source ~./bashrc</code>ä½¿ç«‹å³ç”Ÿæ•ˆ,<code>echo $ndk-gcc</code>æŸ¥çœ‹æ˜¯å¦è®¾ç½®æˆåŠŸã€‚</p>
<h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p>æ‰§è¡Œ<code>ndk-gcc -o hello-arm hello-arm.c</code>ç›´æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚<br>æ‰§è¡Œ<code>ndk-gcc -S hello-arm.s hello-arm.c</code>ç”Ÿæˆarmæ±‡ç¼–æ–‡ä»¶ã€‚<br>å…¶ä»–é€‰é¡¹æ‰§è¡Œ<code>ndk-gcc --help</code>æŸ¥çœ‹å¸®åŠ©ã€‚</p>
<h2 id="ä½¿ç”¨ndk-build"><a href="#ä½¿ç”¨ndk-build" class="headerlink" title="ä½¿ç”¨ndk-build"></a>ä½¿ç”¨ndk-build</h2><h3 id="é…ç½®ndk-buildç¯å¢ƒ"><a href="#é…ç½®ndk-buildç¯å¢ƒ" class="headerlink" title="é…ç½®ndk-buildç¯å¢ƒ"></a>é…ç½®ndk-buildç¯å¢ƒ</h3><p>å¦‚æœæ˜¯å•ç‹¬ä¸‹çš„ndk,è¿™æ—¶å€™ç³»ç»Ÿæ‰¾ä¸åˆ°ndk-buildå‘½ä»¤,éœ€è¦å°†å…¶è·¯å¾„åŠ å…¥pathä¸­.<br>ndk-buildåœ¨ndkæ ¹ç›®å½•ä¸‹ã€‚</p>
<h3 id="æ–°å»ºAndroidå·¥ç¨‹"><a href="#æ–°å»ºAndroidå·¥ç¨‹" class="headerlink" title="æ–°å»ºAndroidå·¥ç¨‹"></a>æ–°å»ºAndroidå·¥ç¨‹</h3><p>æ‰§è¡Œ<code>android list</code>æŸ¥çœ‹å·²å®‰è£…çš„sdkç‰ˆæœ¬;<br>æ‰§è¡Œ<code>android create project -t 1 -p ~/Desktop/helloarm -a MainActivity</code>åœ¨æ¡Œé¢åˆ›å»ºä¸€ä¸ªæ–°å·¥ç¨‹.<br>å…¶ä¸­:<br><code>-t</code>è¡¨ç¤ºæ–°å·¥ç¨‹ç›®æ ‡sdk;<br><code>-p</code>è¡¨ç¤ºå·¥ç¨‹çš„è·¯å¾„;<br><code>-a</code>è¡¨ç¤ºé»˜è®¤activityçš„åç§°.<br>å…¶ä»–é€‰é¡¹å¯æ‰§è¡Œ<code>android create project -h</code>æŸ¥çœ‹.</p>
<h3 id="é…ç½®jniç›®å½•"><a href="#é…ç½®jniç›®å½•" class="headerlink" title="é…ç½®jniç›®å½•"></a>é…ç½®jniç›®å½•</h3><p>åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª<code>jni</code>ç›®å½•,å°†<code>hello-arm.c</code>æ‹·è´è‡³æ­¤ç›®å½•.<br>æ–°å»ºè„šæœ¬æ–‡ä»¶åä¸º<code>Android.mk</code>,è¿™æ˜¯ndk-buildéœ€è¦çš„å·¥ç¨‹ç¼–è¯‘è„šæœ¬,æè¿°äº†ç¼–è¯‘ç¨‹åºçš„å„ç§é€‰é¡¹å’Œä¾èµ–.<br>å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_ARM_MODE := arm</div><div class="line">LOCAL_MODULE := hello-arm</div><div class="line">LOCAL_SRC_FILES := hello-arm.c</div><div class="line">include $(BUILD_EXECUTABLE)</div></pre></td></tr></table></figure>
<p>å…¶ä¸­:<br><code>LOCAL_PATH</code>è¡¨ç¤ºæœ¬å·¥ç¨‹æºç çš„è·¯å¾„, <code>my-dir</code>è¡¨ç¤ºAndroid.mkçš„è·¯å¾„;<br><code>CLEAR_VARS</code>è®©ç¼–è¯‘å™¨æ¸…é™¤å·²ç»å®šä¹‰è¿‡çš„å®,é¿å…åœ¨ç¼–è¯‘å¤šä¸ªæ¨¡å—æ—¶å‘ç”Ÿé”™è¯¯,å› ä¸ºè¿™äº›å®æ˜¯å…¨å±€çš„,å¿…é¡»é‡æ–°è®¾ç½®;<br><code>LOCAL_ARM_MODE</code>æŒ‡å®šç¨‹åºä½¿ç”¨çš„ARMæŒ‡ä»¤æ¨¡å¼;<br><code>LOCAL_MODULE</code>æŒ‡å®šç”Ÿæˆçš„æ¨¡å—å,å¦‚æœç”Ÿæˆçš„æ˜¯å…±äº«åº“,æ¨¡å—åä¼šå˜ä¸ºlibhello-arm.so;<br><code>LOCAL_SRC_FILES</code>æŒ‡å®šæºæ–‡ä»¶åˆ—è¡¨;<br><code>BUILD_EXECUTABLE</code>è¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„,å…¶ä»–é€‰é¡¹æœ‰<code>BUILD_SHARED_LIBRARY</code>(ç”ŸæˆåŠ¨æ€åº“),<code>BUILD_STATIC_LIBRARY</code>(ç”Ÿæˆé™æ€åº“).</p>
<h3 id="ç¼–è¯‘-1"><a href="#ç¼–è¯‘-1" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p>åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ‰§è¡Œ<code>ndk-build</code>,ç¼–è¯‘å®Œæˆåçš„æ–‡ä»¶åœ¨<code>libs/armeabi</code>ç›®å½•ä¸‹.</p>
<h1 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h1><p>æ‰§è¡Œ<code>adb push hello-arm /data/local</code>pushåˆ°æ‰‹æœºä¸Š(æˆ‘ç”¨çš„æ˜¯genymotionè™šæ‹Ÿæœº),</p>
<p>æ‰§è¡Œ<code>/data/local/hello-arm</code></p>
<h2 id="å‡ºç°ç¬¬ä¸€ä¸ªé”™è¯¯"><a href="#å‡ºç°ç¬¬ä¸€ä¸ªé”™è¯¯" class="headerlink" title="å‡ºç°ç¬¬ä¸€ä¸ªé”™è¯¯"></a>å‡ºç°ç¬¬ä¸€ä¸ªé”™è¯¯</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh: ./hello arm: not executable: magic 7F45</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºç¨‹åºæŒ‡ä»¤é›†å’Œæ‰‹æœºæŒ‡ä»¤é›†ä¸ä¸€è‡´é€ æˆçš„ã€‚</p>
<p>å†™ä¸€æ®µjavaä»£ç ç¼–è¯‘æˆdex,çœ‹çœ‹æ‰‹æœºæ˜¯ä»€ä¹ˆæ¶æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class GetCPU</div><div class="line">&#123;</div><div class="line">    public static void main(String[] args)</div><div class="line">    &#123;</div><div class="line">        String arch = System.getProperty(&quot;os.arch&quot;);</div><div class="line">        System.out.println(arch);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>javac GetCPU.java</code> å’Œ <code>dx --dex --output=GetCPU.dex GetCPU.class</code> ç¼–è¯‘æˆdexæ–‡ä»¶,<br>pushåˆ°æ‰‹æœºä¸Šçš„ /data/local/ç›®å½•, æ‰§è¡Œ<code>dalvikvm -cp /data/local/GetCPU.dex GetCPU</code>:<br>æœç„¶æ˜¯intelçš„..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@vbox86p:/data/local #dalvikvm -cp /data/local/GetCPU.dex GetCPU  </div><div class="line">i686</div></pre></td></tr></table></figure>
<p>æ¢äº†ä¸€ä¸ªarmæ¶æ„çš„æ‰‹æœº(çœŸæœº):<br>å…ˆæ‰§è¡Œäº†GetCPU.dexç¡®è®¤æŒ‡ä»¤é›†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@aio_otfp:/data/local # dalvikvm -cp /data/local/GetCPU.dex GetCPU         </div><div class="line">aarch64</div></pre></td></tr></table></figure>
<p>ç°åœ¨å¯ä»¥æ‰§è¡Œ <code>/data/local/hello-arm</code>äº†.</p>
<h2 id="å‡ºç°ç¬¬äºŒä¸ªé”™è¯¯ï¼"><a href="#å‡ºç°ç¬¬äºŒä¸ªé”™è¯¯ï¼" class="headerlink" title="å‡ºç°ç¬¬äºŒä¸ªé”™è¯¯ï¼"></a>å‡ºç°ç¬¬äºŒä¸ªé”™è¯¯ï¼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh: ./hello-arm: can&apos;t execute: Permission denied</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºæ²¡æœ‰æ‰§è¡Œæƒé™ï¼ŒåŠ ä¸Šæ‰§è¡Œæƒé™ï¼777ï¼å†æ¬¡æ‰§è¡Œï¼</p>
<h2 id="å‡ºç°ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼"><a href="#å‡ºç°ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼" class="headerlink" title="å‡ºç°ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼"></a>å‡ºç°ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error: only position independent executables (PIE) are supported.</div></pre></td></tr></table></figure>
<p>è¿™æ¬¡æ˜¯å› ä¸ºæ²¡æœ‰é™æ€ç¼–è¯‘ï¼Œé‡æ–°ç¼–è¯‘ï¼ŒåŠ ä¸Šé™æ€é€‰é¡¹ï¼š</p>
<p><code>ndk-gcc --static hello-world.c -o hello-arm</code></p>
<p>é¢¤é¢¤å·å·çš„å†æ¬¡æ‰§è¡Œâ€¦<br>ç»ˆäºå‡ºç°äº† â€”â€”â€”â€”â€”â€”â€” hello arm!</p>
<h1 id="Refernece"><a href="#Refernece" class="headerlink" title="Refernece"></a>Refernece</h1><p><a href="http://ticktick.blog.51cto.com/823160/1692489" target="_blank" rel="external">å¦‚ä½•åœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨Android NDKäº¤å‰ç¼–è¯‘å·¥å…·</a></p>
<p><a href="http://blog.csdn.net/smfwuxiao/article/details/6587709" target="_blank" rel="external">Android NDK å·¥å…·é“¾çš„ä½¿ç”¨æ–¹æ³•ï¼ˆStandalone Toolchainï¼‰</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ndk </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ubuntu 14.04ç¼–è¯‘è¿è¡Œandroid 4.4.4_r2æºç ]]></title>
      <url>/2015/12/02/compile-android-sourcecode-4-4-4-r2/</url>
      <content type="html"><![CDATA[<h1 id="ä¸‹è½½-repo"><a href="#ä¸‹è½½-repo" class="headerlink" title="ä¸‹è½½ repo"></a>ä¸‹è½½ repo</h1><p>ä½¿ç”¨çš„æ˜¯<a href="https://mirrors.tuna.tsinghua.edu.cn/help/#AOSP" target="_blank" rel="external">æ¸…åé•œåƒ</a>ï¼ŒæŒ‰æ­¥éª¤æ¥ä¸‹è½½å³å¯ã€‚<br><a id="more"></a><br>å…·ä½“å‚è€ƒ<a href="https://mirrors.tuna.tsinghua.edu.cn/help/#AOSP" target="_blank" rel="external">Android é•œåƒä½¿ç”¨å¸®åŠ©</a><br>è¿™ç§æ–¹æ³•ä¸‹è½½æ¯”è¾ƒæ…¢ï¼Œä¸‹äº†æœ‰50+Gï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯gitæ–‡ä»¶ã€‚<br>æ‰€ä»¥å‡†å¤‡çš„ç¡¬ç›˜ç©ºé—´è¦å¤§ä¸€äº›!å¤§ä¸€äº›!å†å¤§ä¸€äº›!<br>æˆ‘ç¼–è¯‘å®Œæˆåå ç”¨çš„æ€»ç©ºé—´æœ‰101Gï¼å…¶ä¸­ç¼–è¯‘åçš„outç›®å½•26G, .repoç›®å½•66G, ä¹Ÿå°±æ˜¯æºç åªæœ‰9Gâ€¦</p>
<h1 id="å®‰è£…jdk"><a href="#å®‰è£…jdk" class="headerlink" title="å®‰è£…jdk"></a>å®‰è£…jdk</h1><p>æˆ‘ä¹‹å‰å®‰è£…çš„jdkæ˜¯1.7çš„ï¼Œandroid4.4.4éœ€è¦å®‰è£…1.5çš„ç‰ˆæœ¬ã€‚</p>
<h1 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h1><p>è¿™é‡Œä¸€å®šè¦ç¡®ä¿å…¨éƒ¨å®‰è£…äº†ã€‚<br>ä¸‹é¢çš„å‘½ä»¤æ˜¯é’ˆå¯¹ubuntu14.04æ¥è¯´çš„ï¼Œå…¶ä½™ç³»ç»Ÿå‚è€ƒ<a href="https://source.android.com/source/initializing.html" target="_blank" rel="external">å®˜ç½‘</a>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install git-core gnupg flex bison gperf build-essential \</div><div class="line">  zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \</div><div class="line">  lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache \</div><div class="line">  libgl1-mesa-dev libxml2-utils xsltproc unzip</div></pre></td></tr></table></figure>
<h1 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h1><p>æºç æ ¹ç›®å½•ä¸‹æ‰§è¡Œmakeã€‚<br>å‡ºç°äº†ï¼é”™è¯¯ï¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;../build/scripts/make_css_property_names.py&quot;, line 255, in &lt;module&gt;</div><div class="line">    in_generator.Maker(CSSPropertiesWriter).main(sys.argv)</div><div class="line">  File &quot;/media/mobiledisk/source-code/repo-android/external/chromium_org/third_party/WebKit/Source/build/scripts/in_generator.py&quot;, line 99, in main</div><div class="line">    writer.write_files(options.output_dir)</div><div class="line">  File &quot;/media/mobiledisk/source-code/repo-android/external/chromium_org/third_party/WebKit/Source/build/scripts/in_generator.py&quot;, line 79, in write_files</div><div class="line">    self._write_file(output_dir, generator(), file_name)</div><div class="line">  File &quot;../build/scripts/make_css_property_names.py&quot;, line 250, in generate_implementation</div><div class="line">    gperf = subprocess.Popen(gperf_args, stdin=subprocess.PIPE, stdout=subprocess.PIPE)</div><div class="line">  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 710, in __init__</div><div class="line">    errread, errwrite)</div><div class="line">  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 1327, in _execute_child</div><div class="line">    raise child_exception</div><div class="line">OSError: [Errno 2] No such file or directory</div></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µå°±æ˜¯æŸä¸ªä¾èµ–æ²¡æœ‰å®‰è£…â€¦</p>
<h1 id="è¿è¡Œç¼–è¯‘å¥½çš„ç³»ç»Ÿ"><a href="#è¿è¡Œç¼–è¯‘å¥½çš„ç³»ç»Ÿ" class="headerlink" title="è¿è¡Œç¼–è¯‘å¥½çš„ç³»ç»Ÿ"></a>è¿è¡Œç¼–è¯‘å¥½çš„ç³»ç»Ÿ</h1><p>æºç æ ¹ç›®å½•ä¸‹æ‰§è¡Œä¸€ä¸‹å‘½ä»¤:</p>
<p><code>source build/envsetup.sh</code><br><code>lunch full-eng</code><br><code>emulator</code></p>
<p>å°±ä¼šå¯åŠ¨è‡ªå¸¦çš„æ¨¡æ‹Ÿå™¨äº†ï¼Œé‡Œé¢å°±æ˜¯åˆšåˆšç¼–è¯‘å¥½çš„ç³»ç»Ÿã€‚</p>
<hr>
<h1 id="ç•ªå¤–"><a href="#ç•ªå¤–" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><p>æºç æ ¹ç›®å½•ä¸‹å…³äºavdçš„æ“ä½œï¼š</p>
<p><code>android list avd</code>: åˆ—å‡ºæ¨¡æ‹Ÿå™¨åˆ—è¡¨<br><code>android create avd -t 1 -n myavd</code>: åˆ›å»ºä¸€ä¸ªåä¸ºmyavdçš„æ¨¡æ‹Ÿå™¨,-tä¸ºæŒ‡å®šid.å…·ä½“å¯é€šè¿‡-hæŸ¥çœ‹.<br><code>emulator -avd myavd</code>: å¯åŠ¨æ¨¡æ‹Ÿå™¨</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> compile </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[dexåŠå…¶ç±»çš„åŠ è½½è¿‡ç¨‹]]></title>
      <url>/2015/11/28/dex-loading-flow/</url>
      <content type="html"><![CDATA[<blockquote>
<p>åœ¨Androidç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹å­µåŒ–å‡ºæ¥çš„ï¼Œè€ŒZygoteè¿›ç¨‹æ˜¯ç”±Initè¿›ç¨‹å¯åŠ¨çš„ã€‚Zygoteè¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹ï¼Œæ¯å½“å®ƒå­µåŒ–ä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ—¶ï¼Œéƒ½ä¼šå°†è¿™ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹å¤åˆ¶åˆ°æ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹é‡Œé¢å»ï¼Œä»è€Œä½¿å¾—æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Dalvikè™šæ‹Ÿæœºå®ä¾‹ã€‚</p>
</blockquote>
<a id="more"></a>
<p>æ¯ä¸ªandroidåº”ç”¨ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºå®ä¾‹ä¸Šçš„ï¼Œè€Œå…¶ä¸­dexçš„åŠ è½½å°±æ¯”å¦‚ç¦»å¼€ä¸äº†è™šæ‹Ÿæœºçš„åˆå§‹åŒ–ã€‚</p>
<h1 id="JNI-CreateJavaVM"><a href="#JNI-CreateJavaVM" class="headerlink" title="JNI_CreateJavaVM"></a>JNI_CreateJavaVM</h1><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/Jni.cpp#3524" target="_blank" rel="external">/dalvik/vm/Jni.cpp</a>.<br>åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæœºä¹‹åè°ƒç”¨ dvmStartup åˆå§‹åŒ–è™šæ‹Ÿæœºã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">std::string status = dvmStartup(argc, argv.get(), args-&gt;ignoreUnrecognized, (JNIEnv*)pEnv);</div></pre></td></tr></table></figure>
<h1 id="dvmStartup"><a href="#dvmStartup" class="headerlink" title="dvmStartup"></a>dvmStartup</h1><p>ä½äº<a href="(http://androidxref.com/4.4.4_r1/xref/dalvik/vm/Init.cpp#1382">/dalvik/vm/Init.cpp</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">std::string dvmStartup(int argc, const char* const argv[],</div><div class="line">        bool ignoreUnrecognized, JNIEnv* pEnv)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    if (!dvmClassStartup()) &#123;   //åˆå§‹åŒ–æ–‡ä»¶çš„ç»“æ„ä½“å¼•ç”¨</div><div class="line">        return &quot;dvmClassStartup failed&quot;;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    if (!dvmFindRequiredClassesAndMembers()) &#123;  //åˆå§‹åŒ–æˆå‘˜ã€ç±»çš„å¼•ç”¨</div><div class="line">        return &quot;dvmFindRequiredClassesAndMembers failed&quot;;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="dvmClassStartup"><a href="#dvmClassStartup" class="headerlink" title="dvmClassStartup"></a>dvmClassStartup</h2><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#409" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a><br>å¤„ç†å¯åŠ¨ç±»è·¯å¾„ï¼Œæ‰“å¼€ç‰¹å®šçš„dex/jaræ–‡ä»¶ï¼Œå¯èƒ½ä¼šè¿›è¡Œä¸€äº›ä¼˜åŒ–ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">bool dvmClassStartup()</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    processClassPath(gDvm.bootClassPathStr, true);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="processClassPath"><a href="#processClassPath" class="headerlink" title="processClassPath"></a>processClassPath</h3><p>å°†ä¸€äº›æ–‡ä»¶è·¯å¾„è½¬åŒ–ä¸ºClassPathEntryç»“æ„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">static ClassPathEntry* processClassPath(const char* pathStr, bool isBootstrap)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    cp = mangle;</div><div class="line">    idx = 0;</div><div class="line">    while (cp &lt; end) &#123;  //å¾ªç¯éå†pathStr</div><div class="line">        ...</div><div class="line">            ClassPathEntry tmp;</div><div class="line">            tmp.kind = kCpeUnknown;</div><div class="line">            tmp.fileName = strdup(cp);</div><div class="line">            tmp.ptr = NULL;</div><div class="line">            cpe[idx].kind = kCpeLastEntry;</div><div class="line">            cpe[idx].fileName = NULL;</div><div class="line">            cpe[idx].ptr = NULL;</div><div class="line">            //ä¸ºæ¯ä¸ªæ–‡ä»¶å‡†å¤‡ä¸€ä¸ªcpe</div><div class="line">            if (!prepareCpe(&amp;tmp, isBootstrap)) &#123;</div><div class="line">                /* drop from list and continue on */</div><div class="line">                free(tmp.fileName);</div><div class="line">            &#125; else &#123;</div><div class="line">                /* copy over, pointers and all */</div><div class="line">                cpe[idx] = tmp;</div><div class="line">                idx++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        cp += strlen(cp) +1;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    return cpe;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="prepareCpe"><a href="#prepareCpe" class="headerlink" title="prepareCpe"></a>prepareCpe</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#603" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a>.<br>æ ¹æ®ä¼ è¿›çš„æ–‡ä»¶ååˆ¤æ–­è¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Œæå–å‡ºæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå­˜å…¥ClassPathEntryç»“æ„ä½“ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">static bool prepareCpe(ClassPathEntry* cpe, bool isBootstrap)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    char suffix[10];</div><div class="line">    getFileNameSuffix(cpe-&gt;fileName, suffix, sizeof(suffix));</div><div class="line">    //æ ¹æ®åç¼€ååˆ¤æ–­æ–‡ä»¶ç±»å‹</div><div class="line">    if ((strcmp(suffix, &quot;jar&quot;) == 0) || (strcmp(suffix, &quot;zip&quot;) == 0) ||</div><div class="line">            (strcmp(suffix, &quot;apk&quot;) == 0)) &#123;</div><div class="line">        JarFile* pJarFile = NULL;</div><div class="line">        if (dvmJarFileOpen(cpe-&gt;fileName, NULL, &amp;pJarFile, isBootstrap) == 0) &#123;</div><div class="line">            cpe-&gt;kind = kCpeJar;</div><div class="line">            cpe-&gt;ptr = pJarFile;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">    &#125; else if (strcmp(suffix, &quot;dex&quot;) == 0) &#123;</div><div class="line">        RawDexFile* pRawDexFile = NULL;</div><div class="line">        if (dvmRawDexFileOpen(cpe-&gt;fileName, NULL, &amp;pRawDexFile, isBootstrap) == 0) &#123;</div><div class="line">            cpe-&gt;kind = kCpeDex;</div><div class="line">            cpe-&gt;ptr = pRawDexFile;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        ALOGE(&quot;Unknown type suffix &apos;%s&apos;&quot;, suffix);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="dvmRawDexFileOpen"><a href="#dvmRawDexFileOpen" class="headerlink" title="dvmRawDexFileOpen"></a>dvmRawDexFileOpen</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/RawDexFile.cpp#109" target="_blank" rel="external">/dalvik/vm/RawDexFile.cpp</a>.<br>æ‰“å¼€ä¸€ä¸ªåŸç”Ÿdexæ–‡ä»¶ï¼Œä¼˜åŒ–ï¼ŒåŠ è½½ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"> int dvmRawDexFileOpen(const char* fileName, const char* odexOutputName,</div><div class="line">     RawDexFile** ppRawDexFile, bool isBootstrap)</div><div class="line"> &#123;</div><div class="line">    ...</div><div class="line">     dexFd = open(fileName, O_RDONLY);  //æ‰“å¼€æ–‡ä»¶</div><div class="line">     if (dexFd &lt; 0) goto bail;</div><div class="line">     if (odexOutputName == NULL) &#123;  //æ„é€ ä¸€ä¸ªdex cache name</div><div class="line">         cachedName = dexOptGenerateCacheFileName(fileName, NULL);</div><div class="line">         if (cachedName == NULL)</div><div class="line">             goto bail;</div><div class="line">     &#125;</div><div class="line">    ...</div><div class="line">    //æ‰“å¼€cacheä¸­çš„æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰ä¼šæ–°å»ºä¸€ä¸ªï¼Œå¡«å……å¤´éƒ¨ï¼ŒéªŒè¯dependencies</div><div class="line">     optFd = dvmOpenCachedDexFile(fileName, cachedName, modTime,</div><div class="line">         adler32, isBootstrap, &amp;newFile, /*createIfMissing=*/true);</div><div class="line">    //æ–°ç”Ÿæˆä¸€ä¸ªä¼˜åŒ–çš„dex</div><div class="line">     if (newFile) &#123;</div><div class="line">         ...</div><div class="line">         if (result) &#123;     //å†…éƒ¨æ‰§è¡Œäº†system/binç›®å½•ä¸‹çš„dexoptæ–‡ä»¶</div><div class="line">             result = dvmOptimizeDexFile(optFd, dexOffset, fileSize,</div><div class="line">                 fileName, modTime, adler32, isBootstrap);</div><div class="line">         &#125;</div><div class="line">         ...</div><div class="line">     &#125;</div><div class="line">     if (dvmDexFileOpenFromFd(optFd, &amp;pDvmDex) != 0) &#123;</div><div class="line">         ALOGI(&quot;Unable to map cached %s&quot;, fileName);</div><div class="line">         goto bail;</div><div class="line">     &#125;</div><div class="line">     ...</div><div class="line">     *ppRawDexFile = (RawDexFile*) calloc(1, sizeof(RawDexFile));</div><div class="line">     (*ppRawDexFile)-&gt;cacheFileName = cachedName;</div><div class="line">     (*ppRawDexFile)-&gt;pDvmDex = pDvmDex;    //æ–°æ–‡ä»¶çš„æŒ‡é’ˆ</div><div class="line">     cachedName = NULL;      // don&apos;t free it below</div><div class="line">     result = 0;</div><div class="line">...</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="dvmFindRequiredClassesAndMembers"><a href="#dvmFindRequiredClassesAndMembers" class="headerlink" title="dvmFindRequiredClassesAndMembers"></a>dvmFindRequiredClassesAndMembers</h2><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/InitRefs.cpp#481" target="_blank" rel="external">/dalvik/vm/InitRefs.cpp</a> .<br>éå†ç±»åˆ—è¡¨å’Œæˆå‘˜åˆ—è¡¨ï¼Œå°†ä»–ä»¬çš„å¼•ç”¨å­˜å…¥å…¨å±€éå†gDvmä¸­ä»¥ä¾¿æ—¥åå¼•ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Look up the set of classes and members used directly by the VM,</div><div class="line"> * storing references to them into the globals instance. See</div><div class="line"> * Globals.h. This function is exposed so that dex optimization may</div><div class="line"> * call it (while avoiding doing other unnecessary VM initialization).</div><div class="line"> *</div><div class="line"> * The function returns a success flag (true == success).</div><div class="line"> */</div><div class="line">bool dvmFindRequiredClassesAndMembers() &#123;</div><div class="line">    /*</div><div class="line">     * Note: Under normal VM use, this is called by dvmStartup()</div><div class="line">     * in Init.c. For dex optimization, this is called as well, but in</div><div class="line">     * that case, the call is made from DexPrepare.c.</div><div class="line">     */</div><div class="line">    return initClassReferences()</div><div class="line">        &amp;&amp; initFieldOffsets()</div><div class="line">        &amp;&amp; initConstructorReferences()</div><div class="line">        &amp;&amp; initDirectMethodReferences()</div><div class="line">        &amp;&amp; initVirtualMethodOffsets()</div><div class="line">        &amp;&amp; initFinalizerReference()</div><div class="line">        &amp;&amp; verifyStringOffsets();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»…ä»¥initClassReferencesä¸ºä¾‹ã€‚</p>
<h3 id="initClassReferences"><a href="#initClassReferences" class="headerlink" title="initClassReferences"></a>initClassReferences</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/InitRefs.cpp#initClassReferences" target="_blank" rel="external">/dalvik/vm/InitRefs.cpp</a> .<br>åˆå§‹åŒ–ä¸€ä¸‹æ ¸å¿ƒç±»ã€æ•°ç»„ç±»ã€å¼‚å¸¸ç±»çš„å¼•ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">static bool initClassReferences() &#123;</div><div class="line">    ...</div><div class="line">    int i;      //åˆå§‹åŒ–ç±»çš„å¼•ç”¨</div><div class="line">    for (i = 0; classes[i].ref != NULL; i++) &#123;</div><div class="line">        if (!initClassReference(classes[i].ref, classes[i].name)) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="initClassReference"><a href="#initClassReference" class="headerlink" title="initClassReference"></a>initClassReference</h4><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/InitRefs.cpp#24" target="_blank" rel="external">/dalvik/vm/InitRefs.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static bool initClassReference(ClassObject** pClass, const char* name) &#123;</div><div class="line">    ClassObject* result;</div><div class="line">    assert(*pClass == NULL);</div><div class="line">    if (name[0] == &apos;[&apos;) &#123;   //åŸºæœ¬ç±»ç±»å‹çš„æ•°ç»„</div><div class="line">        result = dvmFindArrayClass(name, NULL);</div><div class="line">    &#125; else &#123;    //ç³»ç»Ÿç±»çš„å¼•ç”¨</div><div class="line">        result = dvmFindSystemClassNoInit(name);</div><div class="line">    &#125;</div><div class="line">    if (result == NULL) &#123;</div><div class="line">        ALOGE(&quot;Could not find essential class %s&quot;, name);</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">    *pClass = result;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="dvmFindSystemClassNoInit"><a href="#dvmFindSystemClassNoInit" class="headerlink" title="dvmFindSystemClassNoInit"></a>dvmFindSystemClassNoInit</h4><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#1454" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Find the named class (by descriptor), searching for it in the</div><div class="line"> * bootclasspath.</div><div class="line"> *</div><div class="line"> * On failure, this returns NULL with an exception raised.</div><div class="line"> */</div><div class="line">ClassObject* dvmFindSystemClassNoInit(const char* descriptor)</div><div class="line">&#123;</div><div class="line">    return findClassNoInit(descriptor, NULL, NULL);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="findClassNoInit"><a href="#findClassNoInit" class="headerlink" title="findClassNoInit"></a>findClassNoInit</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#1473" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a><br>é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œå¦‚æœç±»æ²¡æœ‰åŠ è½½ï¼Œæˆ‘ä»¬å°±å»åŠ è½½å¹¶é“¾æ¥ï¼Œä½†æ˜¯ä¸ä¼šæ‰§è¡Œ<clinit>.<br>è¿™é‡Œä¼šè¿”å›ä¸€ä¸ªæ˜¯é€šè¿‡åŠ è½½å¾—åˆ°çš„ç±»è¿˜æ˜¯ç”¨çš„å·²æœ‰çš„ç±»å®šä¹‰çš„æ ‡è¯†ï¼Œä»¥é˜²åœ¨åŒä¸€ä¸ªclass loaderä¸­è¢«åŠ è½½ä¸¤æ¬¡ã€‚</clinit></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">static ClassObject* findClassNoInit(const char* descriptor, Object* loader,</div><div class="line">    DvmDex* pDvmDex)</div><div class="line">&#123;</div><div class="line">    //åœ¨å·²ç»åŠ è½½çš„ç±»åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼ˆhashï¼‰</div><div class="line">    clazz = dvmLookupClass(descriptor, loader, true);</div><div class="line">    if (clazz == NULL) &#123;    //å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„ç±»åˆ‡æ²¡æœ‰ä¼ è¿›dexæ–‡ä»¶çš„å‚æ•°ï¼Œå°±åœ¨dexåˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä¹‹ååŠ è½½dexæ–‡ä»¶ä¸­çš„ç±»</div><div class="line">        const DexClassDef* pClassDef;</div><div class="line">        ...</div><div class="line">        if (pDvmDex == NULL) &#123;</div><div class="line">            assert(loader == NULL);     /* shouldn&apos;t be here otherwise */</div><div class="line">            pDvmDex = searchBootPathForClass(descriptor, &amp;pClassDef); //åœ¨dexåˆ—è¡¨ä¸­æŸ¥æ‰¾</div><div class="line">        &#125; else &#123;    //åœ¨æä¾›çš„dexæ–‡ä»¶ä¸­æŸ¥æ‰¾</div><div class="line">            pClassDef = dexFindClass(pDvmDex-&gt;pDexFile, descriptor);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        /* found a match, try to load it */</div><div class="line">        clazz = loadClassFromDex(pDvmDex, pClassDef, loader);   //åŠ è½½dexï¼</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="loadClassFromDex"><a href="#loadClassFromDex" class="headerlink" title="loadClassFromDex"></a>loadClassFromDex</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#1953" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a>.<br>ä»æŒ‡å®šçš„dexæ–‡ä»¶ä¸­åŠ è½½æŒ‡å®šçš„ç±»ã€‚æ­¤å‡½æ•°ç›¸å½“äºloadClass()+defineClass().</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Try to load the indicated class from the specified DEX file.</div><div class="line"> *</div><div class="line"> * This is effectively loadClass()+defineClass() for a DexClassDef.  The</div><div class="line"> * loading was largely done when we crunched through the DEX.</div><div class="line"> *</div><div class="line"> * Returns NULL on failure.  If we locate the class but encounter an error</div><div class="line"> * while processing it, an appropriate exception is thrown.</div><div class="line"> */</div><div class="line">static ClassObject* loadClassFromDex(DvmDex* pDvmDex,</div><div class="line">    const DexClassDef* pClassDef, Object* classLoader)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    pDexFile = pDvmDex-&gt;pDexFile;</div><div class="line">    //é€šè¿‡pClassDefå¾—åˆ°class_data_itemæŒ‡é’ˆ</div><div class="line">    pEncodedData = dexGetClassData(pDexFile, pClassDef);</div><div class="line">    if (pEncodedData != NULL) &#123;</div><div class="line">        dexReadClassDataHeader(&amp;pEncodedData, &amp;header);</div><div class="line">    &#125; else &#123;</div><div class="line">        // Provide an all-zeroes header for the rest of the loading.</div><div class="line">        memset(&amp;header, 0, sizeof(header));</div><div class="line">    &#125;</div><div class="line">    //é€šè¿‡å¤´éƒ¨æ•°æ®å’Œclass_data_itemå¾—åˆ°å…¶ä»–çš„æ•°æ®</div><div class="line">    result = loadClassFromDex0(pDvmDex, pClassDef, &amp;header, pEncodedData,</div><div class="line">            classLoader);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="loadClassFromDex0"><a href="#loadClassFromDex0" class="headerlink" title="loadClassFromDex0"></a>loadClassFromDex0</h3><p>ä½äº<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Class.cpp#1727" target="_blank" rel="external">/dalvik/vm/oo/Class.cpp</a>.<br>é€šè¿‡å¤´éƒ¨æ•°æ®å’Œclass_data_itemï¼Œè¿”å›ä¸€ä¸ªclassçš„å…¨éƒ¨æ•°æ®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">static ClassObject* loadClassFromDex0(DvmDex* pDvmDex,</div><div class="line">    const DexClassDef* pClassDef, const DexClassDataHeader* pHeader,</div><div class="line">    const u1* pEncodedData, Object* classLoader)</div><div class="line">&#123;</div><div class="line">    ClassObject* newClass = NULL;</div><div class="line">    descriptor = dexGetClassDescriptor(pDexFile, pClassDef);</div><div class="line">    newClass-&gt;descriptor = descriptor; //æè¿°ç¬¦</div><div class="line">    SET_CLASS_FLAG(newClass, pClassDef-&gt;accessFlags);   //æƒé™æ ‡è¯†</div><div class="line">    newClass-&gt;pDvmDex = pDvmDex;</div><div class="line">    newClass-&gt;primitiveType = PRIM_NOT;</div><div class="line">    newClass-&gt;status = CLASS_IDX;</div><div class="line">    ...</div><div class="line">    newClass-&gt;super = (ClassObject*) pClassDef-&gt;superclassIdx;  //çˆ¶ç±»</div><div class="line">    ....</div><div class="line">    ....</div><div class="line">    newClass-&gt;sourceFile = dexGetSourceFile(pDexFile, pClassDef);   //æºæ–‡ä»¶</div><div class="line">    /* caller must call dvmReleaseTrackedAlloc */</div><div class="line">    return newClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è™šæ‹Ÿæœºåˆ›å»ºåå¼€å§‹åˆå§‹åŒ–ï¼Œå…¶ä¸­ä¸€æ­¥å°±æ˜¯åˆå§‹åŒ–ç±»çš„å¼•ç”¨ï¼Œç±»æˆå‘˜çš„å¼•ç”¨ã€‚</p>
<p>åœ¨åˆå§‹åŒ–æ–‡ä»¶ç»“æ„ä½“çš„å¼•ç”¨æ—¶ï¼Œè™šæ‹Ÿæœºæ ¹æ®å…¨å±€å˜é‡gDvmä¸­çš„å¯åŠ¨ç±»è·¯å¾„æ¥ä¸ºæ¯ä¸ªç±»ç”Ÿæˆä¸€ä¸ªClassPathEntryçš„ç»“æ„ä½“å¼•ç”¨ï¼Œå¤„ç†çš„è¿‡ç¨‹ä¸­ä¸ºå‹ç¼©æ–‡ä»¶/dexè°ƒç”¨äº†ä¸åŒçš„å‡½æ•°ï¼Œ<br>å¤„ç†dexæ–‡ä»¶æ—¶é¡ºä¾¿å¯¹é½è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç”Ÿæˆäº†odexæ–‡ä»¶ã€‚(å½“ç„¶4.4ä¹‹åç”±äºé‡‡ç”¨äº†ARTä»£æ›¿dalvikï¼Œä¼˜åŒ–åçš„æ–‡ä»¶æ ¼å¼åº”ä¸ºelf)ã€‚</p>
<p>åœ¨åˆå§‹åŒ–ç±»ä¸­æ•°æ®çš„å¼•ç”¨æ—¶ï¼Œå…ˆæ˜¯åœ¨å·²ç»åŠ è½½çš„ç±»åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å†é€ä¸ªçš„å¯¹dexè¿›è¡Œè§£å‰–æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç›¸åº”çš„dexåï¼ŒåŠ è½½è¿™ä¸ªdexæ–‡ä»¶è§£æå…¨éƒ¨æ•°æ®ã€‚</p>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://androidxref.com/4.4.4_r1/" target="_blank" rel="external">Androidåœ¨çº¿æºç </a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8885792" target="_blank" rel="external">Dalvikè™šæ‹Ÿæœºçš„å¯åŠ¨è¿‡ç¨‹åˆ†æ</a><br><a href="http://www.cnblogs.com/jacobchen/p/3599483.html" target="_blank" rel="external">Dalvikçš„BOOTCLASSPATHå’Œdexoptæµç¨‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
            <tag> dalvik </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[smali è¯­æ³• - å†…éƒ¨ç±»å’Œæ³¨è§£ç±»]]></title>
      <url>/2015/11/27/smali-grammar-special-classes/</url>
      <content type="html"><![CDATA[<blockquote>
<p>æœ¬æ–‡ç¯å¢ƒ<br><code>java version &quot;1.7.0_75&quot;</code><br><code>dx version 1.11</code><br><code>baksmali 2.1.0</code></p>
</blockquote>
<a id="more"></a>
<h1 id="çŸ¥è¯†é¢„å¤‡"><a href="#çŸ¥è¯†é¢„å¤‡" class="headerlink" title="çŸ¥è¯†é¢„å¤‡"></a>çŸ¥è¯†é¢„å¤‡</h1><h2 id="ç³»ç»Ÿæ³¨è§£"><a href="#ç³»ç»Ÿæ³¨è§£" class="headerlink" title="ç³»ç»Ÿæ³¨è§£"></a>ç³»ç»Ÿæ³¨è§£</h2><p>ç³»ç»Ÿæ³¨è§£ç”¨æ¥è¡¨ç¤ºjavaåå°„ç›¸å…³çš„ä¿¡æ¯ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ã€‚<br>å­˜åœ¨äº .dex æ–‡ä»¶annotationéƒ¨åˆ†ï¼Œåªåœ¨è¿è¡Œæ—¶ç³»ç»Ÿå¯è§ã€‚<br>æºç åœ¨ /libcore/dalvik/src/main/java/dalvik/annotation/ ç›®å½•ä¸‹.</p>
<h3 id="AnnotationDefault"><a href="#AnnotationDefault" class="headerlink" title="AnnotationDefault"></a>AnnotationDefault</h3><p>æ³¨è§£ç±»çš„é»˜è®¤æ³¨è§£ç±»ï¼Œå¦‚æœæŒ‡å®šäº†é»˜è®¤å€¼ï¼Œæ­¤æ³¨è§£ç±»å°±ä¼šå‡ºç°ã€‚</p>
<h3 id="EnclosingClass"><a href="#EnclosingClass" class="headerlink" title="EnclosingClass"></a>EnclosingClass</h3><p>å‡ºç°åœ¨å†…éƒ¨ç±»ä¸­ï¼ŒæŒ‡å®šè¯¥ å†…éƒ¨ç±»/åŒ¿åå†…éƒ¨ç±» æ‰€åœ¨çš„æœ€è¿‘çš„å¤–éƒ¨ç±»ï¼Œæ­¤æ³¨è§£ç±»å¿…é¡»å’ŒInnerClassæ³¨è§£ç±»ä¸€åŒå‡ºç°,ä¸èƒ½å’ŒEnclosingMethodä¸€åŒå‡ºç°ã€‚</p>
<h3 id="EnclosingMethod"><a href="#EnclosingMethod" class="headerlink" title="EnclosingMethod"></a>EnclosingMethod</h3><p>å‡ºç°åœ¨å†…éƒ¨ç±»ä¸­ï¼ŒæŒ‡å®šè¯¥å†…éƒ¨ç±»æ‰€åœ¨çš„æœ€è¿‘çš„å¤–éƒ¨å‡½æ•°ï¼Œæ­¤æ³¨è§£ç±»å¿…é¡»å’ŒInnerClassæ³¨è§£ç±»ä¸€åŒå‡ºç°,ä¸èƒ½å’ŒEnclosingClassä¸€åŒå‡ºç°ã€‚</p>
<h3 id="InnerClass"><a href="#InnerClass" class="headerlink" title="InnerClass"></a>InnerClass</h3><p>å‡ºç°åœ¨å†…éƒ¨ç±»ä¸­ï¼Œæä¾›å†…éƒ¨ç±»çš„åå­—(ä¸åŒ…æ‹¬åŒ…å,åŒ¿åå†…éƒ¨ç±»å€¼ä¸ºnull)å’Œè®¿é—®æƒé™(åŒç±»çš„è®¿é—®æƒé™)ã€‚<br>è¯¥æ³¨è§£ç±»éœ€å’ŒEnclosingMethodæˆ–EnclosingClassä¹‹ä¸€ä¸€åŒå‡ºç°ã€‚</p>
<h3 id="MemberClasses"><a href="#MemberClasses" class="headerlink" title="MemberClasses"></a>MemberClasses</h3><p>å‡ºç°åœ¨å…·æœ‰å†…éƒ¨ç±»çš„ç±»ä¸­ï¼Œæä¾›ç›´æ¥å†…éƒ¨ç±»(ä¸åŒ…å«åµŒå¥—)çš„ç±»ååˆ—è¡¨ã€‚</p>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>å‡ºç°ç”±æ›´å¤æ‚çš„ç±»å‹å®šä¹‰çš„ç±»ã€å­—æ®µæˆ–è€…æ–¹æ³•ä¸­ï¼Œdexæ–‡ä»¶ä¸å®šä¹‰signatureçš„æ ¼å¼ï¼Œæ­¤æ³¨è§£ç±»åªæ˜¯æŒ‡å®š<code>æºè¯­è¨€èƒ½å¤Ÿå®ç°å…¶è¯­ä¹‰</code>çš„ç›¸åº”çš„signatureã€‚<br>å› æ­¤ï¼Œsignatureå¹¶ä¸èƒ½è¢«è§£ææˆ–è¿™éªŒè¯ï¼Œåªèƒ½è¢«é«˜ä¸€çº§çš„APIæˆ–è€…å·¥å…·(å¦‚è°ƒè¯•å™¨)æ¥ç®¡ã€‚<br>signatureä»¥å­—ç¬¦ä¸²æ•°ç»„çš„å½¢å¼å­˜åœ¨ï¼Œä½¿ç”¨çš„æ—¶å€™æ‹¼æ¥ã€‚åªæœ‰ç¼–è¯‘å·¥å…·æ‰èƒ½å°†ä¸€ä¸ªå®Œæ•´çš„signatureåˆ†æˆå‡ ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<h3 id="Throws"><a href="#Throws" class="headerlink" title="Throws"></a>Throws</h3><p>ä»¥æ•°ç»„å½¢å¼æŒ‡å®šæŸä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ã€‚</p>
<h1 id="å†…éƒ¨ç±»"><a href="#å†…éƒ¨ç±»" class="headerlink" title="å†…éƒ¨ç±»"></a>å†…éƒ¨ç±»</h1><p>java åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šä¸ºæ¯ä¸ªç±»ç”Ÿæˆä¸€ä¸ªclassæ–‡ä»¶ï¼Œå†…éƒ¨ç±»çš„æ ¼å¼ä¸º <code>[å¤–éƒ¨ç±»]$[å†…éƒ¨ç±»].class</code>.</p>
<h2 id="java-ä»£ç "><a href="#java-ä»£ç " class="headerlink" title="java ä»£ç "></a>java ä»£ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class HeyInnerclass</div><div class="line">&#123;</div><div class="line">    class Inner1&#123;</div><div class="line">        class Inner1_1&#123;&#125;</div><div class="line">    &#125;</div><div class="line">    class Inner2&#123;&#125;</div><div class="line">    private void func()&#123;</div><div class="line">        class InnerFun&#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="smali-ä»£ç "><a href="#smali-ä»£ç " class="headerlink" title="smali ä»£ç "></a>smali ä»£ç </h2><p>ä»¥ä¸‹ä»…ä¸ºéƒ¨åˆ†ç›¸å…³ä»£ç ã€‚</p>
<h3 id="HeyInnerclass"><a href="#HeyInnerclass" class="headerlink" title="HeyInnerclass"></a>HeyInnerclass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># annotations   //æ³¨è§£ç±»MemberClasses</div><div class="line">.annotation system Ldalvik/annotation/MemberClasses;</div><div class="line">    value = &#123;</div><div class="line">        LHeyInnerclass$Inner2;,</div><div class="line">        LHeyInnerclass$Inner1;</div><div class="line">    &#125;</div><div class="line">.end annotation</div><div class="line">.method private func()V</div><div class="line">    .registers 1</div><div class="line">    .prologue</div><div class="line">    .line 18</div><div class="line">    return-void</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>HeyInnerclass ä¸­æœ‰ HeyInnerclass$Inner2 å’Œ HeyInnerclass$Inner1 ä¸¤ä¸ªç±»ï¼<br>func æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ä»»ä½•å®ç°è¿˜æ˜¯å ç”¨äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨è¡¨ç¤ºè‡ªèº«(this)çš„å¼•ç”¨ã€‚</p>
<h3 id="Inner1"><a href="#Inner1" class="headerlink" title="Inner1"></a>Inner1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"># annotations   //æ³¨è§£ç±» EnclosingClass</div><div class="line">.annotation system Ldalvik/annotation/EnclosingClass;</div><div class="line">    value = LHeyInnerclass;</div><div class="line">.end annotation</div><div class="line">//æ³¨è§£ç±» InnerClass</div><div class="line">.annotation system Ldalvik/annotation/InnerClass;</div><div class="line">    accessFlags = 0x0</div><div class="line">    name = &quot;Inner1&quot;</div><div class="line">.end annotation</div><div class="line">//æ³¨è§£ç±» MemberClasses</div><div class="line">.annotation system Ldalvik/annotation/MemberClasses;</div><div class="line">    value = &#123;</div><div class="line">        LHeyInnerclass$Inner1$Inner1_1;</div><div class="line">    &#125;</div><div class="line">.end annotation</div><div class="line"># instance fields   //å£°æ˜å­—æ®µthis$0</div><div class="line">.field final synthetic this$0:LHeyInnerclass;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;(LHeyInnerclass;)V</div><div class="line">    .registers 2</div><div class="line">    .prologue</div><div class="line">    .line 3     //åˆå§‹åŒ–å­—æ®µ this$0</div><div class="line">    iput-object p1, p0, LHeyInnerclass$Inner1;-&gt;this$0:LHeyInnerclass;</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    .line 5</div><div class="line">    return-void</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>Inner1 ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±» HeyInnerclass$Inner1$Inner1_1ï¼Œæ‰€åœ¨çš„å¤–éƒ¨ç±»æ˜¯ HeyInnerclassï¼Œåå­—æ˜¯ Inner1ï¼Œè®¿é—®æƒé™ 0x0.<br><code>this$0</code> æ˜¯ HeyInnerclass ç±»å‹çš„ï¼Œæ˜¯å†…éƒ¨ç±»çš„ä¿ç•™çš„å¯¹æ‰€åœ¨çš„å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œthisè¡¨ç¤ºçˆ¶ç±»çš„å¼•ç”¨ï¼Œ0è¡¨ç¤ºå¼•ç”¨çš„å±‚æ•°ã€‚<br><code>synthetic</code>è¡¨ç¤ºè¿™æ˜¯åˆæˆçš„ï¼Œç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ï¼Œä¸æ˜¯å†™å‡ºæ¥çš„ã€‚</p>
<p>Inner2 ä¸ Inner1 é™¤äº†æ²¡æœ‰å­—èŠ‚çš„å†…éƒ¨ç±»å¤–å…¶ä½™åŸºæœ¬ä¸€è‡´ï¼Œä»£ç å°±ä¸è´´äº†ã€‚</p>
<h3 id="Inner1-1"><a href="#Inner1-1" class="headerlink" title="Inner1_1"></a>Inner1_1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># annotations   #æ³¨è§£ç±»</div><div class="line">.annotation system Ldalvik/annotation/EnclosingClass;</div><div class="line">    value = LHeyInnerclass$Inner1;</div><div class="line">.end annotation</div><div class="line">.annotation system Ldalvik/annotation/InnerClass;   #æ³¨è§£ç±»</div><div class="line">    accessFlags = 0x0</div><div class="line">    name = &quot;Inner1_1&quot;</div><div class="line">.end annotation</div><div class="line"># instance fields</div><div class="line">.field final synthetic this$1:LHeyInnerclass$Inner1;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;(LHeyInnerclass$Inner1;)V</div><div class="line">    .registers 2</div><div class="line">    .prologue</div><div class="line">    .line 5</div><div class="line">    iput-object p1, p0, LHeyInnerclass$Inner1$Inner1_1;-&gt;this$1:LHeyInnerclass$Inner1;</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    return-void</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>Inner1_1 åå­—æ˜¯ Inner1_1,è®¿é—®æƒé™ä¸º0x0,æ‰€åœ¨çš„å¤–éƒ¨ç±»æ˜¯HeyInnerclass$Inner1,<br>å¯¹å¤–éƒ¨ç±»çš„çš„å¼•ç”¨æ˜¯ this$1ï¼Œç±»å‹æ˜¯ HeyInnerclass$Inner1ï¼Œ1è¡¨ç¤ºå¼•ç”¨å±‚æ•°æ·±äº†ä¸€å±‚ã€‚</p>
<h3 id="InnerFun"><a href="#InnerFun" class="headerlink" title="InnerFun"></a>InnerFun</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># annotations   #æ³¨è§£ç±»</div><div class="line">.annotation system Ldalvik/annotation/EnclosingMethod;</div><div class="line">    value = LHeyInnerclass;-&gt;func()V</div><div class="line">.end annotation</div><div class="line">.annotation system Ldalvik/annotation/InnerClass;   #æ³¨è§£ç±»</div><div class="line">    accessFlags = 0x0</div><div class="line">    name = &quot;InnerFun&quot;</div><div class="line">.end annotation</div><div class="line"># instance fields   #å¼•ç”¨å­—æ®µ</div><div class="line">.field final synthetic this$0:LHeyInnerclass;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;(LHeyInnerclass;)V</div><div class="line">    .registers 2</div><div class="line">    .prologue</div><div class="line">    .line 17</div><div class="line">    iput-object p1, p0, LHeyInnerclass$1InnerFun;-&gt;this$0:LHeyInnerclass;</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    return-void</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>InnerFunçš„åå­—æ˜¯InnerFun,è®¿é—®æƒé™æ˜¯0x0ï¼Œæ‰€åœ¨çš„æ–¹æ³•æ˜¯ LHeyInnerclass;-&gt;func()V .<br>å¯¹å¤–éƒ¨ç±»çš„å¼•ç”¨æ˜¯ this$0,ç±»å‹æ˜¯ HeyInnerclass,å¼•ç”¨å±‚æ•°ä¸º0.</p>
<hr>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> smali </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[smali è¯­æ³• - iterator & switch-case & try-catch]]></title>
      <url>/2015/11/26/smali-grammar-iterator-switch/</url>
      <content type="html"><![CDATA[<blockquote>
<p>æœ¬æ–‡ç¯å¢ƒ<br><code>java version &quot;1.7.0_75&quot;</code><br><code>dx version 1.11</code><br><code>baksmali 2.1.0</code></p>
</blockquote>
<a id="more"></a>
<h1 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a>iterator</h1><p>ï¼ˆfor å’Œ while-do ä¸¤ç§å½¢å¼ï¼‰</p>
<h2 id="java-ä»£ç "><a href="#java-ä»£ç " class="headerlink" title="java ä»£ç "></a>java ä»£ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line">class HeyIterator</div><div class="line">&#123;</div><div class="line">    static void iter_for()</div><div class="line">    &#123;</div><div class="line">        ArrayList al = new ArrayList();</div><div class="line">        al.add(&quot;C&quot;);</div><div class="line">        for( Iterator itr = al.iterator(); itr.hasNext(); )&#123;</div><div class="line">            System.out.print(itr.next());</div><div class="line">        &#125;</div><div class="line">        Iterator itr2 = al.iterator();</div><div class="line">        while(itr2.hasNext()) &#123;</div><div class="line">            System.out.print(itr2.next());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="smali-ä»£ç "><a href="#smali-ä»£ç " class="headerlink" title="smali ä»£ç "></a>smali ä»£ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">.class LHeyIterator;</div><div class="line">.super Ljava/lang/Object;</div><div class="line">.source &quot;HeyIterator.java&quot;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;()V</div><div class="line">    .registers 1</div><div class="line">    .prologue</div><div class="line">    .line 3</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    return-void</div><div class="line">.end method</div><div class="line">.method static iter_for()V</div><div class="line">    .registers 4</div><div class="line">    .prologue</div><div class="line">    .line 7</div><div class="line">    new-instance v0, Ljava/util/ArrayList;</div><div class="line">    invoke-direct &#123;v0&#125;, Ljava/util/ArrayList;-&gt;&lt;init&gt;()V</div><div class="line">    .line 8</div><div class="line">    const-string v1, &quot;C&quot;</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/util/ArrayList;-&gt;add(Ljava/lang/Object;)Z</div><div class="line">    .line 10    //å¾—åˆ°è¿­ä»£å™¨</div><div class="line">    invoke-virtual &#123;v0&#125;, Ljava/util/ArrayList;-&gt;iterator()Ljava/util/Iterator;</div><div class="line">    move-result-object v1</div><div class="line">    :goto_e     //åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ </div><div class="line">    invoke-interface &#123;v1&#125;, Ljava/util/Iterator;-&gt;hasNext()Z</div><div class="line">    move-result v2</div><div class="line">    if-eqz v2, :cond_1e</div><div class="line">    .line 11</div><div class="line">    sget-object v2, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-interface &#123;v1&#125;, Ljava/util/Iterator;-&gt;next()Ljava/lang/Object;</div><div class="line">    move-result-object v3</div><div class="line">    invoke-virtual &#123;v2, v3&#125;, Ljava/io/PrintStream;-&gt;print(Ljava/lang/Object;)V</div><div class="line">    goto :goto_e    //è·³è‡³å¾ªç¯å¤´éƒ¨</div><div class="line">//--------------åˆ†å‰²çº¿---------------------</div><div class="line">    .line 14</div><div class="line">    :cond_1e    //å¾—åˆ°è¿­ä»£å™¨</div><div class="line">    invoke-virtual &#123;v0&#125;, Ljava/util/ArrayList;-&gt;iterator()Ljava/util/Iterator;</div><div class="line">    move-result-object v0</div><div class="line">    .line 15</div><div class="line">    :goto_22    //åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ </div><div class="line">    invoke-interface &#123;v0&#125;, Ljava/util/Iterator;-&gt;hasNext()Z</div><div class="line">    move-result v1</div><div class="line">    if-eqz v1, :cond_32</div><div class="line">    .line 16</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-interface &#123;v0&#125;, Ljava/util/Iterator;-&gt;next()Ljava/lang/Object;</div><div class="line">    move-result-object v2</div><div class="line">    invoke-virtual &#123;v1, v2&#125;, Ljava/io/PrintStream;-&gt;print(Ljava/lang/Object;)V</div><div class="line">    goto :goto_22   //è·³è‡³å¾ªç¯å¤´éƒ¨</div><div class="line">    .line 18</div><div class="line">    :cond_32</div><div class="line">    return-void</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p><strong>ä¸¤ç§æ–¹å¼å®Œå…¨ä¸€æ ·å•Š</strong></p>
<hr>
<h1 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h1><h2 id="java-ä»£ç -1"><a href="#java-ä»£ç -1" class="headerlink" title="java ä»£ç "></a>java ä»£ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line">class HeySwitch</div><div class="line">&#123;</div><div class="line">    static void func()</div><div class="line">    &#123;</div><div class="line">        int a = 10;</div><div class="line">        //è¿ç»­çš„case</div><div class="line">        switch(a)&#123;</div><div class="line">            case 0:</div><div class="line">                System.out.println(0);</div><div class="line">            case 1:</div><div class="line">                System.out.println(1);</div><div class="line">            case 2:</div><div class="line">                System.out.println(2);</div><div class="line">            case 3:</div><div class="line">                System.out.println(3);</div><div class="line">        &#125;</div><div class="line">        //ä¸è¿ç»­çš„case</div><div class="line">        switch(a)&#123;</div><div class="line">            case 0:</div><div class="line">                System.out.println(0);</div><div class="line">            case 32:</div><div class="line">                System.out.println(32);</div><div class="line">            case 64:</div><div class="line">                System.out.println(64);</div><div class="line">            case 128:</div><div class="line">                System.out.println(128);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="smali-ä»£ç -1"><a href="#smali-ä»£ç -1" class="headerlink" title="smali ä»£ç "></a>smali ä»£ç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">.class LHeySwitch;</div><div class="line">.super Ljava/lang/Object;</div><div class="line">.source &quot;HeySwitch.java&quot;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;()V</div><div class="line">    .registers 1</div><div class="line">    .prologue</div><div class="line">    .line 3</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    return-void</div><div class="line">.end method</div><div class="line">.method static func()V</div><div class="line">    .registers 4</div><div class="line">    .prologue</div><div class="line">    const/4 v3, 0x0</div><div class="line">    .line 7</div><div class="line">    const/16 v0, 0xa</div><div class="line">    .line 8     //ç¬¬ä¸€ä¸ªswitchçš„packedçŸ©é˜µï¼ŒæŒ‡ä»¤æ ¼å¼ packed-switch vAA, +BBBBBBBB</div><div class="line">    packed-switch v0, :pswitch_data_3e</div><div class="line">    .line 19</div><div class="line">    :goto_6     //ç¬¬äºŒä¸ªswitchçš„sparseçŸ©é˜µï¼ŒæŒ‡ä»¤æ ¼å¼ sparse-switch vAA, +BBBBBBBB</div><div class="line">    sparse-switch v0, :sswitch_data_4a</div><div class="line">    .line 30</div><div class="line">    :goto_9         //å‡½æ•°ç»“æŸ</div><div class="line">    return-void</div><div class="line">//------------åˆ†å‰²çº¿-----------</div><div class="line">    .line 10</div><div class="line">    :pswitch_a</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-virtual &#123;v1, v3&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 12</div><div class="line">    :pswitch_f</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/4 v2, 0x1</div><div class="line">    invoke-virtual &#123;v1, v2&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 14</div><div class="line">    :pswitch_15</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/4 v2, 0x2</div><div class="line">    invoke-virtual &#123;v1, v2&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 16</div><div class="line">    :pswitch_1b</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/4 v2, 0x3</div><div class="line">    invoke-virtual &#123;v1, v2&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    goto :goto_6</div><div class="line">    //------------åˆ†å‰²çº¿-----------</div><div class="line">    .line 21</div><div class="line">    :sswitch_22</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-virtual &#123;v0, v3&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 23</div><div class="line">    :sswitch_27</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/16 v1, 0x20</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 25</div><div class="line">    :sswitch_2e</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/16 v1, 0x40</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    .line 27</div><div class="line">    :sswitch_35</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const/16 v1, 0x80</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(I)V</div><div class="line">    goto :goto_9</div><div class="line">//------------åˆ†å‰²çº¿-----------</div><div class="line">    .line 8</div><div class="line">    nop</div><div class="line">    :pswitch_data_3e    //ç¬¬ä¸€ä¸ªçŸ©é˜µ</div><div class="line">    .packed-switch 0x0  //åˆå§‹å€¼ä¸º0ï¼Œä¾æ¬¡é€’å¢</div><div class="line">        :pswitch_a</div><div class="line">        :pswitch_f</div><div class="line">        :pswitch_15</div><div class="line">        :pswitch_1b</div><div class="line">    .end packed-switch</div><div class="line">    .line 19</div><div class="line">    :sswitch_data_4a    //ç¬¬äºŒä¸ªçŸ©é˜µ</div><div class="line">    .sparse-switch      //æ²¡æœ‰è§„å®šåˆå§‹å€¼ï¼Œè€Œæ˜¯æ¯ä¸ªå€¼å¯¹åº”ç›¸åº”çš„ä»£ç </div><div class="line">        0x0 -&gt; :sswitch_22</div><div class="line">        0x20 -&gt; :sswitch_27</div><div class="line">        0x40 -&gt; :sswitch_2e</div><div class="line">        0x80 -&gt; :sswitch_35</div><div class="line">    .end sparse-switch</div><div class="line">.end method</div></pre></td></tr></table></figure>
<h3 id="switch-æŒ‡ä»¤æ ¼å¼"><a href="#switch-æŒ‡ä»¤æ ¼å¼" class="headerlink" title="switch æŒ‡ä»¤æ ¼å¼"></a>switch æŒ‡ä»¤æ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">packed-switch vAA, +BBBBBBBB</div><div class="line">sparse-switch vAA, +BBBBBBBB</div></pre></td></tr></table></figure>
<p><code>AA</code> è¡¨ç¤ºè¦åˆ¤æ–­çš„å€¼<br><code>BBBB</code> è¡¨ç¤ºç›¸åº” switch-payload çš„åç§»</p>
<h3 id="ä¸¤ç§-switch-payload-çš„æ ¼å¼"><a href="#ä¸¤ç§-switch-payload-çš„æ ¼å¼" class="headerlink" title="ä¸¤ç§ switch-payload çš„æ ¼å¼"></a>ä¸¤ç§ switch-payload çš„æ ¼å¼</h3><p><strong>(1) packed-switch-payload format</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ident</td>
<td>ushort = 0x0100</td>
<td>å›ºå®šå€¼</td>
</tr>
<tr>
<td>size</td>
<td>ushort</td>
<td>å…¥å£çš„ä¸ªæ•°</td>
</tr>
<tr>
<td>first_key</td>
<td>int</td>
<td>ç¬¬ä¸€ä¸ªswitchçš„å€¼ï¼ˆæœ€å°çš„ï¼‰</td>
</tr>
<tr>
<td>targets</td>
<td>int[]</td>
<td>æ¯ä¸ªcaseç›¸å¯¹äºswitchæŒ‡ä»¤çš„åç§»ï¼Œè€Œéæ­¤çŸ©é˜µ</td>
</tr>
</tbody>
</table>
<p><strong>(2) sparse-switch-payload format</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ident</td>
<td>ushort = 0x0200</td>
<td>å›ºå®šå€¼</td>
</tr>
<tr>
<td>size</td>
<td>ushort</td>
<td>å…¥å£çš„ä¸ªæ•°</td>
</tr>
<tr>
<td>keys</td>
<td>int[]</td>
<td>caseçš„å€¼ï¼Œä»ä½åˆ°é«˜</td>
</tr>
<tr>
<td>targets</td>
<td>int[]</td>
<td>æ¯ä¸ªcaseç›¸å¯¹äºswitchæŒ‡ä»¤çš„åç§»ï¼Œè€Œéæ­¤çŸ©é˜µ</td>
</tr>
</tbody>
</table>
<h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><p>ç”±<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>å¯å¾—<br><code>packed-switch</code> çš„ opcode ä¸º <code>2b</code>ï¼Œ<code>sparse-switch</code> çš„ opcode ä¸º <code>2c</code> .<br>åœ¨16è¿›åˆ¶ç¼–è¾‘å™¨ä¸­æœç´¢ <code>2b</code>ï¼Œå¯å¾—ä¸¤æ¡ switch çš„ä½ç½®(0x146, 0x14c)ï¼Œä» smali ä»£ç ä¸­ä¹Ÿèƒ½çœ‹å‡ºä»–ä»¬æ˜¯ç›¸é‚»çš„ã€‚ï¼ˆå½“ç„¶è¿™ä¸€æ­¥å¯ç”¨idaç›´æ¥æœç´¢packed-swtchæ›´æ–¹ä¾¿ï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">00000140  .. .. .. .. .. .. 2b 00  3b 00 00 00 2c 00 44 00  |......+.;...,.D.|</div><div class="line">00000150  00 00</div></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸€æ¡ç¿»è¯‘ä¸ºï¼š<code>packed-switch v0,146h+2*3bh</code>,å¾—çŸ©é˜µçš„åç§»ä¸º 0x1bc.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">000001b0  .. .. .. .. .. .. .. .. .. .. .. ..  00 01 04 00  |..n ....(.......|</div><div class="line">000001c0  00 00 00 00 07 00 00 00  0c 00 00 00 12 00 00 00  |................|</div><div class="line">000001d0  18 00 00 00</div></pre></td></tr></table></figure></p>
<p><code>ident</code>: 0x0100<br><code>size</code>: 0x04<br><code>first_key</code>: 0x0<br><code>targets</code>: 0x07, 0x0c, 0x12, 0x18<br>å¦‚ï¼š0x146+2*0x07=0x154 å³ä¸º case 0 å¯¹åº”çš„ä»£ç åœ°å€ã€‚</p>
<p>ç¬¬äºŒæ¡ç¿»è¯‘ä¸ºï¼š<code>sparse-switch v0,14ch+2*44h</code>,å¾—çŸ©é˜µçš„åç§»ä¸º 0x1d4.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">000001d0  .. .. .. .. 00 02 04 00  00 00 00 00 20 00 00 00  |............ ...|</div><div class="line">000001e0  40 00 00 00 80 00 00 00  1c 00 00 00 21 00 00 00  |@...........!...|</div><div class="line">000001f0  28 00 00 00 2f 00 00 00</div></pre></td></tr></table></figure></p>
<p><code>ident</code>: 0x0200<br><code>size</code>: 0x04<br><code>keys</code>: 0x00, 0x02, 0x04, 0x08<br><code>targets</code>: 0x1c, 0x21, 0x28, 0x2f<br>å¦‚ï¼š0x14c+2*0x1c=0x184 å³ä¸º case 0 å¯¹åº”çš„ä»£ç åœ°å€ã€‚</p>
<hr>
<h1 id="try"><a href="#try" class="headerlink" title="try"></a>try</h1><h2 id="java-ä»£ç ï¼š"><a href="#java-ä»£ç ï¼š" class="headerlink" title="java ä»£ç ï¼š"></a>java ä»£ç ï¼š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">import java.util.*;</div><div class="line">class HeyTry</div><div class="line">&#123;</div><div class="line">    public static void func()</div><div class="line">    &#123;</div><div class="line">        try&#123;</div><div class="line">            int a = 10/0;</div><div class="line">        &#125;</div><div class="line">        catch(ArithmeticException e)&#123;   //å…±æœ‰ä¸‰ä¸ªè¿™æ ·çš„å¼‚å¸¸</div><div class="line">            System.out.println(&quot;zero error.&quot;);</div><div class="line">        &#125;</div><div class="line">        try&#123;</div><div class="line">            int a = 0;</div><div class="line">            int b = 10/a;</div><div class="line">        &#125;</div><div class="line">        catch(ArithmeticException e)&#123;</div><div class="line">            System.out.println(&quot;zero error.&quot;);</div><div class="line">        &#125;</div><div class="line">        catch(Exception e)&#123;</div><div class="line">            System.out.println(e);</div><div class="line">        &#125;</div><div class="line">        try&#123;</div><div class="line">            int a = 0;</div><div class="line">            try&#123;</div><div class="line">                int b = 10/a;</div><div class="line">            &#125;</div><div class="line">            catch(ArithmeticException e)&#123;</div><div class="line">                System.out.println(&quot;zero error.&quot;);</div><div class="line">            &#125;</div><div class="line">            int[] ar = &#123;0,0&#125;;</div><div class="line">            int c = ar[2];</div><div class="line">        &#125;</div><div class="line">        catch(Exception e)&#123;</div><div class="line">            System.out.println(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="smali-ä»£ç ï¼š"><a href="#smali-ä»£ç ï¼š" class="headerlink" title="smali ä»£ç ï¼š"></a>smali ä»£ç ï¼š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">.class LHeyTry;</div><div class="line">.super Ljava/lang/Object;</div><div class="line">.source &quot;HeyTry.java&quot;</div><div class="line"># direct methods</div><div class="line">.method constructor &lt;init&gt;()V</div><div class="line">    .registers 1</div><div class="line">    .prologue</div><div class="line">    .line 3</div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</div><div class="line">    return-void</div><div class="line">.end method</div><div class="line">.method public static func()V</div><div class="line">    .registers 2</div><div class="line">    .prologue</div><div class="line">    .line 8</div><div class="line">    const/16 v0, 0xa</div><div class="line">    :try_start_2    //tryå¼€å§‹</div><div class="line">    div-int/lit8 v0, v0, 0x0</div><div class="line">    :try_end_4      //tryç»“æŸï¼Œç´§è·Ÿç€çš„æ˜¯catch</div><div class="line">    .catch Ljava/lang/ArithmeticException; &#123;:try_start_2 .. :try_end_4&#125; :catch_18</div><div class="line">    .line 15</div><div class="line">    :goto_4</div><div class="line">    const/4 v0, 0x0     //åŸæœ¬æ˜¯tryå†…éƒ¨çš„å¸¸é‡å®šä¹‰è¢«æŒªåˆ°äº†å¤–é¢</div><div class="line">    .line 16</div><div class="line">    const/16 v1, 0xa</div><div class="line">    :try_start_7</div><div class="line">    div-int v0, v1, v0</div><div class="line">    :try_end_9</div><div class="line">    .catch Ljava/lang/ArithmeticException; &#123;:try_start_7 .. :try_end_9&#125; :catch_21</div><div class="line">    .catch Ljava/lang/Exception; &#123;:try_start_7 .. :try_end_9&#125; :catch_2a</div><div class="line">    .line 26</div><div class="line">    :goto_9</div><div class="line">    const/4 v0, 0x0</div><div class="line">    .line 28</div><div class="line">    const/16 v1, 0xa</div><div class="line">    :try_start_c</div><div class="line">    div-int v0, v1, v0</div><div class="line">    :try_end_e      //åŸæœ¬æ˜¯å†…å¤–å±‚å…³ç³»çš„ä¸¤ä¸ªcatchè¢«æ”¾åœ¨äº†ä¸€èµ·</div><div class="line">    .catch Ljava/lang/ArithmeticException; &#123;:try_start_c .. :try_end_e&#125; :catch_31</div><div class="line">    .catch Ljava/lang/Exception; &#123;:try_start_c .. :try_end_e&#125; :catch_3a</div><div class="line">    .line 34</div><div class="line">    :goto_e</div><div class="line">    const/4 v0, 0x2</div><div class="line">    :try_start_f</div><div class="line">    new-array v0, v0, [I</div><div class="line">    fill-array-data v0, :array_42   //fill-array-data-payload</div><div class="line">    .line 35</div><div class="line">    const/4 v1, 0x2</div><div class="line">    aget v0, v0, v1</div><div class="line">    :try_end_17</div><div class="line">    .catch Ljava/lang/Exception; &#123;:try_start_f .. :try_end_17&#125; :catch_3a</div><div class="line">    .line 40</div><div class="line">    :goto_17</div><div class="line">    return-void</div><div class="line">    .line 10</div><div class="line">    :catch_18       //åŒæ ·çš„å¼‚å¸¸ä»£ç æ²¡æœ‰è¢«ä¼˜åŒ–</div><div class="line">    move-exception v0</div><div class="line">    .line 11</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const-string v1, &quot;zero error.&quot;</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</div><div class="line">    goto :goto_4</div><div class="line">    .line 18</div><div class="line">    :catch_21</div><div class="line">    move-exception v0</div><div class="line">    .line 19</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const-string v1, &quot;zero error.&quot;</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</div><div class="line">    goto :goto_9</div><div class="line">    .line 21</div><div class="line">    :catch_2a</div><div class="line">    move-exception v0</div><div class="line">    .line 22</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-virtual &#123;v1, v0&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/Object;)V</div><div class="line">    goto :goto_9</div><div class="line">    .line 30</div><div class="line">    :catch_31</div><div class="line">    move-exception v0</div><div class="line">    .line 31</div><div class="line">    :try_start_32</div><div class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const-string v1, &quot;zero error.&quot;</div><div class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</div><div class="line">    :try_end_39</div><div class="line">    .catch Ljava/lang/Exception; &#123;:try_start_32 .. :try_end_39&#125; :catch_3a</div><div class="line">    goto :goto_e</div><div class="line">    .line 37</div><div class="line">    :catch_3a</div><div class="line">    move-exception v0</div><div class="line">    .line 38</div><div class="line">    sget-object v1, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    invoke-virtual &#123;v1, v0&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/Object;)V</div><div class="line">    goto :goto_17</div><div class="line">    .line 34</div><div class="line">    nop</div><div class="line">    :array_42   //fill-array-data-payload</div><div class="line">    .array-data 4</div><div class="line">        0x0</div><div class="line">        0x0</div><div class="line">    .end array-data</div><div class="line">.end method</div></pre></td></tr></table></figure>
<h3 id="æ ¼å¼"><a href="#æ ¼å¼" class="headerlink" title="æ ¼å¼"></a>æ ¼å¼</h3><p>try ä»£ç å—ä»¥ä¸¤ä¸ªæ ‡å·ä¸ºç•Œï¼Œ<code>:try_start_æ•°å­—</code> å’Œ <code>:try_end_æ•°å­—</code>ï¼Œï¼ˆä¸æ™“å¾—è¿™ä¸€æ®µçš„æ•°å­—ä¸ºä»€ä¹ˆæ²¡æœ‰è§„å¾‹ï¼‰ã€‚<br>ç´§æ¥ç€æ˜¯ catch çš„æ ¼å¼ï¼š<br><code>.catch å¼‚å¸¸ç±» {tryèµ·å§‹æ ‡å· .. tryç»“æŸæ ‡å·} catchä»£ç æ ‡å·</code><br>java å¹¶æ²¡æœ‰å¯¹é‡å¤çš„ catch ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å˜é‡çš„å®šä¹‰è¢«æŒªåˆ°äº† try ä¹‹å¤–ã€‚<br>åµŒå¥—çš„ try-catch è¢«åˆ†æˆäº†å•ä¸ªçš„ try-catch .</p>
<h3 id="try-åœ¨-dex-ä¸­çš„å­˜åœ¨"><a href="#try-åœ¨-dex-ä¸­çš„å­˜åœ¨" class="headerlink" title="try åœ¨ dex ä¸­çš„å­˜åœ¨"></a>try åœ¨ dex ä¸­çš„å­˜åœ¨</h3><p>å…³äºtry-catchæ˜¯å¦‚ä½•åœ¨dexæ–‡ä»¶ä¸­å­˜åœ¨çš„å‚è€ƒ<a href="http://kiya-z.github.io/2015/11/21/parse-dex-file-part-classdefs/" target="_blank" rel="external">è§£æ dex æ–‡ä»¶ç»“æ„ - ç´¢å¼•åŒºå’Œæ•°æ®åŒºï¼ˆä¸‰ï¼‰ - ClassDefs</a> .</p>
<p><strong>ä¸‹é¢æ˜¯æ‰‹åŠ¨æŸ¥æ‰¾ï¼š</strong></p>
<p>å‰æœŸå‡†å¤‡:<br>classDefsSize: 0x1<br>classDefsOff: 0x128<br>directMethodsSize: 0x2<br>funcå‡½æ•°çš„codeOff: 0x160<br>DexCode.triesSize: 0x05<br>try-catch åœ°å€: 0x204,æ•°æ®å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">00000200  .. .. .. .. 02 00 00 00  02 00 01 00 07 00 00 00  |................|</div><div class="line">00000210  02 00 04 00 0c 00 00 00  02 00 09 00 0f 00 00 00  |................|</div><div class="line">00000220  08 00 0e 00 32 00 00 00  07 00 0e 00 04 01 02 18  |....2...........|</div><div class="line">00000230  02 02 21 03 2a 02 02 31  03 3a 01 03 3a</div></pre></td></tr></table></figure></p>
<p>é¦–å…ˆæ˜¯0x5ä¸ªDexTry,</p>
<table>
<thead>
<tr>
<th>startAddr</th>
<th>insnCount</th>
<th>handlerOff</th>
<th>å¯¹åº”çš„å¼‚å¸¸å’Œhandler(ç”±ä¸‹è¡¨æ‰€å¾—)</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x02</td>
<td>0x02</td>
<td>0x01</td>
<td>0å·handler: æŠ“åˆ° ArithmeticException</td>
</tr>
<tr>
<td>0x07</td>
<td>0x02</td>
<td>0x04</td>
<td>1å·handler: æŠ“åˆ° ArithmeticExceptionå’ŒException</td>
</tr>
<tr>
<td>0x0c</td>
<td>0x02</td>
<td>0x09</td>
<td>2å·handler: æŠ“åˆ° ArithmeticExceptionå’ŒException</td>
</tr>
<tr>
<td>0x0f</td>
<td>0x08</td>
<td>0x0e</td>
<td>3å·handler: æŠ“åˆ° Exception</td>
</tr>
<tr>
<td>0x32</td>
<td>0x07</td>
<td>0x0e</td>
<td>3å·handler: æŠ“åˆ° Exception</td>
</tr>
</tbody>
</table>
<p>[<em>æ³¨</em>]è¿™é‡Œçš„handleroffæ˜¯ä»¥handler_listä¸ºèµ·å§‹çš„åç§»</p>
<p><code>catch_handleråˆ—è¡¨ä¸ªæ•°</code>: 0x04<br>ä¸‹é¢æ˜¯0x04ä¸ªcatch_handlerï¼š</p>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>size</th>
<th>typeId</th>
<th>addr</th>
<th>catch_all_addr</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0</td>
<td>0x01</td>
<td>0x02(java.lang.ArithmeticException)</td>
<td>0x18</td>
<td>-</td>
</tr>
<tr>
<td>0x1</td>
<td>0x02</td>
<td>0x02(java.lang.ArithmeticException)</td>
<td>0x21</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>0x03(java.lang.Exception)</td>
<td>0x2a</td>
<td>-</td>
</tr>
<tr>
<td>0x2</td>
<td>0x02</td>
<td>0x02(java.lang.ArithmeticException)</td>
<td>0x31</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>0x03(java.lang.Exception)</td>
<td>0x3a</td>
<td>-</td>
</tr>
<tr>
<td>0x03</td>
<td>0x01</td>
<td>0x03(java.lang.Exception)</td>
<td>0x3a</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>ä¸‹é¢æ˜¯ä½¿ç”¨ dexdump çš„æ•°æ®ï¼š</strong><br>å¯ç”¨æ¥éªŒè¯ç»“æœ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">Processing &apos;HeyTry.dex&apos;...</div><div class="line">Opened &apos;HeyTry.dex&apos;, DEX version &apos;035&apos;</div><div class="line">Class #0            -</div><div class="line">  Class descriptor  : &apos;LHeyTry;&apos;</div><div class="line">  Access flags      : 0x0000 ()</div><div class="line">  Superclass        : &apos;Ljava/lang/Object;&apos;</div><div class="line">  Interfaces        -</div><div class="line">  Static fields     -</div><div class="line">  Instance fields   -</div><div class="line">  Direct methods    -</div><div class="line">    #0              : (in LHeyTry;)</div><div class="line">      name          : &apos;&lt;init&gt;&apos;</div><div class="line">      type          : &apos;()V&apos;</div><div class="line">      access        : 0x10000 (CONSTRUCTOR)</div><div class="line">      code          -</div><div class="line">      registers     : 1</div><div class="line">      ins           : 1</div><div class="line">      outs          : 1</div><div class="line">      insns size    : 4 16-bit code units</div><div class="line">      catches       : (none)</div><div class="line">      positions     :</div><div class="line">        0x0000 line=3</div><div class="line">      locals        :</div><div class="line">        0x0000 - 0x0004 reg=0 this LHeyTry;</div><div class="line">    #1              : (in LHeyTry;)</div><div class="line">      name          : &apos;func&apos;</div><div class="line">      type          : &apos;()V&apos;</div><div class="line">      access        : 0x0009 (PUBLIC STATIC)</div><div class="line">      code          -</div><div class="line">      registers     : 2</div><div class="line">      ins           : 0</div><div class="line">      outs          : 2</div><div class="line">      insns size    : 74 16-bit code units  //å…±74æ¡æŒ‡ä»¤</div><div class="line">      catches       : 5     //äº”ä¸ªcatch</div><div class="line">        0x0002 - 0x0004     //startAddr + insnCount</div><div class="line">          Ljava/lang/ArithmeticException; -&gt; 0x0018</div><div class="line">        0x0007 - 0x0009</div><div class="line">          Ljava/lang/ArithmeticException; -&gt; 0x0021</div><div class="line">          Ljava/lang/Exception; -&gt; 0x002a</div><div class="line">        0x000c - 0x000e</div><div class="line">          Ljava/lang/ArithmeticException; -&gt; 0x0031</div><div class="line">          Ljava/lang/Exception; -&gt; 0x003a</div><div class="line">        0x000f - 0x0017</div><div class="line">          Ljava/lang/Exception; -&gt; 0x003a</div><div class="line">        0x0032 - 0x0039</div><div class="line">          Ljava/lang/Exception; -&gt; 0x003a</div><div class="line">      positions     :</div><div class="line">        0x0000 line=8</div><div class="line">        0x0004 line=15</div><div class="line">        0x0005 line=16</div><div class="line">        0x0009 line=26</div><div class="line">        0x000a line=28</div><div class="line">        0x000e line=34</div><div class="line">        0x0014 line=35</div><div class="line">        0x0017 line=40</div><div class="line">        0x0018 line=10</div><div class="line">        0x0019 line=11</div><div class="line">        0x0021 line=18</div><div class="line">        0x0022 line=19</div><div class="line">        0x002a line=21</div><div class="line">        0x002b line=22</div><div class="line">        0x0031 line=30</div><div class="line">        0x0032 line=31</div><div class="line">        0x003a line=37</div><div class="line">        0x003b line=38</div><div class="line">        0x0041 line=34</div><div class="line">      locals        :</div><div class="line">  Virtual methods   -</div><div class="line">  source_file_idx   : 1 (HeyTry.java)</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> smali </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - ç´¢å¼•åŒºå’Œæ•°æ®åŒºï¼ˆä¸‰ï¼‰ - ClassDefs]]></title>
      <url>/2015/11/21/parse-dex-file-part-classdefs/</url>
      <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-3.png" alt="part-class-defs"></p>
<a id="more"></a>
<p>ClassDefs è¡¨ç¤ºæŸä¸ªç±»çš„å…¨éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»ç±»å‹ã€è®¿é—®æƒé™ã€çˆ¶ç±»ã€æ¥å£ã€æºæ–‡ä»¶åã€æ³¨è§£å’Œä»£ç ç­‰ä¿¡æ¯ã€‚<br>ClassDefs çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<hr>
<h1 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h1><p>ClassDefs ä»¥4å­—èŠ‚å¯¹é½ï¼Œå³æ€»å¤§å°ä¸º 4 * 8 * ClassDefsSize .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;class_def_item&quot;.</div><div class="line"> */</div><div class="line">struct DexClassDef &#123;</div><div class="line">    u4  classIdx;           /* æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºç±»çš„ç±»å‹ */</div><div class="line">    u4  accessFlags;        /* ç±»çš„è®¿é—®æ ‡è¯†*/</div><div class="line">    u4  superclassIdx;      /* æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºçˆ¶ç±»ç±»å‹ */</div><div class="line">    u4  interfacesOff;      /* æŒ‡å‘ DexTypeList çš„æ–‡ä»¶åç§»ï¼Œè¡¨ç¤ºæ¥å£*/</div><div class="line">    u4  sourceFileIdx;      /* æŒ‡å‘ stringIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºæºæ–‡ä»¶å */</div><div class="line">    u4  annotationsOff;     /* æŒ‡å‘ annotations_directory_item çš„æ–‡ä»¶åç§»ï¼Œè¡¨ç¤ºæ³¨è§£*/</div><div class="line">    u4  classDataOff;       /* æŒ‡å‘ class_data_item çš„æ–‡ä»¶åç§»*/</div><div class="line">    u4  staticValuesOff;    /* æŒ‡å‘ DexEncodedArray çš„æ–‡ä»¶åç§»*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h2 id="classIdx"><a href="#classIdx" class="headerlink" title="classIdx"></a>classIdx</h2><p>æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œç±»ç±»å‹ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªç±»ç±»å‹è€Œä¸æ˜¯æ•°ç»„æˆ–è€…åŸºæœ¬ç±»å‹ã€‚</p>
<hr>
<h2 id="accessFlags"><a href="#accessFlags" class="headerlink" title="accessFlags"></a>accessFlags</h2><p>ç±»çš„è®¿é—®æ ‡è¯†ï¼Œå¦‚ publicã€final ç­‰ï¼Œå¸¸é‡å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…æ‹¬ç±»ã€å­—æ®µå’Œæ–¹æ³•çš„è®¿é—®æ ‡è¯†ï¼š</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>For Classes (and InnerClass annotations)</th>
<th>For Fields</th>
<th>For Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td>0x1</td>
<td>public: visible everywhere</td>
<td>public: visible everywhere</td>
<td>public: visible everywhere</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x2</td>
<td>* private: only visible to defining class</td>
<td>private: only visible to defining class</td>
<td>private: only visible to defining class</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x4</td>
<td>* protected: visible to package and subclasses</td>
<td>protected: visible to package and subclasses</td>
<td>protected: visible to package and subclasses</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x8</td>
<td>* static: is not constructed with an outer this reference</td>
<td>static: global to defining class</td>
<td>static: does not take a this argument</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x10</td>
<td>final: not subclassable</td>
<td>final: immutable after construction</td>
<td>final: not overridable</td>
</tr>
<tr>
<td>ACC_SYNCHRONIZED</td>
<td>0x20</td>
<td></td>
<td></td>
<td>synchronized: associated lock automatically acquired around call to this method.Note: This is only valid to set when ACC_NATIVE is also set.</td>
</tr>
<tr>
<td>ACC_BRIDGE</td>
<td>0x40</td>
<td></td>
<td></td>
<td>bridge method, added automatically by compiler as a type-safe bridge</td>
</tr>
<tr>
<td>ACC_VOLATILE</td>
<td>0x40</td>
<td></td>
<td>volatile: special access rules to help with thread safety</td>
<td></td>
</tr>
<tr>
<td>ACC_TRANSIENT</td>
<td>0x80</td>
<td></td>
<td>transient: not to be saved by default serialization</td>
<td></td>
</tr>
<tr>
<td>ACC_VARARGS</td>
<td>0x80</td>
<td></td>
<td></td>
<td>last argument should be treated as a â€œrestâ€ argument by compiler</td>
</tr>
<tr>
<td>ACC_NATIVE</td>
<td>0x100</td>
<td></td>
<td></td>
<td>native: implemented in native code</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x200</td>
<td>interface: multiply-implementable abstract class</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x400</td>
<td>abstract: not directly instantiable</td>
<td></td>
<td>abstract: unimplemented by this class</td>
</tr>
<tr>
<td>ACC_STRICT</td>
<td>0x800</td>
<td></td>
<td></td>
<td>strictfp: strict rules for floating-point arithmetic</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>not directly defined in source code</td>
<td>not directly defined in source code</td>
<td>not directly defined in source code</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>declared as an annotation class</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>declared as an enumerated type</td>
<td>declared as an enumerated value</td>
<td></td>
</tr>
<tr>
<td>(unused)</td>
<td>0x8000</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_CONSTRUCTOR</td>
<td>0x10000</td>
<td></td>
<td></td>
<td>constructor method (class or instance initializer)</td>
</tr>
<tr>
<td>ACC_DECLARED_SYNCHRONIZED</td>
<td>0x20000</td>
<td></td>
<td></td>
<td>declared synchronized. Note: This has no effect on execution (other than in reflection of this flag, per se).</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="superclassIdx"><a href="#superclassIdx" class="headerlink" title="superclassIdx"></a>superclassIdx</h2><p>æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œçˆ¶ç±»ç±»å‹ï¼›å¦‚æœæ²¡æœ‰çˆ¶ç±»å€¼ä¸º NO_INDEX . æ³¨æ„ NO_INDEX å€¼ä¸æ˜¯0ï¼Œå› ä¸º 0 æ˜¯ä¸€ä¸ªåˆæ³•çš„ç´¢å¼•ï¼Œè€Œä¸” NO_INDEX æ˜¯ä»¥ uleb128p1 ç¼–ç çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uint NO_INDEX = 0xffffffff;    // == -1 if treated as a signed int</div></pre></td></tr></table></figure>
<hr>
<h2 id="interfacesOff"><a href="#interfacesOff" class="headerlink" title="interfacesOff"></a>interfacesOff</h2><p>æŒ‡å‘ DexTypeList çš„æ–‡ä»¶åç§»ï¼ˆåœ¨æ•°æ®æ®µä¸­ï¼‰ï¼Œè¡¨ç¤ºæ¥å£ï¼›å¦‚æœæ²¡æœ‰æ¥å£æ­¤å€¼ä¸º 0 ã€‚<br>DexTypeList ä¸­çš„å€¼å¿…é¡»æ˜¯ç±»ç±»å‹ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;type_list&quot;.</div><div class="line"> */</div><div class="line">struct DexTypeList &#123;</div><div class="line">    u4  size;               /* DexTypeItemçš„ä¸ªæ•° */</div><div class="line">    DexTypeItem list[1];    /* DexTypeItemçš„å†…å®¹ */</div><div class="line">&#125;;</div><div class="line">/*</div><div class="line"> * Direct-mapped &quot;type_item&quot;.</div><div class="line"> */</div><div class="line">struct DexTypeItem &#123;</div><div class="line">    u2  typeIdx;            /* æŒ‡å‘ typeIds çš„ç´¢å¼• */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h2 id="sourceFileIdx"><a href="#sourceFileIdx" class="headerlink" title="sourceFileIdx"></a>sourceFileIdx</h2><p>æŒ‡å‘ stringIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºæœ¬ç±»æ‰€åœ¨çš„æºæ–‡ä»¶åï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªä¿¡æ¯å€¼ä¸º NO_INDEX</p>
<hr>
<h2 id="annotationsOff"><a href="#annotationsOff" class="headerlink" title="annotationsOff"></a>annotationsOff</h2><p>æŒ‡å‘ annotations_directory_item çš„æ–‡ä»¶åç§»ï¼Œè¡¨ç¤ºæ³¨è§£ï¼›å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œæ­¤å€¼ä¸º 0 ã€‚</p>
<h3 id="annotations-directory-item"><a href="#annotations-directory-item" class="headerlink" title="annotations_directory_item"></a>annotations_directory_item</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;annotations_directory_item&quot;.</div><div class="line"> */</div><div class="line">struct DexAnnotationsDirectoryItem &#123;</div><div class="line">    u4  classAnnotationsOff;  /* æŒ‡å‘ DexAnnotationSetItem çš„æ–‡ä»¶åç§»ï¼Œè‹¥æ— ï¼Œå€¼ä¸º0*/</div><div class="line">    u4  fieldsSize;           /* DexFieldAnnotationsItem çš„ä¸ªæ•°*/</div><div class="line">    u4  methodsSize;          /* DexMethodAnnotationsItem çš„ä¸ªæ•°*/</div><div class="line">    u4  parametersSize;       /* DexParameterAnnotationsItem çš„ä¸ªæ•°*/</div><div class="line">    /* followed by DexFieldAnnotationsItem[fieldsSize] */</div><div class="line">    /* followed by DexMethodAnnotationsItem[methodsSize] */</div><div class="line">    /* followed by DexParameterAnnotationsItem[parametersSize] */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="annotation-set-item"><a href="#annotation-set-item" class="headerlink" title="annotation_set_item"></a>annotation_set_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;annotation_set_item&quot;.</div><div class="line"> */</div><div class="line">struct DexAnnotationSetItem &#123;</div><div class="line">    u4  size;               /* DexAnnotationItem çš„ä¸ªæ•°*/</div><div class="line">    u4  entries[1];         /* DexAnnotationItem çš„å†…å®¹*/</div><div class="line">&#125;;</div><div class="line">/*</div><div class="line"> * Direct-mapped &quot;annotation_item&quot;.</div><div class="line"> *</div><div class="line"> * NOTE: this structure is byte-aligned.</div><div class="line"> */</div><div class="line">struct DexAnnotationItem &#123;</div><div class="line">    u1  visibility;     /* å¯è§æ€§ */</div><div class="line">    u1  annotation[1];  /* ä»¥ encoded_annotation æ ¼å¼ç¼–ç  */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>visibility å®šä¹‰:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VISIBILITY_BUILD</td>
<td>0x00</td>
<td>ç¼–è¯‘æ—¶å¯è§</td>
</tr>
<tr>
<td>VISIBILITY_RUNTIME</td>
<td>0x01</td>
<td>è¿è¡Œæ—¶å¯è§</td>
</tr>
<tr>
<td>VISIBILITY_SYSTEM</td>
<td>0x02</td>
<td>è¿è¡Œæ—¶å¯è§, ä½†æ˜¯åªå¯¹ç³»ç»Ÿå¯è§ï¼Œç”¨æˆ·ä»£ç ä¸å¯è§</td>
</tr>
</tbody>
</table>
<p><strong>encoded_annotation æ ¼å¼å®šä¹‰ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>type_idx</td>
<td>uleb128</td>
<td>æ³¨è§£ç±»å‹. å¿…é¡»æ˜¯ç±»ç±»å‹.</td>
</tr>
<tr>
<td>size</td>
<td>uleb128</td>
<td>æ³¨è§£ä¸­ name-value é”®å€¼å¯¹çš„ä¸ªæ•°.</td>
</tr>
<tr>
<td>elements</td>
<td>annotation_element[size]</td>
<td>æ³¨è§£çš„å…ƒç´ ï¼ˆä¸æ˜¯åç§»ï¼‰. å…ƒç´ éœ€æŒ‰ string_id çš„ç´¢å¼•å‡åºæ’åˆ—.</td>
</tr>
</tbody>
</table>
<p><strong>annotation_elementæ ¼å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name_idx</td>
<td>uleb128</td>
<td>ä»£è¡¨å…ƒç´ åç§°ï¼Œæ˜¯æŒ‡å‘ stringIds çš„ç´¢å¼• .</td>
</tr>
<tr>
<td>value</td>
<td>encoded_value</td>
<td>å…ƒç´ å€¼</td>
</tr>
</tbody>
</table>
<p><strong>encoded_valueæ ¼å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>(value_arg &lt;&lt; 5) &#124; value_type</td>
<td>ubyte</td>
<td>è¡¨ç¤ºåé¢ value çš„ç±»å‹ï¼Œ å¯é€‰é«˜ä¸‰ä½ clarifying argument .ä¸‹é¢è¯¦è¿°. value_arg è¡¨ç¤º value çš„é•¿åº¦(size - 1), æ¯”å¦‚ 0 è¡¨ç¤º value éœ€è¦ 1å­—èŠ‚, 7 è¡¨ç¤º value éœ€è¦8å­—èŠ‚ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ä¾‹å¤–ï¼Œä¸‹é¢è¯¦è¿°.</td>
</tr>
<tr>
<td>value</td>
<td>ubyte[]</td>
<td>å€¼ï¼Œä¸åŒçš„ç±»å‹æœ‰ä¸åŒçš„è§£ç æ–¹å¼, é€šå¸¸æ˜¯å°ç«¯å­˜å‚¨ã€‚</td>
</tr>
</tbody>
</table>
<p><strong>value çš„æ ¼å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç±»å‹å</th>
<th>ç±»å‹å€¼</th>
<th>value_arg Format</th>
<th>value Format</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>VALUE_BYTE</td>
<td>0x00</td>
<td>å¿…é¡»æ˜¯0</td>
<td>ubyte[1]</td>
<td>æœ‰ç¬¦å·1å­—èŠ‚æ•´å½¢å€¼</td>
</tr>
<tr>
<td>VALUE_SHORT</td>
<td>0x02</td>
<td>size - 1 (0â€¦1)</td>
<td>ubyte[size]</td>
<td>æœ‰ç¬¦å·4å­—èŠ‚æ•´å‹å€¼ï¼Œç¬¦å·æ‰©å±•</td>
</tr>
<tr>
<td>VALUE_CHAR</td>
<td>0x03</td>
<td>size - 1 (0â€¦1)</td>
<td>ubyte[size]</td>
<td>æ— ç¬¦å·4å­—èŠ‚æ•´å‹å€¼ï¼Œ0æ‰©å±•</td>
</tr>
<tr>
<td>VALUE_INT</td>
<td>0x04</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>æœ‰ç¬¦å·4å­—èŠ‚æ•´å‹å€¼ï¼Œç¬¦å·æ‰©å±•</td>
</tr>
<tr>
<td>VALUE_LONG</td>
<td>0x06</td>
<td>size - 1 (0â€¦7)</td>
<td>ubyte[size]</td>
<td>æœ‰ç¬¦å·8å­—èŠ‚æ•´å‹å€¼ï¼Œç¬¦å·æ‰©å±•</td>
</tr>
<tr>
<td>VALUE_FLOAT</td>
<td>0x10</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>4å­—èŠ‚ä½æ¨¡å¼ï¼Œ0æ‰©å±•ä¸ºå³ä¾§ï¼Œä»¥ IEEE754 32ä½æµ®ç‚¹ç±»å‹è§£ç </td>
</tr>
<tr>
<td>VALUE_DOUBLE</td>
<td>0x11</td>
<td>size - 1 (0â€¦7)</td>
<td>ubyte[size]</td>
<td>8å­—èŠ‚ä½æ¨¡å¼ï¼Œ0æ‰©å±•ä¸ºå³ä¾§ï¼Œä»¥ IEEE754 64ä½æµ®ç‚¹ç±»å‹è§£ç </td>
</tr>
<tr>
<td>VALUE_STRING</td>
<td>0x17</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>æ— ç¬¦å·(0æ‰©å±•)4å­—èŠ‚æ•´å½¢,è§£ç ä¸ºæŒ‡å‘string_idsçš„ç´¢å¼•ï¼Œä»£è¡¨å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>VALUE_TYPE</td>
<td>0x18</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>ç¬¦å·(0æ‰©å±•)4å­—èŠ‚æ•´å½¢,è§£ç ä¸ºæŒ‡å‘type_idsçš„ç´¢å¼•ï¼Œä»£è¡¨ç±»å‹æˆ–ç±»</td>
</tr>
<tr>
<td>VALUE_FIELD</td>
<td>0x19</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>ç¬¦å·(0æ‰©å±•)4å­—èŠ‚æ•´å½¢,è§£ç ä¸ºæŒ‡å‘field_idsçš„ç´¢å¼•ï¼Œä»£è¡¨å­—æ®µ</td>
</tr>
<tr>
<td>VALUE_METHOD</td>
<td>0x1a</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>ç¬¦å·(0æ‰©å±•)4å­—èŠ‚æ•´å½¢,è§£ç ä¸ºæŒ‡å‘method_idsçš„ç´¢å¼•ï¼Œä»£è¡¨æ–¹æ³•</td>
</tr>
<tr>
<td>VALUE_ENUM</td>
<td>0x1b</td>
<td>size - 1 (0â€¦3)</td>
<td>ubyte[size]</td>
<td>æ— ç¬¦å·(0æ‰©å±•)4å­—èŠ‚æ•´å½¢,è§£ç ä¸ºæŒ‡å‘field_idsçš„ç´¢å¼•ï¼Œä»£è¡¨æšä¸¾å¸¸é‡</td>
</tr>
<tr>
<td>VALUE_ARRAY</td>
<td>0x1c</td>
<td>å¿…é¡»æ˜¯0</td>
<td>encoded_array</td>
<td>æ•°ç»„ï¼Œæ ¼å¼ä¸ºencoded_array format.</td>
</tr>
<tr>
<td>VALUE_ANNOTATION</td>
<td>0x1d</td>
<td>å¿…é¡»æ˜¯0</td>
<td>encoded_annotation</td>
<td>å­æ³¨è§£, æ ¼å¼ä¸ºencoded_annotation format.</td>
</tr>
<tr>
<td>VALUE_NULL</td>
<td>0x1e</td>
<td>å¿…é¡»æ˜¯0</td>
<td>(none)</td>
<td>null</td>
</tr>
<tr>
<td>VALUE_BOOLEAN</td>
<td>0x1f</td>
<td>boolean (0â€¦1)</td>
<td>(none)</td>
<td>ä¸€æ¯”ç‰¹çš„å€¼ï¼Œ 0 ä»£è¡¨ false ï¼Œ 1 ä»£è¡¨ true.</td>
</tr>
</tbody>
</table>
<h4 id="field-annotations-item"><a href="#field-annotations-item" class="headerlink" title="field_annotations_item"></a>field_annotations_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;field_annotations_item&quot;.</div><div class="line"> */</div><div class="line">struct DexFieldAnnotationsItem &#123;</div><div class="line">    u4  fieldIdx;</div><div class="line">    u4  annotationsOff;             /* æŒ‡å‘ DexAnnotationSetItem çš„æ–‡ä»¶åç§»*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="method-annotations-item"><a href="#method-annotations-item" class="headerlink" title="method_annotations_item"></a>method_annotations_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;method_annotations_item&quot;.</div><div class="line"> */</div><div class="line">struct DexMethodAnnotationsItem &#123;</div><div class="line">    u4  methodIdx;</div><div class="line">    u4  annotationsOff;             /* æŒ‡å‘ DexAnnotationSetItem çš„æ–‡ä»¶åç§» */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="parameter-annotations-item"><a href="#parameter-annotations-item" class="headerlink" title="parameter_annotations_item"></a>parameter_annotations_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;parameter_annotations_item&quot;.</div><div class="line"> */</div><div class="line">struct DexParameterAnnotationsItem &#123;</div><div class="line">    u4  methodIdx;</div><div class="line">    u4  annotationsOff;             /* æŒ‡å‘ DexAnnotationSetRefList çš„æ–‡ä»¶åç§»*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;annotation_set_ref_list&quot;.</div><div class="line"> */</div><div class="line">struct DexAnnotationSetRefList &#123;</div><div class="line">    u4  size;</div><div class="line">    DexAnnotationSetRefItem list[1];</div><div class="line">&#125;;</div><div class="line">/*</div><div class="line"> * Direct-mapped &quot;annotation_set_ref_item&quot;.</div><div class="line"> */</div><div class="line">struct DexAnnotationSetRefItem &#123;</div><div class="line">    u4  annotationsOff;             /* offset to DexAnnotationSetItem */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="å¸¸é‡å®šä¹‰"><a href="#å¸¸é‡å®šä¹‰" class="headerlink" title="å¸¸é‡å®šä¹‰"></a>å¸¸é‡å®šä¹‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/* annotation constants */</div><div class="line">enum &#123;</div><div class="line">    kDexVisibilityBuild         = 0x00,     /* annotation visibility */</div><div class="line">    kDexVisibilityRuntime       = 0x01,</div><div class="line">    kDexVisibilitySystem        = 0x02,</div><div class="line">    kDexAnnotationByte          = 0x00,</div><div class="line">    kDexAnnotationShort         = 0x02,</div><div class="line">    kDexAnnotationChar          = 0x03,</div><div class="line">    kDexAnnotationInt           = 0x04,</div><div class="line">    kDexAnnotationLong          = 0x06,</div><div class="line">    kDexAnnotationFloat         = 0x10,</div><div class="line">    kDexAnnotationDouble        = 0x11,</div><div class="line">    kDexAnnotationString        = 0x17,</div><div class="line">    kDexAnnotationType          = 0x18,</div><div class="line">    kDexAnnotationField         = 0x19,</div><div class="line">    kDexAnnotationMethod        = 0x1a,</div><div class="line">    kDexAnnotationEnum          = 0x1b,</div><div class="line">    kDexAnnotationArray         = 0x1c,</div><div class="line">    kDexAnnotationAnnotation    = 0x1d,</div><div class="line">    kDexAnnotationNull          = 0x1e,</div><div class="line">    kDexAnnotationBoolean       = 0x1f,</div><div class="line">    kDexAnnotationValueTypeMask = 0x1f,     /* low 5 bits */</div><div class="line">    kDexAnnotationValueArgShift = 5,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h2 id="classDataOff"><a href="#classDataOff" class="headerlink" title="classDataOff"></a>classDataOff</h2><p>æŒ‡å‘ class_data_item çš„æ–‡ä»¶åç§»ï¼Œå¦‚æœæ­¤ç±»æ²¡æœ‰æ•°æ®(å¦‚æ¥å£)ï¼Œå€¼ä¸º0.<br>é™¤äº† DexCode ä¹‹å¤–çš„ç»“æ„æ˜¯å®šä¹‰åœ¨ /dalvik/libdex/DexCLass.h æ–‡ä»¶ä¸­çš„ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯ uleb128 ç¼–ç æ–¹å¼ã€‚ä¸ä¹‹å‰ä¸åŒ</p>
<h3 id="class-data-item-å®šä¹‰"><a href="#class-data-item-å®šä¹‰" class="headerlink" title="class_data_item å®šä¹‰"></a>class_data_item å®šä¹‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/* expanded form of class_data_item. Note: If a particular item is</div><div class="line"> * absent (e.g., no static fields), then the corresponding pointer</div><div class="line"> * is set to NULL. */</div><div class="line">struct DexClassData &#123;</div><div class="line">    DexClassDataHeader header;          /* å­—æ®µä¸æ–¹æ³•çš„ä¸ªæ•° */</div><div class="line">    DexField*          staticFields;    /* é™æ€å­—æ®µç»“æ„ */</div><div class="line">    DexField*          instanceFields;    /* å®ä¾‹å­—æ®µç»“æ„ */</div><div class="line">    DexMethod*         directMethods;    /* ç›´æ¥æ–¹æ³•ç»“æ„ */</div><div class="line">    DexMethod*         virtualMethods;    /* è™šæ–¹æ³•ç»“æ„ */</div><div class="line">&#125;;</div><div class="line">/* expanded form of a class_data_item header */</div><div class="line">struct DexClassDataHeader &#123;</div><div class="line">    u4 staticFieldsSize;    /*é™æ€å­—æ®µä¸ªæ•°*/</div><div class="line">    u4 instanceFieldsSize;  /*å®ä¾‹å­—æ®µçš„ä¸ªæ•°*/</div><div class="line">    u4 directMethodsSize;   /*ç›´æ¥æ–¹æ³•çš„ä¸ªæ•°*/</div><div class="line">    u4 virtualMethodsSize;  /*è™šæ–¹æ³•çš„ä¸ªæ•°*/</div><div class="line">&#125;;</div><div class="line">/* expanded form of encoded_field */</div><div class="line">struct DexField &#123;</div><div class="line">    u4 fieldIdx;    /*æŒ‡å‘ DexFieldId çš„ç´¢å¼• */</div><div class="line">    u4 accessFlags; /* è®¿é—®æ ‡è¯† */</div><div class="line">&#125;;</div><div class="line">/* expanded form of encoded_method */</div><div class="line">struct DexMethod &#123;</div><div class="line">    u4 methodIdx;    /* æŒ‡å‘ DexMethodId çš„ç´¢å¼• */</div><div class="line">    u4 accessFlags;  /* è®¿é—®æ ‡è¯† */</div><div class="line">    u4 codeOff;      /* æŒ‡å‘ DexCode çš„æ–‡ä»¶åç§»ï¼Œå¦‚æœæ–¹æ³•æ˜¯abstractæˆ–è€…nativeçš„ï¼Œå€¼ä¸º0*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="code-item"><a href="#code-item" class="headerlink" title="code_item"></a>code_item</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;code_item&quot;.</div><div class="line"> *</div><div class="line"> * The &quot;catches&quot; table is used when throwing an exception,</div><div class="line"> * &quot;debugInfo&quot; is used when displaying an exception stack trace or</div><div class="line"> * debugging. An offset of zero indicates that there are no entries.</div><div class="line"> */</div><div class="line">struct DexCode &#123;</div><div class="line">    u2  registersSize;      /* ä½¿ç”¨çš„å¯„å­˜å™¨ä¸ªæ•° */</div><div class="line">    u2  insSize;            /* å‚æ•°ä¸ªæ•° */</div><div class="line">    u2  outsSize;           /* è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶ä½¿ç”¨çš„å¯„å­˜å™¨ä¸ªæ•° */</div><div class="line">    u2  triesSize;          /* Try çš„ä¸ªæ•°*/</div><div class="line">    u4  debugInfoOff;       /* è°ƒè¯•ä¿¡æ¯(è¡Œå·å’Œå±€éƒ¨å˜é‡ä¿¡æ¯)çš„æ–‡ä»¶åç§»ï¼Œæ²¡æœ‰çš„è¯å€¼ä¸º0ï¼Œç»“æ„ä¸º debug_info_item*/</div><div class="line">    u4  insnsSize;          /* æŒ‡ä»¤ä¸ªæ•°ï¼Œä»¥2å­—èŠ‚ä¸ºå•ä½*/</div><div class="line">    u2  insns[1];           /* æŒ‡ä»¤æ•°ç»„ï¼ŒæŒ‡ä»¤å«ä¹‰å‚è€ƒdalvikå­—èŠ‚ç æ ¼å¼*/</div><div class="line">    /* 2å­—èŠ‚ç”¨äºå¯¹é½(tryçš„ç»“æ„æ˜¯ä»¥4å­—èŠ‚å¯¹é½çš„ï¼Œåªæœ‰triesSizeä¸ä¸º0ä¸”insnsSizeä¸ºå¥‡æ•°çš„æ—¶å€™æ­¤å€¼æ‰ä¼šå‡ºç°) */</div><div class="line">    /* try_item[triesSize] DexTry ç»“æ„ï¼ŒæŒ‡ç¤ºå“ªé‡Œæœ‰å¼‚å¸¸ï¼Œæ€æ ·å¤„ç†ï¼›æ•°ç»„ä¸­çš„å…ƒç´ å¿…é¡»æ²¡æœ‰é‡å å’Œè¦†ç›– */</div><div class="line">    /* try/catch ä¸­ handler çš„ä¸ªæ•° */</div><div class="line">    /* catch_handler_item[handlersSize] DexCatchHandlerç»“æ„*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="debug-info-item"><a href="#debug-info-item" class="headerlink" title="debug_info_item"></a>debug_info_item</h4><p>æ¯ä¸ª debug_info_item ä»¥ä¸€ä¸ªå˜é•¿çš„ header å¼€å§‹(é•¿åº¦å–å†³äºæ–¹æ³•çš„å‚æ•°ä¸ªæ•°)ï¼Œæ¥ç€æ˜¯æ“ä½œç ï¼ˆç”¨æ¥ä¿®æ”¹çŠ¶æ€æœºå™¨ç çš„å€¼ï¼‰ï¼Œæœ€åæ˜¯ä¸€ä¸ªç»“æŸå­—èŠ‚ <code>DBG_END_SEQUENCE</code>ã€‚</p>
<p><strong>çŠ¶æ€æœºå™¨ç </strong> åŒ…å«5ä¸ªå¯„å­˜å™¨ï¼ŒåŒæ—¶ä¹Ÿè¿½è¸ªç€æ¯ä¸ªå¯„å­˜å™¨ä¸­æœ€åä¸€ä¸ªå±€éƒ¨å˜é‡çš„åå­—å’Œç±»å‹ï¼Œä¸º DBG_RESTART_LOCAL åšå‡†å¤‡ã€‚<br><code>address</code>å¯„å­˜å™¨ä»£è¡¨ä¸¤å­—èŠ‚æŒ‡ä»¤çš„åç§»åœ°å€ï¼Œåœ¨æ¯ä¸ª debug_info åºåˆ—é‡Œä»¥0å¼€å§‹ï¼Œå•è°ƒé€’å¢ï¼›<br><code>line</code>å¯„å­˜å™¨ä»£è¡¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„è¡Œæ•°ï¼Œå®ƒåœ¨ header ä¸­è¢«åˆå§‹åŒ–ï¼Œå¯èƒ½ä¼šåŠ å‡å˜åŒ–ä½†ç»ä¸ä¼šå°äº 1ï¼›<br><code>source_file</code>å¯„å­˜å™¨ä»£è¡¨è¡Œæ•°æ‰€åœ¨çš„æºæ–‡ä»¶ï¼Œå®ƒçš„ç±»å‹æ˜¯ class_def_item ä¸­çš„ source_file_idxï¼›<br><code>prologue_end</code> å’Œ <code>epilogue_begin</code> æ˜¯å¸ƒå°”ç±»å‹çš„æ ‡è¯†(åˆå§‹å€¼ä¸ºfalse)ï¼Œä»£è¡¨ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯ä¸æ˜¯å‡½æ•°å…¥å£æˆ–è€…å‡½æ•°ç»“æŸã€‚</p>
<p><strong>header çš„æ ¼å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>line_start</td>
<td>uleb128</td>
<td>line å¯„å­˜å™¨çš„åˆå§‹å€¼ï¼Œä¸ä»£è¡¨çœŸå®çš„å…¥å£</td>
</tr>
<tr>
<td>parameters_size</td>
<td>uleb128</td>
<td>å‚æ•°åå­—çš„ä¸ªæ•°. å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•çš„è¯ï¼Œä¸åŒ…æ‹¬this.</td>
</tr>
<tr>
<td>parameter_names</td>
<td>uleb128p1[parameters_size]</td>
<td>æ–¹æ³•çš„å‚æ•°åçš„å­—ç¬¦ä¸²ç´¢å¼•. NO_INDEX è¡¨ç¤ºç›¸å…³å‚æ•°æ²¡æœ‰åå­—. ç±»å‹æè¿°ç¬¦å’Œç­¾ååŒæ–¹æ³•çš„ç±»å‹æè¿°ç¬¦å’Œç­¾å.</td>
</tr>
</tbody>
</table>
<p><strong>debug_info ä¸­æ“ä½œçš„å€¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å€¼</th>
<th>æ ¼å¼</th>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>DBG_END_SEQUENCE</td>
<td>0x00</td>
<td></td>
<td>(none)</td>
<td>ä»£è¡¨è°ƒè¯•ä¿¡æ¯çš„ç»ˆæ­¢</td>
</tr>
<tr>
<td>DBG_ADVANCE_PC</td>
<td>0x01</td>
<td>uleb128  addr_diff</td>
<td>addr_diff: åœ°å€å¯„å­˜å™¨åŠ ä¸Šæ­¤å€¼</td>
<td>ä½¿addresså¯„å­˜å™¨æŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€</td>
</tr>
<tr>
<td>DBG_ADVANCE_LINE</td>
<td>0x02</td>
<td>sleb128 line_diff</td>
<td>line_diff: lineå¯„å­˜å™¨åŠ ä¸Šæ­¤å€¼</td>
<td>ä½¿lineå¯„å­˜å™¨æŒ‡å‘æ–°çš„ä¸€è¡Œ</td>
</tr>
<tr>
<td>DBG_START_LOCAL</td>
<td>0x03</td>
<td>uleb128  register_numï¼Œuleb128p1 name_idxï¼Œuleb128p1 type_idx</td>
<td>register_num: æŸä¸ªå¯„å­˜å™¨ï¼Œname_idx: æŒ‡å‘stringçš„ç´¢å¼•ï¼Œtype_idx: æŒ‡å‘typeçš„ç´¢å¼•</td>
<td>åœ¨å½“å‰åœ°å€å¼•å…¥ä¸€ä¸ªå±€éƒ¨å˜é‡. name_idx æˆ– type_idx å¯èƒ½æ˜¯ NO_INDEXï¼Œä»£è¡¨æ­¤å€¼æœªçŸ¥.</td>
</tr>
<tr>
<td>DBG_START_LOCAL_EXTENDED</td>
<td>0x04</td>
<td>uleb128 register_numï¼Œuleb128p1 name_idxï¼Œuleb128p1 type_idxï¼Œuleb128p1 sig_idx</td>
<td>register_num: æŸä¸ªå¯„å­˜å™¨ï¼Œname_idx: æŒ‡å‘stringçš„ç´¢å¼•ï¼Œtype_idx: æŒ‡å‘typeçš„ç´¢å¼•ï¼Œsig_idx: æŒ‡å‘stringçš„ç´¢å¼•ï¼Œè¡¨ç¤ºç±»å‹ç­¾å</td>
<td>åœ¨å½“å‰åœ°å€å¼•å…¥ä¸€ä¸ªå¸¦æœ‰ç±»å‹ç­¾åçš„å±€éƒ¨å˜é‡. name_idx æˆ– type_idxã€sig_idx å¯èƒ½æ˜¯ NO_INDEXï¼Œä»£è¡¨æ­¤å€¼æœªçŸ¥.â€dalvik.annotation.Signatureâ€ æœ‰å…³äºå¤„ç†ç­¾åçš„è¯´æ˜.</td>
</tr>
<tr>
<td>DBG_END_LOCAL</td>
<td>0x05</td>
<td>uleb128 register_num</td>
<td>register_num: æŸä¸ªå¯„å­˜å™¨</td>
<td>ä»£è¡¨å½“å‰åœ°å€çš„å±€éƒ¨å˜é‡è¶…å‡ºèŒƒå›´</td>
</tr>
<tr>
<td>DBG_RESTART_LOCAL</td>
<td>0x06</td>
<td>uleb128 register_num</td>
<td>register_num: é‡æ–°èµ‹å€¼çš„å¯„å­˜å™¨</td>
<td>åœ¨å½“å‰åœ°å€é‡æ–°å¼•å…¥ä¸€ä¸ªå±€éƒ¨å˜é‡.åå­—å’Œç±»å‹åŒä¸Šä¸€ä¸ªå±€éƒ¨å˜é‡.</td>
</tr>
<tr>
<td>DBG_SET_PROLOGUE_END</td>
<td>0x07</td>
<td></td>
<td>(none)</td>
<td>è®¾ç½® prologue_end çŠ¶æ€å¯„å­˜å™¨, è¡¨ç¤ºä¸‹ä¸€ä¸ªå…¥å£ç‚¹åº”è¯¥è¢«è§†ä½œæ–¹æ³•å¼€å§‹çš„ç»“æŸ(å¯è®¾ç½®æ–¹æ³•æ–­ç‚¹çš„åˆé€‚åœ°æ–¹). prologue_endå¯„å­˜å™¨çš„å€¼å¯ä»¥è¢«ä»»ä½•&gt;=0x0açš„ç‰¹æ®Šæ“ä½œç æ¸…ç©º.</td>
</tr>
<tr>
<td>DBG_SET_EPILOGUE_BEGIN</td>
<td>0x08</td>
<td></td>
<td>(none)</td>
<td>è®¾ç½®epilogue_beginçŠ¶æ€å¯„å­˜å™¨, è¡¨ç¤ºä¸‹ä¸€ä¸ªå…¥å£ç‚¹åº”è¯¥è¢«è§†ä½œæ–¹æ³•ç»“æŸçš„å¼€å§‹(åœ¨æ–¹æ³•ç»“æŸä¹‹å‰ä½¿å…¶æŒ‚èµ·çš„åˆé€‚åœ°æ–¹). epilogue_beginå¯„å­˜å™¨çš„å€¼å¯ä»¥è¢«ä»»ä½•&gt;=0x0açš„ç‰¹æ®Šæ“ä½œç æ¸…ç©º.</td>
</tr>
<tr>
<td>DBG_SET_FILE</td>
<td>0x09</td>
<td>uleb128p1 name_idx</td>
<td>name_idx: æŒ‡å‘stringçš„ç´¢å¼•ï¼Œè¡¨ç¤ºæºæ–‡ä»¶å; NO_INDEX è¡¨ç¤ºæœªçŸ¥</td>
<td>è¡¨é¢æ¥ä¸‹æ¥çš„è¡Œå·å…¥å£éƒ½ä¸è¿™ä¸ªæ–‡ä»¶ç›¸å…³, è€Œä¸æ˜¯ code_item æŒ‡å®šçš„é»˜è®¤åå­—.</td>
</tr>
<tr>
<td>Special Opcodes</td>
<td>0x0aâ€¦0xff</td>
<td></td>
<td>(none)</td>
<td>lineã€addresså¯„å­˜å™¨åŠ å‡, å¼€å¯æ–°çš„å…¥å£ç‚¹, æ¸…ç©º prologue_endã€ epilogue_beginå¯„å­˜å™¨. å…¬å¼å¦‚ä¸‹.</td>
</tr>
</tbody>
</table>
<p><strong>Special Opcodesï¼š</strong></p>
<p>ä½¿ lineã€address å¯„å­˜å™¨å°å¹…åº¦å˜åŒ–/å¼€å¯ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹. èŒƒå›´æ˜¯ 0x0a ~ 0xff .</p>
<p>DBG_FIRST_SPECIAL = 0x0a  // æœ€å°çš„ç‰¹æ®Šæ“ä½œç <br>DBG_LINE_BASE   = -4      // æœ€å°çš„è¡Œå·å¢é‡<br>DBG_LINE_RANGE  = 15      // ä»£è¡¨è¡Œå·çš„å˜åŒ–å€¼</p>
<p>å…¬å¼ï¼š<br>adjusted_opcode = opcode - DBG_FIRST_SPECIAL<br>line += DBG_LINE_BASE + (adjusted_opcode % DBG_LINE_RANGE)<br>address += (adjusted_opcode / DBG_LINE_RANGE)</p>
<h4 id="try-item"><a href="#try-item" class="headerlink" title="try_item"></a>try_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;try_item&quot;.</div><div class="line"> */</div><div class="line">struct DexTry &#123;</div><div class="line">    u4  startAddr;          /* å¼‚å¸¸èµ·å§‹åœ°å€, 2ä¸ªå­—èŠ‚ä¸ºå•ä½ */</div><div class="line">    u2  insnCount;          /* æŒ‡ä»¤ä¸ªæ•°, 2ä¸ªå­—èŠ‚ä¸ºå•ä½ï¼Œæœ€åä¸€ä¸ªæŒ‡ä»¤ä¸º startAddr + insnCount - 1 */</div><div class="line">    u2  handlerOff;         /* ä»¥ handler åˆ—è¡¨ä¸ºèµ·å§‹çš„ æŒ‡å‘å¼‚å¸¸å¯¹åº”çš„ handler çš„åç§»*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="catch-handler-item"><a href="#catch-handler-item" class="headerlink" title="catch_handler_item"></a>catch_handler_item</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Catch handler entry, used while iterating over catch_handler_items.</div><div class="line"> */</div><div class="line">struct DexCatchHandler &#123;</div><div class="line">    u4          typeIdx;    /* catch åˆ°çš„å¼‚å¸¸çš„ç±»å‹ç´¢å¼•ï¼ŒæŒ‡å‘ typeIds */</div><div class="line">    u4          address;    /* handler çš„åœ°å€ */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="ç•ªå¤–-å…³äº-catch-handler-list"><a href="#ç•ªå¤–-å…³äº-catch-handler-list" class="headerlink" title="ç•ªå¤– - å…³äº catch_handler_list"></a>ç•ªå¤– - å…³äº catch_handler_list</h4><p>catch_handler_list åœ¨æºç ä¸­æ²¡æœ‰å®šä¹‰ï¼Œä¸‹é¢çš„è¡¨æ ¼æ˜¯å…¶æ ¼å¼ï¼š</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>uleb128</td>
<td>handler åˆ—è¡¨çš„ä¸ªæ•°</td>
</tr>
<tr>
<td>list</td>
<td>encoded_catch_handler[handlers_size]</td>
<td>handler åˆ—è¡¨</td>
</tr>
</tbody>
</table>
<p>å•ä¸ª catch_handler çš„æ ¼å¼ï¼š</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>sleb128</td>
<td>åˆ—è¡¨ä¸­ catch åˆ°çš„ç±»å‹çš„ä¸ªæ•°. å¦‚æœä¸æ˜¯æ­£æ•°ï¼Œåˆ™handleråˆ—è¡¨ä¸­å«æœ‰å¯ä»¥æ•è·åˆ°æ‰€æœ‰å¼‚å¸¸çš„handler. æ¯”å¦‚ 0 è¡¨ç¤ºæ²¡æœ‰æŒ‡å®šå¼‚å¸¸çš„ç±»å‹ï¼Œåªæœ‰ä¸€ä¸ªæ‰€æœ‰å¼‚å¸¸handler. 2 è¡¨ç¤ºæœ‰ä¸¤ä¸ªæŒ‡å®šç±»å‹çš„å¼‚å¸¸. -1 æœ‰ä¸€ä¸ªæŒ‡å®šç±»å‹çš„å¼‚å¸¸å’Œä¸€ä¸ªå¯ä»¥æ•è·åˆ°æ‰€æœ‰å¼‚å¸¸çš„handler.</td>
</tr>
<tr>
<td>handlers</td>
<td>DexCatchHandler[abs(size)]</td>
<td>abs(size) ä¸ªhandler, å­˜æ”¾çš„æ˜¯æŒ‡å®šç±»å‹çš„å¼‚å¸¸.</td>
</tr>
<tr>
<td>catch_all_addr</td>
<td>uleb128 (optional)</td>
<td>å¯ä»¥å¤„ç†æ‰€æœ‰å¼‚å¸¸çš„ handler çš„åœ°å€. sizeä¸º0æˆ–è€…è´Ÿæ•°æ—¶æ­¤å€¼æœ‰æ•ˆ.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="staticValuesOff"><a href="#staticValuesOff" class="headerlink" title="staticValuesOff"></a>staticValuesOff</h2><p>æŒ‡å‘ DexEncodedArray çš„æ–‡ä»¶åç§»ï¼Œè¡¨ç¤ºé™æ€å­—æ®µçš„åˆå§‹å€¼ï¼Œå€¼ä¸º0è¡¨ç¤ºæ²¡æœ‰è®¾å®šé™æ€å­—æ®µçš„åˆå§‹å€¼ï¼Œé™æ€å­—æ®µè¢«åˆå§‹åŒ–ä¸º0æˆ–è€…null.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;encoded_array&quot;.</div><div class="line"> *</div><div class="line"> * NOTE: this structure is byte-aligned.</div><div class="line"> */</div><div class="line">struct DexEncodedArray &#123;</div><div class="line">    u1  array[1];                   /* encoded_array æ ¼å¼çš„æ•°æ® */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>encoded_array æ ¼å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>uleb128</td>
<td>æ•°ç»„å…ƒç´ çš„ä¸ªæ•°ï¼Œå¿…é¡»ä¸å¤§äºé™æ€å­—æ®µçš„ä¸ªæ•°å’Œå¯¹åº”çš„field_listçš„ä¸ªæ•°ï¼Œå¦‚æœæ˜¯å°äºï¼Œå‰©ä½™çš„é™æ€å­—æ®µæŒ‰ç…§ç›¸åº”çš„ç±»å‹è¢«åˆå§‹åŒ–ä¸º0æˆ–è€…null.</td>
</tr>
<tr>
<td>values</td>
<td>encoded_value[size]</td>
<td>æ•°ç»„å†…å®¹</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="æ‰‹å·¥æŸ¥æ‰¾"><a href="#æ‰‹å·¥æŸ¥æ‰¾" class="headerlink" title="æ‰‹å·¥æŸ¥æ‰¾"></a>æ‰‹å·¥æŸ¥æ‰¾</h1><p>classDefsSizeï¼š0x02<br>classDefsOffï¼š0x047c</p>
<p>0x047c ~ 0x04bc</p>
<h2 id="DexClassDefæ•°æ®åŠå…¶è§£æ"><a href="#DexClassDefæ•°æ®åŠå…¶è§£æ" class="headerlink" title="DexClassDefæ•°æ®åŠå…¶è§£æ"></a>DexClassDefæ•°æ®åŠå…¶è§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">00000470  .. .. .. .... .. .. ..   .. .. .. .. 05 00 00 00  |------------....|</div><div class="line">00000480  01 00 00 00 0e 00 00 00  00 00 00 00 1f 00 00 00  |................|</div><div class="line">00000490  00 00 00 00 c2 0f 00 00  00 00 00 00 06 00 00 00  |................|</div><div class="line">000004a0  01 00 00 00 02 00 00 00  00 00 00 00 20 00 00 00  |............ ...|</div><div class="line">000004b0  64 0a 00 00 de 0f 00 00  00 00 00 00</div></pre></td></tr></table></figure>
<p>ä»¥ç¬¬ä¸€ä¸ªä¸ºä¾‹ï¼š</p>
<ol>
<li><p><code>classIdx</code>=0x05ï¼Œå³ç¬¬0x05ä¸ªtypeIdï¼Œå¾—ç±»ç±»å‹ä¸º Lcom/shell/NativeApplication;</p>
</li>
<li><p><code>accessFlags</code>=0x01ï¼ŒæŸ¥è¡¨å¾—æƒé™ ACC_PUBLIC</p>
</li>
<li><p><code>superclassIdx</code>=0x0eï¼Œå³ç¬¬0x0eä¸ªtypeIdï¼Œå¾—çˆ¶ç±»ç±»å‹ä¸º Ljava/lang/Object;</p>
</li>
<li><p><code>interfacesOff</code>=0x0000ï¼Œæ²¡æœ‰å®ç°æ¥å£</p>
</li>
<li><p><code>sourceFileIdx</code>=0x1fï¼Œå³ç¬¬0x1fä¸ªstringIdï¼Œå¾—æºæ–‡ä»¶åä¸º NativeApplication.java</p>
</li>
<li><p><code>annotationsOff</code>=0x0000ï¼Œæ²¡æœ‰æ³¨è§£</p>
</li>
<li><p><code>classDataOff</code>=0x0fc2ï¼Œå¾—DexClassDataåç§»ä¸º0x0fc2</p>
</li>
<li><p><code>staticValuesOff</code>=0x0000ï¼Œæ²¡æœ‰é™æ€æ•°æ®çš„åˆå§‹å€¼</p>
</li>
</ol>
<h2 id="DexClassDataæ•°æ®åŠå…¶è§£æ"><a href="#DexClassDataæ•°æ®åŠå…¶è§£æ" class="headerlink" title="DexClassDataæ•°æ®åŠå…¶è§£æ"></a>DexClassDataæ•°æ®åŠå…¶è§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">00000fc0  .. .. 00 00 05 00 03 88  80 04 90 18 01 81 80 04  |................|</div><div class="line">00000fd0  b8 18 01 89 02 00 01 89  02 00 01 89 02 00 00 00  |................|</div><div class="line">00000fe0  03 04 08 81 80 04 d0 18  03 02 e8 18 01 09 f4 19  |................|</div></pre></td></tr></table></figure>
<p>[<strong>æ³¨æ„DexClassDataä¸­æ•°å­—çš„ç±»å‹ä¸ºuleb128</strong>]<br>â‘  <strong>header</strong>ï¼š<code>staticFieldsSize</code>=0x00, <code>instanceFieldsSize</code>=0x00, <code>directMethodsSize</code>=0x05, <code>virtualMethodsSize</code>=0x00, å³0ä¸ªé™æ€å­—æ®µï¼Œ0ä¸ªå®ä¾‹å­—æ®µï¼Œ5ä¸ªç›´æ¥æ–¹æ³•ï¼Œ0ä¸ªè™šæ–¹æ³•ï¼›</p>
<p>â‘¡ <strong>directMethods</strong>ï¼š(å…±5ä¸ªï¼Œä»¥ç¬¬ä¸€ä¸ªä¸ºä¾‹)</p>
<ul>
<li><code>methodIdx</code>=0x03ï¼Œå³ç¬¬0x03ä¸ªmethodIdï¼Œå¾—ç›´æ¥æ–¹æ³•ä¸º void com.shell.NativeApplication.<clinit>()</clinit></li>
<li><code>accessFlags</code>=<code>88 80 04</code>ï¼Œè§£ç ä¸º0x10008ï¼Œå¾—æ–¹æ³•è®¿é—®æƒé™ä¸º ACC_STATIC å’Œ ACC_CONSTRUCTOR</li>
<li><code>codeOff</code>=<code>90 18</code>ï¼Œè§£ç ä¸º0xc10ï¼Œå¾— DexCode åç§»ä¸º 0xc10</li>
</ul>
<h2 id="DexCodeæ•°æ®åŠå…¶è§£æ"><a href="#DexCodeæ•°æ®åŠå…¶è§£æ" class="headerlink" title="DexCodeæ•°æ®åŠå…¶è§£æ"></a>DexCodeæ•°æ®åŠå…¶è§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">00000c10  01 00 00 00 01 00 00 00  7c 0a 00 00 0b 00 00 00  |........|.......|</div><div class="line">00000c20  1a 00 00 00 71 10 20 00  00 00 1a 00 01 00 71 10  |....q. .......q.|</div><div class="line">00000c30  20 00 00 00 0e 00 00 00  01 00 01 00 01 00 00 00  | ...............|</div><div class="line">00000c40  83 0a 00 00 04 00 00 00  70 10 1d 00 00 00 0e 00  |........p.......|</div><div class="line">00000c50  01 00 01 00 01 00 00 00  88 0a 00 00 04 00 00 00  |................|</div><div class="line">00000c60  70 10 00 00 00 00 0e 00  0a 00 04 00 04 00 01 00  |p...............|</div><div class="line">00000c70  8d 0a 00 00 38 00 00 00  6e 10 12 00 09 00 0c 05  |....8...n.......|</div><div class="line">00000c80  6e 10 11 00 05 00 0a 05  39 05 09 00 6e 10 12 00  |n.......9...n...|</div></pre></td></tr></table></figure>
<ul>
<li><code>registersSize</code>=0x0001ï¼Œå¾—å¯„å­˜å™¨ä¸ªæ•°ä¸º1</li>
<li><code>insSize</code>=0x0000ï¼Œå¾—å‚æ•°ä¸ªæ•°ä¸º0</li>
<li><code>outsSize</code>=0x0001ï¼Œè°ƒç”¨å…¶ä»–æ–¹æ³•ä½¿ç”¨å¯„å­˜å™¨ä¸ªæ•°ä¸º1</li>
<li><code>triesSize</code>=0x0000ï¼Œtryçš„ä¸ªæ•°ä¸º0</li>
<li><code>debugInfoOff</code>=0x0a7cï¼Œdebugä¿¡æ¯åç§»ä¸º0x0a7c</li>
<li><code>insnsSize</code>=0x0bï¼Œå³æœ‰0xbä¸ª2å­—èŠ‚æŒ‡ä»¤ï¼Œåœ¨ 0x00000c20 ~ 0x00000c35 ä¹‹é—´</li>
<li><code>insns</code>={1a 00 00 00 71 10 20 00 00 00 1a 00 01 00 71 10 20 00 00 00 0e 00}</li>
</ul>
<h3 id="debug-infoæ•°æ®åŠå…¶è§£æ"><a href="#debug-infoæ•°æ®åŠå…¶è§£æ" class="headerlink" title="debug_infoæ•°æ®åŠå…¶è§£æ"></a>debug_infoæ•°æ®åŠå…¶è§£æ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">00000a70  .. .. .. .. .. .. .. ..  .. .. .. .. 09 00 07 0e  |........\.......|</div><div class="line">00000a80  5a 56 00</div></pre></td></tr></table></figure>
<ul>
<li><strong>header:</strong><br>  line_start(09)=0x09ï¼Œå¾—lineå¯„å­˜å™¨çš„åˆå§‹å€¼ä¸º0x09ï¼›<br>  parameters_size(0x00)=0x00ï¼Œå¾—å‚æ•°çš„åå­—çš„ä¸ªæ•°ä¸º0ï¼›</li>
<li><strong>æ“ä½œç ï¼š</strong><br>  <code>0x07</code>:DBG_SET_PROLOGUE_ENDï¼Œæ–¹æ³•å¼€å§‹ï¼›<br>  <code>0x0e</code>:0x0e-0x0a=0x04,å³è¡Œå·+=DBG_LINE_BASE+(0x04%DBG_LINE_RANGE),åœ°å€+=(0x04/DBG_LINE_RANGE),å¾—è¡Œå·+0,åœ°å€+0;<br>  <code>0x5a</code>:0x5a-0x0a=0x50,å³è¡Œå·+=DBG_LINE_BASE+(0x50%DBG_LINE_RANGE),åœ°å€+=(0x50/DBG_LINE_RANGE),å¾—è¡Œå·+1,åœ°å€+5;<br>  <code>0x56</code>:0x56-0x0a=0x4c,å³è¡Œå·+=DBG_LINE_BASE+(0x4c%DBG_LINE_RANGE),åœ°å€+=(0x4c/DBG_LINE_RANGE),å¾—è¡Œå·+1,åœ°å€+5;<br>  <code>0x00</code>:DBG_END_SEQUENCEï¼Œè°ƒè¯•ç»“æŸã€‚</li>
</ul>
<h3 id="insns-ä¸­çš„æŒ‡ä»¤æ•°æ®çš„è§£æ"><a href="#insns-ä¸­çš„æŒ‡ä»¤æ•°æ®çš„è§£æ" class="headerlink" title="insns ä¸­çš„æŒ‡ä»¤æ•°æ®çš„è§£æ"></a>insns ä¸­çš„æŒ‡ä»¤æ•°æ®çš„è§£æ</h3><p>åœ¨ <a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html" target="_blank" rel="external">Dalvik bytecode</a> æ‰¾åˆ° OpCode çš„å«ä¹‰åŠæ ¼å¼ï¼Œåœ¨ <a href="https://source.android.com/devices/tech/dalvik/instruction-formats.html" target="_blank" rel="external">Dalvik Executable instruction formats</a> æ‰¾åˆ°è¯¥æ ¼å¼çš„è¡¨ç¤ºæ–¹å¼ã€‚</p>
<p><strong>ç¬¬1æ¡ä»£ç ï¼š</strong></p>
<p><strong>1a</strong> ï¼š å«ä¹‰ä¸º <code>const-string vAA, string@BBBB</code>ï¼Œ æ ¼å¼ä¸º <code>1a 21c</code><br><strong>21c</strong> : æ ¼å¼ä¸º <code>AA|op BBBB</code>ï¼Œè¡¨ç¤ºæ–¹å¼æœ‰ä¸‰ç§ï¼š<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">op vAA, type@BBBB</div><div class="line">op vAA, field@BBBB</div><div class="line">op vAA, string@BBBB</div></pre></td></tr></table></figure></p>
<p><code>1a</code> çš„å«ä¹‰å·²ç»ä¸ºæˆ‘ä»¬æŒ‡æ˜ï¼Œæˆ‘ä»¬åº”è¯¥é‡‡ç”¨ç¬¬ä¸‰ç§ã€‚1a åé¢çš„6ä¸ªå­—èŠ‚ä¸º <code>00 00 00</code>ï¼Œå³ AA æ˜¯ 00ï¼ŒBBBB æ˜¯ 0000ã€‚<br>åˆ™å¯ç¿»è¯‘ä¸º <code>const-string v0, string@0000</code>ï¼Œ æ‰¾åˆ°ç¬¬0x0ä¸ª StringId å¯¹åº”çš„å­—ç¬¦ä¸² /data/data/com.zyh.lightingbackup/.lib/libexec.so .<br>æœ€ç»ˆè§£æä¸º <code>const-string v0, &quot;/data/data/com.zyh.lightingbackup/.lib/libexec.so&quot;</code></p>
<p><strong>ç¬¬2æ¡ä»£ç ï¼š</strong></p>
<p><strong>71</strong> ï¼š å«ä¹‰ä¸º <code>invoke-static</code>ï¼Œæ ¼å¼ä¸º <code>71 35c</code><br><strong>35c</strong> ï¼š æ ¼å¼ä¸º <code>A|G|op BBBB F|E|D|C</code> ï¼Œè¡¨ç¤ºæ–¹å¼æœ‰7ç§ï¼š<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[A=5] op &#123;vC, vD, vE, vF, vG&#125;, meth@BBBB</div><div class="line">[A=5] op &#123;vC, vD, vE, vF, vG&#125;, type@BBBB</div><div class="line">[A=4] op &#123;vC, vD, vE, vF&#125;, kind@BBBB</div><div class="line">[A=3] op &#123;vC, vD, vE&#125;, kind@BBBB</div><div class="line">[A=2] op &#123;vC, vD&#125;, kind@BBBB</div><div class="line">[A=1] op &#123;vC&#125;, kind@BBBB</div><div class="line">[A=0] op &#123;&#125;, kind@BBBB</div></pre></td></tr></table></figure></p>
<p>71 åé¢çš„ A = 1, G = 0ï¼Œæ‰€ä»¥åº”è¯¥é‡‡ç”¨æ–¹å¼ <code>[A=1] op {vC}, kind@BBBB</code>ï¼Œ<br>è€Œ BBBB = 0020, F|E|D|C = 0000ï¼Œå¯ç¿»è¯‘ä¸º <code>invoke-static {v0}, kind@0020</code>ï¼Œæ‰¾åˆ°ç¬¬ 0x20 ä¸ªmethodId å¯¹åº”çš„å‡½æ•° void java.lang.System.load(java.lang.String) .<br>æœ€ç»ˆè§£æä¸º <code>invoke-static {v0}, Ljava/lang/System;-&gt;load(Ljava/lang/String;)V</code></p>
<p>æœ€åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ apktool å°† apk æ–‡ä»¶åç¼–è¯‘ï¼Œåœ¨ /smali/com/shell/NativeApplication.smali æ–‡ä»¶ä¸­æ‰¾åˆ° <clinit> æ–¹æ³•ï¼Œçœ‹ä»£ç å¯¹ç…§ï¼</clinit></p>
<hr>
<h1 id="å†™ç¨‹åºè§£æ"><a href="#å†™ç¨‹åºè§£æ" class="headerlink" title="å†™ç¨‹åºè§£æ"></a>å†™ç¨‹åºè§£æ</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div></pre></td><td class="code"><pre><div class="line">def parseClassdef_Name(f):</div><div class="line">    return DexStruct.DexTypes[struct.unpack(&apos;I&apos;,f.read(4))[0]][&apos;content&apos;]</div><div class="line">def parseClassdef_Accessflag(f):</div><div class="line">    return struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">def parseClassdef_Superclass(f):</div><div class="line">    class_superclass_id = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if class_superclass_id == -1:</div><div class="line">        return None</div><div class="line">    return DexStruct.DexTypes[class_superclass_id][&apos;content&apos;]</div><div class="line">def parseClassdef_Interface(f):</div><div class="line">    interface_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if interface_off == 0:</div><div class="line">        return None</div><div class="line">    f.seek(interface_off)</div><div class="line">    type_list_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    type_list = []</div><div class="line">    for i in range(type_list_size):</div><div class="line">        type_id = struct.unpack(&apos;H&apos;,f.read(2))[0]</div><div class="line">        type_list.append(DexStruct.DexTypes[type_id][&apos;content&apos;])</div><div class="line">    return type_list</div><div class="line">def parseClassdef_Sourcefile(f):</div><div class="line">    class_sourcefile_id = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if class_sourcefile_id == -1:</div><div class="line">        return None</div><div class="line">    return DexStruct.DexStrings[class_sourcefile_id][&apos;content&apos;]</div><div class="line">def parseClassdef_Annotations(f):</div><div class="line">    annotations_directory_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if annotations_directory_off == 0:</div><div class="line">        return None</div><div class="line">    #-----------</div><div class="line">    f.seek(annotations_directory_off)</div><div class="line">    class_Annotations_Off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    field_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    method_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    parameter_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    #---------</div><div class="line">    annotations_directory = None</div><div class="line">    if class_Annotations_Off != 0:</div><div class="line">        # f.seek(class_Annotations_Off)</div><div class="line">        # annotation_set_item_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        # for i in range(annotation_set_item_size):</div><div class="line">        #     item_visibility = struct.unpack(&apos;B&apos;,f.read(1))[0]</div><div class="line">        #     item_annotation = struct.unpack(&apos;B&apos;,f.read(1))[0]</div><div class="line">        pass    # è§£ç æš‚ä¸”ç•¥è¿‡</div><div class="line">    #--------</div><div class="line">    f.seek(annotations_directory_off+4*4)</div><div class="line">    fieldAnnotation_list = []</div><div class="line">    for i in range(field_size):</div><div class="line">        field = DexStruct.DexFields[struct.unpack(&apos;I&apos;,f.read(4))[0]]</div><div class="line">        field_annotation_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        fieldAnnotation_item = &#123;</div><div class="line">            &apos;field&apos; : field,</div><div class="line">            &apos;annotationsOff&apos; : field_annotation_off,</div><div class="line">        &#125;</div><div class="line">        fieldAnnotation_list.append(fieldAnnotation_item)</div><div class="line">    #--------</div><div class="line">    f.seek(annotations_directory_off+4*4+field_size*8)</div><div class="line">    methodAnnotation_list = []</div><div class="line">    for i in range(method_size):</div><div class="line">        method= DexStruct.DexMethods[struct.unpack(&apos;I&apos;,f.read(4))[0]]</div><div class="line">        method_annotation_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        methodAnnotation_item = &#123;</div><div class="line">            &apos;method&apos; : method,</div><div class="line">            &apos;annotationsOff&apos; : method_annotation_off,</div><div class="line">        &#125;</div><div class="line">        methodAnnotation_list.append(methodAnnotation_item)</div><div class="line">    #--------</div><div class="line">    f.seek(annotations_directory_off+4*4+field_size*8+method_size*8)</div><div class="line">    parameterAnnotation_list = []</div><div class="line">    for i in range(parameter_size):</div><div class="line">        param_method = DexStruct.DexMethods[struct.unpack(&apos;I&apos;,f.read(4))[0]]</div><div class="line">        param_annotation_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        parameterAnnotation_item = &#123;</div><div class="line">            &apos;method&apos; : param_method,</div><div class="line">            &apos;annotationsOff&apos; : param_annotation_off,</div><div class="line">        &#125;</div><div class="line">        parameterAnnotation_list.append(parameterAnnotation_item)</div><div class="line">    tmpDexAnnotationsDirectoryItem = &#123;</div><div class="line">        &apos;classAnnotations&apos; : annotations_directory,</div><div class="line">        &apos;fieldSize&apos; : field_size,</div><div class="line">        &apos;methodSize&apos; : method_size,</div><div class="line">        &apos;parameterSize&apos; : parameter_size,</div><div class="line">        &apos;fieldAnnotation&apos; : fieldAnnotation_list,</div><div class="line">        &apos;methodAnnotation&apos; : methodAnnotation_list,</div><div class="line">        &apos;parameterAnnotaions&apos; : parameterAnnotation_list,</div><div class="line">    &#125;</div><div class="line">    return tmpDexAnnotationsDirectoryItem</div><div class="line">def parseClassdef_ClassData(f):</div><div class="line">    class_data_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if class_data_off == 0:</div><div class="line">        return None</div><div class="line">    f.seek(class_data_off)</div><div class="line">    #-----</div><div class="line">    header = &#123;</div><div class="line">        &apos;staticFieldsSize&apos; : readuleb128(f),</div><div class="line">        &apos;instanceFieldsSize&apos; :  readuleb128(f),</div><div class="line">        &apos;directMethodsSize&apos; : readuleb128(f),</div><div class="line">        &apos;virtualMethodsSize&apos; : readuleb128(f),</div><div class="line">    &#125;</div><div class="line">    #-----</div><div class="line">    staticFields = []</div><div class="line">    if header[&apos;staticFieldsSize&apos;] != 0:</div><div class="line">        for i in range(header[&apos;staticFieldsSize&apos;]):</div><div class="line">            tmpstaticFields = &#123;</div><div class="line">                &apos;field&apos; : DexStruct.DexFields[readuleb128(f)],</div><div class="line">                &apos;accessFlags&apos; : readuleb128(f)</div><div class="line">            &#125;</div><div class="line">            staticFields.append(tmpstaticFields)</div><div class="line">    #-----------</div><div class="line">    instanceFields = []</div><div class="line">    if header[&apos;instanceFieldsSize&apos;] != 0:</div><div class="line">        for i in range(header[&apos;instanceFieldsSize&apos;]):</div><div class="line">            tmpinstanceFields = &#123;</div><div class="line">                &apos;field&apos; : DexStruct.DexFields[readuleb128(f)],</div><div class="line">                &apos;accessFlags&apos; : readuleb128(f)</div><div class="line">            &#125;</div><div class="line">            instanceFields.append(tmpinstanceFields)</div><div class="line">    #-----</div><div class="line">    directMethods = []</div><div class="line">    if header[&apos;directMethodsSize&apos;] != 0:</div><div class="line">        for i in range(header[&apos;directMethodsSize&apos;]):</div><div class="line">            tmpdirectMethods = &#123;</div><div class="line">                &apos;method&apos; : DexStruct.DexMethods[readuleb128(f)],</div><div class="line">                &apos;accessFlags&apos; : readuleb128(f),</div><div class="line">                &apos;codeOff&apos;: readuleb128(f),</div><div class="line">                ####### dexcode è¿˜æ²¡è§£æ</div><div class="line">            &#125;</div><div class="line">            directMethods.append(tmpdirectMethods)</div><div class="line">    #-----</div><div class="line">    virtualMethods = []</div><div class="line">    if header[&apos;virtualMethodsSize&apos;] != 0:</div><div class="line">        for i in range(header[&apos;virtualMethodsSize&apos;]):</div><div class="line">            tmpvirtualMethods = &#123;</div><div class="line">                &apos;method&apos; : DexStruct.DexMethods[readuleb128(f)],</div><div class="line">                &apos;accessFlags&apos; : readuleb128(f),</div><div class="line">                &apos;codeOff&apos; : readuleb128(f)</div><div class="line">                ####### dexcode è¿˜æ²¡è§£æ</div><div class="line">            &#125;</div><div class="line">            virtualMethods.append(tmpvirtualMethods)</div><div class="line">    DexClassData = &#123;</div><div class="line">        &apos;DexClassDataHeader&apos; : header,</div><div class="line">        &apos;staticFields&apos; : staticFields,</div><div class="line">        &apos;instanceFields&apos; : instanceFields,</div><div class="line">        &apos;directMethods&apos; : directMethods,</div><div class="line">        &apos;virtualMethods&apos; : virtualMethods,</div><div class="line">    &#125;</div><div class="line">    return DexClassData</div><div class="line">def parseClassdef_StaticValue(f):</div><div class="line">    staticvalue_off = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">    if staticvalue_off == 0:</div><div class="line">        return None</div><div class="line">    return None ## è¿˜æ²¡è§£æ encoded value</div><div class="line">def parseClassdefs(f):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    æ­¤å‡½æ•°åŸºäºä¹‹å‰æ‰€æœ‰çš„å‡½æ•°ç»“æœ</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;classDefsSize&apos;]):</div><div class="line">        item_off = i*4*8 + DexStruct.DexHeader[&apos;classDefsOff&apos;]</div><div class="line">        f.seek(item_off)</div><div class="line">        class_name = parseClassdef_Name(f)</div><div class="line">        class_accessflag = parseClassdef_Accessflag(f)</div><div class="line">        class_superclass = parseClassdef_Superclass(f)</div><div class="line">        class_interface = parseClassdef_Interface(f)</div><div class="line">        f.seek(item_off+4*4)</div><div class="line">        class_sourcefile = parseClassdef_Sourcefile(f)</div><div class="line">        class_annotation = parseClassdef_Annotations(f)</div><div class="line">        f.seek(item_off+4*6)</div><div class="line">        class_classdata = parseClassdef_ClassData(f)</div><div class="line">        f.seek(item_off+4*7)</div><div class="line">        class_staticvalue = parseClassdef_StaticValue(f)</div><div class="line">        tmpDexClassDef = &#123;</div><div class="line">            &apos;class&apos; : class_name,</div><div class="line">            &apos;accessFlags&apos; : class_accessflag,</div><div class="line">            &apos;superclass&apos; : class_superclass,</div><div class="line">            &apos;interfaces&apos; : class_interface,</div><div class="line">            &apos;sourceFile&apos; : class_sourcefile,</div><div class="line">            &apos;annotations&apos; : class_annotation,</div><div class="line">            &apos;classData&apos; : class_classdata,</div><div class="line">            &apos;staticValue&apos; : class_staticvalue,</div><div class="line">        &#125;</div><div class="line">        DexStruct.DexClassDefs.append(tmpDexClassDef)</div></pre></td></tr></table></figure>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - ç´¢å¼•åŒºå’Œæ•°æ®åŒºï¼ˆäºŒï¼‰ - Protos & Fields & Methods]]></title>
      <url>/2015/11/20/parse-dex-file-part-protos-fields-methods/</url>
      <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-2.png" alt="part-2"></p>
<a id="more"></a>
<h1 id="ProtoIds"><a href="#ProtoIds" class="headerlink" title="ProtoIds"></a>ProtoIds</h1><p>ProtoIds å­˜æ”¾çš„æ˜¯<strong>åŸå‹çš„å£°æ˜</strong>ï¼ŒåŒ…æ‹¬åŸå‹ç®€åã€å‚æ•°å’Œè¿”å›å€¼ã€‚<br>ProtoIds çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>ProtoIds ä»¥4å­—èŠ‚å¯¹é½ï¼Œå³æ€»å¤§å°ä¸º 4 * 3 * protoIdsSize .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;proto_id_item&quot;.</div><div class="line"> */</div><div class="line">struct DexProtoId &#123;</div><div class="line">    u4  shortyIdx;          /* æŒ‡å‘ stringIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºç®€å */</div><div class="line">    u4  returnTypeIdx;      /* æŒ‡å‘ TypeIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºè¿”å›ç±»å‹ */</div><div class="line">    u4  parametersOff;      /* æŒ‡å‘ type_list çš„æ–‡ä»¶åç§»ï¼Œè¡¨ç¤ºå‚æ•°åˆ—è¡¨ï¼Œä¸º 0 è¡¨ç¤ºæ²¡æœ‰å‚æ•°ï¼Œå‚æ•°ç±»å‹ä¸­æ²¡æœ‰ç©º*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;type_list&quot;.</div><div class="line"> */</div><div class="line">struct DexTypeList &#123;</div><div class="line">    u4  size;               /* DexTypeItem çš„ä¸ªæ•° */</div><div class="line">    DexTypeItem list[1];    /* DexTypeItem æ•°ç»„å†…å®¹ */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;type_item&quot;.</div><div class="line"> */</div><div class="line">struct DexTypeItem &#123;</div><div class="line">    u2  typeIdx;            /* æŒ‡å‘ typeIds çš„ç´¢å¼•*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="æ‰‹å·¥æŸ¥æ‰¾"><a href="#æ‰‹å·¥æŸ¥æ‰¾" class="headerlink" title="æ‰‹å·¥æŸ¥æ‰¾"></a>æ‰‹å·¥æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ ProtoIds éƒ¨åˆ†</strong>ï¼š</p>
<p>protoIdsSize : 0x12<br>protoIdsOff : 0x0244</p>
<p>0x0244 ~ 0x031c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">00000240  .. .. .. .. 06 00 00 00  00 00 00 00 40 0a 00 00  |)...........@...|</div><div class="line">00000250  07 00 00 00 01 00 00 00  00 00 00 00 08 00 00 00  |................|</div><div class="line">00000260  01 00 00 00 48 0a 00 00  09 00 00 00 08 00 00 00  |....H...........|</div><div class="line">00000270  00 00 00 00 0a 00 00 00  0c 00 00 00 f8 09 00 00  |................|</div><div class="line">00000280  09 00 00 00 0f 00 00 00  00 00 00 00 0a 00 00 00  |................|</div><div class="line">00000290  14 00 00 00 14 0a 00 00  .. .. .. .. .. .. .. ..  </div><div class="line">........  .. .. .. .. .. .. .. ..  28 00 00 00 17 00 00 00  |........(.......|</div><div class="line">00000300  2c 0a 00 00 27 00 00 00  17 00 00 00 1c 0a 00 00  |,...&apos;...........|</div><div class="line">00000310  .. .. .. .. .. .. .. ..  14 0a 00 00</div></pre></td></tr></table></figure>
<p>ä»¥ç¬¬ä¸€ä¸ª DexProtoId ä¸ºä¾‹ï¼Œ<br>shortyIdx=0x06 =&gt; stringIdOff=0x88 =&gt; stringDataOff=0x0544 =&gt; IL<br>returnTypeIdx=0x00 =&gt; stringId=0x05 =&gt; StringIdOff=0x84 =&gt; stringDataOff=0x0541 =&gt; I<br>parametersOff=0x0a40 =&gt; <code>01 00 00 00 18 00</code> =&gt; typeIdOff=0x240 =&gt; stringIdOff=0x29 =&gt; stringDataOff=0x079c =&gt; [B<br>å³æ­¤å‡½æ•°å£°æ˜ä¸º int (Byte[])</p>
<p><strong>ä»¥æ­¤ç±»æ¨ï¼š</strong></p>
<table>
<thead>
<tr>
<th>åºæ•°</th>
<th>åŸå‹</th>
<th>è¿”å›å€¼</th>
<th>å‚æ•°</th>
<th>æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>IL</td>
<td>I</td>
<td>[B</td>
<td>int (Byte[])</td>
</tr>
<tr>
<td>0x01</td>
<td>J</td>
<td>J</td>
<td>æ— </td>
<td>long ()</td>
</tr>
<tr>
<td>0x02</td>
<td>JL</td>
<td>J</td>
<td>Ljava/io/File;</td>
<td>long (File)</td>
</tr>
<tr>
<td>0x03</td>
<td>L</td>
<td>Ljava/io/File;</td>
<td>æ— </td>
<td>File ()</td>
</tr>
<tr>
<td>0x04</td>
<td>LL</td>
<td>Ljava/io/InputStream;</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>InputStream (ZipENtry)</td>
</tr>
<tr>
<td>0x05</td>
<td>L</td>
<td>Ljava/lang/String;</td>
<td>æ— </td>
<td>String ()</td>
</tr>
<tr>
<td>0x06</td>
<td>LL</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>Ljava/lang/String;</td>
<td>ZipEntry (String)</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td>0x10</td>
<td>ZLL</td>
<td>Z</td>
<td>Landroid/app/Application; Ljava/lang/String;</td>
<td>bool (Application,String)</td>
</tr>
<tr>
<td>0x11</td>
<td>ZL</td>
<td>Z</td>
<td>Ljava/lang/Object;</td>
<td>bool (Object)</td>
</tr>
<tr>
<td>0x12</td>
<td>ZL</td>
<td>Z</td>
<td>Ljava/lang/String;</td>
<td>bool (String)</td>
</tr>
</tbody>
</table>
<h2 id="å†™ç¨‹åºè§£æ"><a href="#å†™ç¨‹åºè§£æ" class="headerlink" title="å†™ç¨‹åºè§£æ"></a>å†™ç¨‹åºè§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">def parseProtos(f):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    æ­¤å‡½æ•°åŸºäº parseStrings å’Œ parseTypes å‡½æ•°çš„ç»“æœ</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    cur_pos = 0</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;protoIdsSize&apos;]):</div><div class="line">        f.seek(DexStruct.DexHeader[&apos;protoIdsOff&apos;] + cur_pos)</div><div class="line">        proto_shortyId = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        proto_returnTypeId = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        proto_paramtersOff = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        parameters = []</div><div class="line">        if proto_paramtersOff &gt; 0:  # æœ‰å‚æ•°å†è¯»å–</div><div class="line">            f.seek(proto_paramtersOff)</div><div class="line">            param_size = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">            for j in range(param_size):</div><div class="line">                param_typeId = struct.unpack(&apos;H&apos;,f.read(2))[0]</div><div class="line">                parameters.append(DexStruct.DexTypes[param_typeId][&apos;content&apos;])</div><div class="line">        tmpDexProto = &#123;</div><div class="line">            &apos;shortyDescription&apos; : DexStruct.DexStrings[proto_shortyId][&apos;content&apos;],</div><div class="line">            &apos;returnType&apos; : DexStruct.DexTypes[proto_returnTypeId][&apos;content&apos;],</div><div class="line">            &apos;parameters&apos; :  parameters,</div><div class="line">        &#125;;</div><div class="line">        DexStruct.DexProtos.append(tmpDexProto)</div><div class="line">        cur_pos += 12</div></pre></td></tr></table></figure>
<hr>
<h1 id="FieldIds"><a href="#FieldIds" class="headerlink" title="FieldIds"></a>FieldIds</h1><p>fields è¡¨ç¤ºçš„æ˜¯ç±»ä¸­çš„å­—æ®µï¼ŒåŒ…æ‹¬æœ¬å­—æ®µæ‰€å±çš„ç±»ã€å­—æ®µç±»å‹å’Œå­—æ®µåã€‚<br>FieldIds çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<h2 id="ç»“æ„-1"><a href="#ç»“æ„-1" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>ä»¥ 4 å­—èŠ‚å¯¹é½ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;field_id_item&quot;.</div><div class="line"> */</div><div class="line">struct DexFieldId &#123;</div><div class="line">    u2  classIdx;           /* æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºå®šä¹‰è¿™ä¸ªå­—æ®µçš„ç±» */</div><div class="line">    u2  typeIdx;            /* æŒ‡å‘ typeIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºå­—æ®µç±»å‹ */</div><div class="line">    u4  nameIdx;            /* æŒ‡å‘ stringIds çš„ç´¢å¼•ï¼Œè¡¨ç¤ºå­—æ®µå*/</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="æ‰‹åŠ¨æŸ¥æ‰¾"><a href="#æ‰‹åŠ¨æŸ¥æ‰¾" class="headerlink" title="æ‰‹åŠ¨æŸ¥æ‰¾"></a>æ‰‹åŠ¨æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ FieldIds éƒ¨åˆ†</strong>ï¼š</p>
<p>fieldIdsSize : 0x01<br>fieldIdsOff : 0x031c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">00000310  .. .. .. .. .. .. .. ..  .. .. .. .. 04 00 0f 00  |&apos;...............|</div><div class="line">00000320  04 00 00 00 .. .. .. ..  .. .. .. .. .. .. .. ..  |................|</div></pre></td></tr></table></figure>
<p>ç”± DexFieldId å¯å¾— ï¼š<br>classIdx=0x0004 =&gt; typeId=0x0d =&gt; stringDataOff=0x00a4 =&gt; Landroid/os/Build;<br>typeIdx=0x000f =&gt; typeId=0x18 =&gt; stringDataOff=0x00d0 =&gt; Ljava/lang/String;<br>nameIdx=0x00000004 =&gt; stringDataOff=0x0538 =&gt; CPU_ABI</p>
<h2 id="å†™ç¨‹åºè§£æ-1"><a href="#å†™ç¨‹åºè§£æ-1" class="headerlink" title="å†™ç¨‹åºè§£æ"></a>å†™ç¨‹åºè§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def parseFields(f):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    æ­¤å‡½æ•°åŸºäº parseStrings å’Œ parseTypes å‡½æ•°çš„ç»“æœ</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    f.seek(DexStruct.DexHeader[&apos;fieldIdsOff&apos;])</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;fieldIdsSize&apos;]):</div><div class="line">        field_class = DexStruct.DexTypes[struct.unpack(&apos;H&apos;,f.read(2))[0]][&apos;content&apos;]</div><div class="line">        field_type = DexStruct.DexTypes[struct.unpack(&apos;H&apos;,f.read(2))[0]][&apos;content&apos;]</div><div class="line">        field_name = DexStruct.DexStrings[struct.unpack(&apos;I&apos;,f.read(4))[0]][&apos;content&apos;]</div><div class="line">        tmpDexFieldItem = &#123;</div><div class="line">            &apos;class&apos; : field_class,</div><div class="line">            &apos;Type&apos; : field_type,</div><div class="line">            &apos;name&apos; : field_name,</div><div class="line">        &#125;</div><div class="line">        DexStruct.DexFields.append(tmpDexFieldItem)</div></pre></td></tr></table></figure>
<hr>
<h1 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h1><p>MethodId è¡¨ç¤ºçš„æ˜¯æ–¹æ³•ï¼ŒåŒ…æ‹¬æœ¬æ–¹æ³•æ‰€å±çš„ç±»ã€æ–¹æ³•åŸå‹ (proto) å’Œæ–¹æ³•åã€‚<br>MethodId çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<h2 id="ç»“æ„-2"><a href="#ç»“æ„-2" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>ä»¥ 4 å­—èŠ‚å¯¹é½ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;method_id_item&quot;.</div><div class="line"> */</div><div class="line">struct DexMethodId &#123;</div><div class="line">    u2  classIdx;           /* æŒ‡å‘ typeIdsï¼Œè¡¨ç¤ºå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±» */</div><div class="line">    u2  protoIdx;           /* æŒ‡å‘ protoIdsï¼Œè¡¨ç¤ºæ–¹æ³•çš„åŸå‹*/</div><div class="line">    u4  nameIdx;            /* æŒ‡å‘ stringIdsï¼Œè¡¨ç¤ºæ–¹æ³•å */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="æ‰‹åŠ¨æŸ¥æ‰¾-1"><a href="#æ‰‹åŠ¨æŸ¥æ‰¾-1" class="headerlink" title="æ‰‹åŠ¨æŸ¥æ‰¾"></a>æ‰‹åŠ¨æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ methodIds éƒ¨åˆ†</strong>ï¼š</p>
<p>methodIdsSize : 0x2b<br>methodIdsOff : 0x0324</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">00000320  .. .. .. .. 02 00 07 00  03 00 00 00 02 00 08 00  |................|</div><div class="line">00000330  30 00 00 00 .. ...</div><div class="line">........</div><div class="line">00000470  42 00 00 00 15 00 04 00  43 00 00 00</div></pre></td></tr></table></figure>
<p>ä»¥ç¬¬ä¸€ä¸ª <code>02 00 07 00 03 00 00 00</code> ä¸ºä¾‹ï¼š<br>classIdx=0x02 =&gt; Landroid/app/Application;<br>protoIdx=0x07 =&gt; void ()<br>nameIdx=0x03 =&gt; &lt;init&gt;<br>å³è¯¥å‡½æ•°ä¸º void android.app.Application.&lt;init&gt;()</p>
<p>ä»¥æ­¤ç±»æ¨ï¼š</p>
<table>
<thead>
<tr>
<th>åºæ•°</th>
<th>æ‰€å±çš„ç±»</th>
<th>å‡½æ•°åŸå‹</th>
<th>å‡½æ•°å</th>
<th>å…¨ç§°</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>Landroid/app/Application;</td>
<td>void ()</td>
<td><init></init></td>
<td>void android.app.Application.<init>()</init></td>
</tr>
<tr>
<td>0x01</td>
<td>Landroid/app/Application;</td>
<td>void (android.content.Context)</td>
<td>attachBaseContext</td>
<td>void android.app.Application.attachBaseContext(android.content.Context)</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td>0x2b</td>
<td>Ljava/util/zip/ZipFile;</td>
<td>InputStream (ZipENtry)</td>
<td>getInputStream</td>
<td>java.io.InputStream java.util.zip.ZipFile.getInputStream(java.util.zip.ZipEntry)</td>
</tr>
</tbody>
</table>
<h2 id="å†™ç¨‹åºè§£æ-2"><a href="#å†™ç¨‹åºè§£æ-2" class="headerlink" title="å†™ç¨‹åºè§£æ"></a>å†™ç¨‹åºè§£æ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def parseMethods(f):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    æ­¤å‡½æ•°åŸºäº parseStringsã€parseProtos å’Œ parseTypes å‡½æ•°çš„ç»“æœ</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    f.seek(DexStruct.DexHeader[&apos;methodIdsOff&apos;])</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;methodIdsSize&apos;]):</div><div class="line">        method_class = DexStruct.DexTypes[struct.unpack(&apos;H&apos;,f.read(2))[0]][&apos;content&apos;]</div><div class="line">        method_proto = DexStruct.DexProtos[struct.unpack(&apos;H&apos;,f.read(2))[0]]</div><div class="line">        method_name = DexStruct.DexStrings[struct.unpack(&apos;I&apos;,f.read(4))[0]][&apos;content&apos;]</div><div class="line">        tmpDexMethodItem = &#123;</div><div class="line">            &apos;class&apos; : method_class,</div><div class="line">            &apos;proto&apos; : method_proto,</div><div class="line">            &apos;name&apos; : method_name,</div><div class="line">        &#125;</div><div class="line">        DexStruct.DexMethods.append(tmpDexMethodItem)</div></pre></td></tr></table></figure>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - ç´¢å¼•åŒºå’Œæ•°æ®åŒºï¼ˆä¸€ï¼‰ - Strings & Types]]></title>
      <url>/2015/11/19/parse-dex-file-part-strings-and-type-descriptors/</url>
      <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-1.png" alt="part-1"></p>
<a id="more"></a>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ <a href="http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/" target="_blank" rel="external">è§£æ dex æ–‡ä»¶ç»“æ„ - DexHeader</a> ä¸­æˆ‘ä»¬çŸ¥é“ Table éƒ¨åˆ†å°±æ˜¯ç´¢å¼•ç»“æ„åŒºï¼Œä»–ä»¬æ˜¯æ˜¯ä½œä¸ºæŒ‡å‘ Data åŒºæ•°æ®çš„ç»“æ„ç´¢å¼•è€Œå­˜åœ¨çš„ã€‚<br>æ•°æ®åŒºæ˜¯ dex ä¼šç”¨åˆ°çš„å…¨éƒ¨æ•°æ®ã€‚</p>
<hr>
<h1 id="StringIds-å’Œ-StringData"><a href="#StringIds-å’Œ-StringData" class="headerlink" title="StringIds å’Œ StringData"></a>StringIds å’Œ StringData</h1><p>StringIds å­˜æ”¾çš„æ˜¯å­—ç¬¦ä¸²çš„ idï¼Œä¹Ÿå°±æ˜¯æ•°æ®åŒºä¸­å„ä¸ª StringData çš„æ–‡ä»¶åç§»ã€‚<br>StringIds çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>StringIds ä»¥4å­—èŠ‚å¯¹é½ï¼Œå³æ€»å¤§å°ä¸º 4 * stringIdsSize .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;string_id_item&quot;.</div><div class="line"> */</div><div class="line">struct DexStringId &#123;</div><div class="line">    u4 stringDataOff;      /* file offset to string_data_item */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>æŒ‰ç…§ StringIds æŒ‡ç¤ºçš„åç§»æ¥åˆ°æ•°æ®åŒºå¯¹åº”çš„ä½ç½®ï¼ŒStringData é‡‡ç”¨çš„æ ¼å¼ä¸ºï¼š</p>
<p><strong>å­—ç¬¦ä¸²é•¿åº¦</strong> : uleb128 æ ¼å¼ï¼Œä¸åŒ…æ‹¬å­—ç¬¦ä¸²å°¾éƒ¨çš„ 00 ã€‚<br><strong>å­—ç¬¦ä¸²å†…å®¹</strong>ï¼šMUTF-8(ç»è¿‡ä¿®æ”¹çš„UTF-8)ï¼Œä»¥ 00 ç»“å°¾ .</p>
<h2 id="æ‰‹å·¥æŸ¥æ‰¾"><a href="#æ‰‹å·¥æŸ¥æ‰¾" class="headerlink" title="æ‰‹å·¥æŸ¥æ‰¾"></a>æ‰‹å·¥æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ StringIds éƒ¨åˆ†</strong>ï¼š</p>
<p>stringIdsSizeï¼š0x5c<br>stringIdsOffï¼š0x0070</p>
<p>0x0070 ~ 0x01df</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">00000070  bc 04 00 00 ef 04 00 00  26 05 00 00 30 05 00 00  |........&amp;...0...|</div><div class="line">00000080  38 05 00 00 41 05 00 00  44 05 00 00 48 05 00 00  |8...A...D...H...|</div><div class="line">00000090  4b 05 00 00 4f 05 00 00  52 05 00 00 56 05 00 00  |K...O...R...V...|</div><div class="line">000000a0  71 05 00 00 8c 05 00 00  a0 05 00 00 bf 05 00 00  |q...............|</div><div class="line">000000b0  dd 05 00 00 f9 05 00 00  09 06 00 00 24 06 00 00  |............$...|</div><div class="line">000000c0  40 06 00 00 57 06 00 00  6e 06 00 00 85 06 00 00  |@...W...n.......|</div><div class="line">........  .. .. .. ..</div><div class="line">000001c0  c4 09 00 00 c9 09 00 00  d1 09 00 00 dd 09 00 00  |................|</div><div class="line">000001d0  e4 09 00 00 eb 09 00 00  f0 09 00 00 f4 09 00 00  |................|</div></pre></td></tr></table></figure>
<p>ä»¥ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œæ–‡ä»¶åç§»ä¸º <code>bc 04 00 00</code>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">000004b0  64 0a 00 00 de 0f 00 00  00 00 00 00 31 2f 64 61  |d...........1/da|</div><div class="line">000004c0  74 61 2f 64 61 74 61 2f  63 6f 6d 2e 7a 79 68 2e  |ta/data/com.zyh.|</div><div class="line">000004d0  6c 69 67 68 74 69 6e 67  62 61 63 6b 75 70 2f 2e  |lightingbackup/.|</div><div class="line">000004e0  6c 69 62 2f 6c 69 62 65  78 65 63 2e 73 6f 00 35  |lib/libexec.so.5|</div></pre></td></tr></table></figure></p>
<p>æ ¹æ® <a href="http://kiya-z.github.io/2015/11/18/parse-dex-file-part-leb128/" target="_blank" rel="external">LEB128 çš„è§£ç æ ¼å¼</a>å¯çŸ¥ï¼š<br>å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 0x31(æœ‰æ•ˆä½ï¼š011 0001) = 49 ä¸ªå­—èŠ‚ã€‚(â€œ/data/data/com.zyh.lightingbackup/.lib/libexec.soâ€)</p>
<p><strong>ä»¥æ­¤ç±»æ¨ï¼š</strong></p>
<table>
<thead>
<tr>
<th>åºæ•°</th>
<th>æ–‡ä»¶åç§»</th>
<th>å­—ç¬¦ä¸²é•¿åº¦</th>
<th>å­—ç¬¦ä¸²</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>0x04bc</td>
<td>0x31</td>
<td>/data/data/com.zyh.lightingbackup/.lib/libexec.so</td>
</tr>
<tr>
<td>0x01</td>
<td>0x04ef</td>
<td>0x35</td>
<td>/data/data/com.zyh.lightingbackup/.lib/libexecmain.so</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td>0x04</td>
<td>0x0538</td>
<td>0x07</td>
<td>CPU_ABI</td>
</tr>
<tr>
<td>0x05</td>
<td>0x0541</td>
<td>0x01</td>
<td>I</td>
</tr>
<tr>
<td>0x06</td>
<td>0x0544</td>
<td>0x02</td>
<td>IL</td>
</tr>
<tr>
<td>0x07</td>
<td>0x0548</td>
<td>0x01</td>
<td>J</td>
</tr>
<tr>
<td>0x08</td>
<td>0x054b</td>
<td>0x02</td>
<td>JL</td>
</tr>
<tr>
<td>0x09</td>
<td>0x054f</td>
<td>0x01</td>
<td>L</td>
</tr>
<tr>
<td>0x0a</td>
<td>0x0552</td>
<td>0x02</td>
<td>LL</td>
</tr>
<tr>
<td>0x0b</td>
<td>0x0556</td>
<td>0x19</td>
<td>Landroid/app/Application;</td>
</tr>
<tr>
<td>0x0c</td>
<td>0x0571</td>
<td>0x19</td>
<td>Landroid/content/Context;</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td>0x5b</td>
<td>0x09f0</td>
<td>0x02</td>
<td>ze</td>
</tr>
<tr>
<td>0x5c</td>
<td>0x09f4</td>
<td>0x02</td>
<td>zf</td>
</tr>
</tbody>
</table>
<h2 id="å†™ç¨‹åºè§£æå­—ç¬¦ä¸²"><a href="#å†™ç¨‹åºè§£æå­—ç¬¦ä¸²" class="headerlink" title="å†™ç¨‹åºè§£æå­—ç¬¦ä¸²"></a>å†™ç¨‹åºè§£æå­—ç¬¦ä¸²</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">def readuleb128(f):</div><div class="line">    num = struct.unpack(&apos;B&apos;,f.read(1))[0]     # è¯»ç¬¬ä¸€å­—èŠ‚</div><div class="line">    if num &gt; 0x7f :</div><div class="line">        cur = struct.unpack(&apos;B&apos;,f.read(1))[0]     #è¯»ç¬¬äºŒå­—èŠ‚</div><div class="line">        num = (num &amp; 0x7f) | ((cur &amp; 0x7f) &lt;&lt; 7)</div><div class="line">        if cur &gt; 0x7f:</div><div class="line">            cur = struct.unpack(&apos;B&apos;,f.read(1))[0]     #è¯»ç¬¬ä¸‰å­—èŠ‚</div><div class="line">            num = num | ((cur &amp; 0x7f) &lt;&lt; 14)</div><div class="line">            if cur &gt; 0x7f:</div><div class="line">                cur = struct.unpack(&apos;B&apos;,f.read(1))[0]     #è¯»ç¬¬å››å­—èŠ‚</div><div class="line">                num = num | ((cur &amp; 0x7f) &lt;&lt; 21)</div><div class="line">                if cur &gt; 0x7f:</div><div class="line">                    cur = struct.unpack(&apos;B&apos;,f.read(1))[0]     #è¯»ç¬¬äº”å­—èŠ‚</div><div class="line">                    num = num | ((cur &amp; 0x7f) &lt;&lt; 28)</div><div class="line">    return num</div><div class="line">def parseStrings(f):</div><div class="line">    f.seek(DexStruct.DexHeader[&apos;stringIdsOff&apos;])</div><div class="line">    stringIds_data = f.read(4*DexStruct.DexHeader[&apos;stringIdsSize&apos;])</div><div class="line">    cur_pos = 0</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;stringIdsSize&apos;]):</div><div class="line">        str_off =  struct.unpack(&apos;I&apos;,stringIds_data[cur_pos:cur_pos+4])[0]</div><div class="line">        f.seek(str_off)</div><div class="line">        str_len = readuleb128(f)</div><div class="line">        str_content = f.read(str_len)</div><div class="line">        cur_pos += 4</div><div class="line">        tmpDexStringItem = &#123;</div><div class="line">            &apos;offset&apos; : str_off,</div><div class="line">            &apos;len&apos; : str_len,</div><div class="line">            &apos;content&apos; : str_content,</div><div class="line">        &#125;</div><div class="line">        DexStruct.DexStrings.append(tmpDexStringItem)</div></pre></td></tr></table></figure>
<hr>
<h1 id="TypeIds"><a href="#TypeIds" class="headerlink" title="TypeIds"></a>TypeIds</h1><p>TypeIds å­˜æ”¾çš„æ˜¯ stringIds å†…çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´ StringData é‡Œé¢çš„ä¸€äº›å­—ç¬¦ä¸²æ˜¯ç±»å‹æè¿°ç¬¦ã€‚<br>TypeIds çš„å¤§å°å’Œæ–‡ä»¶åç§»åœ¨ DexHeader å’Œ map_list ä¸­éƒ½æœ‰æŒ‡å®šã€‚</p>
<p>è¿™é‡Œçš„ç±»å‹æè¿°ç¬¦å¯ä»¥ä»£è¡¨ dex æ–‡ä»¶ä¸­çš„ä»»ä½•ç±»å‹ï¼ŒåŒ…æ‹¬åŸºæœ¬ç±»å‹ï¼Œç±»ç±»å‹ï¼Œæ•°ç»„ç±»å‹å’Œç©ºç±»å‹ã€‚</p>
<h2 id="ç»“æ„-1"><a href="#ç»“æ„-1" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>TypeIds ä»¥4å­—èŠ‚å¯¹é½ï¼Œå³æ€»å¤§å°ä¸º 4 * typeIdsSize .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;type_id_item&quot;.</div><div class="line"> */</div><div class="line">struct DexTypeId &#123;</div><div class="line">    u4  descriptorIdx;      /* index into stringIds list for type descriptor */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>descriptorIdx</code> å¯ä»¥å¾—åˆ°ç›¸åº”<code>ç±»å‹æè¿°ç¬¦</code>çš„å­—ç¬¦ä¸²çš„ StringIdï¼Œä»è€Œæ‰¾åˆ°ç›¸åº”çš„å­—ç¬¦ä¸²ã€‚</p>
<h2 id="æ‰‹åŠ¨æŸ¥æ‰¾"><a href="#æ‰‹åŠ¨æŸ¥æ‰¾" class="headerlink" title="æ‰‹åŠ¨æŸ¥æ‰¾"></a>æ‰‹åŠ¨æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ TypeIds éƒ¨åˆ†</strong>ï¼š</p>
<p>TypeIdsSizeï¼š0x19<br>TypeIdsOffï¼š0x01e0</p>
<p>0x01e0 ~ 0x0244</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">000001e0  05 00 00 00 07 00 00 00  0b 00 00 00 0c 00 00 00  |................|</div><div class="line">000001f0  0d 00 00 00 0e 00 00 00  0f 00 00 00 10 00 00 00  |................|</div><div class="line">00000200  11 00 00 00 12 00 00 00  13 00 00 00 14 00 00 00  |................|</div><div class="line">00000210  15 00 00 00 16 00 00 00  17 00 00 00 18 00 00 00  |................|</div><div class="line">00000220  19 00 00 00 1a 00 00 00  1b 00 00 00 1c 00 00 00  |................|</div><div class="line">00000230  1d 00 00 00 1e 00 00 00  21 00 00 00 26 00 00 00  |........!...&amp;...|</div><div class="line">00000240  29 00 00 00</div></pre></td></tr></table></figure>
<p>ä»¥ç¬¬ä¸€ä¸ªç´¢å¼•å€¼ 0x05 ä¸ºä¾‹ï¼Œåœ¨ StringIds ä¸­æ‰¾åˆ°ç¬¬ 0x05 ä¸ª StringIdï¼Œä¹Ÿå°±æ˜¯ 0x0070(stringIdsOff) + 0x05 * 4 = 0x0084ï¼Œ<br>è¯¥åœ°å€å€¼ä¸º 0x0541ï¼Œ0x0541 å¤„çš„å­—ç¬¦ä¸²ä¸º â€œIâ€ï¼Œint ç±»å‹ã€‚ç±»å‹å¯¹ç…§å‚è§ä¸‹è¡¨ - Dalvik å­—èŠ‚ç ç±»å‹ã€‚</p>
<table>
<thead>
<tr>
<th>è¯­æ³•</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>V</td>
<td>void; åªç”¨äºè¿”å›å€¼</td>
</tr>
<tr>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>B</td>
<td>byte</td>
</tr>
<tr>
<td>S</td>
<td>short</td>
</tr>
<tr>
<td>C</td>
<td>char</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>F</td>
<td>float</td>
</tr>
<tr>
<td>D</td>
<td>double</td>
</tr>
<tr>
<td>Lfully/qualified/Name;</td>
<td>ç±»åï¼šfully.qualified.Name</td>
</tr>
<tr>
<td>[descriptor</td>
<td>æ•°ç»„æè¿°ç¬¦ï¼Œå¯ä»¥è¡¨ç¤ºå¤šç»´æ•°ç»„å¦‚ [[[descriptorï¼Œä½†æœ€å¤šåªèƒ½æœ‰255ä¸ªç»´åº¦</td>
</tr>
</tbody>
</table>
<p>ä»¥æ­¤ç±»æ¨ï¼š</p>
<table>
<thead>
<tr>
<th>åºæ•°</th>
<th>descriptorIdx</th>
<th>StringId</th>
<th>Type</th>
<th>çœŸæ­£ç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>0x05</td>
<td>0x0084</td>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>0x01</td>
<td>0x07</td>
<td>0x008c</td>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>0x02</td>
<td>0x0b</td>
<td>0x009c</td>
<td>Landroid/app/Application;</td>
<td>android.app.Application</td>
</tr>
<tr>
<td>0x03</td>
<td>0x0c</td>
<td>0x00a0</td>
<td>Landroid/content/Context;</td>
<td>android.content.Context</td>
</tr>
<tr>
<td>0x04</td>
<td>0x0d</td>
<td>0x00a4</td>
<td>Landroid/os/Build;</td>
<td>android.os.Build</td>
</tr>
<tr>
<td>0x05</td>
<td>0x0e</td>
<td>0x00a8</td>
<td>Lcom/shell/NativeApplication;</td>
<td>com.shell.NativeApplication</td>
</tr>
<tr>
<td>0x06</td>
<td>0x0f</td>
<td>0x00ac</td>
<td>Lcom/shell/SuperApplication;</td>
<td>com.shell.SuperApplication</td>
</tr>
<tr>
<td>0x07</td>
<td>0x10</td>
<td>0x00b0</td>
<td>Ldalvik/annotation/Throws;</td>
<td>dalvik.annotation.Throws</td>
</tr>
<tr>
<td>0x08</td>
<td>0x11</td>
<td>0x00b4</td>
<td>Ljava/io/File;</td>
<td>java.io.File</td>
</tr>
<tr>
<td>0x09</td>
<td>0x12</td>
<td>0x00b8</td>
<td>Ljava/io/FileInputStream;</td>
<td>java.io.FileInputStream</td>
</tr>
<tr>
<td>0x0a</td>
<td>0x13</td>
<td>0x00bc</td>
<td>Ljava/io/FileOutputStream;</td>
<td>java.io.FileOutputStream</td>
</tr>
<tr>
<td>0x0b</td>
<td>0x14</td>
<td>0x00c0</td>
<td>Ljava/io/IOException;</td>
<td>java.io.IOException</td>
</tr>
<tr>
<td>0x0c</td>
<td>0x15</td>
<td>0x00c4</td>
<td>Ljava/io/InputStream;</td>
<td>java.io.InputStream</td>
</tr>
<tr>
<td>0x0d</td>
<td>0x16</td>
<td>0x00c8</td>
<td>Ljava/lang/Exception;</td>
<td>java.lang.Exception</td>
</tr>
<tr>
<td>0x0e</td>
<td>0x17</td>
<td>0x00cc</td>
<td>Ljava/lang/Object;</td>
<td>java.lang.Object</td>
</tr>
<tr>
<td>0x0f</td>
<td>0x18</td>
<td>0x00d0</td>
<td>Ljava/lang/String;</td>
<td>java.lang.String</td>
</tr>
<tr>
<td>0x10</td>
<td>0x19</td>
<td>0x00d4</td>
<td>Ljava/lang/System;</td>
<td>java.lang.System</td>
</tr>
<tr>
<td>0x11</td>
<td>0x1a</td>
<td>0x00d8</td>
<td>Ljava/util/zip/CRC32;</td>
<td>java.util.zip.CRC32</td>
</tr>
<tr>
<td>0x12</td>
<td>0x1b</td>
<td>0x00dc</td>
<td>Ljava/util/zip/CheckedInputStream;</td>
<td>java.util.zip.CheckedInputStream</td>
</tr>
<tr>
<td>0x13</td>
<td>0x1c</td>
<td>0x00e0</td>
<td>Ljava/util/zip/Checksum;</td>
<td>java.util.zip.Checksum</td>
</tr>
<tr>
<td>0x14</td>
<td>0x1d</td>
<td>0x00e4</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>java.util.zip.ZipEntry</td>
</tr>
<tr>
<td>0x15</td>
<td>0x1e</td>
<td>0x00e8</td>
<td>Ljava/util/zip/ZipFile;</td>
<td>java.util.zip.ZipFile</td>
</tr>
<tr>
<td>0x16</td>
<td>0x21</td>
<td>0x00f4</td>
<td>V</td>
<td>void</td>
</tr>
<tr>
<td>0x17</td>
<td>0x26</td>
<td>0x0108</td>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>0x18</td>
<td>0x29</td>
<td>0x0114</td>
<td>[B]</td>
<td>byte[]</td>
</tr>
</tbody>
</table>
<h2 id="å†™ç¨‹åºè§£æ-TypeIds"><a href="#å†™ç¨‹åºè§£æ-TypeIds" class="headerlink" title="å†™ç¨‹åºè§£æ TypeIds"></a>å†™ç¨‹åºè§£æ TypeIds</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def parseTypes(f):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    æ­¤å‡½æ•°åŸºäº parseStrings å‡½æ•°çš„ç»“æœï¼Œè°ƒç”¨å‰éœ€å…ˆè°ƒç”¨ parseStrings</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    f.seek(DexStruct.DexHeader[&apos;typeIdsOff&apos;])</div><div class="line">    for i in range(DexStruct.DexHeader[&apos;typeIdsSize&apos;]):</div><div class="line">        type_desc_id = struct.unpack(&apos;I&apos;,f.read(4))[0]</div><div class="line">        DexStruct.DexTypes.append(DexStruct.DexStrings[type_desc_id])</div></pre></td></tr></table></figure>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å·ç§° Edit Everything çš„ 010 Editor]]></title>
      <url>/2015/11/19/tools-010-editor/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>010 Editor æ˜¯ä¸€æ¬¾ 16 è¿›åˆ¶ç¼–è¾‘å™¨ï¼ŒText Editor ã€HexEditor ã€Disk Editor &amp; Process Editor .</p>
<a id="more"></a>
<p>æ”¯æŒæ–‡ä»¶çš„äºŒè¿›åˆ¶æ¯”è¾ƒï¼›</p>
<p>æ”¯æŒ bmp ã€avi ã€map3 ã€map4 ç­‰å¸¸è§æ–‡ä»¶å’Œ AndroidManifestã€dex ã€elf ã€exeç­‰ç¨‹åºå‘˜æ–‡ä»¶çš„è§£æï¼Œå­¦ä¹ æ–‡ä»¶æ ¼å¼è§£æçš„æ—¶å€™å†ä¹Ÿä¸ç”¨æ€•ç‚¹æ¥ç‚¹å»æ‰¾ä¸åˆ°å­—èŠ‚äº†ï½<br>è¿™äº›è§£æè„šæœ¬éƒ½æ˜¯ç”±å¾ˆå¤šäººæäº¤çš„ï¼Œå¦‚æœä½ è®¤ä¸ºç°æœ‰çš„è„šæœ¬æœ‰ä½•ä¸è¶³æˆ–è€…ä½ è§£æäº†ä¸€ç§æ–°çš„æ–‡ä»¶æ ¼å¼ï¼Œéƒ½å¯ä»¥å‘ç½‘ç«™æäº¤ï¼Œç„¶åå‡ºç°åœ¨ä¸‹è½½é¡µé¢ï¼</p>
<p>30 å¤©è¯•ç”¨æœŸã€‚</p>
<h2 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h2><p><a href="http://www.sweetscape.com/010editor/" target="_blank" rel="external">å®˜ç½‘</a></p>
<p><a href="http://www.sweetscape.com/010editor/templates/" target="_blank" rel="external">è„šæœ¬ä¸‹è½½</a></p>
<p><a href="http://www.sweetscape.com/010editor/features.html" target="_blank" rel="external">å…¨éƒ¨ç‰¹æ€§</a></p>
<p><a href="http://www.sweetscape.com/010editor/screenshots.html" target="_blank" rel="external">åœ¨çº¿å¼•å¯¼</a></p>
]]></content>
      
        <categories>
            
            <category> Cool </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - LEB128]]></title>
      <url>/2015/11/18/parse-dex-file-part-leb128/</url>
      <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>dex æ–‡ä»¶ä¸­ç”¨åˆ°çš„æ•°æ®ç±»å‹æœ‰:</p>
<a id="more"></a>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¼–ç æ ¼å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>byte</td>
<td>8ä½æœ‰ç¬¦å·æ•´æ•°</td>
</tr>
<tr>
<td>ubyte</td>
<td>8ä½æ— ç¬¦å·æ•´æ•°</td>
</tr>
<tr>
<td>short</td>
<td>16ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>ushort</td>
<td>16ä½æ— ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>int</td>
<td>32ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>uint</td>
<td>32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>long</td>
<td>64ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>ulong</td>
<td>64ä½æ— ç¬¦å·æ•´æ•°ï¼Œå°ç«¯å­˜å‚¨</td>
</tr>
<tr>
<td>sleb128</td>
<td>æœ‰ç¬¦å· LEB128ï¼Œå¯å˜é•¿åº¦</td>
</tr>
<tr>
<td>uleb128</td>
<td>æ— ç¬¦å· LEB128ï¼Œå¯å˜é•¿åº¦</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>æ— ç¬¦å· LEB128 åŠ  1ï¼Œå¯å˜é•¿åº¦</td>
</tr>
</tbody>
</table>
<p>[<strong>æ³¨</strong>] å°†ä¸€ä¸ªæ•°ç¼–ç ä¸º uleb128p1 æ—¶éœ€è¦å°† uleb128 åŠ  1ï¼Œè€Œå°†ä¸€ä¸ªå·²ç»ç¼–ç å¥½çš„ uleb128p1 è§£ç ä¸ºæ­£å¸¸æ•°å­—æ—¶éœ€è¦å°† uleb128 å‡ 1ã€‚</p>
<h2 id="LEB128ï¼Ÿ"><a href="#LEB128ï¼Ÿ" class="headerlink" title="LEB128ï¼Ÿ"></a>LEB128ï¼Ÿ</h2><p>LEB128ï¼Œå…¨ç¨‹ <strong>L</strong>ittle-<strong>E</strong>ndian <strong>B</strong>ase <strong>128</strong>ï¼Œå€Ÿé‰´è‡ª <a href="http://dwarfstd.org/Dwarf3Std.php" target="_blank" rel="external">DWARF3</a> (ä¸€ç§è°ƒè¯•æ–‡ä»¶æ ¼å¼ï¼Œå¹¿æ³›ç”¨äº Unixã€Linuxç­‰æ“ä½œç³»ç»Ÿï¼Œå¯æ‰©å±•æ€§å¼º) ã€‚åœ¨ .dex æ–‡ä»¶ä¸­ï¼ŒLEB128 ä»…å¯¹ 32 ä½æ•°æ®ç¼–ç ã€‚</p>
<p>æ¯ä¸ª LEB128 ç¼–ç çš„å€¼ç”± 1-5 ä¸ªå­—èŠ‚ç»„æˆï¼Œåˆåœ¨ä¸€èµ·è¡¨ç¤ºä¸€ä¸ª 32 ä½çš„å€¼ã€‚æ¯ä¸ªå­—èŠ‚çš„æœ‰æ•ˆä½åªæœ‰7ä½ï¼Œæœ€é«˜ä½ä½œä¸ºæ ‡è®°ï¼šæœ€åä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä½è®¾ä¸º0ï¼Œå…¶ä½™è®¾ä¸º1 ã€‚å¦‚æœç¬¬ 5 ä¸ªå­—èŠ‚çš„æœ€é«˜ä½ä¸º 1ï¼Œè¯´æ˜è¿™ä¸ª dex æ–‡ä»¶æ˜¯æ— æ•ˆçš„ã€‚</p>
<p>sleb128 å¯¹æœ€åä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä½è¿›è¡Œäº†ç¬¦å·æ‰©å±•(é«˜ä½å…¨è¡¥1ï¼Œuleb128æ˜¯é«˜ä½å…¨è¡¥0)ï¼Œå³ä½œä¸ºç¬¦å·ä½ã€‚</p>
<p>uleb128p1 + 1 å°±æ˜¯ uleb128 çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ— ç¬¦å· LEB128 ç±»å‹ä¸­ï¼Œåªæœ‰éè´Ÿæ•°å’Œä¸€ä¸ªè´Ÿæ•°(-1 or 0xffffffff)ã€‚</p>
<p>ä¸‹é¢æ˜¯ 2 ä¸ªå­—èŠ‚çš„ LEB128 å€¼ - å›¾ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>First byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>bit6</td>
<td>bit5</td>
<td>bit4</td>
<td>bit3</td>
<td>bit2</td>
<td>bit1</td>
<td>bit0</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Second byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bit13</td>
<td>bit12</td>
<td>bit12</td>
<td>bit11</td>
<td>bit10</td>
<td>bit9</td>
<td>bit8</td>
<td>bit7</td>
</tr>
</tbody>
</table>
<p><strong>å®˜æ–¹æ —å­ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Encoded Sequence</th>
<th>As sleb128</th>
<th>As uleb128</th>
<th>As uleb128p1</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
<tr>
<td>01</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>7f</td>
<td>-1</td>
<td>127</td>
<td>126</td>
</tr>
<tr>
<td>807f</td>
<td>-128</td>
<td>16256</td>
<td>16255</td>
</tr>
</tbody>
</table>
<p><strong>è§£æï¼š</strong></p>
<table>
<thead>
<tr>
<th>7f</th>
</tr>
</thead>
<tbody>
<tr>
<td>äºŒè¿›åˆ¶</td>
<td>0111,1111</td>
</tr>
<tr>
<td>æœ‰æ•ˆå€¼</td>
<td>111,1111</td>
</tr>
<tr>
<td>sleb128</td>
<td>1111,1111 = - 0000,0000,0000,0001  = -1</td>
</tr>
<tr>
<td>uleb128</td>
<td>0111,1111 = 127</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>127-1=126</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>80 7f</th>
</tr>
</thead>
<tbody>
<tr>
<td>äºŒè¿›åˆ¶</td>
<td>1000,0000,0111,1111</td>
</tr>
<tr>
<td>æœ‰æ•ˆå€¼</td>
<td>111,1111,000,0000</td>
</tr>
<tr>
<td>sleb128</td>
<td>1111,1111,1000,0000 = - 0000,0000,1000,0000  = -128</td>
</tr>
<tr>
<td>uleb128</td>
<td>0011,1111,1000,0000 = 16256</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>16256-1=16255</td>
</tr>
</tbody>
</table>
<h2 id="ç›¸å…³æºç "><a href="#ç›¸å…³æºç " class="headerlink" title="ç›¸å…³æºç "></a>ç›¸å…³æºç </h2><p>ä½äº <code>/dalvik/libdex/Leb128.h</code> æ–‡ä»¶ä¸­ã€‚</p>
<h3 id="è¯»å–æ— ç¬¦å·-LEB128-çš„æºç "><a href="#è¯»å–æ— ç¬¦å·-LEB128-çš„æºç " class="headerlink" title="è¯»å–æ— ç¬¦å· LEB128 çš„æºç "></a>è¯»å–æ— ç¬¦å· LEB128 çš„æºç </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Reads an unsigned LEB128 value, updating the given pointer to point</div><div class="line"> * just past the end of the read value. This function tolerates</div><div class="line"> * non-zero high-order bits in the fifth encoded byte.</div><div class="line"> */</div><div class="line">DEX_INLINE int readUnsignedLeb128(const u1** pStream) &#123;</div><div class="line">    const u1* ptr = *pStream;</div><div class="line">    int result = *(ptr++);      //å–ç¬¬ä¸€ä¸ªå­—èŠ‚</div><div class="line">    if (result &gt; 0x7f) &#123;        //å¦‚æœå¤§äº 0x7f è¡¨ç¤ºç¬¬ 1 å­—èŠ‚æœ€é«˜ä½ä¸º 1</div><div class="line">        int cur = *(ptr++);     //å–ç¬¬äºŒä¸ªå­—èŠ‚</div><div class="line">        result = (result &amp; 0x7f) | ((cur &amp; 0x7f) &lt;&lt; 7);     // ä¸¤ä¸ªå­—èŠ‚ç»„åˆï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä¸ºé«˜ä½</div><div class="line">        if (cur &gt; 0x7f) &#123;        //å¦‚æœå¤§äº 0x7f è¡¨ç¤ºç¬¬ 2 å­—èŠ‚æœ€é«˜ä½ä¸º 1</div><div class="line">            cur = *(ptr++);      //å–ç¬¬ä¸‰ä¸ªå­—èŠ‚</div><div class="line">            result |= (cur &amp; 0x7f) &lt;&lt; 14;           //å‰ä¸‰ä¸ªå­—èŠ‚ç»„åˆï¼Œç¬¬ä¸‰ä¸ªå­—èŠ‚ä¸ºé«˜ä½</div><div class="line">            if (cur &gt; 0x7f) &#123;        //å¦‚æœå¤§äº 0x7f è¡¨ç¤ºç¬¬ 3 å­—èŠ‚æœ€é«˜ä½ä¸º 1</div><div class="line">                cur = *(ptr++);      //å–ç¬¬å››ä¸ªå­—èŠ‚</div><div class="line">                result |= (cur &amp; 0x7f) &lt;&lt; 21;       //å‰å››ä¸ªå­—èŠ‚ç»„åˆï¼Œç¬¬å››ä¸ªå­—èŠ‚ä¸ºé«˜ä½</div><div class="line">                if (cur &gt; 0x7f) &#123;       //å¦‚æœå¤§äº 0x7f è¡¨ç¤ºç¬¬ 4 å­—èŠ‚æœ€é«˜ä½ä¸º 1</div><div class="line">                    /*</div><div class="line">                     * è¿™é‡Œä¸æ£€æŸ¥ ptr æŒ‡é’ˆæ˜¯å¦è¶Šç•Œ</div><div class="line">                     * ä¹Ÿä¸æ£€æŸ¥ç¬¬äº”ä¸ªå­—èŠ‚çš„æœ€é«˜ä½æ˜¯å¦ä¸º0</div><div class="line">                     */</div><div class="line">                    cur = *(ptr++);                //å–ç¬¬äº”ä¸ªå­—èŠ‚</div><div class="line">                    result |= cur &lt;&lt; 28;           //å‰äº”ä¸ªå­—èŠ‚ç»„åˆï¼Œç¬¬äº”ä¸ªå­—èŠ‚ä¸ºé«˜ä½</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    *pStream = ptr;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è¯»å–æœ‰ç¬¦å·-LEB128-çš„æºç "><a href="#è¯»å–æœ‰ç¬¦å·-LEB128-çš„æºç " class="headerlink" title="è¯»å–æœ‰ç¬¦å· LEB128 çš„æºç "></a>è¯»å–æœ‰ç¬¦å· LEB128 çš„æºç </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Reads a signed LEB128 value, updating the given pointer to point</div><div class="line"> * just past the end of the read value. This function tolerates</div><div class="line"> * non-zero high-order bits in the fifth encoded byte.</div><div class="line"> */</div><div class="line">DEX_INLINE int readSignedLeb128(const u1** pStream) &#123;</div><div class="line">    const u1* ptr = *pStream;</div><div class="line">    int result = *(ptr++);</div><div class="line">    if (result &lt;= 0x7f) &#123;   //ç¬¬2ä¸ªå­—èŠ‚æœ€é«˜ä½ä¸º0</div><div class="line">        result = (result &lt;&lt; 25) &gt;&gt; 25;  //æœ€é«˜ä½è¿›è¡Œç¬¦å·æ‰©å±•</div><div class="line">    &#125; else &#123;</div><div class="line">        int cur = *(ptr++);</div><div class="line">        result = (result &amp; 0x7f) | ((cur &amp; 0x7f) &lt;&lt; 7); //å‰ä¸¤ä¸ªå­—èŠ‚ç»„åˆ</div><div class="line">        if (cur &lt;= 0x7f) &#123;   //ç¬¬2ä¸ªå­—èŠ‚æœ€é«˜ä½ä¸º0</div><div class="line">            result = (result &lt;&lt; 18) &gt;&gt; 18;   //æœ€é«˜ä½è¿›è¡Œç¬¦å·æ‰©å±•</div><div class="line">        &#125; else &#123;</div><div class="line">            cur = *(ptr++);</div><div class="line">            result |= (cur &amp; 0x7f) &lt;&lt; 14;   //å‰3ä¸ªå­—èŠ‚ç»„åˆ</div><div class="line">            if (cur &lt;= 0x7f) &#123;   //ç¬¬3ä¸ªå­—èŠ‚æœ€é«˜ä½ä¸º0</div><div class="line">                result = (result &lt;&lt; 11) &gt;&gt; 11;   //æœ€é«˜ä½è¿›è¡Œç¬¦å·æ‰©å±•</div><div class="line">            &#125; else &#123;</div><div class="line">                cur = *(ptr++);</div><div class="line">                result |= (cur &amp; 0x7f) &lt;&lt; 21;    //å‰4ä¸ªå­—èŠ‚ç»„åˆ</div><div class="line">                if (cur &lt;= 0x7f) &#123;     //ç¬¬4ä¸ªå­—èŠ‚æœ€é«˜ä½ä¸º0</div><div class="line">                    result = (result &lt;&lt; 4) &gt;&gt; 4;   //æœ€é«˜ä½è¿›è¡Œç¬¦å·æ‰©å±•</div><div class="line">                &#125; else &#123;</div><div class="line">                    cur = *(ptr++);</div><div class="line">                    result |= cur &lt;&lt; 28;    //å‰5ä¸ªå­—èŠ‚ç»„åˆ</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    *pStream = ptr;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - map_list]]></title>
      <url>/2015/11/18/parse-dex-file-part-map-list/</url>
      <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-map-list.png" alt="map-list"></p>
<a id="more"></a>
<h2 id="ä»€ä¹ˆæ˜¯-map-listï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-map-listï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ map_listï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ map_listï¼Ÿ</h2><p>æ•´ä¸ª dex æ–‡ä»¶çš„å†…å®¹æ¸…å•ï¼Œä½äºæ•°æ®æ®µå†…ï¼Œå…¶æ–‡ä»¶åç§»ç”± DexHeader ä¸­çš„ mapOff å­—æ®µæŒ‡å®šã€‚</p>
<p>æ›´åŠ å…·ä½“çš„è§£é‡Šåœ¨ä¸‹é¢çš„ type æ®µè½éƒ¨åˆ†ã€‚</p>
<hr>
<h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>æ¥åˆ° mapOff æŒ‡å®šçš„åç§»å¤„ï¼Œé¦–å…ˆæ˜¯ DexMapList ç»“æ„ï¼Œå­˜å‚¨äº† map_list å†… map_item (DexMapItem) çš„ä¸ªæ•°å’Œå†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ size ä¹‹åï¼Œæœ‰ size ä¸ªDexMapItem ç±»å‹çš„æ•°æ®ã€‚</p>
<h3 id="DexMapList"><a href="#DexMapList" class="headerlink" title="DexMapList"></a>DexMapList</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;map_list&quot;.</div><div class="line"> */</div><div class="line">struct DexMapList &#123;</div><div class="line">    u4  size;               /* DexMapItem çš„ä¸ªæ•° */</div><div class="line">    DexMapItem list[1];     /* DexMapItem æ•°ç»„ */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="DexMapItem"><a href="#DexMapItem" class="headerlink" title="DexMapItem"></a>DexMapItem</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Direct-mapped &quot;map_item&quot;.</div><div class="line"> */</div><div class="line">struct DexMapItem &#123;</div><div class="line">    u2 type;              /* å„ item çš„ç±»å‹ï¼Œå‡ä»¥ kDexType å¼€å¤´*/</div><div class="line">    u2 unused;            /* æœªä½¿ç”¨ï¼Œç”¨äºå­—èŠ‚å¯¹é½ */</div><div class="line">    u4 size;              /* æŒ‡å®šç±»å‹çš„ä¸ªæ•° */</div><div class="line">    u4 offset;            /* æŒ‡å®šç±»å‹æ•°æ®çš„èµ·å§‹æ–‡ä»¶åç§» */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>åœ¨è¿™äº›ç±»å‹ä¸­ï¼Œé™¤äº† 0x0000 è¡¨ç¤ºçš„å°±æ˜¯ DexHeader æœ¬èº«ä¹‹å¤–ï¼Œ0x0001 ~ 0x1000 éƒ¨åˆ†ä¸ DexHeader ä¸­å®šä¹‰çš„ç±»å‹æ˜¯ä¸€è‡´çš„ï¼›<br>è€Œ 0x1001 ~ 0x2006 éƒ¨åˆ†æ˜¯å¯¹ data æ®µçš„ç»†åˆ†ã€‚<br>è¿™æ ·è®¾è®¡å¯ä»¥ä½œä¸ºä¸€ç§æ–‡ä»¶æ£€éªŒæ–¹å¼ï¼Œä¸€æ—¦å’Œ DexHeader çš„æ•°æ®æœ‰æ‰€ä¸åŒå°±å¯ä»¥åˆ¤å®šè¯¥ dex æ˜¯æŸåçš„ï¼›è€Œä¸” map_list éƒ¨åˆ†çš„å†…å®¹æ›´è¯¦ç»†ï¼Œä»¥æ­¤ä½œä¸ºæ•´ä¸ªæ–‡ä»¶çš„ç´¢å¼•æƒ³å¿…æ˜¯æå¥½çš„ã€‚<br>ä¸‹é¢æ‰‹åŠ¨æŸ¥æ‰¾çš„ä¾‹å­å¯ä»¥è¯æ˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/* map item type codes */</div><div class="line">enum &#123;</div><div class="line">    kDexTypeHeaderItem               = 0x0000,</div><div class="line">    kDexTypeStringIdItem             = 0x0001,</div><div class="line">    kDexTypeTypeIdItem               = 0x0002,</div><div class="line">    kDexTypeProtoIdItem              = 0x0003,</div><div class="line">    kDexTypeFieldIdItem              = 0x0004,</div><div class="line">    kDexTypeMethodIdItem             = 0x0005,</div><div class="line">    kDexTypeClassDefItem             = 0x0006,</div><div class="line">    kDexTypeMapList                  = 0x1000,</div><div class="line">    kDexTypeTypeList                 = 0x1001,</div><div class="line">    kDexTypeAnnotationSetRefList     = 0x1002,</div><div class="line">    kDexTypeAnnotationSetItem        = 0x1003,</div><div class="line">    kDexTypeClassDataItem            = 0x2000,</div><div class="line">    kDexTypeCodeItem                 = 0x2001,</div><div class="line">    kDexTypeStringDataItem           = 0x2002,</div><div class="line">    kDexTypeDebugInfoItem            = 0x2003,</div><div class="line">    kDexTypeAnnotationItem           = 0x2004,</div><div class="line">    kDexTypeEncodedArrayItem         = 0x2005,</div><div class="line">    kDexTypeAnnotationsDirectoryItem = 0x2006,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h2 id="æ‰‹å·¥æŸ¥æ‰¾"><a href="#æ‰‹å·¥æŸ¥æ‰¾" class="headerlink" title="æ‰‹å·¥æŸ¥æ‰¾"></a>æ‰‹å·¥æŸ¥æ‰¾</h2><p><strong>æŸ dex æ–‡ä»¶çš„ map_list éƒ¨åˆ†</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">00001000  10 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|</div><div class="line">00001010  01 00 00 00 5c 00 00 00  70 00 00 00 02 00 00 00  |....\...p.......|</div><div class="line">00001020  19 00 00 00 e0 01 00 00  03 00 00 00 12 00 00 00  |................|</div><div class="line">00001030  44 02 00 00 04 00 00 00  01 00 00 00 1c 03 00 00  |D...............|</div><div class="line">00001040  05 00 00 00 2b 00 00 00  24 03 00 00 06 00 00 00  |....+...$.......|</div><div class="line">00001050  02 00 00 00 7c 04 00 00  02 20 00 00 5c 00 00 00  |....|.... ..\...|</div><div class="line">00001060  bc 04 00 00 01 10 00 00  0a 00 00 00 f8 09 00 00  |................|</div><div class="line">00001070  04 20 00 00 01 00 00 00  4e 0a 00 00 03 10 00 00  |. ......N.......|</div><div class="line">00001080  02 00 00 00 58 0a 00 00  06 20 00 00 01 00 00 00  |....X.... ......|</div><div class="line">00001090  64 0a 00 00 03 20 00 00  09 00 00 00 7c 0a 00 00  |d.... ......|...|</div><div class="line">000010a0  01 20 00 00 09 00 00 00  10 0c 00 00 00 20 00 00  |. ........... ..|</div><div class="line">000010b0  02 00 00 00 c2 0f 00 00  00 10 00 00 01 00 00 00  |................|</div><div class="line">000010c0  00 10 00 00                                       |....|</div></pre></td></tr></table></figure>
<p>å‰ 4 å­—èŠ‚è¡¨æ˜æ¥ä¸‹æ¥ä¼šæœ‰ <code>0x00000010</code> ä¸ª DexMapItem ç»“æ„ï¼›</p>
<table>
<thead>
<tr>
<th>åºæ•°</th>
<th>binary</th>
<th>type</th>
<th>size</th>
<th>offset</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x01</td>
<td>00 00 00 00  01 00 00 00  00 00 00 00</td>
<td>kDexTypeHeaderItem</td>
<td>0x01</td>
<td>0x0</td>
</tr>
<tr>
<td>0x02</td>
<td>01 00 00 00  5c 00 00 00  70 00 00 00</td>
<td>kDexTypeStringIdItem</td>
<td>0x5c</td>
<td>0x70</td>
</tr>
<tr>
<td>0x03</td>
<td>02 00 00 00  19 00 00 00  e0 01 00 00</td>
<td>kDexTypeTypeIdItem</td>
<td>0x19</td>
<td>0x1e0</td>
</tr>
<tr>
<td>0x04</td>
<td>03 00 00 00  12 00 00 00  44 02 00 00</td>
<td>kDexTypeProtoIdItem</td>
<td>0x12</td>
<td>0x244</td>
</tr>
<tr>
<td>0x05</td>
<td>04 00 00 00  01 00 00 00  1c 03 00 00</td>
<td>kDexTypeFieldIdItem</td>
<td>0x01</td>
<td>0x3c1</td>
</tr>
<tr>
<td>0x06</td>
<td>05 00 00 00  2b 00 00 00  24 03 00 00</td>
<td>kDexTypeMethodIdItem</td>
<td>0x2b</td>
<td>0x324</td>
</tr>
<tr>
<td>0x07</td>
<td>06 00 00 00  02 00 00 00  7c 04 00 00</td>
<td>kDexTypeClassDefItem</td>
<td>0x02</td>
<td>0x47c</td>
</tr>
<tr>
<td>0x08</td>
<td>02 20 00 00  5c 00 00 00  bc 04 00 00</td>
<td>kDexTypeStringDataItem</td>
<td>0x5c</td>
<td>0x4bc</td>
</tr>
<tr>
<td>0x09</td>
<td>01 10 00 00  0a 00 00 00  f8 09 00 00</td>
<td>kDexTypeTypeList</td>
<td>0x0a</td>
<td>0x9f8</td>
</tr>
<tr>
<td>0x0a</td>
<td>04 20 00 00  01 00 00 00  4e 0a 00 00</td>
<td>kDexTypeAnnotationItem</td>
<td>0x01</td>
<td>0xa4e</td>
</tr>
<tr>
<td>0x0b</td>
<td>03 10 00 00  02 00 00 00  58 0a 00 00</td>
<td>kDexTypeAnnotationSetItem</td>
<td>0x02</td>
<td>0xa58</td>
</tr>
<tr>
<td>0x0c</td>
<td>06 20 00 00  01 00 00 00  64 0a 00 00</td>
<td>kDexTypeAnnotationsDirectoryItem</td>
<td>0x01</td>
<td>0xa64</td>
</tr>
<tr>
<td>0x0d</td>
<td>03 20 00 00  09 00 00 00  7c 0a 00 00</td>
<td>kDexTypeDebugInfoItem</td>
<td>0x09</td>
<td>0xa7c</td>
</tr>
<tr>
<td>0x0e</td>
<td>01 20 00 00  09 00 00 00  10 0c 00 00</td>
<td>kDexTypeCodeItem</td>
<td>0x09</td>
<td>0xc10</td>
</tr>
<tr>
<td>0x0f</td>
<td>00 20 00 00  02 00 00 00  c2 0f 00 00</td>
<td>kDexTypeClassDataItem</td>
<td>0x02</td>
<td>0xfc2</td>
</tr>
<tr>
<td>0x10</td>
<td>00 10 00 00  01 00 00 00  00 10 00 00</td>
<td>kDexTypeMapList</td>
<td>0x01</td>
<td>0x1000</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œçš„å„é¡¹å€¼å¯ä»¥å’Œä¸Šä¸€èŠ‚ <a href="http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/" target="_blank" rel="external">è§£æ dex æ–‡ä»¶ç»“æ„ - DexHeader</a> æ‰‹åŠ¨æŸ¥æ‰¾éƒ¨åˆ†ä¸­çš„æ•°æ®è¿›è¡Œæ¯”å¯¹ï¼Œå‘ç°æ˜¯ç›¸åŒçš„ã€‚</p>
<hr>
<h2 id="å†™ç¨‹åºè§£æ-map-list"><a href="#å†™ç¨‹åºè§£æ-map-list" class="headerlink" title="å†™ç¨‹åºè§£æ map_list"></a>å†™ç¨‹åºè§£æ map_list</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">class DexStruct(object):</div><div class="line">    DexMapList = &#123;</div><div class="line">        &quot;size&quot;: 0,</div><div class="line">        &quot;DexMapItem&quot;: []</div><div class="line">    &#125;</div><div class="line">    # DexMapItem = &#123;</div><div class="line">    #     &quot;type&quot; : 0</div><div class="line">    #     &quot;unused&quot; : 0</div><div class="line">    #     &quot;size&quot;  : 0</div><div class="line">    #     &quot;offset&quot; : 0</div><div class="line">    # &#125;</div><div class="line">    DexMapItemCode = &#123;</div><div class="line">        0x0000 : &quot;kDexTypeHeaderItem&quot;               ,</div><div class="line">        0x0001 : &quot;kDexTypeStringIdItem&quot;             ,</div><div class="line">        0x0002 : &quot;kDexTypeTypeIdItem&quot;               ,</div><div class="line">        0x0003 : &quot;kDexTypeProtoIdItem&quot;              ,</div><div class="line">        0x0004 : &quot;kDexTypeFieldIdItem&quot;              ,</div><div class="line">        0x0005 : &quot;kDexTypeMethodIdItem&quot;             ,</div><div class="line">        0x0006 : &quot;kDexTypeClassDefItem&quot;             ,</div><div class="line">        0x1000 : &quot;kDexTypeMapList&quot;                  ,</div><div class="line">        0x1001 : &quot;kDexTypeTypeList&quot;                 ,</div><div class="line">        0x1002 : &quot;kDexTypeAnnotationSetRefList&quot;     ,</div><div class="line">        0x1003 : &quot;kDexTypeAnnotationSetItem&quot;        ,</div><div class="line">        0x2000 : &quot;kDexTypeClassDataItem&quot;            ,</div><div class="line">        0x2001 : &quot;kDexTypeCodeItem&quot;                 ,</div><div class="line">        0x2002 : &quot;kDexTypeStringDataItem&quot;           ,</div><div class="line">        0x2003 : &quot;kDexTypeDebugInfoItem&quot;            ,</div><div class="line">        0x2004 : &quot;kDexTypeAnnotationItem&quot;           ,</div><div class="line">        0x2005 : &quot;kDexTypeEncodedArrayItem&quot;         ,</div><div class="line">        0x2006 : &quot;kDexTypeAnnotationsDirectoryItem&quot; ,</div><div class="line">    &#125;</div><div class="line">def parseMapList(map_data):</div><div class="line">    DexStruct.DexMapList[&apos;size&apos;] = struct.unpack(&apos;H&apos;,map_data[:2])[0]</div><div class="line">    curPos = 4</div><div class="line">    for x in range(DexStruct.DexMapList[&apos;size&apos;]):</div><div class="line">        tmpDexMapItem = &#123;</div><div class="line">            &quot;type&quot; : struct.unpack(&apos;H&apos;,map_data[curPos:curPos+2])[0],</div><div class="line">            &quot;unused&quot; : 0,</div><div class="line">            &quot;size&quot;  : struct.unpack(&apos;I&apos;,map_data[curPos+4:curPos+8])[0],</div><div class="line">            &quot;offset&quot; : struct.unpack(&apos;I&apos;,map_data[curPos+8:curPos+12])[0] &#125;</div><div class="line">        curPos += 12</div><div class="line">        DexStruct.DexMapList[&quot;DexMapItem&quot;].append(tmpDexMapItem)</div></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è§£æ dex æ–‡ä»¶ç»“æ„ - DexHeader]]></title>
      <url>/2015/11/17/parse-dex-file-part-dex-header/</url>
      <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-header.png" alt="header"></p>
<h2 id="dex-ç®€ä»‹"><a href="#dex-ç®€ä»‹" class="headerlink" title="dex ç®€ä»‹"></a>dex ç®€ä»‹</h2><p>dex æ–‡ä»¶æ˜¯ dalvik è™šæ‹Ÿæœºçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<a id="more"></a>
<hr>
<h2 id="dex-æ–‡ä»¶ç»“æ„"><a href="#dex-æ–‡ä»¶ç»“æ„" class="headerlink" title="dex æ–‡ä»¶ç»“æ„"></a>dex æ–‡ä»¶ç»“æ„</h2><p>è¯¥ç»“æ„ä½äºç³»ç»Ÿæºç  <code>dalvik\libdex\DexFile.h</code> ä¸­ï¼Œæè¿°çš„æ˜¯ dex æ–‡ä»¶è¢«æ˜ å°„åˆ°å†…å­˜ä¸­çš„ç»“æ„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Structure representing a DEX file.</div><div class="line"> *</div><div class="line"> * Code should regard DexFile as opaque, using the API calls provided here</div><div class="line"> * to access specific structures.</div><div class="line"> */</div><div class="line">struct DexFile &#123;</div><div class="line">    /* directly-mapped &quot;opt&quot; header */</div><div class="line">    const DexOptHeader* pOptHeader;</div><div class="line">    /* pointers to directly-mapped structs and arrays in base DEX */</div><div class="line">    const DexHeader*    pHeader;</div><div class="line">    const DexStringId*  pStringIds;</div><div class="line">    const DexTypeId*    pTypeIds;</div><div class="line">    const DexFieldId*   pFieldIds;</div><div class="line">    const DexMethodId*  pMethodIds;</div><div class="line">    const DexProtoId*   pProtoIds;</div><div class="line">    const DexClassDef*  pClassDefs;</div><div class="line">    const DexLink*      pLinkData;</div><div class="line">    /*</div><div class="line">     * These are mapped out of the &quot;auxillary&quot; section, and may not be</div><div class="line">     * included in the file.</div><div class="line">     */</div><div class="line">    const DexClassLookup* pClassLookup;</div><div class="line">    const void*         pRegisterMapPool;       // RegisterMapClassPool</div><div class="line">    /* points to start of DEX file data */</div><div class="line">    const u1*           baseAddr;</div><div class="line">    /* track memory overhead for auxillary structures */</div><div class="line">    int                 overhead;</div><div class="line">    /* additional app-specific data structures associated with the DEX */</div><div class="line">    //void*               auxData;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>åŸºæœ¬çš„æ–‡ä»¶ç»“æ„åªéœ€å…³æ³¨:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct DexFile&#123;</div><div class="line">    DexHeader    Header;</div><div class="line">    DexStringId  StringIds[stringIdsSize];</div><div class="line">    DexTypeId    TypeIds[typeIdsSize];</div><div class="line">    DexFieldId   FieldIds[fieldIdsSize];</div><div class="line">    DexMethodId  MethodIds[methodIdsSize];</div><div class="line">    DexProtoId   ProtoIds[protoIdsSize];</div><div class="line">    DexClassDef  ClassDefs[classDefsSize];</div><div class="line">    DexData      Data[];</div><div class="line">    DexLink      LinkData;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="å¤§ä½“ç»“æ„å›¾"><a href="#å¤§ä½“ç»“æ„å›¾" class="headerlink" title="å¤§ä½“ç»“æ„å›¾"></a>å¤§ä½“ç»“æ„å›¾</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure.png" alt="dex-file-general-structure"></p>
<p>å¤§è‡´å¯ä»¥å°† dex æ–‡ä»¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šDexHeader ã€Table æ˜¯ç´¢å¼•ç»“æ„åŒº ã€data éƒ¨åˆ†æ˜¯æ•°æ®åŒºã€‚<br>ç¨‹åºä½¿ç”¨åˆ°çš„æ•°æ®éƒ½åœ¨ data section å†…ï¼Œ Tables æ˜¯æŒ‡å‘ data section ä¸­å…·ä½“æ•°æ®ç»“æ„çš„ç´¢å¼•ã€‚</p>
<hr>
<h2 id="DexHeader-ç»“æ„"><a href="#DexHeader-ç»“æ„" class="headerlink" title="DexHeader ç»“æ„"></a>DexHeader ç»“æ„</h2><p>å¤´éƒ¨è®°å½•äº†æ•´ä¸ªæ–‡ä»¶çš„ç´¢å¼•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * 160-bit SHA-1 digest.</div><div class="line"> */</div><div class="line">enum &#123; kSHA1DigestLen = 20,</div><div class="line">       kSHA1DigestOutputLen = kSHA1DigestLen*2 +1 &#125;;</div><div class="line">/*</div><div class="line"> * Direct-mapped &quot;header_item&quot; struct.</div><div class="line"> */</div><div class="line">struct DexHeader &#123;</div><div class="line">    u1  magic[8];           /* ç‰ˆæœ¬æ ‡è¯† */</div><div class="line">    u4  checksum;           /* adler32 æ£€éªŒ */</div><div class="line">    u1  signature[kSHA1DigestLen]; /* SHA-1 å“ˆå¸Œå€¼ */</div><div class="line">    u4  fileSize;           /* æ•´ä¸ªæ–‡ä»¶å¤§å° */</div><div class="line">    u4  headerSize;         /* DexHeader å¤§å° */</div><div class="line">    u4  endianTag;          /* å­—èŠ‚åºæ ‡è®° */</div><div class="line">    u4  linkSize;           /* é“¾æ¥æ®µå¤§å° */</div><div class="line">    u4  linkOff;            /* é“¾æ¥æ®µåç§» */</div><div class="line">    u4  mapOff;             /* DexMapList çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  stringIdsSize;      /* DexStringId çš„ä¸ªæ•° */</div><div class="line">    u4  stringIdsOff;       /* DexStringId çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  typeIdsSize;        /* DexTypeId çš„ä¸ªæ•° */</div><div class="line">    u4  typeIdsOff;         /* DexTypeId çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  protoIdsSize;       /* DexProtoId çš„ä¸ªæ•° */</div><div class="line">    u4  protoIdsOff;        /* DexProtoId çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  fieldIdsSize;       /* DexFieldId çš„ä¸ªæ•° */</div><div class="line">    u4  fieldIdsOff;        /* DexFieldId çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  methodIdsSize;      /* DexMethodId çš„ä¸ªæ•° */</div><div class="line">    u4  methodIdsOff;       /* DexMethodId çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  classDefsSize;      /* DexClassDef çš„ä¸ªæ•° */</div><div class="line">    u4  classDefsOff;       /* DexClassDef çš„æ–‡ä»¶åç§» */</div><div class="line">    u4  dataSize;           /* æ•°æ®æ®µçš„å¤§å° */</div><div class="line">    u4  dataOff;            /* æ•°æ®æ®µçš„æ–‡ä»¶åç§» */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="å…¶ä¸­ï¼š"><a href="#å…¶ä¸­ï¼š" class="headerlink" title="å…¶ä¸­ï¼š"></a>å…¶ä¸­ï¼š</h3><table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>magic</strong></td>
<td>dexæ–‡ä»¶æ ‡è¯†ï¼Œå€¼å¿…é¡»ä¸ºå¸¸é‡ <code>DEX_FILE_MAGIC</code> = { 0x64 0x65 0x78 0x0a 0x30 0x33 0x35 0x00 } = â€œdex\n035\0â€</td>
</tr>
<tr>
<td><strong>checkSum</strong></td>
<td>å¯¹é™¤ magic å’Œ checkSum å¤–çš„å‰©ä½™æ–‡ä»¶è®¡ç®— adler32 æ ¡éªŒå€¼ï¼Œç›®çš„æ˜¯æ£€æµ‹æ–‡ä»¶æ˜¯å¦æŸå</td>
</tr>
<tr>
<td><strong> signature</strong></td>
<td>å¯¹é™¤ magicã€checkSum å’Œ signature å¤–çš„å‰©ä½™æ–‡ä»¶è®¡ç®— SHA-1 æ ¡éªŒå€¼ï¼Œç”¨æ¥ç¡®å®šæ–‡ä»¶çš„å”¯ä¸€æ€§</td>
</tr>
<tr>
<td><strong> fileSize</strong></td>
<td>ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œæ•´ä¸ªæ–‡ä»¶ï¼ˆåŒ…æ‹¬å¤´éƒ¨ï¼‰çš„å¤§å°</td>
</tr>
<tr>
<td><strong> headerSize</strong></td>
<td>å¤´éƒ¨å¤§å°ï¼Œ0x70 å­—èŠ‚ï¼Œå·²ç»è€ƒè™‘åˆ°å…¼å®¹æ€§</td>
</tr>
<tr>
<td><strong> endianTag</strong></td>
<td>ä¸¤ç§å­—èŠ‚åºå–å€¼: <code>uint ENDIAN_CONSTANT = 0x12345678</code> ; <code>uint REVERSE_ENDIAN_CONSTANT = 0x78563412</code></td>
</tr>
<tr>
<td><strong> linkSize</strong></td>
<td>é“¾æ¥æ®µçš„å¤§å°ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨é™æ€é“¾æ¥ï¼Œå€¼ä¸º0</td>
</tr>
<tr>
<td><strong> linkOff</strong></td>
<td>é“¾æ¥æ®µçš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘é“¾æ¥æ•°æ®æ®µå†…ï¼Œå¦‚æœ <code>linkSize</code> ä¸º 0ï¼Œåˆ™ä¸º 0</td>
</tr>
<tr>
<td><strong> mapOff</strong></td>
<td>map item çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘æ•°æ®æ®µå†…ï¼Œæ•°æ®ç»“æ„ä¸º <code>mapList</code>ï¼Œå¦‚æœæ²¡æœ‰ mapï¼Œå€¼ä¸º 0</td>
</tr>
<tr>
<td><strong> stringIdsSize</strong></td>
<td>å­—ç¬¦ä¸² id çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> stringIdsOff</strong></td>
<td>å­—ç¬¦ä¸² id æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>stringIds</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ stringIdsSize ä¸º 0ï¼Œå€¼ä¸º0</td>
</tr>
<tr>
<td><strong> typeIdsSize</strong></td>
<td>ç±»å‹æ ‡è¯†ç¬¦çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> typeIdsOff</strong></td>
<td>ç±»å‹æ ‡è¯†ç¬¦æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>typeIds</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ typeIdsSize ä¸º 0ï¼Œå€¼ä¸º 0 (<em>è¿™å°±å¾ˆå¥‡æ€ªäº†å“Ÿ</em>)</td>
</tr>
<tr>
<td><strong> protoIdsSize</strong></td>
<td>åŸå‹æ ‡è¯†ç¬¦çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> protoIdsOff</strong></td>
<td>åŸå‹æ ‡è¯†ç¬¦æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>protoIds</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ protoIdsSize ä¸º 0ï¼Œå€¼ä¸º 0 (<em>è¿™å°±å¾ˆå¥‡æ€ªäº†å“Ÿ</em>)</td>
</tr>
<tr>
<td><strong>  fieldIdsSize</strong></td>
<td>å­—æ®µæ ‡è¯†ç¬¦çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> fieldIdsOff</strong></td>
<td>å­—æ®µæ ‡è¯†ç¬¦æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>fieldIds</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ fieldIdsSize ä¸º 0ï¼Œå€¼ä¸º 0</td>
</tr>
<tr>
<td><strong> methodIdsSize</strong></td>
<td>æ–¹æ³•æ ‡è¯†ç¬¦çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> methodIdsOff</strong></td>
<td>æ–¹æ³•æ ‡è¯†ç¬¦æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>methodIds</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ methodIdsSize ä¸º 0ï¼Œå€¼ä¸º 0</td>
</tr>
<tr>
<td><strong> classDefsSize</strong></td>
<td>ç±»çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><strong> classDefsOff</strong></td>
<td>ç±»æ¸…å•çš„æ–‡ä»¶åç§»ï¼ŒæŒ‡å‘ <code>classDefs</code> çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœ classDefsSize ä¸º 0ï¼Œå€¼ä¸º 0 (<em>è¿™å°±å¾ˆå¥‡æ€ªäº†å“Ÿ</em>)</td>
</tr>
<tr>
<td><strong> dataSize</strong></td>
<td>æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå¹¶ä¸”æ˜¯ sizeof(uint) çš„å¶æ•°å€</td>
</tr>
<tr>
<td><strong> dataOff</strong></td>
<td>æ•°æ®æ®µçš„æ–‡ä»¶åç§»</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="æ‰‹å·¥æŸ¥æ‰¾"><a href="#æ‰‹å·¥æŸ¥æ‰¾" class="headerlink" title="æ‰‹å·¥æŸ¥æ‰¾"></a>æ‰‹å·¥æŸ¥æ‰¾</h2><p>æ›´æ–¹ä¾¿çš„æ–¹å¼æ˜¯ä½¿ç”¨ <a href="http://www.sweetscape.com/download/010editor/" target="_blank" rel="external">010 Editor</a>ï¼Œä¸‹è½½å…¶å®˜ç½‘ä¸Šå¯è§£æ dex æ–‡ä»¶çš„<a href="http://www.sweetscape.com/010editor/templates/" target="_blank" rel="external">è„šæœ¬æ–‡ä»¶</a>ï¼Œå¯é«˜äº®ç›¸åº”çš„äºŒè¿›åˆ¶ã€‚</p>
<p>linux ä¸‹å¯ä»¥ä½¿ç”¨ <code>hexdump</code> æŸ¥çœ‹æŸæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ® -&gt; <code>hexdump -C classes.dex</code></p>
<p><a href="http://archive.oreilly.com/linux/cmd/cmd.csp?path=h/hexdump" target="_blank" rel="external">å¸¸ç”¨é€‰é¡¹</a></p>
<table>
<thead>
<tr>
<th>option</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>-b</td>
<td>å°†æ¯ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸º8è¿›åˆ¶</td>
</tr>
<tr>
<td>-c</td>
<td>å°†æ¯ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸ºASCIIå­—ç¬¦</td>
</tr>
<tr>
<td>-C</td>
<td>æ¯ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸º16è¿›åˆ¶å’Œç›¸åº”çš„ASCIIå­—ç¬¦</td>
</tr>
<tr>
<td>-d</td>
<td>æ¯ä¸¤ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸º10è¿›åˆ¶</td>
</tr>
<tr>
<td>-o</td>
<td>æ¯ä¸¤ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸º8è¿›åˆ¶</td>
</tr>
<tr>
<td>-x</td>
<td>æ¯ä¸¤ä¸ªå­—èŠ‚æ˜¾ç¤ºä¸º16è¿›åˆ¶</td>
</tr>
</tbody>
</table>
<p><strong>æŸ dex æ–‡ä»¶çš„å¤´éƒ¨ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">00000000  64 65 78 0a 30 33 35 00  3b ba fe c3 83 7e aa be  |dex.035.;....~..|</div><div class="line">00000010  09 97 71 1e 17 96 9f e9  0c bd 01 60 b4 2a 1a c9  |..q........`.*..|</div><div class="line">00000020  c4 10 00 00 70 00 00 00  78 56 34 12 00 00 00 00  |....p...xV4.....|</div><div class="line">00000030  00 00 00 00 00 10 00 00  5c 00 00 00 70 00 00 00  |........\...p...|</div><div class="line">00000040  19 00 00 00 e0 01 00 00  12 00 00 00 44 02 00 00  |............D...|</div><div class="line">00000050  01 00 00 00 1c 03 00 00  2b 00 00 00 24 03 00 00  |........+...$...|</div><div class="line">00000060  02 00 00 00 7c 04 00 00  08 0c 00 00 bc 04 00 00  |....|...........|</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>binary</th>
<th>field</th>
</tr>
</thead>
<tbody>
<tr>
<td>64 65 78 0a 30 33 35 00</td>
<td>magic</td>
</tr>
<tr>
<td>3b ba fe c3</td>
<td>checksum</td>
</tr>
<tr>
<td>83 7e aa be 09 97 71 1e 17 96 9f e9 0c bd 01 60 b4 2a 1a c9</td>
<td>signature</td>
</tr>
<tr>
<td>c4 10 00 00</td>
<td>fileSize</td>
</tr>
<tr>
<td>70 00 00 00</td>
<td>headerSize</td>
</tr>
<tr>
<td>78 56 34 12</td>
<td>endianTag</td>
</tr>
<tr>
<td>00 00 00 00</td>
<td>linkSize</td>
</tr>
<tr>
<td>00 00 00 00</td>
<td>linkOff</td>
</tr>
<tr>
<td>00 10 00 00</td>
<td>mapOff</td>
</tr>
<tr>
<td>5c 00 00 00</td>
<td>stringIdsSize</td>
</tr>
<tr>
<td>70 00 00 00</td>
<td>stringIdsOff</td>
</tr>
<tr>
<td>19 00 00 00</td>
<td>typeIdsSize</td>
</tr>
<tr>
<td>e0 01 00 00</td>
<td>typeIdsOff</td>
</tr>
<tr>
<td>12 00 00 00</td>
<td>protoIdsSize</td>
</tr>
<tr>
<td>44 02 00 00</td>
<td>protoIdsOff</td>
</tr>
<tr>
<td>01 00 00 00</td>
<td>fieldIdsSize</td>
</tr>
<tr>
<td>1c 03 00 00</td>
<td>fieldIdsOff</td>
</tr>
<tr>
<td>2b 00 00 00</td>
<td>methodIdsSize</td>
</tr>
<tr>
<td>24 03 00 00</td>
<td>methodIdsOff</td>
</tr>
<tr>
<td>02 00 00 00</td>
<td>classDefsSize</td>
</tr>
<tr>
<td>7c 04 00 00</td>
<td>classDefsOff</td>
</tr>
<tr>
<td>08 0c 00 00</td>
<td>dataSize</td>
</tr>
<tr>
<td>bc 04 00 00</td>
<td>dataOff</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å†™ç¨‹åºè§£æ-DexHeader"><a href="#å†™ç¨‹åºè§£æ-DexHeader" class="headerlink" title="å†™ç¨‹åºè§£æ DexHeader"></a>å†™ç¨‹åºè§£æ DexHeader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">class DexStruct(object):</div><div class="line">    DexHeader = &#123;</div><div class="line">          &quot;magic&quot;: 0,</div><div class="line">          &quot;checkSum&quot;: 0,</div><div class="line">          &apos;signature&apos;: 0,</div><div class="line">          &apos;fileSize&apos;: 0,</div><div class="line">          &quot;headerSize&quot;: 0,</div><div class="line">          &quot;endianTag&quot;: 0,</div><div class="line">          &quot;linkSize&quot;: 0,</div><div class="line">          &quot;linkOff&quot;: 0,</div><div class="line">          &quot;mapOff&quot;: 0,</div><div class="line">          &quot;stringIdsSize&quot;: 0,</div><div class="line">          &quot;stringIdsOff&quot;: 0,</div><div class="line">          &quot;typeIdsSize&quot;: 0,</div><div class="line">          &quot;typeIdsOff&quot;: 0,</div><div class="line">          &quot;protoIdsSize&quot;: 0,</div><div class="line">          &quot;protoIdsOff&quot;: 0,</div><div class="line">          &quot;fieldIdsSize&quot;: 0,</div><div class="line">          &quot;fieldIdsOff&quot;: 0,</div><div class="line">          &quot;methodIdsSize&quot;: 0,</div><div class="line">          &quot;methodIdsOff&quot;: 0,</div><div class="line">          &quot;classDefsSize&quot;: 0,</div><div class="line">          &quot;classDefsOff&quot;: 0,</div><div class="line">          &quot;dataSize&quot;: 0,</div><div class="line">          &quot;dataOff&quot;: 0,   &#125;</div><div class="line">def parseHeader(header_data):</div><div class="line">        header_list = [header_data[i:i+4] for i in range(32,112,4)]</div><div class="line">        header_list.insert(0,header_data[12:32])</div><div class="line">        header_list.insert(0,header_data[8:12])</div><div class="line">        header_list.insert(0,header_data[:8])</div><div class="line">        DexStruct.DexHeader[&apos;magic&apos;] = struct.unpack(&apos;8s&apos;,header_list[0])[0]</div><div class="line">        if DexStruct.DexHeader[&apos;magic&apos;] != &quot;dex\n035\0&quot;:</div><div class="line">            print &apos;invalid dex file.&apos;</div><div class="line">            exit(-1)</div><div class="line">        DexStruct.DexHeader[&apos;checkSum&apos;] = struct.unpack(&apos;I&apos;,header_list[1])[0]</div><div class="line">        DexStruct.DexHeader[&apos;signature&apos;] = struct.unpack(&apos;20s&apos;,header_list[2])[0]</div><div class="line">        DexStruct.DexHeader[&apos;fileSize&apos;] = struct.unpack(&apos;I&apos;,header_list[3])[0]</div><div class="line">        DexStruct.DexHeader[&apos;headerSize&apos;] = struct.unpack(&apos;I&apos;,header_list[4])[0]</div><div class="line">        DexStruct.DexHeader[&apos;endianTag&apos;] = struct.unpack(&apos;I&apos;,header_list[5])[0]</div><div class="line">        DexStruct.DexHeader[&apos;linkSize&apos;] = struct.unpack(&apos;I&apos;,header_list[6])[0]</div><div class="line">        DexStruct.DexHeader[&apos;linkOff&apos;] = struct.unpack(&apos;I&apos;,header_list[7])[0]</div><div class="line">        DexStruct.DexHeader[&apos;mapOff&apos;] = struct.unpack(&apos;I&apos;,header_list[8])[0]</div><div class="line">        DexStruct.DexHeader[&apos;stringIdsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[9])[0]</div><div class="line">        DexStruct.DexHeader[&apos;stringIdsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[10])[0]</div><div class="line">        DexStruct.DexHeader[&apos;typeIdsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[11])[0]</div><div class="line">        DexStruct.DexHeader[&apos;typeIdsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[12])[0]</div><div class="line">        DexStruct.DexHeader[&apos;protoIdsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[13])[0]</div><div class="line">        DexStruct.DexHeader[&apos;protoIdsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[14])[0]</div><div class="line">        DexStruct.DexHeader[&apos;fieldIdsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[15])[0]</div><div class="line">        DexStruct.DexHeader[&apos;fieldIdsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[16])[0]</div><div class="line">        DexStruct.DexHeader[&apos;methodIdsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[17])[0]</div><div class="line">        DexStruct.DexHeader[&apos;methodIdsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[18])[0]</div><div class="line">        DexStruct.DexHeader[&apos;classDefsSize&apos;] = struct.unpack(&apos;I&apos;,header_list[19])[0]</div><div class="line">        DexStruct.DexHeader[&apos;classDefsOff&apos;] = struct.unpack(&apos;I&apos;,header_list[20])[0]</div><div class="line">        DexStruct.DexHeader[&apos;dataSize&apos;] = struct.unpack(&apos;I&apos;,header_list[21])[0]</div><div class="line">        DexStruct.DexHeader[&apos;dataOff&apos;] = struct.unpack(&apos;I&apos;,header_list[22])[0]</div></pre></td></tr></table></figure>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</a></p>
<p><a href="http://www.blogfshare.com/dex-format.html" target="_blank" rel="external">Androidå®‰å…¨â€“Dexæ–‡ä»¶æ ¼å¼è¯¦è§£</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> dex </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å¦‚ä½•è¿è¡Œ .smali ç¨‹åº]]></title>
      <url>/2015/11/16/how-to-run-file-ended-with-smali/</url>
      <content type="html"><![CDATA[<h2 id="å‡†å¤‡-smali-ç¨‹åº"><a href="#å‡†å¤‡-smali-ç¨‹åº" class="headerlink" title="å‡†å¤‡ smali ç¨‹åº"></a>å‡†å¤‡ smali ç¨‹åº</h2><a id="more"></a>
<p>ä» ã€ŠAndroid è½¯ä»¶å®‰å…¨ä¸é€†å‘ã€‹ä¹¦ä¸­æŠ å‡ºä¸€æ®µï¼Œèµ·åä¸º <code>FirstSmali.smali</code> ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">.class public LFirstSmali;  # å®šä¹‰ç±»å</div><div class="line">.super Ljava/lang/Object;   # å®šä¹‰çˆ¶ç±»</div><div class="line">.method public static main([Ljava/lang/String;)V     # å£°æ˜é™æ€æ–¹æ³•</div><div class="line">    .registers 4     # å¯„å­˜å™¨</div><div class="line">    #.parameter      # å‚æ•°</div><div class="line">    .prologue      # ä»£ç èµ·å§‹</div><div class="line">    nop</div><div class="line">    nop</div><div class="line">    nop</div><div class="line">    nop</div><div class="line">    #æ•°æ®å®šä¹‰</div><div class="line">    const/16 v0,0x8</div><div class="line">    const/4 v1,0x5</div><div class="line">    const/4 v2,0x3</div><div class="line">    #æ•°æ®æ“ä½œ</div><div class="line">    move v1,v2</div><div class="line">    #æ•°ç»„æ“ä½œ</div><div class="line">    new-array v0,v0,[I</div><div class="line">    array-length v1,v0</div><div class="line">    #å®ä¾‹æ“ä½œ</div><div class="line">    new-instance v1,Ljava/lang/StringBuilder;</div><div class="line">    #æ–¹æ³•è°ƒç”¨</div><div class="line">    invoke-direct &#123;v1&#125;,Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V</div><div class="line">    #è·³è½¬</div><div class="line">    if-nez v0, :cond_0</div><div class="line">    goto :goto_0</div><div class="line">    :cond_0</div><div class="line">    #æ•°æ®è½¬æ¢</div><div class="line">    int-to-float v2,v2</div><div class="line">    #è¿ç®—</div><div class="line">    add-float v2,v2,v2</div><div class="line">    #æ¯”è¾ƒ</div><div class="line">    cmpl-float v0,v2,v2</div><div class="line">    #å­—æ®µæ“ä½œ</div><div class="line">    sget-object v0,Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line">    const-string v1,&quot;Hello Smali&quot;</div><div class="line">    #è°ƒç”¨</div><div class="line">    invoke-virtual &#123;v0,v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</div><div class="line">    #è¿”å›</div><div class="line">    :goto_0</div><div class="line">    return-void</div><div class="line">    return-void     # è¿”å›ç©º</div><div class="line">.end method</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="ç¼–è¯‘-smali-ç¨‹åº"><a href="#ç¼–è¯‘-smali-ç¨‹åº" class="headerlink" title="ç¼–è¯‘ smali ç¨‹åº"></a>ç¼–è¯‘ smali ç¨‹åº</h2><p>å°† <code>.smali</code> æ–‡ä»¶ç¼–è¯‘ä¸º <code>.dex</code> æ–‡ä»¶ :<br><code>java -jar smali.jar -o FirstSmali.dex FirstSmali.smali</code></p>
<hr>
<h2 id="æ‰§è¡Œ-smali-ç¨‹åº"><a href="#æ‰§è¡Œ-smali-ç¨‹åº" class="headerlink" title="æ‰§è¡Œ smali ç¨‹åº"></a>æ‰§è¡Œ smali ç¨‹åº</h2><p>æ‰“å¼€ <code>adb</code> ç¯å¢ƒï¼Œè¿ä¸Šæ‰‹æœºï¼Œåœ¨å‘½ä»¤è¡Œä¸‹<br>æ‰§è¡Œ <code>adb devices</code> æŸ¥çœ‹æ‰‹æœºæ˜¯å¦è¿æ¥æˆåŠŸï¼›<br>æ‰§è¡Œ <code>adb push FirstSmali.dex /sdcard/</code> å°† dex æ–‡ä»¶æ¨åˆ°æ‰‹æœºä¸Šï¼›<br>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°± OK äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb shell dalvikvm -cp /sdcard/FirstSmali.dex FirstSmali</div></pre></td></tr></table></figure></p>
<h3 id="å¤‡æ³¨"><a href="#å¤‡æ³¨" class="headerlink" title="å¤‡æ³¨"></a>å¤‡æ³¨</h3><p><code>-cp</code> æ˜¯ <code>classpath</code>  çš„æ„æ€ï¼Œ<code>dalvikvm</code> å‘½ä»¤ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šç±»è·¯å¾„ï¼Œç¬¬äºŒä¸ªæŒ‡å®šç±»åã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœæƒ³è¦ push åˆ°å¦‚ <code>data/local</code> ä¹‹ç±»çš„ç›®å½•ä¸‹æ˜¯æ²¡æœ‰æƒé™çš„ï¼Œå¯ä»¥å…ˆ push åˆ° sdcardï¼Œè¿›å…¥ <code>adb shell</code> æ‰§è¡Œ <code>su</code> è·å¾— root æƒé™ä¹‹åï¼Œå°±å¯ä»¥å¤åˆ¶åˆ° <code>data</code> ç›®å½•äº†ã€‚</p>
<p>æœ¬æ–‡ç¨‹åºåªæœ‰ä¸€ä¸ª dex æ–‡ä»¶ï¼Œå¤šä¸ªçš„è¯éœ€è¦æ‰“åŒ…ä¸º <code>zip</code> ï¼Œå°†æ­¤ zip æ–‡ä»¶ä½œä¸º <code>dalvikvm</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¾¿å¯ã€‚</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> smali </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ ¡éªŒæ•°å­—ç­¾åé˜²æ­¢ apk è¢«äºŒæ¬¡æ‰“åŒ… - Javaå±‚æ ¡éªŒ]]></title>
      <url>/2015/11/12/check-signature-for-avoiding-fake-app-java-level-check/</url>
      <content type="html"><![CDATA[<blockquote>
<p>æµ‹è¯•ç¯å¢ƒ<br>Ubuntu 14.04<br>Lenovo Android 5.1<br>Lenovo Android 4.2.2<br>Android Studio</p>
</blockquote>
<a id="more"></a>
<h2 id="æ™®åŠç­¾ååŒ…åçŸ¥è¯†"><a href="#æ™®åŠç­¾ååŒ…åçŸ¥è¯†" class="headerlink" title="æ™®åŠç­¾ååŒ…åçŸ¥è¯†"></a>æ™®åŠç­¾ååŒ…åçŸ¥è¯†</h2><p>åŒ…å (Package Name) ç›¸å½“äºã€Œåº”ç”¨çš„èº«ä»½è¯ã€ï¼Œæ˜¯ç³»ç»Ÿç”¨æ¥<strong>åŒºåˆ†ä¸åŒåº”ç”¨</strong>çš„å­—æ®µï¼Œé‡å¤çš„åŒ…åä¼šè¢«è®¤ä¸ºæ˜¯åŒä¸€æ¬¾åº”ç”¨ã€‚<br>ç­¾åæ–‡ä»¶ç›¸å½“äºã€Œå¼€å‘è€…çš„èº«ä»½è¯ã€ï¼Œç›®çš„æ˜¯ä¸ºäº†<strong>æ£€éªŒåº”ç”¨æ˜¯å¦è¢«äººæ›´æ”¹è¿‡</strong>ï¼ˆåº”ç”¨å¿…é¡»ç­¾åè¿‡æ‰èƒ½æ­£å¸¸å®‰è£…ï¼‰ã€‚</p>
<p>åŒ…åç›¸åŒç­¾åç›¸åŒæ—¶ï¼Œä¼šå‘ç”Ÿ æ›¿æ¢å®‰è£… / åº”ç”¨å‡çº§ï¼›<br>åŒ…åç›¸åŒç­¾åä¸åŒæ—¶ï¼Œå®‰è£…å¤±è´¥ï¼›<br>åŒ…åä¸åŒç­¾åç›¸åŒæ—¶ï¼Œç›¸å½“äºåŒä¸€å¼€å‘è€…çš„ä¸¤ä¸ªåº”ç”¨ï¼Œäº’ç›¸ä¸å†²çªã€‚</p>
<blockquote>
<p>ç­¾åçš„æ³¨æ„äº‹é¡¹<br>æ‰€æœ‰çš„Androidåº”ç”¨éƒ½å¿…é¡»æœ‰æ•°å­—ç­¾åï¼Œæ²¡æœ‰ä¸å­˜åœ¨æ•°å­—ç­¾åçš„åº”ç”¨ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œçš„ã€‚Androidç³»ç»Ÿä¸ä¼šå®‰è£…æ²¡æœ‰æ•°å­—è¯ä¹¦çš„åº”ç”¨ã€‚<br>ç­¾åçš„æ•°å­—è¯ä¹¦ä¸éœ€è¦æƒå¨æœºæ„æ¥è®¤è¯ï¼Œæ˜¯å¼€å‘è€…è‡ªå·±äº§ç”Ÿçš„æ•°å­—è¯ä¹¦ï¼Œå³æ‰€è°“çš„è‡ªç­¾åã€‚<br>æ­£å¼å‘å¸ƒä¸€ä¸ªAndroidåº”ç”¨æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ä¸€ä¸ªåˆé€‚çš„ç§é’¥ç”Ÿæˆçš„æ•°å­—è¯ä¹¦æ¥ç»™ç¨‹åºç­¾åï¼Œä¸èƒ½ä½¿ç”¨ADTæ’ä»¶æˆ–è€…ANTå·¥å…·ç”Ÿæˆçš„è°ƒè¯•è¯ä¹¦æ¥å‘å¸ƒã€‚<br>Androidå°†æ•°å­—è¯ä¹¦ç”¨æ¥æ ‡è¯†åº”ç”¨ç¨‹åºçš„ä½œè€…å’Œåœ¨åº”ç”¨ç¨‹åºä¹‹é—´å»ºç«‹ä¿¡ä»»å…³ç³»ï¼Œè€Œä¸æ˜¯ç”¨æ¥å†³å®šæœ€ç»ˆç”¨æˆ·å¯ä»¥å®‰è£…å“ªäº›åº”ç”¨ç¨‹åºã€‚</p>
</blockquote>
<hr>
<h2 id="ä¸ºå¤§ä¼—ç‚¹è¯„æ¢ç­¾å"><a href="#ä¸ºå¤§ä¼—ç‚¹è¯„æ¢ç­¾å" class="headerlink" title="ä¸ºå¤§ä¼—ç‚¹è¯„æ¢ç­¾å"></a>ä¸ºå¤§ä¼—ç‚¹è¯„æ¢ç­¾å</h2><p>æŒ‰ç…§å¸¸è§„æ­¥éª¤ä½¿ç”¨ <code>apktool</code> + <code>signapk</code> åç¼–è¯‘ã€ç¼–è¯‘ã€ç­¾åå¹¶å®‰è£…åˆ°æ‰‹æœºä¸Šï¼ˆæ²¡æœ‰ä¿®æ”¹ä»»ä½•ä»£ç ï¼‰ï¼Œæ‰“å¼€ app é€‰æ‹©åŸå¸‚åç•Œé¢å¦‚ä¸‹å›¾å¹¶å¾ˆå¿«é€€å‡ºï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dianping-crash.jpeg-style1" alt="dianping-crash"></p>
<p>è¯´æ˜ç‚¹è¯„å¯¹ç­¾åè¿›è¡Œäº†æ ¡éªŒ ã€‚</p>
<hr>
<h2 id="åˆ†ææ ¡éªŒæ–¹æ³•"><a href="#åˆ†ææ ¡éªŒæ–¹æ³•" class="headerlink" title="åˆ†ææ ¡éªŒæ–¹æ³•"></a>åˆ†ææ ¡éªŒæ–¹æ³•</h2><h3 id="æ€ä¹ˆé€€å‡ºçš„ï¼Ÿ"><a href="#æ€ä¹ˆé€€å‡ºçš„ï¼Ÿ" class="headerlink" title="æ€ä¹ˆé€€å‡ºçš„ï¼Ÿ"></a>æ€ä¹ˆé€€å‡ºçš„ï¼Ÿ</h3><p>æ‰“å¼€ apktool åç¼–è¯‘å¾—åˆ°çš„æ–‡ä»¶å¤¹ä¸‹çš„ <code>AndroidManifest.xml</code> ï¼Œå¾—åˆ°ç¨‹åºåŒ…åï¼š<code>com.dianping.v1</code> ã€‚<br>æ¸…é™¤å¤§ä¼—ç‚¹è¯„çš„æ•°æ®ï¼Œæ‰“å¼€ asï¼Œè¿ä¸Šæ‰‹æœºï¼Œlog çš„è¿‡æ»¤æ¡ä»¶è®¾ä¸º com.dianping ï¼Œåœ¨é€‰æ‹©åŸå¸‚ä¹‹å‰æ¸…ä¸€ä¸‹ log ï¼Œåœ¨ log é‡Œæœç´¢ â€œdieâ€ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„æ˜¯æœ‰å››å¤„ï¼š</p>
<p>è¿›ç¨‹æ­»äº¡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Process com.dianping.v1 (pid 19182) has died</div><div class="line">Process com.dianping.v1 (pid 19586) has died</div><div class="line">Process com.dianping.v1 (pid 19650) has died</div></pre></td></tr></table></figure></p>
<p>app æ­»äº¡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Force removing ActivityRecord&#123;266e5efd u0 com.dianping.v1/.NovaMainActivity t14010&#125;: app died, no saved state</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å‰ä¸¤ä¸ªè¿›ç¨‹æ­»äº¡ä¹‹åéƒ½æœ‰å¼€å¯è¿›ç¨‹çš„æ“ä½œï¼Œè¯´æ˜ç¬¬ä¸€æ¬¡æ ¡éªŒå¤±è´¥åé‡è¯•äº†ä¸¤æ¬¡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startProcess: name=com.dianping.v1 app=null knownToBeDead=true thread=null pid=-1</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">startProcess: name=com.dianping.v1 app=null knownToBeDead=true thread=null pid=-1</div></pre></td></tr></table></figure>
<p>æœ€åä¸€ä¸ªç›´æ¥æ€æ­»äº† appï¼Œæ²¡æœ‰å†ç»§ç»­åˆ›å»ºè¿›ç¨‹ã€‚</p>
<p>åœ¨è¿›ç¨‹ç»“æŸä¹‹å‰ï¼Œå‘ç”Ÿé”™è¯¯çš„è°ƒç”¨è®°å½•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">9586-19586/? D/AccessibilityManager:     at com.dianping.base.app.NovaActivity.setContentView(NovaActivity.java:722)</div><div class="line"> 9586-19586/? D/AccessibilityManager:     at com.dianping.main.guide.MainActivity.setOnContentView(MainActivity.java:339)</div><div class="line"> 9586-19586/? D/AccessibilityManager:     at com.dianping.base.basic.FragmentTabActivity.onCreate(FragmentTabActivity.java:51)</div><div class="line"> 9586-19586/? D/AccessibilityManager:     at com.dianping.base.widget.NovaFragmentTabActivity.onCreate(NovaFragmentTabActivity.java:26)</div><div class="line"> 9586-19586/? D/AccessibilityManager:     at com.dianping.main.guide.MainActivity.onCreate(MainActivity.java:169)</div><div class="line"> 9586-19586/? D/AccessibilityManager:     at com.dianping.v1.NovaMainActivity.onCreate(NovaMainActivity.java:15)</div></pre></td></tr></table></figure></p>
<h3 id="ä»£ç æ¢ç´¢"><a href="#ä»£ç æ¢ç´¢" class="headerlink" title="ä»£ç æ¢ç´¢"></a>ä»£ç æ¢ç´¢</h3><p>è§£å‹ apk æ–‡ä»¶ï¼Œå‘ç°æœ‰ 3 ä¸ª dex æ–‡ä»¶ï¼Œå…ˆæ‹¿ç¬¬ä¸€ä¸ªä¸‹æ‰‹ï¼ŒJD-GUI æ‰“å¼€å‘ç°ä»£ç æ²¡æœ‰æ··æ·†ï¼</p>
<p>è°ƒç”¨è®°å½•ä¸­çš„æ–‡ä»¶ä»ä¸Šå¾€ä¸‹è¿‡ä¸€éï¼Œå‘ç°åœ¨ <code>com.dianping.main.guide.MainActivity.onCreate()</code> æ–¹æ³•ä¸­æœ‰æ ¡éªŒç­¾åçš„å‡½æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (!checkSignature()) &#123;    </div><div class="line">      Process.killProcess(Process.myPid());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>checkSignature</code> å‡½æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">private boolean checkSignature()</div><div class="line">&#123;</div><div class="line"> try</div><div class="line"> &#123;</div><div class="line">   Signature[] arrayOfSignature = getPackageManager().getPackageInfo(getPackageName(), 64).signatures;     //è·å¾—ç­¾åæ•°ç»„</div><div class="line">   if (arrayOfSignature != null)</div><div class="line">   &#123;</div><div class="line">     if (arrayOfSignature.length == 0) &#123;</div><div class="line">       return false;</div><div class="line">     &#125;</div><div class="line">     int j = arrayOfSignature.length;</div><div class="line">     int i = 0;</div><div class="line">     while (i &lt; j)   //å¦‚æœæ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ å€¼ä¸ &apos;ac6fc3fe&apos; ç›¸ç­‰ï¼Œè¿”å›æ ¡éªŒæˆåŠŸï¼›å¦‚æœç›´åˆ°ç»“æŸä¹Ÿæ²¡æœ‰ç›¸ç­‰çš„å…ƒç´ ï¼Œè¿”å›å¤±è´¥</div><div class="line">     &#123;               //åªæ¯”è¾ƒä¸€ä¸ªç‰¹å®šçš„å…ƒç´ ï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸ºäº†ä¸æŠŠæ•´ä¸ªç­¾åæ³„éœ²å‡ºæ¥ï¼ŒåŒæ—¶ä¹Ÿåšåˆ°äº†ä¸€å®šç¨‹åº¦çš„æ ¡éªŒ</div><div class="line">       String str = Integer.toHexString(arrayOfSignature[i].toCharsString().hashCode());</div><div class="line">       if (!&quot;ac6fc3fe&quot;.equalsIgnoreCase(str))   </div><div class="line">       &#123;</div><div class="line">         boolean bool = &quot;600cf559&quot;.equalsIgnoreCase(str);       //è¿™ä¸ªæ¯”è¾ƒå¥½åƒæ²¡ç”¨</div><div class="line">         if (!bool) &#123;&#125;</div><div class="line">       &#125;</div><div class="line">       else</div><div class="line">       &#123;</div><div class="line">         return true;</div><div class="line">       &#125;</div><div class="line">       i += 1;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">   return false;</div><div class="line"> &#125;</div><div class="line"> catch (Exception localException) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç›¸å…³ APIï¼š</p>
<p><code>public Signature[] signatures</code><br>Array of all signatures read from the package file. This is only filled in if the flag GET_SIGNATURES was set.</p>
<p><code>public static final int GET_SIGNATURES</code><br>PackageInfo flag: return information about the signatures included in the package.<br>Constant Value: 64 (0x00000040)</p>
<p><code>public boolean equalsIgnoreCase (String string)</code><br>Compares the given string to this string ignoring case.<br>The strings are compared one char at a time.</p>
<h3 id="æµç¨‹ä¿®æ”¹"><a href="#æµç¨‹ä¿®æ”¹" class="headerlink" title="æµç¨‹ä¿®æ”¹"></a>æµç¨‹ä¿®æ”¹</h3><p>åœ¨ <code>smali/com/dianping/main/guide/MainActivity.smali</code> ä¸­æœç´¢ <code>ac6fc3fe</code> :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.line 358</div><div class="line">    .local v4, &quot;myHash&quot;:Ljava/lang/String;</div><div class="line">    const-string v9, &quot;ac6fc3fe&quot;</div><div class="line">    invoke-virtual &#123;v9, v4&#125;, Ljava/lang/String;-&gt;equalsIgnoreCase(Ljava/lang/String;)Z</div><div class="line">    move-result v9</div><div class="line">    if-nez v9, :cond_2      //if(!equal(..)) return 1</div></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ° <code>con_2</code> çš„å®šä¹‰:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">.line 359</div><div class="line">:cond_2</div><div class="line">const/4 v8, 0x1</div><div class="line">goto :goto_0</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">:goto_0</div><div class="line">    return v8</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥æŠŠ <code>if-nez v9, :cond_2</code> æ”¹æˆ <code>if-eqz v9, :cond_2</code> å°±å¯ä»¥äº†ï¼Œå½“ç„¶ï¼Œä¿®æ”¹æ–¹æ³•è¿˜æœ‰å¾ˆå¤šã€‚</p>
<h3 id="æ‰“åŒ…ç­¾å"><a href="#æ‰“åŒ…ç­¾å" class="headerlink" title="æ‰“åŒ…ç­¾å"></a>æ‰“åŒ…ç­¾å</h3><p>ç‚¹è¯„å¯ä»¥æ­£å¸¸æ‰“å¼€ï¼Œæ­£å¸¸ç™»å½•ï¼Œæ­£å¸¸ä½¿ç”¨äº†ã€‚</p>
<hr>
<blockquote>
<p>ç•ªå¤–ï¼š<br>è€Œå¦ä¸€å°æ‰‹æœº (Lenovo Android 4.2.2) æµ‹è¯•è¿›ç¨‹ä¼šä¸æ–­é‡æ–°åˆ›å»ºã€‚<br>åº”ç”¨ crash ä¹‹å App å¯¹åº”çš„ Process éƒ½è¢«æ€æ­»ï¼Œç„¶åå®‰æ’é‡å¯ Serviceï¼Œé‡æ–°å¯åŠ¨ Task æ ˆé¡¶çš„ Activity ã€‚</p>
</blockquote>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">Androidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æ</a><br><a href="http://www.wandoujia.com/blog/xibaibai-diary-3" target="_blank" rel="external">æ´—ç™½ç™½æ‰‹è®°ï¼šç»•å¼€ Android åº”ç”¨å¼€å‘çš„é‚£äº›ã€Œå‘ã€</a><br><a href="http://www.oschina.net/question/163910_27292#tags_nav" target="_blank" rel="external">ç»™ Android åº”ç”¨ç¨‹åºç­¾å</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> reverse </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android å®‰å…¨å·¥å…·åŒ…ï¼ˆæŒç»­æ›´æ–°ï¼‰]]></title>
      <url>/2015/11/12/Android-security-tools/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>å·¥å…·æ¸…å•</strong></p>
<ul>
<li>Apktool/SHakaApktool</li>
<li>smali &amp; baksmali</li>
<li>dex2jar</li>
<li>JD-GUI</li>
<li>signapk</li>
<li>dx &amp; ddx</li>
</ul>
</blockquote>
<p>ä»¥ä¸Šå·¥å…·å¯ç‚¹å‡» <a href="https://github.com/kiya-z/Android/tree/master/tools" target="_blank" rel="external">è¿™é‡Œ</a> æ‰“åŒ…ä¸‹è½½</p>
<p><strong>æœ¬æ–‡ç¯å¢ƒï¼š<code>Ubuntu 14.04.3 LTS 64-bit</code></strong></p>
<a id="more"></a>
<hr>
<p><strong>å·¥å…·ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">java-&gt;class: javac</div><div class="line">smali-&gt;dex: smali.jar</div><div class="line">class-&gt;dex: dx</div><div class="line">dex-&gt;arm: execute</div><div class="line">dex-&gt;smali: baksmali</div><div class="line">dex-&gt;class: dex2jar</div><div class="line">class-&gt;java: JD-GUI</div></pre></td></tr></table></figure>
<hr>
<h1 id="Apktool"><a href="#Apktool" class="headerlink" title="Apktool"></a><strong>Apktool</strong></h1><p>ç‚¹å‡» <a href="http://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="external">å®˜ç½‘</a> ä¸‹è½½ï¼Œé‡Œé¢ä¹Ÿæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ã€‚</p>
<p><strong>ä¸­æ–‡æ­¥éª¤åŠæ³¨æ„äº‹é¡¹:</strong></p>
<p>ï¼ˆ<em>æ­¤å¤„ä¸º Apktool 2.x ç‰ˆæœ¬</em>ï¼‰</p>
<ol>
<li>å³é”®å¦å­˜ <a href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool" target="_blank" rel="external">è„šæœ¬æ–‡ä»¶</a>ï¼Œåä¸º <code>apktool</code> ã€‚å¦‚æœä¸èƒ½å¦å­˜ï¼Œæ‰“å¼€ <a href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool" target="_blank" rel="external">è„šæœ¬æ–‡ä»¶</a>ï¼Œ å¤åˆ¶å…¨éƒ¨å†…å®¹åˆ°æ–°å»ºæ–‡ä»¶ <code>apktool</code> ä¸­ï¼›</li>
<li>ä¸‹è½½ <a href="https://bitbucket.org/iBotPeaches/apktool/downloads" target="_blank" rel="external">apktool</a>ï¼Œå°†å…¶é‡å‘½åä¸º <code>apktool.jar</code> ã€‚</li>
<li>å¦‚æœæ˜¯ç³»ç»Ÿæ˜¯ 64 ä½ï¼Œéœ€è¦å®‰è£… 32 ä½çš„åº“æ–‡ä»¶ã€‚å¦‚ä½•å®‰è£…å¯å‚è€ƒ <a href="http://stackoverflow.com/questions/23182765/how-to-install-ia32-libs-in-ubuntu-14-04-lts-trusty-tahr" target="_blank" rel="external">How to install ia32-libs in Ubuntu 14.04 LTS (Trusty Tahr)</a> . æˆ–è€…ç›´æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo -i</div><div class="line">cd /etc/apt/sources.list.d</div><div class="line">echo &quot;deb http://old-releases.ubuntu.com/ubuntu/ raring main restricted universe multiverse&quot; &gt;ia32-libs-raring.list</div><div class="line">apt-get update</div><div class="line">apt-get install ia32-libs</div><div class="line">rm ia32-libs-raring.list /etc/apt/sources.list.d</div><div class="line">apt-get update</div></pre></td></tr></table></figure>
</li>
</ol>
<p>æ‰§è¡Œå®Œæˆå¯æŒ‰ <code>Ctrl+D</code> æ³¨é”€ root .</p>
<ol>
<li>æŠŠ <code>apktool</code> å’Œ <code>apktool.jar</code> ä¸¤ä¸ªæ–‡ä»¶ç§»åŠ¨åˆ° <code>usr/local/bin</code> . æ­¤æ­¥éª¤éœ€è¦ <code>sudo</code> .</li>
<li>ä¸ºè¿™ä¸¤ä¸ªæ–‡ä»¶åŠ ä¸Šå¯æ‰§è¡Œæƒé™ã€‚</li>
<li>æ‰§è¡Œ <code>apktool</code> æµ‹è¯•æ•ˆæœã€‚å¦‚æœæç¤º <code>can&#39;t find file apktool.jar</code> ï¼Œå¯èƒ½æ˜¯å› ä¸ºå½“å‰ç”¨æˆ·æ²¡æœ‰ <code>apktool.jar</code> çš„è¯»æƒé™ï¼Œè¯•è¯•ç”¨ <code>sudo apktool</code> æˆ–è€…ä¸ºå…¶åŠ ä¸Šè¯»æƒé™ã€‚</li>
</ol>
<hr>
<h1 id="ShakaApktool"><a href="#ShakaApktool" class="headerlink" title="ShakaApktool"></a>ShakaApktool</h1><p>ShakaApktoolæ˜¯ä¸€ä¸ªæ¯”apktoolæ›´å¼ºå¤§çš„å·¥å…·,æºä»£ç åœ¨æ­¤<a href="https://github.com/rover12421/ShakaApktool" target="_blank" rel="external">https://github.com/rover12421/ShakaApktool</a>.<br>å°½æƒ…äº«ç”¨. :p</p>
<hr>
<h1 id="smali-amp-baksmali"><a href="#smali-amp-baksmali" class="headerlink" title="smali &amp; baksmali"></a><strong>smali &amp; baksmali</strong></h1><p>Apktool ä¸­å†…ç½®äº† smali å’Œ baksmaliï¼Œ<a href="https://bitbucket.org/JesusFreke/smali/downloads" target="_blank" rel="external">ä¸‹è½½é“¾æ¥</a></p>
<hr>
<h1 id="dex2jar"><a href="#dex2jar" class="headerlink" title="dex2jar"></a><strong>dex2jar</strong></h1><p>ä¸‹è½½ <a href="https://bitbucket.org/pxb1988/dex2jar/downloads" target="_blank" rel="external">dex2jar</a> è§£å‹ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸ºæ‰€æœ‰çš„ <code>.sh</code> æ–‡ä»¶åŠ ä¸Šæ‰§è¡Œæƒé™ï¼Œç›®å‰æˆ‘åªåŠ äº† <code>d2j-dex2jar.sh</code> å’Œ <code>d2j_invoke.sh</code> ã€‚å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ°å‘½ä»¤ï¼Œå°±æ˜¯å› ä¸ºä½ æ²¡æœ‰åŠ æ‰§è¡Œæƒé™ã€‚</p>
<hr>
<h1 id="JD-GUI"><a href="#JD-GUI" class="headerlink" title="JD-GUI"></a><strong>JD-GUI</strong></h1><p>å» <a href="http://jd.benow.ca/" target="_blank" rel="external">å®˜ç½‘</a> ä¸‹è½½ç›¸åº”ç‰ˆæœ¬ã€‚<br>æˆ‘ä¸‹è½½çš„æ˜¯ <code>.deb</code> æ–‡ä»¶ï¼Œå®‰è£…å‘½ä»¤ä¸º <code>sudo dpkg -i filename</code> .</p>
<hr>
<h1 id="signapk"><a href="#signapk" class="headerlink" title="signapk"></a><strong>signapk</strong></h1><p>è¿›è¡Œç­¾åéœ€è¦ <code>sianapk.sh</code> ã€<code>signapk.jar</code> å’Œä¸¤ä¸ªç­¾åæ–‡ä»¶ <code>testkey.pk8</code> ã€<code>testkey.x509.pem</code> ã€‚<br><a href="https://github.com/kiya-z/Android/tree/master/tools/signapk" target="_blank" rel="external">ç‚¹å‡»ä¸‹è½½</a></p>
<hr>
<h1 id="dx-amp-ddx"><a href="#dx-amp-ddx" class="headerlink" title="dx &amp; ddx"></a><strong>dx &amp; ddx</strong></h1><p><code>dx</code> æ˜¯æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå°† Java å­—èŠ‚ç è½¬æ¢ä¸º Dalvik å­—èŠ‚ç ï¼ˆclass æ–‡ä»¶å˜æˆ dex æ–‡ä»¶ï¼‰ï¼Œ<code>ddx</code> åˆ™æ­£å¥½ç›¸åã€‚<br>ä½ å¯ä»¥åœ¨ SDK ä¸­æ‰¾åˆ°å®ƒä»¬ï¼Œæˆ–è€… <a href="https://github.com/kiya-z/Android/tree/master/tools" target="_blank" rel="external">ä¸‹è½½</a> ã€‚</p>
<hr>
<h1 id="010-editor"><a href="#010-editor" class="headerlink" title="010 editor"></a><strong>010 editor</strong></h1><p>æŸ¥çœ‹äºŒè¿›åˆ¶æ•°æ®çš„ç¥å™¨ï¼Œå…·ä½“åœ¨è¿™é‡Œ -&gt; <a href="http://kiya-z.github.io/2015/11/19/tools-010-editor/" target="_blank" rel="external">å·ç§° Edit Everything çš„ 010 Editor</a></p>
<hr>
<h1 id="adb"><a href="#adb" class="headerlink" title="adb"></a><strong>adb</strong></h1><p>å…¨ç¨‹ android debug bridgeï¼Œä½äº SDK ä¸­çš„ platform-tools ä¸­ã€‚</p>
<hr>
<h1 id="fastboot"><a href="#fastboot" class="headerlink" title="fastboot"></a><strong>fastboot</strong></h1><p>ä½äº SDK ä¸­çš„ platform-tools,å¯ç”¨æ¥åˆ·recoveryæ–‡ä»¶</p>
<hr>
<h1 id="jadx"><a href="#jadx" class="headerlink" title="jadx"></a><strong>jadx</strong></h1><p>dex2javaå·¥å…·,ç½‘å€:<a href="https://github.com/skylot/jadx" target="_blank" rel="external">https://github.com/skylot/jadx</a></p>
<hr>
<blockquote>
<p>to be continued.</p>
</blockquote>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Python ä¹‹ æ¥å£å’Œå¤šæ€å¼•å‘çš„è¡€æ¡ˆ]]></title>
      <url>/2015/11/11/Python-a-murder-about-interface-and-polymorphism/</url>
      <content type="html"><![CDATA[<h1 id="äº‹æ•…å‘ç”Ÿåœ°"><a href="#äº‹æ•…å‘ç”Ÿåœ°" class="headerlink" title="äº‹æ•…å‘ç”Ÿåœ°"></a>äº‹æ•…å‘ç”Ÿåœ°</h1><p>åœ¨å­¦ä¹ <a href="http://www.maiziedu.com/course/python/545-7480/" target="_blank" rel="external"> Python é¢å‘å¯¹è±¡è§†é¢‘ ä¹‹ é¸­å­ç±»å‹ä¸å¤šæ€ </a>æ—¶çœ‹åˆ°è¿™æ ·ä¸¤å¥è¯ä¸å¾—å…¶è§£ï¼š</p>
<blockquote>
<p>éåŠ¨æ€è¯­è¨€å¿…é¡»é€šè¿‡ç»§æ‰¿å’Œæ¥å£å®ç°å¤šæ€<br>åŠ¨æ€è¯­è¨€ä¸éœ€è¦å®ç°æ¥å£</p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="èœé¸Ÿçš„é—®é¢˜"><a href="#èœé¸Ÿçš„é—®é¢˜" class="headerlink" title="èœé¸Ÿçš„é—®é¢˜"></a>èœé¸Ÿçš„é—®é¢˜</h1><p>(éåŠ¨æ€è¯­è¨€ä»¥ Java ä¸ºä¾‹ï¼ŒåŠ¨æ€è¯­è¨€ä»¥ Python ä¸ºä¾‹)</p>
<ol>
<li>æ¥å£å’Œå¤šæ€æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
<li>Python ä¸ºä»€ä¹ˆæ²¡æœ‰æ¥å£ï¼Ÿæ²¡æœ‰æ¥å£æ€ä¹ˆå®ç°æ¥å£å¯¹åº”çš„è®¾è®¡æ¨¡å¼</li>
<li>Python ä¸ºä»€ä¹ˆæ²¡æœ‰é‡è½½ï¼Ÿ</li>
<li>Python çš„å¤šæ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li>
</ol>
<hr>
<h2 id="æ¥å£å’Œå¤šæ€æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#æ¥å£å’Œå¤šæ€æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="æ¥å£å’Œå¤šæ€æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>æ¥å£å’Œå¤šæ€æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</h2><p>  åœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œå¤šæ€å…·æœ‰ä¸¤ç§å½¢å¼ï¼Œé‡è½½å’Œé‡å†™ï¼š</p>
<blockquote>
<p><strong>é‡è½½</strong>ï¼š<em>åœ¨åŒä¸€ä¸ªç±»ä¸­</em>ï¼Œç›¸åŒçš„æ–¹æ³•åå¯¹åº”ç€ä¸åŒçš„æ–¹æ³•å®ç°ï¼Œå…¶åŒºåˆ«åœ¨äºä»–ä»¬éœ€è¦çš„å‚æ•°å’Œè¿”å›å€¼ä¸åŒã€‚<br><strong>é‡å†™</strong>ï¼š<em>ç”¨äºçˆ¶ç±»å’Œå­ç±»é—´</em>ï¼Œå­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œåªæ˜¯å¯¹åº”çš„æ–¹æ³•å®ç°ä¸åŒï¼Œå…¶æ–¹æ³•åå’Œå‚æ•°éƒ½ç›¸åŒã€‚</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¥ï¼Œé‡å†™æ˜¯åŸºäºç»§æ‰¿çš„ã€‚é‚£ä¹ˆæ¥å£å‘¢ï¼Ÿå¥½åƒé™¤äº†å¼ºåˆ¶è¦æ±‚å­ç±»å®ç°æŸäº›æ–¹æ³•ï¼Œæˆ‘ä¸çŸ¥é“è¿˜æœ‰ä»€ä¹ˆåˆ«çš„ä½œç”¨ã€‚<br>æ­£å› å¦‚æ­¤ï¼Œæ¥å£åªæ˜¯ä¸€ä¸ªè§„èŒƒã€‚åœ¨å¤šä¸ªç±»éƒ½å®ç°ä¸€ä¸ªæ¥å£çš„æ—¶å€™ä»–çš„ä½œç”¨å°±ä½“ç°å‡ºæ¥äº†ï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“åœ¨æŸä¸ªç±»ä¸­è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œåªéœ€è¦è¿™ä¸ªç±»ä¸­æœ‰è¿™ä¸ªæ–¹æ³•è€Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨å°±å¯ä»¥äº†ã€‚æœ‰äº†è¿™æ ·ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼Œæˆ‘ä»¬å°±ä¸å¿…æ‹…å¿ƒåŒæ ·åŠŸèƒ½çš„æ–¹æ³•è¢«èµ·äº†å„ç§å„æ ·çš„åå­—äº†ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘è§‰å¾—å¯ä»¥ç”¨è¿™ä¹ˆä¸€å¥è¯å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œ<strong>æ¥å£ä¸æ˜¯å®ç°å¤šæ€çš„ï¼Œè€Œæ˜¯åŸºäºå¤šæ€çš„ï¼Œæœ‰äº†å¤šæ€æ¥å£æ‰èƒ½å‘æŒ¥ä½œç”¨</strong>ã€‚</p>
<hr>
<h2 id="Python-ä¸ºä»€ä¹ˆæ²¡æœ‰æ¥å£ï¼Ÿæ²¡æœ‰æ¥å£æ€ä¹ˆå®ç°æ¥å£å¯¹åº”çš„è®¾è®¡æ¨¡å¼"><a href="#Python-ä¸ºä»€ä¹ˆæ²¡æœ‰æ¥å£ï¼Ÿæ²¡æœ‰æ¥å£æ€ä¹ˆå®ç°æ¥å£å¯¹åº”çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="Python ä¸ºä»€ä¹ˆæ²¡æœ‰æ¥å£ï¼Ÿæ²¡æœ‰æ¥å£æ€ä¹ˆå®ç°æ¥å£å¯¹åº”çš„è®¾è®¡æ¨¡å¼"></a>Python ä¸ºä»€ä¹ˆæ²¡æœ‰æ¥å£ï¼Ÿæ²¡æœ‰æ¥å£æ€ä¹ˆå®ç°æ¥å£å¯¹åº”çš„è®¾è®¡æ¨¡å¼</h2><p>æ¥å£çš„ä½œç”¨å°±æ˜¯è§„èŒƒï¼Œè§„èŒƒå‚æ•°ç±»å‹ï¼Œè¿”å›å€¼ç­‰ç­‰ï¼Œä»è€Œä½¿ç›¸åŒçš„è°ƒç”¨èƒ½å¤Ÿå®ç°ä¸åŒçš„æ•ˆæœï¼›å¹¶ä¸”æ¥å£ä¹Ÿæ˜¯ä¸ºäº†ç”¨æ¥å¼¥è¡¥è¯­è¨€è‡ªå·±è¡¨è¾¾èƒ½åŠ›çš„ä¸è¶³ï¼Œå¦‚ï¼šJava åªæ”¯æŒå•ç»§æ‰¿ï¼Œä¸ºäº†ä½¿ç±»æ‹¥æœ‰æ›´å¤šçš„ç‰¹æ€§ï¼Œä½¿ç”¨äº†å¤šå®ç°æ¥å¼¥è¡¥ã€‚é™æ€çš„è¯­è¨€å¿…é¡»å…¨éƒ¨éƒ½è§„å®šå¥½æ‰èƒ½æ­£ç¡®ä½¿ç”¨ã€‚<br>è€Œåœ¨ Python  ä¸­ï¼Œå˜é‡æ˜¯æ²¡æœ‰ç±»å‹çš„ï¼Œä¸éœ€è¦äº‹å…ˆè§„å®šï¼Œä¸ç®¡è°ƒç”¨è€…ä¼ å…¥ä»€ä¹ˆç±»å‹çš„å¯¹è±¡ï¼Œè¢«è°ƒç”¨è€…å°±ä¼šè®¤ä¸ºé‚£å°±æ˜¯æˆ‘æ‰€éœ€è¦çš„å¯¹è±¡(é¸­å­ç±»å‹)ï¼Œå¦‚æœåœ¨è¿è¡Œæ—¶ä¼ å…¥çš„å¯¹è±¡ä¸å…·å¤‡éœ€è¦çš„å±æ€§æˆ–æ–¹æ³•ï¼Œç¨‹åºä¼šç›´æ¥æŠ¥é”™ã€‚éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œå°±ç…§å®ç°å°±æ˜¯äº†ï¼Œè¿”å›å’Œå½¢å‚ä¸é™åˆ¶ç±»å‹ï¼Œæ¯”å¦‚ï¼šåœ¨åˆ›å»ºäº†ç±»çš„å®ä¾‹åï¼ŒåŠ¨æ€åœ°ç»™è¯¥å®ä¾‹åŠ ä¸Šä¸€ä¸ªå‡½æ•°å±æ€§ã€‚è¿™å°±æ˜¯åŠ¨æ€ç±»å‹çš„ä¼˜åŠ¿ã€‚<br>è¿™ç§é£æ ¼è¢«ç§°ä¸ºâ€œ<strong>é¸­å­ç±»å‹</strong>â€ï¼š</p>
<blockquote>
<p>åœ¨è¿™ç§é£æ ¼ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡æœ‰æ•ˆçš„è¯­ä¹‰ï¼Œä¸æ˜¯ç”±ç»§æ‰¿è‡ªç‰¹å®šçš„ç±»æˆ–å®ç°ç‰¹å®šçš„æ¥å£ï¼Œè€Œæ˜¯ç”±â€å½“å‰æ–¹æ³•å’Œå±æ€§çš„é›†åˆâ€å†³å®šã€‚<br>åœ¨æˆ‘æƒ³æˆä¸ºé¸­å­çš„æ—¶å€™ï¼Œä¸æ˜¯æˆ‘å¿…é¡»çœŸçš„æ˜¯ä¸ªé¸­å­ï¼Œè€Œæ˜¯æˆ‘çš„è¡Œä¸ºè¡¨ç°çš„åƒæ˜¯ä¸ªé¸­å­ï¼Œé‚£æˆ‘å°±æ˜¯ä¸ªé¸­å­</p>
</blockquote>
<p>ç›¸å…³æ¦‚å¿µ - â€œ<strong>é¸­å­æµ‹è¯•</strong>â€ï¼š</p>
<blockquote>
<p>â€œå½“çœ‹åˆ°ä¸€åªé¸Ÿèµ°èµ·æ¥åƒé¸­å­ã€æ¸¸æ³³èµ·æ¥åƒé¸­å­ã€å«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£ä¹ˆè¿™åªé¸Ÿå°±å¯ä»¥è¢«ç§°ä¸ºé¸­å­ã€‚â€<br>â€œæ¢è¨€ä¹‹ï¼Œä¸è¦æ£€æŸ¥å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ªé¸­å­ï¼šæ£€æŸ¥å®ƒåƒä¸åƒä¸€ä¸ªé¸­å­åœ°å«ï¼Œç­‰ç­‰ã€‚å–å†³äºä½ éœ€è¦å“ªä¸ªåƒé¸­å­çš„è¡Œä¸ºçš„å­é›†æ¥ä½¿ç”¨è¯­è¨€ã€‚â€</p>
</blockquote>
<hr>
<h2 id="Python-ä¸ºä»€ä¹ˆæ²¡æœ‰é‡è½½ï¼Ÿ"><a href="#Python-ä¸ºä»€ä¹ˆæ²¡æœ‰é‡è½½ï¼Ÿ" class="headerlink" title="Python ä¸ºä»€ä¹ˆæ²¡æœ‰é‡è½½ï¼Ÿ"></a>Python ä¸ºä»€ä¹ˆæ²¡æœ‰é‡è½½ï¼Ÿ</h2><blockquote>
<p>å‡½æ•°é‡è½½ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¯å˜å‚æ•°ç±»å‹ã€‚</li>
<li>å¯å˜å‚æ•°ä¸ªæ•°ã€‚</li>
</ol>
</blockquote>
<p>å¦å¤–ï¼Œä¸€ä¸ªåŸºæœ¬çš„è®¾è®¡åŸåˆ™æ˜¯ï¼Œä»…ä»…å½“ä¸¤ä¸ªå‡½æ•°é™¤äº†å‚æ•°ç±»å‹å’Œå‚æ•°ä¸ªæ•°ä¸åŒä»¥å¤–ï¼Œå…¶åŠŸèƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œæ­¤æ—¶æ‰ä½¿ç”¨å‡½æ•°é‡è½½ï¼Œå¦‚æœä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½å…¶å®ä¸åŒï¼Œé‚£ä¹ˆä¸åº”å½“ä½¿ç”¨é‡è½½ï¼Œè€Œåº”å½“ä½¿ç”¨ä¸€ä¸ªåå­—ä¸åŒçš„å‡½æ•°ã€‚<br><em>å¯¹äºæƒ…å†µ 1</em>ï¼Œå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯å‚æ•°ç±»å‹ä¸åŒï¼ŒPython å¦‚ä½•å¤„ç†ï¼Ÿç­”æ¡ˆæ˜¯æ ¹æœ¬ä¸éœ€è¦å¤„ç†ï¼Œå› ä¸º python å¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å‚æ•°ï¼Œå¦‚æœå‡½æ•°çš„åŠŸèƒ½ç›¸åŒï¼Œé‚£ä¹ˆä¸åŒçš„å‚æ•°ç±»å‹åœ¨ Python ä¸­å¾ˆå¯èƒ½æ˜¯ç›¸åŒçš„ä»£ç ï¼Œæ²¡æœ‰å¿…è¦åšæˆä¸¤ä¸ªä¸åŒå‡½æ•°ã€‚<br><em>å¯¹äºæƒ…å†µ 2</em> ï¼Œå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œä½†å‚æ•°ä¸ªæ•°ä¸åŒï¼ŒPython å¦‚ä½•å¤„ç†ï¼Ÿå¤§å®¶çŸ¥é“ï¼Œç­”æ¡ˆå°±æ˜¯ç¼ºçœå‚æ•°ã€‚å¯¹é‚£äº›ç¼ºå°‘çš„å‚æ•°è®¾å®šä¸ºç¼ºçœå‚æ•°å³å¯è§£å†³é—®é¢˜ã€‚å› ä¸ºä½ å‡è®¾å‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œé‚£ä¹ˆé‚£äº›ç¼ºå°‘çš„å‚æ•°ç»ˆå½’æ˜¯éœ€è¦ç”¨çš„ã€‚<br>å¥½äº†ï¼Œé‰´äºæƒ…å†µ 1 è·Ÿ æƒ…å†µ 2 éƒ½æœ‰äº†è§£å†³æ–¹æ¡ˆï¼ŒPython è‡ªç„¶å°±ä¸éœ€è¦å‡½æ•°é‡è½½äº†ã€‚</p>
<hr>
<h2 id="Python-çš„å¤šæ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#Python-çš„å¤šæ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="Python çš„å¤šæ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>Python çš„å¤šæ€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>å¤šæ€å³å¤šç§å½¢æ€ï¼Œåœ¨è¿è¡Œæ—¶ç¡®å®šå…¶çŠ¶æ€ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µæ— æ³•ç¡®å®šå…¶ç±»å‹ï¼Œè¿™å°±æ˜¯å¤šæ€ã€‚<br>1ï¼‰Pythonæ˜¯è§£é‡Šæ€§è¯­è¨€ã€‚ä¸è¿›è¡Œé¢„ç¼–è¯‘ï¼Œå› æ­¤å®ƒå°±åªåœ¨è¿è¡Œæ—¶ç¡®å®šå…¶çŠ¶æ€ï¼›<br>2ï¼‰Pythonä¸­å˜é‡æ˜¯å¼±ç±»å‹çš„ã€‚åœ¨å®šä¹‰æ—¶ä¸ç”¨æŒ‡æ˜å…¶ç±»å‹ï¼Œå®ƒä¼šæ ¹æ®éœ€è¦åœ¨è¿è¡Œæ—¶ç¡®å®šå˜é‡çš„ç±»å‹ã€‚</p>
<hr>
<blockquote>
<p>ç»“è¯­ï¼šä¸€äº›ç²—æµ…ä¹‹è¯­ï¼Œæœ‰é•¿è¿›å†è¡¥å……ã€‚</p>
</blockquote>
<hr>
<h1 id="Referenceï¼š"><a href="#Referenceï¼š" class="headerlink" title="Referenceï¼š"></a>Referenceï¼š</h1><p><a href="http://www.zhihu.com/question/20111251" target="_blank" rel="external"> Java ä¸­çš„æ¥å£æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</a><br><a href="http://www.zhihu.com/question/20685467" target="_blank" rel="external"> Python é‡Œæ²¡æœ‰æ¥å£ï¼Œå¦‚ä½•å†™è®¾è®¡æ¨¡å¼ï¼Ÿ</a><br><a href="http://www.zhihu.com/question/20053359" target="_blank" rel="external">ä¸ºä»€ä¹ˆ Python  ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Ÿ</a><br><a href="http://www.cnblogs.com/dolphin0520/archive/2013/04/03/2997499.html" target="_blank" rel="external"> Pythoné¢å‘å¯¹è±¡ç¼–ç¨‹(äºŒ)</a><br><a href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B" target="_blank" rel="external">é¸­å­ç±»å‹</a></p>
]]></content>
      
        <categories>
            
            <category> Python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Python </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨ Github Pages + Hexo + å¤šè¯´ æ­å»ºåšå®¢å…¨è¿‡ç¨‹ - åŸºç¡€ç¯‡]]></title>
      <url>/2015/11/10/use-Github-Pages-Hexo-duoshuo-to-set-up-a-blog-basic-steps/</url>
      <content type="html"><![CDATA[<p>çœ‹äº†å¾ˆå¤šåšå®¢ï¼Œæœ€åå‘ç°å®˜æ–¹æ–‡æ¡£æ‰æ˜¯æœ€å¯é çš„ï¼è°¨è®°ï¼<br>æœ¬æ–‡åªæ˜¯è‡ªå·±å°è¯•è¿‡ç¨‹çš„è®°å½•ï¼Œå¹¶éå…¨éƒ¨æ­å»ºæ–¹æ³•ã€‚<br>&lt; å‡è®¾ git å·²å®‰è£…ï¼ŒGithub å·²æ³¨å†Œ &gt;</p>
<blockquote>
<p>æ­å»ºç¯å¢ƒï¼š<br>os: Ubuntu 14.04.3 LTS<br>node: 4.2.2<br>hexo: 3.1.1<br>hexo theme: NexT<br>git: 1.9.1</p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="Step-1-å®‰è£…-Node-js"><a href="#Step-1-å®‰è£…-Node-js" class="headerlink" title="Step 1 å®‰è£… Node.js"></a>Step 1 å®‰è£… Node.js</h2><ul>
<li>ä»<a href="https://nodejs.org/en/download/" target="_blank" rel="external">å®˜ç½‘</a>ä¸‹è½½ç³»ç»Ÿå¯¹åº”çš„æºç </li>
<li>ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è§£å‹ç¼–è¯‘å®‰è£…<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar -xzvf node-v4.2.2.tar.gz</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step-2-å®‰è£…-Hexo"><a href="#Step-2-å®‰è£…-Hexo" class="headerlink" title="Step 2 å®‰è£… Hexo"></a>Step 2 å®‰è£… Hexo</h2><ul>
<li>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g hexo</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step-3-æ­å»ºæœ¬åœ°åšå®¢"><a href="#Step-3-æ­å»ºæœ¬åœ°åšå®¢" class="headerlink" title="Step 3 æ­å»ºæœ¬åœ°åšå®¢"></a>Step 3 æ­å»ºæœ¬åœ°åšå®¢</h2><ul>
<li><p>åˆå§‹åŒ–ä¸€æšç›®å½•å­˜æ”¾åšå®¢, è¿›å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo init blog</div><div class="line">cd blog</div></pre></td></tr></table></figure>
</li>
<li><p>æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install</div></pre></td></tr></table></figure>
</li>
</ul>
<p>æ­¤æ—¶ä¸€ä¸ªé»˜è®¤ä¸»é¢˜é»˜è®¤é…ç½®çš„ Hexo åšå®¢å°±æ­å»ºå®Œæˆäº†</p>
<ul>
<li><p>å®‰è£… Hexo å…³äºå¯åŠ¨æœåŠ¡å™¨çš„æ’ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-server --save</div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨æœåŠ¡å™¨, æœ¬åœ°æŸ¥çœ‹æ•ˆæœ, å¦‚æœä¸æŒ‡å®šç«¯å£ï¼Œé»˜è®¤ä¸º4000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo server</div></pre></td></tr></table></figure>
</li>
<li><p>æ‰“å¼€ <a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a> æŸ¥çœ‹æ•ˆæœ</p>
</li>
<li>ä½¿ç”¨ <strong>Ctrl+c</strong> åœæ­¢æœåŠ¡</li>
</ul>
<hr>
<h2 id="Step-4-ä¸»é¢˜å’Œé…ç½®"><a href="#Step-4-ä¸»é¢˜å’Œé…ç½®" class="headerlink" title="Step 4 ä¸»é¢˜å’Œé…ç½®"></a>Step 4 ä¸»é¢˜å’Œé…ç½®</h2><p>åœ¨ <a href="https://hexo.io/themes/" target="_blank" rel="external">https://hexo.io/themes/</a> é€‰æ‹©æŸä¸ªå–œæ¬¢çš„ä¸»é¢˜ï¼Œä»¥ NexT ä¸ºä¾‹ï¼Œå‡è®¾å½“å‰ç›®å½•ä¸º â€œblogâ€ã€‚</p>
<ul>
<li>å‰å¾€<a href="https://github.com/iissnan/hexo-theme-next/releases" target="_blank" rel="external">NexTä¸»é¢˜å‘å¸ƒé¡µé¢</a>ä¸‹è½½ä¸»é¢˜çš„å‹ç¼©åŒ…<br>(è¿™æ˜¯ Next çš„ç¨³å®šç‰ˆæœ¬ï¼Œæˆ‘è¯•ç”¨äº†æœ€æ–°ç‰ˆæœ¬ï¼Œæœ‰ä¸€äº›é—®é¢˜æ•…è½¬ä¸ºç¨³å®šç‰ˆæœ¬)</li>
<li>è§£å‹å¹¶å°†ç›®å½•æ›´åä¸ºnext</li>
<li>å°† next ç§»åŠ¨è‡³ <strong>blog/themes/</strong> ç›®å½•ä¸‹</li>
<li>å°† blog ç›®å½•ä¸‹çš„ <strong>_config.yml</strong> æ–‡ä»¶ä¸­çš„ theme å±æ€§å€¼æ”¹ä¸º next</li>
<li>æ­¤æ—¶ä¸»é¢˜æ›´æ¢æˆåŠŸï¼Œå¯å¯åŠ¨ server éªŒè¯æ•ˆæœ</li>
<li>å¯¹äº _config.yml ä¸­çš„å…¶ä»–å±æ€§å¯æ ¹æ®æƒ…å†µè‡ªè¡Œä¿®æ”¹ï¼ŒåŸºæœ¬çš„æœ‰<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">title: ç½‘ç«™å¤§æ ‡é¢˜</div><div class="line">subtitle: ç½‘ç«™å°æ ‡é¢˜</div><div class="line">description: ä½ å¯¹äºè‡ªå·±çš„æè¿°</div><div class="line">author: æ˜µç§°</div><div class="line">avatar: å¤´åƒ (å¦‚:/images/avatar.jpg, imagesç›®å½•ä½äºsourceç›®å½•ä¸‹)</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step-5-Github-çš„æ“ä½œ"><a href="#Step-5-Github-çš„æ“ä½œ" class="headerlink" title="Step 5 Github çš„æ“ä½œ"></a>Step 5 Github çš„æ“ä½œ</h2><ul>
<li>æ–°å»ºä»“åº“åä¸º <strong>githubç”¨æˆ·å.github.io</strong><br>è¿›å…¥ä»“åº“ï¼Œç‚¹å‡»å³ä¾§ settingsï¼Œåœ¨ Github Pages æ ‡ç­¾ä¸‹å¯çœ‹åˆ°  <em>Your site is published at <a href="http://ä½ çš„ç”¨æˆ·å.github.io" target="_blank" rel="external">http://ä½ çš„ç”¨æˆ·å.github.io</a>.</em> è¿™å¥è¯ã€‚ è¿™æ—¶ä¾¿å¯ç›´æ¥è®¿é—®ï¼Œå¦‚æˆ‘çš„å°±æ˜¯ <a href="http://kiya-z.github.io" target="_blank" rel="external">kiya-z.github.io</a>.</li>
</ul>
<hr>
<h2 id="Step-6-å°†åšå®¢éƒ¨ç½²åˆ°Github"><a href="#Step-6-å°†åšå®¢éƒ¨ç½²åˆ°Github" class="headerlink" title="Step 6 å°†åšå®¢éƒ¨ç½²åˆ°Github"></a>Step 6 å°†åšå®¢éƒ¨ç½²åˆ°Github</h2><ul>
<li><p>å®‰è£… hexo å…³äº git çš„ç»„ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
</li>
<li><p>åœ¨_config.yml ä¸­ä¸º git æ·»åŠ é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">    type: git</div><div class="line">    repository: ä½ çš„ä»“åº“åœ°å€(https://github.com/ç”¨æˆ·å/ç”¨æˆ·å.github.io.git)</div><div class="line">    branch: master</div></pre></td></tr></table></figure>
</li>
<li><p>æ‰§è¡Œ(æ¯æ¬¡ä¿®æ”¹éƒ½è¦æ‰§è¡Œè¿™äº›å‘½ä»¤æ‰èƒ½åœ¨github pagesçœ‹åˆ°æ•ˆæœ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo generate</div><div class="line">hexo deploy</div></pre></td></tr></table></figure>
</li>
</ul>
<p>è¾“å…¥ github çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œéƒ¨ç½²å®Œæˆä¹‹åè®¿é—®ä½ çš„å¦‚ <a href="http://kiya-z.github.io" target="_blank" rel="external">kiya-z.github.io</a> çš„ç½‘å€å³å¯çœ‹åˆ°å’Œæœ¬åœ°ä¸€æ ·çš„æ•ˆæœã€‚</p>
<hr>
<h2 id="Step-7-å…³äºå†™åšå®¢"><a href="#Step-7-å…³äºå†™åšå®¢" class="headerlink" title="Step 7 å…³äºå†™åšå®¢"></a>Step 7 å…³äºå†™åšå®¢</h2><ul>
<li><p>æ–°å»ºåšå®¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new &quot;æ–‡ç« å&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ç¼–è¾‘å™¨å†™å¥½æ–‡ç« åæ‰§è¡Œç”Ÿæˆ+éƒ¨ç½²(é‚£ä¸¤ä¸ªï½)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo generate</div><div class="line">hexo deploy</div></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤æ–‡ç« <br>ç›´æ¥åˆ æ‰ <em>source/_post</em> ä¸‹å¯¹åº”æ–‡ç« çš„æ–‡ä»¶ï¼Œç„¶åé‡æ–°ç”Ÿæˆ+éƒ¨ç½²å³å¯ã€‚æœ‰æ—¶å¯èƒ½è¦å¤šåˆ·æ–°å‡ æ¬¡æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚</p>
</li>
</ul>
<hr>
<h2 id="Step-8-è¯„è®ºç³»ç»Ÿ"><a href="#Step-8-è¯„è®ºç³»ç»Ÿ" class="headerlink" title="Step 8 è¯„è®ºç³»ç»Ÿ"></a>Step 8 è¯„è®ºç³»ç»Ÿ</h2><ul>
<li>ç™»å½• <a href="http://duoshuo.com/" target="_blank" rel="external">http://duoshuo.com/</a> ç‚¹å‡»æˆ‘è¦å®‰è£…ï¼Œåˆ›å»ºç«™ç‚¹ã€‚ç«™ç‚¹åœ°å€æ˜¯ Github Pages çš„åœ°å€ï¼Œå¤šè¯´åŸŸåè‡ªå·±å¡«å†™ã€‚</li>
<li>ç”±äº NexT ä¸»é¢˜å·²ç»æ”¯æŒäº†å¤šè¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ·»åŠ å…¶ä»–ä»£ç ï¼Œåªéœ€è¦åœ¨ <strong>_config.yml</strong> ä¸­æ·»åŠ ä¸€ä¸ªåä¸º <strong>duoshuo_shortname</strong> çš„å­—æ®µï¼Œå…¶å€¼ä¸º<strong>å¤šè¯´åŸŸåä¸­è‡ªå·±å¡«å†™çš„é‚£éƒ¨åˆ†</strong>ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨å¤šè¯´åŸŸåã€‚</li>
</ul>
<hr>
<blockquote>
<p>ç»“è¯­ï¼šæ¬¢è¿æŒ‡æ­£äº¤æµã€‚Ahaï½</p>
</blockquote>
]]></content>
      
        <categories>
            
            <category> Cool </category>
            
        </categories>
        
        
        <tags>
            
            <tag> instruction </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
