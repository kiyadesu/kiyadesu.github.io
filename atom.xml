<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>kiya</title>
  <subtitle>ä¸–ç•Œã¯ä»Šæ—¥ã‚‚å¹³å’Œã§ã™ã­ãƒ¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://kiya.studio/"/>
  <updated>2017-06-21T14:45:42.000Z</updated>
  <id>http://kiya.studio/</id>
  
  <author>
    <name>kiya</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Android é€†å‘æŠ€å·§æ€»ç»“</title>
    <link href="http://kiya.studio/2333/03/03/android-reversing-skills/"/>
    <id>http://kiya.studio/2333/03/03/android-reversing-skills/</id>
    <published>2333-03-02T19:03:03.000Z</published>
    <updated>2017-06-21T14:45:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä»£è¡¨æ€§çš„ crackme ä¸ºä¾‹æ€»ç»“ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼github ä»“åº“<a href="https://github.com/kiya-z/android-reversing-challenges" target="_blank" rel="external">åœ¨æ­¤</a>ã€‚<br><a id="more"></a><br>[TOC]</p>
<h1 id="mobicrackNDK-apk"><a href="#mobicrackNDK-apk" class="headerlink" title="mobicrackNDK.apk"></a><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/mobicrackNDK.apk" target="_blank" rel="external">mobicrackNDK.apk</a></h1><h2 id="JNI-Onload-ä¸­é€šè¿‡-RegisterNatives-åŠ¨æ€æ³¨å†Œ-jni-å‡½æ•°"><a href="#JNI-Onload-ä¸­é€šè¿‡-RegisterNatives-åŠ¨æ€æ³¨å†Œ-jni-å‡½æ•°" class="headerlink" title="JNI_Onload ä¸­é€šè¿‡ RegisterNatives åŠ¨æ€æ³¨å†Œ jni å‡½æ•°"></a>JNI_Onload ä¸­é€šè¿‡ RegisterNatives åŠ¨æ€æ³¨å†Œ jni å‡½æ•°</h2><p><strong>ç›¸å…³å‡½æ•°</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">signed int __fastcall JNI_OnLoad(_JavaVM *a1)</div><div class="line"></div><div class="line">((int (__fastcall *)(_JavaVM *, _JNIEnv **, signed int))v1-&gt;functions-&gt;GetEnv)(v1, &amp;v8, 65540)  </div><div class="line">    /*  v1:JavaVM  v8:JniEnv  65540:jni version */</div><div class="line"></div><div class="line">((int (__fastcall *)(_JNIEnv *, char *))v3-&gt;functions-&gt;FindClass)(v3, v4)   </div><div class="line">    /*  v3:JNIEnv  v4:ç±»å    */</div><div class="line"></div><div class="line">((int (__fastcall *)(_JNIEnv *, int, char **, signed int))v3-&gt;functions-&gt;RegisterNatives)(v3, v5, off_400C, 2)</div><div class="line">    /*  v3:JniEnv  v5:FindClasså¾—åˆ°çš„jclasså¯¹è±¡  off_400C:è¦æ³¨å†Œçš„methods  2:æ³¨å†Œçš„methodsä¸ªæ•°</div><div class="line">        methodçš„æ ¼å¼ä¸ºï¼šå‡½æ•°å å‡½æ•°æè¿°(smaliæ ¼å¼) å‡½æ•°æŒ‡é’ˆ</div><div class="line">        ä¾‹å¦‚(in ida)ï¼š</div><div class="line">            DCD aHello              ; &quot;hello&quot;</div><div class="line">            DCD aLjavaLangStr_1     ; &quot;()Ljava/lang/String;&quot;</div><div class="line">            DCD native_hello+1</div><div class="line">    */</div></pre></td></tr></table></figure>
<h2 id="init-array"><a href="#init-array" class="headerlink" title=".init_array"></a>.init_array</h2><p>æ ¹æ® linker æºç , section çš„æ‰§è¡Œé¡ºåºä¸º <code>.preinit_array</code> -&gt; <code>.init</code> -&gt; <code>.init_array</code> ã€‚ä½† so æ˜¯ä¸ä¼šæ‰§è¡Œ <code>.preinit_array</code> çš„, å¯ä»¥å¿½ç•¥ã€‚</p>
<p><code>.init_array</code> æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ã€‚ç¼–å†™ä»£ç æ—¶åœ¨å‡½æ•°å£°æ˜æ—¶åŠ ä¸Š <code>__attribute__((constructor))</code> ä½¿ä¹‹æˆä¸ºå…±äº«æ„é€ å‡½æ•°ï¼Œå³å¯ä½¿è¯¥å‡½æ•°å‡ºç°åœ¨ <code>.init_array</code> section ä¸­ã€‚</p>
<p>IDA åŠ¨æ€è°ƒè¯•æ—¶ â€˜ctrl+sâ€™ æŸ¥çœ‹ section ä¿¡æ¯å³å¯å®šä½è¿™ä¸¤ä¸ª setctionï¼Œç‰¹åˆ«çš„ï¼Œå¯¹äº <code>.init_array</code>ï¼Œå¯é€šè¿‡æœç´¢ <code>Calling %s @ %p for &#39;%s&#39;</code> å®šä½ã€‚</p>
<p><strong>éƒ¨åˆ†æºç </strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">void soinfo::CallConstructors() &#123;</div><div class="line">    ...</div><div class="line">    // DT_INIT should be called before DT_INIT_ARRAY if both are present.</div><div class="line">    CallFunction(&quot;DT_INIT&quot;, init_func);</div><div class="line">    CallArray(&quot;DT_INIT_ARRAY&quot;, init_array, init_array_count, false);    // CallArray ä¸­ä¹Ÿä¼šè°ƒç”¨ CallFunction å‡½æ•°</div><div class="line">&#125;</div><div class="line"></div><div class="line">void soinfo::CallFunction(const char* function_name UNUSED, linker_function_t function) &#123;</div><div class="line">  if (function == NULL || reinterpret_cast&lt;uintptr_t&gt;(function) == static_cast&lt;uintptr_t&gt;(-1)) &#123;</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  TRACE(&quot;[ Calling %s @ %p for &apos;%s&apos; ]&quot;, function_name, function, name);</div><div class="line">  function();</div><div class="line">  TRACE(&quot;[ Done calling %s @ %p for &apos;%s&apos; ]&quot;, function_name, function, name);</div><div class="line"></div><div class="line">  // The function may have called dlopen(3) or dlclose(3), so we need to ensure our data structures</div><div class="line">  // are still writable. This happens with our debug malloc (see http://b/7941716).</div><div class="line">  set_soinfo_pool_protection(PROT_READ | PROT_WRITE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="misc-apk"><a href="#misc-apk" class="headerlink" title="misc.apk"></a><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/misc.apk" target="_blank" rel="external">misc.apk</a></h1><h2 id="dex-ç»“æ„ï¼ˆä¿®å¤dexï¼‰"><a href="#dex-ç»“æ„ï¼ˆä¿®å¤dexï¼‰" class="headerlink" title="dex ç»“æ„ï¼ˆä¿®å¤dexï¼‰"></a>dex ç»“æ„ï¼ˆä¿®å¤dexï¼‰</h2><p>å¿«é€Ÿç®€è®°ï¼š</p>
<table>
<thead>
<tr>
<th>ç»“æ„</th>
<th>å•ä½ç»“æ„ä½“å å­—èŠ‚</th>
<th>å…±è®¡å­—èŠ‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>DexHeader</td>
<td>-</td>
<td>0x70h</td>
</tr>
<tr>
<td>String Table</td>
<td>4</td>
<td>-</td>
</tr>
<tr>
<td>Type Table</td>
<td>4</td>
<td>-</td>
</tr>
<tr>
<td>Proto Table</td>
<td>12</td>
<td>-</td>
</tr>
<tr>
<td>Field Table</td>
<td>8</td>
<td>-</td>
</tr>
<tr>
<td>Method Table</td>
<td>8</td>
<td>-</td>
</tr>
<tr>
<td>Class Def Table</td>
<td>32</td>
<td>-</td>
</tr>
<tr>
<td>Data Section(å«Map Section)</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="simple-apk"><a href="#simple-apk" class="headerlink" title="simple.apk"></a><a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/simple.apk" target="_blank" rel="external">simple.apk</a></h1><h2 id="hook-ç³»ç»Ÿå‡½æ•°"><a href="#hook-ç³»ç»Ÿå‡½æ•°" class="headerlink" title="hook ç³»ç»Ÿå‡½æ•°"></a>hook ç³»ç»Ÿå‡½æ•°</h2><p>å¸¸è§„æ–¹æ³•é™æ€åˆ†æ</p>
<h2 id="dump-å†…å­˜æœç´¢-flag"><a href="#dump-å†…å­˜æœç´¢-flag" class="headerlink" title="dump å†…å­˜æœç´¢ flag"></a>dump å†…å­˜æœç´¢ flag</h2><h3 id="1-åˆ©ç”¨-ddms-çš„-dump-HPROF-file-åŠŸèƒ½-å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡"><a href="#1-åˆ©ç”¨-ddms-çš„-dump-HPROF-file-åŠŸèƒ½-å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡" class="headerlink" title="1. åˆ©ç”¨ ddms çš„ dump HPROF file åŠŸèƒ½ (å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡)"></a>1. åˆ©ç”¨ ddms çš„ <code>dump HPROF file</code> åŠŸèƒ½ (å¸¦ç®­å¤´çš„æ²¹æ¡¶å›¾æ ‡)</h3><p>æœç´¢ï¼š<code>strings easyre.sjl.gossip.easyre.hprof | grep 0ctf</code></p>
<h3 id="2-åˆ©ç”¨-gore"><a href="#2-åˆ©ç”¨-gore" class="headerlink" title="2. åˆ©ç”¨ gore"></a>2. åˆ©ç”¨ gore</h3><p>gdb é™„åŠ è¿›ç¨‹åç›´æ¥æ‰§è¡Œ <code>gcore</code> dumpï¼Œæœç´¢ï¼š<code>strings core.7967 | grep 0ctf</code></p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://github.com/toToCW/CTF-Mobile" target="_blank" rel="external">CTF-Mobile</a></p>
<p><a href="https://github.com/ctfs/write-ups-2015" target="_blank" rel="external">write-ups-2015</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥ä»£è¡¨æ€§çš„ crackme ä¸ºä¾‹æ€»ç»“ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼github ä»“åº“&lt;a href=&quot;https://github.com/kiya-z/android-reversing-challenges&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;åœ¨æ­¤&lt;/a&gt;ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="reversing" scheme="http://kiya.studio/tags/reversing/"/>
    
      <category term="CTF" scheme="http://kiya.studio/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>gdb è°ƒè¯• Android app</title>
    <link href="http://kiya.studio/2017/06/21/android-gdb/"/>
    <id>http://kiya.studio/2017/06/21/android-gdb/</id>
    <published>2017-06-21T05:38:46.000Z</published>
    <updated>2017-06-21T13:49:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>Android NDK åœ¨ r11 ä¹‹åå»æ‰äº† toolchain ä¸­çš„ gdb å·¥å…·ï¼Œæ— å¥ˆä¸‹è½½äº† r10 çš„ arm-linux-androideabi-gdb å’Œ gdbserverã€‚<a id="more"></a></p>
<p>æŠŠ  arm-linux-androideabi-gdb æ”¾åœ¨ ndk çš„ <code>toolchains/arm-linux-androideabi-4.9/prebuilt/*platform*-x86_64/bin</code> ç›®å½•ä¸‹ï¼ŒæŠŠ <code>gdbserver</code> push åˆ°æ‰‹æœºçš„ <code>system/bin</code> ä¸‹å¹¶æ·»åŠ æ‰§è¡Œæƒé™ã€‚</p>
<blockquote>
<p>æœ¬æ¬¡æµ‹è¯•ç”¨ crackme æ¥è‡ª 0CTF 2015 Quals : <a href="https://github.com/kiya-z/android-reversing-challenges/tree/master/apks/simple.apk" target="_blank" rel="external">simple.apk</a></p>
</blockquote>
<p>åœ¨æ‰‹æœºä¸Šæ‰“å¼€ app å¹¶æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ps | grep easy</div><div class="line">gdbserver :1234 --attach 7967   // 1234 ä¸ºç«¯å£ï¼Œå¯éšæ„æŒ‡å®šï¼›7967ä½ pidã€‚</div></pre></td></tr></table></figure>
<p>åœ¨ç”µè„‘ç«¯æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">adb forward tcp:1234 tcp:1234</div><div class="line">arm-linux-androideabi-gdb</div><div class="line">(gdb) target remote :1234</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶è°ƒè¯•ç®—æ˜¯å·²ç»å¼€å§‹äº†ã€‚</p>
<p><strong>æ‰©å±•</strong>ï¼š</p>
<p>ä¸ºäº†æ‰¾åˆ°è¯¥ crackme çš„ flagï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç€æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(gdb) gcore</div></pre></td></tr></table></figure>
<p>ç­‰ gore dump å‡ºå†…å­˜åï¼Œåœ¨ç”µè„‘ç«¯çš„å½“å‰ç›®å½•ä¸‹ä½¿ç”¨<code>strings</code>å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">strings core.7967 | grep 0CTF</div></pre></td></tr></table></figure>
<p>å³å¯å¾—åˆ° flag ï¼Œçœå»äº†é™æ€åˆ†æå’ŒåŠ¨æ€è°ƒè¯•çš„ç¹çã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Android NDK åœ¨ r11 ä¹‹åå»æ‰äº† toolchain ä¸­çš„ gdb å·¥å…·ï¼Œæ— å¥ˆä¸‹è½½äº† r10 çš„ arm-linux-androideabi-gdb å’Œ gdbserverã€‚
    
    </summary>
    
    
      <category term="debug" scheme="http://kiya.studio/tags/debug/"/>
    
  </entry>
  
  <entry>
    <title>ç¿»è¯‘ - å¤šç§ç‰¹å¾æ£€æµ‹ Frida</title>
    <link href="http://kiya.studio/2017/05/08/detect-frida/"/>
    <id>http://kiya.studio/2017/05/08/detect-frida/</id>
    <published>2017-05-08T09:10:02.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>Frida åœ¨é€†å‘å·¥ç¨‹ç‹®ä¸­å¾ˆå—æ¬¢è¿ï¼Œä½ åŸºæœ¬å¯ä»¥åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°ä½ èƒ½æƒ³åˆ°çš„ä»»ä½•ä¸œè¥¿ï¼Œå†…å­˜åœ°å€ã€native å‡½æ•°ã€Java å®ä¾‹å¯¹è±¡ç­‰ã€‚åœ¨ OWASP çš„ç§»åŠ¨æµ‹è¯•æŒ‡å—é‡Œå°±æåˆ°äº† Fridaã€‚<a id="more"></a>ä½†æ˜¯å•Šï¼Œæ¯å‡ºæ¥ä¸ªå¥½ç”¨çš„æ³¨å…¥å·¥å…·ï¼Œéƒ½ä¼šæœ‰åæ³¨å…¥ã€ååæ³¨å…¥ã€åååæ³¨å…¥ã€åâ€¦æ³¨å…¥ã€‚è¿™ç¯‡æ–‡ç« è¦ä»‹ç»çš„æ˜¯ Android APP æ£€æµ‹ Frida çš„æ–¹æ³•ã€‚</p>
<h2 id="æ£€æŸ¥-Frida-çš„ç—•è¿¹"><a href="#æ£€æŸ¥-Frida-çš„ç—•è¿¹" class="headerlink" title="æ£€æŸ¥ Frida çš„ç—•è¿¹"></a>æ£€æŸ¥ Frida çš„ç—•è¿¹</h2><p>ä¸€ç§ç®€æ˜“æ–¹æ³•æ˜¯æ£€æµ‹ Frida çš„è¿è¡Œç—•è¿¹ï¼Œä¹Ÿé€‚ç”¨äºåŒç±»å·¥å…·çš„æ£€æµ‹ï¼Œæ¯”å¦‚åŒ…æ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€åº“æ–‡ä»¶ã€è¿›ç¨‹ã€ä¸´æ—¶æ–‡ä»¶ç­‰ç­‰ã€‚æœ¬ä¾‹ä¸­é’ˆå¯¹çš„å¯¹è±¡æ˜¯ fridaserverï¼Œå®ƒé€šè¿‡ TCP å¯¹å¤–ä¸ frida é€šä¿¡ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ Java éå†è¿è¡Œçš„è¿›ç¨‹åˆ—è¡¨ä»è€Œæ£€æŸ¥ fridaserver æ˜¯å¦åœ¨è¿è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public boolean checkRunningProcesses() &#123;</div><div class="line"></div><div class="line">  boolean returnValue = false;</div><div class="line"></div><div class="line">  // Get currently running application processes</div><div class="line">  List&lt;RunningServiceInfo&gt; list = manager.getRunningServices(300);</div><div class="line"></div><div class="line">  if(list != null)&#123;</div><div class="line">    String tempName;</div><div class="line">    for(int i=0;i&lt;list.size();++i)&#123;</div><div class="line">      tempName = list.get(i).process;</div><div class="line"></div><div class="line">      if(tempName.contains(&quot;fridaserver&quot;)) &#123;</div><div class="line">        returnValue = true;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‹¥ Frida è¿è¡Œåœ¨é»˜è®¤é…ç½®æ—¶æ­¤æ³•æœ‰æ•ˆï¼Œè‹¥æ˜¯é‡åˆ°ä¸ªç¬¨æ‹™çš„è„šæœ¬å°å­ï¼Œåœ¨ç¬¬ä¸€æ­¥å°±èƒ½ç»Šå€’ä»–ã€‚ç»•è¿‡ä¹Ÿæ˜¯ç›¸å½“ç®€å•ï¼Œåªéœ€é‡å‘½å fridaserverï¼Œæˆ‘ä»¬å¾—æ‰¾ä¸ªæ›´å¥½çš„æ–¹æ³•ã€‚</p>
<p>fridaserver é»˜è®¤çš„ TCP ç«¯å£æ˜¯ 27047ï¼Œå¯ä»¥æ£€æŸ¥è¿™ä¸ªç«¯å£æ˜¯å¦å¼€æ”¾ã€‚native ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">boolean is_frida_server_listening() &#123;</div><div class="line">    struct sockaddr_in sa;</div><div class="line"></div><div class="line">    memset(&amp;sa, 0, sizeof(sa));</div><div class="line">    sa.sin_family = AF_INET;</div><div class="line">    sa.sin_port = htons(27047);</div><div class="line">    inet_aton(&quot;127.0.0.1&quot;, &amp;(sa.sin_addr));</div><div class="line"></div><div class="line">    int sock = socket(AF_INET , SOCK_STREAM , 0);</div><div class="line"></div><div class="line">    if (connect(sock , (struct sockaddr*)&amp;sa , sizeof sa) != -1) &#123;</div><div class="line">      /* Frida server detected. Do somethingâ€¦ */</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒæ ·ï¼Œè¿™ä¹Ÿå¾—è¦æ±‚ fridaserver æ˜¯é»˜è®¤é…ç½®è¿è¡Œï¼Œå‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°å°±å¯ä»¥æ”¹å˜å®ƒçš„ç›‘å¬ç«¯å£ï¼Œç»•è¿‡ä¹Ÿå¤ªä¸éº»çƒ¦äº†ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥ç”¨â€™ nmap -sVâ€™ æ‰¾åˆ°å¼€æ”¾ç«¯å£æ¥æ”¹å–„è¿™ä¸ªæ–¹æ³•ã€‚å› ä¸º fridaserver ä½¿ç”¨ D-Bus åè®®é€šä¿¡ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªå¼€æ”¾çš„ç«¯å£å‘é€ D-Bus çš„è®¤è¯æ¶ˆæ¯ï¼Œå“ªä¸ªç«¯å£å›å¤äº†å“ªä¸ªå°±æ˜¯ fridaserverã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Mini-portscan to detect frida-server on any local port.</div><div class="line"> */</div><div class="line"></div><div class="line">for(i = 0 ; i &lt;= 65535 ; i++) &#123;</div><div class="line"></div><div class="line">    sock = socket(AF_INET , SOCK_STREAM , 0);</div><div class="line">    sa.sin_port = htons(i);</div><div class="line"></div><div class="line">    if (connect(sock , (struct sockaddr*)&amp;sa , sizeof sa) != -1) &#123;</div><div class="line"></div><div class="line">        __android_log_print(ANDROID_LOG_VERBOSE, APPNAME,  &quot;FRIDA DETECTION [1]: Open Port: %d&quot;, i);</div><div class="line"></div><div class="line">        memset(res, 0 , 7);</div><div class="line"></div><div class="line">        // send a D-Bus AUTH message. Expected answer is â€œREJECT&quot;</div><div class="line"></div><div class="line">        send(sock, &quot;\x00&quot;, 1, NULL);</div><div class="line">        send(sock, &quot;AUTH\r\n&quot;, 6, NULL);</div><div class="line"></div><div class="line">        usleep(100);</div><div class="line"></div><div class="line">        if (ret = recv(sock, res, 6, MSG_DONTWAIT) != -1) &#123;</div><div class="line"></div><div class="line">            if (strcmp(res, &quot;REJECT&quot;) == 0) &#123;</div><div class="line">               /* Frida server detected. Do somethingâ€¦ */</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    close(sock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç°åœ¨å¥½åƒæœ‰äº†ä¸ªéå¸¸å¥½ç”¨çš„æ–¹æ³•äº†å‘¢ï¼Œä½†æ˜¯è¿˜å­˜åœ¨é—®é¢˜ã€‚Frida æä¾›ä¸éœ€è¦ fridaserver è¿è¡Œçš„æ¨¡å¼ï¼æ€ä¹ˆæ£€æµ‹ï¼Ÿï¼</p>
<p>Frida çš„å„ä¸ªæ¨¡å¼éƒ½æ˜¯ç”¨æ¥æ³¨å…¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ç‚¹å°±æ˜¯ frida è¿è¡Œæ—¶æ˜ å°„åˆ°å†…å­˜çš„åº“ã€‚æœ€ç›´æ¥çš„æ˜¯æŒ¨ä¸ªæ£€æŸ¥åŠ è½½çš„åº“ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">char line[512];</div><div class="line">FILE* fp;</div><div class="line"></div><div class="line">fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);</div><div class="line"></div><div class="line">if (fp) &#123;</div><div class="line">    while (fgets(line, 512, fp)) &#123;</div><div class="line">        if (strstr(line, &quot;frida&quot;)) &#123;</div><div class="line">            /* Evil library is loaded. Do somethingâ€¦ */</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fclose(fp);</div><div class="line"></div><div class="line">    &#125; else &#123;</div><div class="line">       /* Error opening /proc/self/maps. If this happens, something is off. */</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ£€æµ‹åå­—å«æœ‰â€œfridaâ€çš„åº“ï¼Œè¡¨æ˜ä¸Šæœ‰ç”¨ï¼Œå®é™…ä¸Šï¼š</p>
<ul>
<li><p>è¿˜è®°å¾—ä¸ºä»€ä¹ˆæ£€æµ‹åå­—æ˜¯â€œfridaserverâ€çš„æ–¹æ³•ä¸ºä»€ä¹ˆä¸å¯é å§ï¼Ÿè¿™é‡Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œç¨å¾®æ”¹ä¸€ä¸‹ frida å°±èƒ½é‡å‘½åä»£ç†åº“åã€‚</p>
</li>
<li><p>è¿™æ®µä»£ç ä¾èµ–çš„æ˜¯æ ‡å‡†åº“çš„<code>fopen()</code>å’Œ<code>strstr()</code>å‡½æ•°ï¼Œå¯ç¬‘çš„æ˜¯ï¼Œæˆ‘ä»¬ç«Ÿæƒ³ç”¨èƒ½è¢« frida è½»è€Œæ˜“ä¸¾å°± hook çš„å‡½æ•°æ¥æ£€æµ‹ frida ï¼</p>
</li>
</ul>
<p>é—®é¢˜1å¯ä»¥ç”¨ç»å…¸çš„ç—…æ¯’æ‰«ææ³•è§£å†³ï¼Œåœ¨å†…å­˜ä¸­æ‰«æ frida çš„åº“ç‰¹å¾ â€œgadgetsâ€ã€‚æˆ‘é€‰æ‹©å­—ç¬¦ä¸² â€œLIBFRIDAâ€ï¼Œå®ƒåœ¨æ‰€æœ‰ frida-gadget å’Œ frida-agent çš„ç‰ˆæœ¬ä¸­éƒ½æœ‰å‡ºç°ã€‚ä¸‹é¢çš„ä»£ç æ‰«æäº†åœ¨ <code>/proc/sel/maps</code> é‡Œæ‰¾åˆ°çš„æ‰€æœ‰çš„å¯æ‰§è¡Œæ®µï¼Œä¸ºäº†ç®€æ´æˆ‘æ”¾äº†éƒ¨åˆ†ä»£ç ï¼Œå®Œæ•´çš„åœ¨ <a href="https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/native-lib.cpp" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/native-lib.cpp</a> ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static char keyword[] = &quot;LIBFRIDA&quot;;</div><div class="line">num_found = 0;</div><div class="line"></div><div class="line">int scan_executable_segments(char * map) &#123;</div><div class="line">    char buf[512];</div><div class="line">    unsigned long start, end;</div><div class="line"></div><div class="line">    sscanf(map, &quot;%lx-%lx %s&quot;, &amp;start, &amp;end, buf);</div><div class="line"></div><div class="line">    if (buf[2] == &apos;x&apos;) &#123;</div><div class="line">        return (find_mem_string(start, end, (char*)keyword, 8) == 1);</div><div class="line">    &#125; else &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void scan() &#123;</div><div class="line"></div><div class="line">    if ((fd = my_openat(AT_FDCWD, &quot;/proc/self/maps&quot;, O_RDONLY, 0)) &gt;= 0) &#123;</div><div class="line"></div><div class="line">    while ((read_one_line(fd, map, MAX_LINE)) &gt; 0) &#123;</div><div class="line">        if (scan_executable_segments(map) == 1) &#123;</div><div class="line">            num_found++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (num_found &gt; 1) &#123;</div><div class="line"></div><div class="line">        /* Frida Detected */</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ <code>my_openat()</code> ç­‰å‡½æ•°ï¼Œå®ƒä»¬å¹¶éå¹³å¸¸çš„ libc åº“å‡½æ•°ï¼Œæ˜¯è‡ªå®šä¹‰å®ç°çš„ï¼Œä½†æ˜¯åŠŸèƒ½å’Œ libc ä¸­çš„ä¸€æ ·ï¼Œè®¾ç½®äº†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œæ‰§è¡Œäº†è½¯ä¸­æ–­ã€‚å› ä¸ºç›´æ¥è°ƒç”¨å…¬å…± API å¹¶ä¸å¯é ï¼Œè¿™æ ·ä¸å®¹æ˜“è¢« hookã€‚å®Œæ•´çš„å®ç°åœ¨ <a href="https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/syscall.S" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/syscall.S</a> ã€‚ä¸‹é¢æ˜¯ my_openat çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#include &quot;bionic_asm.h&quot;</div><div class="line"></div><div class="line">.text</div><div class="line">    .globl my_openat</div><div class="line">    .type my_openat,function</div><div class="line">my_openat:</div><div class="line">    .cfi_startproc</div><div class="line">    mov ip, r7</div><div class="line">    .cfi_register r7, ip</div><div class="line">    ldr r7, =__NR_openat</div><div class="line">    swi #0</div><div class="line">    mov r7, ip</div><div class="line">    .cfi_restore r7</div><div class="line">    cmn r0, #(4095 + 1)</div><div class="line">    bxls lr</div><div class="line">    neg r0, r0</div><div class="line">    b __set_errno_internal</div><div class="line">    .cfi_endproc</div><div class="line"></div><div class="line">    .size my_openat, .-my_openat;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œæ€»ç®—æ˜¯æœ‰æ•ˆçš„æ–¹æ³•äº†ï¼Œåªç”¨ frida çš„è¯ä¹Ÿä¸å®¹æ˜“ç»•è¿‡ï¼ŒåŠ äº†æ··æ·†æ›´éš¾ã€‚å³ä½¿è¿™æ ·ï¼Œä¾ç„¶æœ‰å¾ˆå¤šåŠæ³•å¯ä»¥ç»•è¿‡ï¼Œç›´æ¥èƒ½æƒ³åˆ°çš„å°±æ˜¯æ‰“è¡¥ä¸ã€hook ç³»ç»Ÿè°ƒç”¨ã€‚ä½†æ˜¯è®°ä½ï¼Œé€†å‘å·¥ç¨‹æ°¸è¿œèƒœåˆ©ï¼</p>
<p>æƒ³è¦è¯•éªŒï¼Œå¯ä»¥åœ¨è¿™é‡Œ <a href="https://github.com/b-mueller/frida-detection-demo/" target="_blank" rel="external">https://github.com/b-mueller/frida-detection-demo/</a> ä¸‹è½½ Android studio å·¥ç¨‹ã€‚frida æ³¨å…¥æ—¶çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://vp-web.s3.amazonaws.com/uploads/ckeditor/pictures/73/content_fridadetection.jpg" alt=""></p>
<hr>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="http://www.vantagepoint.sg/blog/90-the-jiu-jitsu-of-detecting-frida" target="_blank" rel="external">http://www.vantagepoint.sg/blog/90-the-jiu-jitsu-of-detecting-frida</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-217482.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Frida åœ¨é€†å‘å·¥ç¨‹ç‹®ä¸­å¾ˆå—æ¬¢è¿ï¼Œä½ åŸºæœ¬å¯ä»¥åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°ä½ èƒ½æƒ³åˆ°çš„ä»»ä½•ä¸œè¥¿ï¼Œå†…å­˜åœ°å€ã€native å‡½æ•°ã€Java å®ä¾‹å¯¹è±¡ç­‰ã€‚åœ¨ OWASP çš„ç§»åŠ¨æµ‹è¯•æŒ‡å—é‡Œå°±æåˆ°äº† Fridaã€‚
    
    </summary>
    
    
      <category term="translation" scheme="http://kiya.studio/tags/translation/"/>
    
  </entry>
  
  <entry>
    <title>ç¿»è¯‘ - ç”¨ VirtualBox è°ƒè¯• macOS å†…æ ¸</title>
    <link href="http://kiya.studio/2017/04/14/debug-macos-kernel/"/>
    <id>http://kiya.studio/2017/04/14/debug-macos-kernel/</id>
    <published>2017-04-14T06:57:51.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é‡å¤§æ›´æ–°</strong>ï¼šawalton åœ¨ Hacker News ä¸Šçš„è®¨è®ºä¸­æåˆ°ï¼šVMWare é‡Œå¯ä»¥è®¾ç½® CPUID æ ‡å¿—æ¥ç¦ç”¨ SMAPï¼Œåªéœ€è¦åœ¨ vmx æ–‡ä»¶ä¸­åŠ ä¸Šcpuid.7.ebx = â€œâ€”â€”â€”â€“0â€”â€”â€”â€”â€”â€”â€“â€.<a id="more"></a></p>
<hr>
<p>ä¸Šå¹´ï¼Œæˆ‘ç»™æˆ‘çš„è€ MBP å‡çº§äº†2016å¹´çš„ Skylake Intel å¤„ç†å™¨ã€‚æˆ‘åœ¨è°ƒè¯•ä¸€ä¸ªå†…æ ¸æ¼æ´æ—¶ï¼Œå‘ç°æˆ‘çš„ VMWare å¼€å¯äº†â€œSMAPâ€(é˜²æ­¢è¶…çº§ç”¨æˆ·è®¿é—®)æœºåˆ¶ã€‚æˆ‘æ‰¾ä¸åˆ°æ€ä¹ˆå…³é—­ SMAPï¼Œè¿˜å¥½ VirtualBox ç›®å‰å¥½åƒä¸æ”¯æŒ SMAPï¼Ÿ</p>
<p>è¿™ç¯‡æ–‡ç« ä¼šæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•ç”¨ VirtualBox è¿›è¡Œ macOS å†…æ ¸çš„æºç çº§è°ƒè¯•ã€‚è™½ç„¶è¿™äº›æ­¥éª¤éƒ½æ˜¯åœ¨ VirtualBoxä¸Šè¿›è¡Œçš„ï¼Œä½†åœ¨ VMWare ä¸Šä¹Ÿæ˜¯é€šç”¨çš„ï¼Œç”šè‡³æ›´ç®€å•ã€‚</p>
<h1 id="å®‰è£…-VirtualBox-å’Œ-Sierra"><a href="#å®‰è£…-VirtualBox-å’Œ-Sierra" class="headerlink" title="å®‰è£… VirtualBox å’Œ Sierra"></a>å®‰è£… VirtualBox å’Œ Sierra</h1><p>å¦‚æœä½ è¿˜æ²¡åœ¨ VirtualBox ä¸Šå®‰è£… macOS é•œåƒï¼Œä½ å¯ä»¥å¤ç”¨ VMWare çš„ vmdkï¼Œä¹Ÿå¯ä»¥è£…ä¸ªæ–°çš„ã€‚é‡æ–°å®‰è£…ç³»ç»Ÿéœ€è¦ ISO é•œåƒï¼Œä¸‹é¢çš„å‘½ä»¤å¯ä»¥å°†ä»<a href="https://itunes.apple.com/us/app/macos-sierra/id1127487414?ls=1&amp;mt=12" target="_blank" rel="external">Mac app store</a>ä¸‹è½½çš„ Sierra è½¬æˆ ISOã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ hdiutil attach /Applications/Install\ macOS\ Sierra.app/Contents/SharedSupport/InstallESD.dmg -noverify -nobrowse -mountpoint /Volumes/installesd</div><div class="line">$ hdiutil create -o /tmp/Sierra -size 8g -type SPARSE -layout SPUD -fs HFS+J</div><div class="line">$ hdiutil attach /tmp/Sierra.sparseimage -noverify -nobrowse -mountpoint /Volumes/install</div><div class="line">$ asr restore -source /Volumes/installesd/BaseSystem.dmg -target /Volumes/install -noprompt -noverify -erase</div><div class="line">$ rm /Volumes/OS\ X\ Base\ System/System/Installation/Packages</div><div class="line">$ cp -rp /Volumes/installesd/Packages /Volumes/OS\ X\ Base\ System/System/Installation/</div><div class="line">$ cp -rp /Volumes/installesd/BaseSystem.dmg /Volumes/OS\ X\ Base\ System/BaseSystem.dmg</div><div class="line">$ cp -rp /Volumes/installesd/BaseSystem.chunklist /Volumes/OS\ X\ Base\ System/BaseSystem.chunklist</div><div class="line">$ hdiutil detach /Volumes/installesd</div><div class="line">$ hdiutil detach /Volumes/OS\ X\ Base\ System/</div><div class="line">$ hdiutil resize -sectors min /tmp/Sierra.sparseimage</div><div class="line">$ hdiutil convert /tmp/Sierra.sparseimage -format UDTO -o /tmp/Sierra</div><div class="line">$ rm /tmp/Sierra.sparseimage</div><div class="line">$ mv /tmp/Sierra.cdr /tmp/Sierra.iso</div></pre></td></tr></table></figure>
<h2 id="ç½‘ç»œè®¾ç½®"><a href="#ç½‘ç»œè®¾ç½®" class="headerlink" title="ç½‘ç»œè®¾ç½®"></a>ç½‘ç»œè®¾ç½®</h2><p>å¦‚æœä½ ç”¨äº†æ¡¥æ¥ï¼Œå¯ä»¥è·³è¿‡è¿™éƒ¨åˆ†ã€‚</p>
<p>å¦‚æœç”¨çš„æ˜¯ NATï¼Œéœ€è¦ä¸º KDP å¼€å¯ç«¯å£è½¬å‘ã€‚ç‚¹å‡»â€œç½‘ç»œâ€ï¼Œé€‰æ‹©â€œé«˜çº§â€ -&gt; â€œç«¯å£è½¬å‘â€ï¼Œå°† localhost 41139/UDP è½¬å‘åˆ°è™šæ‹Ÿæœºçš„ 41139/UDPï¼Œå°±èƒ½å¤Ÿè®¿é—®åˆ°è™šæ‹Ÿæœºçš„ 41139 ç«¯å£äº†ã€‚</p>
<h1 id="å®‰è£…-XCode"><a href="#å®‰è£…-XCode" class="headerlink" title="å®‰è£… XCode"></a>å®‰è£… XCode</h1><p>åœ¨ä½ çš„ä¸»æœºä¸Šå®‰è£… XCodeï¼Œé€šè¿‡ App store å®‰è£…æœ€ç®€å•ã€‚ å¯ä»¥ç›´æ¥æ‰“å¼€ XCodeï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œ <code>sudo xcodebuild -license accept</code> æ¥å— XCode licenseã€‚</p>
<h1 id="å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶-KDK"><a href="#å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶-KDK" class="headerlink" title="å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶(KDK)"></a>å®‰è£…å†…æ ¸è°ƒè¯•ç»„ä»¶(KDK)</h1><p>æ ¹æ®æˆ‘ä»¬è¦è°ƒè¯•çš„ macOS ç‰ˆæœ¬ä» Apple å¼€å‘è€…ä¸­å¿ƒå®‰è£… KDK ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯10.12 build 16A323.</p>
<p>KDK çš„å®‰è£…ç›®å½•æ˜¯<code>/Library/Developer/KDKs</code>ï¼Œæä¾›çš„å†…æ ¸ç‰ˆæœ¬ã€ç¬¦å·ã€å†…æ ¸æ‰©å±•éƒ½æœ‰ RELEASEã€DEVELOPMENTã€DEBUG ä¸‰ç§ç‰ˆæœ¬ã€‚ä¸åŒä¹‹å¤„åœ¨äº DEVELOPMENT å’Œ DEBUG ç‰ˆæ¯” RELEASE ç‰ˆå¤šäº†äº›æ–­è¨€å’Œé”™è¯¯æ£€æŸ¥ï¼ŒDEBUG ç‰ˆçš„æœ€ä¸°å¯Œã€‚</p>
<p>æ³¨æ„ï¼šè¢«è°ƒè¯•çš„ç³»ç»Ÿä¸éœ€è¦å®‰è£… KDKã€‚</p>
<h1 id="ä¿®æ”¹-nvram-boot-args"><a href="#ä¿®æ”¹-nvram-boot-args" class="headerlink" title="ä¿®æ”¹ nvram boot-args"></a>ä¿®æ”¹ nvram boot-args</h1><p>ä¸ºäº†èƒ½å¤Ÿè°ƒè¯•è™šæ‹Ÿæœºï¼Œéœ€è¦è®¾ç½®è™šæ‹Ÿæœºä¸Š nvram ä¸­çš„ debug é¡¹ã€‚é™¤äº† debug çš„å€¼å¤–å…¶ä»–å€¼ä¹Ÿèƒ½è¢«æˆ‘ä»¬æ‰€ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€äº›å› å‚æ–¯æŒºçš„é€‰é¡¹ï¼š</p>
<ul>
<li>-vï¼šä»¥ verbose æ¨¡å¼å¯åŠ¨ç³»ç»Ÿã€‚</li>
<li>kcsuffixï¼šå¡«å†™åç¼€ä»¥æŒ‡å®šå¯åŠ¨çš„å†…æ ¸ã€‚</li>
<li>pmuflagsï¼šè²Œä¼¼å¤§å®¶éƒ½æ¨èæŠŠè¿™é¡¹å€¼è®¾ä¸º1ã€‚ç„¶è€Œ Appleâ€™s Kernel Programming Guide å·²ç»æ˜ç¡®æŒ‡å‡ºç®¡ç†ç”µæºçš„çœ‹é—¨ç‹—å®šæ—¶å™¨â€œåªåœ¨å°å¼æœºã€ç¬”è®°æœ¬çš„ G4 ç‰ˆæœ¬å’Œå°å¼æœºçš„ G5 ç‰ˆæœ¬åŠä¹‹å‰æœ‰ä½œç”¨â€ï¼Œå…¶ä»–çš„çœ‹é—¨ç‹—å®šæ—¶å™¨â€œåªåœ¨ OS X Server ä¸­å¯ç”¨â€ã€‚æ‰€ä»¥ï¼Œè™½ç„¶è®¾ç½®äº†ä¹Ÿä¸å½±å“ï¼Œä½†è¿™ä¸ªé€‰é¡¹çœŸæ²¡ä»€ä¹ˆåµç”¨ã€‚</li>
<li>debugï¼šå…è®¸è¿œç¨‹å†…æ ¸è°ƒè¯•ã€‚ Apple docs é‡Œæœ‰åˆ—å‡ºå¯ç”¨çš„æ ‡å¿—ã€‚æˆ‘å¸¸ç”¨çš„æ˜¯<code>DB_LOG_PI_SCRN | DB_ARP | DB_NMI</code>ã€‚å¦å¤–ï¼Œ<code>control + option + command + shift + escape</code> å¯ä»¥è§¦å‘ä¸å¯å±è”½ä¸­æ–­ï¼ˆNMIï¼‰ï¼Œç»§è€Œå¼•å‘è°ƒè¯•å™¨ä¸­æ–­ï¼Œè¶…çº§æ–¹ä¾¿ã€‚è¿™å¯¹ç»„åˆé”®è·Ÿ host key çš„ç»„åˆé”®å†²çªçš„æ—¶å€™ç”¨èµ·æ¥å¾ˆéš¾å—ï¼Œæ‰€ä»¥æˆ‘æŠŠ host key é‡æ–°ç»‘å®šæˆ<code>command + right</code>äº†ã€‚</li>
</ul>
<h2 id="ä¿®æ”¹-nvram"><a href="#ä¿®æ”¹-nvram" class="headerlink" title="ä¿®æ”¹ nvram"></a>ä¿®æ”¹ nvram</h2><p>åœ¨ VMware é‡Œï¼Œå¯ç”¨è¿™æ ·ä¿®æ”¹ nvramï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo nvram boot-args=&quot;-v debug=0x144&quot;</div></pre></td></tr></table></figure></p>
<p>åœ¨ virtualbox é‡Œæ²¡é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºä¸€é‡å¯ä¿®æ”¹çš„å€¼å°±æ²¡äº†ã€‚è¿˜å¥½ä» virtualbox æ‰‹å†Œçš„ 3.13.2 çœ‹åˆ°äº†å¸Œæœ›ï¼š</p>
<blockquote>
<p>ä¸èƒ½åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºå†…éƒ¨æ“ä½œ EFI å˜é‡äº†ï¼ˆå¦‚ï¼šåœ¨Mac OS X è™šæ‹Ÿæœºé‡Œè¿è¡Œ nvram æ¥è®¾ç½®â€œboot-argsâ€ä¸ç®¡ç”¨äº†ï¼‰ã€‚ä¸è¿‡ï¼Œå¯ä»¥é€šè¿‡ç»™è™šæ‹Ÿæœºå‘é€é™„åŠ æ•°æ®â€VBoxInternal2/EfiBootArgsâ€ æ¥è®¾ç½®â€œboot-argsâ€ã€‚â€¦</p>
</blockquote>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­è™šæ‹Ÿæœºï¼Œåœ¨ä¸»æœºä¸Šè¿è¡Œå‘½ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ VBoxManage list vms # åˆ—å‡ºä¸‹æ¡å‘½ä»¤ä½¿ç”¨çš„ UUID</div><div class="line">&quot;macOS 10.12.0&quot; &#123;9ad936f8-9360-44a6-ba3e-c4d92b4243e8&#125;</div><div class="line">$ VBoxManage setextradata 9ad936f8-9360-44a6-ba3e-c4d92b4243e8 VBoxInternal2/EfiBootArgs &quot;-v debug=0x144&quot;</div></pre></td></tr></table></figure></p>
<h1 id="äº¤æ¢å†…æ ¸"><a href="#äº¤æ¢å†…æ ¸" class="headerlink" title="äº¤æ¢å†…æ ¸"></a>äº¤æ¢å†…æ ¸</h1><p>å‰é¢æˆ‘æåˆ°å¯ä»¥æŒ‡å®š<code>kcsuffix</code>é€‰é¡¹ä»¥è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ã€‚å†…æ ¸æ–‡ä»¶åœ¨è™šæ‹Ÿæœºçš„<code>/System/Library/Kernels</code>ç›®å½•ï¼Œç„¶è€Œè¿™ä¸ªç›®å½•å—â€œç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤â€æœºåˆ¶ä¿æŠ¤ï¼ˆSIPï¼‰ã€‚æ‰€ä»¥è¦æƒ³ä½¿ç”¨ KDK æˆ–è€…è‡ªå·±ç¼–è¯‘çš„å†…æ ¸ï¼Œå¿…é¡»å¯åŠ¨è¿›å…¥ recoveryï¼ŒæŠŠç›®æ ‡å†…æ ¸æ‹·è¿›<code>/System/Library/Kernels</code>ç›®å½•ï¼Œä½¿ kextcache å¤±æ•ˆï¼Œç„¶åé‡æ–°å¯åŠ¨ã€‚</p>
<h2 id="å¯åŠ¨è¿›å…¥-recovery"><a href="#å¯åŠ¨è¿›å…¥-recovery" class="headerlink" title="å¯åŠ¨è¿›å…¥ recovery"></a>å¯åŠ¨è¿›å…¥ recovery</h2><p>åœ¨ VMware é‡Œï¼Œ<code>cmd + R</code>å°±èƒ½è¿›å…¥ recovery æ¨¡å¼ã€‚virtualbox è¦å¤šå‡ æ­¥ã€‚</p>
<p>å¯åŠ¨è™šæ‹Ÿæœºæ—¶ï¼ŒæŒ‰ä½<code>F12</code>ï¼Œç„¶åé€‰æ‹©<code>Boot Manager -&gt; EFI Internal Shell</code>ï¼Œå°±ä¼šçœ‹åˆ° EFI Shell çš„æ¬¢è¿ç•Œé¢ã€‚è¾“å…¥å‘½ä»¤è¿›å…¥ recoveryï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FS2:\com.apple.recovery.boot\boot.efi</div></pre></td></tr></table></figure></p>
<p>è¿›å…¥ recovery çš„ç•Œé¢ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œæ“ä½œç›®æ ‡å†…æ ¸ï¼Œå¹¶å°† kextcache è®¾ç½®ä¸ºæ— æ•ˆã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># mv /path/to/kernels/kernel.development /System/Library/Kernels</div><div class="line"># kextcache -invalidate /Volumes/Macintosh\ HD</div><div class="line"># reboot</div></pre></td></tr></table></figure></p>
<p>å¦‚æœéœ€è¦ç¦ç”¨ SIPï¼Œåœ¨é‡å¯ä¹‹å‰æ‰§è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># csrutil disable</div><div class="line">Successfully disabled System Integrity Protection. Please restart the machine for the changes to take effect.</div></pre></td></tr></table></figure></p>
<h1 id="æºç è°ƒè¯•"><a href="#æºç è°ƒè¯•" class="headerlink" title="æºç è°ƒè¯•"></a>æºç è°ƒè¯•</h1><p>ä¸‹è½½è¦è°ƒè¯•çš„ç‰ˆæœ¬çš„ XNU æºç ã€‚è°ƒè¯•æ—¶ï¼ŒLLDB ä¼šå» <code>/Library/Caches/com.apple.xbs/Sources/xnu/xnu-...</code>ç›®å½•å¯»æ‰¾å†…æ ¸æºç ï¼Œæ‰€ä»¥å¯ä»¥æŠŠä¸‹è½½çš„æºç æ”¾è¿™ä¸ªç›®å½•ï¼Œä¹Ÿå¯ä»¥å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æŒ‡å‘æºç ç›®å½•ã€‚è¿˜æœ‰ä¸ªæ–¹æ³•æ˜¯ è®¾ç½® LLDB çš„<code>target.source-map</code>å˜é‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lldb&gt; settings set target.source-map /Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.1.32 /Users/kedy/Downloads/xnu-3789.1.32</div></pre></td></tr></table></figure>
<p>æ—©ä¸€äº›çš„ macOS ç‰ˆæœ¬æ¯”å¦‚ Yosemite å°±åªèƒ½æŠŠæºç æ”¾åœ¨ <code>/SourceCache/xnu/</code>é‡Œã€‚</p>
<h1 id="å®‰è£…-LLDB"><a href="#å®‰è£…-LLDB" class="headerlink" title="å®‰è£… LLDB"></a>å®‰è£… LLDB</h1><p>ç»ˆäºåˆ°è°ƒè¯•å™¨äº†ã€‚ä¸‹é¢ä¼šä¸¾ä¾‹ç”¨çš„æ˜¯ RELEASE å†…æ ¸ã€‚</p>
<p>ä¸ºäº†åœ¨ Sierra KDK é‡Œç”¨ XNU LLDB å®ï¼Œæ‰§è¡Œ<code>pip install macholib</code>å®‰è£…<code>macholib</code>æ¨¡å—ã€‚ç²˜è´´æ‰§è¡ŒåŠ è½½å†…æ ¸æ–‡ä»¶æ—¶æç¤ºæˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p>è§¦å‘ NMI åï¼ˆæˆ–è€…ç­‰å¾…è®¾ç½®äº†<code>DB_HALT</code>çš„è°ƒè¯•å™¨æš‚åœå¯åŠ¨è¿›ç¨‹æ—¶ï¼‰ï¼Œæ‰§è¡Œ<code>kdp-remote &lt;ip&gt;</code>è¿æ¥åˆ°è°ƒè¯•è¿›ç¨‹ï¼ˆè‹¥ä½¿ç”¨çš„æ˜¯ NAT ç«¯å£è½¬å‘ï¼Œip æ˜¯ localhostï¼‰ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">$ lldb /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel</div><div class="line">(lldb) target create &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel&quot;</div><div class="line">warning: &apos;kernel&apos; contains a debug script. To run this script in this debug session:</div><div class="line"></div><div class="line">    command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py&quot;</div><div class="line"></div><div class="line">To run all discovered debug scripts in this session:</div><div class="line"></div><div class="line">    settings set target.load-script-from-symbol-file true</div><div class="line"></div><div class="line">Current executable set to &apos;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel&apos; (x86_64).</div><div class="line">(lldb) command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py&quot;</div><div class="line">Loading kernel debugging from /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py</div><div class="line">LLDB version lldb-370.0.40</div><div class="line">  Swift-3.1</div><div class="line">settings set target.process.python-os-plugin-path &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/core/operating_system.py&quot;</div><div class="line">settings set target.trap-handler-names hndl_allintrs hndl_alltraps trap_from_kernel hndl_double_fault hndl_machine_check _fleh_prefabt _ExceptionVectorsBase _ExceptionVectorsTable _fleh_undef _fleh_dataabt _fleh_irq _fleh_decirq _fleh_fiq_generic _fleh_dec</div><div class="line">command script import &quot;/Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/xnu.py&quot;</div><div class="line">xnu debug macros loaded successfully. Run showlldbtypesummaries to enable type summaries.</div><div class="line"></div><div class="line"></div><div class="line">(lldb) kdp-remote 192.168.149.184</div><div class="line">Version: Darwin Kernel Version 15.2.0: Fri Nov 13 19:56:56 PST 2015; root:xnu-3248.20.55~2/RELEASE_X86_64; UUID=17EA3101-D2E4-31BF-BDA9-931F51049F93; stext=0xffffff8007a00000</div><div class="line">Kernel UUID: 17EA3101-D2E4-31BF-BDA9-931F51049F93</div><div class="line">Load Address: 0xffffff8007a00000</div><div class="line">Kernel slid 0x7800000 in memory.</div><div class="line">Loaded kernel file /Library/Developer/KDKs/KDK_10.11.2_15C50.kdk/System/Library/Kernels/kernel</div><div class="line">Target arch: x86_64</div><div class="line">Instantiating threads completely from saved state in memory.</div><div class="line">Loading 82 kext modules warning: Can&apos;t find binary/dSYM for com.apple.kec.corecrypto (491718F5-B509-31DC-92B5-6BAC95E3F494)</div><div class="line">.warning: Can&apos;t find binary/dSYM for com.apple.kec.pthread (0888BA0A-49EE-394A-AEB1-1E5C6838A1F2)</div><div class="line"></div><div class="line">(omitted...)</div><div class="line"></div><div class="line">. done.</div><div class="line">kernel was compiled with optimization - stepping may behave oddly; variables may not be available.</div><div class="line">Process 1 stopped</div><div class="line">* thread #2, name = &apos;0xffffff800db8b000&apos;, queue = &apos;0x0&apos;, stop reason = signal SIGSTOP</div><div class="line">    frame #0: 0xffffff8007bd655e kernel`Debugger(message=&lt;unavailable&gt;) at model_dep.c:1020 [opt]</div><div class="line">   1017</div><div class="line">   1018		doprnt_hide_pointers = old_doprnt_hide_pointers;</div><div class="line">   1019		__asm__(&quot;int3&quot;);</div><div class="line">-&gt; 1020		hw_atomic_sub(&amp;debug_mode, 1);</div><div class="line">   1021	&#125;</div><div class="line">   1022</div><div class="line">   1023	char *</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>ç§ï¼ŒmacOS å†…æ ¸æºç è°ƒè¯•è¿™å°±å¼€å§‹äº†ï¼</p>
<hr>
<p>åŸæ–‡é“¾æ¥: <a href="https://klue.github.io/blog/2017/04/macos_kernel_debugging_vbox/" target="_blank" rel="external">Securing Browsers Through Isolation Versus Mitigation</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-217023.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;é‡å¤§æ›´æ–°&lt;/strong&gt;ï¼šawalton åœ¨ Hacker News ä¸Šçš„è®¨è®ºä¸­æåˆ°ï¼šVMWare é‡Œå¯ä»¥è®¾ç½® CPUID æ ‡å¿—æ¥ç¦ç”¨ SMAPï¼Œåªéœ€è¦åœ¨ vmx æ–‡ä»¶ä¸­åŠ ä¸Šcpuid.7.ebx = â€œâ€”â€”â€”â€“0â€”â€”â€”â€”â€”â€”â€“â€.
    
    </summary>
    
    
      <category term="translation" scheme="http://kiya.studio/tags/translation/"/>
    
  </entry>
  
  <entry>
    <title>ç¿»è¯‘ - â€œéš”ç¦»â€ä¸â€œç¼“è§£â€ - Chromeã€Edge åœ¨æµè§ˆå™¨é˜²æŠ¤ä¸Šçš„ç»ˆæå¯¹å†³ï¼</title>
    <link href="http://kiya.studio/2017/03/10/chromeVSie/"/>
    <id>http://kiya.studio/2017/03/10/chromeVSie/</id>
    <published>2017-03-10T08:30:07.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ˜¨å¤©å¾®è½¯å‘å¸ƒäº†ä¸€ç¯‡å…³äºâ€œ<a href="https://blogs.windows.com/msedgedev/2017/02/23/mitigating-arbitrary-native-code-execution/" target="_blank" rel="external">æ–°æ—§éš”ç¦»æœºåˆ¶</a>â€çš„æ–‡ç« [<em>è¯‘è€…æ³¨</em>:éš”ç¦»ä»»æ„ native ä»£ç çš„æ‰§è¡Œ]ï¼Œæˆ‘ä¸ªäººéå¸¸èµåŒä»–ä»¬ç»™ Edge æ•´ä¸Šè¿™ä¸ªæœºåˆ¶ï¼Œä½†å¤–é¢æœ‰äº›ä¸ªååº”ç®€ç›´å¤¸å¼ çš„ä¸çœŸå®ã€‚<a id="more"></a>æ¥çœ‹çœ‹ Dan Guido çš„ Twitter (å¯¹ä¸ä½äº† Dan ~ğŸ˜‰):</p>
<blockquote>
<p>æ¯«æ— äº‰è®®, Edge ä¸€è·ƒè¶…è¿‡ Chrome æˆä¸ºäº†æœ€å®‰å…¨çš„æµè§ˆå™¨ï¼ <a href="https://t.co/JeE08LHBBv" target="_blank" rel="external">https://t.co/JeE08LHBBv</a> â€”â€”<a href="https://twitter.com/dguido/status/834846901191204864" target="_blank" rel="external">@dguido</a></p>
</blockquote>
<p>åœ¨è¿™ä»¶äº‹ä¸Šï¼Œæˆ‘è®¤ä¸ºå¯¹æ¯” Chrome æ¥åè§‚å¾®è½¯è¿™æ¬¡çš„åŠ¨ä½œï¼Œå¼„æ¸…æ¥šæµè§ˆå™¨çš„ä¸–ç•Œé‡Œå‘ç”Ÿäº†ä»€ä¹ˆæ›´ä¸ºé‡è¦ã€‚å½“ç„¶ï¼Œä½œä¸º Chrome å®‰å…¨çš„å·¥ç¨‹æŒ‡å¯¼æˆ‘å¯èƒ½ä¼šåå¿ƒã€‚ä½†æ˜¯ï¼Œæˆ‘çš„å·¥ä½œè¦æ±‚æˆ‘å®¢è§‚çš„è¯„ä»·å„ç§å®‰å…¨æœºåˆ¶ä»è€ŒæŒ‡å¯¼æˆ‘çš„å›¢é˜Ÿçš„åŠªåŠ›æ–¹å‘ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘è¦ä½œå‡ºçš„ç»“è®ºè¿˜æ˜¯æŒºâ€œæ¸…ç™½â€çš„ã€‚</p>
<p><img src="http://bmob-cdn-1754.b0.upaiyun.com/2017/03/10/801c119140181489806cb2d2ed2d8216.jpeg" alt="EvsC"></p>
<h2 id="ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ-RCE"><a href="#ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ-RCE" class="headerlink" title="ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)"></a>ç¼“è§£è¿œç¨‹ä»£ç æ‰§è¡Œ(RCE)</h2><p>å¯¹äºå‰ç«¯çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œå¾®è½¯å¯æ˜¯ä¸‹äº†å¤§åŠŸå¤«ã€‚å®ƒè¯•å›¾é€šè¿‡é˜²æ­¢æ”»å‡»è€…è·å¾—å¯é çš„ä»£ç è€Œæ‰“ç ´æ¼æ´åˆ©ç”¨çš„ç¬¬ä¸€ç¯ï¼Œå¦‚æœæˆåŠŸçš„è¯å°±å¯ä»¥å®Œå…¨é˜»æ­¢æ”»å‡»è€…ã€‚ä½†æœ€åä»ç„¶ä¼šæ¼”å˜æˆçŒ«æ‰è€é¼ çš„æ¸¸æˆï¼Œç¼“è§£è™½ç„¶å¯ä»¥æ¶ˆè€—æ”»å‡»è€…æ›´å¤šç²¾åŠ›ï¼Œå´ä¸èƒ½ä»æ ¹æœ¬ä¸Šé˜»æ­¢æ¼æ´åˆ©ç”¨ã€‚</p>
<p>ä¸ªäººæ¥è¯´ï¼Œæˆ‘è®¤ä¸ºå¾®è½¯æ­¤æ¬¡çš„ç€çœ¼ç‚¹ä»…ä»…æ˜¯æ”¾åœ¨äº† IE å’Œ Edge æœ€å¸¸å—åˆ°çš„æ”»å‡»ç±»å‹ä¸Šï¼Œâ€œè®©æ•°æ®è¯´è¯â€ä¹Ÿçš„ç¡®ä¸å¤±ä¸ºä¸€ç§åˆé€»è¾‘çš„ç­–ç•¥ã€‚è¿™æ ·çš„è¯å°±æœ‰ä¸€å¤§å †æ–°çš„ RCE ç¼“è§£æŠ€æœ¯ï¼Œè¿åŒç€å…¶ä¸ chrome ç±»ä¼¼æŠ€æœ¯çš„å¯¹æ¯”ï¼Œæˆ‘åœ¨ä¸‹é¢åˆ—äº†å†™å€¼å¾—æ³¨æ„çš„å‡ é¡¹:</p>
<ul>
<li><p>å†…å­˜å›æ”¶<br>é€šè¿‡å›æ”¶ DOM å¯¹è±¡ã€åœ¨ free æ“ä½œæ—¶ä½œç¼“è§£ï¼Œå†…å­˜å›æ”¶é™ä½äº†å¯åˆ©ç”¨çš„ use-after-free æ¼æ´å‡ºç°çš„å¯èƒ½æ€§ã€‚è¿™èƒ½ä¸ Chrome çš„ <a href="https://chromium.googlesource.com/chromium/src/+/master/third_party/WebKit/Source/platform/heap/BlinkGCAPIReference.md" target="_blank" rel="external">use of Oilpan</a> ç±»ä¼¼ï¼Œé€šè¿‡å›æ”¶ DOM å¯¹è±¡ã€åˆ†å—åˆ†é…å†…å­˜ï¼Œé‡‡ç”¨ä¸åŒçš„ç¼“è§£æªæ–½ï¼Œæ¥å¯¹æŠ—å‘ç”Ÿä¸­çš„ use-after-free åˆ©ç”¨ã€‚æ€»çš„æ¥è¯´ï¼Œå†…å­˜å›æ”¶åªæ˜¯ Chrome åœ¨è¿™å—å„¿çš„ä¸€ä¸ªå°ç‰¹ç‚¹ï¼Œç›¸å¯¹æ¥è¯´ Chrome æ²¡æœ‰é‚£ä¹ˆå¤šå¯åˆ©ç”¨çš„æ¼æ´ï¼Œè¿™å±€æ‰“å¹³ã€‚</p>
</li>
<li><p>æ‰§è¡Œæµä¿æŠ¤(CFG)</p>
</li>
</ul>
<p>CFG æä¾›å®Œæ•´çš„æ‰§è¡Œæµè¡¨ï¼Œåœ¨â€œé¢„é˜²ç›´æ¥æ‰§è¡Œéæ³•è·¯å¾„â€ä¸Šä½œäº†å¢å¼ºï¼ŒEdge åœ¨å†…éƒ¨ä»£ç å’Œç³»ç»Ÿåº“éƒ½ç”¨äº† CFGã€‚è€ŒChrome åªåœ¨ç³»ç»Ÿ DLL ç”¨äº† CFGï¼Œ å¦ä¸€æ–¹é¢ä¸æ˜¯ Chrome å†…éƒ¨è€Œæ˜¯ç”¨åœ¨äº† Clang/LLVM  å·¥å…·é“¾ä¸Šï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Clang çš„ CFI æ£€æŸ¥ï¼Œéå¸¸å¥½åœ°å¥‘åˆäº† Chrome çš„éœ€æ±‚ã€‚CFI/CFG æ˜¯æœªç»è¿‡å®é™…æ£€éªŒçš„æŠ€æœ¯ï¼Œæœªæ¥è¿˜å¯èƒ½å‡ºç°é‡å¤§çš„å¼±ç‚¹å’Œè®¾è®¡ç¼ºé™·ï¼Œæ€»çš„æ¥è¯´æ˜¯ Edge å äº†ä¸Šé£ã€‚</p>
<ul>
<li>JavaScript JIT åŠ å¼º</li>
</ul>
<p>å¾®è½¯åœ¨â€œé˜²æ­¢æ¼æ´åˆ©ç”¨æ—¶åˆ©ç”¨ JIT â€æ–¹é¢åšäº†å¾ˆå¤šå·¥ä½œï¼Œå…¶ä¸­æœ€åˆ›æ–°çš„è«è¿‡äºå°† JIT ç§»å‡ºè¿›ç¨‹ï¼Œä¸è®©æ²™ç›’ä¸­çš„è¿›ç¨‹ç›´æ¥åˆ›å»ºå¯æ‰§è¡Œé¡µé¢ã€‚æ”»å‡»è€…å¿…é¡»å®Œæ•´ç¼–è¯‘ RCE æˆ ROP é“¾ï¼Œè¿™å¯è¦è´¹å¤§å·¥å¤«äº†ã€‚æ— å¯å¦è®¤ï¼Œè™½ç„¶ v8 è¦æ¨å‡º JavaScript è§£é‡Šå™¨ï¼ˆignitionï¼‰å’Œ JIT çš„æ›¿ä»£å“ï¼ˆturbofanï¼‰ï¼ŒChrome çš„æ€§èƒ½ä¼šå¤§å¹…æå‡ï¼Œä½†æ˜¯ Chrome å½“å‰çš„ JIT ç¼“è§£æªæ–½è¿˜æ˜¯æ¯”å¾®è½¯å¼±ã€‚è¿™æ–¹é¢ Edge é¥é¥é¢†å…ˆäº† Chromeã€‚</p>
<h2 id="å®‰å…¨éš”ç¦»æœºåˆ¶"><a href="#å®‰å…¨éš”ç¦»æœºåˆ¶" class="headerlink" title="å®‰å…¨éš”ç¦»æœºåˆ¶"></a>å®‰å…¨éš”ç¦»æœºåˆ¶</h2><p>å¾®è½¯åœ¨ RCE ç¼“è§£æ–¹é¢æ¯” Chrome æŠ•å…¥æ›´å¤šï¼ŒChrome æ›´ä¸“æ³¨äºåœ¨æµè§ˆç½‘é¡µæ—¶å®šä¹‰å’ŒåŠ å¼ºæŒç»­å¯ç”¨çš„éš”ç¦»è¾¹ç•Œã€‚åƒå¾®è½¯ä¸€æ ·ï¼ŒChrome ä¹Ÿæ˜¯å—æš´éœ²çš„æ¼æ´ç±»å‹é©±åŠ¨çš„ã€‚ç„¶è€Œï¼Œä¸¤å®¶æ˜¯æœ‰ä¸åŒçš„ç†å¿µå’Œå®æ–½çº¦æŸçš„ï¼Œé€šè¿‡é•¿æœŸè§‚å¯Ÿï¼Œæˆ‘ä»¬å‘ç°éš”ç¦»æœºåˆ¶åè€Œæ˜¯æ›´æœ‰æ•ˆçš„ç­–ç•¥ï¼Œè·¨å¹³å°ä¹Ÿæ›´æ–¹ä¾¿ã€‚</p>
<p>é¦–å…ˆï¼Œä»å®‰å…¨æœºåˆ¶çš„é•¿æœŸæœ‰æ•ˆæ€§æ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨ Chrome ä¸Šå‘ç°ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œåº•å±‚ OS å¹³å°å€¾å‘äºæå‡å®‰å…¨éš”ç¦»åŸè¯­ã€‚æ¯”å¦‚è¯´ Linux çš„è¡ç”Ÿç³»ç»Ÿä¼šä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Seccomp" target="_blank" rel="external">seccomp-bpf æœºåˆ¶</a>ï¼Œä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨ï¼ŒWindows ç³»ç»Ÿä¼šä½¿ç”¨<a href="https://msdn.microsoft.com/en-us/library/bb625957.aspx" target="_blank" rel="external">integrity level(IL)</a>ï¼Œ é”å®š win32k ä¸Šçš„è¿›ç¨‹ç¼“è§£ç­–ç•¥ã€‚åœ¨å®‰å…¨éš”ç¦»æ–¹é¢ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰èƒ½åŠ›åˆ©ç”¨è¿™äº›æ“ä½œç³»ç»Ÿä½œå‡ºçš„å®‰å…¨ä¸Šçš„æ”¹è¿›ã€‚</p>
<p>è¯´åˆ°å¯ç§»æ¤æ€§ï¼Œæ‹¿å¾®è½¯æœ€è¿‘çš„ JIT åŠ å¼ºæ¥è¯´ï¼Œå®ƒä¾èµ–äº Windows 10 ä¸Š Edge çš„æ–°ç‰¹æ€§ï¼Œå¹¶ä¸”å—é™äºå¾®è½¯çš„ç­¾åæ–‡ä»¶ã€‚ç°åœ¨è¿™ç§ OS é™åˆ¶å·²ç»ä¸å¸¸è§ï¼Œå·¥ç¨‹å¸ˆä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°æ›¿ä»£æ–¹æ³•è§£å†³ï¼Œä½†æ˜¯è€ƒè™‘åˆ°è¿™é¡¹åŠŸèƒ½æ¶‰åŠä¿®æ”¹ä¸»æ¶æ„ï¼Œå¿…é¡»ç¡®å®šè¿™å¯¹å…¶ä»–å¹³å°æ˜¯å¦å‹å¥½ï¼Œæˆ–è€…è§£é‡Šè¯´æ˜¯å®‰å…¨ä¸Šä½œäº†é‡å¤§æ”¹è¿›ï¼Œç„¶è€Œè¿™ä¸¤ç§è¯´æ³•éƒ½ä¸ç°å®ã€‚</p>
<blockquote>
<p>æ¯”èµ· Edgeï¼Œ Chrome çš„æ¸²æŸ“å™¨å¤„åœ¨æ›´å¼ºæœ‰åŠ›çš„æ²™ç®±ä¿æŠ¤ä¸­ã€‚</p>
</blockquote>
<p>Chrome åœ¨åˆ›å»ºæ›´å¼ºçš„éš”ç¦»åŸè¯­ï¼ˆå¦‚ Chrome çš„æ¸²æŸ“å™¨æ¯” Edge å¤„åœ¨æ›´å¼ºçš„æ²™ç®±ä¿æŠ¤ä¸­ï¼‰å’Œæ‰©å±•å…¶åº”ç”¨æ–¹é¢ï¼ˆå¦‚ GPU æ²™ç›’ã€ç½‘ç»œæ²™ç›’ï¼‰åšå‡ºäº†æ›´å¤§åŠªåŠ›ã€‚</p>
<p>è¿™æ–¹é¢æˆ‘ä»¬çš„ç‹ç‰Œæ˜¯ä»Šå¹´æ¨å‡ºçš„<a href="https://www.chromium.org/developers/design-documents/site-isolation" target="_blank" rel="external">ç«™ç‚¹éš”ç¦»é¡¹ç›®</a>ï¼Œç«™ç‚¹éš”ç¦»æ˜¯æ•°åå¹´çš„å·¥ç¨‹æˆæœï¼Œä¸º web æºåŠ ä¸Šé™åˆ¶ï¼Œä»è€Œé˜»æ­¢æ¸²æŸ“å™¨æ²™ç›’ RCE æ“ä½œå…¶ä»– web æºã€‚è¿™æ¯”ç°ä»Šå…¶ä»–ä»»ä½•æµè§ˆå™¨çš„å®‰å…¨ä¿è¯éƒ½æ›´å¼ºå£®æœ‰åŠ›ã€‚</p>
<h2 id="è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ"><a href="#è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ" class="headerlink" title="è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ"></a>è¿™ç¯‡æ–‡ç« çš„ç‚¹åœ¨å“ªï¼Ÿ</h2><p>æµè§ˆå™¨å®‰å…¨æ˜¯ä¸ªå¤æ‚çš„è¯é¢˜ã€‚æ‰€ä»¥æˆ‘æƒ³ä¸º Chrome ç°åœ¨çš„å†³ç­–ä½œä¸€äº›è¯´æ˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘è®¤ä¸ºè¿™äº›å†³ç­–ä»ç„¶å¯ä»¥æå« Chrome åœ¨å„ä¸ªå¹³å°ä½œä¸ºæœ€å®‰å…¨æµè§ˆå™¨çš„åœ°ä½ï¼ˆäº‹å®è¯æ˜ï¼‰ã€‚</p>
<p>ç°åœ¨é—®é¢˜æ˜¯æœ‰ä¸€äº›ç°è±¡æŠŠå®‰å…¨ç ”ç©¶é™ä½æˆç®€å•åœ°åˆ’åˆ’æ¸…å•ï¼Œæˆ–è€…æ˜¯äº’ç›¸æ¯”è¾ƒå®‰å…¨ç‰¹å¾/CVE çš„æ¸¸æˆï¼Œè¿™äº›ä¸œè¥¿å¯¹è¯„ä¼°çœŸå®çš„å®‰å…¨æ²¡ä¸€ç‚¹ç”¨å¤„ã€‚æµè§ˆå™¨çš„æ¶æ„æ˜¯è½¯ä»¶é‡Œæœ€å¤æ‚çš„ï¼ŒèƒŒåçš„å†³ç­–å¯¹æˆ‘ä»¬ä¹Ÿæ˜¯ä¸é€æ˜çš„ã€‚æˆ‘ç¡®å®è®¤ä¸ºæˆ‘ä»¬åšäº†æ­£ç¡®çš„å†³å®šï¼Œä¼˜å…ˆè§£å†³ç€ Chrome æœ€è¦ç´§çš„é—®é¢˜ã€‚æˆ‘æ‰¿è®¤å¦‚æœæˆ‘è´Ÿè´£çš„æ˜¯ Edge çš„å®‰å…¨ï¼Œæˆ‘ä¼šé’ˆå¯¹ä¸åŒçš„ç”¨æˆ·æ‹¿å‡ºä¸åŒçš„æ•°æ®ï¼Œæœ€ååšå‡ºä¸ªä¸ä¸€æ ·çš„ç»“è®ºã€‚</p>
<h2 id="ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ"><a href="#ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ" class="headerlink" title="ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ"></a>ä»¥æˆ‘ä»¬çš„å…±åŒç‚¹ç»“æŸå¦‚ä½•ï¼Ÿ</h2><p>å¾®è½¯çš„åšå®¢é‡Œå…³äº Edge å¦‚ä½•é˜²æ­¢ç¬¬ä¸‰æ–¹ä»£ç æ³¨å…¥è¿™ç‚¹éå¸¸æœ‰æ„æ€ï¼Œè¿™ä¹Ÿæ˜¯æ‰€æœ‰æµè§ˆå™¨å¤§å¤´çš„ç‚¹ã€‚ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ä¸å½“æ“ä½œæ’å…¥ä»£ç ä¸ä»…ä¼šé€ æˆç¨³å®šæ€§é—®é¢˜å’Œæ€§èƒ½é—®é¢˜ï¼Œä¹Ÿå¦¨å®³ç€æµè§ˆå™¨å®‰å…¨ã€‚æˆ‘ä¸€ç›´è¯´æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸€ç›´ä¸èƒ½åœ¨ Chrome æ²™ç›’é‡Œå¯ç”¨ Lowbox Tokenï¼ˆApp å®¹å™¨å®‰å…¨é™åˆ¶ï¼‰å’Œ CSRSS é™åˆ¶ï¼Œå› ä¸ºé‚£æ—¶ç¬¬ä¸‰æ–¹çš„åç—…æ¯’ç¨‹åºä¼šé€ æˆ Chrome å´©æºƒã€‚</p>
<p>å¾ˆé«˜å…´çœ‹åˆ°å¾®è½¯åˆ©è½çš„åˆ‡å…¥äº† Edgeï¼Œä¸ºé˜»æ­¢ç¬¬ä¸‰æ–¹æ³¨å…¥å¼€äº†å…ˆæ²³ã€‚Chrome å’Œ Firefox ä»Šå¹´ä¹Ÿå‡†å¤‡éƒ¨ç½²ç±»ä¼¼çš„æ–¹æ¡ˆï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šä¸ºäº†æœ€å¥½çš„å¸®åŠ©ç”¨æˆ·æˆ‘ä»¬è¾¾æˆäº†ç»“ç›Ÿã€‚</p>
<p><img src="http://bmob-cdn-1754.b0.upaiyun.com/2017/03/10/6ed3e9394075934e805505708887b01b.jpeg" alt=""></p>
<hr>
<p>åŸæ–‡é“¾æ¥: <a href="https://medium.com/@justin.schuh/securing-browsers-through-isolation-versus-mitigation-15f0baced2c2#.l2srshz32" target="_blank" rel="external">Securing Browsers Through Isolation Versus Mitigation</a></p>
<p>æœ¬æ–‡é¦–å‘äº<a href="http://bbs.pediy.com/thread-216267.htm" target="_blank" rel="external">çœ‹é›ª</a>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ˜¨å¤©å¾®è½¯å‘å¸ƒäº†ä¸€ç¯‡å…³äºâ€œ&lt;a href=&quot;https://blogs.windows.com/msedgedev/2017/02/23/mitigating-arbitrary-native-code-execution/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;æ–°æ—§éš”ç¦»æœºåˆ¶&lt;/a&gt;â€çš„æ–‡ç« [&lt;em&gt;è¯‘è€…æ³¨&lt;/em&gt;:éš”ç¦»ä»»æ„ native ä»£ç çš„æ‰§è¡Œ]ï¼Œæˆ‘ä¸ªäººéå¸¸èµåŒä»–ä»¬ç»™ Edge æ•´ä¸Šè¿™ä¸ªæœºåˆ¶ï¼Œä½†å¤–é¢æœ‰äº›ä¸ªååº”ç®€ç›´å¤¸å¼ çš„ä¸çœŸå®ã€‚
    
    </summary>
    
    
      <category term="translation" scheme="http://kiya.studio/tags/translation/"/>
    
  </entry>
  
  <entry>
    <title>ç¼–è¯‘ lua 5.3.3 æºç </title>
    <link href="http://kiya.studio/2016/08/31/compile-lua-5-3-3/"/>
    <id>http://kiya.studio/2016/08/31/compile-lua-5-3-3/</id>
    <published>2016-08-31T14:57:56.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>lua æºç ç›´æ¥ <code>make platform</code> ç¼–è¯‘æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè¿™é‡Œå°±è¯´ä¸€ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<a id="more"></a>
<h1 id="ç¼–è¯‘ä¸ºsoåº“"><a href="#ç¼–è¯‘ä¸ºsoåº“" class="headerlink" title="ç¼–è¯‘ä¸ºsoåº“"></a>ç¼–è¯‘ä¸ºsoåº“</h1><p>é»˜è®¤çš„ç¼–è¯‘åªæœ‰ .a åº“, so åº“åªèƒ½è‡ªå·±åŠ¨æ‰‹äº†.</p>
<h2 id="ä¿®æ”¹-Makefile"><a href="#ä¿®æ”¹-Makefile" class="headerlink" title="ä¿®æ”¹ Makefile"></a>ä¿®æ”¹ Makefile</h2><p>å°†æ ¹ç›®å½•ä¸­çš„Makefileä½œå¦‚ä¸‹ä¿®æ”¹:</p>
<p>å°†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TO_LIB= liblua.a</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TO_LIB= liblua.a liblua.so</div></pre></td></tr></table></figure></p>
<p>åœ¨src/Makefileä¸­å¯»æ‰¾åˆé€‚çš„ä½ç½®æ·»åŠ ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LUA_SO=liblua.so</div><div class="line"></div><div class="line">$(LUA_SO): $(CORE_O) $(LIB_O)</div><div class="line">    $(CC) -o $@ -shared $? -ldl -lm</div></pre></td></tr></table></figure></p>
<p>å°†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALL_T= $(LUA_A) $(LUA_T) $(LUAC_T)</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALL_T= $(LUA_A) $(LUA_T) $(LUAC_T) $(LUA_SO)</div></pre></td></tr></table></figure></p>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>ç¼–è¯‘å®Œæˆåæœ‰ä¸¤ä¸ªä¸»è¦çš„å¯æ‰§è¡Œæ–‡ä»¶<code>lua</code> å’Œ <code>luac</code> å’Œä¸¤ä¸ªåº“ <code>liblua.a</code> å’Œ <code>liblua.so</code>.</p>
<p><code>lua</code> : è™šæ‹Ÿæœºï¼Œç”¨æ¥æ‰§è¡Œ lua ä»£ç <br><code>luac</code> : ç¼–è¯‘å™¨ï¼Œç”¨æ¥ä¸º lua ä»£ç åšä¸€äº›ä¼˜åŒ–ä»€ä¹ˆçš„ (å¹¶ä¸æ˜¯è¯´è„šæœ¬è¯­è¨€å°±ä¸éœ€è¦ç¼–è¯‘å™¨äº†å•Šå•Šå•Šå•Š)<br><code>liblua.a</code> : é™æ€åº“<br><code>liblua.so</code> : åŠ¨æ€åº“</p>
<h1 id="ä¸ºAndroidå¹³å°ç¼–è¯‘"><a href="#ä¸ºAndroidå¹³å°ç¼–è¯‘" class="headerlink" title="ä¸ºAndroidå¹³å°ç¼–è¯‘"></a>ä¸ºAndroidå¹³å°ç¼–è¯‘</h1><p>æ–°å»º <code>liblua.mk</code> å’Œ <code>Android.mk</code>, å†™å…¥:</p>
<p><strong>liblua.mk</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">LIB_VERSION:=lua-5.3.3-src</div><div class="line">SRC_ROOT_PATH:= ../../$(LIB_VERSION)</div><div class="line"></div><div class="line">LOCAL_PATH:= $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE := liblua</div><div class="line">LOCAL_CFLAGS := -D&quot;lua_getlocaledecpoint() =&apos;.&apos;&quot; -DLUA_USE_C89</div><div class="line"></div><div class="line">LOCAL_SRC_FILES := \</div><div class="line"> $(SRC_ROOT_PATH)/src/lapi.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lauxlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lbaselib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lbitlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lcode.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lcorolib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lctype.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldblib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldebug.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldo.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ldump.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lfunc.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lgc.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/linit.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/liolib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/llex.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lmathlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lmem.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/loadlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lobject.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lopcodes.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/loslib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lparser.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstate.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstring.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lstrlib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltable.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltablib.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/ltm.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lua.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lundump.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lvm.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lzio.c \</div><div class="line"> $(SRC_ROOT_PATH)/src/lutf8lib.c\</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div><div class="line">#include $(BUILD_STATIC_LIBRARY)</div><div class="line">#include $(BUILD_EXECUTABLE)</div></pre></td></tr></table></figure></p>
<p><strong>Android.mk</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH:= $(call my-dir)</div><div class="line">include $(LOCAL_PATH)/liblua.mk</div></pre></td></tr></table></figure></p>
<p>æ­¤æ—¶æ–‡ä»¶ç»“æ„å¦‚å›¾ (lua-5.5.5-srcæ–‡ä»¶å¤¹ä¸ºä¸‹è½½çš„æºç ,å…¶ä»–æ˜¯æ–°å»ºçš„):</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/30/1.png-styleOnlyWatermark" alt=""></p>
<p>è¿›å…¥<code>jni</code>æ–‡ä»¶å¤¹æ‰§è¡Œ<code>ndk-build</code>ç¼–è¯‘, æˆåŠŸåçš„æ–‡ä»¶ç»“æ„å¦‚å›¾:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/30/2.png-styleOnlyWatermark" alt=""></p>
<h1 id="é”™è¯¯åˆ—è¡¨"><a href="#é”™è¯¯åˆ—è¡¨" class="headerlink" title="é”™è¯¯åˆ—è¡¨"></a>é”™è¯¯åˆ—è¡¨</h1><h2 id="é”™è¯¯1"><a href="#é”™è¯¯1" class="headerlink" title="é”™è¯¯1"></a>é”™è¯¯1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file not recognized: ä¸å¯è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make clean</div></pre></td></tr></table></figure></p>
<h2 id="é”™è¯¯2"><a href="#é”™è¯¯2" class="headerlink" title="é”™è¯¯2"></a>é”™è¯¯2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/bin/ld: lapi.o: relocation R_X86_64_32 against `luaO_nilobject_&apos; can not be used when making a shared object; recompile with -fPIC</div><div class="line">lapi.o: error adding symbols: é”™è¯¯çš„å€¼</div></pre></td></tr></table></figure>
<p>å°†src/Makefileæ–‡ä»¶ä¸­çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFLAGS= -O2 -Wall -Wextra -DLUA_COMPAT_5_2 $(SYSCFLAGS) $(MYCFLAGS)</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFLAGS= -O2 -Wall -Wextra -DLUA_COMPAT_5_2 $(SYSCFLAGS) -fPIC $(MYCFLAGS)</div></pre></td></tr></table></figure></p>
<h2 id="é”™è¯¯3"><a href="#é”™è¯¯3" class="headerlink" title="é”™è¯¯3"></a>é”™è¯¯3</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error: &apos;struct lconv&apos; has no member named &apos;decimal_point&apos;</div></pre></td></tr></table></figure>
<p>å°†<code>luaconf.h</code>ä¸­çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define lua_getlocaledecpoint()		(localeconv()-&gt;decimal_point[0])</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define lua_getlocaledecpoint()		&apos;.&apos;</div></pre></td></tr></table></figure></p>
<p><strong>æˆ–è€…</strong> åœ¨makefileåŠ ä¸Šé€‰é¡¹ <code>-D&quot;lua_getlocaledecpoint() =&#39;.&#39;&quot;</code>. (å®Œæ•´makefileå†…å®¹è§ä¸Š)</p>
<h2 id="é”™è¯¯4"><a href="#é”™è¯¯4" class="headerlink" title="é”™è¯¯4"></a>é”™è¯¯4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">undefined reference to &apos;log2&apos;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>makefile</code> åŠ ä¸Šé€‰é¡¹ <code>-DLUA_USE_C89</code> . (å®Œæ•´makefileå†…å®¹è§ä¸Š)</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;lua æºç ç›´æ¥ &lt;code&gt;make platform&lt;/code&gt; ç¼–è¯‘æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè¿™é‡Œå°±è¯´ä¸€ä¸‹éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="compile" scheme="http://kiya.studio/tags/compile/"/>
    
  </entry>
  
  <entry>
    <title>Android Studio è°ƒè¯• smali ä»£ç </title>
    <link href="http://kiya.studio/2016/08/07/use-studio-debug-smali/"/>
    <id>http://kiya.studio/2016/08/07/use-studio-debug-smali/</id>
    <published>2016-08-07T14:57:52.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹äº java å±‚é€†å‘æ¥è¯´ï¼ŒåŠ¨æ€è°ƒè¯•å¯æ¯”æ‰“ log æ–¹ä¾¿å¤šäº† :p</p>
<a id="more"></a>
<p>å¼€å§‹ä¹‹å‰å…ˆä¾›å‡ºä¸€ä¸ªå¤§ç¥ï¼ˆæ­¤å¤„çŒ®ä¸Šè†ç›–ï¼‰ï¼Œsmaliã€baksmaliã€smalidea å…¨å¥—éƒ½å¯ä»¥åœ¨è¿™é‡Œ -&gt; <a href="https://bitbucket.org/JesusFreke/smali/downloads" target="_blank" rel="external">ä¸‹è½½</a>ï¼Œä»Šå¤©ç”¨åˆ°çš„æ˜¯ smalidea æ’ä»¶ï¼Œç›®å‰ç‰ˆæœ¬æ˜¯ 0.03 .</p>
<h2 id="å®‰è£…æ’ä»¶"><a href="#å®‰è£…æ’ä»¶" class="headerlink" title="å®‰è£…æ’ä»¶"></a>å®‰è£…æ’ä»¶</h2><ul>
<li><strong>File -&gt; Settings</strong> ç‚¹å‡» <strong>Plugins</strong> :</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/1.png-styleOnlyWatermark" alt=""></p>
<h2 id="å¯¼å…¥é¡¹ç›®"><a href="#å¯¼å…¥é¡¹ç›®" class="headerlink" title="å¯¼å…¥é¡¹ç›®"></a>å¯¼å…¥é¡¹ç›®</h2><ul>
<li>ä½¿ç”¨ baksmali å°† dex æ–‡ä»¶åç¼–è¯‘ä¸º smali .</li>
<li><strong>File -&gt; New -&gt; Import Projectâ€¦</strong>ï¼Œé€‰ä¸­åç¼–è¯‘è¿‡çš„ smali ç›®å½•ã€‚</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/2.png-styleOnlyWatermark" alt=""></p>
<p>ä¹‹åä¸€è·¯ next å³å¯ã€‚</p>
<h2 id="ä¸€äº›è®¾ç½®"><a href="#ä¸€äº›è®¾ç½®" class="headerlink" title="ä¸€äº›è®¾ç½®"></a>ä¸€äº›è®¾ç½®</h2><ul>
<li>å³é”®æºä»£ç æ ¹ç›®å½• <strong>Mark Directory As -&gt; Sources Root</strong> </li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/5.png-styleOnlyWatermark" alt=""></p>
<ul>
<li><strong>File -&gt; Project Structureâ€¦</strong> è®¾ç½® jdk</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/3.png-styleOnlyWatermark" alt=""></p>
<ul>
<li><strong>Run -&gt; Edit Configurationsâ€¦</strong> æ–°å»ºä¸€ä¸ª remoteï¼Œè®¾ç½®ç«¯å£ä¸º8700ï¼Œå‘½åä¸º smali</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/7.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/8.png-styleOnlyWatermark" alt=""></p>
<h2 id="å¼€å§‹è°ƒè¯•"><a href="#å¼€å§‹è°ƒè¯•" class="headerlink" title="å¼€å§‹è°ƒè¯•"></a>å¼€å§‹è°ƒè¯•</h2><ul>
<li>ç¡®ä¿é€‰æ‹©çš„ app æ˜¯å¯è°ƒè¯•çš„/ä¿®æ”¹è¿‡è®¾å¤‡ç¯å¢ƒ</li>
<li><p>å®‰è£… apk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb install xxx.apk</div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ Android Device Monitor ï¼ˆå¼€å¯è°ƒè¯•ç«¯å£ç”¨ï¼‰</p>
</li>
<li><p>å¯åŠ¨ app</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb shell am start -D -n package_name/main_activity_name</div></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹å¥½æ–­ç‚¹</p>
</li>
<li>å¼€å§‹ Debug</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/9.png-styleOnlyWatermark" alt=""></p>
<ul>
<li>æ–­ä¸‹</li>
</ul>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/07/6.png-styleOnlyWatermark" alt=""></p>
<hr>
<p>over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹äº java å±‚é€†å‘æ¥è¯´ï¼ŒåŠ¨æ€è°ƒè¯•å¯æ¯”æ‰“ log æ–¹ä¾¿å¤šäº† :p&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://kiya.studio/categories/Android/"/>
    
    
      <category term="debug" scheme="http://kiya.studio/tags/debug/"/>
    
      <category term="smali" scheme="http://kiya.studio/tags/smali/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•é‡æ–°ç¼–è¯‘ uiautomatorviewer</title>
    <link href="http://kiya.studio/2016/08/06/recompile-uiautomatorviewer/"/>
    <id>http://kiya.studio/2016/08/06/recompile-uiautomatorviewer/</id>
    <published>2016-08-06T15:38:16.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨uiautomatorvieweræ—¶å¯èƒ½ä¼šæƒ³ç”¨åˆ°å…¶æœ¬èº«æ²¡æœ‰çš„åŠŸèƒ½ï¼Œæˆ–è€…æƒ³ä¿®æ”¹ä¸€ä¸‹å®ƒçš„é€»è¾‘ï¼Œè¿™æ—¶å€™å°±éœ€è¦é‡æ–°ç¼–è¯‘ä¸€ä¸ªjaråŒ…äº†ã€‚</p>
<a id="more"></a>
<p>å¥½åœ¨Androidæ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥ä¸ç”¨åç¼–è¯‘åŸæ¥çš„jaråŒ…ç›´æ¥ä¸‹è½½æºä»£ç å°±å¯ä»¥äº†ï¼Œæˆ‘æ˜¯åœ¨è¿™é‡Œcloneäº†ä¸€ä»½ -&gt; <a href="https://github.com/android-ia/platform_tools_swt" target="_blank" rel="external">é“¾æ¥</a> ~ å½“ç„¶åªéœ€è¦ç”¨åˆ°å…¶ä¸­çš„<a href="https://github.com/android-ia/platform_tools_swt/tree/master/uiautomatorviewer" target="_blank" rel="external">uiautomatorviewer</a>è¿™ä¸€ä¸ªæºç æ–‡ä»¶å¤¹å°±å¤Ÿäº†ã€‚</p>
<p>å› ä¸ºgoogleä½¿ç”¨eclipse rcpæ¥å¼€å‘è¿™äº›ä¸ªå·¥å…·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨eclipseå»ºç«‹e4é¡¹ç›®ã€‚</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/1.png-styleOnlyWatermark" alt=""></p>
<p>å»ºç«‹çš„è¿‡ç¨‹ä¸­ä¸€ç›´nextå°±å¥½ã€‚</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/2.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/3.png-styleOnlyWatermark" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/4.png-styleOnlyWatermark" alt=""></p>
<p>å°†uiautomatorviewerçš„æºç ä¸­src/main/javaæ–‡ä»¶å¤¹ä¸‹çš„ <strong>com å’Œ image</strong> æ–‡ä»¶å¤¹å¤åˆ¶åˆ°å·¥ç¨‹ä¸­çš„srcä¸­ï¼Œä¸‹è½½ <strong>ddmlib.jar</strong> å’Œ <strong>common.jar</strong> å¤åˆ¶åˆ° libs æ–‡ä»¶å¤¹ä¸‹(æ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª)ï¼Œå†å°†è¿™ä¸¤ä¸ª jar åŒ…å³é”® <strong>â€œBuild Pathâ€ -&gt; â€œAdd to Build Pathâ€</strong>ã€‚<br>é™„ä¸Š <a href="http://www.java2s.com/Code/JarDownload/ddmlib/ddmlib-22.2.0.jar.zip" target="_blank" rel="external">ddmlib.jar</a> å’Œ <a href="http://www.java2s.com/Code/JarDownload/common/common.jar.zip" target="_blank" rel="external">common.jar</a> çš„ä¸‹è½½åœ°å€ã€‚<br>è¿™æ˜¯å®Œæˆçš„é¡¹ç›®ç›®å½•ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/5.png-styleOnlyWatermark" alt=""></p>
<p>æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹è¿‡ä»£ç åï¼Œåœ¨é¡¹ç›®æ ¹èŠ‚ç‚¹å³é”® <strong>â€œexportâ€¦â€</strong>ï¼Œé€‰æ‹© <strong>â€œJAR fileâ€</strong>:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/6.png-styleOnlyWatermark" alt=""></p>
<p>é€‰æ‹©å¯¼å‡ºè¦åŒ…æ‹¬çš„é¡¹ç›®æ–‡ä»¶ï¼Œåªé€‰ <strong>src</strong> å³å¯ï¼Œå¹¶å¡«å…¥å¯¼å‡ºè·¯å¾„:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/7.png-styleOnlyWatermark" alt=""></p>
<p>ä¸€ç›´nextï¼Œåœ¨æœ€åä¸€æ­¥è®°å¾—å¡«å…¥ <strong>Main class</strong>:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/2016/08/06/8.png-styleOnlyWatermark" alt=""></p>
<p><strong>finish</strong> ä¹‹åå³å¯åœ¨å¯¼å‡ºè·¯å¾„ä¸‹çœ‹åˆ°jaræ–‡ä»¶ï¼Œæ›¿æ¢æ‰sdk toolsä¸­çš„uiautomatorviewer.jarå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å·¥å…·äº†~</p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä½¿ç”¨uiautomatorvieweræ—¶å¯èƒ½ä¼šæƒ³ç”¨åˆ°å…¶æœ¬èº«æ²¡æœ‰çš„åŠŸèƒ½ï¼Œæˆ–è€…æƒ³ä¿®æ”¹ä¸€ä¸‹å®ƒçš„é€»è¾‘ï¼Œè¿™æ—¶å€™å°±éœ€è¦é‡æ–°ç¼–è¯‘ä¸€ä¸ªjaråŒ…äº†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://kiya.studio/categories/Android/"/>
    
    
      <category term="compile" scheme="http://kiya.studio/tags/compile/"/>
    
  </entry>
  
  <entry>
    <title>å‡çº§ç«™é•¿ç§˜ç±ï¼šä½¿ç”¨flarumæ¡†æ¶æ­å»ºä¸€ä¸ªæœ‰é€¼æ ¼çš„è½»è®ºå›</title>
    <link href="http://kiya.studio/2016/04/14/install-flarum/"/>
    <id>http://kiya.studio/2016/04/14/install-flarum/</id>
    <published>2016-04-14T12:59:34.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…ˆæ¥ä¸ªæˆå“å›¾è§‚èµè§‚èµï¼š</p>
<a id="more"></a>
<p>æ‰‹æœºç‰ˆï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/10/30-style1" alt=""></p>
<p>ç”µè„‘ç‰ˆï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/05/53-style1" alt=""></p>
<hr>
<p>æˆ‘çš„ç¯å¢ƒï¼šubuntu 14.06 x64 VPS</p>
<h1 id="å®‰è£…å‡†å¤‡"><a href="#å®‰è£…å‡†å¤‡" class="headerlink" title="å®‰è£…å‡†å¤‡"></a>å®‰è£…å‡†å¤‡</h1><p>ä¾æ¬¡å®‰è£… apache2ã€php5ã€mysql-serverã€php5-mysql .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install apache2</div><div class="line">sudo apt-get install php5</div><div class="line">sudo apt-get install mysql-server</div><div class="line">sudo apt-get install php5-mysql</div></pre></td></tr></table></figure>
<p>å®‰è£…composer.(è¿™ä¸€æ­¥ç›´æ¥åœ¨å®˜ç½‘ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶åŠ ä¸Šå¯æ‰§è¡Œæƒé™å¤åˆ¶åˆ°/usr/local/binä¸­å°±è¡Œ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php -r &quot;readfile(&apos;https://getcomposer.org/installer&apos;);&quot; &gt; composer-setup.php</div><div class="line">php -r &quot;if (hash(&apos;SHA384&apos;, file_get_contents(&apos;composer-setup.php&apos;)) === &apos;7228c001f88bee97506740ef0888240bd8a760b046ee16db8f4095c0d8d525f2367663f22a46b48d072c816e7fe19959&apos;) &#123; echo &apos;Installer verified&apos;; &#125; else &#123; echo &apos;Installer corrupt&apos;; unlink(&apos;composer-setup.php&apos;); &#125; echo PHP_EOL;&quot;</div><div class="line">php composer-setup.php --install-dir=bin --filename=composer</div><div class="line">php -r &quot;unlink(&apos;composer-setup.php&apos;);&quot;</div></pre></td></tr></table></figure>
<h1 id="åˆ›å»ºflarumå·¥ç¨‹"><a href="#åˆ›å»ºflarumå·¥ç¨‹" class="headerlink" title="åˆ›å»ºflarumå·¥ç¨‹"></a>åˆ›å»ºflarumå·¥ç¨‹</h1><p>ä¸€å®šè¦åœ¨ç©ºç›®å½•é‡Œæ‰§è¡Œcreate-object.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir V2NB_forum</div><div class="line">cd V2NB_forum/</div><div class="line">composer create-project flarum/flarum . --stability=beta</div></pre></td></tr></table></figure>
<p>å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Installing flarum/flarum (v0.1.0-beta.5)</div><div class="line">  - Installing flarum/flarum (v0.1.0-beta.5)</div><div class="line">    Downloading: 100%         </div><div class="line"></div><div class="line">Created project in .</div><div class="line">Loading composer repositories with package information</div><div class="line">Updating dependencies (including require-dev)</div><div class="line">Your requirements could not be resolved to an installable set of packages.</div><div class="line"></div><div class="line">  Problem 1</div><div class="line">    - flarum/flarum-ext-akismet v0.1.0-beta.3 requires tijsverkoyen/akismet ^1.1 -&gt; satisfiable by tijsverkoyen/akismet[1.1.0].</div><div class="line">    - flarum/flarum-ext-akismet v0.1.0-beta.5 requires tijsverkoyen/akismet ^1.1 -&gt; satisfiable by tijsverkoyen/akismet[1.1.0].</div><div class="line">    - tijsverkoyen/akismet 1.1.0 requires ext-curl * -&gt; the requested PHP extension curl is missing from your system.</div><div class="line">    - Installation request for flarum/flarum-ext-akismet ^0.1.0 -&gt; satisfiable by flarum/flarum-ext-akismet[v0.1.0-beta.3, v0.1.0-beta.5].</div><div class="line"></div><div class="line">  To enable extensions, verify that they are enabled in those .ini files:</div><div class="line">    - /etc/php5/cli/php.ini</div><div class="line">    - /etc/php5/cli/conf.d/05-opcache.ini</div><div class="line">    - /etc/php5/cli/conf.d/10-pdo.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-json.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-mysql.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-mysqli.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-pdo_mysql.ini</div><div class="line">    - /etc/php5/cli/conf.d/20-readline.ini</div><div class="line">  You can also run `php --ini` inside terminal to see which files are used by PHP in CLI mode.</div></pre></td></tr></table></figure>
<p>è¿™æ—¶éœ€è¦å®‰è£…php-curlåï¼Œåˆ é™¤ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶(åŒ…æ‹¬.å¼€å¤´çš„éšè—æ–‡ä»¶)å†æ‰§è¡Œ<code>composer create-project flarum/flarum . --stability=beta</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install php5-curl</div></pre></td></tr></table></figure>
<p>æ­£å¸¸çš„å®‰è£…æ—¥å¿—åº”è¯¥å¥½é•¿å¥½é•¿ã€‚</p>
<p>è¿™æ—¶å·¥ç¨‹ç›®å½•ä¸­çš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/21/35/27-style1" alt=""></p>
<h1 id="ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®"><a href="#ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®" class="headerlink" title="ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®"></a>ä¸€äº›ä¿®æ”¹å’Œè®¾ç½®</h1><h2 id="ä¿®æ”¹æƒé™"><a href="#ä¿®æ”¹æƒé™" class="headerlink" title="ä¿®æ”¹æƒé™"></a>ä¿®æ”¹æƒé™</h2><p>å°†å·¥ç¨‹ç›®å½•å…¨éƒ¨æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„æƒé™ä¿®æ”¹ä¸º777.<br>å¦‚æˆ‘çš„æ˜¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod -R 777 /home/kiya/v2nb</div></pre></td></tr></table></figure>
<h2 id="å¼€å¯rewrite"><a href="#å¼€å¯rewrite" class="headerlink" title="å¼€å¯rewrite"></a>å¼€å¯rewrite</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /etc/apache2/mods-enabled</div><div class="line">sudo ln -s ../mods-available/rewrite.load</div></pre></td></tr></table></figure>
<h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><p>ä¿®æ”¹<code>/etc/apache2/sites-available/000-default.conf</code>æ–‡ä»¶ä¸­çš„DocumentRooté¡¹ä¸ºä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹è·¯å¾„. å¦‚<code>DocumentRoot /home/kiya/v2nb</code>.<br>å¹¶åœ¨è¯¥æ–‡ä»¶ä¸­çš„<code>VirtualHost</code>èŠ‚ç‚¹ä¹‹é—´æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /home/kiya/V2NB&gt;</div><div class="line">    AllowOverride All</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>åœ¨<code>/etc/apache2/apache2.conf</code>æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Directory /&gt;</div><div class="line">        Options FollowSymLinks</div><div class="line">        AllowOverride None</div><div class="line">        Require all denied</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>å°†<code>Require all denied</code>æ”¹ä¸º<code>Require all granted</code>,å°†<code>AllowOverride None</code>æ”¹ä¸º<code>AllowOverride All</code>.</p>
<h2 id="ä¿®æ”¹host"><a href="#ä¿®æ”¹host" class="headerlink" title="ä¿®æ”¹host"></a>ä¿®æ”¹host</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/hosts</div></pre></td></tr></table></figure>
<p>æ‰“å¼€hostsæ–°å¢åŠ ä¸€è¡Œ<code>23.105.197.243 v2nb.today</code>. è¿™é‡Œçš„ipæ˜¯vpsçš„ipï¼ŒåŸŸåéšä¾¿å†™. æœ¬æœºçš„è¯å¯ä»¥ipå¯ä»¥å†™æˆ<code>127.0.0.1</code>.<br>å¦‚æœè¿™é‡Œä¸åŠ åœ¨å¯åŠ¨apacheæœåŠ¡æ—¶ä¼šè­¦å‘Š:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AH00558: apache2: Could not reliably determine the server&apos;s fully qualified domain name, using v2nb.today. Set the &apos;ServerName&apos; directive globally to suppress this message</div></pre></td></tr></table></figure>
<h1 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h1><p>å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªè®ºå›ç”¨çš„æ•°æ®åº“,userå’Œpassæ—¶å®‰è£…mysqlæ—¶å¡«å†™çš„è´¦å·å¯†ç . å¾…ä¼šè¦ç”¨åˆ°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql -u user -p</div><div class="line">pass</div><div class="line">create database v2nb;</div></pre></td></tr></table></figure>
<h1 id="å®‰è£…flarum"><a href="#å®‰è£…flarum" class="headerlink" title="å®‰è£…flarum"></a>å®‰è£…flarum</h1><p>é‡å¯apacheæœåŠ¡.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service apache2 restart</div></pre></td></tr></table></figure>
<p>ç”¨æµè§ˆå™¨è®¿é—®<code>23.105.197.243</code>. å¦‚æœæ˜¯æœ¬åœ°æµ‹è¯•åˆ™è®¿é—®<code>localhost</code>.</p>
<p>å¦‚æœå‡ºç°çš„æ˜¯ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/39/41-style1" alt=""></p>
<p>åˆ™éœ€è¦å®‰è£…<code>gd</code>æ¨¡å—,æ‰§è¡Œ<code>sudo apt-get install php5-gd</code>é‡å¯apacheå³å¯.</p>
<p>æ­£ç¡®çš„è¯ä¼šå‡ºç°ä¸‹å›¾é¡µé¢ç”¨ä»¥å¡«å†™ä¿¡æ¯ï¼š</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/43/21-style1" alt=""></p>
<p>å…¶ä¸­çš„<code>MySQL Database</code>æ˜¯ä¸Šé¢æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„æ•°æ®åº“åå­—. å¡«å¥½ä¹‹åç‚¹å‡»<code>Install Flarum</code>.</p>
<p>å‡ºç°ä¸‹å›¾å°±å®‰è£…å¥½å•¦~</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/14/23/47/54-style1" alt=""></p>
<p>ç®¡ç†å‘˜ç•Œé¢:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/04/15/00/11/45-style1" alt=""></p>
<h1 id="è®¿é—®oops"><a href="#è®¿é—®oops" class="headerlink" title="è®¿é—®oops"></a>è®¿é—®oops</h1><p>åœ¨ä½¿ç”¨åŸŸåæ‰“å¼€è®ºå›æ—¶å¦‚æœç»å¸¸å‡ºç°<code>Oops! Something went wrong. Please reload the page and try again</code>å¹¶ä¸”èµ„æºä¹ŸåŠ è½½ä¸å‡º,å¯èƒ½æ˜¯è¯´æ˜è¯·æ±‚çš„urlå’Œé…ç½®çš„urlä¸ä¸€æ ·.<br>éœ€è¦ä¿®æ”¹å·¥ç¨‹ç›®å½•ä¸‹çš„<code>config.php</code>æ–‡ä»¶.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim config.php</div></pre></td></tr></table></figure>
<p>å¦‚å°†<code>&#39;url&#39; =&gt; &#39;23.105.197.243&#39;</code>æ”¹ä¸º<code>&#39;url&#39; =&gt; &#39;v2nb.today&#39;</code>.</p>
<h1 id="enjoy"><a href="#enjoy" class="headerlink" title="enjoy !"></a>enjoy !</h1><p>ç´¯ç…æˆ‘ä¹Ÿ.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å…ˆæ¥ä¸ªæˆå“å›¾è§‚èµè§‚èµï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="flarum" scheme="http://kiya.studio/categories/flarum/"/>
    
    
      <category term="instruction" scheme="http://kiya.studio/tags/instruction/"/>
    
  </entry>
  
  <entry>
    <title>ubuntuå¯åŠ¨idaæŠ¥é”™æ‰¾ä¸åˆ°libgthread-2.0.so.0</title>
    <link href="http://kiya.studio/2016/03/20/install-ia32-libs/"/>
    <id>http://kiya.studio/2016/03/20/install-ia32-libs/</id>
    <published>2016-03-20T08:32:52.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¢äº†ç”µè„‘æ–°è£…äº†ubuntu 15.04 64ä½ï¼Œå¯åŠ¨idaæ—¶æŠ¥é”™â€œError while loading shared libraries: libgthread-2.0.so.0â€ã€‚<br>è¿™æ˜¯å› ä¸ºidaéœ€è¦32ä½çš„åº“è€Œæˆ‘çš„ç³»ç»Ÿæ˜¯64ä½çš„ï¼Œæ‰€ä»¥è¦å®‰è£…32ä½çš„åº“ã€‚</p>
<a id="more"></a>
<p>è¯´ç¼ºå°‘libgthread-2.0.so.0é‚£æˆ‘å°±å…ˆå®‰è£…libgthread-2.0.so.0å‘—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dpkg -S libgthread-2.0.so.0</div><div class="line">sudo apt-get install libglib2.0-0:i386</div></pre></td></tr></table></figure>
<p>å®Œäº†å¯åŠ¨idaåˆæç¤ºç¼ºå°‘å¦ä¸€ä¸ªï¼Œå†å®‰åˆæç¤º..<br>å¾—äº†ï¼Œç›´æ¥æŠŠ32ä½çš„åº“éƒ½å®‰äº†å§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install ia32-libs</div></pre></td></tr></table></figure>
<p>ç„¶è€Œå¹¶æ²¡æœ‰æˆåŠŸï¼ŒæŠ¥é”™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">æ­£åœ¨è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨...å®Œæˆ</div><div class="line">æ­£åœ¨åˆ†æè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»æ ‘</div><div class="line">æ­£åœ¨è¯»å–çŠ¶æ€ä¿¡æ¯...å®Œæˆ</div><div class="line">ç°åœ¨æ²¡æœ‰å¯ç”¨çš„è½¯ä»¶åŒ… ia32-libsï¼Œä½†æ˜¯å®ƒè¢«å…¶å®ƒçš„è½¯ä»¶åŒ…å¼•ç”¨äº†ã€‚</div><div class="line">è¿™å¯èƒ½æ„å‘³ç€è¿™ä¸ªç¼ºå¤±çš„è½¯ä»¶åŒ…å¯èƒ½å·²ç»è¢«åºŸå¼ƒï¼Œ</div><div class="line">æˆ–è€…åªèƒ½åœ¨å…¶ä»–å‘å¸ƒæºä¸­æ‰¾åˆ°</div><div class="line">....</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dpkg --print-architecture</div><div class="line">dpkg --add-architecture i386</div><div class="line">apt-get update</div><div class="line">apt-get install iceweasel:i386</div></pre></td></tr></table></figure>
<p><strong>Reference</strong></p>
<p><a href="http://blog.tshine.me/ubuntu14-04-64%E4%BD%8D-%E5%AE%89%E8%A3%85-ia32-libs%E5%BA%93.html" target="_blank" rel="external">ubuntu14.04 64ä½ å®‰è£… ia32-libsåº“</a></p>
<p><a href="http://askubuntu.com/questions/427496/error-while-loading-shared-libraries-libgthread-2-0-so-0" target="_blank" rel="external">Error while loading shared libraries: libgthread-2.0.so.0</a></p>
<p><a href="http://blog.csdn.net/u011500307/article/details/11933739" target="_blank" rel="external">64ä½Ubuntuç³»ç»Ÿå®‰è£…32ä½å…¼å®¹åº“</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ¢äº†ç”µè„‘æ–°è£…äº†ubuntu 15.04 64ä½ï¼Œå¯åŠ¨idaæ—¶æŠ¥é”™â€œError while loading shared libraries: libgthread-2.0.so.0â€ã€‚&lt;br&gt;è¿™æ˜¯å› ä¸ºidaéœ€è¦32ä½çš„åº“è€Œæˆ‘çš„ç³»ç»Ÿæ˜¯64ä½çš„ï¼Œæ‰€ä»¥è¦å®‰è£…32ä½çš„åº“ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Ubuntu" scheme="http://kiya.studio/categories/Ubuntu/"/>
    
    
      <category term="ida" scheme="http://kiya.studio/tags/ida/"/>
    
  </entry>
  
  <entry>
    <title>æŸåŠ å›ºä¸­çš„åè°ƒè¯•</title>
    <link href="http://kiya.studio/2016/01/12/anti-debug-in-jiagubao/"/>
    <id>http://kiya.studio/2016/01/12/anti-debug-in-jiagubao/</id>
    <published>2016-01-12T02:23:31.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥æŸå¨æˆ¿ä¸ºä¾‹.</p>
<a id="more"></a>
<h1 id="åè°ƒè¯•å‡½æ•°"><a href="#åè°ƒè¯•å‡½æ•°" class="headerlink" title="åè°ƒè¯•å‡½æ•°"></a>åè°ƒè¯•å‡½æ•°</h1><p>ï¼ˆjiagu.soåŸºå€5287d000ï¼‰</p>
<p>åœ¨library load/unloadæ–­ä¸‹,åœ¨mmapå‡½æ•°å°¾éƒ¨ä¸‹æ–­ç‚¹,æ–­ä¸‹åf8æ‰§è¡Œå‡ å¥,å¯æ‰¾åˆ°<code>libjiagu.so:528855E4 BL      loc_5288308C</code>,è¿›å…¥åè°ƒè¯•.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/12/35/50" alt=""></p>
<p>å¾€ä¸‹æ‰§è¡Œçš„å…³é”®è·³è½¬æœ‰<br><strong>libjiagu.so:528830D0 BLX     LR     ; debug079:5287C000</strong><br><strong>debug079:5287C014 BLX     LR         ; loc_5288042C</strong><br><strong>debug079:5287C038 BLX     LR ; loc_52880614</strong></p>
<p><code>5287C000</code>æ˜¯ä¸€ä¸ªåè°ƒè¯•æ¨¡å—çš„èµ·å§‹.</p>
<p><code>libjiagu.so:loc_5288042C</code>å‡½æ•°ä½œç”¨æ˜¯æ‰“å¼€statusæ–‡ä»¶è·å¾—TracerPid,æ­¤å‡½æ•°åœ°å€ä¸å˜ å…¶ä¸­çš„ <strong>libjiagu.so:52880528 BL      open_0</strong> æ˜¯è°ƒç”¨<code>open</code>æ‰“å¼€<code>/proc/self/status</code>çš„.</p>
<p><code>loc_52880614</code>æ˜¯ç¬¬äºŒç§åè°ƒè¯•.</p>
<hr>
<h1 id="å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹"><a href="#å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹" class="headerlink" title="å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹"></a>å…·ä½“çš„åè°ƒè¯•è¿‡ç¨‹</h1><h2 id="è§£æstatusæ–‡ä»¶"><a href="#è§£æstatusæ–‡ä»¶" class="headerlink" title="è§£æstatusæ–‡ä»¶"></a>è§£æstatusæ–‡ä»¶</h2><h3 id="æ‰¾å‡º-TracerPid"><a href="#æ‰¾å‡º-TracerPid" class="headerlink" title="æ‰¾å‡º TracerPid"></a>æ‰¾å‡º TracerPid</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/33/10-style1" alt=""></p>
<h3 id="è½¬æ¢-TracerPid"><a href="#è½¬æ¢-TracerPid" class="headerlink" title="è½¬æ¢ TracerPid"></a>è½¬æ¢ TracerPid</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/19/37/38-style1" alt=""></p>
<h3 id="æ¯”è¾ƒ-TracerPid"><a href="#æ¯”è¾ƒ-TracerPid" class="headerlink" title="æ¯”è¾ƒ TracerPid"></a>æ¯”è¾ƒ TracerPid</h3><p>å¦‚æœ<code>TracerPid</code>ä¸ä¸º0,kill!</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/34/28-style1" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/34/47-style1" alt=""></p>
<h2 id="è§£æ-proc-net-tcpæ–‡ä»¶"><a href="#è§£æ-proc-net-tcpæ–‡ä»¶" class="headerlink" title="è§£æ/proc/net/tcpæ–‡ä»¶"></a>è§£æ/proc/net/tcpæ–‡ä»¶</h2><p>åœ¨æ¯”è¾ƒè¿‡<code>tracerid</code>å,æ¥ç€åˆè§£æäº†<code>tcp</code>æ–‡ä»¶.</p>
<h3 id="è°ƒç”¨å¤„"><a href="#è°ƒç”¨å¤„" class="headerlink" title="è°ƒç”¨å¤„"></a>è°ƒç”¨å¤„</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/12-style1" alt=""></p>
<h3 id="æ‰“å¼€æ–‡ä»¶"><a href="#æ‰“å¼€æ–‡ä»¶" class="headerlink" title="æ‰“å¼€æ–‡ä»¶"></a>æ‰“å¼€æ–‡ä»¶</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/33-style1" alt=""></p>
<h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2016/01/12/15/35/49-style1" alt=""></p>
<p>é€è¡Œæ¯”è¾ƒæ˜¯å¦å«æœ‰<code>00000000:5D8A</code>,5d8aå°±æ˜¯23946,<code>android_server</code>ç›‘å¬ç«¯å£å³ä¸º23946,0AçŠ¶æ€è¡¨ç¤ºç›‘å¬.<br>è¿™é‡Œr0ä¼šè¢«èµ‹ä¸º1ï¼Œè¿”å›è°ƒç”¨å¤„æ—¶è¿›ç¨‹å°±ä¼šè¢«kill.</p>
<p>å¦‚æœ¬æœºtcpæ–‡ä»¶ä¸­çš„å†…å®¹ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode                                                     </div><div class="line"> 0: 00000000:5D8A 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 42138 1 00000000 100 0 0 10 -1                            </div><div class="line"> 1: 00000000:15B3 00000000:0000 0A 00000000:00000000 00:00000000 00000000  2000        0 20426 1 00000000 100 0 0 10 -1                            </div><div class="line"> 2: 0100007F:91AF 0100007F:5D8A 01 00000000:00000000 00:00000000 00000000  2000        0 43283 1 00000000 21 4 2 10 -1                             </div><div class="line"> 3: ED01A8C0:15B3 EE01A8C0:E1B6 01 00000018:00000000 01:00000018 00000000  2000        0 20427 2 00000000 24 4 28 8 6                              </div><div class="line"> 4: 0100007F:5D8A 0100007F:91AF 01 00000000:00000000 02:00083C35 00000000     0        0 42634 2 00000000 22 4 3 10 -1</div></pre></td></tr></table></figure>
<hr>
<h1 id="ç»•è¿‡åè°ƒè¯•"><a href="#ç»•è¿‡åè°ƒè¯•" class="headerlink" title="ç»•è¿‡åè°ƒè¯•"></a>ç»•è¿‡åè°ƒè¯•</h1><p>å…³é”®æ–­ç‚¹æ˜¯:<code>libjiagu.so:loc_5288042C</code>,è¿”å›ä¹‹åå°±æ˜¯cmp.<br>ç¬¬äºŒç§åè°ƒè¯•<code>libjiagu.so:52880614</code>åœ¨cmpä¸‹é¢(è‹¥æœ‰).</p>
<p>æ–­ä¸‹ä¹‹ååœ¨lrå¯¹åº”çš„åœ°å€ä¸‹æ–­ç‚¹,f9ï¼Œå°†ä¸¤ä¸ªåè°ƒè¯•å‡½æ•°ä¸‹é¢çš„æ¯”è¾ƒçš„r0å€¼ä¿®æ”¹å°±å¯ä»¥äº†.</p>
<hr>
<h1 id="åè°ƒè¯•çš„patch"><a href="#åè°ƒè¯•çš„patch" class="headerlink" title="åè°ƒè¯•çš„patch"></a>åè°ƒè¯•çš„patch</h1><p>ä½†æ˜¯ä¸æ­¢ä¸€æ¬¡åè°ƒè¯•,æ¯æ¬¡çš„åœ°å€ä¹Ÿä¸åŒ,è€Œä¸”æ¯ä¸ªé‡‡ç”¨è¿™ç§åŠ å›ºçš„appéƒ½è¦å¦‚æ­¤,è¿™æ ·ä¹Ÿå¤ªä¸åˆ’ç®—äº†å§.æ—¢ç„¶å¦‚æ­¤,ä¸ºä»€ä¹ˆä¸patchä¸€ä¸‹å‘¢?</p>
<p>å°†<code>libjiagu.so</code>ä½œå¦‚ä¸‹ä¿®æ”¹å³å¯å»æ‰åè°ƒè¯•:(è¿”å›å€¼r0æ”¹ä¸º0,mov r0,#0)<br>æ–‡ä»¶åç§»<code>35EC</code>å¤„ -&gt; <code>04 00 A0 E1</code>æ”¹ä¸º<code>00 00 A0 E3</code><br>æ–‡ä»¶åç§»<code>3720</code>å¤„ -&gt; <code>01 00 A0 E3</code>æ”¹ä¸º<code>00 00 A0 E3</code></p>
<hr>
<p>æœ¬æ–‡å°ç™½é¼ : <a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/com.xiachufang_138.apk" target="_blank" rel="external">here</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://www.52pojie.cn/thread-435746-1-1.html" target="_blank" rel="external">xxxåŠ å›º ä¹‹ åŠ¨æ€è„±å£³</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥æŸå¨æˆ¿ä¸ºä¾‹.&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
      <category term="æŸåŠ å›º" scheme="http://kiya.studio/categories/Android-Security/%E6%9F%90%E5%8A%A0%E5%9B%BA/"/>
    
    
      <category term="anti-debug" scheme="http://kiya.studio/tags/anti-debug/"/>
    
      <category term="enforce" scheme="http://kiya.studio/tags/enforce/"/>
    
  </entry>
  
  <entry>
    <title>ç¬¬ä¸€ä¸ªxposedæ¨¡å—ä¸­çš„â€œClass ref in pre-verified class resolved to unexpected implementationâ€é”™è¯¯åŸå› </title>
    <link href="http://kiya.studio/2016/01/03/xposed-class-ispreverified/"/>
    <id>http://kiya.studio/2016/01/03/xposed-class-ispreverified/</id>
    <published>2016-01-03T14:43:53.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æˆ‘çš„<a href="http://kiya.space/2015/12/28/hello-xposed/" target="_blank" rel="external">ç¬¬ä¸€ä¸ª Xposed æ¨¡å—</a>ä¸­æ›¾å‡ºç°<code>Class ref in pre-verified class resolved to unexpected implementation</code>é”™è¯¯,Xposed logå¦‚ä¸‹ï¼š</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">01-03 19:42:03.974 134-134/? I/Xposed: Loading modules from /data/app/space.kiya.xposedtest-1.apk</div><div class="line">01-03 19:42:04.285 134-134/? I/Xposed:   Loading class space.kiya.xposedtest.ChangeStatusBar</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed: java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexFile.defineClass(Native Method)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexFile.loadClassBinaryName(DexFile.java:211)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.DexPathList.findClass(DexPathList.java:313)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:51)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at java.lang.ClassLoader.loadClass(ClassLoader.java:501)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at java.lang.ClassLoader.loadClass(ClassLoader.java:461)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.loadModule(XposedBridge.java:421)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.loadModules(XposedBridge.java:386)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at de.robv.android.xposed.XposedBridge.main(XposedBridge.java:120)</div><div class="line">01-03 19:42:04.298 134-134/? I/Xposed:     at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure>
<p>ä»ä¸­å¯ä»¥çœ‹åˆ°,å› ä¸ºXposedBridgeçš„mainå‡½æ•°è°ƒç”¨äº†loadModules,è€ŒloadModulesåˆè°ƒç”¨äº†loadModule,loadModuleè°ƒç”¨loadClass,è¿™æ ·ä¸€å±‚ä¸€å±‚ä¸‹å»æœ€ç»ˆå¯¼è‡´äº†ç°åœ¨çš„é”™è¯¯.<br>æˆ‘ä»¬å°±ä»æ¡ˆå‘ç°åœº<code>loadclass</code>å’Œé”™è¯¯ä¿¡æ¯<code>Class ref in pre-verified class resolved to unexpected implementation</code>å…¥æ‰‹å§ï¼</p>
<h1 id="æ¡ˆå‘ç°åœº-loadclass"><a href="#æ¡ˆå‘ç°åœº-loadclass" class="headerlink" title="æ¡ˆå‘ç°åœº loadclass"></a>æ¡ˆå‘ç°åœº loadclass</h1><p>æŠŠ<a href="https://github.com/rovo89/XposedBridge" target="_blank" rel="external">XposedBridgeçš„ä»£ç </a>cloneä¸‹æ¥,æ‰¾åˆ°<code>de/robv/android/xposed/XposedBridge</code>æ–‡ä»¶.</p>
<p>æˆ‘ä»¬çŸ¥é“<code>Xposed Installer</code>çš„ç•Œé¢æœ‰ä¸€ä¸ªæ¨¡å—åˆ—è¡¨,åœ¨å†™Xposedæ¨¡å—æ—¶ä¹Ÿéœ€è¦æ–°å»ºæ–‡ä»¶<code>xposed_init</code>å†™å…¥å®ç°äº†Xposedæ¥å£çš„ç±»å.</p>
<p>mainå‡½æ•°çš„ä½œç”¨å°±æ˜¯åˆå§‹åŒ–Xposedæ¡†æ¶å’Œæ¨¡å—,æ¨¡å—æ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„å‘¢?æ¥çœ‹loadModuleså‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Try to load all modules defined in &lt;code&gt;BASE_DIR/conf/modules.list&lt;/code&gt;</div><div class="line"> */</div><div class="line">private static void loadModules() throws IOException &#123;</div><div class="line">	final String filename = BASE_DIR + &quot;conf/modules.list&quot;;</div><div class="line">	BaseService service = SELinuxHelper.getAppDataFileService();</div><div class="line">	if (!service.checkFileExists(filename)) &#123;</div><div class="line">		Log.e(TAG, &quot;Cannot load any modules because &quot; + filename + &quot; was not found&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	InputStream stream = service.getFileInputStream(filename);</div><div class="line">	BufferedReader apks = new BufferedReader(new InputStreamReader(stream));</div><div class="line">	String apk;</div><div class="line">	while ((apk = apks.readLine()) != null) &#123;</div><div class="line">		loadModule(apk);</div><div class="line">	&#125;</div><div class="line">	apks.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>Xposed Installer</code>çš„å®‰è£…ç›®å½•<code>/data/data/de.robv.android.xposed.installer</code>ä¸‹çš„<code>conf</code>æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª<code>modules.list</code>æ–‡ä»¶,è®°å½•ç€æ¯ä¸ªxposedæ¨¡å—çš„apkçš„è·¯å¾„.<br><code>loadModules</code>å¯¹æ¯è¡Œ(ä¸€è¡Œå¯¹åº”ä¸€ä¸ªapkè·¯å¾„)è°ƒç”¨<code>loadModule</code>å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Load a module from an APK by calling the init(String) method for all classes defined</div><div class="line"> * in &lt;code&gt;assets/xposed_init&lt;/code&gt;.</div><div class="line"> */</div><div class="line">@SuppressWarnings(&quot;deprecation&quot;)</div><div class="line">private static void loadModule(String apk) &#123;</div><div class="line">	log(&quot;Loading modules from &quot; + apk);</div><div class="line"></div><div class="line">	if (!new File(apk).exists()) &#123;</div><div class="line">		log(&quot;  File does not exist&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ClassLoader mcl = new PathClassLoader(apk, BOOTCLASSLOADER);</div><div class="line">	InputStream is = mcl.getResourceAsStream(&quot;assets/xposed_init&quot;);</div><div class="line">	if (is == null) &#123;</div><div class="line">		log(&quot;assets/xposed_init not found in the APK&quot;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	BufferedReader moduleClassesReader = new BufferedReader(new InputStreamReader(is));</div><div class="line">	try &#123;</div><div class="line">		String moduleClassName;</div><div class="line">		while ((moduleClassName = moduleClassesReader.readLine()) != null) &#123;</div><div class="line">			moduleClassName = moduleClassName.trim();</div><div class="line">			if (moduleClassName.isEmpty() || moduleClassName.startsWith(&quot;#&quot;))</div><div class="line">				continue;</div><div class="line"></div><div class="line">			try &#123;</div><div class="line">				log (&quot;  Loading class &quot; + moduleClassName);</div><div class="line">				Class&lt;?&gt; moduleClass = mcl.loadClass(moduleClassName);</div><div class="line"></div><div class="line">				if (!IXposedMod.class.isAssignableFrom(moduleClass)) &#123;</div><div class="line">					log (&quot;    This class doesn&apos;t implement any sub-interface of IXposedMod, skipping it&quot;);</div><div class="line">					continue;</div><div class="line">				&#125; else if (disableResources &amp;&amp; IXposedHookInitPackageResources.class.isAssignableFrom(moduleClass)) &#123;</div><div class="line">					log (&quot;    This class requires resource-related hooks (which are disabled), skipping it.&quot;);</div><div class="line">					continue;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				final Object moduleInstance = moduleClass.newInstance();</div><div class="line">				if (isZygote) &#123;</div><div class="line">					if (moduleInstance instanceof IXposedHookZygoteInit) &#123;</div><div class="line">						IXposedHookZygoteInit.StartupParam param = new IXposedHookZygoteInit.StartupParam();</div><div class="line">						param.modulePath = apk;</div><div class="line">						param.startsSystemServer = startsSystemServer;</div><div class="line">						((IXposedHookZygoteInit) moduleInstance).initZygote(param);</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					if (moduleInstance instanceof IXposedHookLoadPackage)</div><div class="line">						hookLoadPackage(new IXposedHookLoadPackage.Wrapper((IXposedHookLoadPackage) moduleInstance));</div><div class="line"></div><div class="line">					if (moduleInstance instanceof IXposedHookInitPackageResources)</div><div class="line">						hookInitPackageResources(new IXposedHookInitPackageResources.Wrapper((IXposedHookInitPackageResources) moduleInstance));</div><div class="line">				&#125; else &#123;</div><div class="line">					if (moduleInstance instanceof IXposedHookCmdInit) &#123;</div><div class="line">						IXposedHookCmdInit.StartupParam param = new IXposedHookCmdInit.StartupParam();</div><div class="line">						param.modulePath = apk;</div><div class="line">						param.startClassName = startClassName;</div><div class="line">						((IXposedHookCmdInit) moduleInstance).initCmdApp(param);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125; catch (Throwable t) &#123;</div><div class="line">				log(t);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; catch (IOException e) &#123;</div><div class="line">		log(e);</div><div class="line">	&#125; finally &#123;</div><div class="line">		try &#123;</div><div class="line">			is.close();</div><div class="line">		&#125; catch (IOException ignored) &#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>loadModule</code>è¯»å–æ¯ä¸ªapkæ–‡ä»¶ä¸­çš„<code>assets/xposed_init</code>,ä½¿ç”¨<code>PathClassLoader</code>çš„<code>loadclass</code>æ–¹æ³•åŠ è½½æ¯ä¸ªæ³¨å†Œçš„ç±»,ç„¶åå°†ç±»çš„å®ä¾‹ä½œä¸ºç›¸åº”xposedæ¨¡å—çš„å›è°ƒ.</p>
<p>é‚£ä¹ˆ<code>Class&lt;?&gt; moduleClass = mcl.loadClass(moduleClassName);</code>è¿™å¥ä»£ç æ˜¯æ€ä¹ˆä¼šå‡ºé”™çš„å‘¢?</p>
<h1 id="ä½•æ–¹ç¥åœ£-CLASS-ISPREVERIFIED"><a href="#ä½•æ–¹ç¥åœ£-CLASS-ISPREVERIFIED" class="headerlink" title="ä½•æ–¹ç¥åœ£ CLASS_ISPREVERIFIED"></a>ä½•æ–¹ç¥åœ£ CLASS_ISPREVERIFIED</h1><p><code>CLASS_ISPREVERIFIED</code>æ˜¯è™šæ‹Ÿæœºåœ¨å¯¹dexæ–‡ä»¶ä¼˜åŒ–æ—¶çš„ä¸€ä¸ª<code>ClassFlags</code>,è¡¨ç¤ºæŸä¸ªç±»æ˜¯å¦å·²ç»è¢«é¢„éªŒè¯è¿‡.<br>ä¹Ÿå°±æ˜¯è¯´å½“æŸä¸ªç±»ä¸­å¼•ç”¨çš„æ–¹æ³•å…¨éƒ¨æ¥è‡ªæ‰€åœ¨çš„dexæ–‡ä»¶ä¸­æ—¶,è¿™ä¸ªç±»å°±ä¼šè¢«æ‰“ä¸Šè¿™ä¸ªæ ‡è®°.<br>è‹¥appæœ‰å¤šä¸ªdexæ–‡ä»¶æ—¶,å½“å¼•ç”¨äº†æŸä¸ªå¸¦æœ‰è¿™ä¸ªæ ‡è®°çš„ç±»æ—¶,è™šæ‹Ÿæœºä¸éœ€è¦åœ¨å…¨éƒ¨çš„dexæ–‡ä»¶ä¸­æŸ¥æ‰¾,ä»è€Œå¸®åŠ©æé«˜dalvikè™šæ‹Ÿæœºçš„æ€§èƒ½.</p>
<p>å…³äºå¦‚ä½•éªŒè¯çš„ç»†èŠ‚ç¨ååˆ†æ.</p>
<p>æˆ‘ä»¬å†™çš„<code>ChangeStatusBar</code>ç±»å®ç°äº†<code>IXposedHookLoadPackage</code>,åŒæ—¶jaråŒ…çš„å¼•ç”¨æ–¹å¼ä¸º<code>compile</code>,æ‰€ä»¥ä¹ŸæŠŠXposedBridge.jarç¼–è¯‘è¿›dexäº†,å› æ­¤åœ¨éªŒè¯<code>ChangeStatusBar</code>ç±»æ—¶åœ¨æœ¬dexä¸­å¯ä»¥æ‰¾åˆ°<code>IXposedHookLoadPackage</code>ä»è€Œè¢«æ ‡è®°äº†<code>CLASS_ISPREVERIFIED</code>.</p>
<p><strong>é‚£ä¹ˆæ˜¯åœ¨å“ªé‡Œæ£€æŸ¥æ˜¯å¦æœ‰CLASS_ISPREVERIFIEDæ ‡è®°çš„å‘¢ï¼Ÿ</strong></p>
<p>æºä»£ç æ–‡ä»¶<a href="http://androidxref.com/4.4.4_r1/xref/dalvik/vm/oo/Resolve.cpp#119" target="_blank" rel="external">/dalvik/vm/oo/Resolve.cpp</a>çš„<code>dvmResolveClass</code>å‡½æ•°ä¸­:æœ‰è¿™ä¹ˆä¸€æ®µä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">if (!fromUnverifiedConstant &amp;&amp; IS_CLASS_FLAG_SET(referrer, CLASS_ISPREVERIFIED))</div><div class="line">&#123;</div><div class="line">    ClassObject* resClassCheck = resClass;</div><div class="line">    if (dvmIsArrayClass(resClassCheck))</div><div class="line">        resClassCheck = resClassCheck-&gt;elementClass;</div><div class="line"></div><div class="line">    if (referrer-&gt;pDvmDex != resClassCheck-&gt;pDvmDex &amp;&amp;</div><div class="line">        resClassCheck-&gt;classLoader != NULL)</div><div class="line">    &#123;</div><div class="line">        ALOGW(&quot;Class resolved by unexpected DEX:&quot;</div><div class="line">             &quot; %s(%p):%p ref [%s] %s(%p):%p&quot;,</div><div class="line">            referrer-&gt;descriptor, referrer-&gt;classLoader,</div><div class="line">            referrer-&gt;pDvmDex,</div><div class="line">            resClass-&gt;descriptor, resClassCheck-&gt;descriptor,</div><div class="line">            resClassCheck-&gt;classLoader, resClassCheck-&gt;pDvmDex);</div><div class="line">        ALOGW(&quot;(%s had used a different %s during pre-verification)&quot;,</div><div class="line">            referrer-&gt;descriptor, resClass-&gt;descriptor);</div><div class="line">        dvmThrowIllegalAccessError(</div><div class="line">            &quot;Class ref in pre-verified class resolved to unexpected &quot;</div><div class="line">            &quot;implementation&quot;);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“è™šæ‹Ÿæœºæ‰¾åˆ°éœ€è¦å¼•ç”¨çš„ç±»æ—¶,å¦‚æœå¼•ç”¨è€…å·²ç»è¢«é¢„éªŒè¯è¿‡,ä¸”å¼•ç”¨è€…æ‰€åœ¨çš„dexå’Œè¢«å¼•ç”¨è€…æ‰€åœ¨çš„dexä¸åŒæ—¶,æŠ›å‡º<code>Class ref in pre-verified class ...</code>å¼‚å¸¸!</p>
<p>è€Œåœ¨æˆ‘çš„<a href="http://kiya.space/2015/12/28/hello-xposed/" target="_blank" rel="external">ç¬¬ä¸€ä¸ª Xposed æ¨¡å—</a>å‡ºç°é”™è¯¯æ—¶dalvikçš„logå¦‚ä¸‹(ç»è¿‡å‰ªåˆ‡):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01-04 20:11:03.463 134-134/? W/dalvikvm: Class resolved by unexpected DEX: Lspace/kiya/xposedtest/ChangeStatusBar;(0x40e59fc8):0x5028f000 ref [Lde/robv/android/xposed/IXposedHookLoadPackage;] Lde/robv/android/xposed/IXposedHookLoadPackage;(0x40da2fd0):0x4f2f8000</div><div class="line">01-04 20:14:06.184 134-134/? W/dalvikvm: (Lspace/kiya/xposedtest/ChangeStatusBar; had used a different Lde/robv/android/xposed/IXposedHookLoadPackage; during pre-verification)</div><div class="line"></div><div class="line">01-04 20:11:03.467 134-134/? W/dalvikvm: Class resolved by unexpected DEX: Lspace/kiya/xposedtest/GetQQPassword;(0x40e59fc8):0x5028f000 ref [Lde/robv/android/xposed/IXposedHookLoadPackage;] Lde/robv/android/xposed/IXposedHookLoadPackage;(0x40da2fd0):0x4f2f8000</div><div class="line">01-04 20:14:06.187 134-134/? W/dalvikvm: (Lspace/kiya/xposedtest/GetQQPassword; had used a different Lde/robv/android/xposed/IXposedHookLoadPackage; during pre-verification)</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨<code>loadclass</code>æ—¶çš„å¼•ç”¨è€…æ˜¯<code>Lspace/kiya/xposedtest/ChangeStatusBar</code>,è¢«å¼•ç”¨è€…æ˜¯<code>Lde/robv/android/xposed/IXposedHookLoadPackage</code>.<br>(è§£æç±»çš„è¿‡ç¨‹åŒ…æ‹¬ç±»çš„æ‰€æœ‰å¼•ç”¨çš„æ£€æŸ¥,è¿™é‡Œé—®é¢˜æ˜¯å‡ºåœ¨æ¨¡å—ç±»å¼•ç”¨å…¶ä»–ç±»æ—¶è€ŒéxposedåŠ è½½æ¨¡å—ç±»æ—¶,æ•…å¼•ç”¨è€…æ˜¯è¢«åŠ è½½çš„æ¨¡å—ç±»)</p>
<p>dalvikè§£æçš„æ—¶å€™å‘ç°<code>IXposedHookLoadPackage</code>å’Œ<code>ChangeStatusBar</code>ä¸åœ¨ä¸€ä¸ªdexæ–‡ä»¶å†…,ä½†æ˜¯<code>ChangeStatusBar</code>ç±»å·²ç»è¢«æ ¡éªŒè¿‡äº†å‘€,é‡Œé¢æ‰€æœ‰çš„æ–¹æ³•éƒ½åœ¨æœ¬dexå†…,ç°åœ¨åˆå‘Šè¯‰æˆ‘ä¸åœ¨ä¸€èµ·äº†,é‚£è‚¯å®šè¦æŠ¥é”™äº†!</p>
<p>å’Œä¸Šä¸€å°èŠ‚çš„é—®é¢˜ç»“åˆèµ·æ¥,å¿…ç„¶æ˜¯<code>loadclass</code>åŠ è½½ç±»çš„åŒæ—¶åšäº†éªŒè¯!æ˜¯å¦æ˜¯è¿™æ ·æˆ‘ä»¬éšåå†éªŒè¯.</p>
<p>ç°åœ¨çš„é—®é¢˜æ˜¯æ˜æ˜<code>ChangeStatusBar</code>å·²ç»é€šè¿‡äº†æ ¡éªŒ,<code>IXposedHookLoadPackage</code>å’Œ<code>ChangeStatusBar</code>åœ¨åŒä¸€ä¸ªdexä¸­,æ€ä¹ˆåŠ è½½æ—¶<code>IXposedHookLoadPackage</code>åˆä¸åœ¨è¿™é‡Œäº†?</p>
<h1 id="ç½ªé­ç¥¸é¦–-PathClassLoader"><a href="#ç½ªé­ç¥¸é¦–-PathClassLoader" class="headerlink" title="ç½ªé­ç¥¸é¦– PathClassLoader"></a>ç½ªé­ç¥¸é¦– PathClassLoader</h1><p>è¿™å°±è¦è¯´è¯´PathClassLoaderäº†.</p>
<p><code>XposedBridge</code>æºç ä¸­ä½¿ç”¨çš„ç±»åŠ è½½å™¨å°±æ˜¯PathClassLoader.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public static final ClassLoader BOOTCLASSLOADER = ClassLoader.getSystemClassLoader();</div><div class="line">ClassLoader mcl = new PathClassLoader(apk, BOOTCLASSLOADER);</div></pre></td></tr></table></figure>
<p>å…¶ä¸­apkæ˜¯æ¨¡å—apkçš„è·¯å¾„;BOOTCLASSLOADERæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨çš„å®ä¾‹,ä»classpathä¸­åŠ è½½ç±».</p>
<blockquote>
<p>loadClassæ–¹æ³•åœ¨åŠ è½½ä¸€ä¸ªç±»çš„å®ä¾‹çš„æ—¶å€™ï¼Œ<br>ä¼šå…ˆæŸ¥è¯¢å½“å‰ClassLoaderå®ä¾‹æ˜¯å¦åŠ è½½è¿‡æ­¤ç±»ï¼Œæœ‰å°±è¿”å›ï¼›<br>å¦‚æœæ²¡æœ‰ã€‚æŸ¥è¯¢Parentæ˜¯å¦å·²ç»åŠ è½½è¿‡æ­¤ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œå°±ç›´æ¥è¿”å›ParentåŠ è½½çš„ç±»ï¼›<br>å¦‚æœç»§æ‰¿è·¯çº¿ä¸Šçš„ClassLoaderéƒ½æ²¡æœ‰åŠ è½½ï¼Œæ‰ç”±Childæ‰§è¡Œç±»çš„åŠ è½½å·¥ä½œï¼›</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„<code>apk</code>æ˜¯æœ€åä¸€ä¸ªè¢«æŸ¥æ‰¾çš„è·¯å¾„.</p>
<p>è€Œåœ¨<code>Xposed</code>æºç ä¸­çš„<code>app_main.cpp</code>(è¢«ä¿®æ”¹è¿‡çš„app_process)è°ƒç”¨äº†<code>xposed::initialize(zygote, startSystemServer, className, argc, argv)</code>,<code>initialize</code>ä¸­åˆè°ƒç”¨äº†<code>addJarToClasspath()</code>,åŠŸèƒ½å°±æ˜¯å°†<code>XposedBridge.jar</code>æ·»åŠ åˆ°Java classpath!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#define XPOSED_JAR               &quot;/system/framework/XposedBridge.jar&quot;</div><div class="line">/** Add XposedBridge.jar to the Java classpath. */</div><div class="line">bool addJarToClasspath() &#123;</div><div class="line">    ALOGI(&quot;-----------------&quot;);</div><div class="line"></div><div class="line">    if (access(XPOSED_JAR, R_OK) == 0) &#123;</div><div class="line">        if (!addPathToEnv(&quot;CLASSPATH&quot;, XPOSED_JAR))</div><div class="line">            return false;</div><div class="line"></div><div class="line">        ALOGI(&quot;Added Xposed (%s) to CLASSPATH&quot;, XPOSED_JAR);</div><div class="line">        return true;</div><div class="line">    &#125; else &#123;</div><div class="line">        ALOGE(&quot;ERROR: Could not access Xposed jar &apos;%s&apos;&quot;, XPOSED_JAR);</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥<code>loadclass</code>åœ¨æ£€æŸ¥<code>apk</code>è·¯å¾„ä¹‹å‰ç³»ç»Ÿç±»åŠ è½½å™¨å°±åœ¨ç³»ç»Ÿç±»è·¯å¾„ä¸­çš„<code>XposedBridge.jar</code>ä¸­æ‰¾åˆ°äº†<code>IXposedHookLoadPackage</code>,è™½ç„¶æˆ‘ä»¬çš„apkä¸­ä¹Ÿæœ‰è¿™ä¸ªå‡½æ•°,ä½†æ˜¯è¿˜æ²¡æœ‰ç­‰åˆ°åŠ è½½å°±å·²ç»ç»“æŸäº†.</p>
<p>åˆ°è¿™é‡Œå°±å¯ä»¥ç†æ¸…é”™è¯¯ä¸ºä»€ä¹ˆå‘ç”Ÿäº†:</p>
<ol>
<li>ç¼–å†™æ¨¡å—æ—¶æˆ‘ä»¬æŠŠ<code>XposedBridge.jar</code>ç¼–è¯‘è¿›äº†dexæ–‡ä»¶ä¸­;</li>
<li>dalvikåœ¨ä¼˜åŒ–dexæ—¶ä¸ºæ¨¡å—ç±»æ‰“ä¸Šäº†<code>CLASS_ISPREVERIFIED</code>æ ‡è®°,è¡¨ç¤ºæ²¡æœ‰å¼•ç”¨çš„ç±»å…¨éƒ¨æ¥è‡ªæœ¬dex;</li>
<li>xposedæ¡†æ¶ä¿®æ”¹åçš„app_processä¼šåœ¨å¼€æœºæ—¶å°†<code>/system/framework/XposedBridge.jar</code>åŠ å…¥ç±»è·¯å¾„;</li>
<li>éšåxposedè¦åŠ è½½æˆ‘ä»¬æ³¨å†Œçš„æ¨¡å—ç±»,åœ¨äº‹å…ˆä¸ºå…¶å‡†å¤‡å¥½çš„jaråŒ…ä¸­æ‰¾åˆ°äº†å¼•ç”¨çš„ç±»;</li>
<li>ä½†æ˜¯æ¨¡å—ç±»è¢«æ‰“ä¸Šæ ‡è®°äº†,xposedå‘ç°æ¨¡å—å°±æ²¡æ‰“ç®—ç”¨è‡ªå·±å‡†å¤‡å¥½çš„ç±»,åè€Œè¦è‡ªç»™è‡ªè¶³,è¿™å“ªæ˜¯æ¡†æ¶å’Œæ¨¡å—çš„å…³ç³»!ç®€ç›´æ˜¯é€ å!äºæ˜¯æ„¤è€ŒæŠ¥é”™.</li>
</ol>
<p>å‰é¢ä¹Ÿæåˆ°è§£å†³æ–¹æ³•å°±æ˜¯ä¸å°†<code>XposedBridge.jar</code>ç¼–è¯‘è¿›dexå³å¯,è¿™æ ·ä¸ä¼šè¢«æ‰“ä¸Šæ ‡è®°,ä¸‡äº‹ok.<br>ç°åœ¨appçš„çƒ­ä¿®å¤åŸç†ä¹Ÿæ˜¯è¿™æ ·.</p>
<h1 id="å‡Œæ™¨4ç‚¹-startvm"><a href="#å‡Œæ™¨4ç‚¹-startvm" class="headerlink" title="å‡Œæ™¨4ç‚¹ startvm"></a>å‡Œæ™¨4ç‚¹ startvm</h1><p>åˆ°äº†ç°åœ¨,å¦‚æœä¸åœ¨æ„ä¸€äº›ç»†èŠ‚,æœ¬æ¡ˆå·²ç»è¢«ç ´!</p>
<p>ä¹‹å‰è¯´åˆ°,å½“ç±»åŠ è½½å™¨è°ƒç”¨<code>loadclass</code>åŠ è½½ç±»æ—¶å‘ç°<code>ChangeStatusBar</code>ç±»å·²ç»è¢«æ ¡éªŒè¿‡â€¦<br>ç­‰ç­‰!æˆ‘ä»¬çš„XposedBridgeåŠ è½½æ¨¡å—ç±»çš„ä»£ç æ˜¯åœ¨app_processä¸­å‘€,è€Œæ ¡éªŒæ˜¯å±äºdexopt(dexä¼˜åŒ–)çš„æ­¥éª¤å“‡,éš¾é“dexä¼˜åŒ–æ¯”app_processè¿™ä¸ªå¯åŠ¨ä»£ç è¿˜è¦æ—©?</p>
<p>é‚£ä¹ˆé—®é¢˜å°±æ¸…æ™°å¤šäº†: <strong>app_process å’Œ dexopt çš„å…³ç³»</strong>.</p>
<p>ä¸€ä¸ªappå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªapp_processè¿›ç¨‹,app_processçš„ä½œç”¨å¦‚ä¸‹:</p>
<ol>
<li>åˆ›å»ºjvm</li>
<li>æ‰§è¡ŒstartClassçš„mainæ–¹æ³•</li>
</ol>
<p><code>app_main.cpp</code>ä¸­çš„éƒ¨åˆ†æ·»åŠ ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#define XPOSED_CLASS_DOTS_ZYGOTE &quot;de.robv.android.xposed.XposedBridge&quot;</div><div class="line">isXposedLoaded = xposed::initialize(zygote, startSystemServer, className, argc, argv);</div><div class="line">if (zygote) &#123;</div><div class="line">    runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_ZYGOTE : &quot;com.android.internal.os.ZygoteInit&quot;,</div><div class="line">            startSystemServer ? &quot;start-system-server&quot; : &quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>initialize</code>åœ¨ä¸Šé¢æåˆ°è¿‡,è€Œ<code>runtime.start</code>å°±æ˜¯androidæºç <a href="http://androidxref.com/4.4.4_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#805" target="_blank" rel="external">/frameworks/base/core/jni/AndroidRuntime.cpp</a>ä¸­çš„<code>AndroidRuntime::start</code>å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Start the Android runtime.  This involves starting the virtual machine</div><div class="line"> * and calling the &quot;static void main(String[] args)&quot; method in the class</div><div class="line"> * named by &quot;className&quot;.</div><div class="line"> *</div><div class="line"> * Passes the main function two arguments, the class name and the specified</div><div class="line"> * options string.</div><div class="line"> */</div><div class="line">void AndroidRuntime::start(const char* className, const char* options)</div></pre></td></tr></table></figure>
<p><strong>æ­¤å‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯:</strong> å¯åŠ¨è™šæ‹Ÿæœº,æ‰§è¡Œä¼ å…¥ç±»çš„mainå‡½æ•°<br><strong>æµç¨‹:</strong> AndroidRuntime::start -&gt; startvm -&gt; æ‰§è¡Œä¼ å…¥çš„ç±»çš„mainå‡½æ•°<br>æœ¬æ¡ˆä¸­ä¼ å…¥çš„ç±»æ˜¯<code>de.robv.android.xposed.XposedBridge</code>.</p>
<p>è€Œstartvmä¸­åˆæ‰§è¡Œäº†ä»€ä¹ˆå‘¢?<br>startvm -&gt; JNI_CreateJavaVM -&gt; dvmStartup -&gt; dvmClassStartup -&gt; â€¦ -&gt; ç›´åˆ°ä¼˜åŒ–dexæ—¶éªŒè¯class</p>
<p>====&gt; å› æ­¤å½“XposedBridgeçš„mainå‡½æ•°æ‰§è¡Œæ—¶,dexä¸­çš„å„ä¸ªç±»å·²ç»è¢«verifyè¿‡äº†.æˆ‘ä»¬çš„çŒœæƒ³æ˜¯å¯¹å“©.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://bugly.qq.com/blog/?p=781" target="_blank" rel="external">ã€æ–°æŠ€èƒ½getã€‘è®©AppåƒWebä¸€æ ·å‘å¸ƒæ–°ç‰ˆæœ¬</a></p>
<p><a href="http://gold.xitu.io/entry/564ab7eb60b259caed3827f1" target="_blank" rel="external">Android çƒ­è¡¥ä¸åŠ¨æ€ä¿®å¤æ¡†æ¶å°ç»“</a></p>
<p><a href="http://segmentfault.com/a/1190000004062880" target="_blank" rel="external">AndroidåŠ¨æ€åŠ è½½åŸºç¡€ ClassLoaderå·¥ä½œæœºåˆ¶</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨æˆ‘çš„&lt;a href=&quot;http://kiya.space/2015/12/28/hello-xposed/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ç¬¬ä¸€ä¸ª Xposed æ¨¡å—&lt;/a&gt;ä¸­æ›¾å‡ºç°&lt;code&gt;Class ref in pre-verified class resolved to unexpected implementation&lt;/code&gt;é”™è¯¯,Xposed logå¦‚ä¸‹ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="Xposed" scheme="http://kiya.studio/tags/Xposed/"/>
    
  </entry>
  
  <entry>
    <title>ç¬¬ä¸€ä¸ª Xposed æ¨¡å—</title>
    <link href="http://kiya.studio/2015/12/28/hello-xposed/"/>
    <id>http://kiya.studio/2015/12/28/hello-xposed/</id>
    <published>2015-12-28T15:43:37.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç¯å¢ƒ:<br>å·²rootæ‰‹æœºä¸€æš(Android 4.4.4)<br>Android Studioä¸€æš</p>
<a id="more"></a>
<p>å®˜æ–¹æ–‡æ¡£å‚è€ƒ<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial-style1" target="_blank" rel="external">è¿™é‡Œ</a>.</p>
<h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>æˆ‘ä»¬éœ€è¦äº‹å…ˆä¸‹è½½ä¸€ä¸ª<a href="http://dl-xda.xposed.info/modules/de.robv.android.xposed.installer_v33_36570c.apk-style1" target="_blank" rel="external">Xposed installer</a>å®‰è£…åœ¨æ‰‹æœºä¸Š,ç”¨æ¥ç®¡ç†æ‰€æœ‰çš„æ¨¡å—.</p>
<p>å®‰è£…å®Œæˆåæ‰“å¼€:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/02-style1" alt=""></p>
<p>ç‚¹å‡»<code>æ¡†æ¶</code>,</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/32-style1" alt=""></p>
<p>ç‚¹å‡»<code>å®‰è£…/æ›´æ–°</code>å®‰è£…æ¡†æ¶,</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/53/49-style1" alt=""></p>
<p>ç‚¹å‡»ç¡®å®šé‡å¯,æ¡†æ¶ç•Œé¢æ˜¯è¿™æ ·çš„:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/54/11-style1" alt=""></p>
<h1 id="ç¼–å†™æ–°æ¨¡å—"><a href="#ç¼–å†™æ–°æ¨¡å—" class="headerlink" title="ç¼–å†™æ–°æ¨¡å—"></a>ç¼–å†™æ–°æ¨¡å—</h1><p>æ‰“å¼€android studio,æ–°å»ºå·¥ç¨‹,é€‰æ‹©<code>Add no activity</code></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/09/54/35-style1" alt=""></p>
<p>æ–°å»ºå®Œæˆå,æ‰¾åˆ°<code>app</code>ç›®å½•ä¸‹çš„<code>build.gradle</code>æ–‡ä»¶,å°†<code>dependencies</code>ä¸­çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div></pre></td></tr></table></figure>
<p>æ”¹ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">provided fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div></pre></td></tr></table></figure>
<p>ä¸‹è½½<a href="http://forum.xda-developers.com/attachment.php?attachmentid=2748878&amp;d=1400342298-style1" target="_blank" rel="external">XposedBridgeApi-54.jar</a>å¹¶æ”¾å…¥appç›®å½•ä¸‹çš„libsæ–‡ä»¶å¤¹.</p>
<p>åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶çš„<code>application</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ,å…¶ä¸­çš„54æ˜¯å‰é¢ä¸‹è½½çš„æ–‡ä»¶ä¸­çš„å·ç .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposedmodule&quot;</div><div class="line">    android:value=&quot;true&quot; /&gt;</div><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposeddescription&quot;</div><div class="line">    android:value=&quot;kiya&apos;s test module&quot; /&gt;</div><div class="line">&lt;meta-data</div><div class="line">    android:name=&quot;xposedminversion&quot;</div><div class="line">    android:value=&quot;54&quot; /&gt;</div></pre></td></tr></table></figure>
<p>æ–°å»ºä¸€ä¸ª<code>Test</code>ç±»,å†™å…¥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">package space.kiya.xposedtest;</div><div class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</div><div class="line">import de.robv.android.xposed.XposedBridge;</div><div class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</div><div class="line"></div><div class="line">public class Test implements IXposedHookLoadPackage&#123;</div><div class="line">    @Override public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123;</div><div class="line">        XposedBridge.log(&quot;loaded: &quot; + loadPackageParam.packageName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–°å»º<code>assets</code>æ–‡ä»¶å¤¹,åœ¨é‡Œé¢æ–°å»ºæ–‡ä»¶åä¸º<code>xposed_init</code>,å†™å…¥åˆšåˆšçš„ç±»å,æ­¤å¤„åº”ä¸º<code>space.kiya.xposedtest.Test</code>.</p>
<p>è¿™æ—¶å°±å¯ä»¥ç¼–è¯‘å®‰è£…äº†.</p>
<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>å› ä¸ºå·¥ç¨‹æ²¡æœ‰activity,æ‰€ä»¥åœ¨æ¡Œé¢ä¸Šçœ‹ä¸åˆ°è¯¥åº”ç”¨ã€‚<br>æ¥åˆ°<code>xposed installer</code>çš„<code>æ¨¡å—</code>ä¸­,å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æ¨¡å—å‡ºç°åœ¨è¿™é‡Œ,ç°åœ¨å‹¾é€‰å®ƒ:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/10/17/03-style1" alt=""></p>
<p>åœ¨é‡å¯ä½¿ä¹‹ç”Ÿæ•ˆä¹‹å‰,æˆ‘ä»¬åœ¨logcatæ–°å»ºä¸€ä¸ªtagä¸º<code>Xposed</code>çš„è¿‡æ»¤å™¨,è¿™æ ·å°±å¯ä»¥è¿‡æ»¤å‡ºæ¨¡å—è¾“å‡ºçš„log.<br>å¤§æ¦‚æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Loading Xposed v54(for Zygote)...</div><div class="line">Loading modules from /data/app/space.kiya.xposedtest-1.apk</div><div class="line">  Loading class space.kiya.xposedtest.Test</div><div class="line">Loaded: android</div><div class="line">...</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„æ—¥å¿—åœ¨<code>xposed installer</code>çš„<code>æ—¥å¿—</code>ä¸­ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°çš„.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/10/16/42-style1" alt=""></p>
<h1 id="å¯èƒ½å‡ºç°çš„é”™è¯¯"><a href="#å¯èƒ½å‡ºç°çš„é”™è¯¯" class="headerlink" title="å¯èƒ½å‡ºç°çš„é”™è¯¯"></a>å¯èƒ½å‡ºç°çš„é”™è¯¯</h1><p>å¦‚æœè¾“å‡ºçš„logä¸­å‡ºç°äº†å¦‚ä¸‹é”™è¯¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</div></pre></td></tr></table></figure>
<p>è¯´æ˜æ˜¯å‰é¢æ­¥éª¤ä¸­æ²¡æœ‰ä¿®æ”¹<code>build.gradle</code>å¯¼è‡´çš„.</p>
<p>å…·ä½“åŸå› è§<a href="http://kiya.space/2016/01/03/xposed-class-ispreverified/" target="_blank" rel="external">å¦ä¸€ç¯‡åšå®¢</a>.</p>
<h1 id="xposedæ€æ ·å·¥ä½œ"><a href="#xposedæ€æ ·å·¥ä½œ" class="headerlink" title="xposedæ€æ ·å·¥ä½œ?"></a>xposedæ€æ ·å·¥ä½œ?</h1><p>å¼€æœºæ—¶,<code>./init.rc</code>è„šæœ¬æ–‡ä»¶ä¼šå¯åŠ¨<code>Zygote</code>è¿›ç¨‹,Zygoteå¯¹åº”çš„å…·ä½“ç¨‹åºæ˜¯<code>/system/bin/app_process</code>,ç„¶ååŠ è½½éœ€è¦çš„ç±»,è°ƒç”¨åˆå§‹åŒ–çš„æ–¹æ³•,ä¹‹åå¯åŠ¨çš„æ¯ä¸ªåº”ç”¨éƒ½æ˜¯Zygoteçš„æ‹·è´,æ‰€ä»¥Zygoteè¿›ç¨‹æ˜¯ååˆ†é‡è¦çš„.</p>
<p>é€šè¿‡åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä¸€ä¸ªjaråŒ…,åœ¨<code>app_process</code>çš„ç‰¹å®šä½ç½®è°ƒç”¨jaråŒ…ä¸­çš„æ–¹æ³•,Xposedæ¡†æ¶å®ç°äº†å¸¦æ‰©å±•åŠŸèƒ½çš„<code>app_process</code>,ç„¶åå°†åŸæœ‰çš„<code>app_process</code>æ›¿æ¢æ‰.<br>åœ¨<code>/data/data/de.robv.android.xposed.installer/bin/</code>ç›®å½•ä¸‹æœ‰ä¸€ä¸ª<code>XposedBridge.jar</code>æ–‡ä»¶,å®ƒå°±æ˜¯è¢«å¼•ç”¨çš„jaråŒ…,æºç åœ¨<a href="https://github.com/rovo89/XposedBridge-style1" target="_blank" rel="external">github</a>,mainå‡½æ•°åœ¨<code>/src/de/robv/android/xposed/XposedBridge.java</code>ä¸­,æ¯ä¸ªè¿›ç¨‹æ¯æ¬¡å¯åŠ¨æ—¶éƒ½ä¼šè¢«è°ƒç”¨.åŠ è½½æ¨¡å—çš„åŠŸèƒ½ä¹Ÿæ˜¯åœ¨è¿™é‡Œå®ç°.</p>
<p>XposedçœŸæ­£å¼ºå¤§çš„æ˜¯å®ƒå¯ä»¥hookè°ƒç”¨çš„æ–¹æ³•.å½“ä½ åç¼–è¯‘ä¿®æ”¹apkæ—¶,ä½ å¯ä»¥åœ¨é‡Œé¢æ’å…¥xposedçš„å‘½ä»¤,äºæ˜¯ä½ å°±å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨å‰åæ³¨å…¥è‡ªå·±çš„ä»£ç .</p>
<p>XposedBridgeæœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°æ–¹æ³•<code>hookMethodNative</code>,ä»£ç å®ç°æ”¾åœ¨<code>app_process</code>ä¸­.åœ¨è°ƒç”¨è¢«hookçš„æ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨æ­¤æ–¹æ³•,<code>hookMethodNative</code>æœ‰ä¸€ä¸ª<code>handleHookedMethod</code>æ–¹æ³•,å¯ä»¥ä¿®æ”¹ä¼ é€’ç»™è¢«hookå‡½æ•°çš„å‚æ•°,å˜é‡ç”šè‡³æ˜¯è°ƒç”¨å…¶ä»–æ–¹æ³•.</p>
<h1 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h1><p>ä»¥ä¸Šä»…ä»…æ˜¯è¯æ˜äº†æˆ‘ä»¬çš„xposedæ¨¡å—æ˜¯å¯ä»¥å·¥ä½œçš„.ç°åœ¨æ¥ä¿®æ”¹ç‚¹ä»€ä¹ˆ,æ¯”å¦‚çŠ¶æ€æ ä¸Šçš„æ—¶é—´?</p>
<p>åœ¨å®‰è£…æºç ä¸‹çš„<a href="http://androidxref.com/4.4.4_r1/xref/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java#42" target="_blank" rel="external">/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java</a>æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª<code>updateClock</code>å‡½æ•°ç”¨æ¥æ›´æ–°æ—¶é—´.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final void updateClock() &#123;</div><div class="line">    if (mDemoMode) return;</div><div class="line">    mCalendar.setTimeInMillis(System.currentTimeMillis());</div><div class="line">    setText(getSmallTime());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä»£ç ä¸­ä½¿ç”¨<code>findAndHookMethod</code>å‡½æ•°æ‰¾åˆ°è¿™ä¸€å‡½æ•°,å¹¶åœ¨updateClockå‡½æ•°æ‰§è¡Œåå°†<code>TextView</code>çš„å†…å®¹é‡æ–°è®¾ç½®å³å¯.æ³¨æ„åœ¨ä½¿ç”¨å‰éœ€è¦è¿™æ ·å°†å…¶å¯¼å…¥:<code>import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</code>.<br>æˆ‘ä»¬çš„æ•ˆæœæ˜¯å°†æ—¶é—´åé¢åŠ ä¸Šä¸€ä¸ªç¬‘è„¸,é¢œè‰²è®¾ä¸ºçº¢è‰².<br>ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">package space.kiya.xposedtest;</div><div class="line"></div><div class="line">import android.graphics.Color;</div><div class="line">import android.widget.TextView;</div><div class="line"></div><div class="line">import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;</div><div class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</div><div class="line">import de.robv.android.xposed.XC_MethodHook;</div><div class="line">import de.robv.android.xposed.XposedBridge;</div><div class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</div><div class="line"></div><div class="line">public class Test implements IXposedHookLoadPackage&#123;</div><div class="line">    @Override public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123;</div><div class="line">        if(loadPackageParam.packageName.equals(&quot;com.android.systemui&quot;))&#123;</div><div class="line">            findAndHookMethod(&quot;com.android.systemui.statusbar.policy.Clock&quot;, loadPackageParam.classLoader, &quot;updateClock&quot;, new XC_MethodHook() &#123;</div><div class="line">                @Override protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</div><div class="line">                    TextView tv = (TextView)param.thisObject;</div><div class="line">                    String text = tv.getText().toString();</div><div class="line">                    tv.setText(text + &quot;:)&quot;);</div><div class="line">                    tv.setTextColor(Color.RED);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/29/15/34/49-style1" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç¯å¢ƒ:&lt;br&gt;å·²rootæ‰‹æœºä¸€æš(Android 4.4.4)&lt;br&gt;Android Studioä¸€æš&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="Xposed" scheme="http://kiya.studio/tags/Xposed/"/>
    
  </entry>
  
  <entry>
    <title>hook - Android ARMä¸‹çš„çš„soæ³¨å…¥</title>
    <link href="http://kiya.studio/2015/12/23/hook-call-function-in-so/"/>
    <id>http://kiya.studio/2015/12/23/hook-call-function-in-so/</id>
    <published>2015-12-23T10:11:33.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹<a href="http://www.weibo.com/zhengmin1989" target="_blank" rel="external">å¤§çŠ‡è’¸ç±³spark</a>çš„<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a>çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">é“¾æ¥</a>.</p>
<a id="more"></a>
<p><strong>è¢«æµ‹è¯•ä»£ç :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line"></div><div class="line">int count = 0;</div><div class="line"></div><div class="line">void print()</div><div class="line">&#123;</div><div class="line">	printf(&quot;hello,%d\n&quot;,count);</div><div class="line">        sleep(1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(int argc, char const *argv[])</div><div class="line">&#123;</div><div class="line">	while(1)&#123;</div><div class="line">		print();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨å…¥æ–¹æ³•éƒ½æ˜¯é€šè¿‡ptraceå®ç°çš„.<br>æœ¬æ–‡ä»£ç åœ¨<a href="https://github.com/kiya-z/Android/tree/master/hook" target="_blank" rel="external">github</a>.</p>
<h1 id="è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°"><a href="#è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°" class="headerlink" title="è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°"></a>è°ƒç”¨ç³»ç»Ÿsoåº“ä¸­çš„å‡½æ•°</h1><p>ç›®æ ‡å‡½æ•°æ˜¯<code>libc.so</code>ä¸­çš„<code>sleep</code>å‡½æ•°.<br>æ­£å¸¸æƒ…å†µæ˜¯æ¯è¾“å‡ºä¸€æ¬¡æš‚åœä¸€ç§’,ç°åœ¨æˆ‘ä»¬è®©å®ƒæš‚åœ10ç§’.</p>
<h2 id="æ€»ä½“æ€è·¯"><a href="#æ€»ä½“æ€è·¯" class="headerlink" title="æ€»ä½“æ€è·¯"></a>æ€»ä½“æ€è·¯</h2><ul>
<li>è·å–ç›®æ ‡è¿›ç¨‹sleepå‡½æ•°åœ°å€</li>
<li>åœ¨ç›®æ ‡è¿›ç¨‹å†…æ‰§è¡Œsleepå‡½æ•°</li>
</ul>
<h2 id="å¦‚ä½•è·å–å‡½æ•°åœ°å€"><a href="#å¦‚ä½•è·å–å‡½æ•°åœ°å€" class="headerlink" title="å¦‚ä½•è·å–å‡½æ•°åœ°å€"></a>å¦‚ä½•è·å–å‡½æ•°åœ°å€</h2><ul>
<li><p><strong>å·²çŸ¥æ¡ä»¶</strong>: æœ¬è¿›ç¨‹çš„åŸºå€ã€ç›®æ ‡è¿›ç¨‹çš„åŸºå€ã€æœ¬è¿›ç¨‹ä¸­sleepå‡½æ•°çš„åœ°å€(å½“ç„¶,è¿™äº›å·²çŸ¥æ¡ä»¶ä¹Ÿæ˜¯éœ€è¦è·å¾—çš„ :p)<br><code>/proc/&lt;pid&gt;/maps</code>æ–‡ä»¶ä¸­å­˜å‚¨çš„æ˜¯è¿›ç¨‹å†…å­˜æ˜ å°„è¯¦æƒ…,æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥è¯¢è¿›ç¨‹ä¸­soçš„åŸºå€;<br><code>sleep</code>å‡½æ•°åœ¨æœ¬è¿›ç¨‹ä¸­çš„åœ°å€ç›´æ¥å¯ä»¥è·å¾—(<code>void*</code>)</p>
</li>
<li><p><strong>æ±‚è§£</strong>: ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€</p>
</li>
<li><p><strong>è®¡ç®—</strong>: æœ¬è¿›ç¨‹sleepåœ°å€ - æœ¬è¿›ç¨‹åŸºå€ + ç›®æ ‡è¿›ç¨‹åŸºå€</p>
</li>
</ul>
<h3 id="è·å–soåº“çš„åŠ è½½åŸºå€"><a href="#è·å–soåº“çš„åŠ è½½åŸºå€" class="headerlink" title="è·å–soåº“çš„åŠ è½½åŸºå€"></a>è·å–soåº“çš„åŠ è½½åŸºå€</h3><p>æ‰“å¼€<code>/proc/&lt;pid&gt;/maps</code>æ–‡ä»¶æ‰¾åˆ°åŸºå€.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">void* get_module_base(int pid, const char* module_name)</div><div class="line">&#123;</div><div class="line">    FILE *f;		//æ–‡ä»¶æŒ‡é’ˆ</div><div class="line">    long addr = 0;	//æ¨¡å—åœ°å€</div><div class="line">    char filename[32];	//mapsè·¯å¾„</div><div class="line">    char *pch;</div><div class="line">    char line[1024];	//æ¯è¡Œ</div><div class="line">    if(pid == 0)&#123;</div><div class="line">        snprintf(filename, sizeof(filename), &quot;/proc/self/maps&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">        snprintf(filename, sizeof(filename), &quot;/proc/%d/maps&quot;, pid);</div><div class="line">    &#125;</div><div class="line">    f = fopen(filename, &quot;r&quot;);</div><div class="line">    if(f != NULL)&#123;</div><div class="line">        while(fgets(line,sizeof(line),f))&#123;</div><div class="line">           if(strstr(line, module_name)) &#123;  //æ‰¾åˆ°è¯¥è¡Œæ˜¯å¦å«æœ‰module_name</div><div class="line">               pch = strtok(line,&quot;-&quot;);  //åˆ†å‰²å‡ºåŸºå€å­—ç¬¦ä¸²</div><div class="line">               addr = strtoul(pch,NULL,0x10); //è½¬æ¢ä¸º16è¿›åˆ¶æ•°</div><div class="line">               if(addr == 0x8000)   //32ä½linuxç¨‹åºä¸­é»˜è®¤çš„textåŠ è½½åœ°å€ä¸º0x08408000,64ä½çš„æ”¹ä¸º0x00400000,æ­¤æ—¶è®¡ç®—baseåœ°å€å°±æ²¡ä»€ä¹ˆç”¨äº†</div><div class="line">                   addr = 0;</div><div class="line">               break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        fclose(f);</div><div class="line">    &#125;</div><div class="line">    return (void*)addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€"><a href="#è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€" class="headerlink" title="è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€"></a>è®¡ç®—ç›®æ ‡è¿›ç¨‹ä¸­sleepå‡½æ•°åœ°å€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">long get_remote_addr(int target_pid, const char* module_name, void* local_addr)</div><div class="line">&#123;</div><div class="line">    void* local_handle = get_module_base(0,module_name);</div><div class="line">    void* remote_handle = get_module_base(target_pid,module_name);</div><div class="line"></div><div class="line">    printf(&quot;local_handle:%p  remote_handle:%p\n&quot;, local_handle, remote_handle);</div><div class="line"></div><div class="line">    //è®¡ç®—å…¬å¼</div><div class="line">    long remote_addr = (long)((uint32_t)local_addr - (uint32_t)local_handle + (uint32_t)remote_handle);</div><div class="line"></div><div class="line">    printf(&quot;remote_addr:%p\n&quot;, remote_addr);</div><div class="line">    return remote_addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°"><a href="#å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°" class="headerlink" title="å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°"></a>å¦‚ä½•æ‰§è¡Œsleepå‡½æ•°</h2><ul>
<li>è®¾ç½®å‡½æ•°å‚æ•°,å¦‚æœå‚æ•°ä¸ªæ•°å°äºç­‰äº4,å‚æ•°æŒ‰é¡ºåºæ”¾å…¥R0~R4å¯„å­˜å™¨ä¸­;å¦‚æœå‚æ•°ä¸ªæ•°å¤§äº4,å¤šä½™çš„éƒ¨åˆ†éœ€è¦å…¥æ ˆ.</li>
<li>è®¾ç½®pcå¯„å­˜å™¨çš„å€¼,è®¾ç½®å½“å‰æŒ‡ä»¤é›†æ ‡å¿—ä½.</li>
<li>åº”ç”¨ä»¥ä¸Šå¯„å­˜å™¨çš„ä¿®æ”¹ä½¿ä¹‹ç”Ÿæ•ˆ.</li>
<li>ç­‰å¾…å‡½æ•°æ‰§è¡Œ.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">//ç›®æ ‡è¿›ç¨‹id,å‚æ•°åœ°å€,å‚æ•°ä¸ªæ•°,å¯„å­˜å™¨åœ°å€</div><div class="line">int ptrace_call(int pid, long addr, long *params, uint32_t params_num, struct pt_regs* regs)</div><div class="line">&#123;</div><div class="line">    uint32_t i;</div><div class="line">    for (i = 0; i &lt; params_num &amp;&amp; i &lt; 4; i++) &#123;     //è®¾ç½®å°‘äº4ä¸ªçš„å‚æ•°</div><div class="line">        regs-&gt;uregs[i] = params[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //è®¾ç½®å¤šäº4ä¸ªçš„å‚æ•°</div><div class="line">    if (i &lt; params_num) &#123;</div><div class="line">        regs-&gt;ARM_sp -= (params_num - i) * long_size;    //æŠ¬é«˜æ ˆé¡¶æŒ‡é’ˆ(åˆ†é…ç©ºé—´)</div><div class="line">        writeData(pid, (long)regs-&gt;ARM_sp, (char*)&amp;params[i], (params_num - i) * long_size); //å†™å…¥</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    regs-&gt;ARM_pc = addr;    //è®¾ç½®pc</div><div class="line">    if (regs-&gt;ARM_pc &amp; 1) &#123;     //åˆ¤æ–­æ˜¯å¦æ˜¯ThumbæŒ‡ä»¤</div><div class="line">        regs-&gt;ARM_pc &amp;= (~1u);  //Thumbçš„pcæœ€åä¸€ä½æ€»æ˜¯0</div><div class="line">        regs-&gt;ARM_cpsr |= CPSR_T_MASK;  //Tæ ‡å¿—ä½ä¸º1</div><div class="line">    &#125; else &#123;    //arm</div><div class="line">        regs-&gt;ARM_cpsr &amp;= ~CPSR_T_MASK;  //Tæ ‡å¿—ä½ä¸º0</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    regs-&gt;ARM_lr = 0;   //ä¸ºäº†ä½¿sleepå‡½æ•°æ‰§è¡Œå®Œæ¯•åäº§ç”Ÿâ€œå†…å­˜è®¿é—®é”™è¯¯â€,è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®Œäº†</div><div class="line"></div><div class="line">    if(ptrace_setregs(pid,regs)==-1 || ptrace_continue(pid)==-1)&#123;   //ç›®æ ‡è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int stat = 0;                   //WUNTRACEDè¡¨ç¤ºå¦‚æœpidè¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€ï¼Œé‚£ä¹ˆwaitpidå‡½æ•°ç«‹å³è¿”å›</div><div class="line">    waitpid(pid,&amp;stat,WUNTRACED);   //ç­‰å¾…sleepå‡½æ•°æ‰§è¡Œ,ç­‰å¾…è¿‡ç¨‹ä¸­æœ¬è¿›ç¨‹æš‚åœæ‰§è¡Œ</div><div class="line">    printf(&quot;%d\n&quot;, stat);</div><div class="line">    while (stat != 0xb7f) &#123;     //0xb7fè¡¨ç¤ºç›®æ ‡è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€</div><div class="line">        printf(&quot;%d\n&quot;, stat);</div><div class="line">        if (ptrace_continue(pid) == -1) &#123;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        waitpid(pid,&amp;stat,WUNTRACED);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•æ³¨å…¥"><a href="#å¦‚ä½•æ³¨å…¥" class="headerlink" title="å¦‚ä½•æ³¨å…¥"></a>å¦‚ä½•æ³¨å…¥</h2><ul>
<li>ä¿å­˜å¯„å­˜å™¨çš„å€¼</li>
<li>è·å¾—sleepå‡½æ•°åœ°å€</li>
<li>æ‰§è¡Œsleepå‡½æ•°</li>
<li>æ¢å¤å¯„å­˜å™¨çš„å€¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">void inject(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs old_regs,regs;</div><div class="line">    long sleep_addr;</div><div class="line">    //ä¿å­˜å¯„å­˜å™¨</div><div class="line">    ptrace(PTRACE_GETREGS, pid, NULL, &amp;old_regs);</div><div class="line">    memcpy(&amp;regs, &amp;old_regs, sizeof(regs));</div><div class="line"></div><div class="line">    long parameters[1];</div><div class="line">    parameters[0] = 10;</div><div class="line">    sleep_addr = get_remote_addr(pid, &quot;libc.so&quot;, (void*)sleep);</div><div class="line">    ptrace_call(pid,sleep_addr,parameters,1,&amp;regs);</div><div class="line">    //æ¢å¤å¯„å­˜å™¨</div><div class="line">    ptrace(PTRACE_SETREGS, pid, NULL, &amp;old_regs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ä¸»å‡½æ•°"><a href="#ä¸»å‡½æ•°" class="headerlink" title="ä¸»å‡½æ•°"></a>ä¸»å‡½æ•°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;string.h&gt;  // strstr,strtok</div><div class="line">#include&lt;stdlib.h&gt;  //strtoul</div><div class="line">#include&lt;stdint.h&gt;  //uint32_t</div><div class="line">#include&lt;unistd.h&gt;  //sleep</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">#include&lt;linux/wait.h&gt;    // WUNTRACED</div><div class="line">#include&lt;time.h&gt;</div><div class="line"></div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(argc != 2)&#123;</div><div class="line">        printf(&quot;usage: %s &lt;pid to be traced&gt;\n&quot;,argv[0]);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    int pid = atoi(argv[1]);</div><div class="line"></div><div class="line">    if(0 != ptrace(PTRACE_ATTACH, pid, NULL, NULL))&#123;</div><div class="line">        printf(&quot;attach failed.&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    inject(pid);</div><div class="line"></div><div class="line">    ptrace(PTRACE_DETACH, pid, NULL, NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ç•ªå¤–"><a href="#ç•ªå¤–" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><h2 id="proc-lt-pid-gt-æ–‡ä»¶å¤¹"><a href="#proc-lt-pid-gt-æ–‡ä»¶å¤¹" class="headerlink" title="/proc/&lt;pid&gt; æ–‡ä»¶å¤¹"></a>/proc/&lt;pid&gt; æ–‡ä»¶å¤¹</h2><table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>cmdline</td>
<td>å‘½ä»¤è¡Œå…¨å(åŠ å‚æ•°å˜é‡)å’Œ ps å‘½ä»¤ä¸­çš„command åˆ—ç»“æœä¸€æ ·</td>
</tr>
<tr>
<td>cwd</td>
<td>è¿›ç¨‹çš„å·¥ä½œç›®å½• å’Œ (pwdx PID) ç»“æœç›¸åŒ</td>
</tr>
<tr>
<td>environ</td>
<td>è¿›ç¨‹çš„ç¯å¢ƒå˜é‡</td>
</tr>
<tr>
<td>exe</td>
<td>ä¸€èˆ¬æ˜¯/bin/ çš„é“¾æ¥</td>
</tr>
<tr>
<td>fd</td>
<td>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°fu .ç”¨ls -l å¯ä»¥æŸ¥çœ‹å…·ä½“çš„æ–‡ä»¶ (å¯ä»¥ç”¨lsof -p PID)</td>
</tr>
<tr>
<td>status</td>
<td>è¿›ç¨‹çš„ç›¸å…³çŠ¶æ€</td>
</tr>
<tr>
<td>task</td>
<td>è¯¥ç›®å½•ä¸‹æ˜¯è¿›ç¨‹æ‰€åŒ…å«çš„çº¿ç¨‹(note: ps å¯ä»¥æŸ¥çœ‹çº¿ç¨‹)</td>
</tr>
<tr>
<td>mounts</td>
<td>è¿›ç¨‹æŒ‚è½½ç‚¹</td>
</tr>
<tr>
<td>maps</td>
<td>è¿›ç¨‹å†…å­˜æ˜ å°„è¯¦æƒ…</td>
</tr>
</tbody>
</table>
<h2 id="å…³äºpcå¯„å­˜å™¨"><a href="#å…³äºpcå¯„å­˜å™¨" class="headerlink" title="å…³äºpcå¯„å­˜å™¨"></a>å…³äºpcå¯„å­˜å™¨</h2><p><a href="https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf" target="_blank" rel="external">arm.pdf</a> ä¸­çš„<strong>A2.4.3 Register 15 and the program counter</strong>æœ‰è¿™æ ·ä¸€æ®µè¯:<br>æ˜¯å…³äºæŒ‡ä»¤é›†åœ¨pcå¯„å­˜å™¨ä¸Šçš„è¡¨ç°çš„.</p>
<blockquote>
<p>Reading the program counter<br>When an instruction reads the PC, the value read depends on which instruction set it comes from:<br>â€¢ For an ARM instruction, the value read is the address of the instruction plus 8 bytes. Bits [1:0] of this<br>value are always zero, because ARM instructions are always word-aligned.<br>â€¢ For a Thumb instruction, the value read is the address of the instruction plus 4 bytes. Bit [0] of this<br>value is always zero, because Thumb instructions are always halfword-aligned.</p>
</blockquote>
<h2 id="å…³äºCPSRå¯„å­˜å™¨"><a href="#å…³äºCPSRå¯„å­˜å™¨" class="headerlink" title="å…³äºCPSRå¯„å­˜å™¨"></a>å…³äºCPSRå¯„å­˜å™¨</h2><table>
<thead>
<tr>
<th>31</th>
<th>30</th>
<th>29</th>
<th>28</th>
<th>27</th>
<th>26  25</th>
<th>24</th>
<th>23 20</th>
<th>19 16</th>
<th>15 10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4 0</th>
</tr>
</thead>
<tbody>
<tr>
<td>N</td>
<td>Z</td>
<td>C</td>
<td>V</td>
<td>Q</td>
<td>Res</td>
<td>J</td>
<td>RESERVED</td>
<td>GE[3:0]</td>
<td>RESERVED</td>
<td>E</td>
<td>A</td>
<td>I</td>
<td>F</td>
<td>T</td>
<td>M[4:0]</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­Jå’ŒTæ ‡è®°ä½ä»£è¡¨å½“å‰æŒ‡ä»¤é›†:</p>
<table>
<thead>
<tr>
<th>J</th>
<th>T</th>
<th>Instruction set</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>ARM</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>Thumb</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>Jazelle</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>RESERVED</td>
</tr>
</tbody>
</table>
<h2 id="å…³äºwaitpid"><a href="#å…³äºwaitpid" class="headerlink" title="å…³äºwaitpid"></a>å…³äºwaitpid</h2><p>è¯¦ç»†ä»‹ç»å¯çœ‹<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr2/wait.htm" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>.</p>
<h3 id="å‚æ•°status"><a href="#å‚æ•°status" class="headerlink" title="å‚æ•°status"></a>å‚æ•°status</h3><p><code>wait</code>å‡½æ•°è°ƒç”¨è¿‡å,<code>status</code>æŒ‡é’ˆæŒ‡å‘å¯ä»¥è¢«å®è§£æçš„å€¼,è¿™äº›å®åœ¨ndkç›®å½•ä¸‹<code>platforms/android-21/arch-arm/usr/include/sys/wait.h</code>æ–‡ä»¶ä¸­å®šä¹‰.</p>
<p>é«˜2å­—èŠ‚ç”¨äºè¡¨ç¤ºå¯¼è‡´å­è¿›ç¨‹çš„é€€å‡ºæˆ–æš‚åœçŠ¶æ€ä¿¡å·å€¼(<code>WTERMSIG</code>)ï¼Œä½2å­—èŠ‚è¡¨ç¤ºå­è¿›ç¨‹æ˜¯é€€å‡º(0x0)è¿˜æ˜¯æš‚åœ(0x7f)çŠ¶æ€(<code>WEXITSTATUS</code>)ã€‚<br>å¦‚:0xb7få°±è¡¨ç¤ºå­è¿›ç¨‹ä¸ºæš‚åœçŠ¶æ€ï¼Œå¯¼è‡´å®ƒæš‚åœçš„ä¿¡å·é‡ä¸º11å³<code>sigsegv</code>é”™è¯¯ã€‚<br>å…³äºé”™è¯¯ä»£ç çš„æ–‡æ¡£å¯çœ‹<a href="https://support.sas.com/documentation/onlinedoc/sasc/doc/lr1/lrv1ch5.htm" target="_blank" rel="external">è¿™é‡Œ</a>,<br>å®šä¹‰åœ¨ndkç›®å½•ä¸‹<code>platforms/android-21/arch-arm/usr/include/asm/signal.h</code>ä¸­.</p>
<blockquote>
<p>å…¶ä¸­ä¸¤ä¸ªå®:<br>WEXITSTATUS(*statusPtr):<br>if the child process terminates normally, this macro evaluates to the lower 8 bits of the value passed to the exit or _exit function or returned from main.<br>WTERMSIG(*statusPtr)<br>if the child process ends by a signal that was not caught, this macro evaluates to the number of that signal.</p>
</blockquote>
<h3 id="å‚æ•°options"><a href="#å‚æ•°options" class="headerlink" title="å‚æ•°options"></a>å‚æ•°options</h3><p>æŒ‡å®šäº†<code>waitpid</code>çš„é¢å¤–è¡ŒåŠ¨.é€‰é¡¹æœ‰:</p>
<p><strong>WNOHANG</strong>:<br>å‘Šè¯‰<code>waitpid</code>ä¸ç­‰ç¨‹åºä¸­æ­¢ç«‹å³è¿”å›<code>status</code>ä¿¡æ¯.<br>æ­£å¸¸æƒ…å†µæ˜¯å½“ä¸»è¿›ç¨‹å¯¹å­è¿›ç¨‹ä½¿ç”¨äº†<code>waitpid</code>,ä¸»è¿›ç¨‹å°±ä¼šé˜»å¡ç›´åˆ°<code>waitpid</code>è¿”å›<code>status</code>ä¿¡æ¯;å¦‚æœæŒ‡å®šäº†<code>WNOHANG</code>é€‰é¡¹,ä¸»è¿›ç¨‹å°±ä¸ä¼šé˜»å¡äº†.<br>å¦‚æœè¿˜æ²¡æœ‰å¯ç”¨çš„<code>status</code>ä¿¡æ¯,<code>waitpid</code>è¿”å›0.</p>
<p><strong>WUNTRACED</strong>:<br>å‘Šè¯‰<code>waitpid</code>ï¼Œå¦‚æœå­è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€æˆ–è€…å·²ç»ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°±ç«‹å³è¿”å›<code>status</code>ä¿¡æ¯,æ­£å¸¸æƒ…å†µæ˜¯ç´«ç¦åŸç»ˆæ­¢çš„æ—¶å€™æ‰è¿”å›.<br>å¦‚æœæ˜¯è¢«ptraceçš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆå³ä½¿ä¸æä¾›WUNTRACEDå‚æ•°ï¼Œä¹Ÿä¼šåœ¨å­è¿›ç¨‹è¿›å…¥æš‚åœçŠ¶æ€çš„æ—¶å€™ç«‹å³è¿”å›ã€‚<br>å¯¹äºä½¿ç”¨<code>ptrace_cont</code>è¿è¡Œçš„å­è¿›ç¨‹ï¼Œå®ƒä¼šåœ¨3ç§æƒ…å†µä¸‹è¿›å…¥æš‚åœçŠ¶æ€ï¼šâ‘ ä¸‹ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼›â‘¡å­è¿›ç¨‹é€€å‡ºï¼›â‘¢å­è¿›ç¨‹çš„æ‰§è¡Œå‘ç”Ÿé”™è¯¯ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç¨‹åºä¸­çš„<code>0xb7f</code>å°±è¡¨ç¤ºå­è¿›ç¨‹è¿›å…¥äº†æš‚åœçŠ¶æ€ï¼Œä¸”å‘é€çš„é”™è¯¯ä¿¡å·ä¸º11(SIGSEGV)ï¼Œå®ƒè¡¨ç¤ºè¯•å›¾è®¿é—®æœªåˆ†é…ç»™è‡ªå·±çš„å†…å­˜, æˆ–è¯•å›¾å¾€æ²¡æœ‰å†™æƒé™çš„å†…å­˜åœ°å€å†™æ•°æ®ã€‚<br>å½“å­è¿›ç¨‹æ‰§è¡Œå®Œæ³¨å…¥çš„å‡½æ•°åï¼Œç”±äºæˆ‘ä»¬åœ¨å‰é¢è®¾ç½®äº†regs-&gt;ARM_lr = 0ï¼Œå®ƒå°±ä¼šè¿”å›åˆ°0åœ°å€å¤„ç»§ç»­æ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šäº§ç”ŸSIGSEGVäº†.</p>
<h1 id="è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°"><a href="#è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°" class="headerlink" title="è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°"></a>è°ƒç”¨è‡ªå®šä¹‰soåº“ä¸­çš„å‡½æ•°</h1><ul>
<li>ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€</li>
<li>è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€</li>
<li>è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯</li>
<li>è°ƒç”¨dlopenåŠ è½½soåº“</li>
<li>è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€</li>
<li>æ‰§è¡Œç›®æ ‡å‡½æ•°</li>
<li>è°ƒç”¨dlcloseå¸è½½soåº“</li>
<li>æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€</li>
</ul>
<h2 id="ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€"><a href="#ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€" class="headerlink" title="ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€"></a>ä¿å­˜å½“å‰å¯„å­˜å™¨çš„çŠ¶æ€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">struct pt_regs old_regs,regs;</div><div class="line">ptrace(PTRACE_GETREGS, pid, NULL, &amp;old_regs);</div><div class="line">memcpy(&amp;regs,&amp;old_regs,sizeof(regs));</div></pre></td></tr></table></figure>
<h2 id="è·å–ç›®æ ‡ç¨‹åºçš„mmap-dlopen-dlsym-dlcloseå‡½æ•°åœ°å€"><a href="#è·å–ç›®æ ‡ç¨‹åºçš„mmap-dlopen-dlsym-dlcloseå‡½æ•°åœ°å€" class="headerlink" title="è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€"></a>è·å–ç›®æ ‡ç¨‹åºçš„mmap, dlopen, dlsym, dlcloseå‡½æ•°åœ°å€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">long mmap_addr,dlopen_addr,dlsym_addr,dlclose_addr;</div><div class="line">mmap_addr = get_remote_addr(pid, libc_path, (void*)mmap);</div><div class="line">dlopen_addr = get_remote_addr(pid, libc_path, (void*)dlopen);</div><div class="line">dlsym_addr = get_remote_addr(pid, libc_path, (void*)dlsym);</div><div class="line">dlclose_addr = get_remote_addr(pid, libc_path, (void*)dlclose);</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯"><a href="#è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯" class="headerlink" title="è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯"></a>è°ƒç”¨mmapåˆ†é…ç©ºé—´ä¿å­˜å‚æ•°ä¿¡æ¯</h2><p>mmapçš„åŸå‹å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>addr</td>
<td>æ˜ å°„çš„èµ·å§‹åœ°å€,ä¸º0è¡¨ç¤ºç”±ç³»ç»Ÿå†³å®šæ˜ å°„çš„èµ·å§‹åœ°å€</td>
</tr>
<tr>
<td>length</td>
<td>æ˜ å°„çš„é•¿åº¦</td>
</tr>
<tr>
<td>prot</td>
<td>æ˜ å°„çš„å†…å­˜ä¿å­˜å±æ€§,ä¸èƒ½ä¸æ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼å†²çª</td>
</tr>
<tr>
<td>flags</td>
<td>æŒ‡å®šæ˜ å°„å¯¹è±¡çš„ç±»å‹,æ˜ å°„é€‰é¡¹å’Œæ˜ å°„é¡µæ˜¯å¦å¯ä»¥å…±äº«</td>
</tr>
<tr>
<td>fd</td>
<td>æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦,ä¸€èˆ¬æ˜¯ç”±open()å‡½æ•°è¿”å›;å…¶å€¼ä¹Ÿå¯ä»¥è®¾ç½®ä¸º-1,æ­¤æ—¶éœ€è¦æŒ‡å®šflagså‚æ•°ä¸­çš„MAP_ANON,è¡¨æ˜è¿›è¡Œçš„æ˜¯åŒ¿åæ˜ å°„</td>
</tr>
<tr>
<td>offset</td>
<td>è¢«æ˜ å°„å¯¹è±¡å†…å®¹çš„èµ·ç‚¹</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>mmap(0,0x4000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE,0,0)</code>,<br><code>PROT_EXEC</code>è¡¨ç¤ºå¯æ‰§è¡Œ.<br><code>PROT_READ</code>è¡¨ç¤ºå¯è¯».<br><code>PROT_WRITE</code>è¡¨ç¤ºå¯å†™.<br><code>MAP_PRIVATE</code>è¡¨ç¤ºå»º.ç«‹ä¸€ä¸ªå†™å…¥æ—¶æ‹·è´çš„ç§æœ‰æ˜ å°„.å†…å­˜åŒºåŸŸçš„å†™å…¥ä¸ä¼šå½±å“åˆ°åŸæ–‡ä»¶.è¿™ä¸ªæ ‡å¿—å’Œä»¥ä¸Šæ ‡å¿—æ˜¯äº’æ–¥çš„,åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª.<br><code>MAP_ANONYMOUS</code>è¡¨ç¤ºåŒ¿åæ˜ å°„,æ˜ å°„åŒºä¸ä¸ä»»ä½•æ–‡ä»¶å…³è”.<br>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">long parameters[10];    </div><div class="line">parameters[0] = 0;  //æ„é€ å‚æ•°</div><div class="line">parameters[1] = 0x4000;</div><div class="line">parameters[2] = PROT_READ | PROT_WRITE | PROT_EXEC;</div><div class="line">parameters[3] = MAP_ANONYMOUS | MAP_PRIVATE;</div><div class="line">parameters[4] = 0;</div><div class="line">parameters[5] = 0;</div><div class="line">ptrace_call(pid,mmap_addr,parameters,6,&amp;regs);</div><div class="line">//è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">long mapping_base = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlopenåŠ è½½soåº“"><a href="#è°ƒç”¨dlopenåŠ è½½soåº“" class="headerlink" title="è°ƒç”¨dlopenåŠ è½½soåº“"></a>è°ƒç”¨dlopenåŠ è½½soåº“</h2><p><strong>åŸå‹:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *dlopen(const char *filename, int flags);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>filename</td>
<td>soåº“å</td>
</tr>
<tr>
<td>flags</td>
<td>æ‰“å¼€æ–¹å¼</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>dlopen(so_path,RTLD_NOW | RTLD_GLOBAL)</code>,<br><code>RTLD_NOW</code>è¡¨ç¤ºéœ€è¦åœ¨dlopenè¿”å›å‰,è§£æå‡ºæ‰€æœ‰æœªå®šä¹‰ç¬¦å·,å¦‚æœè§£æä¸å‡ºæ¥åœ¨dlopenä¼šè¿”å›NULL;<br><code>RTLD_GLOBAL</code>è¡¨ç¤ºåŠ¨æ€åº“ä¸­å®šä¹‰çš„ç¬¦å·å¯è¢«å…¶åæ‰“å¼€çš„å…¶å®ƒåº“è§£æ.<br>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, so_path, strlen(so_path)+1);   //å°†åº“åå­—ç¬¦ä¸²æ”¾å…¥ç›®æ ‡è¿›ç¨‹ç©ºé—´</div><div class="line">parameters[0] = mapping_base;</div><div class="line">parameters[1] = RTLD_NOW | RTLD_GLOBAL;</div><div class="line">ptrace_call(pid, dlopen_addr, parameters, 2, &amp;regs);</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);  //è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">long handle = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€"><a href="#è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€" class="headerlink" title="è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€"></a>è°ƒç”¨dlsymæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€</h2><p>åŸå‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *dlsym(void *handle, const char *symbol);</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>handle</td>
<td>soåº“çš„åŸºå€</td>
</tr>
<tr>
<td>symbol</td>
<td>å‡½æ•°ååœ°å€</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„è°ƒç”¨è¯­å¥æ˜¯<code>dlsym(handle, function_name)</code>,åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, function_name, strlen(function_name)+1);</div><div class="line">parameters[0] = handle;</div><div class="line">parameters[1] = mapping_base;</div><div class="line">ptrace_call(pid, dlsym_addr, parameters, 2, &amp;regs);</div><div class="line">ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);  //è°ƒç”¨ç»“æŸåè·å¾—r0ä¸­ä¿å­˜çš„è¿”å›å€¼</div><div class="line">long function_addr = regs.ARM_r0;</div></pre></td></tr></table></figure>
<h2 id="æ‰§è¡Œç›®æ ‡å‡½æ•°"><a href="#æ‰§è¡Œç›®æ ‡å‡½æ•°" class="headerlink" title="æ‰§è¡Œç›®æ ‡å‡½æ•°"></a>æ‰§è¡Œç›®æ ‡å‡½æ•°</h2><p>å…ˆå†™æ®µcç¨‹åºç¼–è¯‘ä¸ºsoæ–‡ä»¶:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line"></div><div class="line">void hello(char *str)</div><div class="line">&#123;</div><div class="line">    printf(&quot;hello %s\n&quot;,str);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">writeData(pid, mapping_base, function_parameters, strlen(function_parameters)+1);</div><div class="line">parameters[0] = mapping_base;</div><div class="line">ptrace_call(pid, function_addr, parameters, 1, &amp;regs);</div></pre></td></tr></table></figure>
<h2 id="è°ƒç”¨dlcloseå¸è½½soåº“"><a href="#è°ƒç”¨dlcloseå¸è½½soåº“" class="headerlink" title="è°ƒç”¨dlcloseå¸è½½soåº“"></a>è°ƒç”¨dlcloseå¸è½½soåº“</h2><p>åŸå‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int dlclose(void *handle);</div></pre></td></tr></table></figure>
<p>åˆ™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">parameters[0] = handle;</div><div class="line">ptrace_call(pid,dlclose_addr,parameters,1,&amp;regs);</div></pre></td></tr></table></figure>
<h2 id="æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€"><a href="#æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€" class="headerlink" title="æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€"></a>æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ptrace(PTRACE_SETREGS,pid,NULL,&amp;old_regs);</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a></p>
<p><a href="http://blog.csdn.net/jinzhuojun/article/details/9900105" target="_blank" rel="external">Androidä¸­çš„soæ³¨å…¥(inject)å’ŒæŒ‚é’©(hook) - For both x86 and arm</a></p>
<p><a href="http://www.cnblogs.com/wanyuanchun/p/4020756.html" target="_blank" rel="external">Androidæ³¨å…¥å®Œå…¨å‰–æ</a></p>
<p><a href="http://segmentfault.com/a/1190000000606904" target="_blank" rel="external">http://segmentfault.com/a/1190000000606904</a></p>
<p><a href="http://www.sanwho.com/133.html" target="_blank" rel="external">Androidä¸‹soæ³¨å…¥æ±‡æ€»</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡æ˜¯å¯¹&lt;a href=&quot;http://www.weibo.com/zhengmin1989&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å¤§çŠ‡è’¸ç±³spark&lt;/a&gt;çš„&lt;a href=&quot;http://drops.wooyun.org/tips/9300&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking&lt;/a&gt;çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³&lt;a href=&quot;http://drops.wooyun.org/tips/9300&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é“¾æ¥&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="hook" scheme="http://kiya.studio/tags/hook/"/>
    
  </entry>
  
  <entry>
    <title>Pythonçˆ¬è™« - ç™»å½•csdn</title>
    <link href="http://kiya.studio/2015/12/22/csdn-login/"/>
    <id>http://kiya.studio/2015/12/22/csdn-login/</id>
    <published>2015-12-22T05:15:58.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨<code>urllib2</code>ã€<code>BeautifulSoup</code>å’Œ<code>CookieJar</code>å®ç°ç™»å½•.</p>
<a id="more"></a>
<p>ä½¿ç”¨charlesæŠ“åŒ…æ‰¾åˆ°postçš„loginç½‘å€: <code>https://passport.csdn.net/account/login</code></p>
<p>å†æ¥çœ‹çœ‹postçš„å‚æ•°:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/22/16/26/16" alt=""></p>
<p>å“å‘€è¿™é‡Œçš„å¯†ç ç«Ÿç„¶æ˜¯æ˜æ–‡..</p>
<p>usernameã€passwordå’Œ_eventIdå¥½è¯´,åªæ˜¯ltå’Œexecutionåœ¨å“ªé‡Œè·å¾—å‘¢?</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç´§æŒ¨ç€çš„GETè¯·æ±‚è¿”å›çš„htmlä»£ç ,è¿™é‡Œç«Ÿç„¶è¿˜æœ‰æ³¨é‡Šå“‡å“‡:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/22/16/29/43" alt=""></p>
<p>å¥½,é‚£ä¹ˆç°åœ¨æ€»ç»“ä¸€ä¸‹ <strong>æ­¥éª¤</strong>:</p>
<ol>
<li>å¯¹<code>https://passport.csdn.net/account/login</code>è¿›è¡Œgetè¯·æ±‚,åœ¨htmlä»£ç ä¸­è·å¾—ltå’Œexecution;</li>
<li>è¡¨å•åˆ›å»º</li>
<li>å¸¦ä¸ŠPOSTè¡¨å•,è¿›è¡ŒPOSTè¯·æ±‚</li>
</ol>
<p><strong>ä»£ç å¦‚ä¸‹:</strong></p>
<p>è·å– lt å’Œ execution:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cookie = cookielib.MozillaCookieJar(&apos;cookie.txt&apos;)   # MozillaCookieJarå¯ä¿å­˜cookie</div><div class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</div><div class="line">opener = urllib2.build_opener(cookie_handler)</div><div class="line"># prepare for login</div><div class="line">response = opener.open(&apos;https://passport.csdn.net/account/login&apos;)</div><div class="line">data = response.read()</div><div class="line">lt = &quot;&quot;</div><div class="line">execution = &quot;&quot;</div><div class="line">bs = BeautifulSoup(response.read(),&quot;lxml&quot;)</div><div class="line">for input in bs.form.find_all(&apos;input&apos;):</div><div class="line">    if input.get(&apos;name&apos;) == &apos;lt&apos;:</div><div class="line">        lt = input.get(&apos;value&apos;)</div><div class="line">    if input.get(&apos;name&apos;) == &apos;execution&apos;:</div><div class="line">        execution = input.get(&apos;value&apos;)</div></pre></td></tr></table></figure>
<p><strong>è¡¨å•</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">post_data = urllib.urlencode(&#123;</div><div class="line">    &apos;username&apos; : &apos;xxxx&apos;,</div><div class="line">    &apos;password&apos; : &apos;xxxx&apos;,</div><div class="line">    &apos;lt&apos; : lt,</div><div class="line">    &apos;execution&apos; : execution,</div><div class="line">    &apos;_eventId&apos; : &apos;submit&apos;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>POSTåœ°å€</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">login_url = &apos;https://passport.csdn.net/account/login&apos;</div></pre></td></tr></table></figure>
<p><strong>POST</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">request = urllib2.Request(url = login_url,data=post_data)</div><div class="line">try:</div><div class="line">    response = opener.open(request)</div><div class="line">except urllib2.HTTPError as e:</div><div class="line">    print e.read()</div></pre></td></tr></table></figure>
<p><strong>GETå…¶ä»–ç½‘å€éªŒè¯</strong>:</p>
<p>æ³¨æ„è¿™é‡Œçš„requestè¯·æ±‚éœ€è¦å¸¦ä¸Šheaders,å¦åˆ™ä¼šæŠ¥<code>403 forbidden</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">headers_data = &#123;</div><div class="line">    &apos;User-Agent&apos; :	&apos;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&apos;</div><div class="line">&#125;</div><div class="line">request = urllib2.Request(url = &apos;http://blog.csdn.net/attach_114&apos;,headers=headers_data)</div><div class="line">print opener.open(request).read()</div></pre></td></tr></table></figure>
<p><strong>å®Œæ•´ä»£ç :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">#coding:utf-8</div><div class="line">import urllib</div><div class="line">import urllib2</div><div class="line">import cookielib</div><div class="line">from bs4 import BeautifulSoup</div><div class="line">from pass_csdn import username,password</div><div class="line">cookie = cookielib.MozillaCookieJar(&apos;cookie.txt&apos;)</div><div class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</div><div class="line">opener = urllib2.build_opener(cookie_handler)</div><div class="line">def login():</div><div class="line">    # prepare for login</div><div class="line">    response = opener.open(&apos;https://passport.csdn.net/account/login&apos;)</div><div class="line">    lt = &quot;&quot;</div><div class="line">    execution = &quot;&quot;</div><div class="line">    bs = BeautifulSoup(response.read(),&quot;lxml&quot;)</div><div class="line">    for input in bs.form.find_all(&apos;input&apos;):</div><div class="line">        if input.get(&apos;name&apos;) == &apos;lt&apos;:</div><div class="line">            lt = input.get(&apos;value&apos;)</div><div class="line">        if input.get(&apos;name&apos;) == &apos;execution&apos;:</div><div class="line">            execution = input.get(&apos;value&apos;)</div><div class="line">    post_data = urllib.urlencode(&#123;</div><div class="line">        &apos;username&apos; : username,</div><div class="line">        &apos;password&apos; : password,</div><div class="line">        &apos;lt&apos; : lt,</div><div class="line">        &apos;execution&apos; : execution,</div><div class="line">        &apos;_eventId&apos; : &apos;submit&apos;</div><div class="line">    &#125;)</div><div class="line">    headers_data = &#123;</div><div class="line">        &apos;User-Agent&apos; :	&apos;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&apos;</div><div class="line">    &#125;</div><div class="line">    login_url_with_jsession = &apos;https://passport.csdn.net/account/login&apos;</div><div class="line">    request = urllib2.Request(url = login_url_with_jsession,data=post_data)</div><div class="line">    try:</div><div class="line">        response = opener.open(request)</div><div class="line">    except urllib2.HTTPError as e:</div><div class="line">        print e.read()</div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    login()</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨&lt;code&gt;urllib2&lt;/code&gt;ã€&lt;code&gt;BeautifulSoup&lt;/code&gt;å’Œ&lt;code&gt;CookieJar&lt;/code&gt;å®ç°ç™»å½•.&lt;/p&gt;
    
    </summary>
    
      <category term="Python" scheme="http://kiya.studio/categories/Python/"/>
    
    
      <category term="Python" scheme="http://kiya.studio/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>hook - æ‹¦æˆªç³»ç»Ÿè°ƒç”¨</title>
    <link href="http://kiya.studio/2015/12/21/hook-syscall/"/>
    <id>http://kiya.studio/2015/12/21/hook-syscall/</id>
    <published>2015-12-21T10:11:32.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹<a href="http://www.weibo.com/zhengmin1989" target="_blank" rel="external">å¤§çŠ‡è’¸ç±³spark</a>çš„<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a>çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³<a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">é“¾æ¥</a>.</p>
<a id="more"></a>
<p>å®ç°hookå°±ç¦»ä¸å¼€<a href="http://kiya.space/2015/12/18/ptrace-basis/" target="_blank" rel="external">ptrace</a>.</p>
<h1 id="ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨"><a href="#ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨"></a>ARMä¸Šçš„ç³»ç»Ÿè°ƒç”¨</h1><p>ç³»ç»Ÿè°ƒç”¨ç”±SWIå®ç°,å³è½¯ä»¶ä¸­æ–­(Software Interrupt),åœ¨è¯·æ±‚ç³»ç»ŸæœåŠ¡æ—¶é€ æˆçš„ä¸­æ–­,ç”±SWIæŒ‡ä»¤é€ æˆå¼‚å¸¸ä»è€Œåˆ‡å…¥ç‰¹æƒæ¨¡å¼,ä»è€Œå…è®¸éç‰¹æƒæ¨¡å¼è®¿é—®ç‰¹æƒæ¨¡å¼çš„å‡½æ•°.</p>
<p>ARMä¸­æœ‰ä¸¤ç§ç³»ç»Ÿè°ƒç”¨æ–¹å¼: OABI(old application binary interface)å’ŒEABI(extended application binary interface).è§(å†…æ ¸æºç arch/arm/kernel/entry-common.Sæ–‡ä»¶).</p>
<p>å¯¹äºOABI: é€šè¿‡è·Ÿéšåœ¨swiæŒ‡ä»¤åçš„è°ƒç”¨å·æ¥è¿›è¡Œ. <code>1101 1111 vvvv vvvv -- SWI immed_8</code> (ThumbæŒ‡ä»¤)æ ¼å¼)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">swi (#num | 0x900000) (0x900000æ˜¯ä¸ªmagicå€¼)</div></pre></td></tr></table></figure></p>
<p>å¯¹äºEABI: è°ƒç”¨å·å­˜æ”¾åœ¨r7ä¸­. <code>1110 1111 0000 0000 -- SWI 0</code> (ThumbæŒ‡ä»¤æ ¼å¼)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mov r7, #num</div><div class="line">swi 0x0</div></pre></td></tr></table></figure></p>
<p>åœ¨ <a href="https://www.scss.tcd.ie/~waldroj/3d1/arm_arm.pdf" target="_blank" rel="external">arm.pdf</a>çš„ <strong>A4.1.107 SWI</strong> å’Œ <strong>A7.1.69 SWI</strong> åˆ†åˆ«æ˜¯å¯¹ARMå’ŒThumbä¸­SWIçš„æè¿°.</p>
<p>æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨å·åœ¨<code>arch/arm/include/asm/unistd.h</code>æ–‡ä»¶.</p>
<p>æ‰€ä»¥åœ¨å¾—åˆ°ä¸€æ¡SWIæŒ‡ä»¤æ—¶,è¦è§£æå‡ºç³»ç»Ÿè°ƒç”¨å·å¾—åˆ†ä¸¤ç§æƒ…å†µ:<br>è¿™é‡Œçš„æºç¨‹åºç›´æ¥æŒ‰ARMæŒ‡ä»¤é›†å¤„ç†äº†,æ²¡æœ‰åšåˆ¤æ–­thumbçš„å¤„ç†.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if(ins == 0xef000000)&#123;      //ç›´æ¥å’ŒæŒ‡ä»¤æ¯”è¾ƒ</div><div class="line">    return regs-&gt;ARM_r7;</div><div class="line">&#125;else&#123;</div><div class="line">    if((ins &amp; 0x0ff00000) != 0x0f900000)&#123;   //å’Œmagicå€¼æ¯”è¾ƒ,è¿™é‡Œæˆ‘è®¤ä¸ºå‰é¢ä¸¤ä½0fæ”¹æˆåˆ«çš„å€¼ä¹Ÿæ˜¯å¯ä»¥çš„,é‡è¦çš„æ˜¯magicå€¼</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line">    return ins &amp;= 0x000fffff;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="æ‹¦æˆªç³»ç»Ÿè°ƒç”¨"><a href="#æ‹¦æˆªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ‹¦æˆªç³»ç»Ÿè°ƒç”¨"></a>æ‹¦æˆªç³»ç»Ÿè°ƒç”¨</h1><p><strong>æ•´ä¸ªæ€è·¯æ˜¯:</strong></p>
<p>ä½¿è¢«è°ƒè¯•ç¨‹åºåœ¨ä¸‹æ¬¡æ¬¡è°ƒç”¨ç³»ç»Ÿå‡½æ•°å‰ååœä¸‹(SYSCALL),è¿™æ—¶è°ƒè¯•ç¨‹åºå¯¹è¢«è°ƒè¯•è¿›è¡Œæ“ä½œ(PTRACE_PEEKTEXT/PTRACE_GETREGSâ€¦),éšåä½¿è¢«è°ƒè¯•ç¨‹åºç»§ç»­è¿è¡Œ(SYSCALL),è°ƒè¯•ç¨‹åºç­‰å¾…(wait).</p>
<p><strong>è¢«è°ƒè¯•ç¨‹åº:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">int count = 0;</div><div class="line">void print()</div><div class="line">&#123;</div><div class="line">	printf(&quot;hello,%d\n&quot;,count);</div><div class="line">        sleep(1);</div><div class="line">&#125;</div><div class="line">int main(int argc, char const *argv[])</div><div class="line">&#123;</div><div class="line">	while(1)&#123;</div><div class="line">		print();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è°ƒè¯•ç¨‹åº:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;  //å¤´æ–‡ä»¶è·¯å¾„æ ¹æ®ndkç›®å½•ä¸‹/platforms/android-21/arch-arm/usr/include</div><div class="line">#include&lt;asm/unistd.h&gt;</div><div class="line">long getSystemCallNumber(int pid, struct pt_regs *regs)</div><div class="line">&#123;</div><div class="line">    long ins = 0;</div><div class="line">    ins = ptrace(PTRACE_PEEKTEXT, pid, (void *)(regs-&gt;ARM_pc - 4), NULL);   //r15-4</div><div class="line">    if(ins == 0)&#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    if(ins == 0xef000000)&#123;      //EABI</div><div class="line">        return regs-&gt;ARM_r7;</div><div class="line">    &#125;else&#123;</div><div class="line">        if((ins &amp; 0x0ff00000) != 0x0f900000)&#123;   //OABI</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        return ins &amp;= 0x000fffff;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void doSthBefore(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;before syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;    //å¾—åˆ°å‚æ•°</div><div class="line">        printf(&quot;__NR_write &lt;&lt; %ld, %p, %ld\n&quot;,regs.ARM_r0, (void*)regs.ARM_r1, regs.ARM_r2);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void doSthAfter(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;after syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;</div><div class="line">        printf(&quot;__NR_write &gt;&gt; %ld\n&quot;,regs.ARM_r0);</div><div class="line">    &#125;</div><div class="line">    printf(&quot;\n&quot;);</div><div class="line">&#125;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(argc != 2)&#123;</div><div class="line">        printf(&quot;usage: %s &lt;pid to be traced&gt;\n&quot;,argv[0]);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    int pid = atoi(argv[1]);</div><div class="line">    if(0 != ptrace(PTRACE_ATTACH, pid, NULL, NULL))&#123;</div><div class="line">        printf(&quot;attach failed.&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    ptrace(PTRACE_SYSCALL, pid, NULL, NULL);    //ä½¿ä¹‹åœ¨ç³»ç»Ÿè°ƒç”¨å‰ååœä¸‹</div><div class="line">    int status;</div><div class="line">    while(1)&#123;</div><div class="line">        wait(&amp;status);</div><div class="line">        doSthBefore(pid);</div><div class="line">        ptrace(PTRACE_SYSCALL, pid, NULL, NULL);</div><div class="line">        wait(&amp;status);</div><div class="line">        doSthAfter(pid);</div><div class="line">        ptrace(PTRACE_SYSCALL, pid, NULL, NULL);</div><div class="line">    &#125;</div><div class="line">    ptrace(PTRACE_DETACH, pid, NULL, NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ç»“æœ:</strong></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/19/16/20/25" alt=""></p>
<h1 id="ä¿®æ”¹å‡½æ•°å‚æ•°"><a href="#ä¿®æ”¹å‡½æ•°å‚æ•°" class="headerlink" title="ä¿®æ”¹å‡½æ•°å‚æ•°"></a>ä¿®æ”¹å‡½æ•°å‚æ•°</h1><p>ä¿®æ”¹printfçš„å‚æ•°:å­—ç¬¦ä¸²åŠå…¶é•¿åº¦.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">#define long_size 4</div><div class="line">void readData(int pid, long addr, char *str, int len)</div><div class="line">&#123;</div><div class="line">    int i,j;</div><div class="line">    char *laddr;</div><div class="line">    union u&#123;</div><div class="line">        long val;</div><div class="line">        char chars[long_size];</div><div class="line">    &#125;data;</div><div class="line">    i = 0;</div><div class="line">    j = len / long_size;</div><div class="line">    laddr = str;</div><div class="line">    while (i &lt; j) &#123;</div><div class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr+i*4, NULL);    //PEEKDATAä¸€æ¬¡è¯»ä¸€ä¸ªå­—</div><div class="line">        memcpy(laddr,data.chars,long_size);</div><div class="line">        laddr += long_size;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    j = len % long_size;</div><div class="line">    if (j != 0) &#123;</div><div class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr+i*4, NULL);    //PEEKDATAä¸€æ¬¡è¯»ä¸€ä¸ªå­—</div><div class="line">        memcpy(laddr,data.chars,long_size);</div><div class="line">    &#125;</div><div class="line">    str[len] = &apos;\0&apos;;</div><div class="line">&#125;</div><div class="line">void writeData(int pid, long addr, char *str, int len)</div><div class="line">&#123;</div><div class="line">    int i,j;</div><div class="line">    char *laddr;</div><div class="line">    union u&#123;</div><div class="line">        long val;</div><div class="line">        char chars[long_size];</div><div class="line">    &#125;data;</div><div class="line">    i = 0;</div><div class="line">    j = len / long_size;</div><div class="line">    laddr = str;</div><div class="line">    while (i &lt; j) &#123;</div><div class="line">        memcpy(data.chars,laddr,long_size);</div><div class="line">        ptrace(PTRACE_POKEDATA, pid, addr+i*4, data.val);    //PEEKDATAä¸€æ¬¡å†™ä¸€ä¸ªå­—</div><div class="line">        laddr += long_size;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    j = len % long_size;</div><div class="line">    if (j != 0) &#123;</div><div class="line">        memcpy(data.chars,laddr,j);</div><div class="line">        ptrace(PTRACE_POKEDATA, pid, addr+i*4, data.val);    //POKEDATAä¸€æ¬¡å†™ä¸€ä¸ªå­—</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">void strrev(char *p)</div><div class="line">&#123;</div><div class="line">  char *q = p;</div><div class="line">  while(q &amp;&amp; *q) ++q;</div><div class="line">  for(--q; p &lt; q; ++p, --q)</div><div class="line">    *p = *p ^ *q,</div><div class="line">    *q = *p ^ *q,</div><div class="line">    *p = *p ^ *q;</div><div class="line">&#125;</div><div class="line">void modifyString(int pid,long addr,long len)</div><div class="line">&#123;</div><div class="line">    char *str;</div><div class="line">    str = (char*)calloc(sizeof(char)*(len+1),1);</div><div class="line">    readData(pid,addr,str,len);</div><div class="line">    strrev(str);</div><div class="line">    writeData(pid,addr,str,len);</div><div class="line">&#125;</div><div class="line">void doSthBefore(int pid)</div><div class="line">&#123;</div><div class="line">    struct pt_regs regs;</div><div class="line">    int sysCallNumber = 0;</div><div class="line">    ptrace(PTRACE_GETREGS,pid,NULL,&amp;regs);</div><div class="line">    sysCallNumber = getSystemCallNumber(pid,&amp;regs);</div><div class="line">    printf(&quot;before syscallno: %d\n&quot;, sysCallNumber);</div><div class="line">    if(sysCallNumber == __NR_write)&#123;</div><div class="line">        printf(&quot;__NR_write &lt;&lt; %ld, %p, %ld\n&quot;,regs.ARM_r0, (void*)regs.ARM_r1, regs.ARM_r2);</div><div class="line">        modifyString(pid,regs.ARM_r1,regs.ARM_r2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/9300" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking</a></p>
<p><a href="http://www.xuebuyuan.com/706076.html" target="_blank" rel="external">Android ptraceç®€ä»‹</a></p>
<p><a href="http://blog.csdn.net/ce123/article/details/6925375" target="_blank" rel="external">æµ…è°ˆEABIå’ŒOABI</a></p>
<p><a href="http://blog.csdn.net/myarrow/article/details/7036266" target="_blank" rel="external">Arm Linuxç³»ç»Ÿè°ƒç”¨æµç¨‹è¯¦ç»†è§£æ-SWI</a></p>
<p><a href="http://bbs.pediy.com/showthread.php?t=196435" target="_blank" rel="external">linux arm ç³»ç»Ÿè°ƒç”¨</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡æ˜¯å¯¹&lt;a href=&quot;http://www.weibo.com/zhengmin1989&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å¤§çŠ‡è’¸ç±³spark&lt;/a&gt;çš„&lt;a href=&quot;http://drops.wooyun.org/tips/9300&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹ç¦»åˆ«é’© â€“ Hooking&lt;/a&gt;çš„å®è·µè®°å½•ä»¥åŠçŸ¥è¯†æ•´ç†!åŸæ–‡è¯·æˆ³&lt;a href=&quot;http://drops.wooyun.org/tips/9300&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é“¾æ¥&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="hook" scheme="http://kiya.studio/tags/hook/"/>
    
  </entry>
  
  <entry>
    <title>åè°ƒè¯•æ–¹æ³•äºŒ - æŠ¢å ptrace</title>
    <link href="http://kiya.studio/2015/12/18/ptrace-basis/"/>
    <id>http://kiya.studio/2015/12/18/ptrace-basis/</id>
    <published>2015-12-18T13:42:40.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>The ptrace() system call provides a means by which one process (theâ€tracerâ€) may observe and control the execution of another process(the â€œtraceeâ€), and examine and change the traceeâ€™s memory andregisters.  It is primarily used to implement breakpoint debugging and system call tracing.</p>
</blockquote>
<p>å¸®åŠ©æ–‡æ¡£<a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="external">online</a>.</p>
<a id="more"></a>
<h1 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h1><p><code>ptrace</code>å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹ç›‘è§†å’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œ,å¹¶ä¸”ä¿®æ”¹è¢«ç›‘è§†è¿›ç¨‹çš„å†…å­˜ã€å¯„å­˜å™¨ç­‰,ä¸»è¦åº”ç”¨äºæ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ª.</p>
<p>å‡½æ•°åŸå‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">long ptrace(int request, pid_t pid, void * addr, void * data)</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­,requestä»£è¡¨è¯·æ±‚ç±»å‹,pidä»£è¡¨è¢«è°ƒè¯•è¿›ç¨‹çš„pid.</p>
<blockquote>
<p>ptraceå»ºç«‹è·Ÿè¸ªå…³ç³»çš„ä¸¤ç§æ–¹å¼:</p>
<ol>
<li>fork:<br>åˆ©ç”¨fork+execveæ‰§è¡Œè¢«æµ‹è¯•çš„ç¨‹åºï¼Œå­è¿›ç¨‹åœ¨æ‰§è¡Œexecveä¹‹å‰è°ƒç”¨ptrace(PTRACE_TRACEME)ï¼Œå»ºç«‹äº†ä¸çˆ¶è¿›ç¨‹(debugger)çš„è·Ÿè¸ªå…³ç³»ã€‚</li>
<li>attach: debuggerå¯ä»¥è°ƒç”¨ptrace(PTRACE_ATTACHï¼Œpid,â€¦)ï¼Œå»ºç«‹è‡ªå·±ä¸è¿›ç¨‹å·ä¸ºpidçš„è¿›ç¨‹é—´çš„è·Ÿè¸ªå…³ç³»ã€‚<br>å³åˆ©ç”¨PTRACE_ATTACHï¼Œä½¿è‡ªå·±å˜æˆè¢«è°ƒè¯•ç¨‹åºçš„çˆ¶è¿›ç¨‹(ç”¨pså¯ä»¥çœ‹åˆ°)ã€‚ç”¨attachå»ºç«‹èµ·æ¥çš„è·Ÿè¸ªå…³ç³»ï¼Œå¯ä»¥è°ƒç”¨ptrace(PTRACE_DETACHï¼Œpid,â€¦)æ¥è§£é™¤ã€‚æ³¨æ„attachè¿›ç¨‹æ—¶çš„æƒé™é—®é¢˜ï¼Œå¦‚ä¸€ä¸ªérootæƒé™çš„è¿›ç¨‹æ˜¯ä¸èƒ½attachåˆ°ä¸€ä¸ªrootè¿›ç¨‹ä¸Šçš„ã€‚</li>
</ol>
</blockquote>
<p>æœ‰ä¿¡å·å‘ç”Ÿæ—¶,è¢«è°ƒè¯•è¿›ç¨‹å°±ä¼šæš‚åœä¸‹æ¥,å¹¶ä¸”é€šçŸ¥è°ƒè¯•è¿›ç¨‹.è°ƒè¯•è¿›ç¨‹å¯ä»¥è°ƒç”¨waitpid()è·å¾—è¢«è°ƒè¯•è¿›ç¨‹æš‚åœä½ç½®çš„ç›¸å…³ä¿¡æ¯.<br>åœ¨è¢«è°ƒè¯•è¿›ç¨‹æš‚åœçš„æœŸé—´,è°ƒè¯•è¿›ç¨‹å¯ä»¥å„ç§ptrace requestæ¥å¯¹è¢«è°ƒè¯•è¿›ç¨‹è¿›è¡Œæ“ä½œ,æŸ¥çœ‹ã€ä¿®æ”¹ã€ä½¿ä¹‹ç»§ç»­è¿è¡Œã€å¿½ç•¥è¯¥ä¿¡å·ç”šè‡³å‘é€ä¿¡å·.</p>
<h1 id="éƒ¨åˆ†ptrace-request"><a href="#éƒ¨åˆ†ptrace-request" class="headerlink" title="éƒ¨åˆ†ptrace request"></a>éƒ¨åˆ†ptrace request</h1><h2 id="PTRACE-TRACEME"><a href="#PTRACE-TRACEME" class="headerlink" title="PTRACE_TRACEME"></a>PTRACE_TRACEME</h2><p>å°†å½“å‰è¿›ç¨‹åˆ‡æ¢åˆ°åœæ­¢çŠ¶æ€ã€‚å®ƒé€šå¸¸æ€»æ˜¯ä¸ fork/exec ä¸€èµ·ä½¿ç”¨ã€‚å¯¹äºæ¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒPTRACE_TRACEME åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<h2 id="PTRACE-ATTACH"><a href="#PTRACE-ATTACH" class="headerlink" title="PTRACE_ATTACH"></a>PTRACE_ATTACH</h2><p>æ ¹æ®pidå°†è¢«è°ƒè¯•è¿›ç¨‹é™„åŠ åˆ°è°ƒè¯•è¿›ç¨‹ä¸Š,PTRACE_ATTACHå‘è¢«è°ƒè¯•è¿›ç¨‹å‘é€SIGSTOPä¿¡å·ä½¿ä¹‹åœä¸‹.<br>ä½†æ˜¯åœ¨<code>ptrace(PTRACE_ATTACH,pid,0,0)</code>æ‰§è¡Œå®Œæ¯•æ—¶è¢«è°ƒè¯•è¿›ç¨‹å¯èƒ½è¿˜æ²¡æœ‰æš‚åœ,å¯ä»¥ä½¿ç”¨<code>waitpid()</code>ç­‰å¾…å…¶åœä¸‹.</p>
<h2 id="PTRACE-DETACH"><a href="#PTRACE-DETACH" class="headerlink" title="PTRACE_DETACH"></a>PTRACE_DETACH</h2><p>å°†è¢«è°ƒè¯•è¿›ç¨‹ä¸è°ƒè¯•è¿›ç¨‹åˆ†ç¦»,ä½¿è¢«è°ƒè¯•è¿›ç¨‹æ­£å¸¸è¿è¡Œ.</p>
<h2 id="PTRACE-SYSCALL"><a href="#PTRACE-SYSCALL" class="headerlink" title="PTRACE_SYSCALL"></a>PTRACE_SYSCALL</h2><p>ä½¿è¢«è°ƒè¯•è¿›ç¨‹ç»§ç»­è¿è¡Œ,ä½†æ˜¯åœ¨ä¸‹ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å…¥å£å¤„æˆ–å‡ºå£å¤„åœä¸‹,æˆ–è€…æ˜¯æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤ååœä¸‹.<br>ä¾‹å¦‚,è°ƒè¯•è¿›ç¨‹å¯ä»¥ç›‘è§†è¢«è°ƒè¯•è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨å…¥å£å¤„çš„å‚æ•°,æ¥ç€å†ä½¿ç”¨SYSCALL,ç›‘è§†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼.</p>
<h2 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h2><p>waitå‡½æ•°ä¼šå»¶è¿Ÿçˆ¶è¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°è¢«è°ƒè¯•çš„è¿›ç¨‹åˆ‡æ¢ä¸ºåœæ­¢çŠ¶æ€æˆ–è€…ç»ˆæ­¢ä¸ºæ­¢.</p>
<h1 id="åè°ƒè¯•"><a href="#åè°ƒè¯•" class="headerlink" title="åè°ƒè¯•"></a>åè°ƒè¯•</h1><p>ptraceè¢«å¹¿æ³›ç”¨äºåè°ƒè¯•,å› ä¸ºä¸€ä¸ªè¿›ç¨‹åªèƒ½è¢«ptraceä¸€æ¬¡,å¦‚æœäº‹å…ˆè°ƒç”¨äº†ptraceæ–¹æ³•,é‚£å°±å¯ä»¥é˜²æ­¢åˆ«äººè°ƒè¯•æˆ‘ä»¬çš„ç¨‹åº.</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æµ‹è¯•ç¨‹åº:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    ptrace(PTRACE_TRACEME);</div><div class="line">    while(1)&#123;</div><div class="line">        printf(&quot;Hello Ptrace!\n&quot;);</div><div class="line">        sleep(1);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–è¯‘:<code>gcc -g -o hello-ptrace hello-ptrace.c</code></p>
<p>è¿è¡Œ:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/18/16/07/45" alt=""></p>
<p>å¦å¼€å‘½ä»¤è¡Œè°ƒè¯•:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/18/15/59/52" alt=""></p>
<h2 id="æ£€æµ‹"><a href="#æ£€æµ‹" class="headerlink" title="æ£€æµ‹"></a>æ£€æµ‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;sys/ptrace.h&gt;</div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    if(-1 == ptrace(PTRACE_TRACEME))</div><div class="line">    &#123;</div><div class="line">        printf(&quot;Debugger!\n&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    printf(&quot;Hello Ptrace!\n&quot;);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ååè°ƒè¯•"><a href="#ååè°ƒè¯•" class="headerlink" title="ååè°ƒè¯•"></a>ååè°ƒè¯•</h1><p><code>ptrace</code>ç”¨æˆ·æ€æºç (ä½äºbionic/libc/bionic/ptrace.c):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">long ptrace(int request, pid_t pid, void * addr, void * data)</div><div class="line">&#123;</div><div class="line">    switch (request) &#123;</div><div class="line">        case PTRACE_PEEKUSR:</div><div class="line">        case PTRACE_PEEKTEXT:</div><div class="line">        case PTRACE_PEEKDATA:</div><div class="line">        &#123;</div><div class="line">            long word;</div><div class="line">            long ret;</div><div class="line">            ret = __ptrace(request, pid, addr, &amp;word);</div><div class="line">            if (ret == 0) &#123;</div><div class="line">                return word;</div><div class="line">            &#125; else &#123;</div><div class="line">                // __ptrace will set errno for us</div><div class="line">                return -1;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        default:</div><div class="line">             return __ptrace(request, pid, addr, data);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>0è¡¨ç¤ºæˆåŠŸ,-1è¡¨ç¤ºé”™è¯¯.</p>
<ul>
<li><p>å•ä¸ªåº”ç”¨å¯åœ¨ptraceä¸‹æ–­ç‚¹.</p>
</li>
<li><p>å®šåˆ¶ROM,å¯ä»¥å°†ptraceæºä»£ç ä¿®æ”¹ä¸º<code>å¦‚æœæ˜¯è‡ªå·±çš„pidè°ƒç”¨ptrace,è¿”å›-1;å¦åˆ™è¿”å›0</code>.</p>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://www.xuebuyuan.com/706076.html" target="_blank" rel="external">Android ptraceç®€ä»‹</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;The ptrace() system call provides a means by which one process (theâ€tracerâ€) may observe and control the execution of another process(the â€œtraceeâ€), and examine and change the traceeâ€™s memory andregisters.  It is primarily used to implement breakpoint debugging and system call tracing.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¸®åŠ©æ–‡æ¡£&lt;a href=&quot;http://man7.org/linux/man-pages/man2/ptrace.2.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;online&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="anti-debug" scheme="http://kiya.studio/tags/anti-debug/"/>
    
  </entry>
  
  <entry>
    <title>è„±å£³åŸºç¡€ dvmDexFileOpenPartial</title>
    <link href="http://kiya.studio/2015/12/16/unshell-basic/"/>
    <id>http://kiya.studio/2015/12/16/unshell-basic/</id>
    <published>2015-12-16T05:33:50.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ —å­<a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/shell-protect-1.apk" target="_blank" rel="external">åœ¨æ­¤</a></p>
<a id="more"></a>
<h1 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h1><p><a href="http://kiya.space/2015/12/11/ida-dynamic-debug-dex/" target="_blank" rel="external">é™„åŠ è¿›ç¨‹</a>å,åœ¨<code>libdvm.so</code>ä¸­çš„<code>dvmDexFileOpenPartial</code>å‡½æ•°ä¸‹æ–­ç‚¹.</p>
<p>dvmDexFileOpenPartialçš„å‡½æ•°åŸå‹ä¸º(ä½äº/dalvik/vm/DvmDex.cpp):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * @addr: ä¼ å…¥å‚æ•°, dexæ–‡ä»¶çš„èµ·å§‹åœ°å€</div><div class="line"> * @len: ä¼ å‡ºå‚æ•°, dexæ–‡ä»¶çš„å¤§å°</div><div class="line"> * @ppDvmDex: ä¼ å‡ºå‚æ•°,æŒ‡å‘ DvmDex ç»“æ„çš„åœ°å€</div><div class="line">*/</div><div class="line">int dvmDexFileOpenPartial(const void* addr, int len, DvmDex** ppDvmDex)</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œåæ–­ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/16/13/39/27" alt=""></p>
<p>å¾—R0ä¸ºaddr,R1ä¸ºlen.</p>
<p>æ‰§è¡Œè„šæœ¬:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/16/13/39/41" alt=""></p>
<p>ç°åœ¨å°±å¯ä»¥ä½¿ç”¨baksmaliå¤„ç†dexæ–‡ä»¶ç»§ç»­åˆ†æäº†.</p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>dalvikè™šæ‹Ÿæœºä¼šæŠŠdexæ–‡ä»¶ä¼˜åŒ–ä¸ºodexæ–‡ä»¶,è€Œä¼˜åŒ–çš„æºä»£ç ä¸º<code>/dalvik/dexopt/OptMain.cpp</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Main entry point.  Decide where to go.</div><div class="line"> */</div><div class="line">int main(int argc, char* const argv[])</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">    if (argc &gt; 1) &#123;</div><div class="line">        if (strcmp(argv[1], &quot;--zip&quot;) == 0)</div><div class="line">            return fromZip(argc, argv);</div><div class="line">        else if (strcmp(argv[1], &quot;--dex&quot;) == 0)</div><div class="line">            return fromDex(argc, argv);</div><div class="line">        else if (strcmp(argv[1], &quot;--preopt&quot;) == 0)</div><div class="line">            return preopt(argc, argv);</div><div class="line">    &#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>fromzip</code>å’Œ<code>preopt</code>éƒ½ä¼šè°ƒç”¨<code>processZipFile</code>å…ˆå°†dexæ–‡ä»¶æå–å‡ºæ¥,<code>fromDex</code>åˆ™ç›´æ¥è°ƒç”¨<code>dvmContinueOptimization</code>ä¼˜åŒ–.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Common functionality for normal device-side processing as well as</div><div class="line"> * preoptimization.</div><div class="line"> */</div><div class="line">static int processZipFile(int zipFd, int cacheFd, const char* zipName,</div><div class="line">        const char *dexoptFlags)</div><div class="line">&#123;</div><div class="line">   	...</div><div class="line">    int result = extractAndProcessZip(zipFd, cacheFd, zipName, isBootstrap,</div><div class="line">            bcp, dexoptFlags);</div><div class="line">    free(bcpCopy);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>extractAndProcessZip</code>ä¸­å¤„ç†zipæ–‡ä»¶å¹¶å°†dexæå–å‡ºæ¥,éšåè°ƒç”¨ä¼˜åŒ–å‡½æ•°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Extract &quot;classes.dex&quot; from zipFd into &quot;cacheFd&quot;, leaving a little space</div><div class="line"> * up front for the DEX optimization header.</div><div class="line"> */</div><div class="line">static int extractAndProcessZip(int zipFd, int cacheFd,</div><div class="line">    const char* debugFileName, bool isBootstrap, const char* bootClassPath,</div><div class="line">    const char* dexoptFlagStr)</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">    /*</div><div class="line">     * Open the zip archive, find the DEX entry.</div><div class="line">     */</div><div class="line">    if (dexZipPrepArchive(zipFd, debugFileName, &amp;zippy) != 0) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: unable to open zip archive &apos;%s&apos;&quot;, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    zipEntry = dexZipFindEntry(&amp;zippy, kClassesDex);</div><div class="line">    if (zipEntry == NULL) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: zip archive &apos;%s&apos; does not include %s&quot;,</div><div class="line">            debugFileName, kClassesDex);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    /*</div><div class="line">     * Extract some info about the zip entry.</div><div class="line">     */</div><div class="line">    if (dexZipGetEntryInfo(&amp;zippy, zipEntry, NULL, &amp;uncompLen, NULL, NULL,</div><div class="line">            &amp;modWhen, &amp;crc32) != 0)</div><div class="line">    &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: zip archive GetEntryInfo failed on %s&quot;, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    uncompLen = uncompLen;</div><div class="line">    modWhen = modWhen;</div><div class="line">    crc32 = crc32;</div><div class="line">    /*</div><div class="line">     * Extract the DEX data into the cache file at the current offset.</div><div class="line">     */</div><div class="line">    if (dexZipExtractEntryToFile(&amp;zippy, zipEntry, cacheFd) != 0) &#123;</div><div class="line">        ALOGW(&quot;DexOptZ: extraction of %s from %s failed&quot;,</div><div class="line">            kClassesDex, debugFileName);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">   	...</div><div class="line">    /*</div><div class="line">     * Prep the VM and perform the optimization.</div><div class="line">     */</div><div class="line">    if (dvmPrepForDexOpt(bootClassPath, dexOptMode, verifyMode,</div><div class="line">            dexoptFlags) != 0)</div><div class="line">    &#123;</div><div class="line">        ALOGE(&quot;DexOptZ: VM init failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">    //vmStarted = 1;</div><div class="line">    /* do the optimization */</div><div class="line">    if (!dvmContinueOptimization(cacheFd, dexOffset, uncompLen, debugFileName,</div><div class="line">            modWhen, crc32, isBootstrap))</div><div class="line">    &#123;</div><div class="line">        ALOGE(&quot;Optimization failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>dvmContinueOptimization</code>å‡½æ•°ä½äº/dalvik/vm/analysis/DexPrepare.cppæ–‡ä»¶,å…¶ä¸­è°ƒç”¨äº†<code>dvmDexFileOpenPartial</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Do the actual optimization.  This is executed in the dexopt process.</div><div class="line"> *</div><div class="line"> * For best use of disk/memory, we want to extract once and perform</div><div class="line"> * optimizations in place.  If the file has to expand or contract</div><div class="line"> * to match local structure padding/alignment expectations, we want</div><div class="line"> * to do the rewrite as part of the extract, rather than extracting</div><div class="line"> * into a temp file and slurping it back out.  (The structure alignment</div><div class="line"> * is currently correct for all platforms, and this isn&apos;t expected to</div><div class="line"> * change, so we should be okay with having it already extracted.)</div><div class="line"> *</div><div class="line"> * Returns &quot;true&quot; on success.</div><div class="line"> */</div><div class="line">bool dvmContinueOptimization(int fd, off_t dexOffset, long dexLength,</div><div class="line">    const char* fileName, u4 modWhen, u4 crc, bool isBootstrap)</div><div class="line">&#123;</div><div class="line">   ...</div><div class="line">		success = rewriteDex(((u1*) mapAddr) + dexOffset, dexLength,</div><div class="line">                    doVerify, doOpt, &amp;pClassLookup, NULL);</div><div class="line">        if (success) &#123;</div><div class="line">            DvmDex* pDvmDex = NULL;</div><div class="line">            u1* dexAddr = ((u1*) mapAddr) + dexOffset;</div><div class="line">            if (dvmDexFileOpenPartial(dexAddr, dexLength, &amp;pDvmDex) != 0) &#123;</div><div class="line">                ALOGE(&quot;Unable to create DexFile&quot;);</div><div class="line">                success = false;</div><div class="line">            &#125; else &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>dvmDexFileOpenPartial</code>è°ƒç”¨äº†<code>dexFileParse</code>,ç”¨æ¥è§£æå†…å­˜ä¸­ä¼˜åŒ–è¿‡æˆ–æœªä¼˜åŒ–è¿‡çš„dexæ–‡ä»¶,è¿”å›dexFileç»“æ„.<br>æ‰€ä»¥æ­¤æ—¶dexæ–‡ä»¶å·²ç»è¢«åŠ è½½è¿›å†…å­˜,å°±å¯ä»¥dumpå‡ºæ¥äº†.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Create a DexFile structure for a &quot;partial&quot; DEX.  This is one that is in</div><div class="line"> * the process of being optimized.  The optimization header isn&apos;t finished</div><div class="line"> * and we won&apos;t have any of the auxillary data tables, so we have to do</div><div class="line"> * the initialization slightly differently.</div><div class="line"> *</div><div class="line"> * Returns nonzero on error.</div><div class="line"> */</div><div class="line">int dvmDexFileOpenPartial(const void* addr, int len, DvmDex** ppDvmDex)</div><div class="line">&#123;</div><div class="line">    DvmDex* pDvmDex;</div><div class="line">    DexFile* pDexFile;</div><div class="line">    int parseFlags = kDexParseDefault;</div><div class="line">    int result = -1;</div><div class="line">    /* -- file is incomplete, new checksum has not yet been calculated</div><div class="line">    if (gDvm.verifyDexChecksum)</div><div class="line">        parseFlags |= kDexParseVerifyChecksum;</div><div class="line">    */</div><div class="line">    pDexFile = dexFileParse((u1*)addr, len, parseFlags);</div><div class="line">    if (pDexFile == NULL) &#123;</div><div class="line">        ALOGE(&quot;DEX parse failed&quot;);</div><div class="line">        goto bail;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ —å­&lt;a href=&quot;https://github.com/kiya-z/Android/blob/master/lab-mouse/shell-protect-1.apk&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;åœ¨æ­¤&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="MSC" scheme="http://kiya.studio/tags/MSC/"/>
    
      <category term="enforce" scheme="http://kiya.studio/tags/enforce/"/>
    
  </entry>
  
  <entry>
    <title>åè°ƒè¯•æ–¹æ³•ä¸€ - è¯»å–è¿›ç¨‹statusæ–‡ä»¶</title>
    <link href="http://kiya.studio/2015/12/14/android-anti-debug-read-status/"/>
    <id>http://kiya.studio/2015/12/14/android-anti-debug-read-status/</id>
    <published>2015-12-14T13:33:56.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ —å­:<a href="https://github.com/kiya-z/Android/blob/master/lab-mouse/AliCrackme_2.apk" target="_blank" rel="external">é˜¿é‡Œç§»åŠ¨å®‰å…¨æŒ‘æˆ˜èµ›ç¬¬äºŒé¢˜</a></p>
<a id="more"></a>
<blockquote>
<p>æœ¬æ —åè°ƒè¯•æ–¹æ³•:<br>ç”¨fopenæ‰“å¼€<code>/proc/&lt;pid&gt;/status</code>æ–‡ä»¶è¯»å–å…¶ä¸­çš„<code>TracerPid</code>å€¼æ¥æ£€æµ‹è‡ªå·±çš„è¿›ç¨‹æ˜¯å¦è¢«attachï¼Œ<br>TracerPidå¦‚æœä¸º0è¯´æ˜æ²¡æœ‰åˆ«çš„è¿›ç¨‹åœ¨è°ƒè¯•è¿™ä¸ªè¿›ç¨‹ï¼Œå¦‚æœä¸ä¸º0è¯´æ˜æœ‰ç¨‹åºåœ¨è°ƒè¯•ã€‚</p>
</blockquote>
<p>ä½¿ç”¨idaé™„åŠ è¿›ç¨‹,å…³é”®å‡½æ•°ä¸‹æ–­ç‚¹F9ä¹‹å,è¿›ç¨‹é€€å‡º,idaé€€å‡º.<br>è°ƒè¯•è¿‡åå‘ç°JNI_OnLoadä¸­æœ‰åè°ƒè¯•æ–¹æ³•(å®é™…ä¸Šæ˜¯å‰è¾ˆçš„ç»“è®º :p).</p>
<p>æ ¹æ®<a href="http://kiya.space/2015/12/11/ida-dynamic-debug-so/" target="_blank" rel="external">ä½¿ç”¨idaè°ƒè¯•soæ–‡ä»¶</a>çš„æ­¥éª¤åœ¨<code>library load</code>å¤„æ–­ä¸‹.</p>
<h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p>æ‰“å¼€Debugger windows -&gt; Module list,æ‰¾åˆ°<code>/data/app-lib/com.yaotong.crackme-1/libcrackme.so</code>,ä¸ºå…¶ä¸­çš„JNI_OnLoadæ–¹æ³•å³é”®<code>Add breakpoint</code>.è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°libcrackme.soçš„åŸºå€ä¸º0x520AE000.<br>(å½“ç„¶å¦‚æœåè°ƒè¯•æ–¹æ³•æ˜¯åœ¨.initarrayä¸­,å…¶åœ°å€éœ€è¦æ‰‹åŠ¨è®¡ç®—.)</p>
<p>ä¸€æ­¥ä¸€æ­¥F8å‘ç°åœ¨æ‰§è¡Œè¿™ä¸€å¥ä¹‹åç¨‹åºé€€å‡º.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/14/22" alt=""></p>
<p>F7è¿›å»,å‘ç°æ˜¯<code>pthread_create</code>å‡½æ•°.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/14/57" alt=""></p>
<p>æ‰€ä»¥ä¸Šä¸Šå›¾ä¸­çš„<code>unk_520AF6A4</code>å‡½æ•°å°±æ˜¯çº¿ç¨‹å›è°ƒå‡½æ•°å’¯.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/15/23" alt=""></p>
<p>å…ˆä¸å»åˆ†æ(å…¶å®æ˜¯æ°´å¹³è¾¾ä¸åˆ° :( ),æ‰€ä»¥æˆ‘ä»¬è¦ç”¨å®ˆæ ªå¾…å…”çš„æ–¹æ³•.<br>åœ¨module listä¸­æ‰¾åˆ°<code>libc.so</code>,åœ¨fopenå‡½æ•°ä¸‹æ–­ç‚¹,ä»¥æ­¤æ£€éªŒç¨‹åºæ˜¯å¦æ‰“å¼€äº†æŸäº›æ–‡ä»¶æ£€æµ‹çŠ¶æ€å€¼.<br>åŒæ—¶æ‰“å¼€ä¸€ä¸ªhex view(View -&gt; Open subviews -&gt; Hex dump),è®¾ç½®æ•°æ®ä¸R0åŒæ­¥.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/15/46" alt=""></p>
<p>F9è¿è¡Œåˆ°fopenå‡½æ•°å¤„(æœ‰æ—¶å¹¶ä¸èƒ½ä¸€æ¬¡å°±æ–­åœ¨fopen,æ³¨æ„çœ‹æ³¨é‡Š).</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/06" alt=""></p>
<p>æ‰€ä»¥ç¨‹åºç¡®å®æ˜¯è¯»å–äº†statusæ–‡ä»¶. :P<br>è¿™æ˜¯éœ€è¦æ‰¾åˆ°æ˜¯è°è°ƒç”¨äº†fopenå‡½æ•°,ç„¶åä¿®æ”¹è¯»å–statusçš„è¿”å›å€¼ä¸º0(ä¸ç„¶å°±éœ²é¦…äº†).<br>ä¸€ç›´æ‘F8ç›´åˆ°fopenå‡½æ•°è¿”å›,äºæ˜¯æˆ‘ä»¬æ¥åˆ°äº†è¿™é‡Œ.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/21" alt=""></p>
<p>ä¸€è¾¹æ˜¯æ•°æ®ä¸€è¾¹æ˜¯ä»£ç ,å®Œå…¨æ‰¾ä¸åˆ°å‡½æ•°å¼€å§‹çš„åœ°æ–¹å“‡.<br>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ­¤å¤„åœ°å€ä¸º<code>520AF420</code>,å‡å»æˆ‘ä»¬ä¹‹å‰è®°ä¸‹çš„libcrackme.soçš„åŸºå€520AE000,å¾—åˆ°ç›¸å¯¹åœ°å€ä¸º<code>1420</code><br>å¦å¼€ä¸€ä¸ªida,æ‘Gé”®è·³è‡³æ­¤åœ°å€,F5å‘ç°æ˜¯å‡½æ•°<code>sub_130c</code>.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/38" alt=""></p>
<p>å°†<code>sub_130c</code>çš„æ–‡ä»¶åç§»è½¬æ¢ä¸ºç»å¯¹åœ°å€:130c+520AE000=520AF30C.<br>pé”®å°†æ­¤å¤„æ•°æ®è§†ä¸ºä»£ç å˜æˆè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/02" alt=""></p>
<p>ç¨‹åºéšåä¼šç”¨fgets()å’Œstrstr()æ¥è·å–TracerIdçš„å€¼ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨strstr()å¤„ä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åè®©hex viewçš„æ•°æ®ä¸R0åŒæ­¥.<br>ä¸€ç›´F9,ç›´åˆ°R0çš„å€¼å˜ä¸ºè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/31" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/21/48" alt=""></p>
<p>F2ä¿®æ”¹ä¸ºè¿™æ ·:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/22/34" alt=""></p>
<p>ä½†æ˜¯è¿‡ä¸€ä¼šç¨‹åºåˆè¦è·å–,æˆ‘ä»¬å¾—ä¸€ç›´ä¸åœçš„æ”¹,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™æ®µä»£ç nopæ‰,ä¸–ç•Œæ‰å®‰é™.</p>
<h1 id="patch-so"><a href="#patch-so" class="headerlink" title="patch so"></a>patch so</h1><p>å¦‚æœé™æ€åˆ†ææ—¶æ‰¾åˆ°JNI_OnLoadä¸­å…³é”®çš„é‚£å¥ä»£ç :</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/16/59" alt=""></p>
<p>è¿›å…¥çº¿ç¨‹çš„å›è°ƒå‡½æ•°,å‘ç°ç«Ÿç„¶æ˜¯è¿™æ ·å­çš„!</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/15" alt=""></p>
<p>å›è°ƒå‡½æ•°<code>sub_16a4</code>ä¸­è°ƒç”¨äº†<code>sub_130c</code>!<br>è·Ÿæˆ‘ä»¬åœ¨åŠ¨æ€è°ƒè¯•æ—¶çœ‹åˆ°çš„å®Œå…¨ä¸ä¸€æ ·å˜›.<br>ç°åœ¨å°†å›è°ƒå‡½æ•°ä¸­çš„è¿™ä¸€å¥nopæ‰å°±å¥½äº†å‘—.<br>å³é”®é€‰æ‹©<code>copy to assembly</code></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/31" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/17/48" alt=""></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯<code>BL sub_130C</code>. armä¸­æ²¡æœ‰nopè¯­å¥,æ‰€ä»¥å°†<code>movs r0,r0</code>ä½œä¸ºNOP,å¯¹åº”çš„æœºå™¨ç ä¸º<code>00 00 A0 E1</code>.</p>
<p>å³é”®è¿›å…¥hex view.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/02" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/17" alt=""></p>
<p>æ‘F2å°†<code>13 FF FF EB</code>æ”¹ä¸º<code>00 00 A0 E1</code>,å†æ‘F2åº”ç”¨.<br>ç‚¹å‡»<code>Edit -&gt; Patch program -&gt; Apply patches to input file...</code>ä¿å­˜å³å¯.</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/18/34" alt=""></p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/14/21/20/31" alt=""></p>
<p>å°†åŸapkä¸­çš„soæ–‡ä»¶æ›¿æ¢ä¸ºæ­¤soæ–‡ä»¶,é‡æ–°æ‰“åŒ…ç­¾åå®‰è£…,ç°åœ¨ç›´æ¥æ‰“å¼€appè°ƒè¯•å°±ä¸ä¼šé€€å‡ºäº†. Success!</p>
<hr>
<h1 id="ç•ªå¤–"><a href="#ç•ªå¤–" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><p>idaä¸­æŒ‰ä¸‰ä¸‹Dï¼Œå°†æ•°æ®æ ¼å¼ä»å­—ç¬¦è½¬åŒ–ä¸ºæŒ‡é’ˆå½¢å¼.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://drops.wooyun.org/tips/6840" target="_blank" rel="external">å®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹å­”é›€ç¿ â€“ Ida Pro</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ —å­:&lt;a href=&quot;https://github.com/kiya-z/Android/blob/master/lab-mouse/AliCrackme_2.apk&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é˜¿é‡Œç§»åŠ¨å®‰å…¨æŒ‘æˆ˜èµ›ç¬¬äºŒé¢˜&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Android Security" scheme="http://kiya.studio/categories/Android-Security/"/>
    
    
      <category term="anti-debug" scheme="http://kiya.studio/tags/anti-debug/"/>
    
      <category term="MSC" scheme="http://kiya.studio/tags/MSC/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨idaè°ƒè¯•soæ–‡ä»¶</title>
    <link href="http://kiya.studio/2015/12/11/ida-dynamic-debug-so/"/>
    <id>http://kiya.studio/2015/12/11/ida-dynamic-debug-so/</id>
    <published>2015-12-11T05:16:52.000Z</published>
    <updated>2017-06-21T11:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¿æŠ¤ä»£ç é€šå¸¸æ”¾åœ¨soæ–‡ä»¶ä¸­.</p>
<a id="more"></a>
<h1 id="æ­£å¸¸çš„åº”ç”¨"><a href="#æ­£å¸¸çš„åº”ç”¨" class="headerlink" title="æ­£å¸¸çš„åº”ç”¨"></a>æ­£å¸¸çš„åº”ç”¨</h1><h2 id="androidæœºçš„å‡†å¤‡å·¥ä½œ"><a href="#androidæœºçš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="androidæœºçš„å‡†å¤‡å·¥ä½œ"></a>androidæœºçš„å‡†å¤‡å·¥ä½œ</h2><p>æ‰¾åˆ°<code>ida</code>ç›®å½•ä¸‹çš„<code>/dbgsrv/android_server</code>æ–‡ä»¶,pushè¿›androidæœº,å¯åŠ¨<code>android_server</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">adb push android_server /data/local/tmp/</div><div class="line">adb shell</div><div class="line">su</div><div class="line">cd data/local/tmp</div><div class="line">chmod 755 android_server</div><div class="line">./android_server</div></pre></td></tr></table></figure>
<p>å‡ºç°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@android:/data/local/tmp # ./android_server</div><div class="line">IDA Android 32-bit remote debug server(ST) v1.19. Hex-Rays (c) 2004-2015</div><div class="line">Listening on port #23946...</div></pre></td></tr></table></figure>
<p>å¦å¼€å‘½ä»¤è¡Œè¿›è¡Œtcpç«¯å£è½¬å‘ï¼š<br><code>adb forward tcp:23946 tcp:23946</code></p>
<p>[<strong>æ³¨æ„äº‹é¡¹</strong>]</p>
<ol>
<li>æ­¤android_serveréœ€å’Œidaæ˜¯é…å¥—çš„</li>
<li>å‡ºç°<code>bind: Address already in use</code>é”™è¯¯<br>è¿™æ˜¯å› ä¸ºæ‰‹æœºä¸­å¯èƒ½å·²ç»åœ¨è¿è¡Œandroid_server,ä½¿ç”¨<code>ps | grep android_server</code>çœ‹ä¸€ä¸‹,æœ‰çš„è¯æ€æ‰.<br>å¦‚ä¸‹:(14061æ˜¯pid)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@android:/ # ps | grep android_server</div><div class="line">root      14061 13574 11180  9504  ffffffff 40183da0 S /data/local/tmp/android_server</div><div class="line">127|root@android:/ # kill -s 9 14061</div></pre></td></tr></table></figure>
<h2 id="ida-çš„å‡†å¤‡"><a href="#ida-çš„å‡†å¤‡" class="headerlink" title="ida çš„å‡†å¤‡"></a>ida çš„å‡†å¤‡</h2><p>æ‰“å¼€idaï¼Œæ‰“å¼€soæ–‡ä»¶,è®°å½•soæ–‡ä»¶ä¸­æ„Ÿå…´è¶£çš„å‡½æ•°çš„æ–‡ä»¶åç§».</p>
<p>æ‰‹æœºæ‰“å¼€app.</p>
<p>å¦å¼€ä¸€ä¸ªida,èœå•æ è®¾ç½®<code>Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</code>å¦‚ä¸‹:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/46/45" alt=""></p>
<p>ç‚¹å‡»ok,å¼¹å‡ºè¿›ç¨‹åˆ—è¡¨,ä¾‹å¦‚:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/11/13/49/17" alt=""></p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>å¦‚æœæ­¤æ—¶è¿›ç¨‹åˆ—è¡¨ä¸­åªæœ‰ä¸€ä¸¤ä¸ªè¿›ç¨‹,å¯èƒ½æ˜¯å› ä¸ºä¸Šä¸€æ­¥å¯åŠ¨<code>android_server</code>æ—¶ä½ ä½¿ç”¨äº†è¿™æ ·çš„å‘½ä»¤:<br><code>adb shell /data/local/tmp/android_server</code><br>åªè¦å…ˆè¿›å…¥<code>adb shell</code>å†æ‰§è¡Œå°±æ²¡é—®é¢˜äº†.</p>
</blockquote>
<p>é€‰æ‹©è¦è°ƒè¯•çš„è¿›ç¨‹,ç­‰å¾…åˆ†æå®Œæ¯•.</p>
<p><code>ctrl+s</code>æ‰“å¼€segmentåˆ—è¡¨,æ‰¾åˆ°è¦è°ƒè¯•çš„soæ–‡ä»¶,é€‰æ‹©classå±æ€§ä¸ºCODEçš„é‚£ä¸ªå°±okäº†.è®°å¾—è®°ä¸‹soçš„åŸºå€(startå±æ€§).<br>åŸºå€åŠ ä¸Šåˆšåˆšè®°å½•çš„å‡½æ•°çš„æ–‡ä»¶åç§»å³å¾—å‡½æ•°çš„åœ°å€,æŒ‰å¿«æ·é”®Gè¾“å…¥åœ°å€è·³è½¬,ä¸‹æ–­ç‚¹è¿è¡Œå³å¯.</p>
<h1 id="ä¸æ­£å¸¸çš„åº”ç”¨"><a href="#ä¸æ­£å¸¸çš„åº”ç”¨" class="headerlink" title="ä¸æ­£å¸¸çš„åº”ç”¨"></a>ä¸æ­£å¸¸çš„åº”ç”¨</h1><p>(æ­¤æ­¥éª¤ä¹Ÿé€‚ç”¨äºç»™ç³»ç»Ÿå‡½æ•°ä¸‹æ–­ç‚¹)<br>soæ–‡ä»¶åœ¨è¢«åŠ è½½çš„æ—¶å€™ä¼šé¦–å…ˆæ‰§è¡Œ.init_arrayä¸­çš„å‡½æ•°ï¼Œç„¶åå†æ‰§è¡ŒJNI_OnLoad()å‡½æ•°ã€‚å¦‚æœåœ¨è¿™ä¸­é—´åŠ äº†åè°ƒè¯•ä»£ç ,é‚£ä¹ˆæˆ‘ä»¬ä¸€æ—¦å¼€å§‹è°ƒè¯•appå¯èƒ½å°±ä¼šé€€å‡º.æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨soæ–‡ä»¶è¢«åŠ è½½ä¹‹å‰å°±æ–­ä¸‹æ¥.</p>
<h2 id="å¯åŠ¨app"><a href="#å¯åŠ¨app" class="headerlink" title="å¯åŠ¨app"></a>å¯åŠ¨app</h2><p>ä½¿ç”¨am startå‘½ä»¤å¯åŠ¨app:<br><code>adb shell am start -D -n com.yaotong.crackme/com.yaotong.crackme.MainActivity</code><br><strong>com.yaotong.crackme</strong> ä¸ºåŒ…å,<strong>com.yaotong.crackme.MainActivity</strong> ä¸ºä¸»activityå.</p>
<p>æ­¤æ—¶æ‰‹æœºä¸Šä¼šå¼¹å‡º:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/12/13/35/08" alt=""></p>
<h2 id="idaå‡†å¤‡"><a href="#idaå‡†å¤‡" class="headerlink" title="idaå‡†å¤‡"></a>idaå‡†å¤‡</h2><p>åŒæ ·æ˜¯è®¾ç½®<code>Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</code>å†é€‰æ‹©è¿›ç¨‹.<br>ä¹‹åéœ€è¦è®¾ç½®è°ƒè¯•å™¨è°ƒè¯•é€‰é¡¹ä¸º:</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/from_clipboard/2015/12/12/13/35/31" alt=""></p>
<p>F9è¿è¡Œ.<br>åœ¨æ§åˆ¶å°ä½¿ç”¨jdbæ¢å¤è¿›ç¨‹è¿è¡Œ:<br><code>jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</code></p>
<p>æ­£å¸¸æƒ…å†µä¼šå‡ºç°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">è®¾ç½®æœªæ•è·çš„java.lang.Throwable</div><div class="line">è®¾ç½®å»¶è¿Ÿçš„æœªæ•è·çš„java.lang.Throwable</div><div class="line">æ­£åœ¨åˆå§‹åŒ–jdb...</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>é”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">java.net.ConnectException: Connection refused: connect</div><div class="line">        at java.net.DualStackPlainSocketImpl.connect0(Native Method)</div><div class="line">        at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:79)</div><div class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:345)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:172)</div><div class="line">        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">        at java.net.Socket.connect(Socket.java:589)</div><div class="line">        at com.sun.tools.jdi.SocketTransportService.attach(SocketTransportService.java:222)</div><div class="line">        at com.sun.tools.jdi.GenericAttachingConnector.attach(GenericAttachingConnector.java:116)</div><div class="line">        at com.sun.tools.jdi.SocketAttachingConnector.attach(SocketAttachingConnector.java:90)</div><div class="line">        at com.sun.tools.example.debug.tty.VMConnection.attachTarget(VMConnection.java:519)</div><div class="line">        at com.sun.tools.example.debug.tty.VMConnection.open(VMConnection.java:328)</div><div class="line">        at com.sun.tools.example.debug.tty.Env.init(Env.java:63)</div><div class="line">        at com.sun.tools.example.debug.tty.TTY.main(TTY.java:1066)</div><div class="line">è‡´å‘½é”™è¯¯:</div><div class="line">æ— æ³•é™„åŠ åˆ°ç›®æ ‡ VMã€‚</div></pre></td></tr></table></figure>
<ul>
<li>æ‰“å¼€ddmså°è¯•.</li>
<li>æ£€æŸ¥è°ƒè¯•çš„appé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦æœ‰<code>android:debuggable=&quot;true&quot;</code>ï¼Œå¯¼è‡´ä¸èƒ½è°ƒè¯•ã€‚<br>è‹¥æ— åˆ™åœ¨æ¸…å•æ–‡ä»¶çš„applicationä¸­åŠ ä¸Š,é‡æ–°æ‰“åŒ…å³å¯.</li>
</ul>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨.initarrayå’ŒJNI_OnLoadä¸‹æ–­ç‚¹äº†.</p>
<hr>
<blockquote>
<p>ç•ªå¤–</p>
</blockquote>
<h1 id="initarray"><a href="#initarray" class="headerlink" title=".initarray"></a>.initarray</h1><p>é™æ€åˆ†æsoæ–‡ä»¶æ—¶,æŒ‰<code>ctrl+s</code>å‡ºç°segmentåˆ—è¡¨,è¿›å…¥<code>.initarray</code>å³å¯çœ‹åˆ°åˆ—è¡¨.</p>
<h1 id="å¦‚ä½•dump-soæ–‡ä»¶"><a href="#å¦‚ä½•dump-soæ–‡ä»¶" class="headerlink" title="å¦‚ä½•dump soæ–‡ä»¶"></a>å¦‚ä½•dump soæ–‡ä»¶</h1><p>dumpæ—¶åŠ¡å¿…ç¡®ä¿soæ–‡ä»¶å·²ç»åŠ è½½.<br>pythonè„šæœ¬:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import idaapi</div><div class="line">data = idaapi.dbg_read_memory(start_addr,file_len)</div><div class="line">f = open(r&apos;C:\Users\...\Desktop\dump.so&apos;,&apos;wb&apos;)</div><div class="line">f.write(data)</div><div class="line">f.close()</div></pre></td></tr></table></figure>
<p>idaçš„apiå‡½æ•°åœ°å€:<a href="https://www.hex-rays.com/products/ida/support/idapython_docs/idaapi-module.html" target="_blank" rel="external">https://www.hex-rays.com/products/ida/support/idapython_docs/idaapi-module.html</a></p>
<p>ä»¥ä¸Š.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¿æŠ¤ä»£ç é€šå¸¸æ”¾åœ¨soæ–‡ä»¶ä¸­.&lt;/p&gt;
    
    </summary>
    
      <category term="é€†å‘" scheme="http://kiya.studio/categories/%E9%80%86%E5%90%91/"/>
    
    
      <category term="MSC" scheme="http://kiya.studio/tags/MSC/"/>
    
      <category term="debug" scheme="http://kiya.studio/tags/debug/"/>
    
      <category term="ida" scheme="http://kiya.studio/tags/ida/"/>
    
  </entry>
  
</feed>
